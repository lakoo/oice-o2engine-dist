/*//////////////////////////////////////////////////////////////////////////////
O₂ Engine  -  version 
Date : 2016-03-09
Copyright ©2012-2016 Gengosha Inc. All rights reserved.
To use or redistribute this software, please read 
http://developer.novelsphere.jp/

This software includes undermentioned libraries.
The following license descriptions are NOT about the license of O₂ Engine itself.

*** jQuery ***
Copyright 2013 jQuery Foundation and other contributors
http://jquery.com/

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
//////////////////////////////////////////////////////////////////////////////*/
function clone(e,t){if(e&&e.clone&&"function"==typeof e.clone)return e.clone();if(null==e||"object"!=typeof e||/\[object HTML[A-Za-z]*Element\]/.test(Object.prototype.toString.apply(e))||/\[object Window\]/.test(Object.prototype.toString.apply(e)))return e;if(e instanceof Date){var r=new Date;return r.setTime(e.getTime()),r}if(e instanceof Array){for(var r=[],i=0,n=e.length;n>i;i++)r[i]=clone(e[i]);return r}if(e instanceof Object){var r;if(r=window[e.initializer]&&e instanceof window[e.initializer]?new window[e.initializer]:new e.constructor,t&&(r.originalReference=e),"function"==typeof r.importFrom)r.importFrom(e);else for(var o in e)e.hasOwnProperty(o)&&(r[o]=clone(e[o]));return r}throw new Error("[内部エラー] オブジェクトをコピーできません。この型はサポートされていません")}function mergeObj(e,t){for(var r in e)"object"!=typeof e[r]||void 0==t[r]?t[r]=e[r]:mergeObj(e[r],t[r]);return t}function KeySpline(e,t,r,i){function n(e,t){return 1-3*t+3*e}function o(e,t){return 3*t-6*e}function a(e){return 3*e}function s(e,t,r){return((n(t,r)*e+o(t,r))*e+a(t))*e}function c(e,t,r){return 3*n(t,r)*e*e+2*o(t,r)*e+a(t)}function u(t){for(var i=t,n=0;4>n;++n){var o=c(i,e,r);if(0==o)return i;var a=s(i,e,r)-t;i-=a/o}return i}this.get=function(n){return e==t&&r==i?n:s(u(n),t,i)}}function B_Spline_Generator(e){var t=e.length,r=t-1,i=t+2,n=(t+1)/100;return function(t){t=0>t?0:t>100?100:t;var o,a,s,c,u,l=n*t-1,h={x:0,y:0};for(o=-2;i>o;o++)c=l-o,s=(c=Math.abs(c))<1?(u=c*c*3,(c*u-2*u+4)/6):2>c?(u=c-2,u*u*u/-6):0,a=0>o?0:o>r?r:o,h.x+=e[a][0]*s,h.y+=e[a][1]*s;return h}}function supportCssProperty(e){"string"==typeof e&&(e=[e]);for(var t=0;t<e.length;t++){var r=e[t],i=document.body;if("string"!=typeof i.style[r]&&"string"!=typeof i.style["Webkit"+r.substring(0,1).toUpperCase()+r.substring(1)]&&"string"!=typeof i.style["Moz"+r.substring(0,1).toUpperCase()+r.substring(1)]&&"string"!=typeof i.style["O"+r.substring(0,1).toUpperCase()+r.substring(1)])return!1}return!0}function hexToRgb(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function wheelDistance(e){e||(e=event);var t=0,r=0,i=e.wheelDelta,n=e.detail;return n?i?r=i/n/40*n>0?1:-1:e.deltaX||e.deltaY?(t=e.deltaX,r=e.deltaY):r=-n/3:e.wheelDeltaX||e.wheelDeltaY?(r=e.wheelDeltaY/120,t=e.wheelDeltaX/120):e.deltaX||e.deltaY?(t=-e.deltaX/3,r=-e.deltaY/3):r=i/120,"DOMMouseScroll"==e.type?(r*=40,t*=40):browser.isIE||(r*=10,t*=10),{x:t,y:r}}function multiplyMatrix(e,t){for(var r=e.length,i=e[0].length,n=(t.length,t[0].length),o=[],a=0;r>a;a++){o[a]=[];for(var s=0;n>s;s++){for(var c=0,u=0;i>u;u++)c+=e[a][u]*t[u][s];o[a][s]=c}}return o}function layerToPageAndLayerNumber(e){for(var t=0;t<o2.foreLayers.messageLayers.length;t++){var r=o2.foreLayers.messageLayers[t];if(e==r)return{page:"fore",layer:t}}for(var t=0;t<o2.backLayers.messageLayers.length;t++){var r=o2.backLayers.messageLayers[t];if(e==r)return{page:"back",layer:t}}}function setupEventHandlers(){var e,t;$("body").on("touchend",function(){window.scrollTo(0,0),scaleToFitPage()}),$(o2).on("click",function(){o2.autoMode?o2.cancelAutoMode():o2.skipMode>o2.SKIP_MODE_CLICK&&o2.skipMode<=o2.SKIP_MODE_STOP&&(o2.skipMode=o2.SKIP_MODE_NONE),o2.hideGlyph(),currentConductor.trigger("click")}),$("body").on("touchstart mousedown",function(e){GestureManager.eventHandlers.start(e)}).on("touchmove mousemove",function(e){GestureManager.eventHandlers.move(e)}).on("touchend mouseup",function(e){GestureManager.eventHandlers.end(e)}).on("touchcancel mouseleave",function(e){GestureManager.eventHandlers.cancel(e)});var r=new GestureRecognizer({numberOfTouches:0,maxNumberOfTouches:0,common:function(e,t){if(t&&(t.preventDefault(),ev.cursorLocation=t.originalEvent.normalizedCoordinate()),o2.historyLayer.visible)return t&&3==t.which?(o2.historyLayer.hide("up",!1),!0):(o2.historyLayer[e]&&o2.historyLayer[e](t)?o2.setCursorStyle("pointer"):o2.setCursorStyle("default"),!0);if(t&&3!=t.which)for(var r=o2.foreLayers.messageLayers.length-1;r>=0;r--){var i=o2.foreLayers.messageLayers[r];if(i[e]&&i[e](t))return t.stopImmediatePropagation(),o2.setCursorStyle("pointer"),!0}return o2.setCursorStyle("default"),!1},start:function(e){e.originalEvent.touches&&(this.numberOfTouches=e.originalEvent.touches.length,this.numberOfTouches>this.maxNumberOfTouches&&(this.maxNumberOfTouches=this.numberOfTouches)),this.state=GestureRecognizer.STATE.POSSIBLE,this.common("mousedown",e)},move:function(e){this.common("mousemove",e)},end:function(e){e.originalEvent.touches&&(this.numberOfTouches=e.originalEvent.touches.length),2==this.maxNumberOfTouches&&(e.which=3),this.common("mouseup",e)||0==this.numberOfTouches&&(3==e.which||2==this.maxNumberOfTouches?$(o2).trigger("rclick"):$(o2).trigger("click")),this.numberOfTouches<=0&&(this.numberOfTouches=0,this.maxNumberOfTouches=0,this.state=GestureRecognizer.STATE.CANCELLED)},cancel:function(){this.numberOfTouches=0,this.maxNumberOfTouches=0,this.failed(),this.common("cancel")}});GestureManager.addRecognizer(r);var i=new GestureRecognizer({start:function(e){this.state=GestureRecognizer.STATE.POSSIBLE,e.originalEvent.touches&&3==e.originalEvent.touches.length&&(this.satisified(),o2.historyLayer.visible||o2.skipToStopForcibly())},move:function(e){},end:function(e){e.originalEvent.touches&&e.originalEvent.touches.length<3&&this.state==GestureRecognizer.STATE.SATISIFIED&&(o2.skipMode=o2.SKIP_MODE_NONE),e.originalEvent.touches&&e.originalEvent.touches.length<=0?this.cancel():e.originalEvent.touches||this.cancel()},cancel:function(e){this.failed()}});GestureManager.addRecognizer(i);var n=GestureRecognizer.accumulateRecognizer(-20,20,100,void 0,function(){o2.historyLayer.visible||o2.historyLayer.vertical||o2.historyLayer.touchmoved({x:0,y:30})}),o=GestureRecognizer.accumulateRecognizer(void 0,0,-20,20,function(){!o2.historyLayer.visible&&o2.historyLayer.vertical&&o2.historyLayer.touchmoved({x:-30,y:0})}),a=n.satisified;n.satisified=function(){return o2.historyLayer.visible||o2.historyLayer.vertical?void 0:a.apply(this,arguments)},o.satisified=function(){return!o2.historyLayer.visible&&o2.historyLayer.vertical?a.apply(this,arguments):void 0},GestureManager.addRecognizer(n),GestureManager.addRecognizer(o),n.shouldCancelOtherRecognizer=o.shouldCancelOtherRecognizer=function(e){return e!=s};var s=GestureRecognizer.basicRecognizer("absolute",function(e,t,r){o2.historyLayer.visible&&(s.lastPoint&&o2.historyLayer.touchmoved({x:t-s.lastPoint.x,y:r-s.lastPoint.y}),"end"==e?s.lastPoint=void 0:s.lastPoint={x:t,y:r})});s.mutualExclusive=!1,GestureManager.addRecognizer(s),$("body").on("keydown",function(r){if("keyCode"in r)switch(r.keyCode){case 37:o2.historyLayer.scrolled({x:30,y:0});break;case 38:o2.historyLayer.scrolled({x:0,y:30});break;case 39:o2.historyLayer.scrolled({x:-30,y:0});break;case 40:o2.historyLayer.visible&&o2.historyLayer.scrolled({x:0,y:-30});break;case 13:t?o2.skipMode||o2.skipToStopForcibly():(t=!0,o2.historyLayer.visible||$(o2).trigger("click"));break;case 17:if(e)return;if(o2.historyLayer.visible)return;e=!0,o2.skipToStopForcibly()}}),$("body").on("keyup",function(r){if("keyCode"in r)switch(r.keyCode){case 17:e=!1,o2.skipMode=o2.SKIP_MODE_NONE;break;case 13:t=!1,o2.skipMode=o2.SKIP_MODE_NONE}}),$("body").on("mousewheel DOMMouseScroll wheel",function(e){e.preventDefault();var t=wheelDistance(e.originalEvent);o2.historyLayer.scrolled(t)});$("body").on("touchstart touchmove touchend touchcancel",function(e){var t=e.originalEvent;t.normalizedCoordinate();"button"!=e.target.type&&e.preventDefault()}),$("body").on("contextmenu",function(e){e.preventDefault()})}function initialize(e){function t(e,t){var r,i=defaultConfig[e];switch(i&&(r=i[0]),r){case"number":config[e]=Number(t);break;case"opacity":config[e]=Number(t)/255;break;case"boolean":"boolean"==typeof t?config[e]=t:"true"==t.toLowerCase()?config[e]=!0:"false"==t.toLowerCase()?config[e]=!1:config[e]=Boolean(t);break;case"color":config[e]=t.replace("0x","#");break;default:config[e]=t}}for(var r in defaultConfig)t(r,defaultConfig[r][1]);for(var r in e.config)t(r,e.config[r]);document.title=config.title,sf.__system.useUserChSpeed=!1,sf.__system.userChSpeed=config.chSpeeds,sf.__system.userCh2ndSpeed=config.userCh2ndSpeed,sf.__system.autoModeLineWait=config.autoModeLineWait,sf.__system.autoModePageWait=config.autoModePageWait;var i={videolist:"videoList",imagelist:"imageList",soundlist:"soundList",fontlist:"fontList"};for(var n in i)i.hasOwnProperty(n)&&"object"==typeof e[n]&&(o2[i[n]]=e[n]);for(var o=0;o<config.numSEBuffers;o++)o2.se.push(new Sound);for(var o=0;o<config.numMovies;o++)o2.videos.push(new Video);if("bgm"==config.priorityAudioChannel)o2.prioritySound=o2.bgm;else{var a=config.priorityAudioChannel.match(/se([0-9]+)/);null==a&&o2.error("config.jsonのpriorityAudioChannelはbgmか、se[0-9]+じゃなければいけないです");var s=parseFloat(a[1]);o2.prioritySound=o2.se[s],o2.prioritySound||o2.error("config.jsonで指定されたpriorityAudioChannelは無効です。")}o2.foreLayers.baseLayer=new BaseLayer,o2.backLayers.baseLayer=new BaseLayer;for(var o=0;o<config.numImageLayers;o++){var c=new ImageLayer;o2.foreLayers.imageLayers.push(c),c=new ImageLayer,o2.backLayers.imageLayers.push(c)}for(var o=0;o<config.numMessageLayers;o++){var c=new MessageLayer;o2.foreLayers.messageLayers.push(c),c=new MessageLayer,o2.backLayers.messageLayers.push(c)}o2.currentMessageLayer=o2.foreLayers.messageLayers[0],o2.foreLayers.messageLayers[0].visible=o2.backLayers.messageLayers[0].visible=config.initialMessageLayerVisible,o2.historyLayer=new HistoryLayer,o2.glyphLayer=new GlyphLayer,window.renderer=new Renderer,o2.resetLayersIndex(),o2.refreshRendererLayers(),$("#main-wrapper").append(renderer.foreCanvas),$("#main-wrapper").css({width:config.scWidth+"px",height:config.scHeight+"px"}),e.manifest&&KAGFiles.setupManifest(e.manifest);for(var u in e.scripts){var l=e.scripts[u];KAGFile.create(u,l)}$("body").css("background-color",config.backgroundColor),scaleToFitPage(),$(window).on("resize",scaleToFitPage)}function getScripts(e,t){o2.serverStat.mode=o2.SERVER_MODE_O2SERVER,$.ajax({url:e,data:t,type:t?"POST":"GET",success:function(e){"string"==typeof e&&(e=JSON.parse(e)),initScripts(e)}})}function initScripts(e){initialize(e),e=null,extraConductor=new SubRoutineConductor,o2.serverStat.mode===o2.SERVER_MODE_O2SERVER&&(o2.currentSaveAdapter=new Tag.actions.save.adapters.O2ServerAdapter);var t=KAGFiles("first.ks");$.when(t).then(function(e){currentConductor=conductor=new Conductor({file:e}),conductor.run(),setupEventHandlers(),$(o2).trigger("init"),window.parent!=window.self&&window.parent.postMessage("scriptLoaded","*")}),(browser.isIOs||browser.isAndroid)&&$("body").one("touchstart",function(e){o2.bgm.dummyLoad();for(var t=o2.se.length-1;t>=0;t--)o2.se[t].dummyLoad();for(var t=o2.videos.length-1;t>=0;t--)o2.videos[t].dummyLoad()}),window.FPSMeter&&(window.meter=new FPSMeter({smoothing:2,position:"fixed",top:"auto",left:"auto",bottom:"0px",right:"0px",graph:1,heat:1}))}!function(e,t){function r(e){var t=e.length,r=oe.type(e);return oe.isWindow(e)?!1:1===e.nodeType&&t?!0:"array"===r||"function"!==r&&(0===t||"number"==typeof t&&t>0&&t-1 in e)}function i(e){var t=pe[e]={};return oe.each(e.match(se)||[],function(e,r){t[r]=!0}),t}function n(){Object.defineProperty(this.cache={},0,{get:function(){return{}}}),this.expando=oe.expando+Math.random()}function o(e,r,i){var n;if(i===t&&1===e.nodeType)if(n="data-"+r.replace(ve,"-$1").toLowerCase(),i=e.getAttribute(n),"string"==typeof i){try{i="true"===i?!0:"false"===i?!1:"null"===i?null:+i+""===i?+i:me.test(i)?JSON.parse(i):i}catch(o){}ge.set(e,r,i)}else i=t;return i}function a(){return!0}function s(){return!1}function c(){try{return $.activeElement}catch(e){}}function u(e,t){for(;(e=e[t])&&1!==e.nodeType;);return e}function l(e,t,r){if(oe.isFunction(t))return oe.grep(e,function(e,i){return!!t.call(e,i,e)!==r});if(t.nodeType)return oe.grep(e,function(e){return e===t!==r});if("string"==typeof t){if(Oe.test(t))return oe.filter(t,e,r);t=oe.filter(t,e)}return oe.grep(e,function(e){return te.call(t,e)>=0!==r})}function h(e,t){return oe.nodeName(e,"table")&&oe.nodeName(1===t.nodeType?t:t.firstChild,"tr")?e.getElementsByTagName("tbody")[0]||e.appendChild(e.ownerDocument.createElement("tbody")):e}function f(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function d(e){var t=Pe.exec(e.type);return t?e.type=t[1]:e.removeAttribute("type"),e}function p(e,t){for(var r=e.length,i=0;r>i;i++)ye.set(e[i],"globalEval",!t||ye.get(t[i],"globalEval"))}function g(e,t){var r,i,n,o,a,s,c,u;if(1===t.nodeType){if(ye.hasData(e)&&(o=ye.access(e),a=oe.extend({},o),u=o.events,ye.set(t,a),u)){delete a.handle,a.events={};for(n in u)for(r=0,i=u[n].length;i>r;r++)oe.event.add(t,n,u[n][r])}ge.hasData(e)&&(s=ge.access(e),c=oe.extend({},s),ge.set(t,c))}}function y(e,r){var i=e.getElementsByTagName?e.getElementsByTagName(r||"*"):e.querySelectorAll?e.querySelectorAll(r||"*"):[];return r===t||r&&oe.nodeName(e,r)?oe.merge([e],i):i}function m(e,t){var r=t.nodeName.toLowerCase();"input"===r&&Me.test(e.type)?t.checked=e.checked:("input"===r||"textarea"===r)&&(t.defaultValue=e.defaultValue)}function v(e,t){if(t in e)return t;for(var r=t.charAt(0).toUpperCase()+t.slice(1),i=t,n=Ze.length;n--;)if(t=Ze[n]+r,t in e)return t;return i}function w(e,t){return e=t||e,"none"===oe.css(e,"display")||!oe.contains(e.ownerDocument,e)}function T(t){return e.getComputedStyle(t,null)}function b(e,t){for(var r,i,n,o=[],a=0,s=e.length;s>a;a++)i=e[a],i.style&&(o[a]=ye.get(i,"olddisplay"),r=i.style.display,t?(o[a]||"none"!==r||(i.style.display=""),""===i.style.display&&w(i)&&(o[a]=ye.access(i,"olddisplay",S(i.nodeName)))):o[a]||(n=w(i),(r&&"none"!==r||!n)&&ye.set(i,"olddisplay",n?r:oe.css(i,"display"))));for(a=0;s>a;a++)i=e[a],i.style&&(t&&"none"!==i.style.display&&""!==i.style.display||(i.style.display=t?o[a]||"":"none"));return e}function L(e,t,r){var i=$e.exec(t);return i?Math.max(0,i[1]-(r||0))+(i[2]||"px"):t}function x(e,t,r,i,n){for(var o=r===(i?"border":"content")?4:"width"===t?1:0,a=0;4>o;o+=2)"margin"===r&&(a+=oe.css(e,r+Je[o],!0,n)),i?("content"===r&&(a-=oe.css(e,"padding"+Je[o],!0,n)),"margin"!==r&&(a-=oe.css(e,"border"+Je[o]+"Width",!0,n))):(a+=oe.css(e,"padding"+Je[o],!0,n),"padding"!==r&&(a+=oe.css(e,"border"+Je[o]+"Width",!0,n)));return a}function C(e,t,r){var i=!0,n="width"===t?e.offsetWidth:e.offsetHeight,o=T(e),a=oe.support.boxSizing&&"border-box"===oe.css(e,"boxSizing",!1,o);if(0>=n||null==n){if(n=qe(e,t,o),(0>n||null==n)&&(n=e.style[t]),Ke.test(n))return n;i=a&&(oe.support.boxSizingReliable||n===e.style[t]),n=parseFloat(n)||0}return n+x(e,t,r||(a?"border":"content"),i,o)+"px"}function S(e){var t=$,r=Ye[e];return r||(r=k(e,t),"none"!==r&&r||(Ve=(Ve||oe("<iframe frameborder='0' width='0' height='0'/>").css("cssText","display:block !important")).appendTo(t.documentElement),t=(Ve[0].contentWindow||Ve[0].contentDocument).document,t.write("<!doctype html><html><body>"),t.close(),r=k(e,t),Ve.detach()),Ye[e]=r),r}function k(e,t){var r=oe(t.createElement(e)).appendTo(t.body),i=oe.css(r[0],"display");return r.remove(),i}function A(e,t,r,i){var n;if(oe.isArray(t))oe.each(t,function(t,n){r||et.test(e)?i(e,n):A(e+"["+("object"==typeof n?t:"")+"]",n,r,i)});else if(r||"object"!==oe.type(t))i(e,t);else for(n in t)A(e+"["+n+"]",t[n],r,i)}function O(e){return function(t,r){"string"!=typeof t&&(r=t,t="*");var i,n=0,o=t.toLowerCase().match(se)||[];if(oe.isFunction(r))for(;i=o[n++];)"+"===i[0]?(i=i.slice(1)||"*",(e[i]=e[i]||[]).unshift(r)):(e[i]=e[i]||[]).push(r)}}function R(e,r,i,n){function o(c){var u;return a[c]=!0,oe.each(e[c]||[],function(e,c){var l=c(r,i,n);return"string"!=typeof l||s||a[l]?s?!(u=l):t:(r.dataTypes.unshift(l),o(l),!1)}),u}var a={},s=e===mt;return o(r.dataTypes[0])||!a["*"]&&o("*")}function N(e,r){var i,n,o=oe.ajaxSettings.flatOptions||{};for(i in r)r[i]!==t&&((o[i]?e:n||(n={}))[i]=r[i]);return n&&oe.extend(!0,e,n),e}function E(e,r,i){for(var n,o,a,s,c=e.contents,u=e.dataTypes;"*"===u[0];)u.shift(),n===t&&(n=e.mimeType||r.getResponseHeader("Content-Type"));if(n)for(o in c)if(c[o]&&c[o].test(n)){u.unshift(o);break}if(u[0]in i)a=u[0];else{for(o in i){if(!u[0]||e.converters[o+" "+u[0]]){a=o;break}s||(s=o)}a=a||s}return a?(a!==u[0]&&u.unshift(a),i[a]):t}function _(e,t,r,i){var n,o,a,s,c,u={},l=e.dataTypes.slice();if(l[1])for(a in e.converters)u[a.toLowerCase()]=e.converters[a];for(o=l.shift();o;)if(e.responseFields[o]&&(r[e.responseFields[o]]=t),!c&&i&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),c=o,o=l.shift())if("*"===o)o=c;else if("*"!==c&&c!==o){if(a=u[c+" "+o]||u["* "+o],!a)for(n in u)if(s=n.split(" "),s[1]===o&&(a=u[c+" "+s[0]]||u["* "+s[0]])){a===!0?a=u[n]:u[n]!==!0&&(o=s[0],l.unshift(s[1]));break}if(a!==!0)if(a&&e["throws"])t=a(t);else try{t=a(t)}catch(h){return{state:"parsererror",error:a?h:"No conversion from "+c+" to "+o}}}return{state:"success",data:t}}function I(){return setTimeout(function(){kt=t}),kt=oe.now()}function D(e,t){oe.each(t,function(t,r){for(var i=(_t[t]||[]).concat(_t["*"]),n=0,o=i.length;o>n;n++)if(i[n].call(e,t,r))return})}function M(e,t,r){var i,n,o=0,a=Et.length,s=oe.Deferred().always(function(){delete c.elem}),c=function(){if(n)return!1;for(var t=kt||I(),r=Math.max(0,u.startTime+u.duration-t),i=r/u.duration||0,o=1-i,a=0,c=u.tweens.length;c>a;a++)u.tweens[a].run(o);return s.notifyWith(e,[u,o,r]),1>o&&c?r:(s.resolveWith(e,[u]),!1)},u=s.promise({elem:e,props:oe.extend({},t),opts:oe.extend(!0,{specialEasing:{}},r),originalProperties:t,originalOptions:r,startTime:kt||I(),duration:r.duration,tweens:[],createTween:function(t,r){var i=oe.Tween(e,u.opts,t,r,u.opts.specialEasing[t]||u.opts.easing);return u.tweens.push(i),i},stop:function(t){var r=0,i=t?u.tweens.length:0;if(n)return this;for(n=!0;i>r;r++)u.tweens[r].run(1);return t?s.resolveWith(e,[u,t]):s.rejectWith(e,[u,t]),this}}),l=u.props;for(F(l,u.opts.specialEasing);a>o;o++)if(i=Et[o].call(u,e,l,u.opts))return i;return D(u,l),oe.isFunction(u.opts.start)&&u.opts.start.call(e,u),oe.fx.timer(oe.extend(c,{elem:e,anim:u,queue:u.opts.queue})),u.progress(u.opts.progress).done(u.opts.done,u.opts.complete).fail(u.opts.fail).always(u.opts.always)}function F(e,t){var r,i,n,o,a;for(r in e)if(i=oe.camelCase(r),n=t[i],o=e[r],oe.isArray(o)&&(n=o[1],o=e[r]=o[0]),r!==i&&(e[i]=o,delete e[r]),a=oe.cssHooks[i],a&&"expand"in a){o=a.expand(o),delete e[i];for(r in o)r in e||(e[r]=o[r],t[r]=n)}else t[i]=n}function B(e,r,i){var n,o,a,s,c,u,l,h,f,d=this,p=e.style,g={},y=[],m=e.nodeType&&w(e);i.queue||(h=oe._queueHooks(e,"fx"),null==h.unqueued&&(h.unqueued=0,f=h.empty.fire,h.empty.fire=function(){h.unqueued||f()}),h.unqueued++,d.always(function(){d.always(function(){h.unqueued--,oe.queue(e,"fx").length||h.empty.fire()})})),1===e.nodeType&&("height"in r||"width"in r)&&(i.overflow=[p.overflow,p.overflowX,p.overflowY],"inline"===oe.css(e,"display")&&"none"===oe.css(e,"float")&&(p.display="inline-block")),i.overflow&&(p.overflow="hidden",d.always(function(){p.overflow=i.overflow[0],p.overflowX=i.overflow[1],p.overflowY=i.overflow[2]})),c=ye.get(e,"fxshow");for(n in r)if(a=r[n],Ot.exec(a)){if(delete r[n],u=u||"toggle"===a,a===(m?"hide":"show")){if("show"!==a||c===t||c[n]===t)continue;m=!0}y.push(n)}if(s=y.length){c=ye.get(e,"fxshow")||ye.access(e,"fxshow",{}),"hidden"in c&&(m=c.hidden),u&&(c.hidden=!m),m?oe(e).show():d.done(function(){oe(e).hide()}),d.done(function(){var t;ye.remove(e,"fxshow");for(t in g)oe.style(e,t,g[t])});for(n=0;s>n;n++)o=y[n],l=d.createTween(o,m?c[o]:0),g[o]=c[o]||oe.style(e,o),o in c||(c[o]=l.start,m&&(l.end=l.start,l.start="width"===o||"height"===o?1:0))}}function P(e,t,r,i,n){return new P.prototype.init(e,t,r,i,n)}function G(e,t){var r,i={height:e},n=0;for(t=t?1:0;4>n;n+=2-t)r=Je[n],i["margin"+r]=i["padding"+r]=e;return t&&(i.opacity=i.width=e),i}function z(e){return oe.isWindow(e)?e:9===e.nodeType&&e.defaultView}var q,V,j=typeof t,H=e.location,$=e.document,K=$.documentElement,W=e.jQuery,Y=e.$,U={},X=[],J="2.0.0",Z=X.concat,Q=X.push,ee=X.slice,te=X.indexOf,re=U.toString,ie=U.hasOwnProperty,ne=J.trim,oe=function(e,t){return new oe.fn.init(e,t,q)},ae=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,se=/\S+/g,ce=/^(?:(<[\w\W]+>)[^>]*|#([\w-]*))$/,ue=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,le=/^-ms-/,he=/-([\da-z])/gi,fe=function(e,t){return t.toUpperCase()},de=function(){$.removeEventListener("DOMContentLoaded",de,!1),e.removeEventListener("load",de,!1),oe.ready()};oe.fn=oe.prototype={jquery:J,constructor:oe,init:function(e,r,i){var n,o;if(!e)return this;if("string"==typeof e){if(n="<"===e.charAt(0)&&">"===e.charAt(e.length-1)&&e.length>=3?[null,e,null]:ce.exec(e),!n||!n[1]&&r)return!r||r.jquery?(r||i).find(e):this.constructor(r).find(e);if(n[1]){if(r=r instanceof oe?r[0]:r,oe.merge(this,oe.parseHTML(n[1],r&&r.nodeType?r.ownerDocument||r:$,!0)),ue.test(n[1])&&oe.isPlainObject(r))for(n in r)oe.isFunction(this[n])?this[n](r[n]):this.attr(n,r[n]);return this}return o=$.getElementById(n[2]),o&&o.parentNode&&(this.length=1,this[0]=o),this.context=$,this.selector=e,this}return e.nodeType?(this.context=this[0]=e,this.length=1,this):oe.isFunction(e)?i.ready(e):(e.selector!==t&&(this.selector=e.selector,this.context=e.context),oe.makeArray(e,this))},selector:"",length:0,toArray:function(){return ee.call(this)},get:function(e){return null==e?this.toArray():0>e?this[this.length+e]:this[e]},pushStack:function(e){var t=oe.merge(this.constructor(),e);return t.prevObject=this,t.context=this.context,t},each:function(e,t){return oe.each(this,e,t)},ready:function(e){return oe.ready.promise().done(e),this},slice:function(){return this.pushStack(ee.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,r=+e+(0>e?t:0);return this.pushStack(r>=0&&t>r?[this[r]]:[])},map:function(e){return this.pushStack(oe.map(this,function(t,r){return e.call(t,r,t)}))},end:function(){return this.prevObject||this.constructor(null)},push:Q,sort:[].sort,splice:[].splice},oe.fn.init.prototype=oe.fn,oe.extend=oe.fn.extend=function(){var e,r,i,n,o,a,s=arguments[0]||{},c=1,u=arguments.length,l=!1;for("boolean"==typeof s&&(l=s,s=arguments[1]||{},c=2),"object"==typeof s||oe.isFunction(s)||(s={}),u===c&&(s=this,--c);u>c;c++)if(null!=(e=arguments[c]))for(r in e)i=s[r],n=e[r],s!==n&&(l&&n&&(oe.isPlainObject(n)||(o=oe.isArray(n)))?(o?(o=!1,a=i&&oe.isArray(i)?i:[]):a=i&&oe.isPlainObject(i)?i:{},s[r]=oe.extend(l,a,n)):n!==t&&(s[r]=n));return s},oe.extend({expando:"jQuery"+(J+Math.random()).replace(/\D/g,""),noConflict:function(t){return e.$===oe&&(e.$=Y),t&&e.jQuery===oe&&(e.jQuery=W),oe},isReady:!1,readyWait:1,holdReady:function(e){e?oe.readyWait++:oe.ready(!0)},ready:function(e){(e===!0?--oe.readyWait:oe.isReady)||(oe.isReady=!0,e!==!0&&--oe.readyWait>0||(V.resolveWith($,[oe]),oe.fn.trigger&&oe($).trigger("ready").off("ready")))},isFunction:function(e){return"function"===oe.type(e)},isArray:Array.isArray,isWindow:function(e){return null!=e&&e===e.window},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},type:function(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?U[re.call(e)]||"object":typeof e},isPlainObject:function(e){if("object"!==oe.type(e)||e.nodeType||oe.isWindow(e))return!1;try{if(e.constructor&&!ie.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(t){return!1}return!0},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},error:function(e){throw Error(e)},parseHTML:function(e,t,r){if(!e||"string"!=typeof e)return null;"boolean"==typeof t&&(r=t,t=!1),t=t||$;var i=ue.exec(e),n=!r&&[];return i?[t.createElement(i[1])]:(i=oe.buildFragment([e],t,n),n&&oe(n).remove(),oe.merge([],i.childNodes))},parseJSON:JSON.parse,parseXML:function(e){var r,i;if(!e||"string"!=typeof e)return null;try{i=new DOMParser,r=i.parseFromString(e,"text/xml")}catch(n){r=t}return(!r||r.getElementsByTagName("parsererror").length)&&oe.error("Invalid XML: "+e),r},noop:function(){},globalEval:function(e){var t,r=eval;e=oe.trim(e),e&&(1===e.indexOf("use strict")?(t=$.createElement("script"),t.text=e,$.head.appendChild(t).parentNode.removeChild(t)):r(e))},camelCase:function(e){return e.replace(le,"ms-").replace(he,fe)},nodeName:function(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()},each:function(e,t,i){var n,o=0,a=e.length,s=r(e);if(i){if(s)for(;a>o&&(n=t.apply(e[o],i),n!==!1);o++);else for(o in e)if(n=t.apply(e[o],i),n===!1)break}else if(s)for(;a>o&&(n=t.call(e[o],o,e[o]),n!==!1);o++);else for(o in e)if(n=t.call(e[o],o,e[o]),n===!1)break;return e},trim:function(e){return null==e?"":ne.call(e)},makeArray:function(e,t){var i=t||[];return null!=e&&(r(Object(e))?oe.merge(i,"string"==typeof e?[e]:e):Q.call(i,e)),i},inArray:function(e,t,r){return null==t?-1:te.call(t,e,r)},merge:function(e,r){var i=r.length,n=e.length,o=0;if("number"==typeof i)for(;i>o;o++)e[n++]=r[o];else for(;r[o]!==t;)e[n++]=r[o++];return e.length=n,e},grep:function(e,t,r){var i,n=[],o=0,a=e.length;for(r=!!r;a>o;o++)i=!!t(e[o],o),r!==i&&n.push(e[o]);return n},map:function(e,t,i){var n,o=0,a=e.length,s=r(e),c=[];if(s)for(;a>o;o++)n=t(e[o],o,i),null!=n&&(c[c.length]=n);else for(o in e)n=t(e[o],o,i),null!=n&&(c[c.length]=n);return Z.apply([],c)},guid:1,proxy:function(e,r){var i,n,o;return"string"==typeof r&&(i=e[r],r=e,e=i),oe.isFunction(e)?(n=ee.call(arguments,2),o=function(){return e.apply(r||this,n.concat(ee.call(arguments)))},o.guid=e.guid=e.guid||oe.guid++,o):t},access:function(e,r,i,n,o,a,s){var c=0,u=e.length,l=null==i;if("object"===oe.type(i)){o=!0;for(c in i)oe.access(e,r,c,i[c],!0,a,s)}else if(n!==t&&(o=!0,oe.isFunction(n)||(s=!0),l&&(s?(r.call(e,n),r=null):(l=r,r=function(e,t,r){return l.call(oe(e),r)})),r))for(;u>c;c++)r(e[c],i,s?n:n.call(e[c],c,r(e[c],i)));return o?e:l?r.call(e):u?r(e[0],i):a},now:Date.now,swap:function(e,t,r,i){var n,o,a={};for(o in t)a[o]=e.style[o],e.style[o]=t[o];n=r.apply(e,i||[]);for(o in t)e.style[o]=a[o];return n}}),oe.ready.promise=function(t){return V||(V=oe.Deferred(),"complete"===$.readyState?setTimeout(oe.ready):($.addEventListener("DOMContentLoaded",de,!1),e.addEventListener("load",de,!1))),V.promise(t)},oe.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(e,t){U["[object "+t+"]"]=t.toLowerCase()}),q=oe($),function(e,t){function r(e){return we.test(e+"")}function i(){var e,t=[];return e=function(r,i){return t.push(r+=" ")>k.cacheLength&&delete e[t.shift()],e[r]=i}}function n(e){return e[z]=!0,e}function o(e){var t=I.createElement("div");try{return!!e(t)}catch(r){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function a(e,t,r,i){var n,o,a,s,c,u,l,h,f,g;if((t?t.ownerDocument||t:q)!==I&&_(t),t=t||I,r=r||[],!e||"string"!=typeof e)return r;if(1!==(s=t.nodeType)&&9!==s)return[];if(M&&!i){if(n=Te.exec(e))if(a=n[1]){if(9===s){if(o=t.getElementById(a),!o||!o.parentNode)return r;if(o.id===a)return r.push(o),r}else if(t.ownerDocument&&(o=t.ownerDocument.getElementById(a))&&G(t,o)&&o.id===a)return r.push(o),r}else{if(n[2])return te.apply(r,t.getElementsByTagName(e)),r;if((a=n[3])&&V.getElementsByClassName&&t.getElementsByClassName)return te.apply(r,t.getElementsByClassName(a)),r}if(V.qsa&&(!F||!F.test(e))){if(h=l=z,f=t,g=9===s&&e,1===s&&"object"!==t.nodeName.toLowerCase()){for(u=d(e),(l=t.getAttribute("id"))?h=l.replace(xe,"\\$&"):t.setAttribute("id",h),h="[id='"+h+"'] ",c=u.length;c--;)u[c]=h+p(u[c]);f=pe.test(e)&&t.parentNode||t,g=u.join(",")}if(g)try{return te.apply(r,f.querySelectorAll(g)),r}catch(y){}finally{l||t.removeAttribute("id")}}}return L(e.replace(he,"$1"),t,r,i)}function s(e,t){var r=t&&e,i=r&&(~t.sourceIndex||J)-(~e.sourceIndex||J);if(i)return i;if(r)for(;r=r.nextSibling;)if(r===t)return-1;return e?1:-1}function c(e,r,i){var n;return i?t:(n=e.getAttributeNode(r))&&n.specified?n.value:e[r]===!0?r.toLowerCase():null}function u(e,r,i){var n;return i?t:n=e.getAttribute(r,"type"===r.toLowerCase()?1:2)}function l(e){return function(t){var r=t.nodeName.toLowerCase();return"input"===r&&t.type===e}}function h(e){return function(t){var r=t.nodeName.toLowerCase();return("input"===r||"button"===r)&&t.type===e}}function f(e){return n(function(t){return t=+t,n(function(r,i){for(var n,o=e([],r.length,t),a=o.length;a--;)r[n=o[a]]&&(r[n]=!(i[n]=r[n]))})})}function d(e,t){var r,i,n,o,s,c,u,l=K[e+" "];if(l)return t?0:l.slice(0);for(s=e,c=[],u=k.preFilter;s;){(!r||(i=fe.exec(s)))&&(i&&(s=s.slice(i[0].length)||s),c.push(n=[])),r=!1,(i=de.exec(s))&&(r=i.shift(),n.push({value:r,type:i[0].replace(he," ")}),s=s.slice(r.length));for(o in k.filter)!(i=ve[o].exec(s))||u[o]&&!(i=u[o](i))||(r=i.shift(),n.push({value:r,type:o,matches:i}),s=s.slice(r.length));if(!r)break}return t?s.length:s?a.error(e):K(e,c).slice(0)}function p(e){for(var t=0,r=e.length,i="";r>t;t++)i+=e[t].value;return i}function g(e,t,r){var i=t.dir,n=r&&"parentNode"===i,o=H++;return t.first?function(t,r,o){for(;t=t[i];)if(1===t.nodeType||n)return e(t,r,o)}:function(t,r,a){var s,c,u,l=j+" "+o;if(a){for(;t=t[i];)if((1===t.nodeType||n)&&e(t,r,a))return!0}else for(;t=t[i];)if(1===t.nodeType||n)if(u=t[z]||(t[z]={}),(c=u[i])&&c[0]===l){if((s=c[1])===!0||s===S)return s===!0}else if(c=u[i]=[l],c[1]=e(t,r,a)||S,c[1]===!0)return!0}}function y(e){return e.length>1?function(t,r,i){for(var n=e.length;n--;)if(!e[n](t,r,i))return!1;return!0}:e[0]}function m(e,t,r,i,n){for(var o,a=[],s=0,c=e.length,u=null!=t;c>s;s++)(o=e[s])&&(!r||r(o,i,n))&&(a.push(o),u&&t.push(s));return a}function v(e,t,r,i,o,a){return i&&!i[z]&&(i=v(i)),o&&!o[z]&&(o=v(o,a)),n(function(n,a,s,c){var u,l,h,f=[],d=[],p=a.length,g=n||b(t||"*",s.nodeType?[s]:s,[]),y=!e||!n&&t?g:m(g,f,e,s,c),v=r?o||(n?e:p||i)?[]:a:y;if(r&&r(y,v,s,c),i)for(u=m(v,d),i(u,[],s,c),l=u.length;l--;)(h=u[l])&&(v[d[l]]=!(y[d[l]]=h));if(n){if(o||e){if(o){for(u=[],l=v.length;l--;)(h=v[l])&&u.push(y[l]=h);o(null,v=[],u,c)}for(l=v.length;l--;)(h=v[l])&&(u=o?ie.call(n,h):f[l])>-1&&(n[u]=!(a[u]=h))}}else v=m(v===a?v.splice(p,v.length):v),o?o(null,a,v,c):te.apply(a,v)})}function w(e){for(var t,r,i,n=e.length,o=k.relative[e[0].type],a=o||k.relative[" "],s=o?1:0,c=g(function(e){return e===t},a,!0),u=g(function(e){return ie.call(t,e)>-1},a,!0),l=[function(e,r,i){return!o&&(i||r!==N)||((t=r).nodeType?c(e,r,i):u(e,r,i))}];n>s;s++)if(r=k.relative[e[s].type])l=[g(y(l),r)];else{if(r=k.filter[e[s].type].apply(null,e[s].matches),r[z]){for(i=++s;n>i&&!k.relative[e[i].type];i++);return v(s>1&&y(l),s>1&&p(e.slice(0,s-1)).replace(he,"$1"),r,i>s&&w(e.slice(s,i)),n>i&&w(e=e.slice(i)),n>i&&p(e))}l.push(r)}return y(l)}function T(e,t){var r=0,i=t.length>0,o=e.length>0,s=function(n,s,c,u,l){var h,f,d,p=[],g=0,y="0",v=n&&[],w=null!=l,T=N,b=n||o&&k.find.TAG("*",l&&s.parentNode||s),L=j+=null==T?1:Math.random()||.1;for(w&&(N=s!==I&&s,S=r);null!=(h=b[y]);y++){if(o&&h){for(f=0;d=e[f++];)if(d(h,s,c)){u.push(h);break}w&&(j=L,S=++r)}i&&((h=!d&&h)&&g--,n&&v.push(h))}if(g+=y,i&&y!==g){for(f=0;d=t[f++];)d(v,p,s,c);if(n){if(g>0)for(;y--;)v[y]||p[y]||(p[y]=Q.call(u));p=m(p)}te.apply(u,p),w&&!n&&p.length>0&&g+t.length>1&&a.uniqueSort(u)}return w&&(j=L,N=T),v};return i?n(s):s}function b(e,t,r){for(var i=0,n=t.length;n>i;i++)a(e,t[i],r);return r}function L(e,t,r,i){var n,o,a,s,c,u=d(e);if(!i&&1===u.length){if(o=u[0]=u[0].slice(0),o.length>2&&"ID"===(a=o[0]).type&&9===t.nodeType&&M&&k.relative[o[1].type]){if(t=(k.find.ID(a.matches[0].replace(Ce,Se),t)||[])[0],!t)return r;e=e.slice(o.shift().value.length)}for(n=ve.needsContext.test(e)?0:o.length;n--&&(a=o[n],!k.relative[s=a.type]);)if((c=k.find[s])&&(i=c(a.matches[0].replace(Ce,Se),pe.test(o[0].type)&&t.parentNode||t))){if(o.splice(n,1),e=i.length&&p(o),!e)return te.apply(r,i),r;break}}return R(e,u)(i,t,!M,r,pe.test(e)),r}function x(){}var C,S,k,A,O,R,N,E,_,I,D,M,F,B,P,G,z="sizzle"+-new Date,q=e.document,V={},j=0,H=0,$=i(),K=i(),W=i(),Y=!1,U=function(){return 0},X=typeof t,J=1<<31,Z=[],Q=Z.pop,ee=Z.push,te=Z.push,re=Z.slice,ie=Z.indexOf||function(e){for(var t=0,r=this.length;r>t;t++)if(this[t]===e)return t;return-1},ne="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",ae="[\\x20\\t\\r\\n\\f]",se="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",ce=se.replace("w","w#"),ue="\\["+ae+"*("+se+")"+ae+"*(?:([*^$|!~]?=)"+ae+"*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+ce+")|)|)"+ae+"*\\]",le=":("+se+")(?:\\(((['\"])((?:\\\\.|[^\\\\])*?)\\3|((?:\\\\.|[^\\\\()[\\]]|"+ue.replace(3,8)+")*)|.*)\\)|)",he=RegExp("^"+ae+"+|((?:^|[^\\\\])(?:\\\\.)*)"+ae+"+$","g"),fe=RegExp("^"+ae+"*,"+ae+"*"),de=RegExp("^"+ae+"*([>+~]|"+ae+")"+ae+"*"),pe=RegExp(ae+"*[+~]"),ge=RegExp("="+ae+"*([^\\]'\"]*)"+ae+"*\\]","g"),ye=RegExp(le),me=RegExp("^"+ce+"$"),ve={
ID:RegExp("^#("+se+")"),CLASS:RegExp("^\\.("+se+")"),TAG:RegExp("^("+se.replace("w","w*")+")"),ATTR:RegExp("^"+ue),PSEUDO:RegExp("^"+le),CHILD:RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+ae+"*(even|odd|(([+-]|)(\\d*)n|)"+ae+"*(?:([+-]|)"+ae+"*(\\d+)|))"+ae+"*\\)|)","i"),"boolean":RegExp("^(?:"+ne+")$","i"),needsContext:RegExp("^"+ae+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+ae+"*((?:-\\d)?\\d*)"+ae+"*\\)|)(?=[^-]|$)","i")},we=/^[^{]+\{\s*\[native \w/,Te=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,be=/^(?:input|select|textarea|button)$/i,Le=/^h\d$/i,xe=/'|\\/g,Ce=/\\([\da-fA-F]{1,6}[\x20\t\r\n\f]?|.)/g,Se=function(e,t){var r="0x"+t-65536;return r!==r?t:0>r?String.fromCharCode(r+65536):String.fromCharCode(55296|r>>10,56320|1023&r)};try{te.apply(Z=re.call(q.childNodes),q.childNodes),Z[q.childNodes.length].nodeType}catch(ke){te={apply:Z.length?function(e,t){ee.apply(e,re.call(t))}:function(e,t){for(var r=e.length,i=0;e[r++]=t[i++];);e.length=r-1}}}O=a.isXML=function(e){var t=e&&(e.ownerDocument||e).documentElement;return t?"HTML"!==t.nodeName:!1},_=a.setDocument=function(e){var i=e?e.ownerDocument||e:q;return i!==I&&9===i.nodeType&&i.documentElement?(I=i,D=i.documentElement,M=!O(i),V.getElementsByTagName=o(function(e){return e.appendChild(i.createComment("")),!e.getElementsByTagName("*").length}),V.attributes=o(function(e){return e.className="i",!e.getAttribute("className")}),V.getElementsByClassName=o(function(e){return e.innerHTML="<div class='a'></div><div class='a i'></div>",e.firstChild.className="i",2===e.getElementsByClassName("i").length}),V.sortDetached=o(function(e){return 1&e.compareDocumentPosition(I.createElement("div"))}),V.getById=o(function(e){return D.appendChild(e).id=z,!i.getElementsByName||!i.getElementsByName(z).length}),V.getById?(k.find.ID=function(e,t){if(typeof t.getElementById!==X&&M){var r=t.getElementById(e);return r&&r.parentNode?[r]:[]}},k.filter.ID=function(e){var t=e.replace(Ce,Se);return function(e){return e.getAttribute("id")===t}}):(k.find.ID=function(e,r){if(typeof r.getElementById!==X&&M){var i=r.getElementById(e);return i?i.id===e||typeof i.getAttributeNode!==X&&i.getAttributeNode("id").value===e?[i]:t:[]}},k.filter.ID=function(e){var t=e.replace(Ce,Se);return function(e){var r=typeof e.getAttributeNode!==X&&e.getAttributeNode("id");return r&&r.value===t}}),k.find.TAG=V.getElementsByTagName?function(e,r){return typeof r.getElementsByTagName!==X?r.getElementsByTagName(e):t}:function(e,t){var r,i=[],n=0,o=t.getElementsByTagName(e);if("*"===e){for(;r=o[n++];)1===r.nodeType&&i.push(r);return i}return o},k.find.CLASS=V.getElementsByClassName&&function(e,r){return typeof r.getElementsByClassName!==X&&M?r.getElementsByClassName(e):t},B=[],F=[],(V.qsa=r(i.querySelectorAll))&&(o(function(e){e.innerHTML="<select><option selected=''></option></select>",e.querySelectorAll("[selected]").length||F.push("\\["+ae+"*(?:value|"+ne+")"),e.querySelectorAll(":checked").length||F.push(":checked")}),o(function(e){var t=I.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("t",""),e.querySelectorAll("[t^='']").length&&F.push("[*^$]="+ae+"*(?:''|\"\")"),e.querySelectorAll(":enabled").length||F.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),F.push(",.*:")})),(V.matchesSelector=r(P=D.webkitMatchesSelector||D.mozMatchesSelector||D.oMatchesSelector||D.msMatchesSelector))&&o(function(e){V.disconnectedMatch=P.call(e,"div"),P.call(e,"[s!='']:x"),B.push("!=",le)}),F=F.length&&RegExp(F.join("|")),B=B.length&&RegExp(B.join("|")),G=r(D.contains)||D.compareDocumentPosition?function(e,t){var r=9===e.nodeType?e.documentElement:e,i=t&&t.parentNode;return e===i||!(!i||1!==i.nodeType||!(r.contains?r.contains(i):e.compareDocumentPosition&&16&e.compareDocumentPosition(i)))}:function(e,t){if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},U=D.compareDocumentPosition?function(e,t){if(e===t)return Y=!0,0;var r=t.compareDocumentPosition&&e.compareDocumentPosition&&e.compareDocumentPosition(t);return r?1&r||!V.sortDetached&&t.compareDocumentPosition(e)===r?e===i||G(q,e)?-1:t===i||G(q,t)?1:E?ie.call(E,e)-ie.call(E,t):0:4&r?-1:1:e.compareDocumentPosition?-1:1}:function(e,t){var r,n=0,o=e.parentNode,a=t.parentNode,c=[e],u=[t];if(e===t)return Y=!0,0;if(!o||!a)return e===i?-1:t===i?1:o?-1:a?1:E?ie.call(E,e)-ie.call(E,t):0;if(o===a)return s(e,t);for(r=e;r=r.parentNode;)c.unshift(r);for(r=t;r=r.parentNode;)u.unshift(r);for(;c[n]===u[n];)n++;return n?s(c[n],u[n]):c[n]===q?-1:u[n]===q?1:0},I):I},a.matches=function(e,t){return a(e,null,null,t)},a.matchesSelector=function(e,t){if((e.ownerDocument||e)!==I&&_(e),t=t.replace(ge,"='$1']"),!(!V.matchesSelector||!M||B&&B.test(t)||F&&F.test(t)))try{var r=P.call(e,t);if(r||V.disconnectedMatch||e.document&&11!==e.document.nodeType)return r}catch(i){}return a(t,I,null,[e]).length>0},a.contains=function(e,t){return(e.ownerDocument||e)!==I&&_(e),G(e,t)},a.attr=function(e,r){(e.ownerDocument||e)!==I&&_(e);var i=k.attrHandle[r.toLowerCase()],n=i&&i(e,r,!M);return n===t?V.attributes||!M?e.getAttribute(r):(n=e.getAttributeNode(r))&&n.specified?n.value:null:n},a.error=function(e){throw Error("Syntax error, unrecognized expression: "+e)},a.uniqueSort=function(e){var t,r=[],i=0,n=0;if(Y=!V.detectDuplicates,E=!V.sortStable&&e.slice(0),e.sort(U),Y){for(;t=e[n++];)t===e[n]&&(i=r.push(n));for(;i--;)e.splice(r[i],1)}return e},A=a.getText=function(e){var t,r="",i=0,n=e.nodeType;if(n){if(1===n||9===n||11===n){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)r+=A(e)}else if(3===n||4===n)return e.nodeValue}else for(;t=e[i];i++)r+=A(t);return r},k=a.selectors={cacheLength:50,createPseudo:n,match:ve,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(Ce,Se),e[3]=(e[4]||e[5]||"").replace(Ce,Se),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||a.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&a.error(e[0]),e},PSEUDO:function(e){var t,r=!e[5]&&e[2];return ve.CHILD.test(e[0])?null:(e[4]?e[2]=e[4]:r&&ye.test(r)&&(t=d(r,!0))&&(t=r.indexOf(")",r.length-t)-r.length)&&(e[0]=e[0].slice(0,t),e[2]=r.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(Ce,Se).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=$[e+" "];return t||(t=RegExp("(^|"+ae+")"+e+"("+ae+"|$)"))&&$(e,function(e){return t.test("string"==typeof e.className&&e.className||typeof e.getAttribute!==X&&e.getAttribute("class")||"")})},ATTR:function(e,t,r){return function(i){var n=a.attr(i,e);return null==n?"!="===t:t?(n+="","="===t?n===r:"!="===t?n!==r:"^="===t?r&&0===n.indexOf(r):"*="===t?r&&n.indexOf(r)>-1:"$="===t?r&&n.slice(-r.length)===r:"~="===t?(" "+n+" ").indexOf(r)>-1:"|="===t?n===r||n.slice(0,r.length+1)===r+"-":!1):!0}},CHILD:function(e,t,r,i,n){var o="nth"!==e.slice(0,3),a="last"!==e.slice(-4),s="of-type"===t;return 1===i&&0===n?function(e){return!!e.parentNode}:function(t,r,c){var u,l,h,f,d,p,g=o!==a?"nextSibling":"previousSibling",y=t.parentNode,m=s&&t.nodeName.toLowerCase(),v=!c&&!s;if(y){if(o){for(;g;){for(h=t;h=h[g];)if(s?h.nodeName.toLowerCase()===m:1===h.nodeType)return!1;p=g="only"===e&&!p&&"nextSibling"}return!0}if(p=[a?y.firstChild:y.lastChild],a&&v){for(l=y[z]||(y[z]={}),u=l[e]||[],d=u[0]===j&&u[1],f=u[0]===j&&u[2],h=d&&y.childNodes[d];h=++d&&h&&h[g]||(f=d=0)||p.pop();)if(1===h.nodeType&&++f&&h===t){l[e]=[j,d,f];break}}else if(v&&(u=(t[z]||(t[z]={}))[e])&&u[0]===j)f=u[1];else for(;(h=++d&&h&&h[g]||(f=d=0)||p.pop())&&((s?h.nodeName.toLowerCase()!==m:1!==h.nodeType)||!++f||(v&&((h[z]||(h[z]={}))[e]=[j,f]),h!==t)););return f-=n,f===i||0===f%i&&f/i>=0}}},PSEUDO:function(e,t){var r,i=k.pseudos[e]||k.setFilters[e.toLowerCase()]||a.error("unsupported pseudo: "+e);return i[z]?i(t):i.length>1?(r=[e,e,"",t],k.setFilters.hasOwnProperty(e.toLowerCase())?n(function(e,r){for(var n,o=i(e,t),a=o.length;a--;)n=ie.call(e,o[a]),e[n]=!(r[n]=o[a])}):function(e){return i(e,0,r)}):i}},pseudos:{not:n(function(e){var t=[],r=[],i=R(e.replace(he,"$1"));return i[z]?n(function(e,t,r,n){for(var o,a=i(e,null,n,[]),s=e.length;s--;)(o=a[s])&&(e[s]=!(t[s]=o))}):function(e,n,o){return t[0]=e,i(t,null,o,r),!r.pop()}}),has:n(function(e){return function(t){return a(e,t).length>0}}),contains:n(function(e){return function(t){return(t.textContent||t.innerText||A(t)).indexOf(e)>-1}}),lang:n(function(e){return me.test(e||"")||a.error("unsupported lang: "+e),e=e.replace(Ce,Se).toLowerCase(),function(t){var r;do if(r=M?t.lang:t.getAttribute("xml:lang")||t.getAttribute("lang"))return r=r.toLowerCase(),r===e||0===r.indexOf(e+"-");while((t=t.parentNode)&&1===t.nodeType);return!1}}),target:function(t){var r=e.location&&e.location.hash;return r&&r.slice(1)===t.id},root:function(e){return e===D},focus:function(e){return e===I.activeElement&&(!I.hasFocus||I.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:function(e){return e.disabled===!1},disabled:function(e){return e.disabled===!0},checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,e.selected===!0},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeName>"@"||3===e.nodeType||4===e.nodeType)return!1;return!0},parent:function(e){return!k.pseudos.empty(e)},header:function(e){return Le.test(e.nodeName)},input:function(e){return be.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||t.toLowerCase()===e.type)},first:f(function(){return[0]}),last:f(function(e,t){return[t-1]}),eq:f(function(e,t,r){return[0>r?r+t:r]}),even:f(function(e,t){for(var r=0;t>r;r+=2)e.push(r);return e}),odd:f(function(e,t){for(var r=1;t>r;r+=2)e.push(r);return e}),lt:f(function(e,t,r){for(var i=0>r?r+t:r;--i>=0;)e.push(i);return e}),gt:f(function(e,t,r){for(var i=0>r?r+t:r;t>++i;)e.push(i);return e})}};for(C in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})k.pseudos[C]=l(C);for(C in{submit:!0,reset:!0})k.pseudos[C]=h(C);R=a.compile=function(e,t){var r,i=[],n=[],o=W[e+" "];if(!o){for(t||(t=d(e)),r=t.length;r--;)o=w(t[r]),o[z]?i.push(o):n.push(o);o=W(e,T(n,i))}return o},k.pseudos.nth=k.pseudos.eq,x.prototype=k.filters=k.pseudos,k.setFilters=new x,V.sortStable=z.split("").sort(U).join("")===z,_(),[0,0].sort(U),V.detectDuplicates=Y,o(function(e){if(e.innerHTML="<a href='#'></a>","#"!==e.firstChild.getAttribute("href"))for(var t="type|href|height|width".split("|"),r=t.length;r--;)k.attrHandle[t[r]]=u}),o(function(e){if(null!=e.getAttribute("disabled"))for(var t=ne.split("|"),r=t.length;r--;)k.attrHandle[t[r]]=c}),oe.find=a,oe.expr=a.selectors,oe.expr[":"]=oe.expr.pseudos,oe.unique=a.uniqueSort,oe.text=a.getText,oe.isXMLDoc=a.isXML,oe.contains=a.contains}(e);var pe={};oe.Callbacks=function(e){e="string"==typeof e?pe[e]||i(e):oe.extend({},e);var r,n,o,a,s,c,u=[],l=!e.once&&[],h=function(t){for(r=e.memory&&t,n=!0,c=a||0,a=0,s=u.length,o=!0;u&&s>c;c++)if(u[c].apply(t[0],t[1])===!1&&e.stopOnFalse){r=!1;break}o=!1,u&&(l?l.length&&h(l.shift()):r?u=[]:f.disable())},f={add:function(){if(u){var t=u.length;!function i(t){oe.each(t,function(t,r){var n=oe.type(r);"function"===n?e.unique&&f.has(r)||u.push(r):r&&r.length&&"string"!==n&&i(r)})}(arguments),o?s=u.length:r&&(a=t,h(r))}return this},remove:function(){return u&&oe.each(arguments,function(e,t){for(var r;(r=oe.inArray(t,u,r))>-1;)u.splice(r,1),o&&(s>=r&&s--,c>=r&&c--)}),this},has:function(e){return e?oe.inArray(e,u)>-1:!(!u||!u.length)},empty:function(){return u=[],s=0,this},disable:function(){return u=l=r=t,this},disabled:function(){return!u},lock:function(){return l=t,r||f.disable(),this},locked:function(){return!l},fireWith:function(e,t){return t=t||[],t=[e,t.slice?t.slice():t],!u||n&&!l||(o?l.push(t):h(t)),this},fire:function(){return f.fireWith(this,arguments),this},fired:function(){return!!n}};return f},oe.extend({Deferred:function(e){var t=[["resolve","done",oe.Callbacks("once memory"),"resolved"],["reject","fail",oe.Callbacks("once memory"),"rejected"],["notify","progress",oe.Callbacks("memory")]],r="pending",i={state:function(){return r},always:function(){return n.done(arguments).fail(arguments),this},then:function(){var e=arguments;return oe.Deferred(function(r){oe.each(t,function(t,o){var a=o[0],s=oe.isFunction(e[t])&&e[t];n[o[1]](function(){var e=s&&s.apply(this,arguments);e&&oe.isFunction(e.promise)?e.promise().done(r.resolve).fail(r.reject).progress(r.notify):r[a+"With"](this===i?r.promise():this,s?[e]:arguments)})}),e=null}).promise()},promise:function(e){return null!=e?oe.extend(e,i):i}},n={};return i.pipe=i.then,oe.each(t,function(e,o){var a=o[2],s=o[3];i[o[1]]=a.add,s&&a.add(function(){r=s},t[1^e][2].disable,t[2][2].lock),n[o[0]]=function(){return n[o[0]+"With"](this===n?i:this,arguments),this},n[o[0]+"With"]=a.fireWith}),i.promise(n),e&&e.call(n,n),n},when:function(e){var t,r,i,n=0,o=ee.call(arguments),a=o.length,s=1!==a||e&&oe.isFunction(e.promise)?a:0,c=1===s?e:oe.Deferred(),u=function(e,r,i){return function(n){r[e]=this,i[e]=arguments.length>1?ee.call(arguments):n,i===t?c.notifyWith(r,i):--s||c.resolveWith(r,i)}};if(a>1)for(t=Array(a),r=Array(a),i=Array(a);a>n;n++)o[n]&&oe.isFunction(o[n].promise)?o[n].promise().done(u(n,i,o)).fail(c.reject).progress(u(n,r,t)):--s;return s||c.resolveWith(i,o),c.promise()}}),oe.support=function(t){var r=$.createElement("input"),i=$.createDocumentFragment(),n=$.createElement("div"),o=$.createElement("select"),a=o.appendChild($.createElement("option"));return r.type?(r.type="checkbox",t.checkOn=""!==r.value,t.optSelected=a.selected,t.reliableMarginRight=!0,t.boxSizingReliable=!0,t.pixelPosition=!1,r.checked=!0,t.noCloneChecked=r.cloneNode(!0).checked,o.disabled=!0,t.optDisabled=!a.disabled,r=$.createElement("input"),r.value="t",r.type="radio",t.radioValue="t"===r.value,r.setAttribute("checked","t"),r.setAttribute("name","t"),i.appendChild(r),t.checkClone=i.cloneNode(!0).cloneNode(!0).lastChild.checked,t.focusinBubbles="onfocusin"in e,n.style.backgroundClip="content-box",n.cloneNode(!0).style.backgroundClip="",t.clearCloneStyle="content-box"===n.style.backgroundClip,oe(function(){var r,i,o="padding:0;margin:0;border:0;display:block;-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box",a=$.getElementsByTagName("body")[0];a&&(r=$.createElement("div"),r.style.cssText="border:0;width:0;height:0;position:absolute;top:0;left:-9999px;margin-top:1px",a.appendChild(r).appendChild(n),n.innerHTML="",n.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;padding:1px;border:1px;display:block;width:4px;margin-top:1%;position:absolute;top:1%",oe.swap(a,null!=a.style.zoom?{zoom:1}:{},function(){t.boxSizing=4===n.offsetWidth}),e.getComputedStyle&&(t.pixelPosition="1%"!==(e.getComputedStyle(n,null)||{}).top,t.boxSizingReliable="4px"===(e.getComputedStyle(n,null)||{width:"4px"}).width,i=n.appendChild($.createElement("div")),i.style.cssText=n.style.cssText=o,i.style.marginRight=i.style.width="0",n.style.width="1px",t.reliableMarginRight=!parseFloat((e.getComputedStyle(i,null)||{}).marginRight)),a.removeChild(r))}),t):t}({});var ge,ye,me=/(?:\{[\s\S]*\}|\[[\s\S]*\])$/,ve=/([A-Z])/g;n.uid=1,n.accepts=function(e){return e.nodeType?1===e.nodeType||9===e.nodeType:!0},n.prototype={key:function(e){if(!n.accepts(e))return 0;var t={},r=e[this.expando];if(!r){r=n.uid++;try{t[this.expando]={value:r},Object.defineProperties(e,t)}catch(i){t[this.expando]=r,oe.extend(e,t)}}return this.cache[r]||(this.cache[r]={}),r},set:function(e,t,r){var i,n=this.key(e),o=this.cache[n];if("string"==typeof t)o[t]=r;else if(oe.isEmptyObject(o))this.cache[n]=t;else for(i in t)o[i]=t[i]},get:function(e,r){var i=this.cache[this.key(e)];return r===t?i:i[r]},access:function(e,r,i){return r===t||r&&"string"==typeof r&&i===t?this.get(e,r):(this.set(e,r,i),i!==t?i:r)},remove:function(e,r){var i,n,o=this.key(e),a=this.cache[o];if(r===t)this.cache[o]={};else{oe.isArray(r)?n=r.concat(r.map(oe.camelCase)):r in a?n=[r]:(n=oe.camelCase(r),n=n in a?[n]:n.match(se)||[]),i=n.length;for(;i--;)delete a[n[i]]}},hasData:function(e){return!oe.isEmptyObject(this.cache[e[this.expando]]||{})},discard:function(e){delete this.cache[this.key(e)]}},ge=new n,ye=new n,oe.extend({acceptData:n.accepts,hasData:function(e){return ge.hasData(e)||ye.hasData(e)},data:function(e,t,r){return ge.access(e,t,r)},removeData:function(e,t){ge.remove(e,t)},_data:function(e,t,r){return ye.access(e,t,r)},_removeData:function(e,t){ye.remove(e,t)}}),oe.fn.extend({data:function(e,r){var i,n,a=this[0],s=0,c=null;if(e===t){if(this.length&&(c=ge.get(a),1===a.nodeType&&!ye.get(a,"hasDataAttrs"))){for(i=a.attributes;i.length>s;s++)n=i[s].name,0===n.indexOf("data-")&&(n=oe.camelCase(n.substring(5)),o(a,n,c[n]));ye.set(a,"hasDataAttrs",!0)}return c}return"object"==typeof e?this.each(function(){ge.set(this,e)}):oe.access(this,function(r){var i,n=oe.camelCase(e);if(a&&r===t){if(i=ge.get(a,e),i!==t)return i;if(i=ge.get(a,n),i!==t)return i;if(i=o(a,n,t),i!==t)return i}else this.each(function(){var i=ge.get(this,n);ge.set(this,n,r),-1!==e.indexOf("-")&&i!==t&&ge.set(this,e,r)})},null,r,arguments.length>1,null,!0)},removeData:function(e){return this.each(function(){ge.remove(this,e)})}}),oe.extend({queue:function(e,r,i){var n;return e?(r=(r||"fx")+"queue",n=ye.get(e,r),i&&(!n||oe.isArray(i)?n=ye.access(e,r,oe.makeArray(i)):n.push(i)),n||[]):t},dequeue:function(e,t){t=t||"fx";var r=oe.queue(e,t),i=r.length,n=r.shift(),o=oe._queueHooks(e,t),a=function(){oe.dequeue(e,t)};"inprogress"===n&&(n=r.shift(),i--),o.cur=n,n&&("fx"===t&&r.unshift("inprogress"),delete o.stop,n.call(e,a,o)),!i&&o&&o.empty.fire()},_queueHooks:function(e,t){var r=t+"queueHooks";return ye.get(e,r)||ye.access(e,r,{empty:oe.Callbacks("once memory").add(function(){ye.remove(e,[t+"queue",r])})})}}),oe.fn.extend({queue:function(e,r){var i=2;return"string"!=typeof e&&(r=e,e="fx",i--),i>arguments.length?oe.queue(this[0],e):r===t?this:this.each(function(){var t=oe.queue(this,e,r);oe._queueHooks(this,e),"fx"===e&&"inprogress"!==t[0]&&oe.dequeue(this,e)})},dequeue:function(e){return this.each(function(){oe.dequeue(this,e)})},delay:function(e,t){return e=oe.fx?oe.fx.speeds[e]||e:e,t=t||"fx",this.queue(t,function(t,r){var i=setTimeout(t,e);r.stop=function(){clearTimeout(i)}})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,r){var i,n=1,o=oe.Deferred(),a=this,s=this.length,c=function(){--n||o.resolveWith(a,[a])};for("string"!=typeof e&&(r=e,e=t),e=e||"fx";s--;)i=ye.get(a[s],e+"queueHooks"),i&&i.empty&&(n++,i.empty.add(c));return c(),o.promise(r)}});var we,Te,be=/[\t\r\n]/g,Le=/\r/g,xe=/^(?:input|select|textarea|button)$/i;oe.fn.extend({attr:function(e,t){return oe.access(this,oe.attr,e,t,arguments.length>1)},removeAttr:function(e){return this.each(function(){oe.removeAttr(this,e)})},prop:function(e,t){return oe.access(this,oe.prop,e,t,arguments.length>1)},removeProp:function(e){return this.each(function(){delete this[oe.propFix[e]||e]})},addClass:function(e){var t,r,i,n,o,a=0,s=this.length,c="string"==typeof e&&e;if(oe.isFunction(e))return this.each(function(t){oe(this).addClass(e.call(this,t,this.className))});if(c)for(t=(e||"").match(se)||[];s>a;a++)if(r=this[a],i=1===r.nodeType&&(r.className?(" "+r.className+" ").replace(be," "):" ")){for(o=0;n=t[o++];)0>i.indexOf(" "+n+" ")&&(i+=n+" ");r.className=oe.trim(i)}return this},removeClass:function(e){var t,r,i,n,o,a=0,s=this.length,c=0===arguments.length||"string"==typeof e&&e;if(oe.isFunction(e))return this.each(function(t){oe(this).removeClass(e.call(this,t,this.className))});if(c)for(t=(e||"").match(se)||[];s>a;a++)if(r=this[a],i=1===r.nodeType&&(r.className?(" "+r.className+" ").replace(be," "):"")){for(o=0;n=t[o++];)for(;i.indexOf(" "+n+" ")>=0;)i=i.replace(" "+n+" "," ");r.className=e?oe.trim(i):""}return this},toggleClass:function(e,t){var r=typeof e,i="boolean"==typeof t;return oe.isFunction(e)?this.each(function(r){oe(this).toggleClass(e.call(this,r,this.className,t),t)}):this.each(function(){if("string"===r)for(var n,o=0,a=oe(this),s=t,c=e.match(se)||[];n=c[o++];)s=i?s:!a.hasClass(n),a[s?"addClass":"removeClass"](n);else(r===j||"boolean"===r)&&(this.className&&ye.set(this,"__className__",this.className),this.className=this.className||e===!1?"":ye.get(this,"__className__")||"")})},hasClass:function(e){for(var t=" "+e+" ",r=0,i=this.length;i>r;r++)if(1===this[r].nodeType&&(" "+this[r].className+" ").replace(be," ").indexOf(t)>=0)return!0;return!1},val:function(e){var r,i,n,o=this[0];return arguments.length?(n=oe.isFunction(e),this.each(function(i){var o,a=oe(this);1===this.nodeType&&(o=n?e.call(this,i,a.val()):e,null==o?o="":"number"==typeof o?o+="":oe.isArray(o)&&(o=oe.map(o,function(e){return null==e?"":e+""})),r=oe.valHooks[this.type]||oe.valHooks[this.nodeName.toLowerCase()],r&&"set"in r&&r.set(this,o,"value")!==t||(this.value=o))})):o?(r=oe.valHooks[o.type]||oe.valHooks[o.nodeName.toLowerCase()],r&&"get"in r&&(i=r.get(o,"value"))!==t?i:(i=o.value,"string"==typeof i?i.replace(Le,""):null==i?"":i)):void 0}}),oe.extend({valHooks:{option:{get:function(e){var t=e.attributes.value;return!t||t.specified?e.value:e.text}},select:{get:function(e){for(var t,r,i=e.options,n=e.selectedIndex,o="select-one"===e.type||0>n,a=o?null:[],s=o?n+1:i.length,c=0>n?s:o?n:0;s>c;c++)if(r=i[c],!(!r.selected&&c!==n||(oe.support.optDisabled?r.disabled:null!==r.getAttribute("disabled"))||r.parentNode.disabled&&oe.nodeName(r.parentNode,"optgroup"))){if(t=oe(r).val(),o)return t;a.push(t)}return a},set:function(e,t){for(var r,i,n=e.options,o=oe.makeArray(t),a=n.length;a--;)i=n[a],(i.selected=oe.inArray(oe(i).val(),o)>=0)&&(r=!0);return r||(e.selectedIndex=-1),o}}},attr:function(e,r,i){var n,o,a=e.nodeType;return e&&3!==a&&8!==a&&2!==a?typeof e.getAttribute===j?oe.prop(e,r,i):(1===a&&oe.isXMLDoc(e)||(r=r.toLowerCase(),n=oe.attrHooks[r]||(oe.expr.match["boolean"].test(r)?Te:we)),i===t?n&&"get"in n&&null!==(o=n.get(e,r))?o:(o=oe.find.attr(e,r),null==o?t:o):null!==i?n&&"set"in n&&(o=n.set(e,i,r))!==t?o:(e.setAttribute(r,i+""),i):(oe.removeAttr(e,r),t)):void 0},removeAttr:function(e,t){var r,i,n=0,o=t&&t.match(se);if(o&&1===e.nodeType)for(;r=o[n++];)i=oe.propFix[r]||r,oe.expr.match["boolean"].test(r)&&(e[i]=!1),e.removeAttribute(r)},attrHooks:{type:{set:function(e,t){if(!oe.support.radioValue&&"radio"===t&&oe.nodeName(e,"input")){var r=e.value;return e.setAttribute("type",t),r&&(e.value=r),t}}}},propFix:{"for":"htmlFor","class":"className"},prop:function(e,r,i){var n,o,a,s=e.nodeType;return e&&3!==s&&8!==s&&2!==s?(a=1!==s||!oe.isXMLDoc(e),a&&(r=oe.propFix[r]||r,o=oe.propHooks[r]),i!==t?o&&"set"in o&&(n=o.set(e,i,r))!==t?n:e[r]=i:o&&"get"in o&&null!==(n=o.get(e,r))?n:e[r]):void 0},propHooks:{tabIndex:{get:function(e){return e.hasAttribute("tabindex")||xe.test(e.nodeName)||e.href?e.tabIndex:-1}}}}),Te={set:function(e,t,r){return t===!1?oe.removeAttr(e,r):e.setAttribute(r,r),r}},oe.each(oe.expr.match["boolean"].source.match(/\w+/g),function(e,r){var i=oe.expr.attrHandle[r]||oe.find.attr;oe.expr.attrHandle[r]=function(e,r,n){var o=oe.expr.attrHandle[r],a=n?t:(oe.expr.attrHandle[r]=t)!=i(e,r,n)?r.toLowerCase():null;return oe.expr.attrHandle[r]=o,a}}),oe.support.optSelected||(oe.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null}}),oe.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){oe.propFix[this.toLowerCase()]=this}),oe.each(["radio","checkbox"],function(){oe.valHooks[this]={set:function(e,r){return oe.isArray(r)?e.checked=oe.inArray(oe(e).val(),r)>=0:t}},oe.support.checkOn||(oe.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})});var Ce=/^key/,Se=/^(?:mouse|contextmenu)|click/,ke=/^(?:focusinfocus|focusoutblur)$/,Ae=/^([^.]*)(?:\.(.+)|)$/;oe.event={global:{},add:function(e,r,i,n,o){var a,s,c,u,l,h,f,d,p,g,y,m=ye.get(e);if(m){for(i.handler&&(a=i,i=a.handler,o=a.selector),i.guid||(i.guid=oe.guid++),(u=m.events)||(u=m.events={}),(s=m.handle)||(s=m.handle=function(e){return typeof oe===j||e&&oe.event.triggered===e.type?t:oe.event.dispatch.apply(s.elem,arguments)},s.elem=e),r=(r||"").match(se)||[""],l=r.length;l--;)c=Ae.exec(r[l])||[],p=y=c[1],g=(c[2]||"").split(".").sort(),p&&(f=oe.event.special[p]||{},p=(o?f.delegateType:f.bindType)||p,f=oe.event.special[p]||{},h=oe.extend({type:p,origType:y,data:n,handler:i,guid:i.guid,selector:o,needsContext:o&&oe.expr.match.needsContext.test(o),namespace:g.join(".")},a),(d=u[p])||(d=u[p]=[],d.delegateCount=0,f.setup&&f.setup.call(e,n,g,s)!==!1||e.addEventListener&&e.addEventListener(p,s,!1)),f.add&&(f.add.call(e,h),h.handler.guid||(h.handler.guid=i.guid)),o?d.splice(d.delegateCount++,0,h):d.push(h),oe.event.global[p]=!0);e=null}},remove:function(e,t,r,i,n){var o,a,s,c,u,l,h,f,d,p,g,y=ye.hasData(e)&&ye.get(e);if(y&&(c=y.events)){for(t=(t||"").match(se)||[""],u=t.length;u--;)if(s=Ae.exec(t[u])||[],d=g=s[1],p=(s[2]||"").split(".").sort(),d){for(h=oe.event.special[d]||{},d=(i?h.delegateType:h.bindType)||d,f=c[d]||[],s=s[2]&&RegExp("(^|\\.)"+p.join("\\.(?:.*\\.|)")+"(\\.|$)"),a=o=f.length;o--;)l=f[o],!n&&g!==l.origType||r&&r.guid!==l.guid||s&&!s.test(l.namespace)||i&&i!==l.selector&&("**"!==i||!l.selector)||(f.splice(o,1),l.selector&&f.delegateCount--,h.remove&&h.remove.call(e,l));a&&!f.length&&(h.teardown&&h.teardown.call(e,p,y.handle)!==!1||oe.removeEvent(e,d,y.handle),delete c[d])}else for(d in c)oe.event.remove(e,d+t[u],r,i,!0);oe.isEmptyObject(c)&&(delete y.handle,ye.remove(e,"events"))}},trigger:function(r,i,n,o){var a,s,c,u,l,h,f,d=[n||$],p=ie.call(r,"type")?r.type:r,g=ie.call(r,"namespace")?r.namespace.split("."):[];if(s=c=n=n||$,3!==n.nodeType&&8!==n.nodeType&&!ke.test(p+oe.event.triggered)&&(p.indexOf(".")>=0&&(g=p.split("."),p=g.shift(),g.sort()),l=0>p.indexOf(":")&&"on"+p,r=r[oe.expando]?r:new oe.Event(p,"object"==typeof r&&r),r.isTrigger=o?2:3,r.namespace=g.join("."),r.namespace_re=r.namespace?RegExp("(^|\\.)"+g.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,r.result=t,r.target||(r.target=n),i=null==i?[r]:oe.makeArray(i,[r]),f=oe.event.special[p]||{},o||!f.trigger||f.trigger.apply(n,i)!==!1)){if(!o&&!f.noBubble&&!oe.isWindow(n)){for(u=f.delegateType||p,ke.test(u+p)||(s=s.parentNode);s;s=s.parentNode)d.push(s),c=s;c===(n.ownerDocument||$)&&d.push(c.defaultView||c.parentWindow||e)}for(a=0;(s=d[a++])&&!r.isPropagationStopped();)r.type=a>1?u:f.bindType||p,h=(ye.get(s,"events")||{})[r.type]&&ye.get(s,"handle"),h&&h.apply(s,i),h=l&&s[l],h&&oe.acceptData(s)&&h.apply&&h.apply(s,i)===!1&&r.preventDefault();return r.type=p,o||r.isDefaultPrevented()||f._default&&f._default.apply(d.pop(),i)!==!1||!oe.acceptData(n)||l&&oe.isFunction(n[p])&&!oe.isWindow(n)&&(c=n[l],c&&(n[l]=null),oe.event.triggered=p,n[p](),oe.event.triggered=t,c&&(n[l]=c)),r.result}},dispatch:function(e){e=oe.event.fix(e);var r,i,n,o,a,s=[],c=ee.call(arguments),u=(ye.get(this,"events")||{})[e.type]||[],l=oe.event.special[e.type]||{};if(c[0]=e,e.delegateTarget=this,!l.preDispatch||l.preDispatch.call(this,e)!==!1){for(s=oe.event.handlers.call(this,e,u),r=0;(o=s[r++])&&!e.isPropagationStopped();)for(e.currentTarget=o.elem,i=0;(a=o.handlers[i++])&&!e.isImmediatePropagationStopped();)(!e.namespace_re||e.namespace_re.test(a.namespace))&&(e.handleObj=a,e.data=a.data,n=((oe.event.special[a.origType]||{}).handle||a.handler).apply(o.elem,c),n!==t&&(e.result=n)===!1&&(e.preventDefault(),e.stopPropagation()));return l.postDispatch&&l.postDispatch.call(this,e),e.result}},handlers:function(e,r){var i,n,o,a,s=[],c=r.delegateCount,u=e.target;if(c&&u.nodeType&&(!e.button||"click"!==e.type))for(;u!==this;u=u.parentNode||this)if(u.disabled!==!0||"click"!==e.type){for(n=[],i=0;c>i;i++)a=r[i],o=a.selector+" ",n[o]===t&&(n[o]=a.needsContext?oe(o,this).index(u)>=0:oe.find(o,this,null,[u]).length),n[o]&&n.push(a);n.length&&s.push({elem:u,handlers:n})}return r.length>c&&s.push({elem:this,handlers:r.slice(c)}),s},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(e,t){return null==e.which&&(e.which=null!=t.charCode?t.charCode:t.keyCode),e}},mouseHooks:{props:"button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(e,r){var i,n,o,a=r.button;return null==e.pageX&&null!=r.clientX&&(i=e.target.ownerDocument||$,n=i.documentElement,o=i.body,e.pageX=r.clientX+(n&&n.scrollLeft||o&&o.scrollLeft||0)-(n&&n.clientLeft||o&&o.clientLeft||0),e.pageY=r.clientY+(n&&n.scrollTop||o&&o.scrollTop||0)-(n&&n.clientTop||o&&o.clientTop||0)),e.which||a===t||(e.which=1&a?1:2&a?3:4&a?2:0),e}},fix:function(e){if(e[oe.expando])return e;var t,r,i,n=e.type,o=e,a=this.fixHooks[n];for(a||(this.fixHooks[n]=a=Se.test(n)?this.mouseHooks:Ce.test(n)?this.keyHooks:{}),i=a.props?this.props.concat(a.props):this.props,e=new oe.Event(o),t=i.length;t--;)r=i[t],e[r]=o[r];return 3===e.target.nodeType&&(e.target=e.target.parentNode),a.filter?a.filter(e,o):e},special:{load:{noBubble:!0},focus:{trigger:function(){return this!==c()&&this.focus?(this.focus(),!1):t},delegateType:"focusin"},blur:{trigger:function(){return this===c()&&this.blur?(this.blur(),!1):t},delegateType:"focusout"},click:{trigger:function(){return"checkbox"===this.type&&this.click&&oe.nodeName(this,"input")?(this.click(),!1):t},_default:function(e){return oe.nodeName(e.target,"a")}},beforeunload:{postDispatch:function(e){e.result!==t&&(e.originalEvent.returnValue=e.result)}}},simulate:function(e,t,r,i){var n=oe.extend(new oe.Event,r,{type:e,isSimulated:!0,originalEvent:{}});i?oe.event.trigger(n,null,t):oe.event.dispatch.call(t,n),n.isDefaultPrevented()&&r.preventDefault()}},oe.removeEvent=function(e,t,r){e.removeEventListener&&e.removeEventListener(t,r,!1)},oe.Event=function(e,r){return this instanceof oe.Event?(e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||e.getPreventDefault&&e.getPreventDefault()?a:s):this.type=e,r&&oe.extend(this,r),this.timeStamp=e&&e.timeStamp||oe.now(),this[oe.expando]=!0,t):new oe.Event(e,r)},oe.Event.prototype={isDefaultPrevented:s,isPropagationStopped:s,isImmediatePropagationStopped:s,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=a,e&&e.preventDefault&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=a,e&&e.stopPropagation&&e.stopPropagation()},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=a,this.stopPropagation()}},oe.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(e,t){oe.event.special[e]={delegateType:t,bindType:t,handle:function(e){var r,i=this,n=e.relatedTarget,o=e.handleObj;return(!n||n!==i&&!oe.contains(i,n))&&(e.type=o.origType,r=o.handler.apply(this,arguments),e.type=t),r}}}),oe.support.focusinBubbles||oe.each({focus:"focusin",blur:"focusout"},function(e,t){var r=0,i=function(e){oe.event.simulate(t,e.target,oe.event.fix(e),!0)};oe.event.special[t]={setup:function(){0===r++&&$.addEventListener(e,i,!0)},teardown:function(){0===--r&&$.removeEventListener(e,i,!0)}}}),oe.fn.extend({on:function(e,r,i,n,o){var a,c;if("object"==typeof e){"string"!=typeof r&&(i=i||r,r=t);for(c in e)this.on(c,r,i,e[c],o);return this}if(null==i&&null==n?(n=r,i=r=t):null==n&&("string"==typeof r?(n=i,i=t):(n=i,i=r,r=t)),n===!1)n=s;else if(!n)return this;
return 1===o&&(a=n,n=function(e){return oe().off(e),a.apply(this,arguments)},n.guid=a.guid||(a.guid=oe.guid++)),this.each(function(){oe.event.add(this,e,n,i,r)})},one:function(e,t,r,i){return this.on(e,t,r,i,1)},off:function(e,r,i){var n,o;if(e&&e.preventDefault&&e.handleObj)return n=e.handleObj,oe(e.delegateTarget).off(n.namespace?n.origType+"."+n.namespace:n.origType,n.selector,n.handler),this;if("object"==typeof e){for(o in e)this.off(o,r,e[o]);return this}return(r===!1||"function"==typeof r)&&(i=r,r=t),i===!1&&(i=s),this.each(function(){oe.event.remove(this,e,i,r)})},trigger:function(e,t){return this.each(function(){oe.event.trigger(e,t,this)})},triggerHandler:function(e,r){var i=this[0];return i?oe.event.trigger(e,r,i,!0):t}});var Oe=/^.[^:#\[\.,]*$/,Re=oe.expr.match.needsContext,Ne={children:!0,contents:!0,next:!0,prev:!0};oe.fn.extend({find:function(e){var t,r,i,n=this.length;if("string"!=typeof e)return t=this,this.pushStack(oe(e).filter(function(){for(i=0;n>i;i++)if(oe.contains(t[i],this))return!0}));for(r=[],i=0;n>i;i++)oe.find(e,this[i],r);return r=this.pushStack(n>1?oe.unique(r):r),r.selector=(this.selector?this.selector+" ":"")+e,r},has:function(e){var t=oe(e,this),r=t.length;return this.filter(function(){for(var e=0;r>e;e++)if(oe.contains(this,t[e]))return!0})},not:function(e){return this.pushStack(l(this,e||[],!0))},filter:function(e){return this.pushStack(l(this,e||[],!1))},is:function(e){return!!e&&("string"==typeof e?Re.test(e)?oe(e,this.context).index(this[0])>=0:oe.filter(e,this).length>0:this.filter(e).length>0)},closest:function(e,t){for(var r,i=0,n=this.length,o=[],a=Re.test(e)||"string"!=typeof e?oe(e,t||this.context):0;n>i;i++)for(r=this[i];r&&r!==t;r=r.parentNode)if(11>r.nodeType&&(a?a.index(r)>-1:1===r.nodeType&&oe.find.matchesSelector(r,e))){r=o.push(r);break}return this.pushStack(o.length>1?oe.unique(o):o)},index:function(e){return e?"string"==typeof e?te.call(oe(e),this[0]):te.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){var r="string"==typeof e?oe(e,t):oe.makeArray(e&&e.nodeType?[e]:e),i=oe.merge(this.get(),r);return this.pushStack(oe.unique(i))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),oe.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return oe.dir(e,"parentNode")},parentsUntil:function(e,t,r){return oe.dir(e,"parentNode",r)},next:function(e){return u(e,"nextSibling")},prev:function(e){return u(e,"previousSibling")},nextAll:function(e){return oe.dir(e,"nextSibling")},prevAll:function(e){return oe.dir(e,"previousSibling")},nextUntil:function(e,t,r){return oe.dir(e,"nextSibling",r)},prevUntil:function(e,t,r){return oe.dir(e,"previousSibling",r)},siblings:function(e){return oe.sibling((e.parentNode||{}).firstChild,e)},children:function(e){return oe.sibling(e.firstChild)},contents:function(e){return oe.nodeName(e,"iframe")?e.contentDocument||e.contentWindow.document:oe.merge([],e.childNodes)}},function(e,t){oe.fn[e]=function(r,i){var n=oe.map(this,t,r);return"Until"!==e.slice(-5)&&(i=r),i&&"string"==typeof i&&(n=oe.filter(i,n)),this.length>1&&(Ne[e]||oe.unique(n),"p"===e[0]&&n.reverse()),this.pushStack(n)}}),oe.extend({filter:function(e,t,r){var i=t[0];return r&&(e=":not("+e+")"),1===t.length&&1===i.nodeType?oe.find.matchesSelector(i,e)?[i]:[]:oe.find.matches(e,oe.grep(t,function(e){return 1===e.nodeType}))},dir:function(e,r,i){for(var n=[],o=i!==t;(e=e[r])&&9!==e.nodeType;)if(1===e.nodeType){if(o&&oe(e).is(i))break;n.push(e)}return n},sibling:function(e,t){for(var r=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&r.push(e);return r}});var Ee=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,_e=/<([\w:]+)/,Ie=/<|&#?\w+;/,De=/<(?:script|style|link)/i,Me=/^(?:checkbox|radio)$/i,Fe=/checked\s*(?:[^=]|=\s*.checked.)/i,Be=/^$|\/(?:java|ecma)script/i,Pe=/^true\/(.*)/,Ge=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,ze={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};ze.optgroup=ze.option,ze.tbody=ze.tfoot=ze.colgroup=ze.caption=ze.col=ze.thead,ze.th=ze.td,oe.fn.extend({text:function(e){return oe.access(this,function(e){return e===t?oe.text(this):this.empty().append((this[0]&&this[0].ownerDocument||$).createTextNode(e))},null,e,arguments.length)},append:function(){return this.domManip(arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=h(this,e);t.appendChild(e)}})},prepend:function(){return this.domManip(arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=h(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return this.domManip(arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return this.domManip(arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},remove:function(e,t){for(var r,i=e?oe.filter(e,this):this,n=0;null!=(r=i[n]);n++)t||1!==r.nodeType||oe.cleanData(y(r)),r.parentNode&&(t&&oe.contains(r.ownerDocument,r)&&p(y(r,"script")),r.parentNode.removeChild(r));return this},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(oe.cleanData(y(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null==e?!1:e,t=null==t?e:t,this.map(function(){return oe.clone(this,e,t)})},html:function(e){return oe.access(this,function(e){var r=this[0]||{},i=0,n=this.length;if(e===t&&1===r.nodeType)return r.innerHTML;if("string"==typeof e&&!De.test(e)&&!ze[(_e.exec(e)||["",""])[1].toLowerCase()]){e=e.replace(Ee,"<$1></$2>");try{for(;n>i;i++)r=this[i]||{},1===r.nodeType&&(oe.cleanData(y(r,!1)),r.innerHTML=e);r=0}catch(o){}}r&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var e=oe.map(this,function(e){return[e.nextSibling,e.parentNode]}),t=0;return this.domManip(arguments,function(r){var i=e[t++],n=e[t++];n&&(oe(this).remove(),n.insertBefore(r,i))},!0),t?this:this.remove()},detach:function(e){return this.remove(e,!0)},domManip:function(e,t,r){e=Z.apply([],e);var i,n,o,a,s,c,u=0,l=this.length,h=this,p=l-1,g=e[0],m=oe.isFunction(g);if(m||!(1>=l||"string"!=typeof g||oe.support.checkClone)&&Fe.test(g))return this.each(function(i){var n=h.eq(i);m&&(e[0]=g.call(this,i,n.html())),n.domManip(e,t,r)});if(l&&(i=oe.buildFragment(e,this[0].ownerDocument,!1,!r&&this),n=i.firstChild,1===i.childNodes.length&&(i=n),n)){for(o=oe.map(y(i,"script"),f),a=o.length;l>u;u++)s=i,u!==p&&(s=oe.clone(s,!0,!0),a&&oe.merge(o,y(s,"script"))),t.call(this[u],s,u);if(a)for(c=o[o.length-1].ownerDocument,oe.map(o,d),u=0;a>u;u++)s=o[u],Be.test(s.type||"")&&!ye.access(s,"globalEval")&&oe.contains(c,s)&&(s.src?oe._evalUrl(s.src):oe.globalEval(s.textContent.replace(Ge,"")))}return this}}),oe.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,t){oe.fn[e]=function(e){for(var r,i=[],n=oe(e),o=n.length-1,a=0;o>=a;a++)r=a===o?this:this.clone(!0),oe(n[a])[t](r),Q.apply(i,r.get());return this.pushStack(i)}}),oe.extend({clone:function(e,t,r){var i,n,o,a,s=e.cloneNode(!0),c=oe.contains(e.ownerDocument,e);if(!(oe.support.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||oe.isXMLDoc(e)))for(a=y(s),o=y(e),i=0,n=o.length;n>i;i++)m(o[i],a[i]);if(t)if(r)for(o=o||y(e),a=a||y(s),i=0,n=o.length;n>i;i++)g(o[i],a[i]);else g(e,s);return a=y(s,"script"),a.length>0&&p(a,!c&&y(e,"script")),s},buildFragment:function(e,t,r,i){for(var n,o,a,s,c,u,l=0,h=e.length,f=t.createDocumentFragment(),d=[];h>l;l++)if(n=e[l],n||0===n)if("object"===oe.type(n))oe.merge(d,n.nodeType?[n]:n);else if(Ie.test(n)){for(o=o||f.appendChild(t.createElement("div")),a=(_e.exec(n)||["",""])[1].toLowerCase(),s=ze[a]||ze._default,o.innerHTML=s[1]+n.replace(Ee,"<$1></$2>")+s[2],u=s[0];u--;)o=o.firstChild;oe.merge(d,o.childNodes),o=f.firstChild,o.textContent=""}else d.push(t.createTextNode(n));for(f.textContent="",l=0;n=d[l++];)if((!i||-1===oe.inArray(n,i))&&(c=oe.contains(n.ownerDocument,n),o=y(f.appendChild(n),"script"),c&&p(o),r))for(u=0;n=o[u++];)Be.test(n.type||"")&&r.push(n);return f},cleanData:function(e){for(var t,r,i,n=e.length,o=0,a=oe.event.special;n>o;o++){if(r=e[o],oe.acceptData(r)&&(t=ye.access(r)))for(i in t.events)a[i]?oe.event.remove(r,i):oe.removeEvent(r,i,t.handle);ge.discard(r),ye.discard(r)}},_evalUrl:function(e){return oe.ajax({url:e,type:"GET",dataType:"text",async:!1,global:!1,success:oe.globalEval})}}),oe.fn.extend({wrapAll:function(e){var t;return oe.isFunction(e)?this.each(function(t){oe(this).wrapAll(e.call(this,t))}):(this[0]&&(t=oe(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){for(var e=this;e.firstElementChild;)e=e.firstElementChild;return e}).append(this)),this)},wrapInner:function(e){return oe.isFunction(e)?this.each(function(t){oe(this).wrapInner(e.call(this,t))}):this.each(function(){var t=oe(this),r=t.contents();r.length?r.wrapAll(e):t.append(e)})},wrap:function(e){var t=oe.isFunction(e);return this.each(function(r){oe(this).wrapAll(t?e.call(this,r):e)})},unwrap:function(){return this.parent().each(function(){oe.nodeName(this,"body")||oe(this).replaceWith(this.childNodes)}).end()}});var qe,Ve,je=/^(none|table(?!-c[ea]).+)/,He=/^margin/,$e=RegExp("^("+ae+")(.*)$","i"),Ke=RegExp("^("+ae+")(?!px)[a-z%]+$","i"),We=RegExp("^([+-])=("+ae+")","i"),Ye={BODY:"block"},Ue={position:"absolute",visibility:"hidden",display:"block"},Xe={letterSpacing:0,fontWeight:400},Je=["Top","Right","Bottom","Left"],Ze=["Webkit","O","Moz","ms"];oe.fn.extend({css:function(e,r){return oe.access(this,function(e,r,i){var n,o,a={},s=0;if(oe.isArray(r)){for(n=T(e),o=r.length;o>s;s++)a[r[s]]=oe.css(e,r[s],!1,n);return a}return i!==t?oe.style(e,r,i):oe.css(e,r)},e,r,arguments.length>1)},show:function(){return b(this,!0)},hide:function(){return b(this)},toggle:function(e){var t="boolean"==typeof e;return this.each(function(){(t?e:w(this))?oe(this).show():oe(this).hide()})}}),oe.extend({cssHooks:{opacity:{get:function(e,t){if(t){var r=qe(e,"opacity");return""===r?"1":r}}}},cssNumber:{columnCount:!0,fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":"cssFloat"},style:function(e,r,i,n){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var o,a,s,c=oe.camelCase(r),u=e.style;return r=oe.cssProps[c]||(oe.cssProps[c]=v(u,c)),s=oe.cssHooks[r]||oe.cssHooks[c],i===t?s&&"get"in s&&(o=s.get(e,!1,n))!==t?o:u[r]:(a=typeof i,"string"===a&&(o=We.exec(i))&&(i=(o[1]+1)*o[2]+parseFloat(oe.css(e,r)),a="number"),null==i||"number"===a&&isNaN(i)||("number"!==a||oe.cssNumber[c]||(i+="px"),oe.support.clearCloneStyle||""!==i||0!==r.indexOf("background")||(u[r]="inherit"),s&&"set"in s&&(i=s.set(e,i,n))===t||(u[r]=i)),t)}},css:function(e,r,i,n){var o,a,s,c=oe.camelCase(r);return r=oe.cssProps[c]||(oe.cssProps[c]=v(e.style,c)),s=oe.cssHooks[r]||oe.cssHooks[c],s&&"get"in s&&(o=s.get(e,!0,i)),o===t&&(o=qe(e,r,n)),"normal"===o&&r in Xe&&(o=Xe[r]),""===i||i?(a=parseFloat(o),i===!0||oe.isNumeric(a)?a||0:o):o}}),qe=function(e,r,i){var n,o,a,s=i||T(e),c=s?s.getPropertyValue(r)||s[r]:t,u=e.style;return s&&(""!==c||oe.contains(e.ownerDocument,e)||(c=oe.style(e,r)),Ke.test(c)&&He.test(r)&&(n=u.width,o=u.minWidth,a=u.maxWidth,u.minWidth=u.maxWidth=u.width=c,c=s.width,u.width=n,u.minWidth=o,u.maxWidth=a)),c},oe.each(["height","width"],function(e,r){oe.cssHooks[r]={get:function(e,i,n){return i?0===e.offsetWidth&&je.test(oe.css(e,"display"))?oe.swap(e,Ue,function(){return C(e,r,n)}):C(e,r,n):t},set:function(e,t,i){var n=i&&T(e);return L(e,t,i?x(e,r,i,oe.support.boxSizing&&"border-box"===oe.css(e,"boxSizing",!1,n),n):0)}}}),oe(function(){oe.support.reliableMarginRight||(oe.cssHooks.marginRight={get:function(e,r){return r?oe.swap(e,{display:"inline-block"},qe,[e,"marginRight"]):t}}),!oe.support.pixelPosition&&oe.fn.position&&oe.each(["top","left"],function(e,r){oe.cssHooks[r]={get:function(e,i){return i?(i=qe(e,r),Ke.test(i)?oe(e).position()[r]+"px":i):t}}})}),oe.expr&&oe.expr.filters&&(oe.expr.filters.hidden=function(e){return 0>=e.offsetWidth&&0>=e.offsetHeight},oe.expr.filters.visible=function(e){return!oe.expr.filters.hidden(e)}),oe.each({margin:"",padding:"",border:"Width"},function(e,t){oe.cssHooks[e+t]={expand:function(r){for(var i=0,n={},o="string"==typeof r?r.split(" "):[r];4>i;i++)n[e+Je[i]+t]=o[i]||o[i-2]||o[0];return n}},He.test(e)||(oe.cssHooks[e+t].set=L)});var Qe=/%20/g,et=/\[\]$/,tt=/\r?\n/g,rt=/^(?:submit|button|image|reset|file)$/i,it=/^(?:input|select|textarea|keygen)/i;oe.fn.extend({serialize:function(){return oe.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=oe.prop(this,"elements");return e?oe.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!oe(this).is(":disabled")&&it.test(this.nodeName)&&!rt.test(e)&&(this.checked||!Me.test(e))}).map(function(e,t){var r=oe(this).val();return null==r?null:oe.isArray(r)?oe.map(r,function(e){return{name:t.name,value:e.replace(tt,"\r\n")}}):{name:t.name,value:r.replace(tt,"\r\n")}}).get()}}),oe.param=function(e,r){var i,n=[],o=function(e,t){t=oe.isFunction(t)?t():null==t?"":t,n[n.length]=encodeURIComponent(e)+"="+encodeURIComponent(t)};if(r===t&&(r=oe.ajaxSettings&&oe.ajaxSettings.traditional),oe.isArray(e)||e.jquery&&!oe.isPlainObject(e))oe.each(e,function(){o(this.name,this.value)});else for(i in e)A(i,e[i],r,o);return n.join("&").replace(Qe,"+")},oe.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(e,t){oe.fn[t]=function(e,r){return arguments.length>0?this.on(t,null,e,r):this.trigger(t)}}),oe.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)},bind:function(e,t,r){return this.on(e,null,t,r)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,r,i){return this.on(t,e,r,i)},undelegate:function(e,t,r){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",r)}});var nt,ot,at=oe.now(),st=/\?/,ct=/#.*$/,ut=/([?&])_=[^&]*/,lt=/^(.*?):[ \t]*([^\r\n]*)$/gm,ht=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,ft=/^(?:GET|HEAD)$/,dt=/^\/\//,pt=/^([\w.+-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,gt=oe.fn.load,yt={},mt={},vt="*/".concat("*");try{ot=H.href}catch(wt){ot=$.createElement("a"),ot.href="",ot=ot.href}nt=pt.exec(ot.toLowerCase())||[],oe.fn.load=function(e,r,i){if("string"!=typeof e&&gt)return gt.apply(this,arguments);var n,o,a,s=this,c=e.indexOf(" ");return c>=0&&(n=e.slice(c),e=e.slice(0,c)),oe.isFunction(r)?(i=r,r=t):r&&"object"==typeof r&&(o="POST"),s.length>0&&oe.ajax({url:e,type:o,dataType:"html",data:r}).done(function(e){a=arguments,s.html(n?oe("<div>").append(oe.parseHTML(e)).find(n):e)}).complete(i&&function(e,t){s.each(i,a||[e.responseText,t,e])}),this},oe.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){oe.fn[t]=function(e){return this.on(t,e)}}),oe.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:ot,type:"GET",isLocal:ht.test(nt[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":vt,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":oe.parseJSON,"text xml":oe.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?N(N(e,oe.ajaxSettings),t):N(oe.ajaxSettings,e)},ajaxPrefilter:O(yt),ajaxTransport:O(mt),ajax:function(e,r){function i(e,r,i,s){var u,h,v,w,b,x=r;2!==T&&(T=2,c&&clearTimeout(c),n=t,a=s||"",L.readyState=e>0?4:0,u=e>=200&&300>e||304===e,i&&(w=E(f,L,i)),w=_(f,w,L,u),u?(f.ifModified&&(b=L.getResponseHeader("Last-Modified"),b&&(oe.lastModified[o]=b),b=L.getResponseHeader("etag"),b&&(oe.etag[o]=b)),204===e?x="nocontent":304===e?x="notmodified":(x=w.state,h=w.data,v=w.error,u=!v)):(v=x,(e||!x)&&(x="error",0>e&&(e=0))),L.status=e,L.statusText=(r||x)+"",u?g.resolveWith(d,[h,x,L]):g.rejectWith(d,[L,x,v]),L.statusCode(m),m=t,l&&p.trigger(u?"ajaxSuccess":"ajaxError",[L,f,u?h:v]),y.fireWith(d,[L,x]),l&&(p.trigger("ajaxComplete",[L,f]),--oe.active||oe.event.trigger("ajaxStop")))}"object"==typeof e&&(r=e,e=t),r=r||{};var n,o,a,s,c,u,l,h,f=oe.ajaxSetup({},r),d=f.context||f,p=f.context&&(d.nodeType||d.jquery)?oe(d):oe.event,g=oe.Deferred(),y=oe.Callbacks("once memory"),m=f.statusCode||{},v={},w={},T=0,b="canceled",L={readyState:0,getResponseHeader:function(e){var t;if(2===T){if(!s)for(s={};t=lt.exec(a);)s[t[1].toLowerCase()]=t[2];t=s[e.toLowerCase()]}return null==t?null:t},getAllResponseHeaders:function(){return 2===T?a:null},setRequestHeader:function(e,t){var r=e.toLowerCase();return T||(e=w[r]=w[r]||e,v[e]=t),this},overrideMimeType:function(e){return T||(f.mimeType=e),this},statusCode:function(e){var t;if(e)if(2>T)for(t in e)m[t]=[m[t],e[t]];else L.always(e[L.status]);return this},abort:function(e){var t=e||b;return n&&n.abort(t),i(0,t),this}};if(g.promise(L).complete=y.add,L.success=L.done,L.error=L.fail,f.url=((e||f.url||ot)+"").replace(ct,"").replace(dt,nt[1]+"//"),f.type=r.method||r.type||f.method||f.type,f.dataTypes=oe.trim(f.dataType||"*").toLowerCase().match(se)||[""],null==f.crossDomain&&(u=pt.exec(f.url.toLowerCase()),f.crossDomain=!(!u||u[1]===nt[1]&&u[2]===nt[2]&&(u[3]||("http:"===u[1]?"80":"443"))===(nt[3]||("http:"===nt[1]?"80":"443")))),f.data&&f.processData&&"string"!=typeof f.data&&(f.data=oe.param(f.data,f.traditional)),R(yt,f,r,L),2===T)return L;l=f.global,l&&0===oe.active++&&oe.event.trigger("ajaxStart"),f.type=f.type.toUpperCase(),f.hasContent=!ft.test(f.type),o=f.url,f.hasContent||(f.data&&(o=f.url+=(st.test(o)?"&":"?")+f.data,delete f.data),f.cache===!1&&(f.url=ut.test(o)?o.replace(ut,"$1_="+at++):o+(st.test(o)?"&":"?")+"_="+at++)),f.ifModified&&(oe.lastModified[o]&&L.setRequestHeader("If-Modified-Since",oe.lastModified[o]),oe.etag[o]&&L.setRequestHeader("If-None-Match",oe.etag[o])),(f.data&&f.hasContent&&f.contentType!==!1||r.contentType)&&L.setRequestHeader("Content-Type",f.contentType),L.setRequestHeader("Accept",f.dataTypes[0]&&f.accepts[f.dataTypes[0]]?f.accepts[f.dataTypes[0]]+("*"!==f.dataTypes[0]?", "+vt+"; q=0.01":""):f.accepts["*"]);for(h in f.headers)L.setRequestHeader(h,f.headers[h]);if(f.beforeSend&&(f.beforeSend.call(d,L,f)===!1||2===T))return L.abort();b="abort";for(h in{success:1,error:1,complete:1})L[h](f[h]);if(n=R(mt,f,r,L)){L.readyState=1,l&&p.trigger("ajaxSend",[L,f]),f.async&&f.timeout>0&&(c=setTimeout(function(){L.abort("timeout")},f.timeout));try{T=1,n.send(v,i)}catch(x){if(!(2>T))throw x;i(-1,x)}}else i(-1,"No Transport");return L},getJSON:function(e,t,r){return oe.get(e,t,r,"json")},getScript:function(e,r){return oe.get(e,t,r,"script")}}),oe.each(["get","post"],function(e,r){oe[r]=function(e,i,n,o){return oe.isFunction(i)&&(o=o||n,n=i,i=t),oe.ajax({url:e,type:r,dataType:o,data:i,success:n})}}),oe.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(e){return oe.globalEval(e),e}}}),oe.ajaxPrefilter("script",function(e){e.cache===t&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),oe.ajaxTransport("script",function(e){if(e.crossDomain){var t,r;return{send:function(i,n){t=oe("<script>").prop({async:!0,charset:e.scriptCharset,src:e.url}).on("load error",r=function(e){t.remove(),r=null,e&&n("error"===e.type?404:200,e.type)}),$.head.appendChild(t[0])},abort:function(){r&&r()}}}});var Tt=[],bt=/(=)\?(?=&|$)|\?\?/;oe.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Tt.pop()||oe.expando+"_"+at++;return this[e]=!0,e}}),oe.ajaxPrefilter("json jsonp",function(r,i,n){var o,a,s,c=r.jsonp!==!1&&(bt.test(r.url)?"url":"string"==typeof r.data&&!(r.contentType||"").indexOf("application/x-www-form-urlencoded")&&bt.test(r.data)&&"data");return c||"jsonp"===r.dataTypes[0]?(o=r.jsonpCallback=oe.isFunction(r.jsonpCallback)?r.jsonpCallback():r.jsonpCallback,c?r[c]=r[c].replace(bt,"$1"+o):r.jsonp!==!1&&(r.url+=(st.test(r.url)?"&":"?")+r.jsonp+"="+o),r.converters["script json"]=function(){return s||oe.error(o+" was not called"),s[0]},r.dataTypes[0]="json",a=e[o],e[o]=function(){s=arguments},n.always(function(){e[o]=a,r[o]&&(r.jsonpCallback=i.jsonpCallback,Tt.push(o)),s&&oe.isFunction(a)&&a(s[0]),s=a=t}),"script"):t}),oe.ajaxSettings.xhr=function(){try{return new XMLHttpRequest}catch(e){}};var Lt=oe.ajaxSettings.xhr(),xt={0:200,1223:204},Ct=0,St={};e.ActiveXObject&&oe(e).on("unload",function(){for(var e in St)St[e]();St=t}),oe.support.cors=!!Lt&&"withCredentials"in Lt,oe.support.ajax=Lt=!!Lt,oe.ajaxTransport(function(e){var r;return oe.support.cors||Lt&&!e.crossDomain?{send:function(i,n){var o,a,s=e.xhr();if(s.open(e.type,e.url,e.async,e.username,e.password),e.xhrFields)for(o in e.xhrFields)s[o]=e.xhrFields[o];e.mimeType&&s.overrideMimeType&&s.overrideMimeType(e.mimeType),e.crossDomain||i["X-Requested-With"]||(i["X-Requested-With"]="XMLHttpRequest");for(o in i)s.setRequestHeader(o,i[o]);r=function(e){return function(){r&&(delete St[a],r=s.onload=s.onerror=null,"abort"===e?s.abort():"error"===e?n(s.status||404,s.statusText):n(xt[s.status]||s.status,s.statusText,"string"==typeof s.responseText?{text:s.responseText}:t,s.getAllResponseHeaders()))}},s.onload=r(),s.onerror=r("error"),r=St[a=Ct++]=r("abort"),s.send(e.hasContent&&e.data||null)},abort:function(){r&&r()}}:t});var kt,At,Ot=/^(?:toggle|show|hide)$/,Rt=RegExp("^(?:([+-])=|)("+ae+")([a-z%]*)$","i"),Nt=/queueHooks$/,Et=[B],_t={"*":[function(e,t){var r,i,n=this.createTween(e,t),o=Rt.exec(t),a=n.cur(),s=+a||0,c=1,u=20;if(o){if(r=+o[2],i=o[3]||(oe.cssNumber[e]?"":"px"),"px"!==i&&s){s=oe.css(n.elem,e,!0)||r||1;do c=c||".5",s/=c,oe.style(n.elem,e,s+i);while(c!==(c=n.cur()/a)&&1!==c&&--u)}n.unit=i,n.start=s,n.end=o[1]?s+(o[1]+1)*r:r}return n}]};oe.Animation=oe.extend(M,{tweener:function(e,t){oe.isFunction(e)?(t=e,e=["*"]):e=e.split(" ");for(var r,i=0,n=e.length;n>i;i++)r=e[i],_t[r]=_t[r]||[],_t[r].unshift(t)},prefilter:function(e,t){t?Et.unshift(e):Et.push(e)}}),oe.Tween=P,P.prototype={constructor:P,init:function(e,t,r,i,n,o){this.elem=e,this.prop=r,this.easing=n||"swing",this.options=t,this.start=this.now=this.cur(),this.end=i,this.unit=o||(oe.cssNumber[r]?"":"px")},cur:function(){var e=P.propHooks[this.prop];return e&&e.get?e.get(this):P.propHooks._default.get(this)},run:function(e){var t,r=P.propHooks[this.prop];return this.pos=t=this.options.duration?oe.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),r&&r.set?r.set(this):P.propHooks._default.set(this),this}},P.prototype.init.prototype=P.prototype,P.propHooks={_default:{get:function(e){var t;return null==e.elem[e.prop]||e.elem.style&&null!=e.elem.style[e.prop]?(t=oe.css(e.elem,e.prop,""),t&&"auto"!==t?t:0):e.elem[e.prop]},set:function(e){oe.fx.step[e.prop]?oe.fx.step[e.prop](e):e.elem.style&&(null!=e.elem.style[oe.cssProps[e.prop]]||oe.cssHooks[e.prop])?oe.style(e.elem,e.prop,e.now+e.unit):e.elem[e.prop]=e.now}}},P.propHooks.scrollTop=P.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},oe.each(["toggle","show","hide"],function(e,t){var r=oe.fn[t];oe.fn[t]=function(e,i,n){return null==e||"boolean"==typeof e?r.apply(this,arguments):this.animate(G(t,!0),e,i,n)}}),oe.fn.extend({fadeTo:function(e,t,r,i){return this.filter(w).css("opacity",0).show().end().animate({opacity:t},e,r,i)},animate:function(e,t,r,i){var n=oe.isEmptyObject(e),o=oe.speed(t,r,i),a=function(){var t=M(this,oe.extend({},e),o);a.finish=function(){t.stop(!0)},(n||ye.get(this,"finish"))&&t.stop(!0)};return a.finish=a,n||o.queue===!1?this.each(a):this.queue(o.queue,a)},stop:function(e,r,i){var n=function(e){var t=e.stop;delete e.stop,t(i)};return"string"!=typeof e&&(i=r,r=e,e=t),r&&e!==!1&&this.queue(e||"fx",[]),this.each(function(){var t=!0,r=null!=e&&e+"queueHooks",o=oe.timers,a=ye.get(this);if(r)a[r]&&a[r].stop&&n(a[r]);else for(r in a)a[r]&&a[r].stop&&Nt.test(r)&&n(a[r]);for(r=o.length;r--;)o[r].elem!==this||null!=e&&o[r].queue!==e||(o[r].anim.stop(i),t=!1,o.splice(r,1));(t||!i)&&oe.dequeue(this,e)})},finish:function(e){return e!==!1&&(e=e||"fx"),this.each(function(){var t,r=ye.get(this),i=r[e+"queue"],n=r[e+"queueHooks"],o=oe.timers,a=i?i.length:0;for(r.finish=!0,oe.queue(this,e,[]),n&&n.cur&&n.cur.finish&&n.cur.finish.call(this),t=o.length;t--;)o[t].elem===this&&o[t].queue===e&&(o[t].anim.stop(!0),o.splice(t,1));for(t=0;a>t;t++)i[t]&&i[t].finish&&i[t].finish.call(this);delete r.finish})}}),oe.each({slideDown:G("show"),slideUp:G("hide"),slideToggle:G("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,t){oe.fn[e]=function(e,r,i){return this.animate(t,e,r,i)}}),oe.speed=function(e,t,r){var i=e&&"object"==typeof e?oe.extend({},e):{complete:r||!r&&t||oe.isFunction(e)&&e,duration:e,easing:r&&t||t&&!oe.isFunction(t)&&t};return i.duration=oe.fx.off?0:"number"==typeof i.duration?i.duration:i.duration in oe.fx.speeds?oe.fx.speeds[i.duration]:oe.fx.speeds._default,(null==i.queue||i.queue===!0)&&(i.queue="fx"),i.old=i.complete,i.complete=function(){oe.isFunction(i.old)&&i.old.call(this),i.queue&&oe.dequeue(this,i.queue)},i},oe.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2}},oe.timers=[],oe.fx=P.prototype.init,oe.fx.tick=function(){var e,r=oe.timers,i=0;for(kt=oe.now();r.length>i;i++)e=r[i],e()||r[i]!==e||r.splice(i--,1);r.length||oe.fx.stop(),kt=t},oe.fx.timer=function(e){e()&&oe.timers.push(e)&&oe.fx.start()},oe.fx.interval=13,oe.fx.start=function(){At||(At=setInterval(oe.fx.tick,oe.fx.interval))},oe.fx.stop=function(){clearInterval(At),At=null},oe.fx.speeds={slow:600,fast:200,_default:400},oe.fx.step={},oe.expr&&oe.expr.filters&&(oe.expr.filters.animated=function(e){return oe.grep(oe.timers,function(t){return e===t.elem}).length}),oe.fn.offset=function(e){if(arguments.length)return e===t?this:this.each(function(t){oe.offset.setOffset(this,e,t)});var r,i,n=this[0],o={top:0,left:0},a=n&&n.ownerDocument;return a?(r=a.documentElement,oe.contains(r,n)?(typeof n.getBoundingClientRect!==j&&(o=n.getBoundingClientRect()),i=z(a),{top:o.top+i.pageYOffset-r.clientTop,left:o.left+i.pageXOffset-r.clientLeft}):o):void 0},oe.offset={setOffset:function(e,t,r){var i,n,o,a,s,c,u,l=oe.css(e,"position"),h=oe(e),f={};"static"===l&&(e.style.position="relative"),s=h.offset(),o=oe.css(e,"top"),c=oe.css(e,"left"),u=("absolute"===l||"fixed"===l)&&(o+c).indexOf("auto")>-1,u?(i=h.position(),a=i.top,n=i.left):(a=parseFloat(o)||0,n=parseFloat(c)||0),oe.isFunction(t)&&(t=t.call(e,r,s)),null!=t.top&&(f.top=t.top-s.top+a),null!=t.left&&(f.left=t.left-s.left+n),"using"in t?t.using.call(e,f):h.css(f)}},oe.fn.extend({position:function(){if(this[0]){var e,t,r=this[0],i={top:0,left:0};return"fixed"===oe.css(r,"position")?t=r.getBoundingClientRect():(e=this.offsetParent(),t=this.offset(),oe.nodeName(e[0],"html")||(i=e.offset()),i.top+=oe.css(e[0],"borderTopWidth",!0),i.left+=oe.css(e[0],"borderLeftWidth",!0)),{top:t.top-i.top-oe.css(r,"marginTop",!0),left:t.left-i.left-oe.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var e=this.offsetParent||K;e&&!oe.nodeName(e,"html")&&"static"===oe.css(e,"position");)e=e.offsetParent;return e||K})}}),oe.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(r,i){var n="pageYOffset"===i;oe.fn[r]=function(o){return oe.access(this,function(r,o,a){var s=z(r);return a===t?s?s[i]:r[o]:(s?s.scrollTo(n?e.pageXOffset:a,n?a:e.pageYOffset):r[o]=a,t)},r,o,arguments.length,null)}}),oe.each({Height:"height",Width:"width"},function(e,r){oe.each({padding:"inner"+e,content:r,"":"outer"+e},function(i,n){oe.fn[n]=function(n,o){var a=arguments.length&&(i||"boolean"!=typeof n),s=i||(n===!0||o===!0?"margin":"border");return oe.access(this,function(r,i,n){var o;return oe.isWindow(r)?r.document.documentElement["client"+e]:9===r.nodeType?(o=r.documentElement,Math.max(r.body["scroll"+e],o["scroll"+e],r.body["offset"+e],o["offset"+e],o["client"+e])):n===t?oe.css(r,i,s):oe.style(r,i,n,s)},r,a?n:t,a,null)}})}),oe.fn.size=function(){return this.length},oe.fn.andSelf=oe.fn.addBack,"object"==typeof module&&"object"==typeof module.exports?module.exports=oe:"function"==typeof define&&define.amd&&define("jquery",[],function(){return oe}),"object"==typeof e&&"object"==typeof e.document&&(e.jQuery=e.$=oe)}(window),browser={isIE:-1!=navigator.userAgent.indexOf("MSIE"),isFirefox:-1!=navigator.userAgent.toLowerCase().indexOf("firefox"),isNativeApp:-1!=navigator.userAgent.toLowerCase().indexOf("adsphere")||window.nativeInjected,isIOs:!!navigator.userAgent.match(/(iPad|iPhone|iPod)/i),isAndroid:!!navigator.userAgent.match(/(android)/i),isNodeWebkit:"object"==typeof process},browser.supportsMultipleAudio=function(){if(browser.isAndroid)return!1;if(browser.isIOs){var e=function(){var e=window.navigator.userAgent,t=e.indexOf("OS ");return(e.indexOf("iPhone")>-1||e.indexOf("iPad")>-1)&&t>-1?Number(e.substr(t+3,3).replace("_",".")):-1}();return e>=6}return!0}(),Event.prototype.normalizedCoordinate=function(e){var t=0,r=0,i=document.getElementById("main-wrapper");return this.changedTouches?returnCoordinate={x:(this.changedTouches[0].pageX-i.getBoundingClientRect().left)/scale+t,y:(this.changedTouches[0].pageY-i.getBoundingClientRect().top)/scale+r}:returnCoordinate={x:(this.clientX-i.getBoundingClientRect().left)/scale+t,y:(this.clientY-i.getBoundingClientRect().top)/scale+r},e instanceof Layer&&(returnCoordinate=e.localLocation(returnCoordinate.x,returnCoordinate.y)),returnCoordinate};var scaleToFitPage,scale=1,setPageScale;!function(){function e(){if(t)return t;var e=window,r=document,i=r.documentElement,n=r.getElementsByTagName("body")[0],o=e.innerWidth||i.clientWidth||n.clientWidth,a=e.innerHeight||i.clientHeight||n.clientHeight;return{width:o,height:a}}var t;setPageScale=function(e){if(scale!=e){scale=e;var t=$("#main-wrapper");t.css("transformOrigin","0% 0%").css("transform","scale("+scale+")")}};var r;scaleToFitPage=function(i,n){var o;if(-1>=i||-1>=n?t=void 0:i&&n&&(o=t={width:i,height:n}),!o){if(o=e(),r&&r.width==o.width&&r.height==o.height)return;var a=document.body;a.style.overflow="hidden",browser.isIOs&&window==window.top?a.style.height=2*o.height+"px":a.style.height=o.height+"px",window.scrollTo(0,0),o=e()}r=o;var s=o.width/config.scWidth,c=o.height/config.scHeight,u=Math.min(s,c);setPageScale(u);var l=$("#main-wrapper");return l.css("top",(o.height-config.scHeight*u)/2+"px").css("left",(o.width-config.scWidth*u)/2+"px"),this}}(),function(){browser.isAndroid&&(window.requestAnimationFrame=function(e){return window.setTimeout(e,1e3/60)});for(var e=0,t=Date.now(),r=["ms","moz","webkit","o"],i=0;i<r.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[r[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[r[i]+"CancelAnimationFrame"]||window[r[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(r,i){var n=(new Date).getTime(),o=Math.max(0,16-(n-e)),a=window.setTimeout(function(){r(n-t)},o);return e=n+o,a}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),function(){if(window.chrome){var e=CanvasRenderingContext2D.prototype.fillText;CanvasRenderingContext2D.prototype.fillText=function(t,r,i,n){if(-1==t.indexOf("　"))return e.apply(this,arguments);for(var o=t.split(""),a=r,s=0;s<o.length;s++){
var c=o[s],u=this.measureText(c).width;if(r+u-a>n)break;e.call(this,c,r,i),r+=u}}}}(),Function.prototype.bind||(Function.prototype.bind=function(e){if("function"!=typeof this)throw new TypeError("[内部エラー] Function.prototype.bind - what is trying to be bound is not callable");var t=Array.prototype.slice.call(arguments,1),r=this,i=function(){},n=function(){return r.apply(this instanceof i&&e?this:e,t.concat(Array.prototype.slice.call(arguments)))};return i.prototype=this.prototype,n.prototype=new i,n}),$(function(){$.fn.bindFirst=function(e,t){return this.on(e,t),this.each(function(){var t=$._data(this,"events")[e.split(".")[0]];if(t){var r=t.pop();t.splice(0,0,r)}}),this}});var isFontLoaded;!function(){var e=null,t=null,r={};isFontLoaded=function(i){e||(e=document.createElement("canvas"),t=e.getContext("2d"));for(var n="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",o=["monospace","sans-serif","serif"],a=0,s=o.length;s>a;a++){var c=o[a],u=r[c];u||(t.font="72px "+c,u=r[c]=t.measureText(n).width);var l=r[i];if(l||(t.font="72px "+i+","+c,l=t.measureText(n).width),u!=l)return r[i]=l,!0}return!1}}(this);var ResourceLoader;!function(){function e(e,t){if(-1==config.numImageCache)return void(l[e]=t);var r=h.indexOf(e);if(-1!=r&&h.splice(r,1),h.push(e),l[e]=t,h.length>config.numImageCache){var i=h.length-config.numImageCache,n=h.splice(0,i);n.forEach(function(e){delete l[e]})}}var t=function(){function e(e,i){if(!r){var n=t.canPlayType(e);"maybe"!==n&&"probably"!==n||(r=i)}}var t=new Audio,r=void 0;return browser.isNodeWebkit&&e("audio/ogg","ogg"),e("audio/mp4","mp4"),e("audio/ogg","ogg"),e("audio/mp3","mp3"),e("audio/wav","wav"),r||"ogg"},r=function(){var e=document.createElement("video");return"maybe"==e.canPlayType("video/webm")?"webm":"maybe"==e.canPlayType("video/mp4")?"mp4":"maybe"==e.canPlayType("video/ogg")?"ogv":void 0},i=3e3,n=1e4,o=10,a=1e4,s=3,c=3,u=1e4,l={},h=[],f={},d=function(e){var t=$.Deferred(),r=new Image;$(r).on("readystatechange load",function(e){$(this).off(),r.complete||4==r.readyState||"complete"==r.readyState?t.resolve(r):$(r).trigger("error")}),$(r).on("error",function(e){$(this).off(),t.reject(e)});var i=setTimeout(function(){$(r).trigger("error")},n);return t.always(function(){clearTimeout(i)}),$(r).attr("src",e),t.promise()},p=function(e,t){return y(e,"audio",t)},g=function(e,t){return y(e,"video",t)},y=function(e,t,r){var i=$.Deferred();return r||(r="video"==t?document.createElement("video"):new Audio),$(r).on("canplaythrough stalled suspend",function(){$(this).off(),i.resolve(r)}),$(r).on("error",function(){$(this).off(),i.reject()}),r.autoplay=!1,r.src="",r.src=e,r.load(),setTimeout(function(){i.reject()},a),i.promise()};ResourceLoader={getAudioExtension:function(){var e=t();return ResourceLoader.getAudioExtension=function(){return e},e},getVideoExtension:function(){var e=r();return ResourceLoader.getVideoExtension=function(){return e},e},loadImage:function(t,r){function n(){c=d(t),c.done(function(e){e.originalURL=s,a.resolve(e)}).fail(function(e){(browser.isIOs||browser.isAndroid)&&!navigator.onLine||o>u?(setTimeout(n,100),u++,r&&Renderer.showLoadingSign()):r?(Renderer.hideLoadingSign(),Renderer.showServerError(function(){u=0,r&&Renderer.showLoadingSign(),n()})):a.reject(e)})}"undefined"==typeof r&&(r=!0),"data:"!=t.substr(0,5)&&(t=t.toLowerCase());var a=$.Deferred(),s=t;if(t in o2.imageList)t=o2.imageList[t];else if("data:"!=t.substr(0,5))return o2.error("ストレージに"+s+"が見つかりません"),a.reject();if(t in f)return f[t].promise();if(a.done(function(e){ev.lastimage.width=e.width,ev.lastimage.height=e.height}),t in l)a.resolve(l[t]);else{f[t]=a;var c,u=0;n();var h;r&&(h=setTimeout(function(){Renderer.showLoadingSign()},i)),a.done(function(r){e(t,r)}),a.always(function(){r&&(clearTimeout(h),Renderer.hideLoadingSign()),delete f[t]})}return a.promise()},getFullAudioPath:function(e){e=e.toLowerCase();var t=o2.soundList[e];if(t)return t+"."+ResourceLoader.getAudioExtension()},loadAudio:function(e,t,r){function n(){var e=p(a,r);e.done(function(e){o.resolve(e)}).fail(function(e){(browser.isIOs||browser.isAndroid)&&!navigator.onLine||s>c?(setTimeout(n,100),c++,t&&Renderer.showLoadingSign()):t?(Renderer.hideLoadingSign(),Renderer.showServerError(function(){c=0,t&&Renderer.showLoadingSign(),n()})):o.reject(e)})}var o=$.Deferred();"undefined"==typeof t&&(t=!0);var a=this.getFullAudioPath(e);if(!a)return o2.error("ストレージに"+a+" が見つかりません"),o.reject();var c=0;n();var u;return t&&(u=setTimeout(function(){Renderer.showLoadingSign()},i)),o.always(function(){t&&(clearTimeout(u),Renderer.hideLoadingSign())}),o.promise()},loadVideo:function(e,t,r){function n(){var i=g(e+"."+ResourceLoader.getVideoExtension(),r);i.done(function(e){o.resolve(e)}).fail(function(e){(browser.isIOs||browser.isAndroid)&&!navigator.onLine||c>a?(setTimeout(n,100),a++,t&&Renderer.showLoadingSign()):t?(Renderer.hideLoadingSign(),Renderer.showServerError(function(){a=0,t&&Renderer.showLoadingSign(),n()})):o.reject(e)})}if("undefined"==typeof t&&(t=!0),e=e.toLowerCase(),!(e in o2.videoList))throw"ムービーストレージ "+e+" が存在しません";e=o2.videoList[e];var o=$.Deferred(),a=0;n();var s;return t&&(s=setTimeout(function(){Renderer.showLoadingSign()},i)),o.always(function(){t&&(clearTimeout(s),Renderer.hideLoadingSign())}),o.promise()},loadFont:function(e,t){var r=e,n=$.Deferred();if(-1!==e.indexOf(",")){var o=e.split(/\s*,\s*/g),a=o.map(function(e){return e=e.replace('"',""),ResourceLoader.loadFont(e)});return $.when.apply($,a)}if(isFontLoaded(r))return n.resolve();if(e=e.toLowerCase(),!(e in o2.fontList))return n.resolve();e=o2.fontList[e],$("head").prepend('<style type="text/css">@font-face {font-family: "'+r+'";src: url("'+e+'.ttf"),     url("'+e+'.woff");}</style>');var s,c,l=$("<div />").css({"font-family":r,height:0,width:0,opacity:0,margin:0}).html(".").appendTo($("body")),h=(setTimeout(function f(){isFontLoaded(r)?n.resolve():setTimeout(f,100)},100),function(){t&&(s=setTimeout(function(){Renderer.showLoadingSign()},i),c=setTimeout(function(){n.reject()},u))});return h(),n.always(function(){clearTimeout(s),clearTimeout(c),Renderer.hideLoadingSign(),l.remove()}),n.promise()}}}();var Conductor=function(e){this.waitTag={},this.file,this.lineNumber=-1,this.currentTag,this.oneShotStackDepth=0,this.paused=!1,this.tagActions={};var t=[];if(Object.defineProperty(this,"stack",{get:function(){return t},set:function(e){return e}}),this.queue=[],this.status=Conductor.STATUS_STOP,this.callStack=[],this.macroStack=[],this.macros={},this.ifStack=[],this.callbackVarsStack=[],e&&(e.file&&this.setFile(e.file),e.label)){"*"==e.label.charAt(0)&&(e.label=e.label.substring(1));var r=this.file.getLabelTag(e.label);r&&this.setTag(r)}var i=this;this.queue.push=function(e){if(e instanceof Tag){var t=Array.prototype.push.apply(this,arguments);return"click"in i.waitTag?i.trigger("click"):i.status==Conductor.STATUS_STOP&&i.oneShot(),t}}};Conductor.STATUS_STOP=0,Conductor.STATUS_PREPARE_TAG=1,Conductor.STATUS_RUN=2,Conductor.STATUS_WAIT=3,Conductor.prototype.toJSON=function(){var e={currentTag:this.currentTag,stack:this.queue,ifStack:this.ifStack};return config.saveMode==o2.SAVE_MODE_O2KAG&&(e.macroStack=this.macroStack,e.callStack=this.callStack),e},Conductor.prototype.importFromSaveData=function(e){this.waitTag={},this.callStack=[],this.clearMacroStack(),this.clearIfStack(),this.clearStack();var t=this;if(e.currentTag){var r=e.currentTag.restore();return $.when(r).then(function(r){return t.setTag(r,!0),delete e.currentTag,Object.prototype.importFromSaveData.call(t,e)})}var i=KAGFiles(e.file);return $.when(i).then(function(r){var i=r.lines[e.lineNumber];return t.setTag(i,!0),Object.prototype.importFromSaveData.call(t,e)})},Conductor.prototype.importFrom=function(e){throw"【内部エラー】コンダクターはコピーできません。"},Conductor.prototype.getTagAction=function(e){return this.tagActions[e]||Tag.actions[e]},Conductor.prototype.run=function(){if(!this.paused){if(this.waitTag={},this.queue.length)this.currentTag=this.queue.shift();else{var nextTag=this.file.lines[this.lineNumber];if(this.currentTag=nextTag,!this.currentTag){var stopTag=new Tag("s");return void this.queue.push(stopTag)}var lineNumber=this.currentTag.originalLineNumber||this.currentTag.lineNumber,message="ファイル: "+this.file.filename+" / ";message+="行:"+lineNumber+" / ","undefined"!=typeof this.currentTag.originalCharNumber&&(message+="文字:"+this.currentTag.originalCharNumber+" / "),message+="タグ: ",message+=this.macroStack.map(function(e){return e.definition.name}).concat([this.currentTag.tagName]).join(" > "),this.callStack.length&&(message+="\ncall stack: ",message+=this.callStack.map(function(e){var t=e.originalLineNumber||e.line;return e.file+":"+(t-1)+" : call"}).join(" > ")),o2.log(message),this.lineNumber++,this.currentTag.file.recentlyUsed()}var result,condition=!0;if("o2_cond"in this.currentTag.args)try{eval(this.currentTag.args.o2_cond)||(condition=!1)}catch(e){condition=!1}if(condition){if(this.currentTag.conductor=this,this.isMacro(this.currentTag))return void this.jumpIntoMacro(this.currentTag);if(this.shouldMacroEnd())return void this.jumpOutOfMacro();this.status=Conductor.STATUS_PREPARE_TAG,result=this.currentTag.run(),void 0==result&&(result=0),delete this.currentTag.conductor,0===result&&(this.status=Conductor.STATUS_RUN)}else o2.log("o2_condの評価結果がfalseだったため実行されませんでした"),result=0;var _this=this;0==result?($(this).trigger("ran",[result]),this.oneShotStackDepth++,this.oneShot()):1==result?(this.oneShotStackDepth=0,this.wait(this.currentTag.tagName),this.wait("*",function(){$(_this).trigger("ran",[result])})):2==result&&(this.oneShotStackDepth=0,this.status=Conductor.STATUS_STOP,$(this).trigger("ran",[result]))}},Conductor.prototype.setFile=function(e){this.setTag(e.line(0))},Conductor.prototype.setTag=function(e,t){return e.file?(this.file=e.file,this.lineNumber=e.lineNumber,void(t&&this.lineNumber++)):void this.queue.push(e)},Conductor.prototype.getNextTag=function(e){if(!e)return this.queue.length?this.queue[0]:this.file.lines[this.lineNumber];for(var t=this.upComingTags(),r=0;r<t.length;r++)if(t[r].tagName==e)return t[r]},Conductor.prototype.upComingTags=function(){return this.queue.concat(this.file.lines.slice(this.lineNumber))},Conductor.prototype.oneShot=function(){if(this.oneShotStackDepth<5e3)this.run();else{var e=this;setTimeout(function(){e.oneShotStackDepth=0,e.run()})}},Conductor.prototype.isCurrentRead=function(){return!0},Conductor.prototype.pause=function(){this.paused=!0},Conductor.prototype.resume=function(){this.paused=!1},function(){function e(){if(!currentConductor.macroStack.length)return void(window.mp={});var e=currentConductor.macroStack[currentConductor.macroStack.length-1];window.mp=e.args}Conductor.prototype.isMacro=function(e){return e instanceof Tag&&(e=e.tagName),e in this.macros},Conductor.prototype.jumpIntoMacro=function(t){var r,i=new Macro;if(t instanceof Tag){var n=t;if(r=this.macros[n.tagName],!r)throw"登録されていないマクロ "+n.tagName+" が呼び出されました";i.args=n.argsForAction(),i.args.tagname=n.tagName}else r=this.macros[t];i.definition=r;var o=this.getNextTag();if(o)i.returnTag=o.toRestorable();else{var a=new Tag("s");i.returnTag=a.toRestorable()}this.macroStack.push(i),e();var s=this;this.wait("jumpIntoMacro"),$.when(r.startTag.restore()).done(function(e){s.setTag(e),s.trigger("jumpIntoMacro")})},Conductor.prototype.shouldMacroEnd=function(){if(!this.macroStack.length)return!1;this.macroStack[this.macroStack.length-1];return"endmacro"==this.currentTag.tagName},Conductor.prototype.jumpOutOfMacro=function(){var t=this.macroStack.pop();if(e(),t){this.wait("jumpOutOfMacro");var r=t.returnTag.restore(),i=this;$.when(r).then(function(e){i.setTag(e),$(i).trigger("ran",[0]),i.trigger("jumpOutOfMacro")})}else this.oneShot()},Conductor.prototype.clearMacroStack=function(){this.macroStack=[],e()};var t=Conductor.prototype.importFromSaveData;Conductor.prototype.importFromSaveData=function(){return t.apply(this,arguments).done(function(){e()})}}(),Conductor.prototype.clearIfStack=function(){this.ifStack=[]},Conductor.prototype.clearStack=function(){this.stack.forEach(function(e){e.exitScope()}),this.stack=[]},Conductor.prototype.reset=function(){this.queue.splice(0,this.queue.length),this.status=Conductor.STATUS_STOP,this.callStack=[],this.macros={},this.clearMacroStack(),this.clearIfStack(),this.clearStack()},Conductor.prototype.wait=function(e,t){this.status=Conductor.STATUS_WAIT,e instanceof Tag&&(e=e.tagName),e in this.waitTag||(this.waitTag[e]=[]),t&&this.waitTag[e].push(t)},Conductor.prototype.trigger=function(e){if(this.status!==Conductor.STATUS_PREPARE_TAG||0!=Object.keys(this.waitTag).length){var t=[],r=!1;e instanceof Tag&&(e=e.tagName),e in this.waitTag?(r=!0,t=t.concat(this.waitTag[e])):"click"==e&&0==Object.keys(this.waitTag).length&&this.status!=Conductor.STATUS_STOP&&(r=!0),r&&this.waitTag["*"]&&(t=t.concat(this.waitTag["*"]));for(var i=0;i<t.length;i++)t[i]();return r?(this.oneShot(),!0):!1}};var trigger=function(){return currentConductor.trigger.apply(currentConductor,arguments)},wait=function(){return currentConductor.wait.apply(currentConductor,arguments)};MacroDefinition=function(e){e&&(this.name=e.name,this.startTag=e.startTag,this.endTag=e.endTag)};var Macro=function(e){e&&(this.definition=e.definition,this.returnTag=e.returnTag,this.args=e.args)};Macro.prototype.initializer="Macro";var SubRoutineConductor=function(){Conductor.call(this),Object.defineProperty(this,"macros",{get:function(){return conductor.macros}})};SubRoutineConductor.prototype=Object.create(Conductor.prototype),SubRoutineConductor.prototype.getTagAction=function(e){return SubRoutineConductor.tagActions=SubRoutineConductor.tagActions||{"return":new TagAction({rules:Tag.actions["return"].rules,action:function(e){if(0==this.conductor.callStack.length){if(currentConductor=conductor,o2.skipMode=o2.SKIP_MODE_NONE,e.storage||e.target){var t=new Tag("jump",e);currentConductor.queue.push(t)}return 2}return Tag.actions["return"].action.call(this,e)}}),label:new TagAction({action:function(e){return config.saveMode==o2.SAVE_MODE_KAG3&&e.caption?(this.error("サブルーチン内にセーブ可能なラベルを置くことはできません"),0):Tag.actions.label.action.call(this,e)}}),o2_savestat:new TagAction({action:function(e){return config.saveMode==o2.SAVE_MODE_O2KAG&&this.error("サブルーチン内にo2_savestatタグを置くことはできません"),0}})},SubRoutineConductor.tagActions[e]||Conductor.prototype.getTagAction.apply(this,arguments)};var KAGFiles,KAGFile,PartialFile;!function(){function e(){var e=[conductor,extraConductor];return e=e.concat(o2.foreLayers.baseLayer.animationConductors,o2.backLayers.baseLayer.animationConductors),e=[].concat.apply(e,o2.foreLayers.imageLayers.map(function(e){return e.animationConductors})),e=[].concat.apply(e,o2.backLayers.imageLayers.map(function(e){return e.animationConductors})),o2.glyphLayer.animationConductors[0]instanceof AnimationConductor&&e.push(o2.glyphLayer.animationConductors[0]),e}var t={},r=[],i=1/0,n={};KAGFiles=function(e,i){if(e=e.toLowerCase(),void 0==i){if(e in t){var o=t[e];return o.recentlyUsed(),o}if(e in n)return $.get(n[e],null,null,"json").then(function(t){var r=KAGFile.create(e,t);return r});throw e+"というファイルが見つからない"}return r.push(e),t[e]=i,KAGFiles.ensureFileLimit(),i},KAGFiles.setupManifest=function(e){i=config.numScriptCache;for(var t in e)n[t.toLowerCase()]=e[t].toLowerCase()},KAGFiles.ensureFileLimit=function(){if(!(r.length<=i))for(var n=e().filter(function(e){return void 0!=e}).map(function(e){return e.file}),o=0;o<r.length&&r.length>i;){var a=r[o];-1==n.indexOf(t[a])?(r.splice(o,1),delete t[a]):o++}},KAGFile=function(e,t){this.filename=e.toLowerCase(),this.lines=[],this.labels=[],t||KAGFiles(e,this);var r=this;this.lines.push=function(e){return e.file=r,e.lineNumber=this.length,"label"==e.tagName&&r.labels.push(e),Array.prototype.push.apply(this,arguments)}},KAGFile.create=function(e,t){for(var r=new KAGFile(e),i=0;i<t.length;i++){var n=t[i],o=new Tag(n[o2.config.scriptTagNameKey],n[o2.config.scriptTagArgsKey],n[o2.config.scriptTagCallbackArgsKey]);r.lines.push(o),"undefined"!=typeof n[o2.config.scriptTagLineKey]&&(o.originalLineNumber=n[o2.config.scriptTagLineKey]),"undefined"!=typeof n[o2.config.scriptTagCharKey]&&(o.originalCharNumber=n[o2.config.scriptTagCharKey])}return r},KAGFile.prototype.recentlyUsed=function(){var e=r.indexOf(this.filename);-1!=e&&r.splice(e,1),r.push(this.filename),KAGFiles.ensureFileLimit()},KAGFile.prototype.clone=function(){return this},KAGFile.prototype.line=function(e){return this.lines[e]},KAGFile.prototype.getLabelTag=function(e){for(var t=0;t<this.labels.length;t++)if(this.labels[t].args.name==e)return this.labels[t];return null},KAGFile.prototype.basename=function(){var e=this.filename.split(".");return e.pop(),e.join(".")},KAGFile.prototype.toRestorable=function(){return{filename:this.filename,initializer:"KAGFile"}},KAGFile.restore=function(e){return KAGFiles(e.filename)},PartialFile=function(e,t,r){this.originalFile=e,this.filename=e.filename+"(virtual:"+t+"~"+r+")",this.start=t,this.end=r;var i=this;this.lines=e.lines.slice(t,r+1).map(function(e,t){var r=Object.create(e);return r.file=i,r.lineNumber=t,r})},PartialFile.prototype=Object.create(KAGFile.prototype),PartialFile.prototype.getLabelTag=function(e){return this.originalFile.getLabelTag(e)},PartialFile.prototype.toRestorable=function(){return{originalFile:this.originalFile.toRestorable(),start:this.start,end:this.end,initializer:"PartialFile"}},PartialFile.restore=function(e){return $.when(e.originalFile.restore()).then(function(t){return new PartialFile(t,e.start,e.end)})}}();var Rect=function(){if(4==arguments.length)return new Rect({x:arguments[0],y:arguments[1],width:arguments[2],height:arguments[3]});if(1==arguments.length&&"object"==typeof arguments[0]){for(var e in arguments[0])if(this[e]=arguments[0][e],isNaN(this[e]))throw e+"はnumberじゃないです"}else this.x=this.y=this.width=this.height=0};Rect.prototype.initializer="Rect",Rect.prototype.isEqual=function(e){return e.x==this.x&&e.y==this.y&&e.width==this.width&&e.height==this.height},Rect.prototype.isZero=function(){return this.isEqual(new Rect(0,0,0,0))},Rect.prototype.coverCoordinate=function(e,t){return e>=this.x&&e<this.x+this.width&&t>this.y&&t<this.y+this.height},Rect.prototype.extend=function(e){0!=this.width&&0!=this.height||$.extend(this,e);var t=Math.min(e.x,this.x),r=Math.min(e.y,this.y),i=Math.max(e.x+e.width,this.x+this.width);maxY=Math.max(e.y+e.height,this.y+this.height),this.x=t,this.y=r,this.width=i-t,this.height=maxY-r},Rect.prototype.intersect=function(e){if(e.x+e.width>this.x&&e.x<this.x+this.width&&e.y+e.height>this.y&&e.y<this.y+this.height){var t=Math.max(this.x,e.x),r=Math.max(this.y,e.y),i=Math.min(this.x+this.width,e.x+e.width),n=Math.min(this.y+this.height,e.y+e.height);return new Rect({x:t,y:r,width:i-t,height:n-r})}return!1},Rect.prototype.round=function(){this.x=~~(.5+this.x),this.y=~~(.5+this.y),this.width=~~(.5+this.width),this.height=~~(.5+this.height)};var Drawable=function(e){this.rect=clone(e)||new Rect,this.needRedraw=!0,this.partialDraw=!1};Drawable.prototype.initializer="Drawable",Drawable.prototype.objectToBeSerialized=function(e){switch(e){case"needRedraw":case"partialDraw":return}return this[e]},Drawable.prototype.importFrom=function(e){this.rect=clone(e.rect),this.transform=clone(e.transform)},Drawable.prototype.drawOnContext=function(e,t){},Drawable.prototype.frame=function(){return this.rect},Drawable.prototype.canDrawPartial=function(){return!1};var DrawableCanvas=function(e){Drawable.call(this,e),this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.setRect(),this.ctx.textBaseline="top"};DrawableCanvas.prototype=new Drawable,DrawableCanvas.prototype.initializer="DrawableCanvas",DrawableCanvas.prototype.objectToBeSerialized=function(e){switch(e){case"canvas":case"ctx":return}return this[e]},DrawableCanvas.prototype.importFromSaveData=function(){var e=this;return Drawable.prototype.importFromSaveData.apply(this,arguments).done(function(){e.setRect()})},DrawableCanvas.prototype.canDrawPartial=function(){return!0},DrawableCanvas.prototype.setRect=function(e){e&&(this.rect=e),this.canvas.width=this.rect.width,this.canvas.height=this.rect.height},DrawableCanvas.prototype.clone=function(){var e=new DrawableCanvas;return e.importFrom(this),e.canvas.width=this.rect.width,e.canvas.height=this.rect.height,e.ctx.drawImage(this.canvas,0,0),e},DrawableCanvas.prototype.drawOnContext=function(e,t){if(t){var r=t.intersect(this.rect);e.drawImage(this.canvas,r.x-this.rect.x,r.y-this.rect.y,r.width,r.height,r.x,r.y,r.width,r.height)}else e.drawImage(this.canvas,this.rect.x,this.rect.y,this.rect.width,this.rect.height)},DrawableSolidColor=function(e){Drawable.call(this,e),this.color="#000000",this.opacity=1},DrawableSolidColor.prototype=new Drawable,DrawableSolidColor.prototype.initializer="DrawableSolidColor",DrawableSolidColor.prototype.canDrawPartial=function(){return!0},DrawableSolidColor.prototype.drawOnContext=function(e,t){t=t?t.intersect(this.rect):this.rect,e.save(),e.globalAlpha=this.opacity,e.fillStyle=this.color,e.fillRect(t.x,t.y,t.width,t.height),e.restore()},DrawableSolidColor.prototype.importFrom=function(e){e instanceof DrawableSolidColor&&(this.color=e.color,this.opacity=e.opacity)};var DrawableImage=function(e,t,r){if(Drawable.call(this),null==e)throw"image needed";null==t&&(t=0),null==r&&(r=0),Drawable.call(this,new Rect(t,r,e.width,e.height)),this.image=e,this.cacheEnabled=!0,this.reuseCanvas=!1,this.cacheCanvas,this.options={}};DrawableImage.defaultOptions={grayscale:!1,rGamma:1,gGamma:1,bGamma:1,rFloor:0,gFloor:0,bFloor:0,rCeil:255,gCeil:255,bCeil:255,tintColor:"#ff0000",tintOpacity:0,shadow:"#000000",shadowOpacity:200,shadowX:10,shadowY:10,shadowBlur:3,clipLeft:void 0,clipTop:void 0,clipWidth:void 0,clipHeight:void 0,flipUD:!1,flipLR:!1,visible:!0,opacity:1,blurX:0,blurY:0,blurMode:"linear"},DrawableImage.prototype=new Drawable,DrawableImage.prototype.initializer="DrawableImage",DrawableImage.prototype.objectToBeSerialized=function(e){switch(e){case"options":var t={};for(var r in this.options)DrawableImage.defaultOptions.hasOwnProperty(r)&&this.options[r]==DrawableImage.defaultOptions[r]||(t[r]=this.options[r]);return t;case"image":if(this.image.originalURL)return this.image.originalURL;case"cacheCanvas":return}return this[e]},DrawableImage.restore=function(e){return $.when(ResourceLoader.loadImage(e.image,!0)).then(function(t){var r=new DrawableImage(t);return r.importFromSaveData(e).then(function(){return r})})},DrawableImage.prototype.importFromSaveData=function(e){var t=this;return $.when($.when(e.rect.restore()).then(function(e){t.rect=e}),$.when(e.options.restore()).then(function(e){t.options=e}))},DrawableImage.prototype.canDrawPartial=function(){return!0},DrawableImage.prototype.clone=function(){var e=new DrawableImage(this.image);return e.importFrom(this),this.cacheCanvas&&(e.cacheCanvas=document.createElement("canvas"),e.cacheCanvas.width=this.cacheCanvas.width,e.cacheCanvas.height=this.cacheCanvas.height,e.cacheCanvas.getContext("2d").drawImage(this.cacheCanvas,0,0)),e},DrawableImage.prototype.importFrom=function(e){this.options=clone(e.options),this.rect=clone(e.rect)},DrawableImage.prototype.drawOnContext=function(e,t){t||(t=this.rect);var r=0,i=0,n=this.rect.width,o=this.rect.height;this.options.clipLeft&&(r+=this.options.clipLeft,n-=this.options.clipLeft),this.options.clipTop&&(i+=this.options.clipTop,o-=this.options.clipTop),this.options.clipWidth&&(n=this.options.clipWidth),this.options.clipHeight&&(o=this.options.clipHeight);var a=t.intersect(new Rect({x:this.rect.x,y:this.rect.y,width:n,height:o}));if(a&&(a=a.intersect(new Rect({x:0,y:0,width:e.canvas.width,height:e.canvas.height})))){var s=this.image;if(!this.cacheCanvas||!this.cacheEnabled){for(var c,u,l=this,h=function(e){switch(e){case"canvas":return $(s).is("canvas")||(l.cacheCanvas||(l.cacheCanvas=document.createElement("canvas")),l.cacheCanvas.width=n,l.cacheCanvas.height=o,c=l.cacheCanvas.getContext("2d"),c.drawImage(s,r,i,n,o,0,0,n,o),r=0,i=0,s=l.cacheCanvas),u&&(c.putImageData(u,0,0),u=null),s;case"imageData":if(u)return u;var t=h("canvas");return u=t.getContext("2d").getImageData(0,0,s.width,s.height);default:o2.error("ソースタイプが間違ってます。")}},f=0;f<DrawableImage.effects.length;f++)DrawableImage.effects[f](h,this.options);u&&h("canvas")}e.save(),"opacity"in this.options&&(e.globalAlpha=this.options.opacity),e.drawImage(s,a.x-this.rect.x+r,a.y-this.rect.y+i,a.width,a.height,a.x,a.y,a.width,a.height),e.restore(),this.cacheEnabled&&this.reuseCanvas||(this.cacheCanvas=null)}},DrawableImage.effects=[function(e,t){if(t.flipLR){var r=e("canvas"),i=document.createElement("canvas");i.width=r.width,i.height=r.height;var n=i.getContext("2d");n.translate(r.width,0),n.scale(-1,1),n.drawImage(r,0,0);var o=r.getContext("2d");o.clearRect(0,0,r.width,r.height),o.drawImage(i,0,0)}},function(e,t){if(t.flipUD){var r=e("canvas"),i=document.createElement("canvas");i.width=r.width,i.height=r.height;var n=i.getContext("2d");n.translate(0,r.height),n.scale(1,-1),n.drawImage(r,0,0);var o=r.getContext("2d");o.clearRect(0,0,r.width,r.height),o.drawImage(i,0,0)}},function(e,t){if(t.grayscale){var r=e("imageData"),i=r.data,n=0;for(i.length;n<i.length;n+=4){var o=.34*i[n]+.5*i[n+1]+.16*i[n+2];i[n]=o,i[n+1]=o,i[n+2]=o}}},function(e,t){var r=t.rGamma;if("rGamma"in t&&1!=r){var i=e("imageData"),n=i.data;r=1/r;var o=0;for(n.length;o<n.length;o+=4)n[o]=255*Math.pow(n[o]/255,r)}},function(e,t){var r=t.gGamma;if("gGamma"in t&&1!=r){var i=e("imageData"),n=i.data;r=1/r;var o=0;for(n.length;o<n.length;o+=4)n[o+1]=255*Math.pow(n[o+1]/255,r)}},function(e,t){var r=t.bGamma;if("bGamma"in t&&1!=r){var i=e("imageData"),n=i.data;r=1/r;var o=0;for(n.length;o<n.length;o+=4)n[o+2]=255*Math.pow(n[o+2]/255,r)}},function(e,t){if("rFloor"in t||"rCeil"in t){var r="rFloor"in t?t.rFloor:0,i="rCeil"in t?t.rCeil:255,n=i-r;if(0!==r||255!==i){var o=e("imageData").data,a=0;for(o.length;a<o.length;a+=4)o[a]=o[a]/255*n+r}}},function(e,t){if("gFloor"in t||"gCeil"in t){var r="gFloor"in t?t.gFloor:0,i="gCeil"in t?t.gCeil:255,n=i-r;if(0!==r||255!==i){var o=e("imageData").data,a=0;for(o.length;a<o.length;a+=4)o[a+1]=o[a+1]/255*n+r}}},function(e,t){if("bFloor"in t||"bCeil"in t){var r="bFloor"in t?t.bFloor:0,i="gCeil"in t?t.bCeil:255,n=i-r;if(0!==r||255!==i){var o=e("imageData").data,a=0;for(o.length;a<o.length;a+=4)o[a+2]=o[a+2]/255*n+r}}},function(e,t){if(t.tintColor&&t.tintOpacity){var r=e("canvas"),i=r.getContext("2d");i.save(),i.globalAlpha=t.tintOpacity,i.globalCompositeOperation="source-atop",i.fillStyle=t.tintColor,i.fillRect(0,0,r.width,r.height),i.restore()}},function(e,t){if(t.blurX||t.blurY){var r=e("canvas"),i=r.getContext("2d"),n=document.createElement("canvas"),o=n.getContext("2d");n.width=r.width,n.height=r.height;var a=(t.blurX||0)+1,s=(t.blurY||0)+1;if("linear"==t.blurMode){for(var c=0;a>c;c++){o.globalAlpha=1-c/a;var u=(a-c)/2*(c%2?-1:1);o.drawImage(r,u,0)}i.save(),i.clearRect(0,0,r.width,r.height);for(var c=0;s>c;c++){i.globalAlpha=1-c/s;var u=(s-c)/2*(c%2?-1:1);i.drawImage(n,0,u)}i.restore()}else{for(var l=i.getImageData(0,0,r.width,r.height),h=0,f=255,d=l.data,c=d.length-1;c>0;)h<d[c]&&(h=d[c]),f>d[c]&&(f=d[c]),c-=4;d=l=null,o.globalAlpha=1/a;for(var c=0;a>c;c++)o.drawImage(r,c-a/2,0);i.save(),i.clearRect(0,0,r.width,r.height),i.globalAlpha=1/s;for(var c=0;s>c;c++)i.drawImage(n,0,c-s/2);i.restore();for(var p=i.getImageData(0,0,r.width,r.height),g=p.data,y=0,m=255,c=g.length-1;c>0;)y<g[c]&&(y=g[c]),m>g[c]&&(m=g[c]),c-=4;for(var v=h-f,w=y-m,c=g.length-1;c>0;){var T=g[c],b=(T-m)/w,L=f+v*b;g[c]=L,c-=4}i.putImageData(p,0,0)}}}];var Renderer=function(){this.animator=new Animator(this),this.foreLayers=[],this.backLayers=[],this.foreCanvas=document.createElement("canvas"),this.foreCtx=this.foreCanvas.getContext("2d"),this.backCanvas=document.createElement("canvas"),this.backCtx=this.backCanvas.getContext("2d"),this.xShift=0,this.yShift=0,this.foreCanvas.width=this.backCanvas.width=config.scWidth,this.foreCanvas.height=this.backCanvas.height=config.scHeight,this.renderBackCanvas=!1,this.transForeCanvas,this.transBackCanvas,this.transCanvas};Renderer.prototype={render:function(){this.foreCtx.clearRect(0,0,this.foreCanvas.width,this.foreCanvas.height),this.renderBackCanvas&&this.backCtx.clearRect(0,0,this.backCanvas.width,this.backCanvas.height),this.foreCtx.save(),this.foreCtx.translate(this.xShift,this.yShift);for(var e=!1,t=0;t<this.foreLayers.length;t++){var r=this.foreLayers[t],i=r.getCorrespondingLayer();if(r.flush(),i.flush(),r.transTag){this.transForeCanvas||(this.transForeCanvas=document.createElement("canvas"),this.transBackCanvas=document.createElement("canvas"),this.transCanvas=document.createElement("canvas"),this.transForeCanvas.width=this.transBackCanvas.width=this.transCanvas.width=this.foreCanvas.width,this.transForeCanvas.height=this.transBackCanvas.height=this.transCanvas.height=this.foreCanvas.height);var n=this.transForeCanvas.getContext("2d"),o=this.transBackCanvas.getContext("2d");n.clearRect(0,0,this.transForeCanvas.width,this.transForeCanvas.height),o.clearRect(0,0,this.transBackCanvas.width,this.transBackCanvas.height),o.drawImage(this.foreCanvas,0,0),i.drawOnContext(o),n.drawImage(this.foreCanvas,0,0),r.drawOnContext(n),r.transTag.method.transit.call(r.transTag,r.transTag.transArgs,this.transForeCanvas,this.transBackCanvas,this.transCanvas),this.foreCtx.drawImage(this.transCanvas,0,0,this.transCanvas.width,this.transCanvas.height)}else r.drawOnContext(this.foreCtx),this.renderBackCanvas&&(e=!0,i.drawOnContext(this.backCtx))}o2.historyLayer.visible&&(o2.historyLayer.flush(),o2.historyLayer.drawOnContext(this.foreCtx)),this.foreCtx.restore(),$(this.foreCanvas).trigger("draw"),e&&$(this.backCanvas).trigger("draw")}},Renderer.showLoadingSign=function(){$("#loading").show()},Renderer.hideLoadingSign=function(){$("#loading").hide()},Renderer.showServerError=function(e){$("#error").show(),$("#retryButton").one("click",function(){Renderer.hideServerError(),e()})},Renderer.hideServerError=function(){$("#error").hide()},Renderer.askForLogin=function(){var e=$.Deferred();return o2.serverStat.mode!=o2.SERVER_MODE_O2SERVER?e.resolve():-1!=o2.serverStat.uid?e.resolve():($("#login-box iframe").one("load",function(){$("#login-box").fadeIn()}).attr("src",o2.serverStat.userServer+"/auth/login_box"),$(window).one("message",function(t){var r=t.originalEvent;"login/cancel"==r.data?(Renderer.closeLoginBox(),e.reject()):"login/success"==r.data&&(Renderer.closeLoginBox(),$.getScript(o2.serverStat.userServer+"/js?id="+config.gameID).then(function(){return loadSystemStateFromServer()}).then(function(){saveCurrentSystemState(),$(o2).trigger("loginbox.loggedin")}).done(function(){e.resolve()}).fail(function(){e.reject()}))}),e.promise())},Renderer.closeLoginBox=function(){$("#login-box").fadeOut("fast",function(){$("#login-box iframe").attr("src","")}),scaleToFitPage()};var Animator=function(e){this.renderer=e,this.animationRequests=[],this.nextCallTimestamp=void 0,this.timeoutId=void 0,this.animationRequestId=void 0};Animator.prototype={requestFrame:function(e,t){void 0==t&&(t=0),e||(e=function(){});var r=Date.now(),i=r+t;!this.isPaused&&(i<this.nextCallTimestamp||void 0==this.nextCallTimestamp)&&(clearTimeout(this.timeoutId),cancelAnimationFrame(this.animationRequestId),t>0?this.timeoutId=setTimeout(this.animationLoopCalled.bind(this),t):this.animationRequestId=requestAnimationFrame(this.animationLoopCalled.bind(this)),this.nextCallTimestamp=i),this.animationRequests.push({callback:e,begin:i})},animationLoopCalled:function(){window.meter&&window.meter.tickStart(),this.nextCallTimestamp=void 0,this.timeoutId=void 0,this.animationRequestId=void 0;var e=this.animationRequests;this.animationRequests=[];for(var t=[],r=0;r<e.length;r++){var i=e[r],n=i.begin-Date.now();n>0?t.push(i):"function"==typeof i.callback&&i.callback()}for(var r=0;r<t.length;r++){var i=t[r],n=i.begin-Date.now();
this.requestFrame(i.callback,n)}this.renderer.render(),window.meter&&window.meter.tick()},isPaused:!1,pause:function(){this.isPaused||(this.isPaused=!0,void 0!==this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=void 0),void 0!==this.animationRequestId&&(cancelAnimationFrame(this.animationRequestId),this.animationRequestId=void 0),this.nextCallTimestamp=void 0)},resume:function(){this.isPaused&&(this.isPaused=!1,this.animationRequests.length&&this.requestFrame())}},Layer=function(e){Drawable.call(this,e),this.rect.width||(this.rect.width=config.scWidth),this.rect.height||(this.rect.height=config.scHeight),Object.defineProperty(this,"canvas",{get:function(){return this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.width=this.rect.width,this._canvas.height=this.rect.height),this._canvas}}),Object.defineProperty(this,"ctx",{get:function(){return this.canvas.getContext("2d")}}),this.stackedClearRect=new Rect,this.requestedFrame=!1,this.visible=!0,this.opacity=1,this.rotation=0,this.scaleX=1,this.scaleY=1,this.transformOrigin={x:0,y:0},this.cachedTransform={},this.index=0,this.userInteractionEnabled=!0,this.transTag=void 0,this.moveTag=void 0},Layer.prototype=new Drawable,Layer.prototype.initializer="Layer",Layer.prototype.objectToBeSerialized=function(e){switch(e){case"canvas":case"_canvas":case"ctx":case"cachedTransform":case"transTag":case"moveTag":case"stackedClearRect":case"requestedFrame":case"needRedraw":case"partialDraw":return}return this[e]},Layer.prototype.importFromSaveData=function(e){var t=this;return e.scale&&(this.scaleX=this.scaleY=e.scale,delete e.scale),this.stopTransition(),Drawable.prototype.importFromSaveData.call(this,e).done(function(){t.setRect()})},Layer.prototype.importFrom=function(e){this.rect=clone(e.rect),this.visible=e.visible,this.opacity=e.opacity,this.canvas.width=e.canvas.width,this.canvas.height=e.canvas.height,this.redrawRect(),this.transTag=void 0,this.rotation=e.rotation,this.scaleX=e.scaleX,this.scaleY=e.scaleY,this.transformOrigin=clone(e.transformOrigin),this.cachedTransform={},this.index=e.index},Layer.prototype.destroy=function(){this._canvas=null},Layer.prototype.getCorrespondingLayer=function(){var e=o2.allForeLayers().indexOf(this);return-1!=e?o2.allBackLayers()[e]:(e=o2.allBackLayers().indexOf(this),-1!=e?o2.allForeLayers()[e]:void 0)},Layer.prototype.setRect=function(e){e&&(e.width&&e.height||o2.error("width/heightは0です"),this.rect=e),this.canvas.width=this.rect.width,this.canvas.height=this.rect.height},Layer.prototype.transformMatrix=function(){if(this.cachedTransform.x==this.rect.x&&this.cachedTransform.y==this.rect.y&&this.cachedTransform.rotation==this.rotation&&this.cachedTransform.scaleX==this.scaleX&&this.cachedTransform.scaleY==this.scaleY&&this.cachedTransform.originX==this.transformOrigin.x&&this.cachedTransform.originY==this.transformOrigin.y&&void 0!=this.cachedTransform.matrix)return this.cachedTransform.matrix;var e=[[1,0,0],[0,1,0],[0,0,1]];return e=multiplyMatrix(e,[[1,0,this.rect.x+this.transformOrigin.x],[0,1,this.rect.y+this.transformOrigin.y],[0,0,1]]),0!=this.rotation&&(e=multiplyMatrix(e,[[Math.cos(this.rotation),Math.sin(this.rotation),0],[-Math.sin(this.rotation),Math.cos(this.rotation),0],[0,0,1]])),1==this.scaleX&&1==this.scaleY||(e=multiplyMatrix(e,[[this.scaleX,0,0],[0,this.scaleY,0],[0,0,1]])),this.cachedTransform.x=this.rect.x,this.cachedTransform.y=this.rect.y,this.cachedTransform.rotation=this.rotation,this.cachedTransform.scaleX=this.scaleX,this.cachedTransform.scaleY=this.scaleY,this.cachedTransform.originX=this.transformOrigin.x,this.cachedTransform.originY=this.transformOrigin.y,this.cachedTransform.matrix=e,this.cachedTransform.inverted=void 0,e},Layer.prototype.localLocation=function(e,t){var r=this.cachedTransform.inverted;if(!r){var i=this.transformMatrix(),n=[[i[0][0],i[0][1]],[i[1][0],i[1][1]]],o=n[0][0]*n[1][1]-n[0][1]*n[1][0],a=[[n[1][1]/o,n[0][1]/-o],[n[1][0]/-o,n[0][0]/o]],s=multiplyMatrix(a,[[i[0][2]],[i[1][2]]]),s=[[-s[0][0]],[-s[1][0]]],r=[[a[0][0],a[0][1],s[0][0]],[a[1][0],a[1][1],s[1][0]],[0,0,1]];this.cachedTransform.inverted=r}var c=multiplyMatrix(r,[[e],[t],[1]]);return{x:c[0][0]+this.transformOrigin.x,y:c[1][0]+this.transformOrigin.y}},Layer.prototype.transit=function(e){this.transTag=e,"function"==typeof e.method.prepare&&e.method.prepare.call(e,e.transArgs)},Layer.prototype.isTransiting=function(){return void 0!=this.transTag},Layer.prototype.stopTransition=function(){this.transTag&&(this.transTag.end=!0,this.transTag.method.teardown.call(this.transTag),this.importFrom(this.transTag.transArgs.layer.back),this.transTag=void 0)},Layer.prototype.drawOnContext=function(e){if(this.visible){e.save();var t=this.transformMatrix();e.transform(t[0][0],t[1][0],t[0][1],t[1][1],t[0][2],t[1][2]),e.globalAlpha=this.opacity,e.drawImage(this.canvas,-this.transformOrigin.x,-this.transformOrigin.y,this.rect.width,this.rect.height),e.restore()}},Layer.prototype.children=function(){return[]},Layer.prototype.mousedown=function(){return!!this.userInteractionEnabled},Layer.prototype.mousemove=function(){return!!this.userInteractionEnabled},Layer.prototype.mouseup=function(){return!!this.userInteractionEnabled},Layer.prototype.draw=function(e){e.needRedraw=!0,this.requestedFrame||(renderer.animator.requestFrame(),this.requestedFrame=!0)},Layer.prototype.redrawRect=function(e){e||(e=new Rect(0,0,this.rect.width,this.rect.height)),this.stackedClearRect.extend(e),this.requestedFrame||(renderer.animator.requestFrame(),this.requestedFrame=!0)},Layer.prototype.flush=function(){clone(this.stackedClearRect);if(!this.requestedFrame)return!1;for(var e=this.children();;){for(var t=!1,r=e.length-1;r>=0;r--){var i=e[r];i.needRedraw||i.frame().intersect(this.stackedClearRect)&&(i.canDrawPartial()?i.partialDraw=!0:this.stackedClearRect.extend(i.frame()),i.needRedraw=!0,t=!0)}if(!t)break}this.stackedClearRect.round(),this.ctx.clearRect(this.stackedClearRect.x,this.stackedClearRect.y,this.stackedClearRect.width,this.stackedClearRect.height);for(var n=this.stackedClearRect.isZero(),r=0;r<e.length;r++){var i=e[r];i.needRedraw&&(!n&&i.partialDraw?i.drawOnContext(this.ctx,this.stackedClearRect):i.drawOnContext(this.ctx),i.needRedraw=!1,i.partialDraw=!1)}return this.stackedClearRect=new Rect,this.requestedFrame=!1,!0};var ImageLayer=function(){Layer.call(this),this.images=[],this.animationConductors=[],this.animationChildren=[]};ImageLayer.prototype=Object.create(Layer.prototype),ImageLayer.prototype.initializer="ImageLayer",ImageLayer.prototype.children=function(){return this.images.concat(this.animationChildren)},ImageLayer.prototype.importFrom=function(e){Layer.prototype.importFrom.apply(this,arguments),this.clearImage(),this.images=clone(e.images),this.clearAnimationConductors();for(var t in e.animationConductors){var r=clone(e.animationConductors[t]);this.addAnimationConductor(r,t)}},ImageLayer.prototype.objectToBeSerialized=function(e){return"animationConductors"==e&&!this.animationConductors.length||"animationChildren"==e?void 0:Layer.prototype.objectToBeSerialized.apply(this,arguments)},ImageLayer.prototype.importFromSaveData=function(e){this.images=[],this.animationConductors.forEach(function(e){e.stop()}),this.animationConductors=[];for(var t=this,r=[],i=0;i<e.images.length;i++){var n=e.images[i];!function(e){r.push($.when(n.restore()).done(function(r){t.images[e]=r}))}(i)}return delete e.images,$.when.apply($,r).then(function(){o2.log("イメージのロードを完了しました")}).then(function(){var r=[];if(t.clearAnimationConductors(),"animationConductors"in e)for(var i=0;i<e.animationConductors.length;i++){var n=e.animationConductors[i];null!==n&&!function(e,i){r.push($.when(i.restore()).done(function(r){t.addAnimationConductor(r,e),r.run()}))}(i,n)}return delete e.animationConductors,$.when.apply($,r)}).then(function(){return Layer.prototype.importFromSaveData.call(t,e)}).then(function(){return t.redrawRect(),t})},ImageLayer.prototype.loadImage=function(e,t,r){var i=this;return t=t||{},ResourceLoader.loadImage(e,!r).then(function(e){i.clearImage(),i.clearAnimationConductors();var r=new DrawableImage(e,0,0);return r.options=t,i.addImage(r),i.rect.width=r.rect.width,i.rect.height=r.rect.height,i.setRect(),r})},ImageLayer.prototype.addImage=function(e){this.images.push(e),this.draw(e)},ImageLayer.prototype.clearImage=function(){for(var e=0;e<this.images.length;e++)this.redrawRect(this.images[e].rect);this.images=[]},ImageLayer.prototype.getImageRect=function(e){var t=void 0;return"number"==typeof e?t=this.images[e]:"string"==typeof e?t=this.images.filter(function(t){return t.image.originalURL==e})[0]:"function"==typeof e&&(t=this.images.filter(e)[0]),t?t.rect:void 0},ImageLayer.prototype.addAnimationConductor=function(e,t){t in this.animationConductors||(e.layer=this,this.animationConductors[t]=e)},ImageLayer.prototype.clearAnimationConductors=function(){this.animationConductors.forEach(function(e){e.stop()}),this.animationConductors=[]};var BaseLayer=function(){ImageLayer.call(this),this.backgroundSolid=new DrawableSolidColor,this.backgroundSolid.rect=new Rect(0,0,this.rect.width,this.rect.height),this.backgroundSolid.color=config.backgroundColor};BaseLayer.prototype=Object.create(ImageLayer.prototype),BaseLayer.prototype.initializer="BaseLayer",BaseLayer.prototype.children=function(){return[this.backgroundSolid].concat(this.images,this.animationChildren)};var GlyphLayer=function(){ImageLayer.call(this),this.triedLoadCurrentAnimationFile=!1,this.parentLayer=void 0};GlyphLayer.prototype=Object.create(ImageLayer.prototype),GlyphLayer.prototype.initializer="GlyphLayer",GlyphLayer.prototype.objectToBeSerialized=function(e){switch(e){case"parentLayer":case"triedLoadCurrentAnimationFile":return}return ImageLayer.prototype.objectToBeSerialized.apply(this,arguments)},GlyphLayer.prototype.importFromSaveData=function(){return ImageLayer.prototype.importFromSaveData.apply(this,arguments)},GlyphLayer.prototype.redrawRect=function(){this.requestedFrame=!0,this.parentLayer&&this.parentLayer.redrawRect(this.rect),ImageLayer.prototype.redrawRect.apply(this,arguments)},GlyphLayer.prototype.draw=function(){this.requestedFrame=!0,this.parentLayer&&this.parentLayer.redrawRect(this.rect),ImageLayer.prototype.draw.apply(this,arguments)},GlyphLayer.prototype.drawOnContext=function(){this.flush(),ImageLayer.prototype.drawOnContext.apply(this,arguments)},GlyphLayer.prototype.showOnLayer=function(e,t){var r=this,i=t+".asd";return this.parentLayer=e,$.when(function(){return r.images.length&&r.images[0].image.originalURL===t?void 0:(r.triedLoadCurrentAnimationFile=!1,r.loadImage(t))}()).then(function(){if(r.animationConductors.length&&r.animationConductors[0].file.filename==i)return r.visible=!0,r.animationConductors[0].status==Conductor.STATUS_STOP&&r.animationConductors[0].oneShot(),"loaded";if(!r.triedLoadCurrentAnimationFile){var e;try{e=KAGFiles(i)}catch(t){}return e}}).then(function(e){if("loaded"!==e){if(r.triedLoadCurrentAnimationFile=!0,!e)return void o2.warn(i+"が見つからないです。");var t=new AnimationConductor({file:e});r.addAnimationConductor(t,0),t.run(),r.visible=!0}})},GlyphLayer.prototype.hide=function(){this.visible&&(this.visible=!1,this.redrawRect(),this.animationConductors.length&&this.animationConductors[0].status!==Conductor.STATUS_STOP&&(this.animationConductors[0].status=Conductor.STATUS_STOP,this.animationConductors[0].queue.push(new Tag("s"))))},TextProperties=function(e){Drawable.call(this),this.text=e,this.rubyText,this.styles={opacity:1,size:20,face:"Arial",visible:!1,shadowBlur:5,vertical:void 0,shadowOffsetX:0,shadowOffsetY:0},this.useCanvasCache=!1,this.canvas},TextProperties.prototype=new Drawable,TextProperties.prototype.initializer="TextProperties",TextProperties.prototype.importFrom=function(e){Drawable.prototype.importFrom.call(this,e),this.text=e.text,this.rubyText=e.rubyText,this.styles=clone(e.styles),this.useCanvasCache=e.useCanvasCache},TextProperties.prototype.objectToBeSerialized=function(e){switch(e){case"canvas":return}return this[e]},TextProperties.prototype.drawOnContext=function(e){if(this.styles.visible&&0!=this.styles.opacity){if(this.useCanvasCache){var t=this.frame();if(!this.canvas){this.canvas=document.createElement("canvas"),this.canvas.width=t.width,this.canvas.height=t.height;var r=this.canvas.getContext("2d");r.textBaseline="top";var i=this.rect.x-t.x,n=this.rect.y-t.y;this.useCanvasCache=!1;var o=this.rect,a=this.styles.opacity;this.styles.opacity=1,this.rect=new Rect(i,n,this.rect.width,this.rect.height),this.drawOnContext(r),this.rect=o,this.styles.opacity=a,this.useCanvasCache=!0}return e.save(),e.globalAlpha=this.styles.opacity,e.drawImage(this.canvas,t.x,t.y,this.canvas.width,this.canvas.height),void e.restore()}e.save();var s=this.styles.color;if(e.fillStyle!=s&&(e.fillStyle=s),this.styles.shadow?(e.shadowColor=this.styles.shadowColor,e.shadowBlur=this.styles.shadowBlur,e.shadowOffsetX=this.styles.shadowOffsetX,e.shadowOffsetY=this.styles.shadowOffsetY):e.shadowBlur=0,e.globalAlpha!=this.styles.opacity&&(e.globalAlpha=this.styles.opacity),this.styles.vertical)this.fillTextVertical(e);else{var c;if(this.rubyText){c=this.rubyFont(),e.font!=c&&(e.font=c);var u=this.measureRuby(e),l=(this.rect.width-u.width)/2;this.styles.edge&&(e.lineJoin="round",e.lineWidth=this.styles.size/5,e.strokeStyle=this.styles.edgeColor,e.strokeText(this.rubyText,this.rect.x+l,this.rect.y-u.height-this.styles.rubyOffset)),e.fillText(this.rubyText,this.rect.x+l,this.rect.y-u.height-this.styles.rubyOffset)}c=this.font(),e.font!=c&&(e.font=c),this.styles.edge&&(e.lineJoin="round",e.lineWidth=this.styles.size/5,e.strokeStyle=this.styles.edgeColor,e.strokeText(this.text,this.rect.x,this.rect.y)),browser.isFirefox&&e.translate(0,.2*this.styles.size),e.fillText(this.text,this.rect.x,this.rect.y)}e.restore()}},TextProperties.prototype.clearCache=function(){this.canvas&&($(this.canvas).remove(),this.canvas=void 0)},TextProperties.prototype.frame=function(){var e=0;this.styles.edge&&(e+=.2*this.styles.size);var t=new Rect({x:this.rect.x-e,y:this.rect.y-e,width:this.rect.width+2*e,height:this.rect.height+2*e});if(t.y-=.1*this.styles.size,t.height+=.2*this.styles.size,this.styles.shadow){var r=new Rect({x:t.x-this.styles.shadowBlur,y:t.y-this.styles.shadowBlur,width:t.width+2*this.styles.shadowBlur,height:t.height+2*this.styles.shadowBlur});r.x+=this.styles.shadowOffsetX,r.y+=this.styles.shadowOffsetY,t.extend(r)}if((browser.isIOs||browser.isAndroid)&&(t.height+=5),this.rubyText){var i,n=this.measureRuby();if(this.styles.vertical){var o=(this.rect.height-n.height)/2;i=new Rect({x:this.rect.x+this.rect.width+this.styles.rubyOffset,y:this.rect.y+o-10,width:n.width,height:n.height+10})}else{var a=(this.rect.width-n.width)/2;i=new Rect({x:this.rect.x+a,y:this.rect.y-this.styles.rubySize+this.styles.rubyOffset-10,width:n.width,height:n.height+10})}this.styles.edge&&(i.x-=.1*n.width,i.y-=.1*n.height,i.width+=.2*n.width,i.height+=.2*n.height),t.extend(i)}return this.styles.italic&&(t.width+=10),t},TextProperties.prototype.font=function(){var e="";return this.styles.italic&&(e+="italic "),this.styles.bold&&(e+="bold "),e+=this.styles.size+"px ",e+=this.styles.face,e+=" , Arial"},TextProperties.prototype.rubyFont=function(){return this.styles.rubySize+"px "+this.styles.face},TextProperties.prototype.measure=function(e){e.save();var t=this.font();if(e.font!=t&&(e.font=t),this.styles.vertical)r=this.measureVertical(e,this.text);else{var r=e.measureText(this.text);r.height=this.styles.size}return e.restore(),r},TextProperties.prototype.measureRuby=function(e){e||(e=o2.currentMessageLayer.ctx),e.save();var t=this.rubyFont();if(this.font!=t&&(e.font=t),this.styles.vertical)r=this.measureVertical(e,this.rubyText,this.styles.rubySize);else{var r=e.measureText(this.rubyText);r.height=this.styles.rubySize}return e.restore(),r},function(){function e(e,t,r,i,n){var o=r*Math.PI/180,a=Math.cos(o),s=Math.sin(o);return[[e*a,t*s],[-e*s,t*a],[e*(a*i-s*n),t*(s*i+a*n)]]}function t(e,t){e.setTransform(t[0][0],t[0][1],t[1][0],t[1][1],t[2][0],t[2][1])}function r(t,r,i,n,o){switch(t){case"rotate90":return e(1,1,90,-r+i+o,-r-i);case"reflect45":return e(1,-1,270,-r+i+n,r-i-o);case"offsetTopRight":return e(1,1,0,.625*n,-.625*o);case"offsetRight":return e(1,1,0,.125*n,-.125*o);default:return[[1,0],[0,1],[0,0]]}}function i(e,i,u,l,h){var f=e.measureText(i),h=h||this.styles.size,d=this.styles.size;i in n&&(i=n[i]);var p="";return-1!=o.indexOf(i)?p="offsetTopRight":-1!=a.indexOf(i)?p="offsetRight":-1!=s.indexOf(i)?(u+=d,l-=h,p="rotate90"):-1!=c.indexOf(i)&&(u+=d,l-=h,p="reflect45"),e.save(),t(e,r(p,u,l,f.width,h)),this.styles.edge&&(e.lineJoin="round",e.lineWidth=f/5,e.strokeStyle=this.styles.edgeColor,e.strokeText(i,u,l)),e.fillText(i,u,l),e.restore(),"rotate90"==p?f.width:h}var n={"《":"︽","》":"︾","(":"︵","（":"︵",")":"︶","）":"︶","{":"︷","｛":"︷","}":"︸","｝":"︸","【":"︻","】":"︼","＜":"︿","<":"︿","＞":"﹀",">":"﹀","「":"﹁","」":"﹂","『":"﹃","』":"﹄","〔":"︹","〕":"︺"},o=["、","。","．"],a="ぁぃぅぇぉっゃゅょゎヵヶ",s="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ;:.s~〜…s＇─│┌┐┘└├┬┤┴┼━┃┏┓┛┗┣┳┫┻╋┠┯┨┷┿┝┰┥┸╂".split(""),c=["ー","―","～"];TextProperties.prototype.measureVertical=function(e,t,r){for(var i=t.split(""),n=0,o=0,a=0;a<i.length;a++){var c=i[a],u={width:e.measureText(c).width,height:r||this.styles.size};if(-1!=s.indexOf(c)){var l=u.height;u.height=u.width,u.width=l}o+=u.height,n<u.width&&(n=u.width)}return{width:n,height:o}},TextProperties.prototype.fillTextVertical=function(e){var t=this.text.split(""),r=this.rect.y,n=this.font();e.font!=n&&(e.font=n),e.save();for(var o=0;o<t.length;o++){var a=t[o];r+=i.call(this,e,a,this.rect.x,r)}if(e.restore(),this.rubyText){n=this.rubyFont(),e.font!=n&&(e.font=n);for(var s=this.measureRuby(e),c=(this.rect.height-s.height)/2,u=this.rubyText.split(""),r=this.rect.y+c,o=0;o<u.length;o++){var a=u[o];r+=i.call(this,e,a,this.rect.x+this.rect.width+this.styles.rubyOffset,r,this.styles.rubySize)}}}}(),TextProperties.prototype.calculateSize=function(e){var t=this.measure(e);return this.rect.width=t.width,this.rect.height=t.height,t},TextProperties.prototype.isEqual=function(e){if(!(e instanceof TextProperties))return!1;if(!this.frame().isEqual(e.frame()))return!1;for(var t in this.styles)if(this.styles[t]!=e.styles[t])return!1;return!0},Button=function(e,t,r){DrawableImage.call(this,e,t,r),this.cacheEnabled=!1,this.state=Button.STATE_NORMAL},Button.prototype=Object.create(DrawableImage.prototype),Button.prototype.initializer="Button",Button.STATE_NORMAL=0,Button.STATE_HOVER=1,Button.STATE_DOWN=2,Button.STATE_DISABLE=3,Button.prototype.click=function(e,t,r){this.state=Button.STATE_HOVER},Button.prototype.enter=function(e,t,r){this.state=Button.STATE_HOVER},Button.prototype.leave=function(e,t,r){this.state=Button.STATE_NORMAL},Button.prototype.mousemove=function(e,t,r){},Button.prototype.mousedown=function(e,t,r){this.state=Button.STATE_DOWN},Button.prototype.cancel=function(){this.state=Button.STATE_NORMAL},Button.prototype.clone=function(){var e=new Button(this.image);return e.importFrom(this),e},Button.restore=function(e){return $.when(ResourceLoader.loadImage(e.image,!0)).then(function(t){var r=new Button(t);return r.importFromSaveData(e),r})};var Link=function(e){DrawableSolidColor.call(this),this.color=config.messageLayerDefaultLinkColor||"#0000ff",this.opacity=config.messageLayerDefaultLinkOpacity,this.hovering,this.textsProperties=[],this.rects=[],this.vertical=!1,this.messageLayer};Link.prototype=Object.create(DrawableSolidColor.prototype),Link.prototype.initializer="Link",Link.restore=function(e){var t=new Link;return t.importFromSaveData()},Link.prototype.objectToBeSerialized=function(e){switch(e){case"messageLayer":return}return this[e]},Link.prototype.importFrom=function(e){DrawableSolidColor.prototype.importFrom.call(this,e),this.vertical=e.vertical,e.messageLayer?(this.textsProperties=e.textsProperties.map(function(e){return e}),this.refreshRects()):(this.textsProperties=clone(e.textsProperties),this.refreshRects())},Link.prototype.isHovering=function(e,t){for(var r=0;r<this.rects.length;r++)if(this.rects[r].coverCoordinate(e,t))return!0;return!1},Link.prototype.drawOnContext=function(e,t){if(this.hovering){for(var r=this.rect,i=0;i<this.rects.length;i++)this.rect=this.rects[i],DrawableSolidColor.prototype.drawOnContext.call(this,e);this.rect=r}},Link.prototype.addTextProperties=function(e){e instanceof Array?this.textsProperties=this.textsProperties.concat(e):this.textsProperties.push(e),this.refreshRects()},Link.prototype.refreshRects=function(){this.rects=[],this.rect=new Rect;for(var e,t=0;t<this.textsProperties.length;t++){var r=this.textsProperties[t],i=r.frame();e||(e=new Rect),e.extend(i),(t==this.textsProperties.length-1||this.textsProperties[t+1].frame().y!=i.y&&!this.vertical||this.textsProperties[t+1].frame().x!=i.x&&this.vertical)&&(this.rects.push(e),this.rect.extend(e),e=void 0)}},Link.prototype.click=function(e,t,r){},Link.prototype.enter=function(e,t,r){},Link.prototype.leave=function(e,t,r){};var MessageLayer=function(e){Layer.call(this,e||new Rect({x:config.messageLayerCurrentPositionX,y:config.messageLayerCurrentPositionY,width:config.messageLayerCurrentWidth,height:config.messageLayerCurrentHeight})),this.frameImage,this.frameSolid=new DrawableSolidColor(new Rect(0,0,this.rect.width,this.rect.height)),this.frameSolid.color=config.messageLayerColor||"#000",this.frameSolid.opacity=config.messageLayerOpacity,this.visible=!1,this.opacity=1,this.margin={top:config.messageLayerMarginT||20,right:config.messageLayerMarginR||20,bottom:config.messageLayerMarginB||20,left:config.messageLayerMarginL||20},this.textsProperties=[],this.vertical=config.messageLayerVertical,this.textCursor={x:0,y:0},this.align="left",this.delaySpeed=config.chSpeeds||20,this.ctx.textBaseline="top",this.defaultFont=MessageLayer.defaults.defaultFont(),this.defaultStyle=MessageLayer.defaults.defaultStyle(),this.font=clone(this.defaultFont),this.style=clone(this.defaultStyle),ResourceLoader.loadFont(this.defaultFont.face),ResourceLoader.loadFont(this.font.face),this.glyphOptions=MessageLayer.defaults.glyphOptions(),this.textCustomizers=["baseTextCustomizer","alignTextCustomizer"],this.isDrawingText=!1,this.buttons=[],this.routineButtons=[],this.links=[],this.images=[],this.lastLineSize=0,this.resetCursor();var t=this;setTimeout(function(){$(conductor).on("ran",function(){t.refreshRoutineButtons(void 0,void 0,!0)})})};MessageLayer.prototype=Object.create(Layer.prototype),MessageLayer.prototype.initializer="MessageLayer",MessageLayer.defaults={defaultFont:function(){return{size:config.messageLayerDefaultFontSize||20,face:config.messageLayerDefaultFontFace||"Arial",color:config.messageLayerDefaultFontColor||"#000000",rubySize:config.messageLayerDefaultRubySize||10,rubyOffset:config.messageLayerDefaultRubyOffset||0,shadow:config.messageLayerDefaultShadow,shadowColor:config.messageLayerDefaultShadowColor||"#999999",shadowBlur:config.messageLayerDefaultShadowBlur,shadowOffsetX:config.messageLayerDefaultShadowOffsetX,shadowOffsetY:config.messageLayerDefaultShadowOffsetY,edge:config.messageLayerDefaultEdge,edgeColor:config.messageLayerDefaultEdgeColor||"#00ff00",bold:config.messageLayerDefaultFontBold,italic:config.messageLayerDefaultFontItalic}},font:function(){return this.defaultFont()},defaultStyle:function(){return{lineSpacing:Number(config.messageLayerDefaultStyleLineSpacing)||0,pitch:Number(config.messageLayerDefaultStylePitch)||0,lineSize:0,align:"left",autoReturn:config.messageLayerDefaultAutoReturn,kinsoku:MessageLayer.KINSOKU_BURASAGARI,kinsokuBolChar:" 。．、，」』）〉】》］〕”｝’〟？！⁇‼⁈⁉",kinsokuEolChar:"「『（〈【《［〔“｛‘〝",kinsokuBurasagariChar:"。．、，"}},style:function(){return this.defaultStyle()},glyphOptions:function(){return{line:config.messageLayerDefaultGlyphLine,page:config.messageLayerDefaultGlyphPage,fixed:config.messageLayerDefaultGlyphFixed,x:config.messageLayerDefaultGlyphX,y:config.messageLayerDefaultGlyphY}}},MessageLayer.prototype.objectToBeSerialized=function(e){switch(e){case"textsProperties":case"links":case"glyphLayer":case"isDrawingText":return}if(-1==["buttons","routineButtons","images"].indexOf(e)||this[e].length){if(MessageLayer.defaults.hasOwnProperty(e)){var t=MessageLayer.defaults[e]();if(!t)return;var r={};for(var i in this[e])this[e][i]!=t[i]&&(r[i]=this[e][i]);return r}return Layer.prototype.objectToBeSerialized.call(this,e)}},MessageLayer.prototype.importFromSaveData=function(e){var t=this;this.buttons=[];var r=[];if(e.buttons){for(var i=0;i<e.buttons.length;i++){var n=e.buttons[i];r.push($.when(n.restore()).done(function(e){t.addButton(e)}))}delete e.buttons}if(this.images=[],e.images)for(var i=0;i<e.images.length;i++){var o=e.images[i];r.push($.when(o.restore()).done(function(e){t.images.push(e)}))}if(delete e.images,this.links=[],e.links)for(var i=0;i<e.links.length;i++){var a=e.links[i];r.push($.when(a.restore()).done(function(e){t.addLink(e)}))}return delete e.links,this.textCustomizers=[],this.textsProperties=[],r.push(Layer.prototype.importFromSaveData.call(this,e)),e.font.face&&r.push(ResourceLoader.loadFont(e.font.face)),e.defaultFont.face&&r.push(ResourceLoader.loadFont(e.defaultFont.face)),$.when.apply($,r).then(function(){return t.setRect(t.rect),t.redrawRect(),t})},MessageLayer.KINSOKU_NONE=0,MessageLayer.KINSOKU_OIDASHI=1,MessageLayer.KINSOKU_BURASAGARI=2,MessageLayer.prototype.children=function(){var e=[];return this.frameImage?e.push(this.frameImage):e.push(this.frameSolid),e=e.concat(this.textsProperties,this.links,this.images,this.buttons,this.routineButtons),this.glyphLayer&&e.push(this.glyphLayer),e},MessageLayer.prototype.importFrom=function(e){if(!(e instanceof MessageLayer))throw"[内部エラー] otherLayerはMessageLayerではありません";Layer.prototype.importFrom.call(this,e);var t=["frameImage","frameSolid","margin","textsProperties","vertical","lineWidth","textCursor","align","delaySpeed","defaultFont","defaultStyle","font","style","textCustomizers","buttons","images","routineButtons"];(function(){if(this.isDrawingText){var e=t.indexOf("textsProperties");0>e||t.splice(e,1)}}).call(this);for(var r=0;r<t.length;r++){var i=t[r];this[i]=clone(e[i])}this.links=[];for(var n=this,r=0;r<e.links.length;r++){var o=e.links[r],a=clone(o);a.textsProperties=o.textsProperties.map(function(e){var t=o.messageLayer.textsProperties.indexOf(e);return-1!=t?n.textsProperties[t]:void 0}),this.addLink(a)}this.setRect(clone(e.rect),!0)},MessageLayer.prototype.mousemove=function(e){if(!this.visible)return!1;if(!Layer.prototype.mousemove.apply(this,arguments))return!1;var t=!1,r=e.originalEvent.normalizedCoordinate(this);return this.refreshRoutineButtons(r.x,r.y)&&(t=!0),this.refreshButtons(r.x,r.y)&&(t=!0),this.refreshLinks(r.x,r.y)&&(t=!0),t},MessageLayer.prototype.mouseup=function(e){if(!this.visible)return!1;if(!Layer.prototype.mousedown.apply(this,arguments))return!1;for(var t=e.originalEvent.normalizedCoordinate(this),r=this.buttons.length-1;r>=0;r--){var i=this.buttons[r];if(!i.rect.coverCoordinate(t.x,t.y)&&i.state==Button.STATE_DOWN)return i.leave(t.x,t.y,this),this.redrawRect(i.rect),!0}for(var r=this.routineButtons.length-1;r>=0;r--){var i=this.routineButtons[r];if(i.rect.coverCoordinate(t.x,t.y)&&i.state!=Button.STATE_DISABLE)return i.click(t.x,t.y,this),i.state=Button.STATE_HOVER,this.redrawRect(i.rect),!0}for(var r=this.buttons.length-1;r>=0;r--){var i=this.buttons[r];if(i.rect.coverCoordinate(t.x,t.y))return i.click(t.x,t.y,this),i.state=Button.STATE_HOVER,this.redrawRect(i.rect),!0}for(var r=this.links.length-1;r>=0;r--){var n=this.links[r];if(n.isHovering(t.x,t.y))return n.click(t.x,t.y,this),!0}return!1},MessageLayer.prototype.mousedown=function(e){if(!this.visible)return!1;if(!Layer.prototype.mousedown.apply(this,arguments))return!1;for(var t=e.originalEvent.normalizedCoordinate(this),r=this.routineButtons.length-1;r>=0;r--){var i=this.routineButtons[r];if(i.rect.coverCoordinate(t.x,t.y)&&i.state!=Button.STATE_DISABLE)return i.mousedown(t.x,t.y,this),this.redrawRect(i.rect),!0}for(var r=this.buttons.length-1;r>=0;r--){var i=this.buttons[r];if(i.rect.coverCoordinate(t.x,t.y))return i.mousedown(t.x,t.y,this),this.redrawRect(i.rect),!0}return!1},MessageLayer.prototype.touchcancel=function(){for(var e=this.routineButtons.length-1;e>=0;e--){var t=this.routineButtons[e];t.cancel()}for(var e=this.buttons.length-1;e>=0;e--){var t=this.buttons[e];t.cancel()}},MessageLayer.prototype.setRect=function(e,t){e||(e=this.rect),e.width&&e.height||o2.error("width/heightは0です");var r=this.rect.width!=e.width||this.rect.height!=e.height||this.canvas.width!=e.width||this.canvas.height!=e.height;r&&(this.canvas.width=e.width,this.canvas.height=e.height),this.ctx.textBaseline="top",this.rect=e,this.frameSolid.rect.width=e.width,this.frameSolid.rect.height=e.height,(r||t)&&this.redrawRect()},MessageLayer.prototype.resetCursor=function(){this.vertical?this.textCursor={x:this.rect.width-this.margin.right-this.style.lineSpacing,y:this.margin.top}:this.textCursor={x:this.margin.left,y:this.margin.top+this.style.lineSpacing}},MessageLayer.prototype.linebreak=function(){this.vertical?(this.textCursor.y=this.margin.top,this.textCursor.x-=this.style.lineSpacing+this.lastLineSize):(this.textCursor.x=this.margin.left,this.textCursor.y+=this.style.lineSpacing+this.lastLineSize)},MessageLayer.textCustomizers={baseTextCustomizer:function(e,t,r){this.isAnimation=!1;var i=e.delaySpeed,n=void 0,o=function(t){return n?n:n=function(){for(var r=[],i=e.textCursor.x,n=e.textCursor.y,o=0,a=0,s=void 0,c=0;c<t.length;c++){var u=t[c];u.rect.isZero()&&void 0===u.styles.vertical&&(u.styles.vertical=e.vertical)}for(var c=0;c<t.length;c++){var u=t[c];if(u.rect.isZero()){if(void 0==s){e.vertical?(o=Math.max(o,e.style.lineSize),e.lastLineSize=o):(a=Math.max(a,e.style.lineSize),e.lastLineSize=a),s=function(){for(var r=e.vertical?n:i,s=c;s<t.length;s++){var u=t[s].measure(e.ctx);if(e.vertical){if(r+=u.height+e.style.pitch,u.width>o&&(o=u.width,e.lastLineSize=o),r>e.rect.height-e.margin.bottom&&e.style.autoReturn)return s}else if(u.height>a&&(a=u.height,e.lastLineSize=a),r+=u.width+e.style.pitch,r>e.rect.width-e.margin.right&&e.style.autoReturn)return s}return-1}();var l=s;if(-1!=s){var h=t[s],f=t[s+1];if(e.style.kinsoku!=MessageLayer.KINSOKU_BURASAGARI||-1==e.style.kinsokuBurasagariChar.indexOf(h.text)||f&&-1!=e.style.kinsokuBolChar.indexOf(f.text)){if(e.style.kinsoku!=MessageLayer.KINSOKU_NONE)for(;-1!=e.style.kinsokuBolChar.indexOf(t[s].text)||t[s-1]&&-1!=e.style.kinsokuEolChar.indexOf(t[s-1].text);)if(s--,c>=s){s=l;break}}else f?s++:s=-1}}var d=u.measure(e.ctx);if(s===c)if(e.vertical){if(!(n<=e.margin.top)){n=e.margin.top,i-=o+e.style.lineSpacing,o=0,s=void 0,c--;continue}s++}else{if(!(i<=e.margin.left)){i=e.margin.left,n+=a+e.style.lineSpacing,a=0,s=void 0,c--;continue}s++}e.vertical?r[c]={x:i-o+(o-d.width)/2,y:n,width:d.width,height:d.height}:r[c]={x:i,y:n+a-d.height,width:d.width,height:d.height},u.rect=new Rect(r[c]),e.vertical?n+=d.height+e.style.pitch:i+=d.width+e.style.pitch}}return r}()},a=t.concat(r),s=o(a),c=this;this.perform=function(){r.forEach(function(e,t){c.timePassed/i>=t&&(e.styles.visible||(e.styles.visible=!0,e.needRedraw=!0))}),s.forEach(function(e,t){a[t].rect=new Rect(e)})},this.isEnded=function(){return c.timePassed/i>=r.length}},alignTextCustomizer:function(e,t,r){if(e.vertical){if("center"!=e.style.align&&"bottom"!=e.style.align)return}else if("left"==e.style.align)return;var i=t.concat(r);this.perform=function(){var t=e.style.align;if(e.vertical)for(var r=0,n=0;n<i.length;n++){var o=i[n];if(n>=i.length-1||o.rect.y>i[n+1].rect.y){for(var a=0,s=r;n>=s;s++)i[s].styles.visible&&(a+=i[s].rect.height+e.style.pitch);a-=e.style.pitch;var c=0,u=e.rect.height-e.margin.top-e.margin.bottom;"center"==t?c=(u-a)/2:"bottom"==t&&(c=u-a);for(var s=r;n>=s;s++)i[s].styles.visible&&(i[s].rect.y=c,i[s].needRedraw=!0,c+=i[s].rect.height+e.style.pitch);r=n+1}}else for(var r=0,n=0;n<i.length;n++){
var o=i[n];if(n>=i.length-1||o.rect.x>i[n+1].rect.x){for(var l=0,s=r;n>=s;s++)i[s].styles.visible&&(l+=i[s].rect.width+e.style.pitch);var h=0,f=e.rect.width-e.margin.left-e.margin.right;"center"==t?h=(f-l)/2+e.margin.left:"right"==t&&(h=f-l+e.margin.left);for(var s=r;n>=s;s++)i[s].styles.visible&&(i[s].rect.x=h,i[s].needRedraw=!0,h+=i[s].rect.width+e.style.pitch);r=n+1}}}}},MessageLayer.prototype.drawText=function(e,t){function r(){for(var e=!0,i=Date.now()-l,n=0;n<u.length;n++){var o=u[n];o.timePassed=i,(o2.skipMode||0==this.delaySpeed)&&(o.timePassed=1/0),"function"==typeof o.perform&&o.perform(),"function"==typeof o.isEnded&&0==o.isEnded()&&(e=!1)}this.redrawRect();for(var n=0;n<this.links.length;n++)this.links[n].refreshRects();if(e){var a=this.textsProperties[this.textsProperties.length-1];a&&(this.vertical?this.textCursor={x:a.rect.x+a.rect.width+(this.lastLineSize-a.rect.width)/2,y:a.rect.y+a.rect.height}:this.textCursor={x:a.rect.x+a.rect.width,y:a.rect.y+a.rect.height-this.lastLineSize}),this.isDrawingText=!1,"function"==typeof t&&setTimeout(t.bind(this),0),u.forEach(function(e){"function"==typeof e.destroy&&e.destroy()})}else renderer.animator.requestFrame(r.bind(this),s?0:this.delaySpeed)}this.isDrawingText=!0;var i=(this.textsProperties.length,this);"string"==typeof e&&(e=e.split(""));for(var n=this.textsProperties.slice(),o=e.map(function(e){if(e instanceof TextProperties)return e;var t=new TextProperties(e);return $.extend(t.styles,clone(i.font)),t}),a=0;a<o.length;a++)this.textsProperties.push(o[a]);var s=!1,c=!1,u=this.textCustomizers.map(function(e){var e=MessageLayer.textCustomizers[e];if("function"!=typeof e)return void o2.error(e+"はtextCustomizerではないです。");var t=new e(this,n,o);return!s&&t.isAnimation&&(s=!0),t},this);!c&&(s||["center","right","bottom"].indexOf(this.style.align)>=0)&&this.textsProperties.forEach(function(e){e.useCanvasCache=!0});var l=Date.now();r.call(this)},MessageLayer.prototype.measureText=function(e){return"string"==typeof e&&(e=new TextProperties(e),$.extend(e.styles,clone(this.font))),e.measure(this.ctx)},MessageLayer.prototype.refreshButtons=function(e,t){for(var r=!1,i=this.buttons.length-1;i>=0;i--){var n=this.buttons[i],o=n.rect.coverCoordinate(e,t);this.drawButton(n,o,e,t),(o||n.state==Button.STATE_DOWN)&&(r=!0,n.mousemove(e,t,this))}return r},MessageLayer.prototype.drawButton=function(e,t,r,i){t&&e.state==Button.STATE_NORMAL?(e.enter(r,i,this),this.redrawRect(e.rect)):t||e.state!=Button.STATE_HOVER||(e.leave(r,i,this),this.redrawRect(e.rect))},MessageLayer.prototype.addButton=function(e){this.buttons.push(e),this.draw(e)},MessageLayer.prototype.refreshRoutineButtons=function(e,t,r){var i=!1,n=[],o=r?currentConductor.getNextTag():currentConductor.currentTag;if(o){for(var a=-1!=["p","l","s"].indexOf(o.tagName),s=this.routineButtons.length-1;s>=0;s--){var c=this.routineButtons[s],u=e&&t?c.rect.coverCoordinate(e,t):!1;u?n.push(c):this.drawRoutineButton(c,u,a,e,t),u&&a&&c.enabled&&(i=!0)}for(var s=0;s<n.length;s++){var c=n[s];this.drawRoutineButton(c,!0,a,e,t)}return i}},MessageLayer.prototype.drawRoutineButton=function(e,t,r,i,n){var o=Button.STATE_NORMAL;r?t?(o=Button.STATE_HOVER,e.state!=Button.STATE_HOVER&&(e.enter(i,n,this),this.redrawRect(e.rect))):(o=Button.STATE_NORMAL,e.state==Button.STATE_HOVER&&(e.leave(i,n,this),this.redrawRect(e.rect))):o=Button.STATE_DISABLE,e.state!=o&&(e.state=o,this.redrawRect(e.rect))},MessageLayer.prototype.addRoutineButton=function(e){this.routineButtons.push(e),this.draw(e)},MessageLayer.prototype.refreshLinks=function(e,t){for(var r=!1,i=this.links.length-1;i>=0;i--){var n=this.links[i],o=n.isHovering(e,t);this.drawLink(n,o,e,t),o&&(r=!0)}return r},MessageLayer.prototype.drawLink=function(e,t,r,i){t&&!e.hovering?(e.enter(r,i,this),e.hovering=!0,e.visible=!0,this.draw(e)):!t&&e.hovering&&(e.leave(r,i,this),e.hovering=!1,e.visible=!1,this.redrawRect(e.rect))},MessageLayer.prototype.addLink=function(e){e.vertical=this.vertical,e.messageLayer=this,this.links.push(e)},MessageLayer.prototype.addButtonLinkImages=function(){for(var e=0;e<this.buttons.length;e++){var t=this.buttons[e],r=new DrawableCanvas(t.rect);t.rect.x=t.rect.y=0,t.drawOnContext(r.ctx),this.images.push(r),this.redrawRect(r.rect)}for(var e=0;e<this.links.length;e++){var i=this.links[e];if(i.visible&&i.hovering)for(var n=0;n<i.rects.length;n++){var o=i.rects[n],r=new DrawableSolidColor(o);r.importFrom(i),this.images.push(r),this.redrawRect(r.rect)}}},MessageLayer.prototype.showGlyphLayer=function(e,t){t=t||"line",this.glyphLayer=e;var r=this,i="line"===t?this.glyphOptions.line:this.glyphOptions.page;this.glyphLayer.showOnLayer(this,i).done(function(){r.glyphOptions.fixed?(e.rect.x=r.glyphOptions.x,e.rect.y=r.glyphOptions.y):r.vertical?(e.rect.x=r.textCursor.x-e.rect.width,e.rect.y=r.textCursor.y):(e.rect.x=r.textCursor.x,e.rect.y=r.textCursor.y+Math.max(r.style.lineSize,r.font.size)-e.rect.height),r.redrawRect(e.rect)})},MessageLayer.prototype.hideGlyphLayer=function(){this.glyphLayer&&this.glyphLayer.hide(),this.glyphLayer=void 0},MessageLayer.prototype.resetFrameSize=function(){this.frameSolid.rect.width=this.rect.width,this.frameSolid.rect.height=this.rect.height},MessageLayer.prototype.setFrameImage=function(e){if(void 0!=e&&!(e instanceof Drawable))throw"[内部エラー] imageはdrawableではありません";this.frameImage?this.redrawRect(this.frameImage.frame()):this.redrawRect(this.rect),this.frameImage=e,this.frameImage&&this.redrawRect(this.frameImage.rect)},MessageLayer.prototype.resetMessageLayer=function(){for(var e=this.buttons.length-1;e>=0;e--)this.redrawRect(this.buttons[e].frame());for(var e=this.textsProperties.length-1;e>=0;e--)this.redrawRect(this.textsProperties[e].frame());this.buttons=[],this.routineButtons=[],this.images=[],this.links=[],this.textsProperties=[],this.font=clone(this.defaultFont),this.style=clone(this.defaultStyle),this.resetCursor(),this.resetFrameSize(),this.redrawRect()};var Sound=function(e){this.filepath,this.isPlaying=!1,this.volume=1,this.volumePercentage=1,this.loop=!1,this.pan=0,this.loadDefer,this.audio=new Audio,this.fadeDefer,this.fadeStatus,"string"==typeof e&&this.setFile(e)};Sound.prototype.objectToBeSerialized=function(e){switch(e){case"audio":case"loadDefer":return}return this[e]},Sound.prototype.importFromSaveData=function(e){this.filepath=void 0;var t=this,r=e.fadeStatus;return delete e.fadeStatus,Object.prototype.importFromSaveData.call(this,e).then(function(){if(t.isPlaying||t.stop(),r||t.stopFade(),t.filepath){var e=t.setFile(t.filepath);return t.isPlaying&&t.loop&&t.play(),r&&t.fade(r),e}})},Sound.prototype.setFile=function(e){this.filepath=e;var t=this;return this.loadDefer=ResourceLoader.loadAudio(e,!0,this.audio),this.loadDefer.done(function(e){t.setVolume(t.volume),$(e).off(),$(e).on("ended",function(){t.loop?(e.currentTime=0,t.play()):(t.isPlaying=!1,$(t).trigger("ended"))})}),this.loadDefer},Sound.prototype.play=function(e){if(!browser.supportsMultipleAudio&&this!=o2.prioritySound)return void o2.warn("再生しようとしていますが、config.AudioChannelとは違いますのでしなかった");if(this.stopFade(),e&&this.setFile(e),this.isPlaying=!0,this.loadDefer){return this.loadDefer.done(function(e){e.play()}),this.loadDefer}o2.warn("サウンドファイルが指定されていない状態で再生を行おうとしました")},Sound.prototype.pause=function(){this.isPlaying=!1,this.loadDefer&&this.loadDefer.done(function(e){e.pause()})},Sound.prototype.stop=function(){if(this.isPlaying=!1,this.loadDefer){var e=this;this.loadDefer.done(function(t){$(t).trigger("ended"),e.pause(),e.setTime(0)})}},Sound.prototype.setTime=function(e){this.loadDefer.done(function(t){try{t.currentTime=e/1e3}catch(r){$(t).one("loadedmetadata",function(){t.currentTime=e/1e3})}})},Sound.prototype.setVolume=function(e){if(0>e||e>1)return void o2.error("ボリュームの指定が不正です");if(this.volume=e,this.loadDefer){var t=this;this.loadDefer.done(function(e){e.volume=t.volume*t.volumePercentage})}},Sound.prototype.setLoop=function(e){this.loop=e},Sound.prototype.setPan=function(e){this.pan=e},Sound.prototype.fade=function(e){if(e){if(this.fadeStatus&&this.stopFade(!1),"fromVolume"in e||(e.fromVolume=this.volume),"toVolume"in e||(e.toVolume=this.volume),!this.loadDefer)return void o2.log("サウンドファイルを指定されていない状態でフェード処理を行おうとしました");var t=this.fadeStatus=new SoundFade(this,e),r=this;return this.fadeStatus.defer.done(function(){delete r.fadeStatus}),this.loadDefer.done(function(){r.fadeStatus===t&&r.fadeStatus.start()}),this.fadeStatus.defer}return this.fadeStatus?this.fadeStatus.defer:void 0},Sound.prototype.stopFade=function(e){this.fadeStatus&&this.fadeStatus.stop(e)},Sound.prototype.dummyLoad=function(){this.audio.src="x",this.audio.load()},SoundFade=function(e,t){this.sound=e,this.fromVolume=1,this.toVolume=0,this.duration=1e3,this.finalVolume,this.stopAfterFade=!1,t&&$.extend(this,t),this.intervalId,this.defer=$.Deferred()},SoundFade.prototype.initializer="SoundFade",SoundFade.prototype.start=function(){function e(){var e=(Date.now()-t)/this.duration;e>1&&(e=1);var r=this.fromVolume+(this.toVolume-this.fromVolume)*e;this.sound.setVolume(r),e>=1&&this.stop()}var t=Date.now();this.intervalId=setInterval(e.bind(this),1e3/60),e.call(this)},SoundFade.prototype.stop=function(e){void 0===e&&(e=!0),clearInterval(this.intervalId),e&&(this.finalVolume?this.sound.setVolume(this.finalVolume):this.sound.setVolume(this.toVolume)),this.stopAfterFade&&this.sound.stop(),this.defer.resolve()},SoundFade.prototype.toJSON=function(){return{fromVolume:this.fromVolume,toVolume:this.toVolume,duration:this.duration,finalVolume:this.finalVolume,stopAfterFade:this.stopAfterFade}};var Tag,TagAction;Tag=function(e,t,r){this.file,this.tagName=e,this.args=t||{},r&&(this.callbackArgs=r),this.scopeVars,this.lineNumber,this.originalLineNumber,this.originalCharNumber,this.conductor},Tag.prototype.getAction=function(e){return this.conductor&&"function"==typeof this.conductor.getTagAction?this.conductor.getTagAction(e):Tag.actions[e]},Tag.prototype.isOpen=function(){return void 0!=this.callbackArgs},Tag.prototype.isClose=function(){return"/"===this.tagName},Tag.prototype.getOpenTag=function(){if(this.isClose()&&this.file){if(this.openTag)return this.openTag;var e=function(){for(var e=1,t=this.lineNumber-1;t>0;t--){var r=this.file.lines[t];if(r.isClose()?e++:r.isOpen()&&e--,0==e)return r.closeTag=this,this.openTag=r,r}}.call(this),t=this.conductor.stack[this.conductor.stack.length-1];if(e&&t&&e.isPrototypeOf(t))return t;throw"something wrong in stack"}},Tag.prototype.getCloseTag=function(){if(this.isOpen()&&this.file)for(var e=1,t=this.lineNumber+1;t<this.file.lines.length;t++){var r=this.file.lines[t];if(r.isOpen()?e++:r.isClose()&&e--,0==e)return r.openTag=this,this.getCloseTag=function(){return r},r}},Tag.prototype.getCallbackFile=function(){var e=this.getCloseTag();if(e){var t=new PartialFile(this.file,this.lineNumber+1,e.lineNumber-1);return this.getCallbackFile=function(){return t},t}},Tag.prototype.makeScopeVars=function(e){if(e instanceof Array){for(var t={},r=0;r<this.callbackArgs.length;r++)t[this.callbackArgs[r]]=e[r];return t}},Tag.prototype.setScopeVars=function(e){if(this.isOpen()){var t=this.conductor.callbackVarsStack.indexOf(this.scopeVars);e instanceof Array?this.scopeVars=this.makeScopeVars(e):this.scopeVars=e,-1==t?this.conductor.callbackVarsStack.push(this.scopeVars):this.conductor.callbackVarsStack[t]=this.scopeVars}},Tag.prototype.keepStack=function(){throw"keepStackはclose tagのみ使える"},Tag.prototype.flattenCurrentScope=function(e){if(!this.conductor)return{};var t={};return this.conductor.callbackVarsStack.forEach(function(r){for(var i in r)e&&!e(i,r[i])||(t[i]=r[i])}),t},Tag.prototype.exitScope=function(){if(this.isOpen()){var e=this.getAction(this.tagName);if(e){var t=e.exitScope;"function"==typeof exitScope&&t.call(this)}}},Tag.prototype.jumpToTag=function(e,t){for(var r=this.conductor.stack.length-1;r>=0;r--){var i=this.conductor.stack[r];if(i===e||e.isPrototypeOf(i)||i.getCloseTag()===e&&!t)break;var n=i.getCallbackFile().lines.some(function(t){return t===e||e.isPrototypeOf(t)||t.isPrototypeOf(e)});if(n)break;i.exitScope(),this.conductor.stack.pop(),i.scopeVars&&this.conductor.callbackVarsStack.pop()}this.conductor.setTag(e,t)},Tag.prototype.run=function(){var e=this.tagName,t=this.getAction(e);if(this.isClose()){var r=this.conductor.stack[this.conductor.stack.length-1];if(!r)return void this.error("open tagが見つかりません");if(e=r.tagName,t=this.getAction(e),!t)return;var i=t.closeAction,n=0,o=!0;if("function"==typeof i){var a=Object.create(this);a.keepStack=function(){o=!1},n=i.call(a,r)}return o&&(this.exitScope(),this.conductor.stack.pop(),r.scopeVars&&this.conductor.callbackVarsStack.pop()),n}if(t){var s=this.argsForAction(),a=Object.create(this);if(a.conductor=this.conductor,this.isOpen()){a.conductor.stack.push(a);var c=this.getCloseTag();this.conductor.setTag(c)}var n=t.action.call(a,s);return n}this.warn("タグハンドラが見つかりません"),this.isOpen()&&this.conductor.setTag(this.getCloseTag(),!0)},Tag.prototype.preload=function(){var e=this.getAction(this.tagName);if(acthisTagActiontthisTagActionion&&"function"==typeof e.preload){var t=this.validate(this.args);return e.preload.call(this,t)}},Tag.prototype.normalizedArgs=function(_args){_args=clone(_args?_args:this.args);for(var key in _args){var value=_args[key],action=this.getAction(this.tagName);if(action){var rules=action.rules;rules&&(key in rules||"o2_cond"==key||"*"==key||this.warn(key+"という未知の属性があります"))}if("*"!==key){if(_args.hasOwnProperty(key)&&"string"==typeof value){switch(value.charAt(0)){case"&":value=value.substring(1),value=-1!=value.indexOf("$")?this.eval(value):eval(value);break;case"%":value=value.substring(1),values=value.split("|");var currentMacro=this.conductor.macroStack[this.conductor.macroStack.length-1];value=void 0!==currentMacro.args[values[0]]?currentMacro.args[values[0]]:values[1];break;case"$":var needEval=/[\-\+\/\\\*()"'\s|&{:}!=><\[\]\;\?]/.test(value);if(needEval)value=this.eval(value);else{value=value.substring(1);for(var keyPath=value.split("."),thisKey=keyPath[0],i=this.conductor.callbackVarsStack.length-1;i>=0;i--){var thisScope=this.conductor.callbackVarsStack[i];if(thisKey in thisScope){value=thisScope[thisKey],keyPath.shift();break}}0>i?value=void 0:keyPath.forEach(function(e){e in value&&(value=value[e])})}}_args[key]=value}}else for(var macroKey in window.mp)window.mp.hasOwnProperty(macroKey)&&(_args[macroKey]=window.mp[macroKey])}return _args},Tag.prototype.argsForAction=function(){return this.validate(this.normalizedArgs(this.args))},Tag.prototype.validate=function(e){e=e?clone(e):{};var t=this.getAction(this.tagName);if(!t)return e;var r=t.rules;if(!r)return e;if("function"==typeof r)return r(e);for(var i in r){var n=!!r[i].required,o=e[i],a=r[i];if(n&&void 0===o&&this.error("必須の属性 "+i+" が指定されていません"),void 0===o&&"defaultValue"in a&&(o="function"==typeof a.defaultValue?a.defaultValue():a.defaultValue),a.type&&void 0!==o){if("allowString"in a&&"string"==typeof o)for(var s=!1,c=a.allowString.length-1;c>=0;c--){var u=a.allowString[c];if(u===o){s=!0;break}}if(!s)if(a.type in Tag.validators)try{o=Tag.validators[a.type](o)}catch(l){console.trace&&console.trace(),this.error(i+"は"+l)}else a.type instanceof RegExp&&("string"!=typeof o&&(o=String(o)),a.type.test(o)||this.error("属性 "+i+" の値は "+a.type.toString()+" 型でなければなりません"))}void 0!==o&&(e[i]=o)}return e},Tag.validators={STRING:function(e){return String(e)},BOOLEAN:function(e){if("boolean"==typeof e)return e;if("string"==typeof e){if("true"===e||"1"===e)return!0;if("false"===e||"0"===e)return!1}else if("number"==typeof e){if(0===e)return!1;if(1===e)return!0}throw"boolean型ではありません"},INT:function(e){if(isNaN(parseFloat(e))||!isFinite(e))throw"int型ではありません";return parseInt(e)},FLOAT:function(e){if(isNaN(parseFloat(e))||!isFinite(e))throw"float型ではありません";return parseFloat(e)},LAYER:function(e){if("base"===e)return{fore:o2.foreLayers.baseLayer,back:o2.backLayers.baseLayer};if("object"==typeof e&&e.fore instanceof Layer&&e.back instanceof Layer)return e;try{return this.MESSAGE_LAYER(e)}catch(t){}try{return this.IMAGE_LAYER(e)}catch(t){}throw"指定されたレイヤが見つかりません"},IMAGE_LAYER:function(e){if("base"===e)return{fore:o2.foreLayers.baseLayer,back:o2.backLayers.baseLayer};if("object"==typeof e&&e.fore instanceof ImageLayer&&e.back instanceof ImageLayer)return e;var t=Number(e);if(isNaN(t))throw"number型ではありません";if(!(t in o2.foreLayers.imageLayers))throw"イメージレイヤ "+t+" は存在しません";return{fore:o2.foreLayers.imageLayers[t],back:o2.backLayers.imageLayers[t]}},MESSAGE_LAYER:function(e){var t;if(e.toString().match(/^message$/i))return o2.currentMessageLayer;if(t=e.toString().match(/^message(\d+)$/i)){if(number=Number(t[1]),o2.foreLayers.messageLayers[number])return{fore:o2.foreLayers.messageLayers[number],back:o2.backLayers.messageLayers[number]}}else if("object"==typeof e&&e.fore instanceof MessageLayer&&e.back instanceof MessageLayer)return e;throw"メッセージレイヤ "+e+" は存在しません"},COLOR:function(e){var t=/0x([0-9a-fA-F]{6})/.exec(e);if(null==t)throw"color型ではありません";return"#"+t[1]},TIME:function(e){if("number"==typeof e)return e;if("-1"==e.indexOf(":")){var t=parseFloat(e);if(isNaN(t))throw"time型ではありません";return t}var r=e.split(":"),i=0,n=0,o=0,a=0;if(4==r.length)i=parseFloat(r[0]),n=parseFloat(r[1]),o=parseFloat(r[2]),a=r[3];else if(3==r.length)n=parseFloat(r[0]),o=parseFloat(r[1]),a=parseFloat(r[2]);else if(2==r.length)n=parseFloat(r[0]),o=parseFloat(r[1]);else{if(1!=r.length)throw"time型ではありません";a=parseFloat(e)/10}if(isNaN(i)||isNaN(n)||isNaN(o)||isNaN(a))throw"time型ではありません";return 60*i*60*1e3+60*n*1e3+1e3*o+10*a},OBJECT:function(e){if(null==e||"object"!=typeof e)throw"object型ではありません";return e},FUNCTION:function(e){if("function"!=typeof e)throw"functionではありません";return e}},Tag.prototype.eval=function(value){var scope=this.flattenCurrentScope();for(var scopeKey in scope)value=value.replace("$"+scopeKey,"Tag.tempScopeObj."+scopeKey);return Tag.tempScopeObj=scope,value=eval(value),delete Tag.tempScopeObj,value},Tag.actions={},Tag.prototype.done=function(e){return e?void this.conductor.wait(this,e):void(this.conductor&&this.conductor.trigger(this))},Tag.prototype.error=function(e,t){var r="エラー: ";if(t&&(r="警告: "),this.file&&(r+="ファイル: "+this.file.filename+" / "),void 0!==this.originalLineNumber?r+="行: "+this.originalLineNumber+" / ":void 0!==this.lineNumber&&(r+="行: "+this.lineNumber+" / "),r+="タグ: "+this.tagName+" ",r+=e,!t)throw o2.error(r,this),"";o2.warn(r,this)},Tag.prototype.warn=function(e){this.error(e,!0)},Tag.prototype.clone=function(){return this},Tag.prototype.toJSON=function(){return config.saveMode==o2.SAVE_MODE_KAG3?{file:this.file.toRestorable(),label:this.args.name,initializer:"Tag"}:this.toRestorable()},Tag.prototype.toRestorable=function(){var e={initializer:"Tag"};return this.file&&(e.file=this.file.toRestorable()),void 0!==this.lineNumber&&(e.line=this.lineNumber),e.file||(e.tagName=this.tagName,e.args=this.args),void 0!==this.originalLineNumber&&(e.originalLineNumber=this.originalLineNumber),e},Tag.restore=function(e){return"file"in e&&"line"in e?$.when(e.file.restore()).then(function(t){return t.lines[e.line]}):"file"in e&&"label"in e?$.when(e.file.restore()).then(function(t){return t.getLabelTag(e.label)}):"tagName"in e?new Tag(e.tagName,e.args):(o2.error("タグを復元できない",e),{})};var TagAction=function(e){this.action=function(){};for(var t in e)this[t]=e[t]};Tag.actions.s=new TagAction({action:function(){return this.conductor!=conductor&&this.conductor!=extraConductor?2:(o2.skipMode=o2.SKIP_MODE_NONE,o2.reloadDelaySpeed(),2)}}),function(){var textTags=["text","ch","hch","emb","ruby"],styleTags=["style","resetstyle"],nonStopTags=textTags.concat(styleTags);Tag.actions.text=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(e){function t(){o2.skipMode=o2.SKIP_MODE_CLICK,$(o2).off("click",t)}var r=this.conductor.getNextTag();if(o2.currentMessageLayer.stackedTextsProperties||(o2.currentMessageLayer.stackedTextsProperties=[]),e.text.split("").forEach(function(e){var t=new TextProperties(e);$.extend(t.styles,clone(o2.currentMessageLayer.font)),o2.currentMessageLayer.currentRubyText&&(t.rubyText=o2.currentMessageLayer.currentRubyText,delete o2.currentMessageLayer.currentRubyText),o2.currentMessageLayer.stackedTextsProperties.push(t)}),r&&-1!=textTags.indexOf(r.tagName))return 0;var i=new HistoryRecord.String(o2.currentMessageLayer.stackedTextsProperties.map(function(e){return e.text}).join(""));o2.historyLayer.recorder.add(i);var n=clone(o2.currentMessageLayer.stackedTextsProperties),o=this;if(o2.currentMessageLayer.drawText(o2.currentMessageLayer.stackedTextsProperties,function(){$(o2).off("click",t),o.done()}),o2.currentMessageLayerWithBack){var a=o2.currentMessageLayer.getCorrespondingLayer();a.drawText(n)}return delete o2.currentMessageLayer.stackedTextsProperties,o2.clickSkipEnabled&&$(o2).on("click",t),1}}),Tag.actions.ch=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(e){var t=this.conductor.getNextTag();o2.currentMessageLayer.stackedTextsProperties||(o2.currentMessageLayer.stackedTextsProperties=[]);var r=new TextProperties(e.text);if($.extend(r.styles,clone(o2.currentMessageLayer.font)),o2.currentMessageLayer.currentRubyText&&(r.rubyText=o2.currentMessageLayer.currentRubyText,delete o2.currentMessageLayer.currentRubyText),o2.currentMessageLayer.stackedTextsProperties.push(r),t&&-1!=textTags.indexOf(t.tagName))return 0;var i=new HistoryRecord.String(o2.currentMessageLayer.stackedTextsProperties.map(function(e){return e.text}).join(""));o2.historyLayer.recorder.add(i);var n=this;if(o2.currentMessageLayer.drawText(o2.currentMessageLayer.stackedTextsProperties,function(){n.done()}),o2.currentMessageLayerWithBack){var o=o2.currentMessageLayer.getCorrespondingLayer();o.drawText(clone(o2.currentMessageLayer.stackedTextsProperties))}return delete o2.currentMessageLayer.stackedTextsProperties,1}}),Tag.actions.hch=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(e){o2.currentMessageLayer.vertical||this.warn("hchタグは縦書きの状態でしか実行できません");var t=this.conductor.getNextTag();o2.currentMessageLayer.stackedTextsProperties||(o2.currentMessageLayer.stackedTextsProperties=[]);var r=new TextProperties(e.text);if($.extend(r.styles,clone(o2.currentMessageLayer.font)),r.styles.vertical=!1,o2.currentMessageLayer.currentRubyText&&(r.rubyText=o2.currentMessageLayer.currentRubyText,delete o2.currentMessageLayer.currentRubyText),o2.currentMessageLayer.stackedTextsProperties.push(r),t&&-1!=textTags.indexOf(t.tagName))return 0;var i=new HistoryRecord.String(o2.currentMessageLayer.stackedTextsProperties.map(function(e){return e.text}).join(""));o2.historyLayer.recorder.add(i);var n=this;if(o2.currentMessageLayer.drawText(o2.currentMessageLayer.stackedTextsProperties,function(){n.done()}),o2.currentMessageLayerWithBack){var o=o2.currentMessageLayer.getCorrespondingLayer();o.drawText(clone(o2.currentMessageLayer.stackedTextsProperties))}return delete o2.currentMessageLayer.stackedTextsProperties,1}}),Tag.actions.emb=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},action:function(args){var value=eval(args.o2_exp),newTag=new Tag("text",{text:value});return this.conductor.queue.push(newTag),0}})}(),Tag.actions.ruby=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(e){return o2.currentMessageLayer.currentRubyText=e.text,o2.currentMessageLayerWithBack&&(o2.currentMessageLayer.getCorrespondingLayer().currentRubyText=e.text),0}}),Tag.actions.cm=new TagAction({action:function(e){for(var t=o2.foreLayers.messageLayers.concat(o2.backLayers.messageLayers),r=t.length-1;r>=0;r--){var i=t[r];i.resetMessageLayer()}return o2.historyLayer.recorder.options.repage&&o2.historyLayer.recorder.addPage(),0}}),Tag.actions.ct=new TagAction({action:function(e){var t=new Tag("cm");return t.run(),o2.currentMessageLayer=o2.foreLayers.messageLayers[0],o2.currentMessageLayerWithBack=!1,o2.historyLayer.recorder.options.repage&&o2.historyLayer.recorder.addPage(),0}}),Tag.actions.er=new TagAction({action:function(e){return o2.currentMessageLayer.resetMessageLayer(),o2.currentMessageLayerWithBack&&o2.currentMessageLayer.getCorrespondingLayer().resetMessageLayer(),o2.historyLayer.recorder.options.repage&&o2.historyLayer.recorder.addPage(),0}}),Tag.actions.current=new TagAction({rules:{layer:{type:"MESSAGE_LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},withback:{type:"BOOLEAN"}},action:function(e){var t=e.layer[e.page];return o2.currentMessageLayer=t,"withback"in e&&(o2.currentMessageLayerWithBack=e.withback),0}}),Tag.actions.position=new TagAction({rules:{layer:{type:"MESSAGE_LAYER"},page:{type:/fore|back/},left:{type:"INT"},top:{type:"INT"},width:{type:"INT"},height:{type:"INT"},frame:{type:"STRING"},color:{type:"COLOR"},opacity:{type:"FLOAT"},marginl:{type:"INT"},margint:{type:"INT"},marginr:{type:"INT"},marginb:{type:"INT"},vertical:{type:"BOOLEAN"},visible:{type:"BOOLEAN"}},action:function(e){var t;t=e.layer&&e.page?e.layer[e.page]:o2.currentMessageLayer;var r=!1,i=clone(t.rect);if("left"in e&&(i.x=e.left),"top"in e&&(i.y=e.top),"width"in e&&(i.width=e.width),"height"in e&&(i.height=e.height),t.setRect(i),"frame"in e)if(""===e.frame)t.setFrameImage();else{var n=this;ResourceLoader.loadImage(e.frame,!0).done(function(e){var r=new DrawableImage(e);t.setFrameImage(r)}).always(function(){setTimeout(function(){renderer.animator.requestFrame(),"visible"in e&&t.visible!=e.visible&&(t.visible=e.visible),n.done()})}),r=!0}return"color"in e&&(t.frameSolid.color=e.color),"opacity"in e&&(t.frameSolid.opacity=e.opacity/255),"marginl"in e&&(t.margin.left=e.marginl),"margint"in e&&(t.margin.top=e.margint),"marginr"in e&&(t.margin.right=e.marginr),"marginb"in e&&(t.margin.bottom=e.marginb),"vertical"in e&&(t.vertical=e.vertical),t.resetMessageLayer(),r?1:("visible"in e&&t.visible!=e.visible&&(t.visible=e.visible),renderer.animator.requestFrame(),0)}}),Tag.actions.delay=new TagAction({rules:{speed:{type:"INT",required:!0,allowString:["user","nowait"]}},action:function(e){"nowait"===e.speed?(sf.__system.chSpeed=0,sf.__system.useUserChSpeed=!1):"user"===e.speed?sf.__system.useUserChSpeed=!0:(sf.__system.chSpeed=parseFloat(e.speed),sf.__system.useUserChSpeed=!1),o2.reloadDelaySpeed()}}),Tag.actions.wc=new TagAction({rules:{time:{type:"INT",required:!0}},action:function(e){var t=e.time*o2.currentMessageLayer.delaySpeed,r=this;return setTimeout(function(){r.done()},t),1}}),function(){var e=void 0;Tag.actions.nowait=new TagAction({action:function(){return e=o2.currentMessageLayer.delaySpeed,o2.currentMessageLayer.delaySpeed=0,0}}),Tag.actions.endnowait=new TagAction({action:function(){return o2.currentMessageLayer.delaySpeed=e,0}})}(),Tag.actions.deffont=new TagAction({rules:{size:{type:"INT"},face:{type:"STRING"},color:{type:"COLOR"},rubysize:{type:"INT"},rubyoffset:{type:"INT"},edge:{type:"BOOLEAN"},edgecolor:{type:"COLOR"},bold:{type:"BOOLEAN"},o2_shadow:{type:"BOOLEAN"},o2_shadowcolor:{type:"COLOR"},o2_shadowblur:{type:"INT"},o2_shadowoffsetx:{type:"INT"},o2_shadowoffsety:{type:"INT"}},action:function(e){var t=o2.currentMessageLayer,r={rubysize:"rubySize",rubyoffset:"rubyOffset",edgecolor:"edgeColor",shadowcolor:"shadowColor",o2_shadow:"shadow",o2_shadowcolor:"shadowColor",o2_shadowblur:"shadowBlur",o2_shadowoffsetx:"shadowOffsetX",o2_shadowoffsety:"shadowOffsetY"};for(var i in e){var n=r[i]||i;t.defaultFont[n]=e[i],o2.currentMessageLayerWithBack&&(t.getCorrespondingLayer().defaultFont[n]=e[i])}if(e.face){var o=this;return ResourceLoader.loadFont(e.face,!0).always(function(){setTimeout(function(){o.done()})}),1}return 0}}),Tag.actions.font=new TagAction({rules:{size:{type:"INT",allowString:["default"]},face:{type:"STRING"},color:{type:"COLOR",allowString:["default"]},italic:{type:"BOOLEAN",allowString:["default"]},rubysize:{type:"INT",allowString:["default"]},rubyoffset:{type:"INT",allowString:["default"]},edge:{type:"BOOLEAN",allowString:["default"]},edgecolor:{type:"COLOR",allowString:["default"]},bold:{type:"BOOLEAN",allowString:["default"]},o2_shadow:{type:"BOOLEAN"},o2_shadowcolor:{type:"COLOR"},o2_shadowblur:{type:"INT"},o2_shadowoffsetx:{type:"INT"},o2_shadowoffsety:{type:"INT"}},action:function(e){var t={rubysize:"rubySize",rubyoffset:"rubyOffset",edgecolor:"edgeColor",shadowcolor:"shadowColor",o2_shadow:"shadow",o2_shadowcolor:"shadowColor",o2_shadowblur:"shadowBlur",o2_shadowoffsetx:"shadowOffsetX",o2_shadowoffsety:"shadowOffsetY"};for(var r in e){var i=t[r]||r;"default"===e[r]&&(e[r]=o2.currentMessageLayer.deffont[i]),o2.currentMessageLayer.font[i]=e[r],o2.currentMessageLayerWithBack&&(o2.currentMessageLayer.getCorrespondingLayer().font[i]=e[r])}if(e.face){var n=this;return ResourceLoader.loadFont(e.face,!0).always(function(){setTimeout(function(){n.done()})}),1}return 0}}),Tag.actions.resetfont=new TagAction({action:function(e){if(o2.currentMessageLayer.font=clone(o2.currentMessageLayer.defaultFont),o2.currentMessageLayerWithBack){var t=o2.currentMessageLayer.getCorrespondingLayer();t.font=clone(t.defaultFont)}}}),Tag.actions.defstyle=new TagAction({rules:{linespacing:{type:"INT"},pitch:{type:"INT"},linesize:{type:"INT"},o2_kinsoku:{type:/none|oidashi|burasagari-oidashi/},o2_kinsoku_bol_char:{type:"STRING"},o2_kinsoku_eol_char:{type:"STRING"},o2_kinsoku_burasagari_char:{type:"STRING"}},action:function(e){var t={linespacing:"lineSpacing",linesize:"lineSize",o2_kinsoku:"kinsoku",o2_kinsoku_bol_char:"kinsokuBolChar",o2_kinsoku_eol_char:"kinsokuEolChar",o2_kinsoku_burasagari_char:"kinsokuBurasagariChar",toback:{type:"BOOLEAN"}};if(o2.currentMessageLayerWithBack&&!e.toback){var r=clone(e);r.toback=!0;var i=new Tag("defstyle",r);this.conductor.queue.push(i)}var n=o2.currentMessageLayer;e.toback&&(n=n.getCorrespondingLayer());for(var o in e){var a=t[o]||o;n.defaultStyle[a]=e[o]}if("o2_kinsoku"in e)switch(e.o2_kinsoku){case"none":n.defaultStyle.kinsoku=MessageLayer.KINSOKU_NONE;break;case"oidashi":n.defaultStyle.kinsoku=MessageLayer.KINSOKU_OIDASHI;break;case"burasagari-oidashi":n.defaultStyle.kinsoku=MessageLayer.KINSOKU_BURASAGARI}return 0}}),Tag.actions.style=new TagAction({rules:{align:{type:/left|center|right|top|center|bottom|default/},linespacing:{type:"INT"},pitch:{type:"INT"},linesize:{type:"INT",allowString:["default"]},autoreturn:{type:"BOOLEAN",allowString:["default"]},o2_kinsoku:{type:/none|oidashi|burasagari-oidashi/},o2_kinsoku_bol_char:{type:"STRING"},o2_kinsoku_eol_char:{type:"STRING"},o2_kinsoku_burasagari_char:{type:"STRING"},toback:{type:"BOOLEAN"}},action:function(e){if(o2.currentMessageLayerWithBack&&!e.toback){var t=clone(e);t.toback=!0;var r=new Tag("style",t);this.conductor.queue.push(r)}var i=o2.currentMessageLayer;e.toback&&(i=i.getCorrespondingLayer()),"align"in e&&("default"==e.align?i.vertical?i.style.align="top":i.style.align="left":i.style.align=e.align),"linespacing"in e&&(i.vertical?i.textCursor.x-=e.linespacing-i.style.lineSpacing:i.textCursor.y+=e.linespacing-i.style.lineSpacing,i.style.lineSpacing=e.linespacing),"pitch"in e&&(i.style.pitch=e.pitch),"linesize"in e&&("default"==e.linesize?i.style.lineSize=-1:i.style.lineSize=e.linesize),"autoreturn"in e&&("default"==e.autoreturn&&(e.autoreturn=i.defaultStyle.autoReturn),i.style.autoReturn=e.autoreturn);var n={o2_kinsoku_bol_char:"kinsokuBolChar",o2_kinsoku_eol_char:"kinsokuEolChar",o2_kinsoku_burasagari_char:"kinsokuBurasagariChar"};for(var o in e)o in n&&(i.style[n[o]]=e[o]);if("o2_kinsoku"in e)switch(e.o2_kinsoku){case"none":i.style.kinsoku=MessageLayer.KINSOKU_NONE;break;case"oidashi":i.style.kinsoku=MessageLayer.KINSOKU_OIDASHI;break;case"burasagari-oidashi":i.style.kinsoku=MessageLayer.KINSOKU_BURASAGARI}}}),Tag.actions.resetstyle=new TagAction({rules:{toback:{type:"BOOLEAN"}},action:function(e){if(o2.currentMessageLayerWithBack&&!e.toback){var t=clone(e);t.toback=!0;var r=new Tag("resetstyle",t);this.conductor.queue.push(r)}var i=o2.currentMessageLayer;e.toback&&(i=i.getCorrespondingLayer()),i.vertical?i.textCursor.x-=o2.currentMessageLayer.defaultStyle.lineSpacing-o2.currentMessageLayer.style.lineSpacing:i.textCursor.y+=o2.currentMessageLayer.defaultStyle.lineSpacing-o2.currentMessageLayer.style.lineSpacing,
i.style=clone(i.defaultStyle)}}),Tag.actions.locate=new TagAction({rules:{x:{type:"INT"},y:{type:"INT"},toback:{type:"BOOLEAN"}},action:function(e){if(o2.currentMessageLayerWithBack&&!e.toback){var t=clone(e);t.toback=!0;var r=new Tag("locate",t);this.conductor.queue.push(r)}var i=o2.currentMessageLayer;return e.toback&&(i=i.getCorrespondingLayer()),"x"in e&&(i.textCursor.x=e.x+i.margin.left,i.vertical&&(i.textCursor.x-=i.style.lineSpacing)),"y"in e&&(i.textCursor.y=e.y+i.margin.top,i.vertical||(i.textCursor.y+=i.style.lineSpacing)),0}}),Tag.actions.r=new TagAction({action:function(){return o2.currentMessageLayer.linebreak(),o2.currentMessageLayerWithBack&&o2.currentMessageLayer.getCorrespondingLayer().linebreak(),o2.historyLayer.recorder.addCell(!0),0}}),function(){var e=void 0;Tag.actions.indent=new TagAction({action:function(){var t=o2.currentMessageLayer,r=t.margin.vertical;return r?(e=t.margin.top,t.margin.top=t.textCursor.y):(e=t.margin.left,t.margin.left=t.textCursor.x),0}}),Tag.actions.endindent=new TagAction({action:function(){var t=o2.currentMessageLayer,r=t.margin.vertical;return void 0===e&&o2.error("indentタグを先に実行してください"),r?t.margin.top=e:t.margin.left=e,0}})}(),Tag.actions.p=new TagAction({action:function(e){if(o2.historyLayer.recorder.addCell(!0),o2.autoMode){var t=this,r=o2.cancelAutoMode,i=setTimeout(function(){t.conductor===currentConductor&&(o2.cancelAutoMode=r,t.done())},sf.__system.autoModePageWait);return o2.cancelAutoMode=function(){return clearTimeout(i),t.conductor.wait("click"),o2.cancelAutoMode=r,r.apply(this,arguments)},1}return o2.skipMode<=o2.SKIP_MODE_PAGE&&(o2.skipMode=o2.SKIP_MODE_NONE),o2.skipMode?0:(o2.showGlyph("page"),this.conductor.wait("click",function(){o2.hideGlyph()}),1)}}),Tag.actions.l=new TagAction({action:function(){var e=this.conductor.isCurrentRead(),t=config.chNonStopToPageBreak||config.ch2ndNonStopToPageBreak&&e;if(t)return 0;if(o2.autoMode){var r=this,i=o2.cancelAutoMode,n=setTimeout(function(){r.conductor===currentConductor&&(o2.cancelAutoMode=i,r.done())},sf.__system.autoModeLineWait);return o2.cancelAutoMode=function(){return clearTimeout(n),o2.showGlyph("line"),r.conductor.wait("click"),o2.cancelAutoMode=i,i.apply(this,arguments)},1}return o2.skipMode<=o2.SKIP_MODE_CLICK&&(o2.skipMode=o2.SKIP_MODE_NONE),o2.skipMode?0:(o2.showGlyph("line"),this.conductor.wait("click",function(){o2.hideGlyph()}),1)}}),Tag.actions.button=new TagAction({rules:{graphic:{type:"STRING",required:!0},graphickey:{type:"COLOR",allowString:["adapt"]},storage:{type:"STRING"},target:{type:"STRING"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},o2_exp:{type:"STRING"},o2_onenter:{type:"STRING"},o2_onleave:{type:"STRING"}},action:function(e){var t=this;return ResourceLoader.loadImage(e.graphic).done(function(r){setTimeout(function(){var i=o2.currentMessageLayer.textCursor,n=new KAGButton(r,i.x,i.y);n.importFromKAGArgs(e),o2.currentMessageLayer.addButton(n),o2.currentMessageLayerWithBack&&o2.currentMessageLayer.getCorrespondingLayer().addButton(clone(n)),t.done()})}),1}});var KAGButton=function(e,t,r){Button.call(this,e,t,r),this.rect.width=Math.floor(this.rect.width/3),this.options.clipLeft=0,this.options.clipWidth=this.rect.width,this.tagArgs};KAGButton.prototype=Object.create(Button.prototype),KAGButton.prototype.initializer="KAGButton",KAGButton.prototype.clone=function(){var e=new KAGButton(this.image);return e.importFrom(this),e},KAGButton.prototype.drawOnContext=function(e,t){switch(this.state){case Button.STATE_HOVER:this.options.clipLeft=2*this.rect.width;break;case Button.STATE_DOWN:this.options.clipLeft=this.rect.width;break;case Button.STATE_NORMAL:default:this.options.clipLeft=0}Button.prototype.drawOnContext.apply(this,arguments)},KAGButton.prototype.importFromKAGArgs=function(args){args&&(this.tagArgs=clone(args),this.click=function(x,y,layer){if(Button.prototype.click.apply(this,arguments),args.o2_exp&&eval(args.o2_exp),args.o2_url&&window.open(args.o2_url,args.o2_urltarget),args.storage||args.target){var newTag=new Tag("jump",{storage:args.storage,target:args.target});currentConductor.queue.push(newTag)}layer.addButtonLinkImages(),layer.buttons=[],layer.links=[]},args.o2_onenter&&(this.enter=function(){Button.prototype.enter.apply(this,arguments),eval(args.o2_onenter)}),args.o2_onleave&&(this.leave=function(){Button.prototype.leave.apply(this,arguments),eval(args.o2_onleave)}))},KAGButton.prototype.importFrom=function(e){Button.prototype.importFrom.call(this,e),this.importFromKAGArgs(e.tagArgs)},KAGButton.prototype.importFromSaveData=function(e){Button.prototype.importFromSaveData.call(this,e),this.importFromKAGArgs(e.tagArgs)},KAGButton.prototype.toJSON=function(){var e=Button.prototype.toJSON.call(this);return e.tagArgs=this.tagArgs,e},KAGButton.restore=function(e){return $.when(ResourceLoader.loadImage(e.image,!0)).then(function(t){var r=new KAGButton(t);return r.importFromSaveData(e),r})},function(){KAGLink=function(){Link.call(this),this.tagArgs},KAGLink.prototype=Object.create(Link.prototype),KAGLink.prototype.initializer="KAGLink",KAGLink.restore=function(e){var t=new KAGLink;return t.importFromKAGArgs(e.tagArgs),delete e.tagArgs,Link.prototype.importFromSaveData(e),t},KAGLink.prototype.importFrom=function(e){Link.prototype.importFrom.call(this,e),this.importFromKAGArgs(e.tagArgs)},KAGLink.prototype.importFromKAGArgs=function(args){this.tagArgs=args,this.click=function(x,y,layer){if(Link.prototype.click.apply(this,arguments),"o2_exp"in args&&eval(args.o2_exp),"o2_url"in args&&window.open(args.o2_url,args.o2_urltarget),args.target||args.storage){var jumpTag=new Tag("jump",{target:this.tagArgs.target,storage:this.tagArgs.storage});currentConductor.queue.push(jumpTag)}layer.addButtonLinkImages(),layer.buttons=[],layer.links=[]},"o2_onenter"in args&&(this.enter=function(){Link.prototype.enter.apply(this,arguments),eval(args.o2_onenter)}),"o2_onleave"in args&&(this.leave=function(){Link.prototype.leave.apply(this,arguments),eval(args.o2_onleave)})};var initialTextLength=0,linkArgs={};Tag.actions.link=new TagAction({rules:{storage:{type:"STRING"},target:{type:"STRING"},color:{type:"COLOR"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},o2_onenter:{type:"STRING"},o2_onleave:{type:"STRING"},o2_exp:{type:"STRING"}},action:function(e){return initialTextLength=o2.currentMessageLayer.textsProperties.length,linkArgs=e,0}}),Tag.actions.endlink=new TagAction({action:function(e){var t=new KAGLink;t.importFromKAGArgs(linkArgs),t.vertical=o2.currentMessageLayer.vertical;for(var r=initialTextLength;r<o2.currentMessageLayer.textsProperties.length;r++)t.addTextProperties(o2.currentMessageLayer.textsProperties[r]);if(o2.currentMessageLayer.addLink(t),o2.currentMessageLayerWithBack){var i=o2.currentMessageLayer.getCorrespondingLayer(),t=new KAGLink;t.importFromKAGArgs(linkArgs),t.vertical=i.vertical;for(var r=initialTextLength;r<i.textsProperties.length;r++)t.addTextProperties(i.textsProperties[r]);i.addLink(t)}return 0}})}(),Tag.actions.image=new TagAction({rules:{storage:{type:"STRING",required:!0},layer:{type:"IMAGE_LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},grayscale:{type:"BOOLEAN"},rgamma:{type:"FLOAT"},ggamma:{type:"FLOAT"},bgamma:{type:"FLOAT"},rfloor:{type:"INT"},gfloor:{type:"INT"},bfloor:{type:"INT"},rceil:{type:"INT"},gceil:{type:"INT"},bceil:{type:"INT"},mcolor:{type:"COLOR"},mopacity:{type:"INT"},shadow:{type:"COLOR"},shadowopacity:{type:"INT",defaultValue:200},shadowx:{type:"INT",defaultValue:10},shadowy:{type:"INT",defaultValue:10},shadowblur:{type:"FLOAT",defaultValue:3},clipleft:{type:"INT"},cliptop:{type:"INT"},clipwidth:{type:"INT"},clipheight:{type:"INT"},flipud:{type:"BOOLEAN"},fliplr:{type:"BOOLEAN"},visible:{type:"BOOLEAN"},left:{type:"INT"},top:{type:"INT"},pos:{type:/left|left_center|center|right_center|right|l|lc|c|rc|r/},opacity:{type:"INT"},allowfail:{type:"BOOLEAN",defaultValue:!1},o2_zoom:{type:/[0-9]+(:[0-9]+)?/},o2_rotate:{type:"FLOAT"},o2_orx:{type:"FLOAT"},o2_ory:{type:"FLOAT"},o2_blur:{type:"INT"},o2_blurx:{type:"INT"},o2_blury:{type:"INT"},o2_blurmode:{type:/linear|constantalpha/}},preload:function(e){ResourceLoader.loadImage(e.storage,!1)},action:function(e){var t=this,r=e.layer[e.page],i={grayscale:!1,rGamma:1,gGamma:1,bGamma:1,rFloor:0,gFloor:0,bFloor:0,rCeil:255,gCeil:255,bCeil:255,tintColor:"#ff0000",tintOpacity:0,shadow:"#000000",shadowOpacity:200,shadowX:10,shadowY:10,shadowBlur:3,clipLeft:void 0,clipTop:void 0,clipWidth:void 0,clipHeight:void 0,flipUD:!1,flipLR:!1,visible:!0,opacity:255,blurX:0,blurY:0,blurMode:"linear"},n={rgamma:"rGamma",ggamma:"gGamma",bgamma:"bGamma",rfloor:"rFloor",gfloor:"gFloor",bfloor:"bFloor",rceil:"rCeil",gceil:"gCeil",bceil:"bCeil",mcolor:"tintColor",mopacity:"tintOpacity",shadowopacity:"shadowOpacity",shadowx:"shadowX",shadowy:"shadowY",shadowblur:"shadowBlur",clipleft:"clipLeft",cliptop:"clipTop",clipwidth:"clipWidth",clipheight:"clipHeight",flipud:"flipUD",fliplr:"flipLR",o2_blurx:"blurX",o2_blury:"blurY",o2_blurmode:"blurMode"};for(var o in e)if(-1==["storage","layer","page","allowfail","left","top","pos","o2_zoom","o2_rotate","o2_orx","o2_ory"].indexOf(o)){var a=n[o]||o;i[a]=e[o]}return"opacity"in i&&(r.opacity=i.opacity/255,i.opacity=1),"visible"in i&&(r.visible=i.visible,i.visible=!0),"shadowOpacity"in i&&(i.shadowOpacity/=255),"tintOpacity"in i&&(i.tintOpacity/=255),"o2_blur"in e&&("o2_blurx"in e||(i.blurX=e.o2_blur),"o2_blury"in e||(i.blurY=e.o2_blur)),r.loadImage(e.storage,i,e.allowfail).fail(function(){this.error("イメージファイル "+e.storage+" をロードできません")}).then(function(t){if("pos"in e){switch(e.pos){case"left":case"l":r.rect.x=config.scPositionX_left-t.rect.width/2;break;case"left_center":case"lc":r.rect.x=config.scPositionX_left_center-t.rect.width/2;break;case"center":case"c":r.rect.x=config.scPositionX_center-t.rect.width/2;break;case"right_center":case"rc":r.rect.x=config.scPositionX_right_center-t.rect.width/2;break;case"right":case"r":r.rect.x=config.scPositionX_right-t.rect.width/2}r.rect.y=config.scHeight-t.rect.height}else"left"in e&&(r.rect.x=e.left),"top"in e&&(r.rect.y=e.top);if(r.rect.width=Math.max(config.scWidth,t.rect.width),r.rect.height=Math.max(config.scHeight,t.rect.height),r.setRect(),"o2_zoom"in e){var i=1,n=1,o=e.o2_zoom.split(":");if(o.length>=2?(i=parseFloat(o[0]),n=parseFloat(o[1])):i=n=parseFloat(o[0]),isNaN(i)||isNaN(n))return this.error("o2_zoomが正しくありません。"),0;r.scaleX=i/100,r.scaleY=n/100}"o2_rotate"in e&&(r.rotation=e.o2_rotate/180*Math.PI),"o2_orx"in e?r.transformOrigin.x=e.o2_orx:r.transformOrigin.x=t.rect.width/2,"o2_ory"in e?r.transformOrigin.y=e.o2_ory:r.transformOrigin.y=t.rect.height/2}).then(function(){try{return KAGFiles(e.storage+".asd")}catch(t){return $.Deferred().reject()}}).then(function(e){var t=new AnimationConductor({file:e});r.addAnimationConductor(t,0),t.run()}).always(function(){setTimeout(function(){t.done()})}),1}}),Tag.actions.pimage=new TagAction({rules:{storage:{type:"STRING",required:!0},layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},allowfail:{type:"BOOLEAN",defaultValue:!1},dx:{type:"INT",required:!0},dy:{type:"INT",required:!0},sx:{type:"INT",defaultValue:0},sy:{type:"INT",defaultValue:0},sw:{type:"INT"},sh:{type:"INT"},opacity:{type:"INT"},o2_grayscale:{type:"BOOLEAN",defaultValue:!1},o2_rgamma:{type:"FLOAT"},o2_ggamma:{type:"FLOAT"},o2_bgamma:{type:"FLOAT"},o2_rfloor:{type:"INT"},o2_gfloor:{type:"INT"},o2_bfloor:{type:"INT"},o2_rceil:{type:"INT"},o2_gceil:{type:"INT"},o2_bceil:{type:"INT"},o2_mcolor:{type:"COLOR"},o2_mopacity:{type:"INT"}},action:function(e){var t=this;return ResourceLoader.loadImage(e.storage,!e.allowfail).done(function(r){var i=e.layer[e.page],n=new DrawableImage(r,e.dx,e.dy),o={sx:"clipLeft",sy:"clipTop",sw:"clipWidth",sh:"clipHeight",opacity:"opacity",o2_grayscale:"grayscale",o2_rgamma:"rGamma",o2_ggamma:"gGamma",o2_bgamma:"bGamma",o2_rfloor:"rFloor",o2_gfloor:"gFloor",o2_bfloor:"bFloor",o2_rceil:"rCeil",o2_gceil:"gCeil",o2_bceil:"bCeil",o2_mcolor:"tintColor",o2_mopacity:"tintOpacity"};for(var a in o)a in e&&(n.options[o[a]]=e[a]);"opacity"in n.options&&(n.options.opacity/=255),"tintOpacity"in n.options&&(n.options.tintOpacity/=255),i.addImage(n),setTimeout(t.done.bind(t))}),1}}),Tag.actions.freeimage=new TagAction({rules:{layer:{type:"IMAGE_LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"}},action:function(e){return e.layer[e.page].clearImage(),e.layer[e.page].clearAnimationConductors(),0}}),Tag.actions.backlay=new TagAction({rules:{layer:{type:"LAYER"}},action:function(e){var t=this;return renderer.animator.requestFrame(function(){if(e.layer)e.layer.back.importFrom(e.layer.fore);else for(var r=o2.allForeLayers(),i=o2.allBackLayers(),n=0;n<r.length;n++)r[n].moveTag||r[n].transTag,i[n].importFrom(r[n]);t.done()}),1}}),Tag.actions.copylay=new TagAction({rules:{srclayer:{type:"LAYER",required:!0},destlayer:{type:"LAYER",required:!0},srcpage:{type:/fore|back/,defaultValue:"fore"},destpage:{type:/fore|back/,defaultValue:"fore"}},action:function(e){var t=e.srclayer[e.srcpage],r=e.destlayer[e.destpage];if(t.initializer!=r.initializer)throw"srclayerとdestlayerに異なる種類のレイヤを指定することはできません";return r.importFrom(t),0}}),Tag.actions.o2_forelay=new TagAction({rules:{layer:{type:"LAYER"}},action:function(e){var t=this;return renderer.animator.requestFrame(function(){if(e.layer)e.layer.fore.importFrom(e.layer.back);else for(var r=o2.allForeLayers(),i=o2.allBackLayers(),n=0;n<r.length;n++)r[n].importFrom(i[n]);t.done()}),1}}),Tag.actions.layopt=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},visible:{type:"BOOLEAN"},left:{type:"INT"},top:{type:"INT"},opacity:{type:"INT"},autohide:{type:"BOOLEAN"},index:{type:"INT"},o2_zoom:{type:/[0-9]+(:[0-9]+)?/},o2_rotate:{type:"FLOAT"},o2_orx:{type:"FLOAT"},o2_ory:{type:"FLOAT"},o2_frameopacity:{type:"INT"},o2_userinteraction:{type:"BOOLEAN"}},action:function(e){var t=e.layer[e.page];if("visible"in e&&(t.visible=e.visible),"left"in e&&(t.rect.x=e.left),"top"in e&&(t.rect.y=e.top),"opacity"in e&&(t.opacity=e.opacity/255),"autohide"in e)if(e.autohide)-1==o2.extraAutoHideLayers.indexOf(t)&&o2.extraAutoHideLayers.push(t);else{var r=o2.extraAutoHideLayers.indexOf(t);-1!=r&&o2.extraAutoHideLayers.splice(r,1)}if("index"in e&&(t.index=e.index,o2.refreshRendererLayers()),"o2_zoom"in e){var i=1,n=1,o=e.o2_zoom.split(":");if(o.length>=2?(i=parseFloat(o[0]),n=parseFloat(o[1])):i=n=parseFloat(o[0]),isNaN(i)||isNaN(n))return this.error("o2_zoomが正しくありません。"),0;t.scaleX=i/100,t.scaleY=n/100}return"o2_rotate"in e&&(t.rotation=e.o2_rotate/180*Math.PI),"o2_orx"in e&&(t.transformOrigin.x=e.o2_orx),"o2_ory"in e&&(t.transformOrigin.y=e.o2_ory),"o2_frameopacity"in e&&(t instanceof MessageLayer?t.frameImage?(t.frameImage.options.opacity=e.o2_frameopacity/255,t.redrawRect(t.frameImage.rect)):(t.frameSolid.opacity=e.o2_frameopacity/255,t.redrawRect(t.frameSolid.rect)):this.error("メッセージレイヤー以外のレイヤーにo2_frameopacityを指定できないです")),"o2_userinteraction"in e&&(t.userInteractionEnabled=e.o2_userinteraction),renderer.animator.requestFrame(),0}}),Tag.actions.laycount=new TagAction({rules:{layers:{type:"INT"},messages:{type:"INT"}},action:function(e){if("layers"in e)if(e.layers>o2.foreLayers.imageLayers.length)for(var t=o2.foreLayers.imageLayers.length;t<e.layers;t++)o2.foreLayers.imageLayers.push(new ImageLayer),o2.backLayers.imageLayers.push(new ImageLayer);else if(e.layers<o2.foreLayers.imageLayers.length){var r=o2.foreLayers.imageLayers.length-e.layers;o2.foreLayers.imageLayers.splice(-r,r).concat(o2.backLayers.imageLayers.splice(-r,r)).forEach(function(e){e.destroy()})}if("messages"in e)if(e.messages>o2.foreLayers.messageLayers.length)for(var t=o2.foreLayers.messageLayers.length;t<e.messages;t++)o2.foreLayers.messageLayers.push(new MessageLayer),o2.backLayers.messageLayers.push(new MessageLayer);else if(e.messages<o2.foreLayers.messageLayers.length){var r=o2.foreLayers.messageLayers.length-e.messages;o2.foreLayers.messageLayers.splice(-r,r).concat(o2.backLayers.messageLayers.splice(-r,r)).forEach(function(e){e.destroy()})}return o2.resetLayersIndex(),o2.refreshRendererLayers(),renderer.animator.requestFrame(),0}}),Tag.actions.trans=new TagAction({rules:{time:{type:"INT",required:!0},layer:{type:"LAYER",defaultValue:"base"},children:{type:"BOOLEAN",defaultValue:!0},method:{type:"STRING",defaultValue:"crossfade"}},action:function(e){function t(){function t(){i.end||(Date.now()-o<e.time?renderer.animator.requestFrame(t):r())}if(!this.end)if(n)$.when(Tag.actions.trans.stopAllTransitions()).done(function(){Tag.actions.trans.runningTag=i;var t=$("#main-wrapper");i.container=$("<div />"),i.container.css({position:"absolute",width:t.width()+"px",height:t.height()+"px"}),t.append(i.container),i.container.append([renderer.foreCanvas,renderer.backCanvas]),i.method.transitAllLayers.call(i,e,renderer.backCanvas,renderer.foreCanvas,i.container),renderer.animator.requestFrame(function(){i.end||r()},e.time)});else{e.layer.fore.transit(this);var o=Date.now();t()}}function r(){i.end||(i.end=!0,n?$.when(Tag.actions.trans.stopAllTransitions()).done(function(){i.done()}):(e.layer.fore.stopTransition(),i.done()))}this.end=!1,this.transArgs=e,this.method=Tag.actions.trans.methods[e.method],this.method||this.error(e.method+" というメソッドは存在しません"),"canRun"in this.method&&!this.method.canRun()&&(this.method=Tag.actions.trans.methods.crossfade);var i=this,n=!1;return e.layer.fore==o2.foreLayers.baseLayer&&e.children&&(n=!0),this.method.transit||n||this.error("メソッド "+e.method+" を実行するにはlayer属性にbase、children属性にtrueを指定する必要があります"),renderer.renderBackCanvas=!0,"function"==typeof this.method.preload?this.method.preload.call(this,e).done(function(){renderer.animator.requestFrame(function(){t.call(i),i.done()})}):renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){t.call(i),i.done()})}),1},stopAllTransitions:function(){for(var e=o2.allForeLayers(),t=o2.allBackLayers(),r=0;r<e.length;r++)e[r].stopTransition();if(Tag.actions.trans.runningTag){var i=$.Deferred();renderer.renderBackCanvas=!1;for(var r=0;r<e.length;r++)e[r].importFrom(t[r]);return o2.refreshRendererLayers(),function(){var e=Tag.actions.trans.runningTag;renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){"function"==typeof e.method.teardownAllLayers&&e.method.teardownAllLayers.call(e,e.transArgs,renderer.backCanvas,renderer.foreCanvas,e.container),$(renderer.backCanvas).detach(),e.container&&(e.container.remove(),delete e.container),$("#main-wrapper").append(renderer.foreCanvas),i.resolve()})}),e.end=!0}(),Tag.actions.trans.runningTag=void 0,$(o2).trigger("transEnd"),i.promise()}},methods:{}}),TransMethod=function(e){for(var t in e)this[t]=e[t];e.transitAllLayers||(this.transitAllLayers=function(t,r,i,n){function o(){s.end||(Date.now()-a<t.time&&renderer.animator.requestFrame(o),e.transit.call(s,t,i,r,s.transCanvas))}$(r).hide(),$(i).hide(),this.transCanvas=document.createElement("canvas"),this.transCanvas.width=i.width,this.transCanvas.height=r.height,$(this.transCanvas).css({position:"absolute",x:0,y:0}),$(n).append(this.transCanvas),e.prepare.call(this,t);var a=Date.now(),s=this;o()},this.teardownAllLayers=function(t,r,i,n){"function"==typeof e.teardown&&e.teardown.call(this),$(r).show(),$(i).show(),$(this.transCanvas).remove(),this.transCanvas=null})},Tag.actions.stoptrans=new TagAction({action:function(){var e=this;return $.when(Tag.actions.trans.stopAllTransitions()).done(function(){setTimeout(function(){e.done()})}),1}}),Tag.actions.wt=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!0}},action:function(e){var t=o2.allForeLayers(),r=!0;if(Tag.actions.trans.runningTag)r=!1;else for(var i=t.length-1;i>=0;i--)if(t[i].isTransiting()){r=!1;break}if(r)return 0;if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode){var n=this;return $.when(Tag.actions.trans.stopAllTransitions()).done(function(){setTimeout(function(){n.done()})}),1}this.conductor.wait("click",function(){Tag.actions.trans.stopAllTransitions()})}return this.conductor.wait("trans"),1}}),Tag.actions.trans.methods.crossfade=new TransMethod({prepare:function(e){this.beginning=Date.now()},transit:function(e,t,r,i){var n=this,o=i.getContext("2d"),a=Date.now(),s=(a-this.beginning)/e.time;(s>=1||n.end)&&(s=1),o.save(),o.clearRect(0,0,i.width,i.height),o.globalAlpha=1,o.drawImage(t,0,0),o.globalAlpha=s,o.drawImage(r,0,0),o.restore()},teardown:function(){delete this.beginning},transitAllLayers:function(e,t,r,i){function n(){var r=(Date.now()-a)/e.time;o.end||renderer.animator.requestFrame(n),t.style.opacity=r}var o=this,a=Date.now();if(r.style.zIndex=1,t.style.zIndex=2,supportCssProperty("animationName")){var s="@-webkit-keyframes fade { \n0% { \n opacity: 0; \n} 100% { \n opacity: 1; \n}} \n";s+=s.replace(/-webkit-/g,"-moz-")+s.replace(/-webkit-/g,"-o-")+s.replace(/-webkit-/g,"");var c=document.createTextNode(s);this.cssTag=document.createElement("style"),this.cssTag.type="text/css",this.cssTag.appendChild(c),document.getElementsByTagName("head")[0].appendChild(this.cssTag),$(t).css("opacity",0),renderer.animator.requestFrame(function(){$(t).css({"animation-duration":e.time+"ms","animation-timing-function":e.timing_function||"linear","animation-name":"fade"})})}else renderer.animator.requestFrame(n)},teardownAllLayers:function(e,t,r,i){if(this.end=!0,this.cssTag)try{document.getElementsByTagName("head")[0].removeChild(this.cssTag)}catch(n){}$(t).css({opacity:1,"animation-duration":"","animation-timing-function":"","animation-name":""})}}),$.extend(Tag.actions.trans.rules,{from:{type:/left|top|right|bottom/,defaultValue:"left"},stay:{type:/stayfore|stayback|nostay/,defaultValue:"nostay"},o2_timing_function:{type:"STRING",defaultValue:"linear"}}),Tag.actions.trans.methods.scroll=new TransMethod({prepare:function(e){if(this.beginning=Date.now(),-1!=e.o2_timing_function.indexOf("cubic-bezier")){var t=e.o2_timing_function.replace("cubic-bezier","");if(t=t.replace("(",""),t=t.replace(")",""),t=t.split(",").map(function(e){return parseFloat(e)}),4!=t.length)throw"o2_timing_function属性のフォーマットが正しくありません";this.timingFunction=new KeySpline(t[0],t[1],t[2],t[3])}else switch(e.o2_timing_function){case"ease":this.timingFunction=new KeySpline(.25,.1,.25,1);break;case"ease-in":this.timingFunction=new KeySpline(.42,0,1,1);break;case"ease-out":this.timingFunction=new KeySpline(0,0,.58,1);break;case"ease-in-out":this.timingFunction=new KeySpline(.42,0,.58,1);break;default:this.timingFunction=new KeySpline(0,0,1,1)}},transit:function(e,t,r,i){var n=(Date.now()-this.beginning)/e.time,o=i.getContext("2d");n=this.timingFunction.get(n),o.clearRect(0,0,i.width,i.height);var a=drawY=0;if("stayback"!=e.stay)switch(e.from){case"top":drawY=i.height*n;break;case"right":a=-1*t.width*n;break;case"bottom":drawY=-1*t.height*n;break;default:a=i.width*n}o.drawImage(t,a,drawY,t.width,t.height);var s=r.height,c=r.width,u=0,l=0;if("stayfore"==e.stay)switch(a=drawY=0,e.from){case"top":s*=n;break;case"right":c*=n,u=(1-n)*r.width,a=u;break;case"bottom":s*=n,l=(1-n)*r.height,drawY=l;break;default:c*=n}else switch(e.from){case"top":drawY=r.height*(n-1);break;case"right":a=i.width*(1-n);break;case"bottom":drawY=(1-n)*i.height;break;default:a=r.width*(n-1)}c*s>0&&o.drawImage(r,u,l,c,s,a,drawY,c,s)},teardown:function(){delete this.beginning,delete this.timingFunction}}),$.extend(Tag.actions.trans.rules,{vague:{type:"INT",defaultValue:64},rule:{type:"STRING"},liveview:{type:"BOOLEAN",allowString:["auto"],defaultValue:"auto"},opaque:{type:"BOOLEAN",defaultValue:!0}}),Tag.actions.trans.methods.universal=new TransMethod({preload:function(e){if(!("rule"in e))throw"rule属性は必須です";var t=this;return this.liveview=function(){if(e.liveview===!0)return!0;if("auto"==e.liveview){var t;t=e.layer.fore==o2.foreLayers.baseLayer?o2.allLayers():e.layer;for(var r in t)if(t[r].moveTag)return!0}return!1}(),ResourceLoader.loadImage(e.rule).done(function(e){t.maskImage=e})},supportsArrayBuffer:function(){return window.ArrayBuffer&&window.Uint8Array&&window.Uint32Array}(),isLittleEndian:function(){if(!window.ArrayBuffer||!window.Uint8Array||!window.Uint32Array)return!1;var e=new ArrayBuffer(4),t=new Uint32Array(e),r=new Uint8Array(e);if(t[0]=3735928559,239==r[0])return!0;if(222==r[0])return!1;throw new Error("unknown endianness")}(),prepare:function(e){this.beginning=Date.now(),this.maskCanvas=document.createElement("canvas"),this.maskCanvas.width=this.maskImage.width,this.maskCanvas.height=this.maskImage.height,this.maskContext=this.maskCanvas.getContext("2d"),this.maskContext.drawImage(this.maskImage,0,0),this.maskData=this.maskContext.getImageData(0,0,this.maskCanvas.width,this.maskCanvas.height)},transit:function(e,t,r,i){var n=(Date.now()-this.beginning)/e.time;n>1&&(n=1);var o,a;if(!this.liveview&&this.beforeBitmap&&this.afterBitmap)o=this.beforeBitmap,a=this.afterBitmap;else{var s=t.getContext("2d"),c=r.getContext("2d"),u=s.getImageData(0,0,t.width,t.height),l=c.getImageData(0,0,r.width,r.height);a=l.data,o=u.data,this.liveview||(this.beforeBitmap=o,this.afterBitmap=a)}var h=e.vague,f=h+(h+255)*-n,d=this.maskData.data,p=i.getContext("2d"),g=p.createImageData(i.width,i.height),y=g.data;if(e.opaque&&Tag.actions.trans.methods.universal.supportsArrayBuffer&&a.buffer){this.maskCopyingCanvas?this.maskCopyingContext.clearRect(0,0,this.maskCopyingCanvas.width,this.maskCopyingCanvas.height):(this.maskCopyingCanvas=document.createElement("canvas"),this.maskCopyingCanvas.width=this.maskCanvas.width,this.maskCopyingCanvas.height=this.maskCanvas.height,this.maskCopyingContext=this.maskCopyingCanvas.getContext("2d"));var m=new Uint32Array(a.buffer),v=new Uint32Array(y.buffer);if(this.maskCanvas.width==i.width&&this.maskCanvas.height==i.height)if(Tag.actions.trans.methods.universal.isLittleEndian)for(var w=0,T=m.length;T>w;w++){var b=1-(d[w<<2]+f)/h;b=255*(b>1?1:0>b?0:b),v[w]=16777215&m[w]|(0|b)<<24}else for(var w=0,T=m.length;T>w;w++){var b=1-(d[w<<2]+f)/h;b=255*(b>1?1:0>b?0:b),v[w]=4294967040&m[w]|(0|b)}else{var L=i.width,x=this.maskCanvas.width,C=this.maskCanvas.height;if(Tag.actions.trans.methods.universal.isLittleEndian)for(var w=0,T=m.length;T>w;w++){var S=Math.floor(w/L);maskX=w%x,maskY=S%C,maskIndex=maskX+maskY*x;var b=1-(d[maskIndex<<2]+f)/h;b=255*(b>1?1:0>b?0:b),v[w]=16777215&m[w]|(0|b)<<24}else for(var w=0,T=m.length;T>w;w++){var S=Math.floor(w/L);maskX=w%x,maskY=S%C,maskIndex=maskX+maskY*x;var b=1-(d[w<<2]+f)/h;b=255*(b>1?1:0>b?0:b),v[w]=4294967040&m[w]|(0|b)}}this.maskCopyingContext.putImageData(g,0,0),p.drawImage(t,0,0),p.drawImage(this.maskCopyingCanvas,0,0)}else{if(this.maskCanvas.width==i.width&&this.maskCanvas.height==i.height)for(var w=0,T=y.length;T>w;w+=4){var b=1-(d[w]+f)/h;b=Math.max(0,Math.min(1,b)),y[w]=o[w]+(a[w]-o[w])*b,y[w+1]=o[w+1]+(a[w+1]-o[w+1])*b,y[w+2]=o[w+2]+(a[w+2]-o[w+2])*b,y[w+3]=255}else for(var L=i.width,x=this.maskCanvas.width,C=this.maskCanvas.height,w=0,T=y.length;T>w;w+=4){var k=w/4,S=Math.floor(w/4/L);maskX=k%x,maskY=S%C,maskIndex=4*(maskX+maskY*x);var b=1-(d[maskIndex]+f)/h;b=Math.max(0,Math.min(1,b)),y[w]=o[w]+(a[w]-o[w])*b,y[w+1]=o[w+1]+(a[w+1]-o[w+1])*b,y[w+2]=o[w+2]+(a[w+2]-o[w+2])*b,y[w+3]=255}p.putImageData(g,0,0)}},teardown:function(){delete this.beginning,delete this.maskCanvas,delete this.maskContext,delete this.maskData,delete this.maskImage,delete this.maskCopyingCanvas,delete this.maskCopyingContext}}),Tag.actions.move=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},spline:{type:"BOOLEAN"},time:{type:"INT",required:!0},delay:{type:"INT"},path:{type:"STRING"},accel:{type:"INT",defaultValue:0},o2_path:{type:"STRING"},o2_orx:{type:"FLOAT"},o2_ory:{type:"FLOAT"},o2_omit:{type:"STRING"},o2_override:{type:"BOOLEAN",defaultValue:!0}},action:function(e){var t=this,r=e.time,i=e.layer[e.page];if("o2_orx"in e&&(i.transformOrigin.x=e.o2_orx),"o2_ory"in e&&(i.transformOrigin.y=e.o2_ory),!("path"in e||"o2_path"in e))return this.error("path属性かo2_path属性のいずれかは必須です"),0;var n=function(e,t,r,i,n,o){this.x=e,this.y=t,this.opacity=r,this.zoomX=i,this.zoomY=n,this.rotation=o},o=/\((-?[0-9,\s:]+)*\)/g,a=[],s=e.path;"o2_path"in e&&(s=e.o2_path);var c=s.match(o);null==c&&this.error("path属性のフォーマットが正しくありません");var u={};"o2_omit"in e&&e.o2_omit.replace(/\s/g,"").split(",").forEach(function(e){u[e]=1}),a.push(new n(i.rect.x,i.rect.y,i.opacity,i.scaleX,i.scaleY,i.rotation));for(var l=0;l<c.length;l++){var h=c[l];h=h.replace("(","").replace(")",""),h=h.split(",");var f=new n,d=parseFloat(h[0]);isNaN(d)?f.x=a[a.length-1].x:f.x=d;var p=parseFloat(h[1]);isNaN(p)?f.y=a[a.length-1].y:f.y=p;var g=parseFloat(h[2]);isNaN(g)?f.opacity=a[a.length-1].opacity:f.opacity=g/255;var y=[];if(h.length>3){if(s==e.path)return this.error("path属性に4つ以上のパラメータを指定することはできません"),0;y=h[3].split(":")}2==y.length?(f.zoomX=parseFloat(y[0])/100||a[a.length-1].zoomX,f.zoomY=parseFloat(y[1])/100||a[a.length-1].zoomY):(f.zoomX=parseFloat(y[0])/100||a[a.length-1].zoomX,f.zoomY=parseFloat(y[0])/100||a[a.length-1].zoomY);var m=parseFloat(h[4]);isNaN(m)?f.rotation=a[a.length-1].rotation:f.rotation=m/180*Math.PI,a.push(f)}r=e.time*(a.length-1);var v;v=e.accel<-1?new KeySpline(.08,.44,.42,.93):e.accel>1?new KeySpline(.45,0,.97,.65):new KeySpline(0,0,1,1);var w=function(){i.moveTag&&e.o2_override&&(i.moveTag.end=!0),i.moveTag=this;var n=void 0;e.spline&&a.length>=2&&(n=B_Spline_Generator(a.map(function(e){return[e.x,e.y]})));var o=Date.now();renderer.animator.requestFrame(function s(){var e=Date.now(),c=e-o,l=c/r,h=1/(a.length-1);if(l>=1||t.end){l=1;var f=a[a.length-1];return u.x||(i.rect.x=f.x),u.y||(i.rect.y=f.y),u.opacity||(i.opacity=f.opacity),u.scaleX||(i.scaleX=f.zoomX),u.scaleY||(i.scaleY=f.zoomY),u.rotation||(i.rotation=f.rotation),$(o2).off("transEnd",T),T=null,t.end=!1,i.moveTag==t&&delete i.moveTag,void $(t).trigger("ended")}renderer.animator.requestFrame(s);var l=v.get(l),d=(a.length-1)*l,p=Math.floor(d),g=p+1,y=l/h-p;g>=a.length&&(g=a.length-1);var m,w=a[p],b=a[g];m=n?n(100*l):{x:w.x+(b.x-w.x)*y,y:w.y+(b.y-w.y)*y},u.x||(i.rect.x=m.x),u.y||(i.rect.y=m.y),u.opacity||(i.opacity=w.opacity+(b.opacity-w.opacity)*y),u.scaleX||(i.scaleX=w.zoomX+(b.zoomX-w.zoomX)*y),u.scaleY||(i.scaleY=w.zoomY+(b.zoomY-w.zoomY)*y),u.rotation||(i.rotation=w.rotation+(b.rotation-w.rotation)*y)})},T=function(){i.moveTag==t&&delete i.moveTag,i=i.getCorrespondingLayer(),i.moveTag=t};return $(o2).on("transEnd",T),e.delay?setTimeout(w.bind(this),e.delay):w.call(this),0}}),Tag.actions.stopmove=new TagAction({rules:{o2_layer:{type:"LAYER"},o2_page:{type:/fore|back/,defaultValue:"fore"}},action:function(e){var t;t=e.o2_layer?[e.o2_layer[e.o2_page]]:o2.allLayers();for(var r=t.length-1;r>=0;r--)t[r].moveTag&&(t[r].moveTag.end=!0);return 0}}),Tag.actions.wm=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!0},o2_layer:{type:"LAYER"},o2_page:{type:/fore|back/,defaultValue:"fore"}},action:function(e){function t(){o.forEach(function(e){e.moveTag.end=!0})}function r(){o.forEach(function(e){$(e.moveTag).off("ended",r),n.done()})}var i,n=this;i=e.o2_layer?[e.o2_layer[e.o2_page]]:o2.allLayers();var o=i.filter(function(e){return e.moveTag&&!e.moveTag.end}),a=o.length>0;if(!a)return 0;if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return t(),0;this.conductor.wait("click",t)}return o.forEach(function(e){$(e.moveTag).one("ended",r)}),1}}),function(){var e=!1,t=!1;Tag.actions.quake=new TagAction({rules:{time:{type:"INT",required:!0},hmax:{type:"INT",defaultValue:10},vmax:{type:"INT",defaultValue:10}},action:function(r){function i(){e=!0;for(var i=0;a>i;i++)s.push({x:Math.floor(Math.random()*r.hmax*2)-r.hmax,y:Math.floor(Math.random()*r.vmax*2)-r.vmax});s.push({x:0,y:0}),renderer.animator.requestFrame(function o(){var i=Date.now(),a=i-n,u=1/(s.length-1),l=a/r.time;l>1||t?(l=1,e=!1,t=!1,c.done()):renderer.animator.requestFrame(o);var h=(s.length-1)*l,f=Math.floor(h),d=f+1,p=l/u-f;d>=s.length&&(d=s.length-1);
var g=s[f],y=s[d];renderer.xShift=g.x+(y.x-g.x)*p,renderer.yShift=g.y+(y.y-g.y)*p})}var n=Date.now(),o=50,a=Math.ceil(r.time/o),s=[],c=this;return e?(t=!0,renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){i(),c.done()})}),1):(i(),0)}}),Tag.actions.stopquake=new TagAction({rules:{},action:function(r){return e&&(t=!0),0}}),Tag.actions.wq=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(r){if(!e)return 0;if(r.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return t=!0,0;this.conductor.wait("click",function(){t=!0})}return this.conductor.wait("quake"),1}})}(),Tag.actions.label=new TagAction({rules:{name:{type:"STRING",required:!0},caption:{type:"STRING"}},action:function(e){if(this.conductor!=conductor)return 0;if(conductor.stack.length)return this.error("[->]のタグ内にラベルを置いてはいけないです。"),0;if(o2.reloadDelaySpeed(),o2.skipMode!=o2.SKIP_MODE_UNREAD||this.conductor.isCurrentRead()||(o2.skipMode=o2.SKIP_MODE_NONE),"caption"in e&&config.saveMode==o2.SAVE_MODE_KAG3){if(currentConductor.macroStack.length)return this.error("セーブモードがkag3モードの場合、ラベルをマクロの中に置いてはいけない。"),0;""!=e.caption?saveCurrentState(e.caption):saveCurrentState()}return 0}}),Tag.actions.jump=new TagAction({rules:{storage:{type:"STRING"},target:{type:"STRING"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},disable_clear_stack:{type:"BOOLEAN",defaultValue:!1}},action:function(e){function t(t){if(t||n.error("シナリオファイル "+e.storage+" が見つかりません"),e.target){var r=e.target;"*"==r.charAt(0)&&(r=r.substring(1)),i=t.getLabelTag(r),i||n.error("ラベル "+r+" が見つかりません")}else i=t.lines[0];n.jumpToTag(i),e.disable_clear_stack||(n.conductor.clearIfStack(),n.conductor.clearMacroStack(),n.conductor.clearStack())}"o2_url"in e&&window.open(e.o2_url,e.o2_urltarget);var r,i,n=this;if(e.storage)r=KAGFiles(e.storage);else if(this.conductor.macroStack.length){var o=this.conductor.macroStack[this.conductor.macroStack.length-1];r=$.when(o.returnTag.restore()).then(function(e){return e.file})}else r=this.conductor.file;return r instanceof KAGFile?(t(r),0):($.when(r).then(function(e){t(e),n.done()}),1)}}),Tag.actions.call=new TagAction({rules:{storage:{type:"STRING"},target:{type:"STRING"}},action:function(e){var t=this.conductor.getNextTag();if(!t){var r=new Tag("jump",e);return this.conductor.queue.push(r),0}t=t.toRestorable(),this.conductor.callStack.push(t);var e=this.normalizedArgs();e.disable_clear_stack=!0;var r=new Tag("jump",e);return this.conductor.queue.push(r),0}}),Tag.actions["return"]=new TagAction({rules:{storage:{type:"STRING"},target:{type:"STRING"}},action:function(e){var t=this.conductor.callStack.pop();t||this.error("サブルーチン外でreturnタグを実行することはできません"),t=t.restore();var e=this.normalizedArgs();if(e.disable_clear_stack=!0,e.storage||e.target){var r=new Tag("jump",e);return this.conductor.queue.push(r),0}if(t instanceof Tag)return this.jumpToTag(t),0;var i=this;return $.when(t).then(function(e){setTimeout(function(){i.jumpToTag(e),i.done()})}),1}}),Tag.actions.macro=new TagAction({rules:{name:{type:"STRING",required:!0}},action:function(e){var t=new MacroDefinition({name:e.name.toLowerCase(),startTag:this.conductor.getNextTag().toRestorable()});this.conductor.macros[e.name.toLowerCase()]=t;var r=this.conductor.getNextTag("endmacro");return r||this.error("endmacroタグが見つかりません"),this.conductor.setTag(r,!0),0}}),Tag.actions.endmacro=new TagAction({action:function(e){return 0}}),Tag.actions.erasemacro=new TagAction({rules:{name:{type:"STRING",required:!0}},action:function(e){return delete this.conductor.macros[e.name],0}}),Tag.actions.seopt=new TagAction({rules:{buf:{type:"INT",defaultValue:0},volume:{type:"INT"},gvolume:{type:"INT"},pan:{type:"INT",defaultValue:0}},action:function(e){var t=o2.se[e.buf],r=Math.max(-100,Math.min(100,e.pan/100));return t?("volume"in e&&t.setVolume(e.volume/100),"pan"in e&&t.setPan(r),"gvolume"in e&&o2.setSeGVolume(e.gvolume/100),0):(this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0)}}),Tag.actions.playse=new TagAction({rules:{buf:{type:"INT",defaultValue:0},storage:{type:"STRING",required:!0},loop:{type:"BOOLEAN",defaultValue:!1},o2_start:{type:"TIME"},o2_block:{type:"BOOLEAN"}},action:function(e){var t=o2.se[e.buf];if(!t)return this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0;t.play(e.storage),t.setLoop(e.loop),"o2_start"in e&&t.setTime(e.o2_start);var r=this;return e.o2_block?(t.loadDefer.done(function(){setTimeout(function(){r.done()})}),1):0}}),Tag.actions.stopse=new TagAction({rules:{buf:{type:"INT",defaultValue:0}},action:function(e){var t=o2.se[e.buf];return t?(t.stop(),0):(this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0)}}),Tag.actions.fadese=new TagAction({rules:{buf:{type:"INT",defaultValue:0},volume:{type:"INT",required:!0},time:{type:"INT",required:!0}},action:function(e){var t=o2.se[e.buf];return t?(t.fade({toVolume:e.volume/100,duration:e.time}),0):(this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0)}}),Tag.actions.fadeinse=new TagAction({rules:{buf:{type:"INT",defaultValue:0},storage:{type:"STRING",required:!0},time:{type:"INT",required:!0},loop:{type:"BOOLEAN",defaultValue:!1},o2_start:{type:"TIME"},o2_volume:{type:"INT"},o2_block:{type:"BOOLEAN",defaultValue:!1}},action:function(e){var t=o2.se[e.buf];if(!t)return this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0;t.play(e.storage),t.setLoop(e.loop),"o2_start"in e&&t.setTime(e.o2_start),"o2_volume"in e&&t.setVolume(e.o2_volume/100),t.fade({fromVolume:0,duration:e.time});var r=this;return e.o2_block?(t.loadDefer.done(function(){setTimeout(function(){r.done()})}),1):0}}),Tag.actions.fadeoutse=new TagAction({rules:{buf:{type:"INT",defaultValue:0},time:{type:"INT",required:!0}},action:function(e){var t=o2.se[e.buf];return t?(t.fade({toVolume:0,duration:e.time,stopAfterFade:!0,finalVolume:0}),0):(this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0)}}),Tag.actions.wf=new TagAction({rules:{buf:{type:"INT",defaultValue:0},canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(e){var t=this,r=o2.se[e.buf];if(!r)return this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0;var i=r.fade(),n=!1;if(!i)return 0;if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return r.stopFade(),0;this.conductor.wait("click",function(){n=!0,r.stopFade()})}return i.done(function(){n||setTimeout(function(){t.done()})}),1}}),Tag.actions.ws=new TagAction({rules:{buf:{type:"INT",defaultValue:0},canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(e){var t=o2.se[e.buf];if(!t)return this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0;if(!t.isPlaying)return o2.warn("効果音は再生されてないから、このタグは無視されました"),0;if(t.loop)return o2.warn("効果音のループ再生中に再生終了を待つことはできないため、このタグは無視されました"),0;var r=this,i=!1;if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return t.stop(),0;this.conductor.wait("click",function(){i=!0,t.stop()})}return $(t).one("ended",function(){i||setTimeout(function(){r.done()})}),1}}),Tag.actions.bgmopt=new TagAction({rules:{volume:{type:"INT"},gvolume:{type:"INT"}},action:function(e){var t=o2.bgm;return"volume"in e&&t.setVolume(e.volume/100),"gvolume"in e&&o2.setBgmGVolume(e.gvolume/100),0}}),Tag.actions.playbgm=new TagAction({rules:{storage:{type:"STRING",required:!0},loop:{type:"BOOLEAN",defaultValue:!0},o2_start:{type:"TIME"},o2_block:{type:"BOOLEAN"}},action:function(e){var t=o2.bgm;t.stopFade(),t.play(e.storage),t.setLoop(e.loop),"o2_start"in e&&t.setTime(e.o2_start);var r=this;return e.o2_block?(t.loadDefer.done(function(){setTimeout(function(){r.done()})}),1):0}}),Tag.actions.pausebgm=new TagAction({action:function(){return o2.bgm.pause(),0}}),Tag.actions.resumebgm=new TagAction({action:function(){return o2.bgm.play(),0}}),Tag.actions.stopbgm=new TagAction({action:function(e){var t=o2.bgm;return t.stop(),0}}),Tag.actions.fadebgm=new TagAction({rules:{volume:{type:"INT",required:!0},time:{type:"INT",required:!0}},action:function(e){var t=o2.bgm;return t.fade({toVolume:e.volume/100,duration:e.time}),0}}),Tag.actions.fadeinbgm=new TagAction({rules:{storage:{type:"STRING",required:!0},time:{type:"INT",required:!0},loop:{type:"BOOLEAN",defaultValue:!0},o2_start:{type:"TIME"},o2_volume:{type:"INT"},o2_block:{type:"BOOLEAN",defaultValue:!1}},action:function(e){var t=o2.bgm;t.play(e.storage),t.setLoop(e.loop),"o2_start"in e&&t.setTime(e.o2_start),"o2_volume"in e&&t.setVolume(e.o2_volume/100),t.fade({fromVolume:0,duration:e.time});var r=this;return e.o2_block?(t.loadDefer.done(function(){setTimeout(function(){r.done()})}),1):0}}),Tag.actions.fadeoutbgm=new TagAction({rules:{time:{type:"INT",required:!0}},action:function(e){var t=o2.bgm;t.volume,t.fade({toVolume:0,duration:e.time,stopAfterFade:!0,finalVolume:t.volume});return 0}}),Tag.actions.fadepausebgm=new TagAction({rules:{time:{type:"INT",required:!0}},action:function(e){var t=o2.bgm,r=t.fade({toVolume:0,duration:e.time});return r&&r.done(function(){t.pause()}),0}}),Tag.actions.xchgbgm=new TagAction({rules:{storage:{type:"STRING",required:!0},loop:{type:"BOOLEAN",defaultValue:!0},time:{type:"INT",required:!0},overlap:{type:"INT",defaultValue:0},volume:{type:"INT"},o2_start:{type:"TIME"}},action:function(e){var t,r=this;if(t="volume"in e?e.volume/100:o2.bgm.volume,!browser.supportsMultipleAudio&&o2.prioritySound==o2.bgm)return o2.bgm.stop(),o2.bgm.setFile(e.storage).done(function(){setTimeout(function(){o2.bgm.play(),o2.bgm.setVolume(t),o2.bgm.setLoop(e.loop),"o2_start"in e&&o2.bgm.setTime(e.o2_start),r.done()})}),1;var i=new Sound,n=o2.bgm;return i.setFile(e.storage).done(function(){o2.bgm=i,$.when(n.fade({toVolume:0,duration:e.time,id:"old"})).done(function(){n.stop()}),setTimeout(function(){i.play(),"o2_start"in e&&i.setTime(e.o2_start),i.fade({fromVolume:0,toVolume:t,duration:e.time})},e.time-e.overlap),setTimeout(function(){r.done()})}),i.setLoop(e.loop),1}}),Tag.actions.wb=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(e){var t=this,r=o2.bgm,i=r.fade();if(!i)return 0;if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return r.stopFade(),0;this.conductor.wait("click",function(){r.stopFade()})}return i.done(function(){setTimeout(function(){t.done()})}),1}}),Tag.actions.wl=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(e){var t=this,r=o2.bgm;if(!r.isPlaying||r.loop)return o2.warn("BGMのループ再生中に再生終了を待つことはできないため、このタグは無視されました"),0;if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return r.stop(),0;this.conductor.wait("click",function(){r.stop()})}return $(r).one("ended",function(){setTimeout(function(){t.done()})}),1}}),function(){function getFirstTagInSameStackDepth(e,t){t||(t=currentConductor);var r=t.upComingTags(),i=0;"string"==typeof e&&(e=[e]);for(var n=0;n<r.length;n++){var o=r[n];if(0===i&&-1!==e.indexOf(o.tagName))return o;"if"===o.tagName&&i++,"endif"===o.tagName&&i--}}IfStatus=function(){this.conditionFulfilled=!1},Tag.actions["if"]=Tag.actions.ignore=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},action:function(args){var thisStatus=new IfStatus;this.conductor.ifStack.push(thisStatus);try{thisStatus.conditionFulfilled=eval(args.o2_exp)}catch(e){thisStatus.conditionFulfilled=!1}if("ignore"===this.tagName&&(thisStatus.conditionFulfilled=!thisStatus.conditionFulfilled),!thisStatus.conditionFulfilled){var targetTag=getFirstTagInSameStackDepth(["else","elsif","endif","endignore"],this.conductor);targetTag&&this.conductor.setTag(targetTag)}return 0}}),Tag.actions["else"]=new TagAction({action:function(e){var t=this.conductor.ifStack[this.conductor.ifStack.length-1];if(!t)return 0;if(t.conditionFulfilled){var r=getFirstTagInSameStackDepth(["endif","endignore"],this.conductor);r&&this.conductor.setTag(r)}return 0}}),Tag.actions.elsif=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},action:function(args){var currentStatus=this.conductor.ifStack[this.conductor.ifStack.length-1],skipThisBlock=!1;if(!currentStatus)return 0;if(currentStatus.conditionFulfilled)skipThisBlock=!0;else{var thisFulfilled;try{thisFulfilled=eval(args.o2_exp)}catch(e){thisFulfilled=!1}thisFulfilled?currentStatus.conditionFulfilled=!0:skipThisBlock=!0}if(skipThisBlock){var endIfTag=getFirstTagInSameStackDepth(["else","elsif","endif","endignore"],this.conductor);endIfTag&&this.conductor.setTag(endIfTag)}return 0}}),Tag.actions.endif=Tag.actions.endignore=new TagAction({action:function(e){return this.conductor.ifStack.pop(),0}}),Tag.actions["switch"]=new TagAction({rules:{val:{type:"STRING"}},action:function(e){this.value=e.val;var t=!1;return this.originalCase=this.conductor.tagActions["case"],this.conductor.tagActions["case"]=new TagAction({rules:{val:{type:"STRING"}},action:function(r){r.val==e.val&&(t=!0,this.conductor.setTag(this,!0))}}),this.originalDefault=this.conductor.tagActions["default"],this.conductor.tagActions["default"]=new TagAction({action:function(){t||this.conductor.setTag(this,!0)}}),this.conductor.setTag(this,!0),0},exitScope:function(){this.conductor.tagActions["case"]=this.originalCase,this.conductor.tagActions["default"]=this.originalDefault},closeAction:function(e){return 0}}),Tag.actions.foreach=new TagAction({rules:{val:{type:"OBJECT"},from:{type:"NUMBER",defaultValue:0},to:{type:"NUMBER"}},action:function(e){if(!("to"in e||"val"in e))return this.error("valかtoを指定してください。"),0;if(null!=e.val&&"object"==typeof e.val&&("to"in e||0!=e.from))return this.error("valがobjectの時、to/fromを使えない"),0;var t;if("val"in e&&(e.val instanceof Array&&!("to"in e)||null!=e.val&&"object"==typeof e.val)&&(t=Object.keys(e.val),e.to=t.length-1),this.loopStatus={index:e.from,shouldLoop:function(){return this.index<=e.to},getValues:function(){if(e.val instanceof Array)return[e.val[this.index],this.index];if("object"==typeof e.val){var r=t[this.index],i=e.val[r];return[r,i]}return[this.index]},next:function(){this.index++}},this.loopStatus.shouldLoop()){var r=this.loopStatus.getValues();this.setScopeVars(r),this.conductor.setTag(this,!0)}return 0},exitScope:function(){delete this.loopStatus},closeAction:function(e){var t=e.loopStatus;return t.next(),t.shouldLoop()&&(e.setScopeVars(t.getValues()),this.conductor.setTag(e,!0),this.keepStack()),0}})}(),function(){var e=void 0;Tag.actions.wait=new TagAction({rules:{time:{type:"INT",required:!0},mode:{type:/normal|until/,defaultValue:"normal"},canskip:{type:"BOOLEAN",defaultValue:!0}},action:function(t){var r=this;if("until"===t.mode&&(t.time=e+t.time-Date.now(),t.time<=0))return 0;var i=setTimeout(function(){r.done()},t.time);if(t.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return clearTimeout(i),0;this.conductor.wait("click",function(){clearTimeout(i)})}return 1}}),Tag.actions.resetwait=new TagAction({action:function(t){return e=Date.now(),0}})}(),Tag.actions.waitclick=new TagAction({action:function(e){return this.conductor.wait("click",function(){o2.skipMode=o2.SKIP_MODE_NONE}),1}}),Tag.actions.cancelskip=new TagAction({action:function(e){return o2.skipMode=o2.SKIP_MODE_NONE,0}}),Tag.actions.clickskip=new TagAction({rules:{enabled:{type:"BOOLEAN",required:!0}},action:function(e){return o2.clickSkipEnabled=e.enabled,0}}),Tag.actions.cancelautomode=new TagAction({action:function(){return o2.cancelAutoMode(),0}}),Tag.actions.eval=new TagAction({rules:{o2_exp:{type:"STRING"},func:{type:"FUNCTION"}},action:function(e){e.o2_exp||e.func||this.error("o2_expがないです");try{e.o2_exp?this.eval(e.o2_exp):e.func(e)}catch(t){}return 0}}),Tag.actions.o2_iscript=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},action:function(e){try{this.eval(e.o2_exp)}catch(t){}return 0}}),$(function(){function e(){r=[];for(var e=o2.autoHideLayers(),t=0;t<e.length;t++){var i=e[t];r.push(i.visible),i.visible=!1}renderer.animator.requestFrame()}function t(){if(r){for(var e=o2.autoHideLayers(),t=0;t<e.length;t++){var i=e[t];i.visible=r[t]}renderer.animator.requestFrame(),r=void 0,"p"==conductor.currentTag.tagName?o2.showGlyph("page"):"l"==conductor.currentTag.tagName&&o2.showGlyph("line")}}var r=void 0;$(o2).on("rclick",function(){if(-1!=["p","l","s"].indexOf(currentConductor.currentTag.tagName)&&o2.rclickSettings.enabled&&!r)if(o2.rclickSettings.call){extraConductor.setFile(conductor.file),currentConductor=extraConductor;var e=new Tag("jump",{target:o2.rclickSettings.target,storage:o2.rclickSettings.storage});extraConductor.queue.push(e)}else if(o2.rclickSettings.jump){var e=new Tag("jump",{target:o2.rclickSettings.target,storage:o2.rclickSettings.storage});currentConductor.queue.push(e)}else Tag.actions.rclick.hideMessageLayer()});var i=function(e){e.stopImmediatePropagation(),t(),$(o2).off("click",i),$(o2).off("rclick",i)};Tag.actions.rclick=new TagAction({rules:{call:{type:"BOOLEAN"},jump:{type:"BOOLEAN"},target:{type:"STRING"},storage:{type:"STRING"},enabled:{type:"BOOLEAN"}},action:function(e){if("call"in e&&e.call===!0&&"jump"in e&&e.jump===!0)return this.error("call属性とjump属性の両方にtrueを指定することはできません"),0;for(var t in e)e.hasOwnProperty(t)&&(o2.rclickSettings[t]=e[t]);return 0},hideMessageLayer:function(){e(),$(o2).bindFirst("click",i),$(o2).bindFirst("rclick",i)},showMessageLayer:function(){showMessageLayer()}}),Tag.actions.hidemessage=new TagAction({action:function(t){e();var r=this;return $(o2).bindFirst("click",i),$(o2).bindFirst("click",function n(){setTimeout(function(){r.done()}),$(o2).off("click",n)}),1}})}),function(){var e=void 0;Tag.actions.o2_request=new TagAction({rules:{method:{type:/get|post/i,required:!0},url:{type:"STRING",required:!0},req:{type:"STRING",required:!0},"return":{type:"STRING",defaultValue:"req"}},action:function(t){return e=$.ajax({url:t.url,type:t.method,data:t.req}).done(function(r,i,n){ev[t["return"]]={stat:n.status+" "+n.statusText,head:n.getAllResponseHeaders(),body:r},e=void 0}),0}}),Tag.actions.o2_wr=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!1},timeout:{type:"INT"}},action:function(t){function r(){n||(i.done(),n=!0)}if(!e)return 0;var i=this,n=!1;return e.done(function(){setTimeout(r)}),"timeout"in t&&setTimeout(r,t.timeout),t.canskip&&o2.clickSkipEnabled&&this.conductor.wait("click",function(){n=!0}),1}})}(),Tag.actions.title=new TagAction({rules:{name:{type:"STRING",required:!0}},action:function(e){return config.title=e.name,document.title=config.title,0}});var GestureRecognizer=function(e){for(var t in e)this[t]=e[t];this.state=GestureRecognizer.STATE.POSSIBLE,this.mutualExclusive=!0};GestureRecognizer.STATE={NONE:0,POSSIBLE:1,SATISIFIED:2,CANCELLED:3},GestureRecognizer.prototype.start=function(){},GestureRecognizer.prototype.move=function(){},GestureRecognizer.prototype.end=function(){},GestureRecognizer.prototype.cancel=function(){},GestureRecognizer.prototype.satisified=function(){this.manager&&this.manager.satisified(this)},GestureRecognizer.prototype.failed=function(){this.manager&&this.manager.failed(this)},GestureRecognizer.prototype.shouldCancelOtherRecognizer=function(e){return this.mutualExclusive},GestureRecognizer.prototype.shouldBeCancelled=function(e){return!0},GestureRecognizer.accumulateRecognizer=function(e,t,r,i,n){function o(n,o){function s(e){return e>=0&&1>=e}var c=n.x-a.startLocation.x,u=n.y-a.startLocation.y;return o&&(s(c/e)||s(c/t))&&(s(u/r)||s(u/i))?!0:(void 0==r||u>r)&&(void 0==i||i>u)&&(void 0==e||c>e)&&(void 0==t||t>c)}var a=new GestureRecognizer({startLocation:void 0,start:function(e){var t=e.originalEvent.normalizedCoordinate();a.startLocation=t,a.state=GestureRecognizer.STATE.POSSIBLE},move:function(e){if(a.startLocation){var t=e.originalEvent.normalizedCoordinate();o(t,!0)?o(t)&&(a.satisified(),n(),a.startLocation=void 0):a.cancel()}},end:function(e){if(a.startLocation){var t=e.originalEvent.normalizedCoordinate();o(t)?(a.satisified(),n()):a.cancel()}},cancel:function(){a.startLocation=void 0,a.failed()}});return a},GestureRecognizer.basicRecognizer=function(e,t){var r=new GestureRecognizer({startLocation:void 0,start:function(i){r.startLocation=i.originalEvent.normalizedCoordinate(),"absolute"==e?t("start",r.startLocation.x,r.startLocation.y):"delta"==e&&t("start",0,0),r.state=GestureRecognizer.STATE.POSSIBLE},move:function(i){if(r.startLocation){var n=i.originalEvent.normalizedCoordinate(),o=n.x-r.startLocation.x,a=n.y-r.startLocation.y;"absolute"==e?t("move",n.x,n.y):"delta"==e&&t("move",o,a)}},end:function(i){if(r.startLocation){var n=i.originalEvent.normalizedCoordinate(),o=n.x-r.startLocation.x,a=n.y-r.startLocation.y;"absolute"==e?t("end",n.x,n.y):"delta"==e&&t("end",o,a),r.satisified(),r.startLocation=void 0}},cancel:function(){r.startLocation=void 0,r.failed()}});return r},GestureRecognizer.longTapRecognizer=function(e,t,r){var i=new GestureRecognizer({startDate:void 0,startLocation:void 0,timer:void 0,start:function(t){i.startDate=Date.now(),i.startLocation=t.originalEvent.normalizedCoordinate(),i.state=GestureRecognizer.STATE.POSSIBLE,clearTimeout(i.timer),i.timer=setTimeout(function(){i.startDate=void 0,i.startLocation=void 0,i.timer=void 0,i.satisified(),r()},e)},move:function(e){if(i.startLocation){var r=e.originalEvent.normalizedCoordinate(),n=r.x-i.startLocation.x,o=r.y-i.startLocation.y;(n>t||o>t)&&i.cancel()}},end:function(e){i.cancel()},cancel:function(){i.startDate=void 0,i.startLocation=void 0,clearTimeout(i.timer),i.timer=void 0,i.failed()}});return i};var GestureManager={isProcessingEvent:!1,recognizers:[],addRecognizer:function(e){e.manager=this,this.recognizers.push(e)},removeRecognizer:function(e){var t=this.recognizers.indexOf(e);-1!=t&&this.recognizers.splice(t,1)},satisified:function(e){e.state=GestureRecognizer.STATE.SATISIFIED;for(var t=0;t<this.recognizers.length;t++){var r=this.recognizers[t];r!=e&&e.shouldCancelOtherRecognizer(r)&&r.shouldBeCancelled(e)&&r.cancel()}},failed:function(e){e.state=GestureRecognizer.STATE.CANCELLED},resetIfPossible:function(){var e=this.recognizers.filter(function(e){return e.state==GestureRecognizer.STATE.POSSIBLE});if(!e.length)for(var t=0;t<this.recognizers.length;t++){var r=this.recognizers[t];r.state=GestureRecognizer.STATE.NONE}},eventHandlers:{start:function(e){GestureManager.isProcessingEvent=!0;for(var t=GestureManager.recognizers.length-1;t>=0;t--){var r=GestureManager.recognizers[t];r.state!=GestureRecognizer.STATE.CANCELLED&&r.start(e)}GestureManager.isProcessingEvent=!1},move:function(e){GestureManager.isProcessingEvent=!0;for(var t=GestureManager.recognizers.length-1;t>=0;t--){var r=GestureManager.recognizers[t];r.state!=GestureRecognizer.STATE.CANCELLED&&r.move(e)}GestureManager.isProcessingEvent=!1},end:function(e){GestureManager.isProcessingEvent=!0;for(var t=GestureManager.recognizers.length-1;t>=0;t--){var r=GestureManager.recognizers[t];r.state!=GestureRecognizer.STATE.CANCELLED&&r.end(e)}GestureManager.isProcessingEvent=!1,GestureManager.resetIfPossible()},cancel:function(e){GestureManager.isProcessingEvent=!0;for(var t=GestureManager.recognizers.length-1;t>=0;t--){var r=GestureManager.recognizers[t];r.cancel(e)}GestureManager.isProcessingEvent=!1,GestureManager.resetIfPossible()}}},HistoryRecord=function(){};HistoryRecord.prototype.toDrawable=function(e,t){return null},HistoryRecord.String=function(e){HistoryRecord.call(this),this.text=e},HistoryRecord.String.prototype=Object.create(HistoryRecord.prototype),HistoryRecord.String.prototype.initializer="HistoryRecord.String",HistoryRecord.String.prototype.toDrawable=function(e){return this.text.split("").map(function(t){var r=new TextProperties(t);return $.extend(r.styles,e.layer.font),r})};var HistoryCell=function(){this.records=[],this.controller=void 0,this.sizeCache=void 0};HistoryCell.prototype={initializer:"HistoryCell",records:[],objectToBeSerialized:function(e){switch(e){case"initializer":case"records":return this[e]}}},HistoryCell.PageBreakPrototype=function(){},HistoryCell.PageBreakPrototype.prototype=Object.create(HistoryCell.prototype),HistoryCell.PageBreakPrototype.prototype.toJSON=function(){return{initializer:"HistoryCell.PageBreakPrototype"}},HistoryCell.PageBreakPrototype.restore=function(){return HistoryCell.PageBreak},HistoryCell.PageBreak=new HistoryCell.PageBreakPrototype;var HistoryCellController=function(e,t){DrawableCanvas.call(this),this.cell=e,this.layer=t,this.needPrepare=!0,this.drawables=[],this.needRedrawChildren=!1,this.prepareDrawables(),this.drawChildren()};HistoryCellController.prototype=Object.create(DrawableCanvas.prototype),HistoryCellController.prototype.prepareDrawables=function(){this.needPrepare=!1;for(var e=[],t=0,r=this.cell.records.length;r>t;t++){var i=this.cell.records[t].toDrawable(this,e);i instanceof Drawable?e.push(i):i instanceof Array&&e.push.apply(e,i)}this.drawables=e;var n=e.filter(function(e){return e instanceof TextProperties}),o=new MessageLayer.textCustomizers.baseTextCustomizer(this.layer,[],n);o.timePassed=1/0,o.perform();for(var t=n.length-1;t>=0;t--){var a=n[t];this.layer.vertical?(a.rect.x+=this.layer.margin.right,a.rect.y-=this.layer.margin.top):(a.rect.x-=this.layer.margin.left,a.rect.y-=this.layer.margin.top)}if(this.layer.vertical)for(var s=n.reduce(function(e,t){return Math.min(t.rect.x,e)},1/0),t=0;t<n.length;t++)n[t].rect.x-=s;for(var t=0;t<e.length;t++){var c=e[t];c instanceof Link&&c.refreshRects()}this.cell.sizeCache={width:e.reduce(function(e,t){var r=t.frame();return Math.max(r.x+r.width,e)},0),height:e.reduce(function(e,t){var r=t.frame();return Math.max(r.y+r.height,e)},0)}},HistoryCellController.prototype.mousemove=function(e){var t=!1;if(this.rect.coverCoordinate(e.x,e.y))for(var r=e.x-this.rect.x,i=e.y-this.rect.y,n=0;n<this.drawables.length;n++){var o=this.drawables[n];if(o instanceof Link)o.isHovering(r,i)?(t=!0,o.hovering||(o.hovering=!0,this.needRedrawChildren=!0,this.layer.redrawRect(this.rect))):o.hovering&&(o.hovering=!1,this.needRedrawChildren=!0,this.layer.redrawRect(this.rect));else if(o instanceof Button){var a=o.rect.coverCoordinate(r,i);a&&o.state==Button.STATE_NORMAL?(o.enter(r,i,this),this.needRedrawChildren=!0,this.layer.redrawRect(this.rect)):a||o.state!=Button.STATE_HOVER||(o.leave(r,i,this),this.needRedrawChildren=!0,this.layer.redrawRect(this.rect))}}else for(var s=0;s<this.drawables.length;s++){var o=this.drawables[s];o instanceof Link&&o.hovering?(o.hovering=!1,this.needRedrawChildren=!0,this.layer.redrawRect(this.rect)):o instanceof Button&&o.state==Button.STATE_HOVER&&(o.leave(r,i,this),this.needRedrawChildren=!0,this.layer.redrawRect(this.rect))}return t},HistoryCellController.prototype.mouseup=function(e){var t=!1;if(this.rect.coverCoordinate(e.x,e.y))for(var r=e.x-this.rect.x,i=e.y-this.rect.y,n=0;n<this.drawables.length;n++){var o=this.drawables[n];o instanceof Link?o.isHovering(r,i)&&(t=!0,o.click()):o instanceof Button&&o.rect.coverCoordinate(r,i)&&(t=!0,o.state=Button.STATE_HOVER,o.click())}return t},HistoryCellController.prototype.drawChildren=function(){this.rect.width=this.cell.sizeCache.width,this.rect.height=this.cell.sizeCache.height,this.setRect(),this.ctx.clearRect(0,0,this.rect.width,this.rect.height),this.ctx.textBaseline="top";for(var e=0;e<this.drawables.length;e++){var t=this.drawables[e];t.drawOnContext(this.ctx)}},HistoryCellController.prototype.drawOnContext=function(e){this.needRedrawChildren&&this.drawChildren(),e.save(),this.drawables.length&&DrawableCanvas.prototype.drawOnContext.apply(this,arguments),e.restore()};var HistoryRecorder=function(e){this.options={enabled:!0,output:!0,repage:config.historyLayerEverypage},this.layer,this.cells=[],this.currentPage=0,this.pageCount=0,this.lineCount=0};HistoryRecorder.prototype.objectToBeSerialized=function(e){switch(e){case"layer":return}if(config.historyLayerStoreState||"cells"!==e&&"pageCount"!==e&&"lineCount"!==e)return this[e]},HistoryRecorder.prototype.importFromSaveData=function(e){this.clearAllRecords(),Object.prototype.importFromSaveData.call(this,e)},HistoryRecorder.prototype.add=function(e){if(this.options.output){if(!(e instanceof HistoryRecord))throw"history recordじゃないです";this.cells.length&&this.cells[this.cells.length-1]!==HistoryCell.PageBreak||this.addCell();var t=this.cells.length-1;this.cells[t].records.push(e),this.lineCount++,this.ensureHistoryLimit()}},HistoryRecorder.prototype.addCell=function(e){if(this.options.output){var t=this.cells.length-1;if(this.cells.length&&!this.cells[t].records.length&&this.cells[t]!=HistoryCell.PageBreak){if(!e)return;this.cells[t].records.push(new HistoryRecord.String(" "))}this.cells.push(new HistoryCell)}},HistoryRecorder.prototype.addPage=function(){if(this.options.output){var e=this.cells.length-1;this.cells[e]&&this.cells[e]!==HistoryCell.PageBreak&&(this.cells[e].records.length?this.cells.push(HistoryCell.PageBreak):(this.cells[e]=HistoryCell.PageBreak,this.addCell()),this.pageCount++,this.ensureHistoryLimit())}},HistoryRecorder.prototype.ensureHistoryLimit=function(){var e=config.historyLayerMaxPages||100,t=config.historyLayerMaxLines||1e3;if(this.pageCount>e){var r=this.cells.indexOf(HistoryCell.PageBreak);this.cells.splice(0,r+1)}if(this.lineCount>t){var i=this.cells.shift();return this.lineCount-=i.records.length,this.cells[0]===HistoryCell.PageBreak&&this.cells.shift(),i}},HistoryRecorder.prototype.clearAllRecords=function(){this.cells=[],this.pageCount=0,this.lineCount=0,this.currentPage=0};var HistoryLayer=function(){MessageLayer.call(this),this.frameSolid.opacity=.5,this.visible=!1,this.font.shadow=!1,this.font.edge=!1,this.font.size=36,this.recorder=new HistoryRecorder(this),this.contentOffset={x:0,y:0},this.visibleCellController=[],this.backgroundStay=config.historyLayerFrameFixed,this.animating=!1,this.animationOffset={x:0,y:0},this.animationContentOpacity=1,this.defaultFont.size=config.historyLayerFontHeight,this.defaultFont.face=config.historyLayerFontFace,this.defaultFont.color=config.historyLayerFontColor,this.defaultFont.shadow=config.historyLayerShadow,this.defaultFont.shadowColor=config.historyLayerShadowColor,this.defaultFont.shadowBlur=config.historyLayerShadowBlur,this.defaultFont.shadowOffsetX=config.historyLayerShadowOffsetX,this.defaultFont.shadowOffsetY=config.historyLayerShadowOffsetY,this.defaultFont.bold=config.historyLayerFontBold,this.defaultFont.edge=config.historyLayerEdge,this.defaultFont.edgeColor=config.historyLayerEdgeColor,this.font=clone(this.defaultFont),this.style.lineSize=config.historyLayerLineHeight,this.style.lineSpacing=0,this.frameSolid.color=config.historyLayerColor,this.frameSolid.opacity=config.historyLayerOpacity;var e=this;config.historyLayerFrame&&ResourceLoader.loadImage(config.historyLayerFrame,!1).done(function(t){e.frameImage=new DrawableImage(t,0,0)}),this.margin={top:config.historyLayerMarginT,right:config.historyLayerMarginR,bottom:config.historyLayerMarginB,left:config.historyLayerMarginL},setTimeout(function(){e.setRect({x:config.historyLayerCurrentPositionX,y:config.historyLayerCurrentPositionY,width:config.historyLayerCurrentWidth,height:config.historyLayerCurrentHeight})}),this.resetCursor(),this.originalGlyphShown=!1};HistoryLayer.prototype=Object.create(MessageLayer.prototype),HistoryLayer.prototype.objectToBeSerialized=function(e){switch(e){case"animating":case"textsProperties":case"buttons":case"links":case"images":case"visibleCellController":return;case"recorder":case"contentOffset":return this[e];case"visible":return!1}return MessageLayer.prototype.objectToBeSerialized.call(this,e)},HistoryLayer.prototype.importFromSaveData=function(e){return Layer.prototype.importFromSaveData.call(this,e)},HistoryLayer.prototype.drawOnContext=function(){Layer.prototype.drawOnContext.apply(this,arguments)},HistoryLayer.prototype.reloadVertical=function(){"auto"==config.historyLayerVertical?this.vertical=o2.currentMessageLayer.vertical:"true"==config.historyLayerVertical||1==config.historyLayerVertical?this.vertical=!0:this.vertical=!1,this.resetCursor()},HistoryLayer.prototype.mousemove=function(e){if(!this.visible)return!1;for(var t=!1,r=e.originalEvent.normalizedCoordinate(this),i=0;i<this.visibleCellController.length;i++){var n=this.visibleCellController[i],o=n.mousemove(r);o&&(t=!0)}return t||(t=MessageLayer.prototype.mousemove.apply(this,arguments)),
t},HistoryLayer.prototype.mouseup=function(e){if(!this.visible)return!1;for(var t=!1,r=e.originalEvent.normalizedCoordinate(this),i=0;i<this.visibleCellController.length;i++){var n=this.visibleCellController[i],o=n.mouseup(r);o&&(t=!0)}return t||(t=MessageLayer.prototype.mouseup.apply(this,arguments)),t},HistoryLayer.prototype.touchmoved=function(e){this.vertical?this.scrolled({x:e.x,y:0}):this.scrolled({x:0,y:e.y})},HistoryLayer.prototype.scrolled=function(e){if(!this.animating){if(this.reloadVertical(),this.vertical){if(!this.visible&&e.x<0){var t=-1!=["p","l","s"].indexOf(currentConductor.currentTag.tagName);if(!t)return;return void this.resetAndShow()}var r=this.visibleCellController[0],i=this.visibleCellController[this.visibleCellController.length-1],n=!0;if(!this.visibleCellController.length||r.rect.x+e.x>this.margin.left||r.rect.x+r.rect.width+e.x<this.margin.left||i.rect.x+i.rect.width+e.x<this.rect.width-this.margin.right||i.rect.x+e.x>this.rect.width-this.margin.right){if(this.visibleCellController.length){if(r.rect.x+e.x>this.margin.left&&e.x>0){var o=this.recorder.cells.indexOf(r.cell),a=this.recorder.cells[o+1];a&&(a.records.length||a==HistoryCell.PageBreak)||(n=!1,this.contentOffset.x=0,this.hide("right",!1)),a&&a===HistoryCell.PageBreak&&(n=!1,this.newerPage("right"))}if(r.rect.x+r.rect.width+e.x<this.margin.left,i.rect.x+i.rect.width+e.x<this.rect.width-this.margin.right&&e.x<0){var s=this.recorder.cells.indexOf(i.cell),c=this.recorder.cells[s-1];if(!c)return n=!1,this.contentOffset.x-=this.rect.width-this.margin.right-(i.rect.x+i.rect.width),void(this.visibleCellController=this.childrenAtContentOffset(this.contentOffset));c&&c===HistoryCell.PageBreak&&(n=!1,this.olderPage("left"))}i.rect.x-e.x>this.rect.width-this.margin.right}n&&(this.contentOffset.x-=e.x,this.visibleCellController=this.childrenAtContentOffset(this.contentOffset))}else this.contentOffset.x-=e.x,this.visibleCellController.forEach(function(t){t.rect.x+=e.x}),renderer.animator.requestFrame()}else{if(!this.visible&&e.y>0){var t=-1!=["p","l","s"].indexOf(currentConductor.currentTag.tagName);if(!t)return;return void this.resetAndShow()}var u=this.visibleCellController[0],l=this.visibleCellController[this.visibleCellController.length-1],n=!0;if(!this.visibleCellController.length||u.rect.y+u.rect.height+e.y<this.rect.height-this.margin.bottom||u.rect.y+e.y>this.rect.height-this.margin.bottom||l.rect.y+e.y>this.margin.top||l.rect.y+l.rect.height+e.y<this.margin.top){if(this.visibleCellController.length){if(u.rect.y+u.rect.height+e.y<this.rect.height-this.margin.bottom&&e.y<0){var h=this.recorder.cells.indexOf(u.cell),f=this.recorder.cells[h+1];f&&(f.records.length||f==HistoryCell.PageBreak)||(n=!1,this.contentOffset.y=0,this.hide("up",!1)),f&&f===HistoryCell.PageBreak&&(n=!1,this.newerPage())}if(u.rect.y+e.y>this.rect.height-this.margin.bottom,l.rect.y+e.y>this.margin.top&&e.y>0){var d=this.recorder.cells.indexOf(l.cell),p=this.recorder.cells[d-1];if(!p)return n=!1,this.contentOffset.y+=this.margin.top-l.rect.y,void(this.visibleCellController=this.childrenAtContentOffset(this.contentOffset));p&&p===HistoryCell.PageBreak&&(n=!1,this.olderPage())}l.rect.y+l.rect.height+e.y<this.margin.top}n&&(this.contentOffset.y+=e.y,this.visibleCellController=this.childrenAtContentOffset(this.contentOffset))}else this.contentOffset.y+=e.y,this.visibleCellController.forEach(function(t){t.rect.y+=e.y}),renderer.animator.requestFrame()}this.redrawRect()}},HistoryLayer.prototype.scrollToPageEnd=function(){this.vertical?this.contentOffset.x=0:this.contentOffset.y=0,this.redrawRect()},HistoryLayer.prototype.show=function(e,t){o2.skipMode=o2.SKIP_MODE_NONE,o2.cancelAutoMode(),void 0===t&&(t=this.backgroundStay),this.reloadVertical();var r=$.Deferred();if(this.animating||!this.recorder.options.enabled||!this.recorder.cells.length)return r.reject(),r.promise();this.animating=!0,this.visible=!0;var i=this,n=Date.now(),o=config.historyLayerCurrentPositionX,a=config.historyLayerCurrentPositionY,s=500,c=0,u=300;switch(e){case"left":c=300,u=0;break;case"right":c=-300,u=0;break;case"down":u=-300,c=0}t?this.animationContentOpacity=0:this.opacity=0;var l=new KeySpline(.08,.44,.42,.93);return renderer.animator.requestFrame(function h(){var e=(Date.now()-n)/s;e>=1?(e=1,i.animating=!1,r.resolve()):renderer.animator.requestFrame(h),e=l.get(e),t?(i.animationContentOpacity=e,i.animationOffset.x=c*(1-e),i.animationOffset.y=u*(1-e),i.redrawRect()):(i.opacity=e,i.rect.x=o+c*(1-e),i.rect.y=a+u*(1-e))}),this.redrawRect(),r.promise()},HistoryLayer.prototype.resetAndShow=function(){return this.scrollToPageEnd(),this.vertical?(this.contentOffset.x=0,this.visibleCellController=this.childrenAtContentOffset(this.contentOffset),this.show("left",!1)):(this.contentOffset.y=0,this.visibleCellController=this.childrenAtContentOffset(this.contentOffset),this.show("down",!1))},HistoryLayer.prototype.hide=function(e,t){void 0===t&&(t=this.backgroundStay),this.animating=!0;var r=this,i=Date.now(),n=this.rect.x,o=this.rect.y,a=500,s=this.vertical?300:0,c=this.vertical?0:-300;switch(e){case"left":s=-300,c=0;break;case"right":s=300,c=0;break;case"down":c=300,s=0}var u=$.Deferred(),l=new KeySpline(.45,0,.97,.65);return renderer.animator.requestFrame(function h(){var e=(Date.now()-i)/a;return e>=1?(e=1,r.animating=!1,r.visible=!1,r.textsProperties=[],t?(r.animationContentOpacity=1,r.animationOffset.x=0,r.animationOffset.y=0,r.redrawRect()):(r.rect.x=n,r.rect.y=o,r.opacity=0),void u.resolve()):(renderer.animator.requestFrame(h),e=l.get(e),void(t?(r.animationContentOpacity=1-e,r.animationOffset.x=s*e,r.animationOffset.y=c*e,r.redrawRect()):(r.opacity=1-e,r.rect.x=n+s*e,r.rect.y=o+c*e)))}),this.redrawRect(),u.promise()},function(){function e(e){return function(t,r,i){if(t instanceof HistoryCell&&(t=this.recorder.cells.indexOf(t)),void 0===r?r=this.recorder.cells.length-1:r instanceof HistoryCell&&(r=this.recorder.cells.indexOf(r)),t>r)throw"start cannot be larger than end";if(!this.recorder.cells[t]||!this.recorder.cells[r])throw"statr or end doesnt exist";for(var n=0,o=t;r>=o;o++)o==t&&i||o==r&&i||(n+=this.recorder.cells[o].sizeCache[e]);return n}}HistoryLayer.prototype.heightBetweenCells=e("height"),HistoryLayer.prototype.widthBetweenCells=e("width")}(),HistoryLayer.prototype.olderPage=function(e){e||(e="down");var t=this;if(this.vertical){var r=this.visibleCellController[this.visibleCellController.length-1],i=r.cell,n=this.widthBetweenCells(i),t=this;this.hide(e).done(function(){t.contentOffset.x=n,t.visibleCellController=t.childrenAtContentOffset(t.contentOffset),t.show(e)})}else{var o=this.visibleCellController[this.visibleCellController.length-1],a=o.cell,n=this.heightBetweenCells(a),t=this;this.hide(e).done(function(){t.contentOffset.y=n,t.visibleCellController=t.childrenAtContentOffset(t.contentOffset),t.show(e)})}},HistoryLayer.prototype.newerPage=function(e){e||(e="up");var t=this,r=t.visibleCellController[0],i=this.recorder.cells.indexOf(r.cell)+2;if(this.vertical){for(var n=this.widthBetweenCells(i),o=n-(this.rect.width-this.margin.left-this.margin.right),a=i;a<this.recorder.cells.length&&this.recorder.cells[a]!=HistoryCell.PageBreak;a++)i=a;var s=this.widthBetweenCells(i),c=Math.max(s,o);this.hide(e).done(function(){t.contentOffset.x=c,t.visibleCellController=t.childrenAtContentOffset(t.contentOffset),t.show(e)})}else{for(var u=this.heightBetweenCells(i),l=u-(this.rect.height-this.margin.top-this.margin.bottom),a=i;a<this.recorder.cells.length&&this.recorder.cells[a]!=HistoryCell.PageBreak;a++)i=a;var h=this.heightBetweenCells(i),c=Math.max(h,l);this.hide(e).done(function(){t.contentOffset.y=c,t.visibleCellController=t.childrenAtContentOffset(t.contentOffset),t.show(e)})}},HistoryLayer.prototype.children=function(){return MessageLayer.prototype.children.apply(this,arguments).concat(this.visibleCellController)},HistoryLayer.prototype.childrenAtContentOffset=function(e){if(e||(e=this.contentOffset),this.vertical){for(var t=0,r=[],i=!1,n=this.recorder.cells.length-1;n>=0;n--){var o=this.recorder.cells[n];if(o.sizeCache&&0!=o.sizeCache.width||(o.controller=new HistoryCellController(o,this)),t+=o.sizeCache.width,t>e.x&&t-o.sizeCache.width<this.rect.width-this.margin.right-this.margin.left+e.x){if(o.controller||(o.controller=new HistoryCellController(o,this)),o.controller.rect=new Rect({x:this.margin.left+(t-o.sizeCache.width)-e.x,y:this.margin.top,width:o.sizeCache.width,height:o.sizeCache.height}),o!=HistoryCell.PageBreak)r.push(o.controller);else if(r.length){o.controller=null,i=!0;break}}else o.controller&&(o.controller=null)}if(!i&&r.length&&r[r.length-1].rect.x+r[r.length-1].rect.width<this.rect.width-this.margin.right&&(i=!0),i){var a=r[r.length-1],s=this.rect.width-this.margin.right-(a.rect.x+a.rect.width);r.forEach(function(e){e.rect.x+=s})}return r}for(var c=0,r=[],u=!1,n=this.recorder.cells.length-1;n>=0;n--){var o=this.recorder.cells[n];if(o.sizeCache&&0!=o.sizeCache.height||(o.controller=new HistoryCellController(o,this)),c+=o.sizeCache.height,c>e.y&&c-o.sizeCache.height<this.rect.height-this.margin.top-this.margin.bottom+e.y){if(o.controller||(o.controller=new HistoryCellController(o,this)),o.controller.rect=new Rect({x:this.margin.left,y:this.rect.height-this.margin.bottom-c+e.y,width:o.sizeCache.width,height:o.sizeCache.height}),o==HistoryCell.PageBreak){o.controller=null,u=!0;break}r.push(o.controller)}else o.controller&&(o.controller=null)}if(!u&&r.length&&r[r.length-1].rect.y>this.margin.top&&(u=!0),u){var a=r[r.length-1],s=a.rect.y-this.margin.top;r.forEach(function(e){e.rect.y-=s})}return r},HistoryLayer.prototype.flush=function(){if(this.requestedFrame){this.requestedFrame=!1,this.stackedClearRect=new Rect,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.backgroundStay||this.ctx.translate(this.animationOffset.x,this.animationOffset.y);for(var e=this.children(),t=0;t<e.length;t++){var r=e[t];if(-1!=this.visibleCellController.indexOf(r))break;r.drawOnContext(this.ctx)}for(this.backgroundStay&&(this.ctx.translate(this.animationOffset.x,this.animationOffset.y),this.ctx.globalAlpha=this.animationContentOpacity),this.ctx.beginPath(),this.ctx.rect(this.margin.left,this.margin.top,this.rect.width-this.margin.left-this.margin.right,this.rect.height-this.margin.top-this.margin.bottom),this.ctx.clip();t<e.length;){var r=e[t];r.drawOnContext(this.ctx),t++}this.ctx.restore(),this.resetCursor()}},Tag.actions.history=new TagAction({rules:{output:{type:"BOOLEAN"},enabled:{type:"BOOLEAN"}},action:function(e){return"output"in e&&(o2.historyLayer.recorder.options.output=e.output),"enabled"in e&&(o2.historyLayer.recorder.options.enabled=e.enabled),0}}),Tag.actions.hr=new TagAction({rules:{repage:{type:"BOOLEAN",defaultValue:!1}},action:function(e){return o2.historyLayer.recorder.options.repage&&e.repage?o2.historyLayer.recorder.addPage():o2.historyLayer.recorder.addCell(!0),0}}),Tag.actions.showhistory=new TagAction({action:function(e){if(!o2.historyLayer.visible){var t=this;o2.historyLayer.resetAndShow().done(function(){t.done()}).fail(function(){t.warn("ヒストリーレイヤを開けなかった。"),t.done()})}return 1}}),Tag.actions.o2_historytext=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(e){var t=new HistoryRecord.String(e.text);return o2.historyLayer.recorder.add(t),0}}),function(){var initialTextLength=-1,originalArgs={};HistoryRecord.LinkStart=function(e){this.args=e},HistoryRecord.LinkStart.prototype=Object.create(HistoryRecord.prototype),HistoryRecord.LinkStart.prototype.initializer="HistoryRecord.LinkStart",HistoryRecord.LinkStart.prototype.toDrawable=function(e,t){initialTextLength=t.length,originalArgs=this.args},HistoryRecord.LinkEnd=function(){},HistoryRecord.LinkEnd.prototype=Object.create(HistoryRecord.prototype),HistoryRecord.LinkEnd.prototype.initializer="HistoryRecord.LinkEnd",HistoryRecord.LinkEnd.prototype.toDrawable=function(controller,drawables){if(initialTextLength>=0){var drawablesInLink=drawables.slice(initialTextLength);initialTextLength=-1;var newLink=new Link;return newLink.color="#ff0000",newLink.vertical=controller.layer.vertical,newLink.addTextProperties(drawablesInLink),function(originalArgs){newLink.click=function(){eval(originalArgs.o2_exp)}}(originalArgs),newLink}},Tag.actions.hact=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},action:function(e){var t=new HistoryRecord.LinkStart(e);return o2.historyLayer.recorder.add(t),0}}),Tag.actions.endhact=new TagAction({action:function(){var e=new HistoryRecord.LinkEnd;return o2.historyLayer.recorder.add(e),0}})}();var Video=function(){this.element=document.createElement("video"),this.element.setAttribute("webkit-playsinline",!0),this.filepath,this.rect=new Rect(0,0,320,240),this.loop=!1,this.outputs=[],this.volume=1,this.mode=Video.MODE_OVERLAY,this.loadDefer};Video.prototype.toJSON=function(){return{rect:this.rect,loop:this.loop,outputs:this.outputs,volume:this.volume,mode:this.mode,currentTime:this.element.currentTime,paused:this.paused(),filepath:this.filepath}},Video.prototype.importFromSaveData=function(e){var t=$.Deferred();e.filepath&&(this.setFile(e.filepath),delete e.filepath),"paused"in e&&(e.paused?this.pause():this.play());return"currentTime"in e&&this.setTime(1e3*e.currentTime),t.resolve(),this.mode=e.mode,this.setVolume(e.volume),this.setLoop(e.loop),this.setRect(e.rect),t.promise()},Video.MODE_OVERLAY=0,Video.MODE_LAYER=1,Video.canPlayInline=function(){var e=null!=navigator.userAgent.match(/iPad/i);return!browser.isIOs||e}(),Video.prototype.setFile=function(e){if(Video.canPlayInline){this.filepath=e;var t=this;return this.loadDefer=ResourceLoader.loadVideo(e,!0,this.element).done(function(e){t.setLoop(),t.setRect(),t.setVolume(),$(e).on("ended",function(){$(t).trigger("ended")})}),this.loadDefer}},Video.prototype.setVisible=function(e){if(Video.canPlayInline){var t=document.getElementsByClassName("video-wrapper")[0],r=!!this.element.parentNode;r&&!e?t.removeChild(this.element):!r&&e&&t.appendChild(this.element)}},Video.prototype.setRect=function(e){e&&(this.rect=e);var t=this;this.loadDefer&&this.loadDefer.done(function(e){e.style.marginLeft=t.rect.x+"px",e.style.marginTop=t.rect.y+"px",e.width=t.rect.width,e.height=t.rect.height})},Video.prototype.setLoop=function(e){if(void 0!==e&&(this.loop=e),this.loadDefer){var t=this;this.loadDefer.done(function(e){e.loop=t.loop})}},Video.prototype.setPlaybackRate=function(e){this.loadDefer&&this.loadDefer.done(function(t){t.playbackRate=e})},Video.prototype.setVolume=function(e){if(void 0!==e&&(this.volume=e),this.loadDefer){var t=this;this.loadDefer.done(function(e){e.volume=t.volume})}},Video.prototype.setMode=function(){},Video.prototype.play=function(e){e&&this.setFile(e),this.element.play()},Video.prototype.pause=function(){this.element.pause()},Video.prototype.paused=function(){return this.element&&this.loadDefer?this.element.paused:!0},Video.prototype.stop=function(){this.pause(),this.setTime(0)},Video.prototype.setTime=function(e){this.loadDefer&&this.loadDefer.done(function(t){try{t.currentTime=e/1e3}catch(r){$(t).one("loadedmetadata",function(){t.currentTime=e/1e3})}})},Video.prototype.dummyLoad=function(){this.element.src="x",this.element.load()},Tag.actions.video=new TagAction({rules:{slot:{type:"INT",defaultValue:0},visible:{type:"BOOLEAN"},left:{type:"INT"},top:{type:"INT"},width:{type:"INT"},height:{type:"INT"},loop:{type:"BOOLEAN"},position:{type:"INT"},frame:{type:"INT"},mode:{type:/overlay|layer/i},playrate:{type:"FLOAT"},volume:{type:"FLOAT"}},action:function(e){var t=o2.videos[e.slot];if(!t)return this.error("ビデオスロット "+e.slot+" が存在しません"),0;"visible"in e&&t.setVisible(e.visible);var r=!1;return"left"in e&&(t.rect.x=e.left,r=!0),"top"in e&&(t.rect.y=e.top,r=!0),"width"in e&&(t.rect.width=e.width,r=!0),"height"in e&&(t.rect.height=e.height,r=!0),r&&t.setRect(),"loop"in e&&t.setLoop(e.loop),"position"in e&&t.setTime(e.position),"mode"in e&&("layer"==e.mode?t.setMode(Video.MODE_LAYER):t.setMode(Video.MODE_OVERLAY)),"playrate"in e&&t.setPlaybackRate(e.playrate),"volume"in e&&t.setVolume(e.volume/100),0}}),Tag.actions.videolayer=new TagAction({rules:{slot:{type:"INT",defaultValue:0},channel:{type:/1|2/,required:!0},page:{type:/fore|back/,required:!0},layer:{type:"LAYER",required:!0}},action:function(e){var t=o2.videos[e.slot];return t?(t.outputs[e.channel]=e.layer[e.page],0):(this.error("ビデオスロット "+e.slot+" が存在しません"),0)}}),Tag.actions.openvideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0},storage:{type:"STRING",required:!0}},action:function(e){var t=o2.videos[e.slot];if(!t)return this.error("ビデオスロット "+e.slot+" が存在しません"),0;try{t.setFile(e.storage)}catch(r){this.error(r)}return 0}}),Tag.actions.preparevideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(e){var t=this;return renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){t.done()})}),1}}),Tag.actions.playvideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0},storage:{type:"STRING"}},action:function(e){var t=o2.videos[e.slot];if(!t)return this.error("ビデオスロット "+e.slot+" が存在しません"),0;try{t.play(e.storage)}catch(r){this.error(r)}return 0}}),Tag.actions.pausevideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(e){var t=o2.videos[e.slot];return t?(t.pause(),0):(this.error("ビデオスロット "+e.slot+" が存在しません"),0)}}),Tag.actions.resumevideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(e){var t=o2.videos[e.slot];return t?(t.play(),0):(this.error("ビデオスロット "+e.slot+" が存在しません"),0)}}),Tag.actions.stopvideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(e){var t=o2.videos[e.slot];return t?(t.stop(),0):(this.error("ビデオスロット "+e.slot+" が存在しません"),0)}}),Tag.actions.rewindvideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(e){var t=o2.videos[e.slot];return t?(t.setTime(0),0):(this.error("ビデオスロット "+e.slot+" が存在しません"),0)}}),Tag.actions.wv=new TagAction({rules:{slot:{type:"INT",defaultValue:0},canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(e){var t=o2.videos[e.slot];if(!t)return this.error("ビデオスロット "+e.slot+" が存在しません"),0;if(t.paused())return 0;if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return t.stop(),0;this.conductor.wait("click",function(){t.stop()})}var r=this;return $(t).on("ended",function(){r.done()}),1}}),Object.defineProperty(Object.prototype,"objectToBeSerialized",{enumerable:!1,writable:!0,value:function(e){return this[e]}}),Object.defineProperty(Object.prototype,"toJSON",{enumerable:!1,writable:!0,value:function(){var e=this instanceof Array?[]:{};for(var t in this){var r=this.objectToBeSerialized(t);void 0!==r&&"function"!=typeof r&&(e[t]=r)}return e}}),function(){var e=[],t=[];Object.defineProperty(Object.prototype,"importFromSaveData",{enumerable:!1,writable:!0,value:function(r){var i=[],n=this;for(var o in r)!function(o){var a=n[o],s=r[o];if(e.push(o),"object"==typeof a&&null!==a){var c=a.importFromSaveData(s);c&&(c.stackName=e.join(">"),i.push(c),t.push(c),c.done(function(){t.splice(t.indexOf(c,1))}))}else{var u=!1;void 0!=s&&s.initializer&&(u=!0,i.push($.when(s.restore()).done(function(e){n[o]=e}))),u||(n[o]=s)}e.pop()}(o);return $.when.apply($,i).then(function(){return n})}})}(),Object.defineProperty(Object.prototype,"restore",{enumerable:!1,writable:!0,value:function(){if(this.initializer){var e=this.initializer.split("."),t=window;if(e.forEach(function(e){t=t[e]}),"function"==typeof t){if(t.restore!=Object.prototype.restore)return t.restore(this);var r=new t;return r.importFromSaveData(this)}}return this}}),function(){function e(){var e=JSON.stringify({o2:o2,f:f,mp:mp,conductor:conductor},function(e,t){var r=Object.prototype.toString.apply(t);return/\[object HTML[A-Za-z]*Element\]/.test(r)?void 0:"function"==typeof t?void 0:t});return e}function t(e){var t=document.createElement("canvas"),r=Math.min(config.scWidth,e),i=r/config.scWidth*config.scHeight;return t.width=r,t.height=i,t.getContext("2d").drawImage(renderer.foreCanvas,0,0,config.scWidth,config.scHeight,0,0,r,i),t.toDataURL()}var r,i=0;$(function(){$(o2).on("init",function(){$([conductor,extraConductor]).on("ran",function(e,t){0!=t&&saveCurrentSystemState()}),o2.serverStat.mode==o2.SERVER_MODE_O2SERVER?$(o2).on("systeminit.loggedin",function(){loadSystemStateFromServer()}):o2.serverStat.mode==o2.SERVER_MODE_STANDALONE&&loadSystemStateFromServer()})});var n=function(){};n.prototype={setItem:function(e,t){try{return localStorage[e]=t,$.Deferred().resolve()}catch(r){return $.Deferred().reject("localStorageの容量を超えました。"+r)}},getItem:function(e){return $.Deferred().resolve(localStorage[e])},deleteItem:function(e){return $.Deferred().resolve(delete localStorage[e])},setGlobalSaveData:function(e){var t=config.gameID+"_sf";return this.setItem(t,e)},getGlobalSaveData:function(){var e=$.Deferred(),t=config.gameID+"_sf";return this.getItem(t).then(function(t){var r;try{r=JSON.parse(t)}catch(i){return $.Deferred().reject(i)}for(var n=Object.keys(localStorage),o=new RegExp(config.gameID+"_([0-9]+)"),a=null,s={},c=0;c<n.length;c++){var a=n[c].match(o);a&&n[c]+"_date"in localStorage&&n[c]+"_caption"in localStorage&&(s[a[1]]={date:new Date(1e3*localStorage.getItem(n[c]+"_date")),caption:localStorage.getItem(n[c]+"_caption"),snapshot:localStorage.getItem(n[c]+"_screen")})}return e.resolve(r,s)})},setSaveData:function(e,t){var e=config.gameID+"_"+e,r=e+"_caption",i=e+"_date",n=e+"_screen";return $.when(this.setItem(e,t.data),this.setItem(r,t.caption),this.setItem(i,t.date),t.snapshot?this.setItem(n,t.snapshot):null)},getSaveData:function(e){var e=config.gameID+"_"+e;return this.getItem(e)},deleteSaveData:function(e){var e=config.gameID+"_"+e,t=e+"_caption",r=e+"_date",i=e+"_screen";return $.when(this.deleteItem(e),this.deleteItem(t),this.deleteItem(r),this.deleteItem(i))}};var o=function(){this.lastSentSystemStringTime=0,this.timerDefer,this.scheduledTimer,this.minimumRequestInterval=1e4};o.prototype=Object.create(n.prototype),$.extend(o.prototype,{setGlobalSaveData:function(e){function t(){return $.post(o2.serverStat.saveServer+"/api/1.2/globaldata/save.php",{sysvars:a,novel:config.gameID,key:o2.serverStat.skey,uid:o2.serverStat.uid})}function r(e){var t=$.Deferred();return setTimeout(function(){t.resolve()},e),t.promise()}if(-1==o2.serverStat.uid||this.waitingForSystemString)return $.Deferred().reject();if(Date.now()-this.lastSentSystemStringTime>this.minimumRequestInterval)return this.lastSentSystemStringTime=Date.now(),t();var i=this;return this.scheduledTimer||(this.timerDefer=$.Deferred().resolve().then(function(){return r(i.lastSentSystemStringTime+i.minimumRequestInterval-Date.now())}).then(function(){return t()}).done(function(){i.timerDefer=null,i.scheduledTimer=null,i.lastSentSystemStringTime=Date.now()})),this.timerDefer.promise()},getGlobalSaveData:function(e){if(-1==o2.serverStat.uid)return $.Deferred().reject();this.waitingForSystemString=!0;var t=this;return $.post(o2.serverStat.saveServer+"/api/1.2/globaldata/load.php",{novel:config.gameID,key:o2.serverStat.skey,uid:o2.serverStat.uid}).then(function(e){if("string"==typeof e&&(e=JSON.parse(e)),"ok"!==e.result)return $.Deferred().reject(e.reason);if("string"==typeof e.sysvars)try{e.sysvars=JSON.parse(e.sysvars)}catch(t){return $.Deferred().reject(t)}var r={};if("sindex"in e)for(var i=0;i<e.sindex.length;i++){var n=e.sindex[i];r[n.save_id]={date:new Date(1e3*n.updated_at),caption:n.caption,snapshot:n.screen}}return $.Deferred().resolve(e.sysvars,r)}).always(function(){t.waitingForSystemString=!1})},setSaveData:function(e,t){return $.when(Renderer.askForLogin()).then(function(){return $.post(o2.serverStat.saveServer+"/api/1.2/savedata/save.php",{uid:o2.serverStat.uid,novel:config.gameID,sindex:e,data:t.data,key:o2.serverStat.skey,screen:t.snapshot||"1",caption:t.caption})})},getSaveData:function(e){return Renderer.askForLogin().then(function(){return $.post(o2.serverStat.saveServer+"/api/1.2/savedata/load.php",{uid:o2.serverStat.uid,novel:config.gameID,sindex:e,key:o2.serverStat.skey})}).then(function(e){return"ok"!==e.result?$.Deferred().reject(e.reason):("string"==typeof e&&(e=JSON.parse(e)),e.data)})},deleteSaveData:function(e){return $.when(Renderer.askForLogin()).then(function(){return $.post(o2.serverStat.saveServer+"/api/1.2/savedata/erase.php",{uid:o2.serverStat.uid,novel:config.gameID,sindex:e,key:o2.serverStat.skey})})}}),window.loadSystemStateFromServer=function(){return o2.currentSaveAdapter.getGlobalSaveData().done(function(e,t){if(e){window.sf=mergeObj(e,sf);for(var r in t){var i=t[r];ev.save.date[r]=i.date,ev.save.caption[r]=i.caption,ev.save.snapshot[r]=i.snapshot}o2.setSeGVolume(),o2.setBgmGVolume()}})};var a;window.saveCurrentSystemState=function(){var e=$.Deferred();try{a=JSON.stringify(window.sf)}catch(t){o2.error("システム変数を保存できない。")}return r==a?e.reject():o2.currentSaveAdapter.setGlobalSaveData(a).done(function(){r=a})},window.saveCurrentState=function(r){return Tag.actions.save.stateString=e(),!i&&config.saveThumbnail&&(Tag.actions.save.stateScreenShot=t(config.thumbnailWidth)),void 0!=r&&(Tag.actions.save.stateCaption=r),Tag.actions.save.stateString},Tag.actions.save=new TagAction({rules:{place:{type:"INT",defaultValue:0},ask:{type:"BOOLEAN",defaultValue:!1}},action:function(e){if(void 0==Tag.actions.save.stateString)return config.saveMode==o2.SAVE_MODE_KAG3?o2.warn("一度もセーブ可能なラベルを通過していない状態でセーブを行おうとしました"):config.saveMode==o2.SAVE_MODE_O2KAG&&o2.warn("一度も o2_savestat タグが実行されていない状態でセーブを行おうとしました"),0;if(e.ask&&!confirm("本当にセーブしますか？"))return 0;i||(Tag.actions.save.stateScreenShot=t(config.thumbnailWidth)),ev.save.date[e.place]=new Date,ev.save.caption[e.place]=Tag.actions.save.stateCaption,ev.save.snapshot[e.place]=Tag.actions.save.stateScreenShot;var r=this;return Tag.actions.save.processForSlot(e.place).always(function(){setTimeout(function(){r.done()})}).fail(function(e){o2.warn("書き込みに失敗しました: "+e)}),1},processForSlot:function(e){return o2.currentSaveAdapter.setSaveData(e,{data:Tag.actions.save.stateString,caption:Tag.actions.save.stateCaption,date:Date.now()/1e3,snapshot:Tag.actions.save.stateScreenShot})},adapters:{LocalAdapter:n,O2ServerAdapter:o}}),Tag.actions.save.stateString=void 0,Tag.actions.save.stateCaption="",Tag.actions.save.stateScreenShot=void 0,Tag.actions.o2_savestat=new TagAction({rules:{caption:{type:"STRING"}},action:function(e){if(config.saveMode==o2.SAVE_MODE_KAG3)return this.warn("セーブモードがKAG3モードの時にo2_savestatタグを実行することはできません"),0;if(conductor.stack.length)return this.error("[->]のタグ内はセーブできないです。"),0;var t=this;return renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){saveCurrentState(e.caption),t.done()})}),1}}),Tag.actions.load=new TagAction({rules:{place:{type:"INT",defaultValue:0},ask:{type:"BOOLEAN",defaultValue:!1}},action:function(e){if(e.ask&&!confirm("本当にロードしますか？"))return 0;var t=this;return o2.currentSaveAdapter.getSaveData(e.place).then(Tag.actions.load.processData).done(function(t){Tag.actions.load.applyDeserializedData(t).done(function(){setTimeout(function(){Tag.actions.save.stateString=t,Tag.actions.save.stateCaption=ev.save.caption[e.place],Tag.actions.save.stateScreenShot=ev.save.snapshot[e.place],currentConductor!=conductor&&currentConductor.reset(),currentConductor=conductor,o2.refreshRendererLayers(),conductor.oneShot()})})}).fail(function(){o2.warn("読み込みに失敗しました"),t.done()}),1},processData:function(e){return e},applyDeserializedData:function(e){$("body").css("pointer-events","none"),renderer.animator.pause(),conductor.pause();var t=JSON.parse(e),r=t.conductor;delete t.conductor,window.f={};var i=window.importFromSaveData(t).then(function(){return conductor.importFromSaveData(r)}).done(function(){o2.allLayers().forEach(function(e){e.redrawRect()}),o2.setSeGVolume(),o2.setBgmGVolume(),$("body").css("pointer-events","auto"),renderer.animator.resume(),conductor.resume()});return i}}),Tag.actions.locksnapshot=new TagAction({action:function(e){return 0==i&&(Tag.actions.save.stateScreenShot=t(config.thumbnailWidth)),i++,0}}),Tag.actions.unlocksnapshot=new TagAction({action:function(){return i--,0>i&&this.error("unlocksnapshotの回数はlocksnapshotより多いです。"),0}}),Tag.actions.erasebookmark=new TagAction({rules:{place:{type:"INT",defaultValue:0}},action:function(e){delete ev.save.date[e.place],delete ev.save.caption[e.place],delete ev.save.snapshot[e.place];var t=this;return o2.currentSaveAdapter.deleteSaveData(e.place).always(function(){setTimeout(function(){t.done()})}),1}})}(),AnimationConductor=function(e){Conductor.call(this,e),this.layer,this.cellImage,this.canvas,this.isLooping=!1,e&&(this.startingLabelName=e.label),this.nextTagTime,this.shouldStop},AnimationConductor.prototype=Object.create(Conductor.prototype),AnimationConductor.prototype.initializer="AnimationConductor",AnimationConductor.prototype.importFrom=function(e){if(this.waitTag=clone(e.waitTag),this.setTag(e.currentTag),this.queue=clone(e.queue),this.status=e.status,this.callStack=clone(e.callStack),this.macroStack=clone(e.macroStack),this.macros=clone(e.macros),this.ifStack=clone(e.ifStack),this.layer=e.layer,e.cellImage&&(this.cellImage=clone(e.cellImage)),e.canvas&&(this.canvas=clone(e.canvas)),this.shouldStop=e.shouldStop,e.status!=Conductor.STATUS_STOP)if("wait"==e.currentTag.tagName){this.currentTag=e.currentTag,this.setTag(e.currentTag,!0);var t=(e.nextTagTime||Date.now())-Date.now(),r=this;setTimeout(function(){r.run()},t)}else this.run()},AnimationConductor.prototype.toJSON=function(){var e=this.layer&&0==this.layer.animationConductors.indexOf(this)||!this.canvas||this.isLooping;if(e)return{initializer:"AnimationConductor",file:this.file.filename,lineNumber:0,startingLabelName:this.startingLabelName}},AnimationConductor.restore=function(e){return $.when(KAGFiles(e.file)).then(function(t){var r=new AnimationConductor({file:t,label:e.startingLabelName});return r})},AnimationConductor.prototype.run=function(){var e=o2.debugLevel;o2.debugLevel=0,Conductor.prototype.run.apply(this,arguments),o2.debugLevel=e},AnimationConductor.prototype.addChildToLayer=function(){return this.canvas?(-1==this.layer.animationChildren.indexOf(this.canvas)&&this.layer.animationChildren.push(this.canvas),!0):!1},AnimationConductor.prototype.removeChildFromLayer=function(){var e=this.layer.animationChildren.indexOf(this.canvas);e>=0&&this.layer.animationChildren.splice(e,1)},AnimationConductor.prototype.wait=function(e,t){Conductor.prototype.wait.call(this,e)},AnimationConductor.prototype.stop=function(){this.removeChildFromLayer(),this.status!==Conductor.STATUS_STOP&&this.queue.push(new Tag("s"))},AnimationConductor.prototype.stopUntilHome=function(){this.shouldStop=!0},AnimationConductor.prototype.getTagAction=function(e){return AnimationConductor.tagActions||(AnimationConductor.tagActions={loadcell:new TagAction({rules:{storage:{type:"STRING"}},action:function(e){var t,r,i=this,n=this.conductor;try{r=this.conductor.layer.images[0],t=e.storage||r.image.originalURL+"_a"}catch(o){this.error("レイヤは画像がないです。")}return ResourceLoader.loadImage(t,!1).done(function(e){setTimeout(function(){var t=new DrawableImage(e,0,0);t.cacheEnabled=!1,t.reuseCanvas=!0,n.cellImage=t,n.canvas=new DrawableCanvas(r.rect),i.done()})}),1}}),copy:new TagAction({rules:{dx:{type:"INT",required:!0},dy:{type:"INT",required:!0},sx:{type:"INT",required:!0},sy:{type:"INT",required:!0},sw:{type:"INT",required:!0},sh:{type:"INT",required:!0}},action:function(e){this.conductor.addChildToLayer()||this.error("loadcellしていない状態でcopyタグを使おうとしてます");var t=this.conductor.canvas,r=t.canvas.getContext("2d"),i=this.conductor.cellImage;return i.options.clipLeft=e.sx,i.options.clipTop=e.sy,i.options.clipWidth=e.sw,i.options.clipHeight=e.sh,i.rect=new Rect({x:e.dx,y:e.dy,width:e.sw,height:e.sh}),t.ctx.clearRect(i.rect.x,i.rect.y,i.rect.width,i.rect.height),i.drawOnContext(r),this.conductor.layer.redrawRect(this.conductor.canvas.rect),0}}),clip:new TagAction({rules:{left:{type:"INT",
required:!0},top:{type:"INT",required:!0}},action:function(e){if(!this.conductor.layer.images[0])return 0;var t=this.conductor.layer.images[0];return t.options.clipLeft=e.left,t.options.clipTop=e.top,t.cacheEnabled=!1,t.cacheCanvas=void 0,this.conductor.layer.redrawRect(t.rect),0}}),wait:new TagAction({rules:{time:{type:"INT",required:!0}},action:function(e){this.conductor.nextTagTime=Date.now()+e.time;var t=this,r=this.conductor;return setTimeout(function(){delete r.nextTagTime,t.done()},e.time),1}}),label:new TagAction({rules:{name:{type:"STRING"}},action:function(e){return 0}}),loop:new TagAction({action:function(){return this.conductor.isLooping=!0,0}}),home:new TagAction({action:function(){return this.conductor.shouldStop?2:0}}),s:new TagAction({action:function(){return 2}})},["jump","macro","endmacro","erasemacro","if","else","elsif","endif","ignore","endignore","eval","o2_iscript"].forEach(function(e){AnimationConductor.tagActions[e]=Tag.actions[e]})),AnimationConductor.tagActions[e]||Conductor.prototype.getTagAction.apply(this,arguments)},Tag.actions.animstart=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},seg:{type:"INT",required:!0},target:{type:"STRING"}},action:function(e){var t=e.layer[e.page];if(!t.images[0]||!t.images[0].image)return this.warn("layerに画像がないです。"),0;var r=t.images[0].image.originalURL,i=KAGFiles(r+".asd"),n=this;return $.when(i).then(function(i){setTimeout(function(){if(!i)return n.error(r+".asdが見つからないです。"),void n.done();var o=new AnimationConductor({file:i,label:e.target});t.addAnimationConductor(o,e.seg),o.run(),n.done()})}),1}}),Tag.actions.animstop=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},seg:{type:"INT"}},action:function(e){var t=e.layer[e.page],r=t.animationConductors[e.seg];return r?r.stopUntilHome():this.warn(e.seg+"というアニメーションセグメントが見つかりません。"),0}}),Tag.actions.wa=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},seg:{type:"INT"}},action:function(e){var t=this,r=e.layer[e.page],i=r.animationConductors[e.seg];return i?i.isLooping?0:($(i).on("ran",function(e,r){2==r&&t.done()}),1):(this.warn(e.seg+"というアニメーションセグメントが見つかりません。"),0)}}),function(){var e;Tag.actions.o2_geo_watch=new TagAction({action:function(t){return e?0:(e=navigator.geolocation.watchPosition(function(e){ev.geo=e}),0)}}),Tag.actions.o2_geo_endwatch=new TagAction({action:function(t){return navigator.geolocation.clearWatch(e),e=void 0,0}}),Tag.actions.o2_geo_get=new TagAction({action:function(e){function t(e){ev.geo=e,i.done()}function r(){i.done()}var i=this;return navigator.geolocation.getCurrentPosition(t,r),0}}),Tag.actions.o2_geo_wg=new TagAction({rules:{canskip:{type:"BOOLEAN"}},action:function(e){return e.canskip&&this.conductor.wait("click"),this.conductor.wait("o2_geo_get"),1}})}(),Tag.actions.clearsysvar=new TagAction({action:function(){return window.sf={},0}}),Tag.actions.clearvar=new TagAction({action:function(){window.f={}}}),Tag.actions.glyph=new TagAction({rules:{line:{type:"STRING"},page:{type:"STRING"},fix:{type:"BOOLEAN"},left:{type:"FLOAT"},top:{type:"FLOAT"}},action:function(e){var t={fix:"fixed",left:"x",top:"y"};for(var r in e){var i=t[r]||r;o2.currentMessageLayer.glyphOptions[i]=e[r]}return 0}}),Tag.actions.o2_loadplugin=new TagAction({rules:{module:{type:"STRING",required:!0}},action:function(e){var t=this,r=document.createElement("script");return r.onload=function(){t.done()},r.onerror=function(){t.error("プラグインファイル "+e.module+" をロードできません")},r.src="./plugin/"+e.module,document.getElementsByTagName("head")[0].appendChild(r),1}}),Tag.actions.o2_sysbutton=new TagAction({rules:{graphic:{type:"STRING",required:!0},graphickey:{type:"COLOR",allowString:["adapt"]},storage:{type:"STRING"},target:{type:"STRING"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},o2_exp:{type:"STRING"},o2_onenter:{type:"STRING"},o2_onleave:{type:"STRING"},id:{type:"STRING",required:!0}},action:function(e){var t=this;return ResourceLoader.loadImage(e.graphic).done(function(r){setTimeout(function(){var i=o2.currentMessageLayer.textCursor,n=new RoutineButton(r,i.x,i.y);n.importFromKAGArgs(e),o2.currentMessageLayer.addRoutineButton(n),t.done()})}),1}}),Tag.actions.o2_updatesysbutton=new TagAction({rules:{id:{type:"STRING",required:!0},enabled:{type:"BOOLEAN"}},action:function(e){for(var t=0;t<o2.currentMessageLayer.routineButtons.length;t++){var r=o2.currentMessageLayer.routineButtons[t];if(r.tagArgs.id==e.id){r.enabled=e.enabled;break}}return 0}}),Tag.actions.o2_deletesysbutton=new TagAction({rules:{id:{type:"STRING",required:!0}},action:function(e){for(var t=0;t<o2.currentMessageLayer.routineButtons.length;t++){var r=o2.currentMessageLayer.routineButtons[t];if(r.tagArgs.id==e.id){o2.currentMessageLayer.routineButtons.splice(t,1),o2.currentMessageLayer.redrawRect(r.rect);break}}return 0}});var RoutineButton=function(e,t,r){Button.call(this,e,t,r),this.rect.width=Math.floor(this.rect.width/4),this.options.clipLeft=0,this.options.clipWidth=this.rect.width,this.tagArgs,this.enabled=!0,this.activated=!0};RoutineButton.prototype=Object.create(Button.prototype),RoutineButton.prototype.initializer="RoutineButton",RoutineButton.prototype.clone=function(){var e=new RoutineButton(this.image);return e.importFrom(this),e},RoutineButton.prototype.drawOnContext=function(e,t){switch(this.state){case Button.STATE_DISABLE:this.options.clipLeft=3*this.rect.width;break;case Button.STATE_HOVER:this.options.clipLeft=2*this.rect.width;break;case Button.STATE_DOWN:this.options.clipLeft=this.rect.width;break;case Button.STATE_NORMAL:default:this.options.clipLeft=0}this.enabled||(this.options.clipLeft=3*this.rect.width),Button.prototype.drawOnContext.apply(this,arguments)},RoutineButton.prototype.importFromKAGArgs=function(args){this.tagArgs=clone(args),this.click=function(x,y,layer){if(Button.prototype.click.apply(this,arguments),this.activated&&this.enabled&&(args.o2_exp&&eval(args.o2_exp),args.o2_url&&window.open(args.o2_url,args.o2_urltarget),args.storage||args.target)){extraConductor.setFile(conductor.file),currentConductor=extraConductor;var newTag=new Tag("jump",{storage:args.storage,target:args.target});extraConductor.queue.push(newTag)}},args.o2_onenter&&(this.enter=function(){Button.prototype.enter.apply(this,arguments),eval(args.o2_onenter)}),args.o2_onleave&&(this.leave=function(){Button.prototype.leave.apply(this,arguments),eval(args.o2_onleave)})},RoutineButton.prototype.importFrom=function(e){Button.prototype.importFrom.call(this,e),e.tagArgs&&this.importFromKAGArgs(e.tagArgs)},RoutineButton.prototype.importFromSaveData=function(e){Button.prototype.importFromSaveData.call(this,e),e.tagArgs&&this.importFromKAGArgs(e.tagArgs)},RoutineButton.prototype.toJSON=function(){var e=Button.prototype.toJSON.call(this);return e.tagArgs=this.tagArgs,e},RoutineButton.restore=function(e){return $.when(ResourceLoader.loadImage(e.image,!0)).then(function(t){var r=new RoutineButton(t);return r.importFromSaveData(e),r})};var RoutineLink;!function(){RoutineLink=function(){Link.call(this),this.tagArgs},RoutineLink.prototype=Object.create(Link.prototype),RoutineLink.prototype.initializer="RoutineLink",RoutineLink.restore=function(e){var t=new RoutineLink;return t.importFromKAGArgs(e.tagArgs),delete e.tagArgs,Link.prototype.importFromSaveData(e),t},RoutineLink.prototype.importFrom=function(e){Link.prototype.importFrom.call(this,e),this.importFromKAGArgs(e.tagArgs)},RoutineLink.prototype.importFromKAGArgs=function(args){this.tagArgs=args,this.click=function(x,y,layer){if(Link.prototype.click.apply(this,arguments),"o2_exp"in args&&eval(args.o2_exp),"o2_url"in args&&window.open(args.o2_url,args.o2_urltarget),args.storage||args.target){extraConductor.setFile(conductor.file),currentConductor=extraConductor;var newTag=new Tag("jump",{storage:args.storage,target:args.target});extraConductor.queue.push(newTag)}},"o2_onenter"in args&&(this.enter=function(){Link.prototype.enter.apply(this,arguments),eval(args.o2_onenter)}),"o2_onleave"in args&&(this.leave=function(){Link.prototype.leave.apply(this,arguments),eval(args.o2_onleave)})};var initialTextLength=0,linkArgs={};Tag.actions.o2_syslink=new TagAction({rules:{storage:{type:"STRING"},target:{type:"STRING"},color:{type:"COLOR"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},o2_onenter:{type:"STRING"},o2_onleave:{type:"STRING"},o2_exp:{type:"STRING"}},action:function(e){return initialTextLength=o2.currentMessageLayer.textsProperties.length,linkArgs=e,0}}),Tag.actions.o2_endsyslink=new TagAction({action:function(e){var t=new RoutineLink;t.importFromKAGArgs(linkArgs),t.vertical=o2.currentMessageLayer.vertical;for(var r=initialTextLength;r<o2.currentMessageLayer.textsProperties.length;r++)t.addTextProperties(o2.currentMessageLayer.textsProperties[r]);if(o2.currentMessageLayer.addLink(t),o2.currentMessageLayerWithBack){var i=o2.currentMessageLayer.getCorrespondingLayer(),t=new RoutineLink;t.importFromKAGArgs(linkArgs),t.vertical=i.vertical;for(var r=initialTextLength;r<i.textsProperties.length;r++)t.addTextProperties(i.textsProperties[r]);i.addLink(t)}return 0}})}(),Tag.actions.o2_enterskip=new TagAction({action:function(){return o2.skipToStop(),0}}),Tag.actions.o2_forcibleskip=new TagAction({action:function(){return o2.skipToStopForcibly(),0}}),Tag.actions.o2_enterautomode=new TagAction({action:function(){return o2.enterAutoMode(),0}}),Tag.actions.cancelskip=new TagAction({action:function(e){return o2.skipMode=o2.SKIP_MODE_NONE,0}}),Tag.actions.cancelautomode=new TagAction({action:function(e){return o2.cancelAutoMode(),0}}),Tag.actions.buildtag=new TagAction({rules:{name:{type:"STRING",required:!0}},action:function(e){this.isOpen()||this.error("openTagじゃないとダメです");var t=this;return this.newTag=new Tag(e.name),this.replaceTags=function(e){t.originalTags={};for(var r in e)t.originalTags[r]=t.conductor.tagActions[r],t.conductor.tagActions[r]=e[r]},this.restoreTags=function(){for(var e in t.originalTags)t.conductor.tagActions[e]=t.originalTags[e];t.originalTags=null},this.replaceTags({arg:new TagAction({rules:{name:{type:"STRING",required:!0},value:{type:"ANY",required:!0}},action:function(e){t.newTag.args[e.name]=e.value}})}),this.conductor.setTag(this,!0),0},closeAction:function(e){e.newTag;this.conductor.queue.push(e.newTag),delete e.newTag,e.restoreTags()}}),function(){var e={};Tag.actions.listengesture=new TagAction({rules:{id:{type:"STRING",required:!0},mode:{type:/delta|accumulate|absolute|longtap/,defaultValue:"accumulate"},mutualexclusive:{type:"BOOLEAN",defaultValue:!0},minx:{type:"INT"},maxx:{type:"INT"},miny:{type:"INT"},maxy:{type:"INT"},duration:{type:"INT",defaultValue:1e3},maxmove:{type:"INT",defaultValue:10}},action:function(t){if(!this.isOpen())return void this.error("openタグじゃないとダメです");if("id"in e)return void this.error(id+"はすでに定義されてる");var r=this,i=function(){var e=new Conductor;e.setTag(r,!0);for(var t=[],i=0;i<arguments.length;i++)t.push(arguments[i]);t=r.makeScopeVars(t),e.callbackVarsStack.push(t),e.run()},n=function(){switch(t.mode){case"accumulate":return GestureRecognizer.accumulateRecognizer(t.minx,t.maxx,t.miny,t.maxy,i);case"delta":return GestureRecognizer.basicRecognizer("delta",i);case"absolute":return GestureRecognizer.basicRecognizer("absolute",i);case"longtap":return GestureRecognizer.longTapRecognizer(t.duration,t.maxmove,i)}}();return n.mutualExclusive=t.mutualexclusive,GestureManager.addRecognizer(n),e[t.id]=n,0},closeAction:function(e){return 2}}),Tag.actions.unlistengesture=new TagAction({rules:{id:{type:"STRING",required:!0}},action:function(t){var r=e[t.id];return GestureManager.removeRecognizer(r),delete e[t.id],0}})}();var defaultConfig={title:["string","untitled"],gameID:["string","mygame"],scWidth:["number",800],scHeight:["number",600],numMessageLayers:["number",2],numImageLayers:["number",2],backgroundColor:["color","0xeeeeee"],chSpeeds:["number",40],userCh2ndSpeed:["number",-1],numSEBuffers:["number",2],numMovies:["number",1],scPositionX_left:["number",0],scPositionX_left_center:["number",0],scPositionX_center:["number",0],scPositionX_right_center:["number",0],scPositionX_right:["number",0],initialMessageLayerVisible:["boolean",!1],messageLayerColor:["color","0x000000"],messageLayerOpacity:["opacity",190],messageLayerMarginT:["number",6],messageLayerMarginL:["number",6],messageLayerMarginR:["number",6],messageLayerMarginB:["number",6],messageLayerCurrentPositionX:["number",10],messageLayerCurrentPositionY:["number",60],messageLayerCurrentWidth:["number",480],messageLayerCurrentHeight:["number",35],messageLayerDefaultAutoReturn:["boolean",!0],messageLayerDefaultFontSize:["number",12],messageLayerDefaultFontFace:["string","ＭＳ Ｐゴシック"],messageLayerDefaultFontColor:["color","0xFFFFFF"],messageLayerDefaultFontBold:["boolean",!1],messageLayerDefaultFontItalic:["boolean",!1],messageLayerDefaultStyleLineSpacing:["number",6],messageLayerDefaultStylePitch:["number",0],messageLayerDefaultGlyphLine:["string","linebreak"],messageLayerDefaultGlyphPage:["string","pagebreak"],messageLayerDefaultGlyphFixed:["boolean",!1],messageLayerDefaultGlyphX:["number",0],messageLayerDefaultGlyphY:["number",0],messageLayerDefaultLinkColor:["color","0x0000ff"],messageLayerDefaultLinkOpacity:["opacity",64],messageLayerVertical:["boolean",!1],messageLayerDefaultRubySize:["number",10],messageLayerDefaultRubyOffset:["number",-2],messageLayerDefaultShadow:["boolean",!0],messageLayerDefaultShadowBlur:["number",3],messageLayerDefaultShadowOffsetX:["number",0],messageLayerDefaultShadowOffsetY:["number",0],messageLayerDefaultShadowColor:["color","0x000000"],messageLayerDefaultEdge:["boolean",!1],messageLayerDefaultEdgeColor:["color","0x000000"],historyLayerFontFace:["string","ＭＳ Ｐゴシック"],historyLayerFontColor:["color","0xFFFFFF"],historyLayerFontBold:["boolean",!1],historyLayerFontHeight:["number",24],historyLayerLineHeight:["number",26],historyLayerEverypage:["boolean",!1],historyLayerMaxPages:["number",30],historyLayerMaxLines:["number",20],historyLayerStoreState:["boolean",!1],historyLayerColor:["color","0x000000"],historyLayerOpacity:["opacity",255],historyLayerFrame:["string",""],historyLayerMarginT:["number",30],historyLayerMarginL:["number",30],historyLayerMarginR:["number",30],historyLayerMarginB:["number",30],historyLayerCurrentPositionX:["number",10],historyLayerCurrentPositionY:["number",10],historyLayerCurrentWidth:["number",300],historyLayerCurrentHeight:["number",300],historyLayerVertical:["string","auto"],historyLayerShadow:["boolean",!0],historyLayerShadowColor:["color","0x000000"],historyLayerShadowBlur:["number",3],historyLayerShadowOffsetX:["number",0],historyLayerShadowOffsetY:["number",0],historyLayerEdge:["boolean",!1],historyLayerEdgeColor:["color","0x000000"],historyLayerFrameFixed:["boolean",!1],cursorDefault:["string","auto"],cursorPointed:["string","pointer"],cursorWaitingClick:["string","auto"],cursorDraggable:["string","auto"],saveMode:["string","o2kag"],priorityAudioChannel:["string","bgm"],saveThumbnail:["boolean",!1],thumbnailWidth:["number",128],autoModePageWait:["number",350],autoModeLineWait:["number",50],chNonStopToPageBreak:["boolean",!1],ch2ndNonStopToPageBreak:["boolean",!1],numImageCache:["number",-1],numScriptCache:["number",5]},config={},mp={},tf={},sf={__system:{seGVolume:1,bgmGVolume:1,chSpeed:40,useUserChSpeed:!0,userChSpeed:40,userCh2ndSpeed:-1,autoModeLineWait:50,autoModePageWait:350}},f={},ev={query:function(){function e(e){return decodeURIComponent((new RegExp("[?|&]"+e+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null}for(var t={},r=window.location.search.substring(1),i=r.split("&"),n=0;n<i.length;n++){var o=i[n].split("=");!o.length||1==o.length&&""==o[0]||(2==o.length?t[o[0]]=e(o[0]):t[o[0]]=!0)}return t}(),save:{date:{},caption:{},snapshot:{}},cursorLocation:{x:0,y:0},ua:navigator.userAgent,lang:navigator.language?navigator.language:navigator.userLanguage,hostname:location.hostname,lastimage:{},enginever:"2.3.0",enginebuild:"71733ff"},o2={foreLayers:{baseLayer:void 0,imageLayers:[],messageLayers:[]},backLayers:{baseLayer:void 0,imageLayers:[],messageLayers:[]},currentMessageLayer:void 0,currentMessageLayerWithBack:!1,allForeLayers:function(){return[this.foreLayers.baseLayer].concat(this.foreLayers.imageLayers).concat(this.foreLayers.messageLayers)},allBackLayers:function(){return[this.backLayers.baseLayer].concat(this.backLayers.imageLayers).concat(this.backLayers.messageLayers)},allLayers:function(){return this.allBackLayers().concat(this.allForeLayers())},autoHideLayers:function(){return this.foreLayers.messageLayers.concat(this.backLayers.messageLayers).concat(this.extraAutoHideLayers)},refreshRendererLayers:function(){function e(e,t){return e.index-t.index}renderer.foreLayers=this.allForeLayers().sort(e),renderer.backLayers=this.allBackLayers().sort(e)},resetLayersIndex:function(){for(var e=0;e<o2.foreLayers.imageLayers.length;e++)o2.foreLayers.imageLayers[e].index=1e3*(e+1),o2.backLayers.imageLayers[e].index=1e3*(e+1);for(var e=0;e<o2.foreLayers.messageLayers.length;e++)o2.foreLayers.messageLayers[e].index=1e6+1e3*(e+1),o2.backLayers.messageLayers[e].index=1e6+1e3*(e+1)},extraAutoHideLayers:[],imageList:[],soundList:[],videoList:[],fontList:[],config:{scriptTagNameKey:"name",scriptTagArgsKey:"args",scriptTagLineKey:"line",scriptTagCharKey:"char"},se:[],setSeGVolume:function(e){void 0!==e&&(sf.__system.seGVolume=e),this.se.forEach(function(e){e.volumePercentage=sf.__system.seGVolume,e.setVolume(e.volume)})},setBgmGVolume:function(e){void 0!==e&&(sf.__system.bgmGVolume=e),o2.bgm.volumePercentage=sf.__system.bgmGVolume,o2.bgm.setVolume(o2.bgm.volume)},bgm:new Sound,prioritySound:void 0,videos:[],currentSaveAdapter:new Tag.actions.save.adapters.LocalAdapter,skipMode:0,clickSkipEnabled:!0,skipWithMode:function(e){o2.skipMode=e,trigger("click")||currentConductor.status===Conductor.STATUS_WAIT&&0==Object.keys(currentConductor.waitTag).length&&currentConductor.oneShot()},skipToClick:function(){this.skipWithMode(o2.SKIP_MODE_CLICK)},skipToPage:function(){this.skipWithMode(o2.SKIP_MODE_PAGE)},skipToStop:function(){currentConductor.isCurrentRead()&&this.skipWithMode(o2.SKIP_MODE_UNREAD)},skipToStopForcibly:function(){this.skipWithMode(o2.SKIP_MODE_STOP)},autoMode:!1,enterAutoMode:function(){this.autoMode=!0,trigger("click")||currentConductor.status!=Conductor.STATUS_STOP&&0==Object.keys(currentConductor.waitTag).length&&currentConductor.oneShot()},cancelAutoMode:function(){this.autoMode=!1},reloadDelaySpeed:function(){var e=sf.__system.chSpeed;sf.__system.useUserChSpeed&&(currentConductor.isCurrentRead()&&"userCh2ndSpeed"in sf.__system&&-1!=sf.__system.userCh2ndSpeed?e=sf.__system.userCh2ndSpeed:"userChSpeed"in sf.__system&&(e=sf.__system.userChSpeed));for(var t=o2.foreLayers.messageLayers.concat(o2.backLayers.messageLayers),r=t.length-1;r>=0;r--)t[r].delaySpeed=e},historyLayer:void 0,glyphLayer:void 0,showGlyph:function(e){e=e||"line",this.currentMessageLayer.showGlyphLayer(this.glyphLayer,e)},hideGlyph:function(){this.currentMessageLayer.hideGlyphLayer()},debugLevel:1,serverStat:{mode:0,key:ev.query.key||null,uid:ev.query.uid||-1,userServer:"https://novelsphere.jp",saveServer:"/",skey:ev.query.skey||null},setServerStat:function(e){o2.serverStat.key=e.key,o2.serverStat.uid=e.uid,o2.serverStat.userServer=e.userServer,o2.serverStat.skey=e.skey,e.saveServer&&(o2.serverStat.saveServer=e.saveServer)},printLog:function(e){if(void 0==e&&(e=o2.DEBUG_LEVEL_LOG),e>o2.debugLevel)return function(){};switch(e){case o2.DEBUG_LEVEL_ERROR:return console.error;case o2.DEBUG_LEVEL_CAUTION:return console.warn;case o2.DEBUG_LEVEL_LOG:return console.log}return function(){}},log:function(){return o2.printLog(o2.DEBUG_LEVEL_LOG).apply(console,arguments)},warn:function(){return o2.printLog(o2.DEBUG_LEVEL_CAUTION).apply(console,arguments)},error:function(){return o2.printLog(o2.DEBUG_LEVEL_ERROR).apply(console,arguments)},setCursorStyle:function(e){var t;switch(e){case"pointer":t=config.cursorPointed;break;case"waitClick":t=config.cursorWaitingClick;break;case"draggable":t=config.cursorDraggable;break;case"default":default:t=config.cursorDefault}$("body").css("cursor",t)},rclickSettings:{call:!1,jump:!1,target:void 0,storage:void 0,enabled:!0}};o2.SKIP_MODE_NONE=0,o2.SKIP_MODE_CLICK=1,o2.SKIP_MODE_PAGE=2,o2.SKIP_MODE_UNREAD=3,o2.SKIP_MODE_STOP=4,o2.SKIP_MODE_FAST_FORWARD=5,o2.DEBUG_LEVEL_OFF=0,o2.DEBUG_LEVEL_ERROR=1,o2.DEBUG_LEVEL_CAUTION=2,o2.DEBUG_LEVEL_LOG=3,o2.SERVER_MODE_STANDALONE=0,o2.SERVER_MODE_O2SERVER=1,o2.SAVE_MODE_O2KAG="o2kag",o2.SAVE_MODE_KAG3="kag3",o2.objectToBeSerialized=function(e){function t(e){for(var t=0;t<o2.foreLayers.messageLayers.length;t++){var r=o2.foreLayers.messageLayers[t];if(e==r)return{page:"fore",layer:t}}for(var t=0;t<o2.backLayers.messageLayers.length;t++){var r=o2.backLayers.messageLayers[t];if(e==r)return{page:"back",layer:t}}}if("function"!=typeof this[e]){switch(e){case"imageList":case"soundList":case"videoList":case"config":case"imageList":case"soundList":case"videoList":case"serverStat":case"prioritySound":case"debugLevel":case"skipMode":case"autoMode":case"SKIP_MODE_NONE":case"SKIP_MODE_CLICK":case"SKIP_MODE_PAGE":case"SKIP_MODE_STOP":case"SKIP_MODE_UNREAD":case"SKIP_MODE_FAST_FORWARD":case"DEBUG_LEVEL_OFF":case"DEBUG_LEVEL_ERROR":case"DEBUG_LEVEL_CAUTION":case"DEBUG_LEVEL_LOG":case"SERVER_MODE_STANDALONE":case"SERVER_MODE_O2SERVER":case"SAVE_MODE_O2KAG":case"SAVE_MODE_KAG3":return;case"currentMessageLayer":return t(this.currentMessageLayer);case"autoHideLayers":return this.autoHideLayers.map(function(e){return t(e)})}return this[e]}},o2.importFromSaveData=function(e){var t=this,r=[];["foreLayers","backLayers"].forEach(function(i){["imageLayers","messageLayers"].forEach(function(n){t[i][n]=[];var o=[];r.push(o.importFromSaveData(e[i][n]).done(function(){t[i][n]=o})),delete e[i][n]})});var i=e.currentMessageLayer;return delete e.currentMessageLayer,r=r.concat(Object.prototype.importFromSaveData.call(this,e)),$.when.apply($,r).done(function(){t.currentMessageLayer=t["back"==i.page?"backLayers":"foreLayers"].messageLayers[i.layer],delete e.currentMessageLayer,t.refreshRendererLayers()})};var conductor,currentConductor,extraConductor;!function(){var e={scriptTagNameKey:0,scriptTagArgsKey:1,scriptTagCallbackArgsKey:2,scriptTagLineKey:3,scriptTagCharKey:4};"undefined"!=typeof module&&module.exports?exports.config=e:window&&window.o2&&(window.o2.config=e)}();