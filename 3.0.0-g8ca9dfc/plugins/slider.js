"use strict";tf.__slider={};var Slider=function(t,e,i,o){Button.call(this,t,i,o),this.rect.width=Math.floor(this.rect.width/2),this.options.clipLeft=0,this.options.clipWidth=this.rect.width,this.layer=null,this.pinImage=new DrawableImage(e,0,0),this.pinImage.rect.width/=3,this.pinImage.options.clipLeft=0,this.pinImage.options.clipWidth=this.pinImage.rect.width,this.pinImage.cacheEnabled=!1,this.max=1,this.min=0,this.callback=null,this.o2onEnter,this.o2onLeave};Slider.prototype=Object.create(Button.prototype),Slider.prototype.enter=function(x,y,layer){if(Button.prototype.enter.apply(this,arguments),this.o2onEnter)try{eval(this.o2onEnter)}catch(e){}},Slider.prototype.leave=function(t,e,i){if(Button.prototype.leave.apply(this,arguments),this.o2onLeave)try{(0,eval)(this.o2onLeave)}catch(o){}},Slider.prototype.mousemove=function(t,e,i){if(Button.prototype.mousemove.apply(this,arguments),this.state==Button.STATE_DOWN){var o=this.positionFromLocation(t);null!==o&&this.setPosition(o)}},Slider.prototype.mousedown=function(t,e,i){Button.prototype.mousedown.apply(this,arguments)},Slider.prototype.click=function(t,e,i){Button.prototype.click.apply(this,arguments);var o=this.positionFromLocation(t);null!==o&&this.setPosition(o)},Slider.prototype.positionFromLocation=function(t){var e=this.rect.width-this.pinImage.rect.width,i=this.rect.x+this.pinImage.rect.width/2,o=(t-i)/e;return 0>o||o>1?null:this.min+(this.max-this.min)*o},Slider.prototype.setPosition=function(t){var e=(t-this.min)/(this.max-this.min),i=this.rect.width-this.pinImage.rect.width;this.layer.redrawRect(new Rect({x:this.rect.x+this.pinImage.rect.x,y:this.rect.y+this.pinImage.rect.y,width:this.pinImage.rect.width,height:this.pinImage.rect.height})),this.pinImage.rect.x=i*e,this.layer.redrawRect(new Rect({x:this.rect.x+this.pinImage.rect.x,y:this.rect.y+this.pinImage.rect.y,width:this.pinImage.rect.width,height:this.pinImage.rect.height}));var o=Slider.callbacks[this.callback];"function"==typeof o&&o(t)},Slider.prototype.drawOnContext=function(t,e){switch(this.state){case Button.STATE_HOVER:this.options.clipLeft=this.rect.width,this.pinImage.options.clipLeft=2*this.pinImage.rect.width;break;case Button.STATE_DOWN:this.pinImage.options.clipLeft=this.pinImage.rect.width;break;case Button.STATE_NORMAL:default:this.pinImage.options.clipLeft=0,this.options.clipLeft=0}Button.prototype.drawOnContext.apply(this,arguments),this.pinImage.rect.x+=this.rect.x,this.pinImage.rect.y+=this.rect.y,this.pinImage.drawOnContext(t,e),this.pinImage.rect.x-=this.rect.x,this.pinImage.rect.y-=this.rect.y},function(){var t=MessageLayer.prototype.importFrom;MessageLayer.prototype.importFrom=function(e){for(var i=[],o=e.buttons.length-1;o>=0;o--){var n=e.buttons[o];n instanceof Slider&&(i.unshift(n),e.buttons.splice(o,1),e.redrawRect(n.rect))}t.apply(this,arguments);for(var r=0;r<i.length;r++){var a=i[r];a.layer=this,this.addButton(a)}}}(),Slider.callbacks={bgmGVolume:function(t){o2.setBgmGVolume(t)},seGVolume:function(t){o2.setSeGVolume(t)},userChSpeed:function(t){sf.__system.userChSpeed=t,o2.reloadDelaySpeed()},userCh2ndSpeed:function(t){sf.__system.userCh2ndSpeed=t,o2.reloadDelaySpeed()}},Tag.actions.o2_slidercreate=new TagAction({rules:{name:{type:"STRING",required:!0},layer:{type:"MESSAGE_LAYER"},page:{type:/fore|back/,defaultValue:"fore"},left:{type:"FLOAT",required:!0},top:{type:"FLOAT",required:!0},bgimage:{type:"STRING",defaultValue:"opt_slider_base"},pinimage:{type:"STRING",defaultValue:"opt_slider_pin"},max:{type:"FLOAT",defaultValue:1},min:{type:"FLOAT",defaultValue:0},position:{type:"FLOAT",defaultValue:.5},callback:{type:"STRING",required:!0},o2_onenter:{type:"STRING"},o2_onleave:{type:"STRING"}},action:function(t){if(!(t.callback in Slider.callbacks))return void o2.error("Slider.callbacksの中に"+t.callback+"属性がないです");if(t.name in tf.__slider)return void o2.error(t.name+"というスライダーはすでに存在してます");t.layer||(t.layer={fore:o2.currentMessageLayer,back:o2.currentMessageLayer.getCorrespondingLayer()});var e=this,i=t.layer[t.page],o=null,n=null,r=ResourceLoader.loadImage(t.bgimage).done(function(t){o=t}),a=ResourceLoader.loadImage(t.pinimage).done(function(t){n=t});return $.when(r,a).done(function(){setTimeout(function(){var r=new Slider(o,n,t.left,t.top);r.max=t.max,r.min=t.min,r.layer=i,r.setPosition(t.position),r.callback=t.callback,"o2_onenter"in t&&(r.o2onEnter=t.o2_onenter),"o2_onleave"in t&&(r.o2onLeave=t.o2_onleave),i.addButton(r),tf.__slider[t.name]=r,e.done()})}),1}}),Tag.actions.o2_slideropt=new TagAction({rules:{name:{type:"STRING",required:!0},position:{type:"FLOAT",required:!0}},action:function(t){var e=tf.__slider[t.name];return e?(e.setPosition(t.position),0):void o2.error(t.name+"というスライダーがないです")}}),Tag.actions.o2_sliderdelete=new TagAction({rules:{name:{type:"STRING",required:!0}},action:function(t){var e=tf.__slider[t.name];if(!e)return void o2.error(t.name+"というスライダーがないです");var i=e.layer;if(i){var o=i.buttons.indexOf(e);if(-1!=o)return i.buttons.splice(o,1),i.redrawRect(e.rect),delete tf.__slider[t.name],0}}});