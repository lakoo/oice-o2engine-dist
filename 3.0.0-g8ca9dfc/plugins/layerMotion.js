"use strict";!function(){var t=function(t,o,i){this.value=t,this.duration=o,this.acceleration=i};t.fromString=function(o){o=o.replace("(","").replace(")","");var i=o.split(",");return 3==i.length?new t(parseFloat(i[0]),parseFloat(i[1]),parseFloat(i[2])):null};var o=function(t){this.points=t,this.totalDuration=t.reduce(function(t,o){return t+o.duration},0)};o.prototype.getCurrentValue=function(t){if(!this.totalDuration)return 0;var o=Date.now()-t;o%=this.totalDuration;for(var i=0,n=1;n<this.points.length&&!(i+this.points[n].duration>o);n++)i+=this.points[n].duration;var e=this.points[n],a=this.points[n-1];e||(e=this.points[this.points.length-1]);var s=(o-i)/e.duration;return e.acceleration>1?s=Math.pow(s,e.acceleration):e.acceleration<-1&&(s=1-s,s=Math.pow(s,-e.acceleration),s=1-s),a.value+(e.value-a.value)*s};var i={},n=function(){this.xMotion=null,this.yMotion=null,this.loopX=1,this.loopY=1};n.prototype.getXValue=function(t){return this.xMotion&&this.xMotion.points.length?this.xMotion.getCurrentValue(t):null},n.prototype.getYValue=function(t){return this.yMotion&&this.yMotion.points.length?this.yMotion.getCurrentValue(t):null},n.prototype.getLastX=function(){if(!this.xMotion||!this.xMotion.points.length)return null;var t=this.xMotion.points.length;return this.xMotion.points[t-1].value},n.prototype.getLastY=function(){if(!this.yMotion||!this.yMotion.points.length)return null;var t=this.yMotion.points.length;return this.yMotion.points[t-1].value},n.prototype.getXLoopCount=function(t){return this.xMotion.totalDuration?Math.floor((Date.now()-t)/this.xMotion.totalDuration):-1},n.prototype.getYLoopCount=function(t){return this.yMotion.totalDuration?Math.floor((Date.now()-t)/this.yMotion.totalDuration):-1};var e=[],a=function(t,o){this.beginning=Date.now(),this.data=t,this.layer=o,this.initX=o.rect.x,this.initY=o.rect.y,this.loopX=this.data.loopX,this.loopY=this.data.loopY,this.loopXCount=0,this.loopYCount=0,this.finish=!1};a.prototype.start=function(){this.beginning=Date.now(),this.animate()},a.prototype.stop=function(){var t=e.indexOf(this);t>-1&&e.splice(t,1),this.finish=!0},a.prototype.animate=function(){var t=this.data.getXLoopCount(this.beginning),o=this.data.getYLoopCount(this.beginning),i=-1==t||0!=this.loopX&&t>=this.loopX,n=-1==o||0!=this.loopY&&o>=this.loopY;if(this.loopXCount!=t&&(this.loopXCount<this.loopX||0==this.loopX)&&(this.loopXCount=t,this.initX+=this.data.getLastX(),i&&(this.layer.rect.x=this.initX)),this.loopYCount!=o&&(this.loopYCount<this.loopY||0==this.loopY)&&(this.loopYCount=o,this.initY+=this.data.getLastY(),n&&(this.layer.rect.y=this.initY)),i||(this.layer.rect.x=this.initX+this.data.getXValue(this.beginning)),n||(this.layer.rect.y=this.initY+this.data.getYValue(this.beginning)),this.finish||i&&n)this.stop(),$(this).trigger("stop");else{var e=this;renderer.animator.requestFrame(function(){e.animate()})}},Tag.actions.motion_define=new TagAction({rules:{name:{type:"STRING",required:!0},locatex:{type:"STRING",defaultValue:""},locatey:{type:"STRING",defaultValue:""},loop:{type:"INT",defaultValue:1},loopx:{type:"INT"},loopy:{type:"INT"}},action:function(e){var a=/\((-?[0-9,\s]+){3}\)/g,s=e.locatex.match(a);s=s?s.map(function(o){return t.fromString(o)}):[],s.unshift(new t(0,0,0));var r=new o(s),l=e.locatey.match(a);l=l?l.map(function(o){return t.fromString(o)}):[],l.unshift(new t(0,0,0));var p=new o(l),u=i[e.name];return u||(u=i[e.name]=new n),u.xMotion=r,u.yMotion=p,"loop"in e&&(u.loopX=u.loopY=e.loop),"loopx"in e&&(u.loopX=e.loopx),"loopy"in e&&(u.loopY=e.loopy),0}}),Tag.actions.motion_start=new TagAction({rules:{layer:{type:"LAYER",defaultValue:0},page:{type:/fore|back/,defaultValue:"fore"},name:{type:"STRING",required:!0},wait:{type:"BOOLEAN"},canskip:{type:"BOOLEAN"},loopx:{type:"INT"},loopy:{type:"INT"},ix:{type:"FLOAT"},iy:{type:"FLOAT"}},action:function(t){var o=t.layer[t.page],n=i[t.name],s=new a(n,o);if("loopx"in t&&(s.loopX=t.loopx),"loopy"in t&&(s.loopY=t.loopy),"ix"in t&&(s.initX=t.ix),"iy"in t&&(s.initY=t.iy),s.start(),e.push(s),t.wait){var r=this,l=!1;return $(s).one("stop",function(){l||r.done()}),t.canskip&&this.conductor.wait("click",function(){l=!0,s.stop()}),1}return 0}}),Tag.actions.motion_stop=new TagAction({rules:{layer:{type:"LAYER",defaultValue:0},page:{type:/fore|back/,defaultValue:"fore"},name:{type:"STRING",required:!0},lastpos:{type:"BOOLEAN",defaultValue:!0}},action:function(t){return e.forEach(function(o){if(o.data==i[t.name]&&o.layer==t.layer[t.page]&&(o.stop(),t.lastpos)){var n=o.data.getLastX(),e=o.data.getLastY();null!==n&&(o.layer.rect.x=n),null!==e&&(o.layer.rect.y=e)}}),0}})}();