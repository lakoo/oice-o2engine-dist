"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function clone(e,t){if(e&&e.clone&&"function"==typeof e.clone)return e.clone();if(null==e||"object"!=("undefined"==typeof e?"undefined":_typeof(e))||/\[object HTML[A-Za-z]*Element\]/.test(Object.prototype.toString.apply(e))||/\[object Window\]/.test(Object.prototype.toString.apply(e)))return e;if(e instanceof Date){var r=new Date;return r.setTime(e.getTime()),r}if(e instanceof Array){for(var n=[],i=0,o=e.length;i<o;i++)n[i]=clone(e[i]);return n}if(e instanceof Object){var a=void 0;if(a=window[e.initializer]&&e instanceof window[e.initializer]?new window[e.initializer]:new e.constructor,t&&(a.originalReference=e),"function"==typeof a.importFrom)a.importFrom(e);else for(var s in e)e.hasOwnProperty(s)&&(a[s]=clone(e[s]));return a}throw new Error("[内部エラー] オブジェクトをコピーできません。この型はサポートされていません")}function mergeObj(e,t){for(var r in e)"object"!=_typeof(e[r])||void 0==t[r]?t[r]=e[r]:mergeObj(e[r],t[r]);return t}function getURLSearchParam(e){e=e.replace(/[\[\]]/g,"\\$&");var t=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)"),r=t.exec(window.location.href);return r?r[2]?decodeURIComponent(r[2].replace(/\+/g," ")):"":null}function KeySpline(e,t,r,n){function i(e,t){return 1-3*t+3*e}function o(e,t){return 3*t-6*e}function a(e){return 3*e}function s(e,t,r){return((i(t,r)*e+o(t,r))*e+a(t))*e}function c(e,t,r){return 3*i(t,r)*e*e+2*o(t,r)*e+a(t)}function u(t){for(var n=t,i=0;i<4;++i){var o=c(n,e,r);if(0==o)return n;var a=s(n,e,r)-t;n-=a/o}return n}this.get=function(i){return e==t&&r==n?i:s(u(i),t,n)}}function B_Spline_Generator(e){var t=e.length,r=t-1,n=t+2,i=(t+1)/100;return function(t){t=t<0?0:100<t?100:t;var o,a,s,c=i*t-1,u={x:0,y:0},l=void 0,h=void 0;for(l=-2;l<n;l++)a=c-l,o=(a=Math.abs(a))<1?(s=a*a*3,(a*s-2*s+4)/6):a<2?(s=a-2,s*s*s/-6):0,h=l<0?0:r<l?r:l,u.x+=e[h][0]*o,u.y+=e[h][1]*o;return u}}function supportCssProperty(e){"string"==typeof e&&(e=[e]);for(var t=0;t<e.length;t++){var r=e[t],n=document.body;if("string"!=typeof n.style[r]&&"string"!=typeof n.style["Webkit"+r.substring(0,1).toUpperCase()+r.substring(1)]&&"string"!=typeof n.style["Moz"+r.substring(0,1).toUpperCase()+r.substring(1)]&&"string"!=typeof n.style["O"+r.substring(0,1).toUpperCase()+r.substring(1)])return!1}return!0}function hexToRgb(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function wheelDistance(e){e||(e=event);var t=0,r=0,n=e.wheelDelta,i=e.detail;return i?n?r=n/i/40*i>0?1:-1:e.deltaX||e.deltaY?(t=e.deltaX,r=e.deltaY):r=-i/3:e.wheelDeltaX||e.wheelDeltaY?(r=e.wheelDeltaY/120,t=e.wheelDeltaX/120):e.deltaX||e.deltaY?(t=-e.deltaX/3,r=-e.deltaY/3):r=n/120,"DOMMouseScroll"==e.type?(r*=40,t*=40):browser.isIE||(r*=10,t*=10),{x:t,y:r}}function multiplyMatrix(e,t){for(var r=e.length,n=e[0].length,i=t[0].length,o=[],a=0;a<r;a++){o[a]=[];for(var s=0;s<i;s++){for(var c=0,u=0;u<n;u++)c+=e[a][u]*t[u][s];o[a][s]=c}}return o}function layerToPageAndLayerNumber(e){for(var t=0;t<o2.foreLayers.messageLayers.length;t++){var r=o2.foreLayers.messageLayers[t];if(e==r)return{page:"fore",layer:t}}for(var n=0;n<o2.backLayers.messageLayers.length;n++){var i=o2.backLayers.messageLayers[n];if(e==i)return{page:"back",layer:n}}}function setupEventHandlers(){var e,t;$("body").on("touchend",function(){window.scrollTo(0,0),scaleToFitPage()}),$(o2).on("click",function(){o2.autoMode?o2.cancelAutoMode():o2.skipMode>o2.SKIP_MODE_CLICK&&o2.skipMode<=o2.SKIP_MODE_STOP&&(o2.skipMode=o2.SKIP_MODE_NONE),o2.hideGlyph(),currentConductor.trigger("click")}),$("body").on("touchstart mousedown",function(e){GestureManager.eventHandlers.start(e)}).on("touchmove mousemove",function(e){GestureManager.eventHandlers.move(e)}).on("touchend mouseup",function(e){GestureManager.eventHandlers.end(e)}).on("touchcancel mouseleave",function(e){GestureManager.eventHandlers.cancel(e)});var r=new GestureRecognizer({numberOfTouches:0,maxNumberOfTouches:0,common:function(e,t){if(t&&(t.preventDefault(),ev.cursorLocation=t.originalEvent.normalizedCoordinate()),o2.historyLayer.visible)return t&&3==t.which?(o2.historyLayer.hide("up",!1),!0):(o2.historyLayer[e]&&o2.historyLayer[e](t)?o2.setCursorStyle("pointer"):o2.setCursorStyle("default"),!0);if(t&&3!=t.which)for(var r=o2.foreLayers.messageLayers.length-1;r>=0;r--){var n=o2.foreLayers.messageLayers[r];if(n[e]&&n[e](t))return t.stopImmediatePropagation(),o2.setCursorStyle("pointer"),!0}return o2.setCursorStyle("default"),!1},start:function(e){e.originalEvent.touches&&(this.numberOfTouches=e.originalEvent.touches.length,this.numberOfTouches>this.maxNumberOfTouches&&(this.maxNumberOfTouches=this.numberOfTouches)),this.state=GestureRecognizer.STATE.POSSIBLE,this.common("mousedown",e)},move:function(e){this.common("mousemove",e)},end:function(e){e.originalEvent.touches&&(this.numberOfTouches=e.originalEvent.touches.length),2==this.maxNumberOfTouches&&(e.which=3),this.common("mouseup",e)||0==this.numberOfTouches&&(3==e.which||2==this.maxNumberOfTouches?$(o2).trigger("rclick"):$(o2).trigger("click")),this.numberOfTouches<=0&&(this.numberOfTouches=0,this.maxNumberOfTouches=0,this.state=GestureRecognizer.STATE.CANCELLED)},cancel:function(){this.numberOfTouches=0,this.maxNumberOfTouches=0,this.failed(),this.common("cancel")}});GestureManager.addRecognizer(r);var n=new GestureRecognizer({start:function(e){this.state=GestureRecognizer.STATE.POSSIBLE,e.originalEvent.touches&&3==e.originalEvent.touches.length&&(this.satisified(),o2.historyLayer.visible||o2.skipToStopForcibly())},move:function(e){},end:function(e){e.originalEvent.touches&&e.originalEvent.touches.length<3&&this.state==GestureRecognizer.STATE.SATISIFIED&&(o2.skipMode=o2.SKIP_MODE_NONE),e.originalEvent.touches&&e.originalEvent.touches.length<=0?this.cancel():e.originalEvent.touches||this.cancel()},cancel:function(e){this.failed()}});GestureManager.addRecognizer(n);var i=GestureRecognizer.accumulateRecognizer(-20,20,100,void 0,function(){o2.historyLayer.visible||o2.historyLayer.vertical||o2.historyLayer.touchmoved({x:0,y:30})}),o=GestureRecognizer.accumulateRecognizer(void 0,0,-20,20,function(){!o2.historyLayer.visible&&o2.historyLayer.vertical&&o2.historyLayer.touchmoved({x:-30,y:0})}),a=i.satisified;i.satisified=function(){if(!o2.historyLayer.visible&&!o2.historyLayer.vertical)return a.apply(this,arguments)},o.satisified=function(){if(!o2.historyLayer.visible&&o2.historyLayer.vertical)return a.apply(this,arguments)},GestureManager.addRecognizer(i),GestureManager.addRecognizer(o),i.shouldCancelOtherRecognizer=o.shouldCancelOtherRecognizer=function(e){return e!=s};var s=GestureRecognizer.basicRecognizer("absolute",function(e,t,r){o2.historyLayer.visible&&(s.lastPoint&&o2.historyLayer.touchmoved({x:t-s.lastPoint.x,y:r-s.lastPoint.y}),"end"==e?s.lastPoint=void 0:s.lastPoint={x:t,y:r})});s.mutualExclusive=!1,GestureManager.addRecognizer(s),$("body").on("keydown",function(r){if("keyCode"in r)switch(r.keyCode){case 37:o2.historyLayer.scrolled({x:30,y:0});break;case 38:o2.historyLayer.scrolled({x:0,y:30});break;case 39:o2.historyLayer.scrolled({x:-30,y:0});break;case 40:o2.historyLayer.visible&&o2.historyLayer.scrolled({x:0,y:-30});break;case 13:t?o2.skipMode||o2.skipToStopForcibly():(t=!0,o2.historyLayer.visible||$(o2).trigger("click"));break;case 17:if(e)return;if(o2.historyLayer.visible)return;e=!0,o2.skipToStopForcibly()}}),$("body").on("keyup",function(r){if("keyCode"in r)switch(r.keyCode){case 17:e=!1,o2.skipMode=o2.SKIP_MODE_NONE;break;case 13:t=!1,o2.skipMode=o2.SKIP_MODE_NONE}}),$("body").on("mousewheel DOMMouseScroll wheel",function(e){e.preventDefault();var t=wheelDistance(e.originalEvent);o2.historyLayer.scrolled(t)}),$("body").on("touchstart touchmove touchend touchcancel",function(e){"button"!=e.target.type&&e.preventDefault()}),$("body").on("contextmenu",function(e){e.preventDefault()})}function initialize(e){function t(e,t){var r,n=defaultConfig[e];switch(n&&(r=n[0]),r){case"number":config[e]=Number(t);break;case"opacity":config[e]=Number(t)/255;break;case"boolean":"boolean"==typeof t?config[e]=t:"true"==t.toLowerCase()?config[e]=!0:"false"==t.toLowerCase()?config[e]=!1:config[e]=Boolean(t);break;case"color":config[e]=t.replace("0x","#");break;default:config[e]=t}}for(var r in defaultConfig)t(r,defaultConfig[r][1]);for(var n in e.config)t(n,e.config[n]);sf.__system.userChSpeed=config.chSpeeds,sf.__system.userCh2ndSpeed=config.userCh2ndSpeed,sf.__system.autoModeLineWait=config.autoModeLineWait,sf.__system.autoModePageWait=config.autoModePageWait;var i={videolist:"videoList",imagelist:"imageList",soundlist:"soundList",fontlist:"fontList"};for(var o in i)i.hasOwnProperty(o)&&"object"===_typeof(e[o])&&(o2[i[o]]=e[o]);for(var a=0;a<config.numSEBuffers;a++)browser.usesWebAudio?o2.se.push(new WebAudioSound):o2.se.push(new Sound);for(var s=0;s<config.numMovies;s++)o2.videos.push(new Video);if("bgm"==config.priorityAudioChannel)o2.prioritySound=o2.bgm;else{var c=config.priorityAudioChannel.match(/se([0-9]+)/);null==c&&o2.error("config.jsonのpriorityAudioChannelはbgmか、se[0-9]+じゃなければいけないです");var u=parseFloat(c[1]);o2.prioritySound=o2.se[u],o2.prioritySound||o2.error("config.jsonで指定されたpriorityAudioChannelは無効です。")}o2.foreLayers.baseLayer=new BaseLayer,o2.backLayers.baseLayer=new BaseLayer;for(var l=0;l<config.numImageLayers;l++){var h=new ImageLayer;o2.foreLayers.imageLayers.push(h),h=new ImageLayer,o2.backLayers.imageLayers.push(h)}for(var f=0;f<config.numMessageLayers;f++){var d=new MessageLayer;o2.foreLayers.messageLayers.push(d),d=new MessageLayer,o2.backLayers.messageLayers.push(d)}o2.currentMessageLayer=o2.foreLayers.messageLayers[0],o2.foreLayers.messageLayers[0].visible=o2.backLayers.messageLayers[0].visible=config.initialMessageLayerVisible,o2.historyLayer=new HistoryLayer,o2.glyphLayer=new GlyphLayer,renderer=new Renderer,o2.resetLayersIndex(),o2.refreshRendererLayers(),$("#main-wrapper").append(renderer.foreCanvas),$("#main-wrapper").css({width:config.scWidth+"px",height:config.scHeight+"px"}),e.manifest&&_KAGFiles.setupManifest(e.manifest);for(var p in e.scripts){var g=e.scripts[p];KAGFile.create(p,g)}$("body").css("background-color",config.backgroundColor),scaleToFitPage(),$(window).on("resize",scaleToFitPage)}function getScripts(e,t){o2.serverStat.mode=o2.SERVER_MODE_O2SERVER,$.ajax({url:e,data:t,type:t?"POST":"GET",success:function(e){"string"==typeof e&&(e=JSON.parse(e)),initScripts(e)}})}function initScripts(e){if(initialize(e),e=null,browser.isOiceApp||!browser.isIOs&&!browser.isAndroid)preload();else{var t=$('meta[property="oice:thumbnail"]').attr("content");$("#background-image").css("background-image","url("+t+")"),$("#background-image").removeClass("hidden"),$("#play-button").removeClass("hidden"),$("body").on("click","#play-button",function(){preload(),$(this).addClass("hidden"),$("#background-image").addClass("hidden")})}o2.preloadPerformanceMonitorTimerId=setInterval(displayPreloadedSize,200)}function displayPreloadedSize(){if(void 0!==performance){var e=performance.getEntriesByType("resource");if(void 0!==e){for(var t=0,r=0;r<e.length;r++){var n=e[r];"encodedBodySize"in n?t+=n.encodedBodySize:"decodedBodySize"in n&&(t+=n.decodedBodySize)}t>0&&$("#progress-text > span").last().html(" ("+(t/1024/1024).toFixed(2)+"MB)")}}}function preload(){if(config.preload){showProgressBar();var e=[];for(var t in o2.imageList)e.push(ResourceLoader.loadImage(t));for(var r in o2.fontList)e.push(ResourceLoader.loadFont(r));if(o2.webFontList.forEach(function(t){e.push(ResourceLoader.loadWebFont(t))}),!browser.isIOs||config.forcePreloadSoundAndVideoInIOS){for(var n in o2.soundList)e.push(ResourceLoader.loadAudio(n));for(var i in o2.videoList)e.push(ResourceLoader.loadVideo(i))}$.whenWithProgress=function(e,t){for(var r=0,n=e.length,i=0;i<n;i++)e[i].done(function(){t(++r,n)});return $.when.apply($,e)},$.whenWithProgress(e,function(e,t){var r=parseInt(Math.max(100*e/t,7))+"%";$("#progress-text > span").first().html(r),$("#progress").css("width",r)}).then(function(){startGame()},function(){console.warn("Error occurs when loading resources"),o2.hasDispatchedPreloadError||(window.parent.postMessage('{"type":"oice.preloadDidFail"}',"*"),o2.hasDispatchedPreloadError=!0),setTimeout(preload,3e3)})}else startGame()}function showProgressBar(){o2.hasShowedProgressBar||(o2.hasShowedProgressBar=!0,$("#main-wrapper").append('<div id="progress-bar-wrapper"><div id="progress-bar"><div><div id="progress"></div></div><div id="progress-text"><span>0%</span><span></span></div></div></div>'))}function startGame(){o2.preloadPerformanceMonitorTimerId&&(clearInterval(o2.preloadPerformanceMonitorTimerId),o2.preloadPerformanceMonitorTimerId=void 0);var e=$("#progress-bar-wrapper");e&&e.fadeOut(1e3,function(){$(this).remove()}),o2.wasPreviouslyPlayingBGM=!1,document.addEventListener("visibilitychange",function(){var e="visible"==document.visibilityState;e?o2.wasPreviouslyPlayingBGM&&(o2.bgm.play(),console.log("Resume bgm")):o2.bgm.isPlaying?(o2.wasPreviouslyPlayingBGM=!0,o2.bgm.pause(),console.log("Pause bgm")):o2.wasPreviouslyPlayingBGM=!1}),extraConductor=new SubRoutineConductor,o2.serverStat.mode===o2.SERVER_MODE_O2SERVER&&(o2.currentSaveAdapter=new Tag.actions.save.adapters.O2ServerAdapter);var t=_KAGFiles("first.ks");$.when(t).then(function(e){currentConductor=conductor=new Conductor({file:e}),conductor.run(),setupEventHandlers(),$(o2).trigger("init"),window.parent!=window.self&&window.parent.postMessage("scriptLoaded","*")}),(browser.isIOs||browser.isAndroid)&&$("body").one("touchstart",function(e){o2.bgm.dummyLoad();for(var t=o2.se.length-1;t>=0;t--)o2.se[t].dummyLoad();for(var r=o2.videos.length-1;r>=0;r--)o2.videos[r].dummyLoad()}),"undefined"!=typeof FPSMeter&&(window.meter=new FPSMeter({smoothing:2,position:"fixed",top:"auto",left:"auto",bottom:"0px",right:"0px",graph:1,heat:1}))}var _get=function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,r,n)}if("value"in i)return i.value;var a=i.get;if(void 0!==a)return a.call(n)},_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e,t){function r(e){var t=e.length,r=oe.type(e);return!oe.isWindow(e)&&(!(1!==e.nodeType||!t)||("array"===r||"function"!==r&&(0===t||"number"==typeof t&&t>0&&t-1 in e)))}function n(e){var t=pe[e]={};return oe.each(e.match(se)||[],function(e,r){t[r]=!0}),t}function i(){Object.defineProperty(this.cache={},0,{get:function(){return{}}}),this.expando=oe.expando+Math.random()}function o(e,r,n){var i;if(n===t&&1===e.nodeType)if(i="data-"+r.replace(ve,"-$1").toLowerCase(),n=e.getAttribute(i),"string"==typeof n){try{n="true"===n||"false"!==n&&("null"===n?null:+n+""===n?+n:me.test(n)?JSON.parse(n):n)}catch(o){}ge.set(e,r,n)}else n=t;return n}function a(){return!0}function s(){return!1}function c(){try{return H.activeElement}catch(e){}}function u(e,t){for(;(e=e[t])&&1!==e.nodeType;);return e}function l(e,t,r){if(oe.isFunction(t))return oe.grep(e,function(e,n){return!!t.call(e,n,e)!==r});if(t.nodeType)return oe.grep(e,function(e){return e===t!==r});if("string"==typeof t){if(Oe.test(t))return oe.filter(t,e,r);t=oe.filter(t,e)}return oe.grep(e,function(e){return te.call(t,e)>=0!==r})}function h(e,t){return oe.nodeName(e,"table")&&oe.nodeName(1===t.nodeType?t:t.firstChild,"tr")?e.getElementsByTagName("tbody")[0]||e.appendChild(e.ownerDocument.createElement("tbody")):e}function f(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function d(e){var t=Pe.exec(e.type);return t?e.type=t[1]:e.removeAttribute("type"),e}function p(e,t){for(var r=e.length,n=0;r>n;n++)ye.set(e[n],"globalEval",!t||ye.get(t[n],"globalEval"))}function g(e,t){var r,n,i,o,a,s,c,u;if(1===t.nodeType){if(ye.hasData(e)&&(o=ye.access(e),a=oe.extend({},o),u=o.events,ye.set(t,a),u)){delete a.handle,a.events={};for(i in u)for(r=0,n=u[i].length;n>r;r++)oe.event.add(t,i,u[i][r])}ge.hasData(e)&&(s=ge.access(e),c=oe.extend({},s),ge.set(t,c))}}function y(e,r){var n=e.getElementsByTagName?e.getElementsByTagName(r||"*"):e.querySelectorAll?e.querySelectorAll(r||"*"):[];return r===t||r&&oe.nodeName(e,r)?oe.merge([e],n):n}function m(e,t){var r=t.nodeName.toLowerCase();"input"===r&&Me.test(e.type)?t.checked=e.checked:("input"===r||"textarea"===r)&&(t.defaultValue=e.defaultValue)}function v(e,t){if(t in e)return t;for(var r=t.charAt(0).toUpperCase()+t.slice(1),n=t,i=Ze.length;i--;)if(t=Ze[i]+r,t in e)return t;return n}function w(e,t){return e=t||e,"none"===oe.css(e,"display")||!oe.contains(e.ownerDocument,e)}function T(t){return e.getComputedStyle(t,null)}function b(e,t){for(var r,n,i,o=[],a=0,s=e.length;s>a;a++)n=e[a],n.style&&(o[a]=ye.get(n,"olddisplay"),r=n.style.display,t?(o[a]||"none"!==r||(n.style.display=""),""===n.style.display&&w(n)&&(o[a]=ye.access(n,"olddisplay",S(n.nodeName)))):o[a]||(i=w(n),(r&&"none"!==r||!i)&&ye.set(n,"olddisplay",i?r:oe.css(n,"display"))));for(a=0;s>a;a++)n=e[a],n.style&&(t&&"none"!==n.style.display&&""!==n.style.display||(n.style.display=t?o[a]||"":"none"));return e}function L(e,t,r){var n=He.exec(t);return n?Math.max(0,n[1]-(r||0))+(n[2]||"px"):t}function x(e,t,r,n,i){for(var o=r===(n?"border":"content")?4:"width"===t?1:0,a=0;4>o;o+=2)"margin"===r&&(a+=oe.css(e,r+Je[o],!0,i)),n?("content"===r&&(a-=oe.css(e,"padding"+Je[o],!0,i)),"margin"!==r&&(a-=oe.css(e,"border"+Je[o]+"Width",!0,i))):(a+=oe.css(e,"padding"+Je[o],!0,i),"padding"!==r&&(a+=oe.css(e,"border"+Je[o]+"Width",!0,i)));return a}function C(e,t,r){var n=!0,i="width"===t?e.offsetWidth:e.offsetHeight,o=T(e),a=oe.support.boxSizing&&"border-box"===oe.css(e,"boxSizing",!1,o);if(0>=i||null==i){if(i=je(e,t,o),(0>i||null==i)&&(i=e.style[t]),Ke.test(i))return i;n=a&&(oe.support.boxSizingReliable||i===e.style[t]),i=parseFloat(i)||0}return i+x(e,t,r||(a?"border":"content"),n,o)+"px"}function S(e){var t=H,r=Ue[e];return r||(r=k(e,t),"none"!==r&&r||(Ve=(Ve||oe("<iframe frameborder='0' width='0' height='0'/>").css("cssText","display:block !important")).appendTo(t.documentElement),t=(Ve[0].contentWindow||Ve[0].contentDocument).document,t.write("<!doctype html><html><body>"),t.close(),r=k(e,t),Ve.detach()),Ue[e]=r),r}function k(e,t){var r=oe(t.createElement(e)).appendTo(t.body),n=oe.css(r[0],"display");return r.remove(),n}function A(e,t,r,n){var i;if(oe.isArray(t))oe.each(t,function(t,i){r||et.test(e)?n(e,i):A(e+"["+("object"==("undefined"==typeof i?"undefined":_typeof(i))?t:"")+"]",i,r,n)});else if(r||"object"!==oe.type(t))n(e,t);else for(i in t)A(e+"["+i+"]",t[i],r,n)}function O(e){return function(t,r){"string"!=typeof t&&(r=t,t="*");var n,i=0,o=t.toLowerCase().match(se)||[];if(oe.isFunction(r))for(;n=o[i++];)"+"===n[0]?(n=n.slice(1)||"*",(e[n]=e[n]||[]).unshift(r)):(e[n]=e[n]||[]).push(r)}}function _(e,r,n,i){function o(c){var u;return a[c]=!0,oe.each(e[c]||[],function(e,c){var l=c(r,n,i);return"string"!=typeof l||s||a[l]?s?!(u=l):t:(r.dataTypes.unshift(l),o(l),!1)}),u}var a={},s=e===mt;return o(r.dataTypes[0])||!a["*"]&&o("*")}function R(e,r){var n,i,o=oe.ajaxSettings.flatOptions||{};for(n in r)r[n]!==t&&((o[n]?e:i||(i={}))[n]=r[n]);return i&&oe.extend(!0,e,i),e}function N(e,r,n){for(var i,o,a,s,c=e.contents,u=e.dataTypes;"*"===u[0];)u.shift(),i===t&&(i=e.mimeType||r.getResponseHeader("Content-Type"));if(i)for(o in c)if(c[o]&&c[o].test(i)){u.unshift(o);break}if(u[0]in n)a=u[0];else{for(o in n){if(!u[0]||e.converters[o+" "+u[0]]){a=o;break}s||(s=o)}a=a||s}return a?(a!==u[0]&&u.unshift(a),n[a]):t}function E(e,t,r,n){var i,o,a,s,c,u={},l=e.dataTypes.slice();if(l[1])for(a in e.converters)u[a.toLowerCase()]=e.converters[a];for(o=l.shift();o;)if(e.responseFields[o]&&(r[e.responseFields[o]]=t),!c&&n&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),c=o,o=l.shift())if("*"===o)o=c;else if("*"!==c&&c!==o){if(a=u[c+" "+o]||u["* "+o],!a)for(i in u)if(s=i.split(" "),s[1]===o&&(a=u[c+" "+s[0]]||u["* "+s[0]])){a===!0?a=u[i]:u[i]!==!0&&(o=s[0],l.unshift(s[1]));break}if(a!==!0)if(a&&e["throws"])t=a(t);else try{t=a(t)}catch(h){return{state:"parsererror",error:a?h:"No conversion from "+c+" to "+o}}}return{state:"success",data:t}}function D(){return setTimeout(function(){kt=t}),kt=oe.now()}function I(e,t){oe.each(t,function(t,r){for(var n=(Et[t]||[]).concat(Et["*"]),i=0,o=n.length;o>i;i++)if(n[i].call(e,t,r))return})}function M(e,t,r){var n,i,o=0,a=Nt.length,s=oe.Deferred().always(function(){delete c.elem}),c=function h(){if(i)return!1;for(var t=kt||D(),r=Math.max(0,u.startTime+u.duration-t),n=r/u.duration||0,o=1-n,a=0,h=u.tweens.length;h>a;a++)u.tweens[a].run(o);return s.notifyWith(e,[u,o,r]),1>o&&h?r:(s.resolveWith(e,[u]),!1)},u=s.promise({elem:e,props:oe.extend({},t),opts:oe.extend(!0,{specialEasing:{}},r),originalProperties:t,originalOptions:r,startTime:kt||D(),duration:r.duration,tweens:[],createTween:function(t,r){var n=oe.Tween(e,u.opts,t,r,u.opts.specialEasing[t]||u.opts.easing);return u.tweens.push(n),n},stop:function(t){var r=0,n=t?u.tweens.length:0;if(i)return this;for(i=!0;n>r;r++)u.tweens[r].run(1);return t?s.resolveWith(e,[u,t]):s.rejectWith(e,[u,t]),this}}),l=u.props;for(F(l,u.opts.specialEasing);a>o;o++)if(n=Nt[o].call(u,e,l,u.opts))return n;return I(u,l),oe.isFunction(u.opts.start)&&u.opts.start.call(e,u),oe.fx.timer(oe.extend(c,{elem:e,anim:u,queue:u.opts.queue})),u.progress(u.opts.progress).done(u.opts.done,u.opts.complete).fail(u.opts.fail).always(u.opts.always)}function F(e,t){var r,n,i,o,a;for(r in e)if(n=oe.camelCase(r),i=t[n],o=e[r],oe.isArray(o)&&(i=o[1],o=e[r]=o[0]),r!==n&&(e[n]=o,delete e[r]),a=oe.cssHooks[n],a&&"expand"in a){o=a.expand(o),delete e[n];for(r in o)r in e||(e[r]=o[r],t[r]=i)}else t[n]=i}function B(e,r,n){var i,o,a,s,c,u,l,h,f,d=this,p=e.style,g={},y=[],m=e.nodeType&&w(e);n.queue||(h=oe._queueHooks(e,"fx"),null==h.unqueued&&(h.unqueued=0,f=h.empty.fire,h.empty.fire=function(){h.unqueued||f()}),h.unqueued++,d.always(function(){d.always(function(){h.unqueued--,oe.queue(e,"fx").length||h.empty.fire()})})),1===e.nodeType&&("height"in r||"width"in r)&&(n.overflow=[p.overflow,p.overflowX,p.overflowY],"inline"===oe.css(e,"display")&&"none"===oe.css(e,"float")&&(p.display="inline-block")),n.overflow&&(p.overflow="hidden",d.always(function(){p.overflow=n.overflow[0],p.overflowX=n.overflow[1],p.overflowY=n.overflow[2]})),c=ye.get(e,"fxshow");for(i in r)if(a=r[i],Ot.exec(a)){if(delete r[i],u=u||"toggle"===a,a===(m?"hide":"show")){if("show"!==a||c===t||c[i]===t)continue;m=!0}y.push(i)}if(s=y.length){c=ye.get(e,"fxshow")||ye.access(e,"fxshow",{}),"hidden"in c&&(m=c.hidden),u&&(c.hidden=!m),m?oe(e).show():d.done(function(){oe(e).hide()}),d.done(function(){var t;ye.remove(e,"fxshow");for(t in g)oe.style(e,t,g[t])});for(i=0;s>i;i++)o=y[i],l=d.createTween(o,m?c[o]:0),g[o]=c[o]||oe.style(e,o),o in c||(c[o]=l.start,m&&(l.end=l.start,l.start="width"===o||"height"===o?1:0))}}function P(e,t,r,n,i){return new P.prototype.init(e,t,r,n,i)}function G(e,t){var r,n={height:e},i=0;for(t=t?1:0;4>i;i+=2-t)r=Je[i],n["margin"+r]=n["padding"+r]=e;return t&&(n.opacity=n.width=e),n}function z(e){return oe.isWindow(e)?e:9===e.nodeType&&e.defaultView}var j,V,q="undefined"==typeof t?"undefined":_typeof(t),$=e.location,H=e.document,K=H.documentElement,W=e.jQuery,U=e.$,Y={},X=[],J="2.0.0",Z=X.concat,Q=X.push,ee=X.slice,te=X.indexOf,re=Y.toString,ne=Y.hasOwnProperty,ie=J.trim,oe=function Dt(e,t){return new Dt.fn.init(e,t,j)},ae=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,se=/\S+/g,ce=/^(?:(<[\w\W]+>)[^>]*|#([\w-]*))$/,ue=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,le=/^-ms-/,he=/-([\da-z])/gi,fe=function(e,t){return t.toUpperCase()},de=function It(){H.removeEventListener("DOMContentLoaded",It,!1),e.removeEventListener("load",It,!1),oe.ready()};oe.fn=oe.prototype={jquery:J,constructor:oe,init:function(e,r,n){var i,o;if(!e)return this;if("string"==typeof e){if(i="<"===e.charAt(0)&&">"===e.charAt(e.length-1)&&e.length>=3?[null,e,null]:ce.exec(e),!i||!i[1]&&r)return!r||r.jquery?(r||n).find(e):this.constructor(r).find(e);if(i[1]){if(r=r instanceof oe?r[0]:r,oe.merge(this,oe.parseHTML(i[1],r&&r.nodeType?r.ownerDocument||r:H,!0)),ue.test(i[1])&&oe.isPlainObject(r))for(i in r)oe.isFunction(this[i])?this[i](r[i]):this.attr(i,r[i]);return this}return o=H.getElementById(i[2]),o&&o.parentNode&&(this.length=1,this[0]=o),this.context=H,this.selector=e,this}return e.nodeType?(this.context=this[0]=e,this.length=1,this):oe.isFunction(e)?n.ready(e):(e.selector!==t&&(this.selector=e.selector,this.context=e.context),oe.makeArray(e,this))},selector:"",length:0,toArray:function(){return ee.call(this)},get:function(e){return null==e?this.toArray():0>e?this[this.length+e]:this[e]},pushStack:function(e){var t=oe.merge(this.constructor(),e);return t.prevObject=this,t.context=this.context,t},each:function(e,t){return oe.each(this,e,t)},ready:function(e){return oe.ready.promise().done(e),this},slice:function(){return this.pushStack(ee.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,r=+e+(0>e?t:0);return this.pushStack(r>=0&&t>r?[this[r]]:[])},map:function(e){return this.pushStack(oe.map(this,function(t,r){return e.call(t,r,t)}))},end:function(){return this.prevObject||this.constructor(null)},push:Q,sort:[].sort,splice:[].splice},oe.fn.init.prototype=oe.fn,oe.extend=oe.fn.extend=function(){var e,r,n,i,o,a,s=arguments[0]||{},c=1,u=arguments.length,l=!1;for("boolean"==typeof s&&(l=s,s=arguments[1]||{},c=2),"object"==("undefined"==typeof s?"undefined":_typeof(s))||oe.isFunction(s)||(s={}),u===c&&(s=this,--c);u>c;c++)if(null!=(e=arguments[c]))for(r in e)n=s[r],i=e[r],s!==i&&(l&&i&&(oe.isPlainObject(i)||(o=oe.isArray(i)))?(o?(o=!1,a=n&&oe.isArray(n)?n:[]):a=n&&oe.isPlainObject(n)?n:{},s[r]=oe.extend(l,a,i)):i!==t&&(s[r]=i));return s},oe.extend({expando:"jQuery"+(J+Math.random()).replace(/\D/g,""),noConflict:function(t){return e.$===oe&&(e.$=U),t&&e.jQuery===oe&&(e.jQuery=W),oe},isReady:!1,readyWait:1,holdReady:function(e){e?oe.readyWait++:oe.ready(!0)},ready:function(e){(e===!0?--oe.readyWait:oe.isReady)||(oe.isReady=!0,e!==!0&&--oe.readyWait>0||(V.resolveWith(H,[oe]),oe.fn.trigger&&oe(H).trigger("ready").off("ready")))},isFunction:function(e){return"function"===oe.type(e)},isArray:Array.isArray,isWindow:function(e){return null!=e&&e===e.window},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},type:function(e){return null==e?e+"":"object"==("undefined"==typeof e?"undefined":_typeof(e))||"function"==typeof e?Y[re.call(e)]||"object":"undefined"==typeof e?"undefined":_typeof(e)},isPlainObject:function(e){if("object"!==oe.type(e)||e.nodeType||oe.isWindow(e))return!1;try{if(e.constructor&&!ne.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(t){return!1}return!0},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},error:function(e){throw Error(e)},parseHTML:function(e,t,r){if(!e||"string"!=typeof e)return null;"boolean"==typeof t&&(r=t,t=!1),t=t||H;var n=ue.exec(e),i=!r&&[];return n?[t.createElement(n[1])]:(n=oe.buildFragment([e],t,i),i&&oe(i).remove(),oe.merge([],n.childNodes))},parseJSON:JSON.parse,parseXML:function(e){var r,n;if(!e||"string"!=typeof e)return null;try{n=new DOMParser,r=n.parseFromString(e,"text/xml")}catch(i){r=t}return(!r||r.getElementsByTagName("parsererror").length)&&oe.error("Invalid XML: "+e),r},noop:function(){},globalEval:function(e){var t,r=eval;e=oe.trim(e),e&&(1===e.indexOf("use strict")?(t=H.createElement("script"),t.text=e,H.head.appendChild(t).parentNode.removeChild(t)):r(e))},camelCase:function(e){return e.replace(le,"ms-").replace(he,fe)},nodeName:function(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()},each:function(e,t,n){var i,o=0,a=e.length,s=r(e);if(n){if(s)for(;a>o&&(i=t.apply(e[o],n),i!==!1);o++);else for(o in e)if(i=t.apply(e[o],n),i===!1)break}else if(s)for(;a>o&&(i=t.call(e[o],o,e[o]),i!==!1);o++);else for(o in e)if(i=t.call(e[o],o,e[o]),i===!1)break;return e},trim:function(e){return null==e?"":ie.call(e)},makeArray:function(e,t){var n=t||[];return null!=e&&(r(Object(e))?oe.merge(n,"string"==typeof e?[e]:e):Q.call(n,e)),n},inArray:function(e,t,r){return null==t?-1:te.call(t,e,r)},merge:function(e,r){var n=r.length,i=e.length,o=0;if("number"==typeof n)for(;n>o;o++)e[i++]=r[o];else for(;r[o]!==t;)e[i++]=r[o++];return e.length=i,e},grep:function(e,t,r){var n,i=[],o=0,a=e.length;for(r=!!r;a>o;o++)n=!!t(e[o],o),r!==n&&i.push(e[o]);return i},map:function(e,t,n){var i,o=0,a=e.length,s=r(e),c=[];if(s)for(;a>o;o++)i=t(e[o],o,n),null!=i&&(c[c.length]=i);else for(o in e)i=t(e[o],o,n),null!=i&&(c[c.length]=i);return Z.apply([],c)},guid:1,proxy:function(e,r){var n,i,o;return"string"==typeof r&&(n=e[r],r=e,e=n),oe.isFunction(e)?(i=ee.call(arguments,2),o=function(){return e.apply(r||this,i.concat(ee.call(arguments)))},o.guid=e.guid=e.guid||oe.guid++,o):t},access:function(e,r,n,i,o,a,s){var c=0,u=e.length,l=null==n;if("object"===oe.type(n)){o=!0;for(c in n)oe.access(e,r,c,n[c],!0,a,s)}else if(i!==t&&(o=!0,oe.isFunction(i)||(s=!0),l&&(s?(r.call(e,i),r=null):(l=r,r=function(e,t,r){return l.call(oe(e),r)})),r))for(;u>c;c++)r(e[c],n,s?i:i.call(e[c],c,r(e[c],n)));return o?e:l?r.call(e):u?r(e[0],n):a},now:Date.now,swap:function(e,t,r,n){var i,o,a={};for(o in t)a[o]=e.style[o],e.style[o]=t[o];i=r.apply(e,n||[]);for(o in t)e.style[o]=a[o];return i}}),oe.ready.promise=function(t){return V||(V=oe.Deferred(),"complete"===H.readyState?setTimeout(oe.ready):(H.addEventListener("DOMContentLoaded",de,!1),e.addEventListener("load",de,!1))),V.promise(t)},oe.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(e,t){Y["[object "+t+"]"]=t.toLowerCase()}),j=oe(H),function(e,t){function r(e){return we.test(e+"")}function n(){var e,t=[];return e=function(r,n){return t.push(r+=" ")>k.cacheLength&&delete e[t.shift()],e[r]=n}}function i(e){return e[z]=!0,e}function o(e){var t=D.createElement("div");try{return!!e(t)}catch(r){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function a(e,t,r,n){var i,o,a,s,c,u,l,h,f,g;if((t?t.ownerDocument||t:j)!==D&&E(t),t=t||D,r=r||[],!e||"string"!=typeof e)return r;if(1!==(s=t.nodeType)&&9!==s)return[];if(M&&!n){if(i=Te.exec(e))if(a=i[1]){if(9===s){if(o=t.getElementById(a),!o||!o.parentNode)return r;if(o.id===a)return r.push(o),r}else if(t.ownerDocument&&(o=t.ownerDocument.getElementById(a))&&G(t,o)&&o.id===a)return r.push(o),r}else{if(i[2])return te.apply(r,t.getElementsByTagName(e)),r;if((a=i[3])&&V.getElementsByClassName&&t.getElementsByClassName)return te.apply(r,t.getElementsByClassName(a)),r}if(V.qsa&&(!F||!F.test(e))){if(h=l=z,f=t,g=9===s&&e,1===s&&"object"!==t.nodeName.toLowerCase()){for(u=d(e),(l=t.getAttribute("id"))?h=l.replace(xe,"\\$&"):t.setAttribute("id",h),h="[id='"+h+"'] ",c=u.length;c--;)u[c]=h+p(u[c]);f=pe.test(e)&&t.parentNode||t,g=u.join(",")}if(g)try{return te.apply(r,f.querySelectorAll(g)),r}catch(y){}finally{l||t.removeAttribute("id")}}}return L(e.replace(he,"$1"),t,r,n)}function s(e,t){var r=t&&e,n=r&&(~t.sourceIndex||J)-(~e.sourceIndex||J);
if(n)return n;if(r)for(;r=r.nextSibling;)if(r===t)return-1;return e?1:-1}function c(e,r,n){var i;return n?t:(i=e.getAttributeNode(r))&&i.specified?i.value:e[r]===!0?r.toLowerCase():null}function u(e,r,n){var i;return n?t:i=e.getAttribute(r,"type"===r.toLowerCase()?1:2)}function l(e){return function(t){var r=t.nodeName.toLowerCase();return"input"===r&&t.type===e}}function h(e){return function(t){var r=t.nodeName.toLowerCase();return("input"===r||"button"===r)&&t.type===e}}function f(e){return i(function(t){return t=+t,i(function(r,n){for(var i,o=e([],r.length,t),a=o.length;a--;)r[i=o[a]]&&(r[i]=!(n[i]=r[i]))})})}function d(e,t){var r,n,i,o,s,c,u,l=K[e+" "];if(l)return t?0:l.slice(0);for(s=e,c=[],u=k.preFilter;s;){(!r||(n=fe.exec(s)))&&(n&&(s=s.slice(n[0].length)||s),c.push(i=[])),r=!1,(n=de.exec(s))&&(r=n.shift(),i.push({value:r,type:n[0].replace(he," ")}),s=s.slice(r.length));for(o in k.filter)!(n=ve[o].exec(s))||u[o]&&!(n=u[o](n))||(r=n.shift(),i.push({value:r,type:o,matches:n}),s=s.slice(r.length));if(!r)break}return t?s.length:s?a.error(e):K(e,c).slice(0)}function p(e){for(var t=0,r=e.length,n="";r>t;t++)n+=e[t].value;return n}function g(e,t,r){var n=t.dir,i=r&&"parentNode"===n,o=$++;return t.first?function(t,r,o){for(;t=t[n];)if(1===t.nodeType||i)return e(t,r,o)}:function(t,r,a){var s,c,u,l=q+" "+o;if(a){for(;t=t[n];)if((1===t.nodeType||i)&&e(t,r,a))return!0}else for(;t=t[n];)if(1===t.nodeType||i)if(u=t[z]||(t[z]={}),(c=u[n])&&c[0]===l){if((s=c[1])===!0||s===S)return s===!0}else if(c=u[n]=[l],c[1]=e(t,r,a)||S,c[1]===!0)return!0}}function y(e){return e.length>1?function(t,r,n){for(var i=e.length;i--;)if(!e[i](t,r,n))return!1;return!0}:e[0]}function m(e,t,r,n,i){for(var o,a=[],s=0,c=e.length,u=null!=t;c>s;s++)(o=e[s])&&(!r||r(o,n,i))&&(a.push(o),u&&t.push(s));return a}function v(e,t,r,n,o,a){return n&&!n[z]&&(n=v(n)),o&&!o[z]&&(o=v(o,a)),i(function(i,a,s,c){var u,l,h,f=[],d=[],p=a.length,g=i||b(t||"*",s.nodeType?[s]:s,[]),y=!e||!i&&t?g:m(g,f,e,s,c),v=r?o||(i?e:p||n)?[]:a:y;if(r&&r(y,v,s,c),n)for(u=m(v,d),n(u,[],s,c),l=u.length;l--;)(h=u[l])&&(v[d[l]]=!(y[d[l]]=h));if(i){if(o||e){if(o){for(u=[],l=v.length;l--;)(h=v[l])&&u.push(y[l]=h);o(null,v=[],u,c)}for(l=v.length;l--;)(h=v[l])&&(u=o?ne.call(i,h):f[l])>-1&&(i[u]=!(a[u]=h))}}else v=m(v===a?v.splice(p,v.length):v),o?o(null,a,v,c):te.apply(a,v)})}function w(e){for(var t,r,n,i=e.length,o=k.relative[e[0].type],a=o||k.relative[" "],s=o?1:0,c=g(function(e){return e===t},a,!0),u=g(function(e){return ne.call(t,e)>-1},a,!0),l=[function(e,r,n){return!o&&(n||r!==R)||((t=r).nodeType?c(e,r,n):u(e,r,n))}];i>s;s++)if(r=k.relative[e[s].type])l=[g(y(l),r)];else{if(r=k.filter[e[s].type].apply(null,e[s].matches),r[z]){for(n=++s;i>n&&!k.relative[e[n].type];n++);return v(s>1&&y(l),s>1&&p(e.slice(0,s-1)).replace(he,"$1"),r,n>s&&w(e.slice(s,n)),i>n&&w(e=e.slice(n)),i>n&&p(e))}l.push(r)}return y(l)}function T(e,t){var r=0,n=t.length>0,o=e.length>0,s=function(i,s,c,u,l){var h,f,d,p=[],g=0,y="0",v=i&&[],w=null!=l,T=R,b=i||o&&k.find.TAG("*",l&&s.parentNode||s),L=q+=null==T?1:Math.random()||.1;for(w&&(R=s!==D&&s,S=r);null!=(h=b[y]);y++){if(o&&h){for(f=0;d=e[f++];)if(d(h,s,c)){u.push(h);break}w&&(q=L,S=++r)}n&&((h=!d&&h)&&g--,i&&v.push(h))}if(g+=y,n&&y!==g){for(f=0;d=t[f++];)d(v,p,s,c);if(i){if(g>0)for(;y--;)v[y]||p[y]||(p[y]=Q.call(u));p=m(p)}te.apply(u,p),w&&!i&&p.length>0&&g+t.length>1&&a.uniqueSort(u)}return w&&(q=L,R=T),v};return n?i(s):s}function b(e,t,r){for(var n=0,i=t.length;i>n;n++)a(e,t[n],r);return r}function L(e,t,r,n){var i,o,a,s,c,u=d(e);if(!n&&1===u.length){if(o=u[0]=u[0].slice(0),o.length>2&&"ID"===(a=o[0]).type&&9===t.nodeType&&M&&k.relative[o[1].type]){if(t=(k.find.ID(a.matches[0].replace(Ce,Se),t)||[])[0],!t)return r;e=e.slice(o.shift().value.length)}for(i=ve.needsContext.test(e)?0:o.length;i--&&(a=o[i],!k.relative[s=a.type]);)if((c=k.find[s])&&(n=c(a.matches[0].replace(Ce,Se),pe.test(o[0].type)&&t.parentNode||t))){if(o.splice(i,1),e=n.length&&p(o),!e)return te.apply(r,n),r;break}}return _(e,u)(n,t,!M,r,pe.test(e)),r}function x(){}var C,S,k,A,O,_,R,N,E,D,I,M,F,B,P,G,z="sizzle"+-new Date,j=e.document,V={},q=0,$=0,H=n(),K=n(),W=n(),U=!1,Y=function(){return 0},X="undefined"==typeof t?"undefined":_typeof(t),J=1<<31,Z=[],Q=Z.pop,ee=Z.push,te=Z.push,re=Z.slice,ne=Z.indexOf||function(e){for(var t=0,r=this.length;r>t;t++)if(this[t]===e)return t;return-1},ie="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",ae="[\\x20\\t\\r\\n\\f]",se="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",ce=se.replace("w","w#"),ue="\\["+ae+"*("+se+")"+ae+"*(?:([*^$|!~]?=)"+ae+"*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+ce+")|)|)"+ae+"*\\]",le=":("+se+")(?:\\(((['\"])((?:\\\\.|[^\\\\])*?)\\3|((?:\\\\.|[^\\\\()[\\]]|"+ue.replace(3,8)+")*)|.*)\\)|)",he=RegExp("^"+ae+"+|((?:^|[^\\\\])(?:\\\\.)*)"+ae+"+$","g"),fe=RegExp("^"+ae+"*,"+ae+"*"),de=RegExp("^"+ae+"*([>+~]|"+ae+")"+ae+"*"),pe=RegExp(ae+"*[+~]"),ge=RegExp("="+ae+"*([^\\]'\"]*)"+ae+"*\\]","g"),ye=RegExp(le),me=RegExp("^"+ce+"$"),ve={ID:RegExp("^#("+se+")"),CLASS:RegExp("^\\.("+se+")"),TAG:RegExp("^("+se.replace("w","w*")+")"),ATTR:RegExp("^"+ue),PSEUDO:RegExp("^"+le),CHILD:RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+ae+"*(even|odd|(([+-]|)(\\d*)n|)"+ae+"*(?:([+-]|)"+ae+"*(\\d+)|))"+ae+"*\\)|)","i"),"boolean":RegExp("^(?:"+ie+")$","i"),needsContext:RegExp("^"+ae+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+ae+"*((?:-\\d)?\\d*)"+ae+"*\\)|)(?=[^-]|$)","i")},we=/^[^{]+\{\s*\[native \w/,Te=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,be=/^(?:input|select|textarea|button)$/i,Le=/^h\d$/i,xe=/'|\\/g,Ce=/\\([\da-fA-F]{1,6}[\x20\t\r\n\f]?|.)/g,Se=function(e,t){var r="0x"+t-65536;return r!==r?t:0>r?String.fromCharCode(r+65536):String.fromCharCode(55296|r>>10,56320|1023&r)};try{te.apply(Z=re.call(j.childNodes),j.childNodes),Z[j.childNodes.length].nodeType}catch(ke){te={apply:Z.length?function(e,t){ee.apply(e,re.call(t))}:function(e,t){for(var r=e.length,n=0;e[r++]=t[n++];);e.length=r-1}}}O=a.isXML=function(e){var t=e&&(e.ownerDocument||e).documentElement;return!!t&&"HTML"!==t.nodeName},E=a.setDocument=function(e){var n=e?e.ownerDocument||e:j;return n!==D&&9===n.nodeType&&n.documentElement?(D=n,I=n.documentElement,M=!O(n),V.getElementsByTagName=o(function(e){return e.appendChild(n.createComment("")),!e.getElementsByTagName("*").length}),V.attributes=o(function(e){return e.className="i",!e.getAttribute("className")}),V.getElementsByClassName=o(function(e){return e.innerHTML="<div class='a'></div><div class='a i'></div>",e.firstChild.className="i",2===e.getElementsByClassName("i").length}),V.sortDetached=o(function(e){return 1&e.compareDocumentPosition(D.createElement("div"))}),V.getById=o(function(e){return I.appendChild(e).id=z,!n.getElementsByName||!n.getElementsByName(z).length}),V.getById?(k.find.ID=function(e,t){if(_typeof(t.getElementById)!==X&&M){var r=t.getElementById(e);return r&&r.parentNode?[r]:[]}},k.filter.ID=function(e){var t=e.replace(Ce,Se);return function(e){return e.getAttribute("id")===t}}):(k.find.ID=function(e,r){if(_typeof(r.getElementById)!==X&&M){var n=r.getElementById(e);return n?n.id===e||_typeof(n.getAttributeNode)!==X&&n.getAttributeNode("id").value===e?[n]:t:[]}},k.filter.ID=function(e){var t=e.replace(Ce,Se);return function(e){var r=_typeof(e.getAttributeNode)!==X&&e.getAttributeNode("id");return r&&r.value===t}}),k.find.TAG=V.getElementsByTagName?function(e,r){return _typeof(r.getElementsByTagName)!==X?r.getElementsByTagName(e):t}:function(e,t){var r,n=[],i=0,o=t.getElementsByTagName(e);if("*"===e){for(;r=o[i++];)1===r.nodeType&&n.push(r);return n}return o},k.find.CLASS=V.getElementsByClassName&&function(e,r){return _typeof(r.getElementsByClassName)!==X&&M?r.getElementsByClassName(e):t},B=[],F=[],(V.qsa=r(n.querySelectorAll))&&(o(function(e){e.innerHTML="<select><option selected=''></option></select>",e.querySelectorAll("[selected]").length||F.push("\\["+ae+"*(?:value|"+ie+")"),e.querySelectorAll(":checked").length||F.push(":checked")}),o(function(e){var t=D.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("t",""),e.querySelectorAll("[t^='']").length&&F.push("[*^$]="+ae+"*(?:''|\"\")"),e.querySelectorAll(":enabled").length||F.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),F.push(",.*:")})),(V.matchesSelector=r(P=I.webkitMatchesSelector||I.mozMatchesSelector||I.oMatchesSelector||I.msMatchesSelector))&&o(function(e){V.disconnectedMatch=P.call(e,"div"),P.call(e,"[s!='']:x"),B.push("!=",le)}),F=F.length&&RegExp(F.join("|")),B=B.length&&RegExp(B.join("|")),G=r(I.contains)||I.compareDocumentPosition?function(e,t){var r=9===e.nodeType?e.documentElement:e,n=t&&t.parentNode;return e===n||!(!n||1!==n.nodeType||!(r.contains?r.contains(n):e.compareDocumentPosition&&16&e.compareDocumentPosition(n)))}:function(e,t){if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},Y=I.compareDocumentPosition?function(e,t){if(e===t)return U=!0,0;var r=t.compareDocumentPosition&&e.compareDocumentPosition&&e.compareDocumentPosition(t);return r?1&r||!V.sortDetached&&t.compareDocumentPosition(e)===r?e===n||G(j,e)?-1:t===n||G(j,t)?1:N?ne.call(N,e)-ne.call(N,t):0:4&r?-1:1:e.compareDocumentPosition?-1:1}:function(e,t){var r,i=0,o=e.parentNode,a=t.parentNode,c=[e],u=[t];if(e===t)return U=!0,0;if(!o||!a)return e===n?-1:t===n?1:o?-1:a?1:N?ne.call(N,e)-ne.call(N,t):0;if(o===a)return s(e,t);for(r=e;r=r.parentNode;)c.unshift(r);for(r=t;r=r.parentNode;)u.unshift(r);for(;c[i]===u[i];)i++;return i?s(c[i],u[i]):c[i]===j?-1:u[i]===j?1:0},D):D},a.matches=function(e,t){return a(e,null,null,t)},a.matchesSelector=function(e,t){if((e.ownerDocument||e)!==D&&E(e),t=t.replace(ge,"='$1']"),!(!V.matchesSelector||!M||B&&B.test(t)||F&&F.test(t)))try{var r=P.call(e,t);if(r||V.disconnectedMatch||e.document&&11!==e.document.nodeType)return r}catch(n){}return a(t,D,null,[e]).length>0},a.contains=function(e,t){return(e.ownerDocument||e)!==D&&E(e),G(e,t)},a.attr=function(e,r){(e.ownerDocument||e)!==D&&E(e);var n=k.attrHandle[r.toLowerCase()],i=n&&n(e,r,!M);return i===t?V.attributes||!M?e.getAttribute(r):(i=e.getAttributeNode(r))&&i.specified?i.value:null:i},a.error=function(e){throw Error("Syntax error, unrecognized expression: "+e)},a.uniqueSort=function(e){var t,r=[],n=0,i=0;if(U=!V.detectDuplicates,N=!V.sortStable&&e.slice(0),e.sort(Y),U){for(;t=e[i++];)t===e[i]&&(n=r.push(i));for(;n--;)e.splice(r[n],1)}return e},A=a.getText=function(e){var t,r="",n=0,i=e.nodeType;if(i){if(1===i||9===i||11===i){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)r+=A(e)}else if(3===i||4===i)return e.nodeValue}else for(;t=e[n];n++)r+=A(t);return r},k=a.selectors={cacheLength:50,createPseudo:i,match:ve,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(Ce,Se),e[3]=(e[4]||e[5]||"").replace(Ce,Se),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||a.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&a.error(e[0]),e},PSEUDO:function(e){var t,r=!e[5]&&e[2];return ve.CHILD.test(e[0])?null:(e[4]?e[2]=e[4]:r&&ye.test(r)&&(t=d(r,!0))&&(t=r.indexOf(")",r.length-t)-r.length)&&(e[0]=e[0].slice(0,t),e[2]=r.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(Ce,Se).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=H[e+" "];return t||(t=RegExp("(^|"+ae+")"+e+"("+ae+"|$)"))&&H(e,function(e){return t.test("string"==typeof e.className&&e.className||_typeof(e.getAttribute)!==X&&e.getAttribute("class")||"")})},ATTR:function(e,t,r){return function(n){var i=a.attr(n,e);return null==i?"!="===t:!t||(i+="","="===t?i===r:"!="===t?i!==r:"^="===t?r&&0===i.indexOf(r):"*="===t?r&&i.indexOf(r)>-1:"$="===t?r&&i.slice(-r.length)===r:"~="===t?(" "+i+" ").indexOf(r)>-1:"|="===t&&(i===r||i.slice(0,r.length+1)===r+"-"))}},CHILD:function(e,t,r,n,i){var o="nth"!==e.slice(0,3),a="last"!==e.slice(-4),s="of-type"===t;return 1===n&&0===i?function(e){return!!e.parentNode}:function(t,r,c){var u,l,h,f,d,p,g=o!==a?"nextSibling":"previousSibling",y=t.parentNode,m=s&&t.nodeName.toLowerCase(),v=!c&&!s;if(y){if(o){for(;g;){for(h=t;h=h[g];)if(s?h.nodeName.toLowerCase()===m:1===h.nodeType)return!1;p=g="only"===e&&!p&&"nextSibling"}return!0}if(p=[a?y.firstChild:y.lastChild],a&&v){for(l=y[z]||(y[z]={}),u=l[e]||[],d=u[0]===q&&u[1],f=u[0]===q&&u[2],h=d&&y.childNodes[d];h=++d&&h&&h[g]||(f=d=0)||p.pop();)if(1===h.nodeType&&++f&&h===t){l[e]=[q,d,f];break}}else if(v&&(u=(t[z]||(t[z]={}))[e])&&u[0]===q)f=u[1];else for(;(h=++d&&h&&h[g]||(f=d=0)||p.pop())&&((s?h.nodeName.toLowerCase()!==m:1!==h.nodeType)||!++f||(v&&((h[z]||(h[z]={}))[e]=[q,f]),h!==t)););return f-=i,f===n||0===f%n&&f/n>=0}}},PSEUDO:function(e,t){var r,n=k.pseudos[e]||k.setFilters[e.toLowerCase()]||a.error("unsupported pseudo: "+e);return n[z]?n(t):n.length>1?(r=[e,e,"",t],k.setFilters.hasOwnProperty(e.toLowerCase())?i(function(e,r){for(var i,o=n(e,t),a=o.length;a--;)i=ne.call(e,o[a]),e[i]=!(r[i]=o[a])}):function(e){return n(e,0,r)}):n}},pseudos:{not:i(function(e){var t=[],r=[],n=_(e.replace(he,"$1"));return n[z]?i(function(e,t,r,i){for(var o,a=n(e,null,i,[]),s=e.length;s--;)(o=a[s])&&(e[s]=!(t[s]=o))}):function(e,i,o){return t[0]=e,n(t,null,o,r),!r.pop()}}),has:i(function(e){return function(t){return a(e,t).length>0}}),contains:i(function(e){return function(t){return(t.textContent||t.innerText||A(t)).indexOf(e)>-1}}),lang:i(function(e){return me.test(e||"")||a.error("unsupported lang: "+e),e=e.replace(Ce,Se).toLowerCase(),function(t){var r;do if(r=M?t.lang:t.getAttribute("xml:lang")||t.getAttribute("lang"))return r=r.toLowerCase(),r===e||0===r.indexOf(e+"-");while((t=t.parentNode)&&1===t.nodeType);return!1}}),target:function(t){var r=e.location&&e.location.hash;return r&&r.slice(1)===t.id},root:function(e){return e===I},focus:function(e){return e===D.activeElement&&(!D.hasFocus||D.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:function(e){return e.disabled===!1},disabled:function(e){return e.disabled===!0},checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,e.selected===!0},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeName>"@"||3===e.nodeType||4===e.nodeType)return!1;return!0},parent:function(e){return!k.pseudos.empty(e)},header:function(e){return Le.test(e.nodeName)},input:function(e){return be.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||t.toLowerCase()===e.type)},first:f(function(){return[0]}),last:f(function(e,t){return[t-1]}),eq:f(function(e,t,r){return[0>r?r+t:r]}),even:f(function(e,t){for(var r=0;t>r;r+=2)e.push(r);return e}),odd:f(function(e,t){for(var r=1;t>r;r+=2)e.push(r);return e}),lt:f(function(e,t,r){for(var n=0>r?r+t:r;--n>=0;)e.push(n);return e}),gt:f(function(e,t,r){for(var n=0>r?r+t:r;t>++n;)e.push(n);return e})}};for(C in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})k.pseudos[C]=l(C);for(C in{submit:!0,reset:!0})k.pseudos[C]=h(C);_=a.compile=function(e,t){var r,n=[],i=[],o=W[e+" "];if(!o){for(t||(t=d(e)),r=t.length;r--;)o=w(t[r]),o[z]?n.push(o):i.push(o);o=W(e,T(i,n))}return o},k.pseudos.nth=k.pseudos.eq,x.prototype=k.filters=k.pseudos,k.setFilters=new x,V.sortStable=z.split("").sort(Y).join("")===z,E(),[0,0].sort(Y),V.detectDuplicates=U,o(function(e){if(e.innerHTML="<a href='#'></a>","#"!==e.firstChild.getAttribute("href"))for(var t="type|href|height|width".split("|"),r=t.length;r--;)k.attrHandle[t[r]]=u}),o(function(e){if(null!=e.getAttribute("disabled"))for(var t=ie.split("|"),r=t.length;r--;)k.attrHandle[t[r]]=c}),oe.find=a,oe.expr=a.selectors,oe.expr[":"]=oe.expr.pseudos,oe.unique=a.uniqueSort,oe.text=a.getText,oe.isXMLDoc=a.isXML,oe.contains=a.contains}(e);var pe={};oe.Callbacks=function(e){e="string"==typeof e?pe[e]||n(e):oe.extend({},e);var r,i,o,a,s,c,u=[],l=!e.once&&[],h=function d(t){for(r=e.memory&&t,i=!0,c=a||0,a=0,s=u.length,o=!0;u&&s>c;c++)if(u[c].apply(t[0],t[1])===!1&&e.stopOnFalse){r=!1;break}o=!1,u&&(l?l.length&&d(l.shift()):r?u=[]:f.disable())},f={add:function(){if(u){var t=u.length;!function n(t){oe.each(t,function(t,r){var i=oe.type(r);"function"===i?e.unique&&f.has(r)||u.push(r):r&&r.length&&"string"!==i&&n(r)})}(arguments),o?s=u.length:r&&(a=t,h(r))}return this},remove:function(){return u&&oe.each(arguments,function(e,t){for(var r;(r=oe.inArray(t,u,r))>-1;)u.splice(r,1),o&&(s>=r&&s--,c>=r&&c--)}),this},has:function(e){return e?oe.inArray(e,u)>-1:!(!u||!u.length)},empty:function(){return u=[],s=0,this},disable:function(){return u=l=r=t,this},disabled:function(){return!u},lock:function(){return l=t,r||f.disable(),this},locked:function(){return!l},fireWith:function(e,t){return t=t||[],t=[e,t.slice?t.slice():t],!u||i&&!l||(o?l.push(t):h(t)),this},fire:function(){return f.fireWith(this,arguments),this},fired:function(){return!!i}};return f},oe.extend({Deferred:function(e){var t=[["resolve","done",oe.Callbacks("once memory"),"resolved"],["reject","fail",oe.Callbacks("once memory"),"rejected"],["notify","progress",oe.Callbacks("memory")]],r="pending",n={state:function(){return r},always:function(){return i.done(arguments).fail(arguments),this},then:function(){var e=arguments;return oe.Deferred(function(r){oe.each(t,function(t,o){var a=o[0],s=oe.isFunction(e[t])&&e[t];i[o[1]](function(){var e=s&&s.apply(this,arguments);e&&oe.isFunction(e.promise)?e.promise().done(r.resolve).fail(r.reject).progress(r.notify):r[a+"With"](this===n?r.promise():this,s?[e]:arguments)})}),e=null}).promise()},promise:function(e){return null!=e?oe.extend(e,n):n}},i={};return n.pipe=n.then,oe.each(t,function(e,o){var a=o[2],s=o[3];n[o[1]]=a.add,s&&a.add(function(){r=s},t[1^e][2].disable,t[2][2].lock),i[o[0]]=function(){return i[o[0]+"With"](this===i?n:this,arguments),this},i[o[0]+"With"]=a.fireWith}),n.promise(i),e&&e.call(i,i),i},when:function(e){var t,r,n,i=0,o=ee.call(arguments),a=o.length,s=1!==a||e&&oe.isFunction(e.promise)?a:0,c=1===s?e:oe.Deferred(),u=function(e,r,n){return function(i){r[e]=this,n[e]=arguments.length>1?ee.call(arguments):i,n===t?c.notifyWith(r,n):--s||c.resolveWith(r,n)}};if(a>1)for(t=Array(a),r=Array(a),n=Array(a);a>i;i++)o[i]&&oe.isFunction(o[i].promise)?o[i].promise().done(u(i,n,o)).fail(c.reject).progress(u(i,r,t)):--s;return s||c.resolveWith(n,o),c.promise()}}),oe.support=function(t){var r=H.createElement("input"),n=H.createDocumentFragment(),i=H.createElement("div"),o=H.createElement("select"),a=o.appendChild(H.createElement("option"));return r.type?(r.type="checkbox",t.checkOn=""!==r.value,t.optSelected=a.selected,t.reliableMarginRight=!0,t.boxSizingReliable=!0,t.pixelPosition=!1,r.checked=!0,t.noCloneChecked=r.cloneNode(!0).checked,o.disabled=!0,t.optDisabled=!a.disabled,r=H.createElement("input"),r.value="t",r.type="radio",t.radioValue="t"===r.value,r.setAttribute("checked","t"),r.setAttribute("name","t"),n.appendChild(r),t.checkClone=n.cloneNode(!0).cloneNode(!0).lastChild.checked,t.focusinBubbles="onfocusin"in e,i.style.backgroundClip="content-box",i.cloneNode(!0).style.backgroundClip="",t.clearCloneStyle="content-box"===i.style.backgroundClip,oe(function(){var r,n,o="padding:0;margin:0;border:0;display:block;-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box",a=H.getElementsByTagName("body")[0];a&&(r=H.createElement("div"),r.style.cssText="border:0;width:0;height:0;position:absolute;top:0;left:-9999px;margin-top:1px",a.appendChild(r).appendChild(i),i.innerHTML="",i.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;padding:1px;border:1px;display:block;width:4px;margin-top:1%;position:absolute;top:1%",oe.swap(a,null!=a.style.zoom?{zoom:1}:{},function(){t.boxSizing=4===i.offsetWidth}),e.getComputedStyle&&(t.pixelPosition="1%"!==(e.getComputedStyle(i,null)||{}).top,t.boxSizingReliable="4px"===(e.getComputedStyle(i,null)||{width:"4px"}).width,n=i.appendChild(H.createElement("div")),n.style.cssText=i.style.cssText=o,n.style.marginRight=n.style.width="0",i.style.width="1px",t.reliableMarginRight=!parseFloat((e.getComputedStyle(n,null)||{}).marginRight)),a.removeChild(r))}),t):t}({});var ge,ye,me=/(?:\{[\s\S]*\}|\[[\s\S]*\])$/,ve=/([A-Z])/g;i.uid=1,i.accepts=function(e){return!e.nodeType||(1===e.nodeType||9===e.nodeType)},i.prototype={key:function(e){if(!i.accepts(e))return 0;var t={},r=e[this.expando];if(!r){r=i.uid++;try{t[this.expando]={value:r},Object.defineProperties(e,t)}catch(n){t[this.expando]=r,oe.extend(e,t)}}return this.cache[r]||(this.cache[r]={}),r},set:function(e,t,r){var n,i=this.key(e),o=this.cache[i];if("string"==typeof t)o[t]=r;else if(oe.isEmptyObject(o))this.cache[i]=t;else for(n in t)o[n]=t[n]},get:function(e,r){var n=this.cache[this.key(e)];return r===t?n:n[r]},access:function(e,r,n){return r===t||r&&"string"==typeof r&&n===t?this.get(e,r):(this.set(e,r,n),n!==t?n:r)},remove:function(e,r){var n,i,o=this.key(e),a=this.cache[o];if(r===t)this.cache[o]={};else{oe.isArray(r)?i=r.concat(r.map(oe.camelCase)):r in a?i=[r]:(i=oe.camelCase(r),i=i in a?[i]:i.match(se)||[]),n=i.length;for(;n--;)delete a[i[n]]}},hasData:function(e){return!oe.isEmptyObject(this.cache[e[this.expando]]||{})},discard:function(e){delete this.cache[this.key(e)]}},ge=new i,ye=new i,oe.extend({acceptData:i.accepts,hasData:function(e){return ge.hasData(e)||ye.hasData(e)},data:function(e,t,r){return ge.access(e,t,r)},removeData:function(e,t){ge.remove(e,t)},_data:function(e,t,r){return ye.access(e,t,r)},_removeData:function(e,t){ye.remove(e,t)}}),oe.fn.extend({data:function(e,r){var n,i,a=this[0],s=0,c=null;if(e===t){if(this.length&&(c=ge.get(a),1===a.nodeType&&!ye.get(a,"hasDataAttrs"))){for(n=a.attributes;n.length>s;s++)i=n[s].name,0===i.indexOf("data-")&&(i=oe.camelCase(i.substring(5)),o(a,i,c[i]));ye.set(a,"hasDataAttrs",!0)}return c}return"object"==("undefined"==typeof e?"undefined":_typeof(e))?this.each(function(){ge.set(this,e)}):oe.access(this,function(r){var n,i=oe.camelCase(e);if(a&&r===t){if(n=ge.get(a,e),n!==t)return n;if(n=ge.get(a,i),n!==t)return n;if(n=o(a,i,t),n!==t)return n}else this.each(function(){var n=ge.get(this,i);ge.set(this,i,r),-1!==e.indexOf("-")&&n!==t&&ge.set(this,e,r)})},null,r,arguments.length>1,null,!0)},removeData:function(e){return this.each(function(){ge.remove(this,e)})}}),oe.extend({queue:function(e,r,n){var i;return e?(r=(r||"fx")+"queue",i=ye.get(e,r),n&&(!i||oe.isArray(n)?i=ye.access(e,r,oe.makeArray(n)):i.push(n)),i||[]):t},dequeue:function(e,t){t=t||"fx";var r=oe.queue(e,t),n=r.length,i=r.shift(),o=oe._queueHooks(e,t),a=function(){oe.dequeue(e,t)};"inprogress"===i&&(i=r.shift(),n--),o.cur=i,i&&("fx"===t&&r.unshift("inprogress"),delete o.stop,i.call(e,a,o)),!n&&o&&o.empty.fire()},_queueHooks:function(e,t){var r=t+"queueHooks";return ye.get(e,r)||ye.access(e,r,{empty:oe.Callbacks("once memory").add(function(){ye.remove(e,[t+"queue",r])})})}}),oe.fn.extend({queue:function(e,r){var n=2;return"string"!=typeof e&&(r=e,e="fx",n--),n>arguments.length?oe.queue(this[0],e):r===t?this:this.each(function(){var t=oe.queue(this,e,r);oe._queueHooks(this,e),"fx"===e&&"inprogress"!==t[0]&&oe.dequeue(this,e)})},dequeue:function(e){return this.each(function(){oe.dequeue(this,e)})},delay:function(e,t){return e=oe.fx?oe.fx.speeds[e]||e:e,t=t||"fx",this.queue(t,function(t,r){var n=setTimeout(t,e);r.stop=function(){clearTimeout(n)}})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,r){var n,i=1,o=oe.Deferred(),a=this,s=this.length,c=function(){--i||o.resolveWith(a,[a])};for("string"!=typeof e&&(r=e,e=t),e=e||"fx";s--;)n=ye.get(a[s],e+"queueHooks"),n&&n.empty&&(i++,n.empty.add(c));return c(),o.promise(r)}});var we,Te,be=/[\t\r\n]/g,Le=/\r/g,xe=/^(?:input|select|textarea|button)$/i;oe.fn.extend({attr:function(e,t){return oe.access(this,oe.attr,e,t,arguments.length>1)},removeAttr:function(e){return this.each(function(){oe.removeAttr(this,e)})},prop:function(e,t){return oe.access(this,oe.prop,e,t,arguments.length>1)},removeProp:function(e){return this.each(function(){delete this[oe.propFix[e]||e]})},addClass:function(e){var t,r,n,i,o,a=0,s=this.length,c="string"==typeof e&&e;if(oe.isFunction(e))return this.each(function(t){oe(this).addClass(e.call(this,t,this.className))});if(c)for(t=(e||"").match(se)||[];s>a;a++)if(r=this[a],n=1===r.nodeType&&(r.className?(" "+r.className+" ").replace(be," "):" ")){for(o=0;i=t[o++];)0>n.indexOf(" "+i+" ")&&(n+=i+" ");r.className=oe.trim(n)}return this},removeClass:function(e){var t,r,n,i,o,a=0,s=this.length,c=0===arguments.length||"string"==typeof e&&e;if(oe.isFunction(e))return this.each(function(t){oe(this).removeClass(e.call(this,t,this.className))});if(c)for(t=(e||"").match(se)||[];s>a;a++)if(r=this[a],n=1===r.nodeType&&(r.className?(" "+r.className+" ").replace(be," "):"")){for(o=0;i=t[o++];)for(;n.indexOf(" "+i+" ")>=0;)n=n.replace(" "+i+" "," ");r.className=e?oe.trim(n):""}return this},toggleClass:function(e,t){var r="undefined"==typeof e?"undefined":_typeof(e),n="boolean"==typeof t;return oe.isFunction(e)?this.each(function(r){oe(this).toggleClass(e.call(this,r,this.className,t),t)}):this.each(function(){if("string"===r)for(var i,o=0,a=oe(this),s=t,c=e.match(se)||[];i=c[o++];)s=n?s:!a.hasClass(i),a[s?"addClass":"removeClass"](i);else(r===q||"boolean"===r)&&(this.className&&ye.set(this,"__className__",this.className),this.className=this.className||e===!1?"":ye.get(this,"__className__")||"")})},hasClass:function(e){for(var t=" "+e+" ",r=0,n=this.length;n>r;r++)if(1===this[r].nodeType&&(" "+this[r].className+" ").replace(be," ").indexOf(t)>=0)return!0;return!1},val:function(e){var r,n,i,o=this[0];return arguments.length?(i=oe.isFunction(e),this.each(function(n){var o,a=oe(this);1===this.nodeType&&(o=i?e.call(this,n,a.val()):e,null==o?o="":"number"==typeof o?o+="":oe.isArray(o)&&(o=oe.map(o,function(e){return null==e?"":e+""})),r=oe.valHooks[this.type]||oe.valHooks[this.nodeName.toLowerCase()],r&&"set"in r&&r.set(this,o,"value")!==t||(this.value=o))})):o?(r=oe.valHooks[o.type]||oe.valHooks[o.nodeName.toLowerCase()],r&&"get"in r&&(n=r.get(o,"value"))!==t?n:(n=o.value,"string"==typeof n?n.replace(Le,""):null==n?"":n)):void 0}}),oe.extend({valHooks:{option:{get:function(e){var t=e.attributes.value;return!t||t.specified?e.value:e.text}},select:{get:function(e){for(var t,r,n=e.options,i=e.selectedIndex,o="select-one"===e.type||0>i,a=o?null:[],s=o?i+1:n.length,c=0>i?s:o?i:0;s>c;c++)if(r=n[c],!(!r.selected&&c!==i||(oe.support.optDisabled?r.disabled:null!==r.getAttribute("disabled"))||r.parentNode.disabled&&oe.nodeName(r.parentNode,"optgroup"))){if(t=oe(r).val(),o)return t;a.push(t)}return a},set:function(e,t){for(var r,n,i=e.options,o=oe.makeArray(t),a=i.length;a--;)n=i[a],(n.selected=oe.inArray(oe(n).val(),o)>=0)&&(r=!0);return r||(e.selectedIndex=-1),o}}},attr:function(e,r,n){var i,o,a=e.nodeType;if(e&&3!==a&&8!==a&&2!==a)return _typeof(e.getAttribute)===q?oe.prop(e,r,n):(1===a&&oe.isXMLDoc(e)||(r=r.toLowerCase(),i=oe.attrHooks[r]||(oe.expr.match["boolean"].test(r)?Te:we)),n===t?i&&"get"in i&&null!==(o=i.get(e,r))?o:(o=oe.find.attr(e,r),null==o?t:o):null!==n?i&&"set"in i&&(o=i.set(e,n,r))!==t?o:(e.setAttribute(r,n+""),n):(oe.removeAttr(e,r),t))},removeAttr:function(e,t){var r,n,i=0,o=t&&t.match(se);if(o&&1===e.nodeType)for(;r=o[i++];)n=oe.propFix[r]||r,oe.expr.match["boolean"].test(r)&&(e[n]=!1),e.removeAttribute(r)},attrHooks:{type:{set:function(e,t){if(!oe.support.radioValue&&"radio"===t&&oe.nodeName(e,"input")){var r=e.value;return e.setAttribute("type",t),r&&(e.value=r),t}}}},propFix:{"for":"htmlFor","class":"className"},prop:function(e,r,n){var i,o,a,s=e.nodeType;if(e&&3!==s&&8!==s&&2!==s)return a=1!==s||!oe.isXMLDoc(e),a&&(r=oe.propFix[r]||r,o=oe.propHooks[r]),n!==t?o&&"set"in o&&(i=o.set(e,n,r))!==t?i:e[r]=n:o&&"get"in o&&null!==(i=o.get(e,r))?i:e[r]},propHooks:{tabIndex:{get:function(e){return e.hasAttribute("tabindex")||xe.test(e.nodeName)||e.href?e.tabIndex:-1}}}}),Te={set:function(e,t,r){return t===!1?oe.removeAttr(e,r):e.setAttribute(r,r),r}},oe.each(oe.expr.match["boolean"].source.match(/\w+/g),function(e,r){var n=oe.expr.attrHandle[r]||oe.find.attr;oe.expr.attrHandle[r]=function(e,r,i){var o=oe.expr.attrHandle[r],a=i?t:(oe.expr.attrHandle[r]=t)!=n(e,r,i)?r.toLowerCase():null;return oe.expr.attrHandle[r]=o,a}}),oe.support.optSelected||(oe.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null}}),oe.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){oe.propFix[this.toLowerCase()]=this}),oe.each(["radio","checkbox"],function(){oe.valHooks[this]={set:function(e,r){return oe.isArray(r)?e.checked=oe.inArray(oe(e).val(),r)>=0:t}},oe.support.checkOn||(oe.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})});var Ce=/^key/,Se=/^(?:mouse|contextmenu)|click/,ke=/^(?:focusinfocus|focusoutblur)$/,Ae=/^([^.]*)(?:\.(.+)|)$/;oe.event={global:{},add:function(e,r,n,i,o){var a,s,c,u,l,h,f,d,p,g,y,m=ye.get(e);if(m){for(n.handler&&(a=n,n=a.handler,o=a.selector),n.guid||(n.guid=oe.guid++),(u=m.events)||(u=m.events={}),(s=m.handle)||(s=m.handle=function(e){return("undefined"==typeof oe?"undefined":_typeof(oe))===q||e&&oe.event.triggered===e.type?t:oe.event.dispatch.apply(s.elem,arguments)},s.elem=e),r=(r||"").match(se)||[""],l=r.length;l--;)c=Ae.exec(r[l])||[],p=y=c[1],g=(c[2]||"").split(".").sort(),p&&(f=oe.event.special[p]||{},p=(o?f.delegateType:f.bindType)||p,f=oe.event.special[p]||{},h=oe.extend({type:p,origType:y,data:i,handler:n,guid:n.guid,selector:o,needsContext:o&&oe.expr.match.needsContext.test(o),namespace:g.join(".")},a),(d=u[p])||(d=u[p]=[],d.delegateCount=0,f.setup&&f.setup.call(e,i,g,s)!==!1||e.addEventListener&&e.addEventListener(p,s,!1)),f.add&&(f.add.call(e,h),h.handler.guid||(h.handler.guid=n.guid)),o?d.splice(d.delegateCount++,0,h):d.push(h),oe.event.global[p]=!0);e=null}},remove:function(e,t,r,n,i){var o,a,s,c,u,l,h,f,d,p,g,y=ye.hasData(e)&&ye.get(e);if(y&&(c=y.events)){for(t=(t||"").match(se)||[""],u=t.length;u--;)if(s=Ae.exec(t[u])||[],d=g=s[1],p=(s[2]||"").split(".").sort(),d){for(h=oe.event.special[d]||{},d=(n?h.delegateType:h.bindType)||d,f=c[d]||[],s=s[2]&&RegExp("(^|\\.)"+p.join("\\.(?:.*\\.|)")+"(\\.|$)"),a=o=f.length;o--;)l=f[o],!i&&g!==l.origType||r&&r.guid!==l.guid||s&&!s.test(l.namespace)||n&&n!==l.selector&&("**"!==n||!l.selector)||(f.splice(o,1),l.selector&&f.delegateCount--,h.remove&&h.remove.call(e,l));a&&!f.length&&(h.teardown&&h.teardown.call(e,p,y.handle)!==!1||oe.removeEvent(e,d,y.handle),delete c[d])}else for(d in c)oe.event.remove(e,d+t[u],r,n,!0);oe.isEmptyObject(c)&&(delete y.handle,ye.remove(e,"events"))}},trigger:function(r,n,i,o){var a,s,c,u,l,h,f,d=[i||H],p=ne.call(r,"type")?r.type:r,g=ne.call(r,"namespace")?r.namespace.split("."):[];if(s=c=i=i||H,3!==i.nodeType&&8!==i.nodeType&&!ke.test(p+oe.event.triggered)&&(p.indexOf(".")>=0&&(g=p.split("."),p=g.shift(),g.sort()),l=0>p.indexOf(":")&&"on"+p,r=r[oe.expando]?r:new oe.Event(p,"object"==("undefined"==typeof r?"undefined":_typeof(r))&&r),r.isTrigger=o?2:3,r.namespace=g.join("."),r.namespace_re=r.namespace?RegExp("(^|\\.)"+g.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,r.result=t,r.target||(r.target=i),n=null==n?[r]:oe.makeArray(n,[r]),f=oe.event.special[p]||{},o||!f.trigger||f.trigger.apply(i,n)!==!1)){if(!o&&!f.noBubble&&!oe.isWindow(i)){for(u=f.delegateType||p,ke.test(u+p)||(s=s.parentNode);s;s=s.parentNode)d.push(s),
c=s;c===(i.ownerDocument||H)&&d.push(c.defaultView||c.parentWindow||e)}for(a=0;(s=d[a++])&&!r.isPropagationStopped();)r.type=a>1?u:f.bindType||p,h=(ye.get(s,"events")||{})[r.type]&&ye.get(s,"handle"),h&&h.apply(s,n),h=l&&s[l],h&&oe.acceptData(s)&&h.apply&&h.apply(s,n)===!1&&r.preventDefault();return r.type=p,o||r.isDefaultPrevented()||f._default&&f._default.apply(d.pop(),n)!==!1||!oe.acceptData(i)||l&&oe.isFunction(i[p])&&!oe.isWindow(i)&&(c=i[l],c&&(i[l]=null),oe.event.triggered=p,i[p](),oe.event.triggered=t,c&&(i[l]=c)),r.result}},dispatch:function(e){e=oe.event.fix(e);var r,n,i,o,a,s=[],c=ee.call(arguments),u=(ye.get(this,"events")||{})[e.type]||[],l=oe.event.special[e.type]||{};if(c[0]=e,e.delegateTarget=this,!l.preDispatch||l.preDispatch.call(this,e)!==!1){for(s=oe.event.handlers.call(this,e,u),r=0;(o=s[r++])&&!e.isPropagationStopped();)for(e.currentTarget=o.elem,n=0;(a=o.handlers[n++])&&!e.isImmediatePropagationStopped();)(!e.namespace_re||e.namespace_re.test(a.namespace))&&(e.handleObj=a,e.data=a.data,i=((oe.event.special[a.origType]||{}).handle||a.handler).apply(o.elem,c),i!==t&&(e.result=i)===!1&&(e.preventDefault(),e.stopPropagation()));return l.postDispatch&&l.postDispatch.call(this,e),e.result}},handlers:function(e,r){var n,i,o,a,s=[],c=r.delegateCount,u=e.target;if(c&&u.nodeType&&(!e.button||"click"!==e.type))for(;u!==this;u=u.parentNode||this)if(u.disabled!==!0||"click"!==e.type){for(i=[],n=0;c>n;n++)a=r[n],o=a.selector+" ",i[o]===t&&(i[o]=a.needsContext?oe(o,this).index(u)>=0:oe.find(o,this,null,[u]).length),i[o]&&i.push(a);i.length&&s.push({elem:u,handlers:i})}return r.length>c&&s.push({elem:this,handlers:r.slice(c)}),s},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(e,t){return null==e.which&&(e.which=null!=t.charCode?t.charCode:t.keyCode),e}},mouseHooks:{props:"button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(e,r){var n,i,o,a=r.button;return null==e.pageX&&null!=r.clientX&&(n=e.target.ownerDocument||H,i=n.documentElement,o=n.body,e.pageX=r.clientX+(i&&i.scrollLeft||o&&o.scrollLeft||0)-(i&&i.clientLeft||o&&o.clientLeft||0),e.pageY=r.clientY+(i&&i.scrollTop||o&&o.scrollTop||0)-(i&&i.clientTop||o&&o.clientTop||0)),e.which||a===t||(e.which=1&a?1:2&a?3:4&a?2:0),e}},fix:function(e){if(e[oe.expando])return e;var t,r,n,i=e.type,o=e,a=this.fixHooks[i];for(a||(this.fixHooks[i]=a=Se.test(i)?this.mouseHooks:Ce.test(i)?this.keyHooks:{}),n=a.props?this.props.concat(a.props):this.props,e=new oe.Event(o),t=n.length;t--;)r=n[t],e[r]=o[r];return 3===e.target.nodeType&&(e.target=e.target.parentNode),a.filter?a.filter(e,o):e},special:{load:{noBubble:!0},focus:{trigger:function(){return this!==c()&&this.focus?(this.focus(),!1):t},delegateType:"focusin"},blur:{trigger:function(){return this===c()&&this.blur?(this.blur(),!1):t},delegateType:"focusout"},click:{trigger:function(){return"checkbox"===this.type&&this.click&&oe.nodeName(this,"input")?(this.click(),!1):t},_default:function(e){return oe.nodeName(e.target,"a")}},beforeunload:{postDispatch:function(e){e.result!==t&&(e.originalEvent.returnValue=e.result)}}},simulate:function(e,t,r,n){var i=oe.extend(new oe.Event,r,{type:e,isSimulated:!0,originalEvent:{}});n?oe.event.trigger(i,null,t):oe.event.dispatch.call(t,i),i.isDefaultPrevented()&&r.preventDefault()}},oe.removeEvent=function(e,t,r){e.removeEventListener&&e.removeEventListener(t,r,!1)},oe.Event=function(e,r){return this instanceof oe.Event?(e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||e.getPreventDefault&&e.getPreventDefault()?a:s):this.type=e,r&&oe.extend(this,r),this.timeStamp=e&&e.timeStamp||oe.now(),this[oe.expando]=!0,t):new oe.Event(e,r)},oe.Event.prototype={isDefaultPrevented:s,isPropagationStopped:s,isImmediatePropagationStopped:s,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=a,e&&e.preventDefault&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=a,e&&e.stopPropagation&&e.stopPropagation()},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=a,this.stopPropagation()}},oe.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(e,t){oe.event.special[e]={delegateType:t,bindType:t,handle:function(e){var r,n=this,i=e.relatedTarget,o=e.handleObj;return(!i||i!==n&&!oe.contains(n,i))&&(e.type=o.origType,r=o.handler.apply(this,arguments),e.type=t),r}}}),oe.support.focusinBubbles||oe.each({focus:"focusin",blur:"focusout"},function(e,t){var r=0,n=function(e){oe.event.simulate(t,e.target,oe.event.fix(e),!0)};oe.event.special[t]={setup:function(){0===r++&&H.addEventListener(e,n,!0)},teardown:function(){0===--r&&H.removeEventListener(e,n,!0)}}}),oe.fn.extend({on:function(e,r,n,i,o){var a,c;if("object"==("undefined"==typeof e?"undefined":_typeof(e))){"string"!=typeof r&&(n=n||r,r=t);for(c in e)this.on(c,r,n,e[c],o);return this}if(null==n&&null==i?(i=r,n=r=t):null==i&&("string"==typeof r?(i=n,n=t):(i=n,n=r,r=t)),i===!1)i=s;else if(!i)return this;return 1===o&&(a=i,i=function(e){return oe().off(e),a.apply(this,arguments)},i.guid=a.guid||(a.guid=oe.guid++)),this.each(function(){oe.event.add(this,e,i,n,r)})},one:function(e,t,r,n){return this.on(e,t,r,n,1)},off:function(e,r,n){var i,o;if(e&&e.preventDefault&&e.handleObj)return i=e.handleObj,oe(e.delegateTarget).off(i.namespace?i.origType+"."+i.namespace:i.origType,i.selector,i.handler),this;if("object"==("undefined"==typeof e?"undefined":_typeof(e))){for(o in e)this.off(o,r,e[o]);return this}return(r===!1||"function"==typeof r)&&(n=r,r=t),n===!1&&(n=s),this.each(function(){oe.event.remove(this,e,n,r)})},trigger:function(e,t){return this.each(function(){oe.event.trigger(e,t,this)})},triggerHandler:function(e,r){var n=this[0];return n?oe.event.trigger(e,r,n,!0):t}});var Oe=/^.[^:#\[\.,]*$/,_e=oe.expr.match.needsContext,Re={children:!0,contents:!0,next:!0,prev:!0};oe.fn.extend({find:function(e){var t,r,n,i=this.length;if("string"!=typeof e)return t=this,this.pushStack(oe(e).filter(function(){for(n=0;i>n;n++)if(oe.contains(t[n],this))return!0}));for(r=[],n=0;i>n;n++)oe.find(e,this[n],r);return r=this.pushStack(i>1?oe.unique(r):r),r.selector=(this.selector?this.selector+" ":"")+e,r},has:function(e){var t=oe(e,this),r=t.length;return this.filter(function(){for(var e=0;r>e;e++)if(oe.contains(this,t[e]))return!0})},not:function(e){return this.pushStack(l(this,e||[],!0))},filter:function(e){return this.pushStack(l(this,e||[],!1))},is:function(e){return!!e&&("string"==typeof e?_e.test(e)?oe(e,this.context).index(this[0])>=0:oe.filter(e,this).length>0:this.filter(e).length>0)},closest:function(e,t){for(var r,n=0,i=this.length,o=[],a=_e.test(e)||"string"!=typeof e?oe(e,t||this.context):0;i>n;n++)for(r=this[n];r&&r!==t;r=r.parentNode)if(11>r.nodeType&&(a?a.index(r)>-1:1===r.nodeType&&oe.find.matchesSelector(r,e))){r=o.push(r);break}return this.pushStack(o.length>1?oe.unique(o):o)},index:function(e){return e?"string"==typeof e?te.call(oe(e),this[0]):te.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){var r="string"==typeof e?oe(e,t):oe.makeArray(e&&e.nodeType?[e]:e),n=oe.merge(this.get(),r);return this.pushStack(oe.unique(n))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),oe.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return oe.dir(e,"parentNode")},parentsUntil:function(e,t,r){return oe.dir(e,"parentNode",r)},next:function(e){return u(e,"nextSibling")},prev:function(e){return u(e,"previousSibling")},nextAll:function(e){return oe.dir(e,"nextSibling")},prevAll:function(e){return oe.dir(e,"previousSibling")},nextUntil:function(e,t,r){return oe.dir(e,"nextSibling",r)},prevUntil:function(e,t,r){return oe.dir(e,"previousSibling",r)},siblings:function(e){return oe.sibling((e.parentNode||{}).firstChild,e)},children:function(e){return oe.sibling(e.firstChild)},contents:function(e){return oe.nodeName(e,"iframe")?e.contentDocument||e.contentWindow.document:oe.merge([],e.childNodes)}},function(e,t){oe.fn[e]=function(r,n){var i=oe.map(this,t,r);return"Until"!==e.slice(-5)&&(n=r),n&&"string"==typeof n&&(i=oe.filter(n,i)),this.length>1&&(Re[e]||oe.unique(i),"p"===e[0]&&i.reverse()),this.pushStack(i)}}),oe.extend({filter:function(e,t,r){var n=t[0];return r&&(e=":not("+e+")"),1===t.length&&1===n.nodeType?oe.find.matchesSelector(n,e)?[n]:[]:oe.find.matches(e,oe.grep(t,function(e){return 1===e.nodeType}))},dir:function(e,r,n){for(var i=[],o=n!==t;(e=e[r])&&9!==e.nodeType;)if(1===e.nodeType){if(o&&oe(e).is(n))break;i.push(e)}return i},sibling:function(e,t){for(var r=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&r.push(e);return r}});var Ne=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,Ee=/<([\w:]+)/,De=/<|&#?\w+;/,Ie=/<(?:script|style|link)/i,Me=/^(?:checkbox|radio)$/i,Fe=/checked\s*(?:[^=]|=\s*.checked.)/i,Be=/^$|\/(?:java|ecma)script/i,Pe=/^true\/(.*)/,Ge=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,ze={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};ze.optgroup=ze.option,ze.tbody=ze.tfoot=ze.colgroup=ze.caption=ze.col=ze.thead,ze.th=ze.td,oe.fn.extend({text:function(e){return oe.access(this,function(e){return e===t?oe.text(this):this.empty().append((this[0]&&this[0].ownerDocument||H).createTextNode(e))},null,e,arguments.length)},append:function(){return this.domManip(arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=h(this,e);t.appendChild(e)}})},prepend:function(){return this.domManip(arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=h(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return this.domManip(arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return this.domManip(arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},remove:function(e,t){for(var r,n=e?oe.filter(e,this):this,i=0;null!=(r=n[i]);i++)t||1!==r.nodeType||oe.cleanData(y(r)),r.parentNode&&(t&&oe.contains(r.ownerDocument,r)&&p(y(r,"script")),r.parentNode.removeChild(r));return this},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(oe.cleanData(y(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return oe.clone(this,e,t)})},html:function(e){return oe.access(this,function(e){var r=this[0]||{},n=0,i=this.length;if(e===t&&1===r.nodeType)return r.innerHTML;if("string"==typeof e&&!Ie.test(e)&&!ze[(Ee.exec(e)||["",""])[1].toLowerCase()]){e=e.replace(Ne,"<$1></$2>");try{for(;i>n;n++)r=this[n]||{},1===r.nodeType&&(oe.cleanData(y(r,!1)),r.innerHTML=e);r=0}catch(o){}}r&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var e=oe.map(this,function(e){return[e.nextSibling,e.parentNode]}),t=0;return this.domManip(arguments,function(r){var n=e[t++],i=e[t++];i&&(oe(this).remove(),i.insertBefore(r,n))},!0),t?this:this.remove()},detach:function(e){return this.remove(e,!0)},domManip:function(e,t,r){e=Z.apply([],e);var n,i,o,a,s,c,u=0,l=this.length,h=this,p=l-1,g=e[0],m=oe.isFunction(g);if(m||!(1>=l||"string"!=typeof g||oe.support.checkClone)&&Fe.test(g))return this.each(function(n){var i=h.eq(n);m&&(e[0]=g.call(this,n,i.html())),i.domManip(e,t,r)});if(l&&(n=oe.buildFragment(e,this[0].ownerDocument,!1,!r&&this),i=n.firstChild,1===n.childNodes.length&&(n=i),i)){for(o=oe.map(y(n,"script"),f),a=o.length;l>u;u++)s=n,u!==p&&(s=oe.clone(s,!0,!0),a&&oe.merge(o,y(s,"script"))),t.call(this[u],s,u);if(a)for(c=o[o.length-1].ownerDocument,oe.map(o,d),u=0;a>u;u++)s=o[u],Be.test(s.type||"")&&!ye.access(s,"globalEval")&&oe.contains(c,s)&&(s.src?oe._evalUrl(s.src):oe.globalEval(s.textContent.replace(Ge,"")))}return this}}),oe.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,t){oe.fn[e]=function(e){for(var r,n=[],i=oe(e),o=i.length-1,a=0;o>=a;a++)r=a===o?this:this.clone(!0),oe(i[a])[t](r),Q.apply(n,r.get());return this.pushStack(n)}}),oe.extend({clone:function(e,t,r){var n,i,o,a,s=e.cloneNode(!0),c=oe.contains(e.ownerDocument,e);if(!(oe.support.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||oe.isXMLDoc(e)))for(a=y(s),o=y(e),n=0,i=o.length;i>n;n++)m(o[n],a[n]);if(t)if(r)for(o=o||y(e),a=a||y(s),n=0,i=o.length;i>n;n++)g(o[n],a[n]);else g(e,s);return a=y(s,"script"),a.length>0&&p(a,!c&&y(e,"script")),s},buildFragment:function(e,t,r,n){for(var i,o,a,s,c,u,l=0,h=e.length,f=t.createDocumentFragment(),d=[];h>l;l++)if(i=e[l],i||0===i)if("object"===oe.type(i))oe.merge(d,i.nodeType?[i]:i);else if(De.test(i)){for(o=o||f.appendChild(t.createElement("div")),a=(Ee.exec(i)||["",""])[1].toLowerCase(),s=ze[a]||ze._default,o.innerHTML=s[1]+i.replace(Ne,"<$1></$2>")+s[2],u=s[0];u--;)o=o.firstChild;oe.merge(d,o.childNodes),o=f.firstChild,o.textContent=""}else d.push(t.createTextNode(i));for(f.textContent="",l=0;i=d[l++];)if((!n||-1===oe.inArray(i,n))&&(c=oe.contains(i.ownerDocument,i),o=y(f.appendChild(i),"script"),c&&p(o),r))for(u=0;i=o[u++];)Be.test(i.type||"")&&r.push(i);return f},cleanData:function(e){for(var t,r,n,i=e.length,o=0,a=oe.event.special;i>o;o++){if(r=e[o],oe.acceptData(r)&&(t=ye.access(r)))for(n in t.events)a[n]?oe.event.remove(r,n):oe.removeEvent(r,n,t.handle);ge.discard(r),ye.discard(r)}},_evalUrl:function(e){return oe.ajax({url:e,type:"GET",dataType:"text",async:!1,global:!1,success:oe.globalEval})}}),oe.fn.extend({wrapAll:function(e){var t;return oe.isFunction(e)?this.each(function(t){oe(this).wrapAll(e.call(this,t))}):(this[0]&&(t=oe(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){for(var e=this;e.firstElementChild;)e=e.firstElementChild;return e}).append(this)),this)},wrapInner:function(e){return oe.isFunction(e)?this.each(function(t){oe(this).wrapInner(e.call(this,t))}):this.each(function(){var t=oe(this),r=t.contents();r.length?r.wrapAll(e):t.append(e)})},wrap:function(e){var t=oe.isFunction(e);return this.each(function(r){oe(this).wrapAll(t?e.call(this,r):e)})},unwrap:function(){return this.parent().each(function(){oe.nodeName(this,"body")||oe(this).replaceWith(this.childNodes)}).end()}});var je,Ve,qe=/^(none|table(?!-c[ea]).+)/,$e=/^margin/,He=RegExp("^("+ae+")(.*)$","i"),Ke=RegExp("^("+ae+")(?!px)[a-z%]+$","i"),We=RegExp("^([+-])=("+ae+")","i"),Ue={BODY:"block"},Ye={position:"absolute",visibility:"hidden",display:"block"},Xe={letterSpacing:0,fontWeight:400},Je=["Top","Right","Bottom","Left"],Ze=["Webkit","O","Moz","ms"];oe.fn.extend({css:function(e,r){return oe.access(this,function(e,r,n){var i,o,a={},s=0;if(oe.isArray(r)){for(i=T(e),o=r.length;o>s;s++)a[r[s]]=oe.css(e,r[s],!1,i);return a}return n!==t?oe.style(e,r,n):oe.css(e,r)},e,r,arguments.length>1)},show:function(){return b(this,!0)},hide:function(){return b(this)},toggle:function(e){var t="boolean"==typeof e;return this.each(function(){(t?e:w(this))?oe(this).show():oe(this).hide()})}}),oe.extend({cssHooks:{opacity:{get:function(e,t){if(t){var r=je(e,"opacity");return""===r?"1":r}}}},cssNumber:{columnCount:!0,fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":"cssFloat"},style:function(e,r,n,i){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var o,a,s,c=oe.camelCase(r),u=e.style;return r=oe.cssProps[c]||(oe.cssProps[c]=v(u,c)),s=oe.cssHooks[r]||oe.cssHooks[c],n===t?s&&"get"in s&&(o=s.get(e,!1,i))!==t?o:u[r]:(a="undefined"==typeof n?"undefined":_typeof(n),"string"===a&&(o=We.exec(n))&&(n=(o[1]+1)*o[2]+parseFloat(oe.css(e,r)),a="number"),null==n||"number"===a&&isNaN(n)||("number"!==a||oe.cssNumber[c]||(n+="px"),oe.support.clearCloneStyle||""!==n||0!==r.indexOf("background")||(u[r]="inherit"),s&&"set"in s&&(n=s.set(e,n,i))===t||(u[r]=n)),t)}},css:function(e,r,n,i){var o,a,s,c=oe.camelCase(r);return r=oe.cssProps[c]||(oe.cssProps[c]=v(e.style,c)),s=oe.cssHooks[r]||oe.cssHooks[c],s&&"get"in s&&(o=s.get(e,!0,n)),o===t&&(o=je(e,r,i)),"normal"===o&&r in Xe&&(o=Xe[r]),""===n||n?(a=parseFloat(o),n===!0||oe.isNumeric(a)?a||0:o):o}}),je=function(e,r,n){var i,o,a,s=n||T(e),c=s?s.getPropertyValue(r)||s[r]:t,u=e.style;return s&&(""!==c||oe.contains(e.ownerDocument,e)||(c=oe.style(e,r)),Ke.test(c)&&$e.test(r)&&(i=u.width,o=u.minWidth,a=u.maxWidth,u.minWidth=u.maxWidth=u.width=c,c=s.width,u.width=i,u.minWidth=o,u.maxWidth=a)),c},oe.each(["height","width"],function(e,r){oe.cssHooks[r]={get:function(e,n,i){return n?0===e.offsetWidth&&qe.test(oe.css(e,"display"))?oe.swap(e,Ye,function(){return C(e,r,i)}):C(e,r,i):t},set:function(e,t,n){var i=n&&T(e);return L(e,t,n?x(e,r,n,oe.support.boxSizing&&"border-box"===oe.css(e,"boxSizing",!1,i),i):0)}}}),oe(function(){oe.support.reliableMarginRight||(oe.cssHooks.marginRight={get:function(e,r){return r?oe.swap(e,{display:"inline-block"},je,[e,"marginRight"]):t}}),!oe.support.pixelPosition&&oe.fn.position&&oe.each(["top","left"],function(e,r){oe.cssHooks[r]={get:function(e,n){return n?(n=je(e,r),Ke.test(n)?oe(e).position()[r]+"px":n):t}}})}),oe.expr&&oe.expr.filters&&(oe.expr.filters.hidden=function(e){return 0>=e.offsetWidth&&0>=e.offsetHeight},oe.expr.filters.visible=function(e){return!oe.expr.filters.hidden(e)}),oe.each({margin:"",padding:"",border:"Width"},function(e,t){oe.cssHooks[e+t]={expand:function(r){for(var n=0,i={},o="string"==typeof r?r.split(" "):[r];4>n;n++)i[e+Je[n]+t]=o[n]||o[n-2]||o[0];return i}},$e.test(e)||(oe.cssHooks[e+t].set=L)});var Qe=/%20/g,et=/\[\]$/,tt=/\r?\n/g,rt=/^(?:submit|button|image|reset|file)$/i,nt=/^(?:input|select|textarea|keygen)/i;oe.fn.extend({serialize:function(){return oe.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=oe.prop(this,"elements");return e?oe.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!oe(this).is(":disabled")&&nt.test(this.nodeName)&&!rt.test(e)&&(this.checked||!Me.test(e))}).map(function(e,t){var r=oe(this).val();return null==r?null:oe.isArray(r)?oe.map(r,function(e){return{name:t.name,value:e.replace(tt,"\r\n")}}):{name:t.name,value:r.replace(tt,"\r\n")}}).get()}}),oe.param=function(e,r){var n,i=[],o=function(e,t){t=oe.isFunction(t)?t():null==t?"":t,i[i.length]=encodeURIComponent(e)+"="+encodeURIComponent(t)};if(r===t&&(r=oe.ajaxSettings&&oe.ajaxSettings.traditional),oe.isArray(e)||e.jquery&&!oe.isPlainObject(e))oe.each(e,function(){o(this.name,this.value)});else for(n in e)A(n,e[n],r,o);return i.join("&").replace(Qe,"+")},oe.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(e,t){oe.fn[t]=function(e,r){return arguments.length>0?this.on(t,null,e,r):this.trigger(t)}}),oe.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)},bind:function(e,t,r){return this.on(e,null,t,r)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,r,n){return this.on(t,e,r,n)},undelegate:function(e,t,r){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",r)}});var it,ot,at=oe.now(),st=/\?/,ct=/#.*$/,ut=/([?&])_=[^&]*/,lt=/^(.*?):[ \t]*([^\r\n]*)$/gm,ht=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,ft=/^(?:GET|HEAD)$/,dt=/^\/\//,pt=/^([\w.+-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,gt=oe.fn.load,yt={},mt={},vt="*/".concat("*");try{ot=$.href}catch(wt){ot=H.createElement("a"),ot.href="",ot=ot.href}it=pt.exec(ot.toLowerCase())||[],oe.fn.load=function(e,r,n){if("string"!=typeof e&&gt)return gt.apply(this,arguments);var i,o,a,s=this,c=e.indexOf(" ");return c>=0&&(i=e.slice(c),e=e.slice(0,c)),oe.isFunction(r)?(n=r,r=t):r&&"object"==("undefined"==typeof r?"undefined":_typeof(r))&&(o="POST"),s.length>0&&oe.ajax({url:e,type:o,dataType:"html",data:r}).done(function(e){a=arguments,s.html(i?oe("<div>").append(oe.parseHTML(e)).find(i):e)}).complete(n&&function(e,t){s.each(n,a||[e.responseText,t,e])}),this},oe.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){oe.fn[t]=function(e){return this.on(t,e)}}),oe.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:ot,type:"GET",isLocal:ht.test(it[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":vt,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":oe.parseJSON,"text xml":oe.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?R(R(e,oe.ajaxSettings),t):R(oe.ajaxSettings,e)},ajaxPrefilter:O(yt),ajaxTransport:O(mt),ajax:function(e,r){function n(e,r,n,s){var u,h,v,w,b,x=r;2!==T&&(T=2,c&&clearTimeout(c),i=t,a=s||"",L.readyState=e>0?4:0,u=e>=200&&300>e||304===e,n&&(w=N(f,L,n)),w=E(f,w,L,u),u?(f.ifModified&&(b=L.getResponseHeader("Last-Modified"),b&&(oe.lastModified[o]=b),b=L.getResponseHeader("etag"),b&&(oe.etag[o]=b)),204===e?x="nocontent":304===e?x="notmodified":(x=w.state,h=w.data,v=w.error,u=!v)):(v=x,(e||!x)&&(x="error",0>e&&(e=0))),L.status=e,L.statusText=(r||x)+"",u?g.resolveWith(d,[h,x,L]):g.rejectWith(d,[L,x,v]),L.statusCode(m),m=t,l&&p.trigger(u?"ajaxSuccess":"ajaxError",[L,f,u?h:v]),y.fireWith(d,[L,x]),l&&(p.trigger("ajaxComplete",[L,f]),--oe.active||oe.event.trigger("ajaxStop")))}"object"==("undefined"==typeof e?"undefined":_typeof(e))&&(r=e,e=t),r=r||{};var i,o,a,s,c,u,l,h,f=oe.ajaxSetup({},r),d=f.context||f,p=f.context&&(d.nodeType||d.jquery)?oe(d):oe.event,g=oe.Deferred(),y=oe.Callbacks("once memory"),m=f.statusCode||{},v={},w={},T=0,b="canceled",L={readyState:0,getResponseHeader:function(e){var t;if(2===T){if(!s)for(s={};t=lt.exec(a);)s[t[1].toLowerCase()]=t[2];t=s[e.toLowerCase()]}return null==t?null:t},getAllResponseHeaders:function(){return 2===T?a:null},setRequestHeader:function(e,t){var r=e.toLowerCase();return T||(e=w[r]=w[r]||e,v[e]=t),this},overrideMimeType:function(e){return T||(f.mimeType=e),this},statusCode:function(e){var t;if(e)if(2>T)for(t in e)m[t]=[m[t],e[t]];else L.always(e[L.status]);return this},abort:function(e){var t=e||b;return i&&i.abort(t),n(0,t),this}};if(g.promise(L).complete=y.add,L.success=L.done,L.error=L.fail,f.url=((e||f.url||ot)+"").replace(ct,"").replace(dt,it[1]+"//"),f.type=r.method||r.type||f.method||f.type,f.dataTypes=oe.trim(f.dataType||"*").toLowerCase().match(se)||[""],null==f.crossDomain&&(u=pt.exec(f.url.toLowerCase()),f.crossDomain=!(!u||u[1]===it[1]&&u[2]===it[2]&&(u[3]||("http:"===u[1]?"80":"443"))===(it[3]||("http:"===it[1]?"80":"443")))),f.data&&f.processData&&"string"!=typeof f.data&&(f.data=oe.param(f.data,f.traditional)),_(yt,f,r,L),2===T)return L;l=f.global,l&&0===oe.active++&&oe.event.trigger("ajaxStart"),f.type=f.type.toUpperCase(),f.hasContent=!ft.test(f.type),o=f.url,f.hasContent||(f.data&&(o=f.url+=(st.test(o)?"&":"?")+f.data,delete f.data),f.cache===!1&&(f.url=ut.test(o)?o.replace(ut,"$1_="+at++):o+(st.test(o)?"&":"?")+"_="+at++)),f.ifModified&&(oe.lastModified[o]&&L.setRequestHeader("If-Modified-Since",oe.lastModified[o]),oe.etag[o]&&L.setRequestHeader("If-None-Match",oe.etag[o])),(f.data&&f.hasContent&&f.contentType!==!1||r.contentType)&&L.setRequestHeader("Content-Type",f.contentType),L.setRequestHeader("Accept",f.dataTypes[0]&&f.accepts[f.dataTypes[0]]?f.accepts[f.dataTypes[0]]+("*"!==f.dataTypes[0]?", "+vt+"; q=0.01":""):f.accepts["*"]);for(h in f.headers)L.setRequestHeader(h,f.headers[h]);if(f.beforeSend&&(f.beforeSend.call(d,L,f)===!1||2===T))return L.abort();b="abort";for(h in{success:1,error:1,complete:1})L[h](f[h]);if(i=_(mt,f,r,L)){L.readyState=1,l&&p.trigger("ajaxSend",[L,f]),f.async&&f.timeout>0&&(c=setTimeout(function(){L.abort("timeout")},f.timeout));try{T=1,i.send(v,n)}catch(x){if(!(2>T))throw x;n(-1,x)}}else n(-1,"No Transport");return L},getJSON:function(e,t,r){return oe.get(e,t,r,"json")},getScript:function(e,r){return oe.get(e,t,r,"script")}}),oe.each(["get","post"],function(e,r){oe[r]=function(e,n,i,o){return oe.isFunction(n)&&(o=o||i,i=n,n=t),oe.ajax({url:e,type:r,dataType:o,data:n,success:i})}}),oe.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(e){return oe.globalEval(e),e}}}),oe.ajaxPrefilter("script",function(e){e.cache===t&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),oe.ajaxTransport("script",function(e){if(e.crossDomain){var t,r;return{send:function(n,i){t=oe("<script>").prop({async:!0,charset:e.scriptCharset,src:e.url}).on("load error",r=function(e){t.remove(),r=null,e&&i("error"===e.type?404:200,e.type)}),H.head.appendChild(t[0])},abort:function(){r&&r()}}}});var Tt=[],bt=/(=)\?(?=&|$)|\?\?/;oe.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Tt.pop()||oe.expando+"_"+at++;return this[e]=!0,e}}),oe.ajaxPrefilter("json jsonp",function(r,n,i){var o,a,s,c=r.jsonp!==!1&&(bt.test(r.url)?"url":"string"==typeof r.data&&!(r.contentType||"").indexOf("application/x-www-form-urlencoded")&&bt.test(r.data)&&"data");return c||"jsonp"===r.dataTypes[0]?(o=r.jsonpCallback=oe.isFunction(r.jsonpCallback)?r.jsonpCallback():r.jsonpCallback,c?r[c]=r[c].replace(bt,"$1"+o):r.jsonp!==!1&&(r.url+=(st.test(r.url)?"&":"?")+r.jsonp+"="+o),r.converters["script json"]=function(){return s||oe.error(o+" was not called"),s[0]},r.dataTypes[0]="json",a=e[o],e[o]=function(){s=arguments},i.always(function(){e[o]=a,r[o]&&(r.jsonpCallback=n.jsonpCallback,Tt.push(o)),s&&oe.isFunction(a)&&a(s[0]),s=a=t}),"script"):t}),oe.ajaxSettings.xhr=function(){try{return new XMLHttpRequest}catch(e){}};var Lt=oe.ajaxSettings.xhr(),xt={0:200,1223:204},Ct=0,St={};e.ActiveXObject&&oe(e).on("unload",function(){for(var e in St)St[e]();St=t}),oe.support.cors=!!Lt&&"withCredentials"in Lt,oe.support.ajax=Lt=!!Lt,oe.ajaxTransport(function(e){var r;return oe.support.cors||Lt&&!e.crossDomain?{send:function(n,i){var o,a,s=e.xhr();if(s.open(e.type,e.url,e.async,e.username,e.password),e.xhrFields)for(o in e.xhrFields)s[o]=e.xhrFields[o];e.mimeType&&s.overrideMimeType&&s.overrideMimeType(e.mimeType),e.crossDomain||n["X-Requested-With"]||(n["X-Requested-With"]="XMLHttpRequest");for(o in n)s.setRequestHeader(o,n[o]);r=function(e){return function(){r&&(delete St[a],r=s.onload=s.onerror=null,"abort"===e?s.abort():"error"===e?i(s.status||404,s.statusText):i(xt[s.status]||s.status,s.statusText,"string"==typeof s.responseText?{text:s.responseText}:t,s.getAllResponseHeaders()))}},s.onload=r(),s.onerror=r("error"),r=St[a=Ct++]=r("abort"),s.send(e.hasContent&&e.data||null)},abort:function(){r&&r()}}:t});var kt,At,Ot=/^(?:toggle|show|hide)$/,_t=RegExp("^(?:([+-])=|)("+ae+")([a-z%]*)$","i"),Rt=/queueHooks$/,Nt=[B],Et={"*":[function(e,t){var r,n,i=this.createTween(e,t),o=_t.exec(t),a=i.cur(),s=+a||0,c=1,u=20;if(o){if(r=+o[2],n=o[3]||(oe.cssNumber[e]?"":"px"),"px"!==n&&s){s=oe.css(i.elem,e,!0)||r||1;do c=c||".5",s/=c,oe.style(i.elem,e,s+n);while(c!==(c=i.cur()/a)&&1!==c&&--u)}i.unit=n,i.start=s,i.end=o[1]?s+(o[1]+1)*r:r}return i}]};oe.Animation=oe.extend(M,{tweener:function(e,t){oe.isFunction(e)?(t=e,e=["*"]):e=e.split(" ");for(var r,n=0,i=e.length;i>n;n++)r=e[n],Et[r]=Et[r]||[],Et[r].unshift(t)},prefilter:function(e,t){t?Nt.unshift(e):Nt.push(e)}}),oe.Tween=P,P.prototype={constructor:P,init:function(e,t,r,n,i,o){this.elem=e,this.prop=r,this.easing=i||"swing",this.options=t,this.start=this.now=this.cur(),this.end=n,this.unit=o||(oe.cssNumber[r]?"":"px")},cur:function(){var e=P.propHooks[this.prop];return e&&e.get?e.get(this):P.propHooks._default.get(this)},run:function(e){var t,r=P.propHooks[this.prop];return this.pos=t=this.options.duration?oe.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),r&&r.set?r.set(this):P.propHooks._default.set(this),this}},P.prototype.init.prototype=P.prototype,P.propHooks={_default:{get:function(e){var t;return null==e.elem[e.prop]||e.elem.style&&null!=e.elem.style[e.prop]?(t=oe.css(e.elem,e.prop,""),t&&"auto"!==t?t:0):e.elem[e.prop]},set:function(e){oe.fx.step[e.prop]?oe.fx.step[e.prop](e):e.elem.style&&(null!=e.elem.style[oe.cssProps[e.prop]]||oe.cssHooks[e.prop])?oe.style(e.elem,e.prop,e.now+e.unit):e.elem[e.prop]=e.now}}},P.propHooks.scrollTop=P.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},oe.each(["toggle","show","hide"],function(e,t){var r=oe.fn[t];oe.fn[t]=function(e,n,i){return null==e||"boolean"==typeof e?r.apply(this,arguments):this.animate(G(t,!0),e,n,i)}}),oe.fn.extend({fadeTo:function(e,t,r,n){return this.filter(w).css("opacity",0).show().end().animate({opacity:t},e,r,n)},animate:function(e,t,r,n){var i=oe.isEmptyObject(e),o=oe.speed(t,r,n),a=function s(){var t=M(this,oe.extend({},e),o);s.finish=function(){t.stop(!0)},(i||ye.get(this,"finish"))&&t.stop(!0)};return a.finish=a,i||o.queue===!1?this.each(a):this.queue(o.queue,a)},stop:function(e,r,n){var i=function(e){var t=e.stop;delete e.stop,t(n)};return"string"!=typeof e&&(n=r,r=e,e=t),r&&e!==!1&&this.queue(e||"fx",[]),this.each(function(){var t=!0,r=null!=e&&e+"queueHooks",o=oe.timers,a=ye.get(this);if(r)a[r]&&a[r].stop&&i(a[r]);else for(r in a)a[r]&&a[r].stop&&Rt.test(r)&&i(a[r]);for(r=o.length;r--;)o[r].elem!==this||null!=e&&o[r].queue!==e||(o[r].anim.stop(n),t=!1,o.splice(r,1));(t||!n)&&oe.dequeue(this,e)})},finish:function(e){return e!==!1&&(e=e||"fx"),this.each(function(){var t,r=ye.get(this),n=r[e+"queue"],i=r[e+"queueHooks"],o=oe.timers,a=n?n.length:0;for(r.finish=!0,oe.queue(this,e,[]),i&&i.cur&&i.cur.finish&&i.cur.finish.call(this),t=o.length;t--;)o[t].elem===this&&o[t].queue===e&&(o[t].anim.stop(!0),o.splice(t,1));for(t=0;a>t;t++)n[t]&&n[t].finish&&n[t].finish.call(this);delete r.finish})}}),oe.each({slideDown:G("show"),slideUp:G("hide"),slideToggle:G("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,t){oe.fn[e]=function(e,r,n){return this.animate(t,e,r,n)}}),oe.speed=function(e,t,r){var n=e&&"object"==("undefined"==typeof e?"undefined":_typeof(e))?oe.extend({},e):{complete:r||!r&&t||oe.isFunction(e)&&e,duration:e,easing:r&&t||t&&!oe.isFunction(t)&&t};return n.duration=oe.fx.off?0:"number"==typeof n.duration?n.duration:n.duration in oe.fx.speeds?oe.fx.speeds[n.duration]:oe.fx.speeds._default,(null==n.queue||n.queue===!0)&&(n.queue="fx"),n.old=n.complete,n.complete=function(){oe.isFunction(n.old)&&n.old.call(this),n.queue&&oe.dequeue(this,n.queue)},n},oe.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2}},oe.timers=[],oe.fx=P.prototype.init,oe.fx.tick=function(){var e,r=oe.timers,n=0;for(kt=oe.now();r.length>n;n++)e=r[n],e()||r[n]!==e||r.splice(n--,1);r.length||oe.fx.stop(),kt=t},oe.fx.timer=function(e){e()&&oe.timers.push(e)&&oe.fx.start()},oe.fx.interval=13,oe.fx.start=function(){At||(At=setInterval(oe.fx.tick,oe.fx.interval))},oe.fx.stop=function(){clearInterval(At),At=null},oe.fx.speeds={slow:600,fast:200,_default:400},oe.fx.step={},oe.expr&&oe.expr.filters&&(oe.expr.filters.animated=function(e){return oe.grep(oe.timers,function(t){return e===t.elem}).length}),oe.fn.offset=function(e){if(arguments.length)return e===t?this:this.each(function(t){oe.offset.setOffset(this,e,t)});var r,n,i=this[0],o={top:0,left:0},a=i&&i.ownerDocument;
return a?(r=a.documentElement,oe.contains(r,i)?(_typeof(i.getBoundingClientRect)!==q&&(o=i.getBoundingClientRect()),n=z(a),{top:o.top+n.pageYOffset-r.clientTop,left:o.left+n.pageXOffset-r.clientLeft}):o):void 0},oe.offset={setOffset:function(e,t,r){var n,i,o,a,s,c,u,l=oe.css(e,"position"),h=oe(e),f={};"static"===l&&(e.style.position="relative"),s=h.offset(),o=oe.css(e,"top"),c=oe.css(e,"left"),u=("absolute"===l||"fixed"===l)&&(o+c).indexOf("auto")>-1,u?(n=h.position(),a=n.top,i=n.left):(a=parseFloat(o)||0,i=parseFloat(c)||0),oe.isFunction(t)&&(t=t.call(e,r,s)),null!=t.top&&(f.top=t.top-s.top+a),null!=t.left&&(f.left=t.left-s.left+i),"using"in t?t.using.call(e,f):h.css(f)}},oe.fn.extend({position:function(){if(this[0]){var e,t,r=this[0],n={top:0,left:0};return"fixed"===oe.css(r,"position")?t=r.getBoundingClientRect():(e=this.offsetParent(),t=this.offset(),oe.nodeName(e[0],"html")||(n=e.offset()),n.top+=oe.css(e[0],"borderTopWidth",!0),n.left+=oe.css(e[0],"borderLeftWidth",!0)),{top:t.top-n.top-oe.css(r,"marginTop",!0),left:t.left-n.left-oe.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var e=this.offsetParent||K;e&&!oe.nodeName(e,"html")&&"static"===oe.css(e,"position");)e=e.offsetParent;return e||K})}}),oe.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(r,n){var i="pageYOffset"===n;oe.fn[r]=function(o){return oe.access(this,function(r,o,a){var s=z(r);return a===t?s?s[n]:r[o]:(s?s.scrollTo(i?e.pageXOffset:a,i?a:e.pageYOffset):r[o]=a,t)},r,o,arguments.length,null)}}),oe.each({Height:"height",Width:"width"},function(e,r){oe.each({padding:"inner"+e,content:r,"":"outer"+e},function(n,i){oe.fn[i]=function(i,o){var a=arguments.length&&(n||"boolean"!=typeof i),s=n||(i===!0||o===!0?"margin":"border");return oe.access(this,function(r,n,i){var o;return oe.isWindow(r)?r.document.documentElement["client"+e]:9===r.nodeType?(o=r.documentElement,Math.max(r.body["scroll"+e],o["scroll"+e],r.body["offset"+e],o["offset"+e],o["client"+e])):i===t?oe.css(r,n,s):oe.style(r,n,i,s)},r,a?i:t,a,null)}})}),oe.fn.size=function(){return this.length},oe.fn.andSelf=oe.fn.addBack,"object"==("undefined"==typeof module?"undefined":_typeof(module))&&"object"==_typeof(module.exports)?module.exports=oe:"function"==typeof define&&define.amd&&define("jquery",[],function(){return oe}),"object"==("undefined"==typeof e?"undefined":_typeof(e))&&"object"==_typeof(e.document)&&(e.jQuery=e.$=oe)}(window);var browser={isIE:navigator.userAgent.indexOf("MSIE")!=-1,isFirefox:navigator.userAgent.toLowerCase().indexOf("firefox")!=-1,isNativeApp:window.webkitNative,isIOs:!!navigator.userAgent.match(/(iPad|iPhone|iPod)/i),isAndroid:!!navigator.userAgent.match(/(android)/i),isNodeWebkit:"object"===("undefined"==typeof process?"undefined":_typeof(process)),isOiceApp:"true"===getURLSearchParam("__oiceApp__")};browser.supportsMultipleAudio=function(){if(browser.isNativeApp)return!0;if(browser.isAndroid)return!0;if(browser.isIOs){var e=function(){var e=window.navigator.userAgent,t=e.indexOf("OS ");return(e.indexOf("iPhone")>-1||e.indexOf("iPad")>-1)&&t>-1?Number(e.substr(t+3,3).replace("_",".")):-1}();return e>=6}return!0}(),browser.usesWebAudio=function(){return!browser.supportsMultipleAudio&&!(!window.AudioContext&&!window.webkitAudioContext)}(),Event.prototype.normalizedCoordinate=function(e){var t,r=0,n=0,i=document.getElementById("main-wrapper");return t=this.changedTouches?{x:(this.changedTouches[0].pageX-i.getBoundingClientRect().left)/scale+r,y:(this.changedTouches[0].pageY-i.getBoundingClientRect().top)/scale+n}:{x:(this.clientX-i.getBoundingClientRect().left)/scale+r,y:(this.clientY-i.getBoundingClientRect().top)/scale+n},e instanceof Layer&&(t=e.localLocation(t.x,t.y)),t};var scaleToFitPage,scale=1,setPageScale;!function(){function e(){if(t)return t;var e=window,r=document,n=r.documentElement,i=r.getElementsByTagName("body")[0],o=e.innerWidth||n.clientWidth||i.clientWidth,a=e.innerHeight||n.clientHeight||i.clientHeight;return{width:o,height:a}}var t;setPageScale=function(e){if(scale!=e){scale=e;var t=$("#main-wrapper");t.css("transformOrigin","0% 0%").css("transform","scale("+scale+")")}};var r;scaleToFitPage=function(n,i){var o;if(n<=-1||i<=-1?t=void 0:n&&i&&(o=t={width:n,height:i}),!o){if(o=e(),r&&r.width==o.width&&r.height==o.height)return;var a=document.body;a.style.overflow="hidden",browser.isIOs&&window==window.top?a.style.height=2*o.height+"px":a.style.height=o.height+"px",window.scrollTo(0,0),o=e()}r=o;var s=o.width/config.scWidth,c=o.height/config.scHeight,u=Math.min(s,c);setPageScale(u);var l=$("#main-wrapper");return l.css("top",(o.height-config.scHeight*u)/2+"px").css("left",(o.width-config.scWidth*u)/2+"px"),this}}(),function(){for(var e=0,t=Date.now(),r=["ms","moz","webkit","o"],n=0;n<r.length&&!window.requestAnimationFrame;++n)window.requestAnimationFrame=window[r[n]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[r[n]+"CancelAnimationFrame"]||window[r[n]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(r,n){var i=(new Date).getTime(),o=Math.max(0,16-(i-e)),a=window.setTimeout(function(){return r(i-t)},o);return e=i+o,a}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),function(){if(window.chrome){var e=CanvasRenderingContext2D.prototype.fillText;CanvasRenderingContext2D.prototype.fillText=function(t,r,n,i){if(t.indexOf("　")==-1)return e.apply(this,arguments);for(var o=t.split(""),a=r,s=0;s<o.length;s++){var c=o[s],u=this.measureText(c).width;if(r+u-a>i)break;e.call(this,c,r,n),r+=u}}}}(),Function.prototype.bind||(Function.prototype.bind=function(e){if("function"!=typeof this)throw new TypeError("[内部エラー] Function.prototype.bind - what is trying to be bound is not callable");var t=Array.prototype.slice.call(arguments,1),r=this,n=function(){},i=function(){return r.apply(this instanceof n&&e?this:e,t.concat(Array.prototype.slice.call(arguments)))};return n.prototype=this.prototype,i.prototype=new n,i}),$(function(){$.fn.bindFirst=function(e,t){return this.on(e,t),this.each(function(){var t=$._data(this,"events")[e.split(".")[0]];if(t){var r=t.pop();t.splice(0,0,r)}}),this}});var isFontLoaded;!function(){var e=null,t=null,r={};isFontLoaded=function(n){e||(e=document.createElement("canvas"),t=e.getContext("2d"));for(var i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",o=["monospace","sans-serif","serif"],a=0,s=o.length;a<s;a++){var c=o[a],u=r[c];u||(t.font="72px "+c,u=r[c]=t.measureText(i).width);var l=r[n];if(l||(t.font="72px "+n+","+c,l=t.measureText(i).width),u!=l)return r[n]=l,!0}return!1}}(void 0);var ResourceLoader;!function(){function e(e,t){if(config.numImageCache==-1)return void(l[e]=t);var r=h.indexOf(e);if(r!=-1&&h.splice(r,1),h.push(e),l[e]=t,h.length>config.numImageCache){var n=h.length-config.numMediaCache,i=h.splice(0,n);i.forEach(function(e){delete l[e]})}}var t=function(){function e(e,n){if(!r){var i=t.canPlayType(e);"maybe"!==i&&"probably"!==i||(r=n)}}var t=new Audio,r=void 0;return browser.isNodeWebkit&&e("audio/ogg","ogg"),e("audio/mp4","mp4"),e("audio/ogg","ogg"),e("audio/mp3","mp3"),e("audio/wav","wav"),r||"ogg"},r=function(){var e=document.createElement("video");return"maybe"==e.canPlayType("video/webm")?"webm":"maybe"==e.canPlayType("video/mp4")?"mp4":"maybe"==e.canPlayType("video/ogg")?"ogv":void 0},n=3e3,i=3e4,o=10,a=3e4,s=3,c=3,u=3e4,l={},h=[],f={},d=function(e){var t=$.Deferred(),r=new Image;$(r).on("readystatechange load",function(e){$(this).off(),r.complete||4==r.readyState||"complete"==r.readyState?t.resolve(r):$(r).trigger("error")}),$(r).on("error",function(e){$(this).off(),t.reject(e)});var n=setTimeout(function(){$(r).trigger("error")},i);return t.always(function(){clearTimeout(n)}),$(r).attr("src",e),t.promise()},p=function(e,t){return y(e,"audio",t)},g=function(e,t){return y(e,"video",t)},y=function(t,r,n){var i=$.Deferred();return l[t]&&(n=l[t].cloneNode()),n||(n="video"==r?document.createElement("video"):new Audio),$(n).on("canplaythrough stalled suspend",function(){$(this).off(),i.resolve(n)}),$(n).on("error",function(){$(this).off(),i.reject()}),n.autoplay=!1,n.src="",n.src=t,n.load(),e(t,n),setTimeout(function(){i.reject()},a),i.promise()},m=function(e,t,r){function i(){var n=r();n.done(function(e){return o.resolve(e)}).fail(function(r){(browser.isIOs||browser.isAndroid)&&!navigator.onLine||a<e?(setTimeout(i,100),a++,t&&Renderer.showLoadingSign()):t?(Renderer.hideLoadingSign(),Renderer.showServerError(function(){a=0,t&&Renderer.showLoadingSign(),i()})):o.reject(r)})}var o=$.Deferred(),a=0;if(t){var s=void 0;s=setTimeout(function(){return Renderer.showLoadingSign()},n),o.always(function(){clearTimeout(s),Renderer.hideLoadingSign()})}return i(),o};ResourceLoader={getAudioExtension:function(){var e=t();return ResourceLoader.getAudioExtension=function(){return e},e},getVideoExtension:function(){var e=r();return ResourceLoader.getVideoExtension=function(){return e},e},loadImage:function(t){var r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];"data:"!=t.substr(0,5)&&(t=t.toLowerCase());var n=t;if(t in o2.imageList)t=o2.imageList[t],console.log("Loading image: "+t);else if("data:"!=t.substr(0,5))return o2.error("ストレージに"+n+"が見つかりません"),$.Deferred().reject();if(t in f)return f[t].promise();if(t in l)return ev.lastimage.width=l[t].width,ev.lastimage.height=l[t].height,$.Deferred().resolve(l[t]);var i=m(o,r,function(){return d(t)});return f[t]=i,i.done(function(r){e(t,r),r.originalURL=n,ev.lastimage.width=r.width,ev.lastimage.height=r.height}),i.promise()},getFullAudioPath:function(e){e=e.toLowerCase();var t=o2.soundList[e];if(t)return t+"."+ResourceLoader.getAudioExtension()},loadAudio:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=this.getFullAudioPath(e);if(console.log("Loading audio: "+n),!n)return o2.error("ストレージに"+e+" が見つかりません"),$.Deferred().reject();var i=m(s,t,function(){return p(n,r)});return i.promise()},loadAudioBuffer:function(e,t){var r=this,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=this.getFullAudioPath(e);if(!i)return o2.error("Audio not found, "+e),$.Deferred().reject();var o=m(s,n,function(){return r.loadBuffer(i).then(function(e){var r=$.Deferred();return t.decodeAudioData(e,function(e){return r.resolve(e)},function(e){return r.reject(e)}),r})});return o},loadVideo:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(e=e.toLowerCase(),!(e in o2.videoList))throw"ムービーストレージ "+e+" が存在しません";e=o2.videoList[e],console.log("Loading video: "+e);var n=m(c,t,function(){return g(e+"."+ResourceLoader.getVideoExtension(),r)});return n.promise()},loadFont:function(e,t){var r=e,i=$.Deferred();if(e.indexOf(",")!==-1){var o=e.split(/\s*,\s*/g),a=o.map(function(e){return e=e.replace('"',""),ResourceLoader.loadFont(e)});return $.when.apply($,a)}if(isFontLoaded(r))return i.resolve();if(e=e.toLowerCase(),!(e in o2.fontList))return i.resolve();e=o2.fontList[e],console.log("Loading font: "+e),$("head").prepend('<style type="text/css">@font-face {font-family: "'+r+'";src: url("'+e+'.ttf"),     url("'+e+'.woff");}</style>');var s,c,l=$("<div />").css({"font-family":r,height:0,width:0,opacity:0,margin:0}).html(".").appendTo($("body"));setTimeout(function f(){isFontLoaded(r)?i.resolve():setTimeout(f,100)},100);var h=function(){t&&(s=setTimeout(function(){Renderer.showLoadingSign()},n),c=setTimeout(function(){i.reject()},u))};return h(),i.always(function(){clearTimeout(s),clearTimeout(c),Renderer.hideLoadingSign(),l.remove()}),i.promise()},loadWebFont:function(e,t){var r=$.Deferred();console.log("Loading web font: "+e.name+"("+e.weight+")"),$("head").prepend('<style type="text/css">@font-face {font-family: "'+e.name+'";font-style: normal;font-weight: '+e.weight+";src: url("+e.url+'.woff2) format("woff2"),     url('+e.url+'.woff) format("woff2"),     url('+e.url+'.otf) format("opentype");}</style>');var n=new FontFaceObserver(e.name,{weight:e.weight});return n.load(null,u).then(function(){return r.resolve()},function(){return r.reject()}),r.promise()},loadBuffer:function(e){var t=$.Deferred(),r=new XMLHttpRequest;return r.open("GET",e,!0),r.responseType="arraybuffer",$(r).one("load",function(){return t.resolve(r.response)}),$(r).one("error",function(){return t.reject()}),r.send(),t}}}();var Conductor=function t(e){if(this.waitTag={},this.file,this.lineNumber=-1,this.currentTag,this.oneShotStackDepth=0,this.paused=!1,this.tagActions={},this.stack=[],this.queue=[],this.status=t.STATUS_STOP,this.callStack=[],this.macroStack=[],this.macros={},this.ifStack=[],this.callbackVarsStack=[],e&&(e.file&&this.setFile(e.file),e.label)){"*"==e.label.charAt(0)&&(e.label=e.label.substring(1));var r=this.file.getLabelTag(e.label);r&&this.setTag(r)}var n=this;this.queue.push=function(e){if(e instanceof Tag){var r=Array.prototype.push.apply(this,arguments);return"click"in n.waitTag?n.trigger("click"):n.status==t.STATUS_STOP&&n.oneShot(),r}}};Conductor.STATUS_STOP=0,Conductor.STATUS_PREPARE_TAG=1,Conductor.STATUS_RUN=2,Conductor.STATUS_WAIT=3,Conductor.prototype.toJSON=function(){var e={currentTag:this.currentTag,stack:this.queue,ifStack:this.ifStack};return config.saveMode==o2.SAVE_MODE_O2KAG&&(e.macroStack=this.macroStack,e.callStack=this.callStack),e},Conductor.prototype.importFromSaveData=function(e){var t=this;if(this.waitTag={},this.callStack=e.callStack||[],delete e.callStack,this.clearMacroStack(),this.clearIfStack(),this.clearStack(),e.currentTag){var r=e.currentTag.restore();return $.when(r).then(function(r){return t.setTag(r,!0),delete e.currentTag,Object.prototype.importFromSaveData.call(t,e)})}var n=_KAGFiles(e.file);return $.when(n).then(function(r){var n=r.lines[e.lineNumber];return t.setTag(n,!0),Object.prototype.importFromSaveData.call(t,e)})},Conductor.prototype.importFrom=function(e){throw"【内部エラー】コンダクターはコピーできません。"},Conductor.prototype.getTagAction=function(e){return this.tagActions[e]||Tag.actions[e]},Conductor.prototype.run=function(){var e=this;if(!this.paused){if(this.waitTag={},this.queue.length)this.currentTag=this.queue.shift();else{var t=this.file.lines[this.lineNumber];if(this.currentTag=t,!this.currentTag){var r=new Tag("s");return void this.queue.push(r)}var n=this.currentTag.originalLineNumber||this.currentTag.lineNumber,i="ファイル: "+this.file.filename+" / ";i+="行:"+n+" / ","undefined"!=typeof this.currentTag.originalCharNumber&&(i+="文字:"+this.currentTag.originalCharNumber+" / "),i+="タグ: ",i+=this.macroStack.map(function(e){return e.displayName()}).concat([this.currentTag.tagName]).join(" > "),this.callStack.length&&(i+="\ncall stack: ",i+=this.callStack.map(function(e){var t=e.originalLineNumber||e.line;return e.file.filename+":"+(t-1)+" : call"}).join(" > ")),o2.log(i),this.lineNumber++,this.currentTag.file.recentlyUsed()}var o,a=!0;if("o2_cond"in this.currentTag.args)try{this.currentTag.eval(this.currentTag.args.o2_cond)||(a=!1)}catch(s){a=!1}if(a){if(this.currentTag.conductor=this,this.isMacro(this.currentTag))return void this.jumpIntoMacro(this.currentTag);if(this.shouldMacroEnd())return void this.jumpOutOfMacro();this.status=Conductor.STATUS_PREPARE_TAG,o=this.currentTag.run(),void 0==o&&(o=0),delete this.currentTag.conductor,0===o&&(this.status=Conductor.STATUS_RUN)}else o2.log("o2_condの評価結果がfalseだったため実行されませんでした"),o=0;0==o?($(this).trigger("ran",[o]),this.oneShotStackDepth++,this.oneShot()):1==o?(this.oneShotStackDepth=0,this.wait(this.currentTag.tagName),this.wait("*",function(){$(e).trigger("ran",[o])})):2==o&&(this.oneShotStackDepth=0,this.status=Conductor.STATUS_STOP,$(this).trigger("ran",[o]))}},Conductor.prototype.setFile=function(e){this.setTag(e.line(0))},Conductor.prototype.setTag=function(e,t){return e.file?(this.file=e.file,this.lineNumber=e.lineNumber,void(t&&this.lineNumber++)):void this.queue.push(e)},Conductor.prototype.getNextTag=function(e){if(!e)return this.queue.length?this.queue[0]:this.file.lines[this.lineNumber];for(var t=this.upComingTags(),r=0;r<t.length;r++)if(t[r].tagName==e)return t[r]},Conductor.prototype.upComingTags=function(){return this.queue.concat(this.file.lines.slice(this.lineNumber))},Conductor.prototype.oneShot=function(){var e=this;this.clearingOneShotStack||(this.oneShotStackDepth<5e3?this.run():(setTimeout(function(){delete e.clearingOneShotStack,e.oneShotStackDepth=0,e.run()}),this.clearingOneShotStack=!0))},Conductor.prototype.isCurrentRead=function(){return!0},Conductor.prototype.pause=function(){this.paused=!0},Conductor.prototype.resume=function(){this.paused=!1},function(){function e(){if(!currentConductor.macroStack.length)return void(window.mp={});var e=currentConductor.macroStack[currentConductor.macroStack.length-1];window.mp=e.args}Conductor.prototype.isMacro=function(e){return e instanceof Tag&&(e=e.tagName),e in this.macros},Conductor.prototype.jumpIntoMacro=function(t){var r=this,n=void 0,i={};if(t instanceof Tag){var o=t;if(n=this.macros[o.tagName],!n)throw"登録されていないマクロ "+o.tagName+" が呼び出されました";i=o.argsForAction(),i.tagname=o.tagName}else n=this.macros[t];var a=this.getNextTag(),s=void 0;if(a)s=a.toRestorable();else{var c=new Tag("s");s=c.toRestorable()}var u=new Macro({definition:n,returnTag:s,args:i});if("endmacro"===s.tagName){var l=this.macroStack.pop(),h=l.displayName();u.returnTag=l.returnTag,u.displayName=function(){return h+" > "+Macro.prototype.displayName.apply(this,arguments)}}this.macroStack.push(u),e(),this.wait("jumpIntoMacro"),$.when(n.startTag.restore()).done(function(e){r.setTag(e),r.trigger("jumpIntoMacro")})},Conductor.prototype.shouldMacroEnd=function(){return!!this.macroStack.length&&"endmacro"==this.currentTag.tagName},Conductor.prototype.jumpOutOfMacro=function(){var t=this,r=this.macroStack.pop();if(e(),r){this.wait("jumpOutOfMacro");var n=r.returnTag.restore();$.when(n).then(function(e){t.setTag(e),$(t).trigger("ran",[0]),t.trigger("jumpOutOfMacro")})}else this.oneShot()},Conductor.prototype.clearMacroStack=function(){this.macroStack=[],e()};var t=Conductor.prototype.importFromSaveData;Conductor.prototype.importFromSaveData=function(){return t.apply(this,arguments).done(function(){e()})}}(),Conductor.prototype.clearIfStack=function(){this.ifStack=[]},Conductor.prototype.clearStack=function(){this.stack.forEach(function(e){e.exitScope()}),this.stack=[]},Conductor.prototype.reset=function(){this.queue.splice(0,this.queue.length),this.status=Conductor.STATUS_STOP,this.callStack=[],this.macros={},this.clearMacroStack(),this.clearIfStack(),this.clearStack()},Conductor.prototype.wait=function(e,t){this.status=Conductor.STATUS_WAIT,e instanceof Tag&&(e=e.tagName),e in this.waitTag||(this.waitTag[e]=[]),t&&this.waitTag[e].push(t)},Conductor.prototype.trigger=function(e){if(this.status!==Conductor.STATUS_PREPARE_TAG||0!=Object.keys(this.waitTag).length){var t=[],r=!1;e instanceof Tag&&(e=e.tagName),e in this.waitTag?(r=!0,t=t.concat(this.waitTag[e])):"click"==e&&0==Object.keys(this.waitTag).length&&this.status!=Conductor.STATUS_STOP&&(r=!0),r&&this.waitTag["*"]&&(t=t.concat(this.waitTag["*"]));for(var n=0;n<t.length;n++)t[n]();return!!r&&(this.oneShot(),!0)}};var MacroDefinition=function(e){e&&(this.name=e.name,this.startTag=e.startTag)};MacroDefinition.prototype.macroCreated=function(e){},MacroDefinition.prototype.importFromSaveData=function(e){this.name=e.name,this.startTag=e.startTag};var Macro=function(e){e&&(this.definition=e.definition,this.returnTag=e.returnTag,this.args=e.args,this.definition.macroCreated(this))};Macro.prototype.initializer="Macro",Macro.prototype.importFromSaveData=function(e){return this.returnTag=e.returnTag,delete e.returnTag,Object.prototype.importFromSaveData.apply(this,arguments)},Macro.prototype.displayName=function(){return this.definition.name};var SubRoutineConductor=function(){Conductor.call(this),Object.defineProperty(this,"macros",{get:function(){return conductor.macros},set:function(){}})};SubRoutineConductor.prototype=Object.create(Conductor.prototype),SubRoutineConductor.prototype.getTagAction=function(e){return SubRoutineConductor.tagActions=SubRoutineConductor.tagActions||{"return":new TagAction({rules:Tag.actions["return"].rules,action:function(e){if(0==this.conductor.callStack.length){if(currentConductor=conductor,o2.skipMode=o2.SKIP_MODE_NONE,e.storage||e.target){var t=new Tag("jump",e);currentConductor.queue.push(t)}return 2}return Tag.actions["return"].action.call(this,e)}}),label:new TagAction({action:function(e){return config.saveMode==o2.SAVE_MODE_KAG3&&e.caption?(this.error("サブルーチン内にセーブ可能なラベルを置くことはできません"),0):Tag.actions.label.action.call(this,e)}}),o2_savestat:new TagAction({action:function(e){return config.saveMode==o2.SAVE_MODE_O2KAG&&this.error("サブルーチン内にo2_savestatタグを置くことはできません"),0}})},SubRoutineConductor.tagActions[e]||Conductor.prototype.getTagAction.apply(this,arguments)};var _KAGFiles,KAGFile,PartialFile;!function(){function e(){var e=[conductor,extraConductor];return e=e.concat(o2.foreLayers.baseLayer.animationConductors,o2.backLayers.baseLayer.animationConductors),e=[].concat.apply(e,o2.foreLayers.imageLayers.map(function(e){return e.animationConductors})),e=[].concat.apply(e,o2.backLayers.imageLayers.map(function(e){return e.animationConductors})),o2.glyphLayer.animationConductors[0]instanceof AnimationConductor&&e.push(o2.glyphLayer.animationConductors[0]),e}var t={},r=[],n=1/0,i={};_KAGFiles=function(e,n){if(e=e.toLowerCase(),void 0==n){if(e in t){var o=t[e];return o.recentlyUsed(),o}if(e in i)return $.get(i[e],null,null,"json").then(function(t){var r=KAGFile.create(e,t);return r});throw e+"というファイルが見つからない"}return r.push(e),t[e]=n,_KAGFiles.ensureFileLimit(),n},_KAGFiles.setupManifest=function(e){n=config.numScriptCache;for(var t in e)i[t.toLowerCase()]=e[t].toLowerCase()},_KAGFiles.ensureFileLimit=function(){if(!(r.length<=n))for(var i=e().filter(function(e){return void 0!=e}).map(function(e){return e.file}),o=0;o<r.length&&r.length>n;){var a=r[o];i.indexOf(t[a])==-1?(r.splice(o,1),delete t[a]):o++}},KAGFile=function(e,t){this.filename=e.toLowerCase(),this.lines=[],this.labels=[],t||_KAGFiles(e,this);var r=this;this.lines.push=function(e){return e.file=r,e.lineNumber=this.length,"label"==e.tagName&&r.labels.push(e),Array.prototype.push.apply(this,arguments)}},KAGFile.create=function(e,t){for(var r=new KAGFile(e),n=0;n<t.length;n++){var i=t[n],o=new Tag(i[o2.config.scriptTagNameKey],i[o2.config.scriptTagArgsKey],i[o2.config.scriptTagCallbackArgsKey]);r.lines.push(o),"undefined"!=typeof i[o2.config.scriptTagLineKey]&&(o.originalLineNumber=i[o2.config.scriptTagLineKey]),"undefined"!=typeof i[o2.config.scriptTagCharKey]&&(o.originalCharNumber=i[o2.config.scriptTagCharKey])}return r},KAGFile.prototype.recentlyUsed=function(){var e=r.indexOf(this.filename);e!=-1&&r.splice(e,1),r.push(this.filename),_KAGFiles.ensureFileLimit()},KAGFile.prototype.clone=function(){return this},KAGFile.prototype.line=function(e){return this.lines[e]},KAGFile.prototype.getLabelTag=function(e){for(var t=0;t<this.labels.length;t++)if(this.labels[t].args.name==e)return this.labels[t];return null},KAGFile.prototype.basename=function(){var e=this.filename.split(".");return e.pop(),e.join(".")},KAGFile.prototype.toRestorable=function(){return{filename:this.filename,initializer:"KAGFile"}},KAGFile.restore=function(e){return _KAGFiles(e.filename)},PartialFile=function(e,t,r){this.originalFile=e,this.filename=e.filename+"(virtual:"+t+"~"+r+")",this.start=t,this.end=r;var n=this;this.lines=e.lines.slice(t,r+1).map(function(e,t){var r=Object.create(e);return r.file=n,r.lineNumber=t,r})},PartialFile.prototype=Object.create(KAGFile.prototype),PartialFile.prototype.getLabelTag=function(e){return this.originalFile.getLabelTag(e)},PartialFile.prototype.toRestorable=function(){return{originalFile:this.originalFile.toRestorable(),start:this.start,end:this.end,initializer:"PartialFile"}},PartialFile.restore=function(e){return $.when(e.originalFile.restore()).then(function(t){return new PartialFile(t,e.start,e.end)})}}();var Rect=function r(){if(4==arguments.length)return new r({x:arguments[0],y:arguments[1],width:arguments[2],height:arguments[3]});if(1==arguments.length&&"object"===_typeof(arguments[0])){for(var e in arguments[0])if(this[e]=arguments[0][e],isNaN(this[e]))throw e+"はnumberじゃないです"}else this.x=this.y=this.width=this.height=0};Rect.prototype.initializer="Rect",Rect.prototype.isEqual=function(e){return e.x==this.x&&e.y==this.y&&e.width==this.width&&e.height==this.height},Rect.prototype.isZero=function(){return this.isEqual(new Rect(0,0,0,0))},Rect.prototype.coverCoordinate=function(e,t){return e>=this.x&&e<this.x+this.width&&t>this.y&&t<this.y+this.height},Rect.prototype.extend=function(e){0!=this.width&&0!=this.height||$.extend(this,e);var t=Math.min(e.x,this.x),r=Math.min(e.y,this.y),n=Math.max(e.x+e.width,this.x+this.width),i=Math.max(e.y+e.height,this.y+this.height);this.x=t,this.y=r,this.width=n-t,this.height=i-r},Rect.prototype.intersect=function(e){if(e.x+e.width>this.x&&e.x<this.x+this.width&&e.y+e.height>this.y&&e.y<this.y+this.height){var t=Math.max(this.x,e.x),r=Math.max(this.y,e.y),n=Math.min(this.x+this.width,e.x+e.width),i=Math.min(this.y+this.height,e.y+e.height);return new Rect({x:t,y:r,width:n-t,height:i-r})}return!1},Rect.prototype.round=function(){this.x=~~(.5+this.x),this.y=~~(.5+this.y),this.width=~~(.5+this.width),this.height=~~(.5+this.height)};var Drawable=function(e){this.rect=clone(e)||new Rect,this.needRedraw=!0,this.partialDraw=!1};Drawable.prototype.initializer="Drawable",Drawable.prototype.objectToBeSerialized=function(e){switch(e){case"needRedraw":case"partialDraw":return}return this[e]},Drawable.prototype.importFrom=function(e){this.rect=clone(e.rect),this.transform=clone(e.transform)},Drawable.prototype.drawOnContext=function(e,t){},Drawable.prototype.frame=function(){return this.rect},Drawable.prototype.canDrawPartial=function(){return!1};var DrawableCanvas=function(e){Drawable.call(this,e),this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.setRect(),this.ctx.textBaseline="top"};DrawableCanvas.prototype=new Drawable,DrawableCanvas.prototype.initializer="DrawableCanvas",DrawableCanvas.prototype.objectToBeSerialized=function(e){switch(e){case"canvas":case"ctx":return}return this[e]},DrawableCanvas.prototype.importFromSaveData=function(){var e=this;return Drawable.prototype.importFromSaveData.apply(this,arguments).done(function(){return e.setRect()})},DrawableCanvas.prototype.canDrawPartial=function(){return!0},DrawableCanvas.prototype.setRect=function(e){e&&(this.rect=e),this.canvas.width=this.rect.width,this.canvas.height=this.rect.height},DrawableCanvas.prototype.clone=function(){var e=new DrawableCanvas;return e.importFrom(this),e.canvas.width=this.rect.width,e.canvas.height=this.rect.height,e.ctx.drawImage(this.canvas,0,0),e},DrawableCanvas.prototype.drawOnContext=function(e,t){if(t){var r=t.intersect(this.rect);e.drawImage(this.canvas,r.x-this.rect.x,r.y-this.rect.y,r.width,r.height,r.x,r.y,r.width,r.height)}else e.drawImage(this.canvas,this.rect.x,this.rect.y,this.rect.width,this.rect.height)};var DrawableSolidColor=function(e){Drawable.call(this,e),this.color="#000000",this.opacity=1};DrawableSolidColor.prototype=new Drawable,DrawableSolidColor.prototype.initializer="DrawableSolidColor",DrawableSolidColor.prototype.canDrawPartial=function(){return!0},DrawableSolidColor.prototype.drawOnContext=function(e,t){t=t?t.intersect(this.rect):this.rect,e.save(),e.globalAlpha=this.opacity,e.fillStyle=this.color,e.fillRect(t.x,t.y,t.width,t.height),e.restore()},DrawableSolidColor.prototype.importFrom=function(e){e instanceof DrawableSolidColor&&(this.color=e.color,this.opacity=e.opacity)};var DrawableImage=function(e,t,r){if(Drawable.call(this),null==e)throw"image needed";null==t&&(t=0),null==r&&(r=0),Drawable.call(this,new Rect(t,r,e.width,e.height)),this.image=e,this.cacheEnabled=!0,this.reuseCanvas=!1,this.cacheCanvas,this.options={}};DrawableImage.defaultOptions={grayscale:!1,rGamma:1,gGamma:1,bGamma:1,rFloor:0,gFloor:0,bFloor:0,rCeil:255,gCeil:255,bCeil:255,tintColor:"#ff0000",tintOpacity:0,shadow:"#000000",shadowOpacity:200,shadowX:10,shadowY:10,shadowBlur:3,clipLeft:void 0,clipTop:void 0,clipWidth:void 0,clipHeight:void 0,flipUD:!1,flipLR:!1,visible:!0,opacity:1,blurX:0,blurY:0,blurMode:"linear"},DrawableImage.prototype=new Drawable,DrawableImage.prototype.initializer="DrawableImage",DrawableImage.prototype.objectToBeSerialized=function(e){switch(e){case"options":var t={};for(var r in this.options)DrawableImage.defaultOptions.hasOwnProperty(r)&&this.options[r]==DrawableImage.defaultOptions[r]||(t[r]=this.options[r]);return t;case"image":if(this.image.originalURL)return this.image.originalURL;case"cacheCanvas":return}return this[e]},DrawableImage.restore=function(e){return $.when(ResourceLoader.loadImage(e.image,!0)).then(function(t){var r=new DrawableImage(t);return r.importFromSaveData(e).then(function(){return r})})},DrawableImage.prototype.importFromSaveData=function(e){var t=this;return $.when($.when(e.rect.restore()).then(function(e){t.rect=e}),$.when(e.options.restore()).then(function(e){t.options=e}))},DrawableImage.prototype.canDrawPartial=function(){return!0},DrawableImage.prototype.clone=function(){var e=new DrawableImage(this.image);return e.importFrom(this),this.cacheCanvas&&(e.cacheCanvas=document.createElement("canvas"),e.cacheCanvas.width=this.cacheCanvas.width,e.cacheCanvas.height=this.cacheCanvas.height,e.cacheCanvas.getContext("2d").drawImage(this.cacheCanvas,0,0)),e},DrawableImage.prototype.importFrom=function(e){this.options=clone(e.options),this.rect=clone(e.rect)},DrawableImage.prototype.drawOnContext=function(e,t){var r=this;t||(t=this.rect);var n=0,i=0,o=this.rect.width,a=this.rect.height;this.options.clipLeft&&(n+=this.options.clipLeft,o-=this.options.clipLeft),this.options.clipTop&&(i+=this.options.clipTop,a-=this.options.clipTop),this.options.clipWidth&&(o=this.options.clipWidth),this.options.clipHeight&&(a=this.options.clipHeight);var s=t.intersect(new Rect({x:this.rect.x,y:this.rect.y,width:o,height:a}));if(s&&(s=s.intersect(new Rect({x:0,y:0,width:e.canvas.width,height:e.canvas.height})))){var c=this.image;if(!this.cacheCanvas||!this.cacheEnabled){for(var u,l,h=function d(e){switch(e){case"canvas":return $(c).is("canvas")||(r.cacheCanvas||(r.cacheCanvas=document.createElement("canvas")),r.cacheCanvas.width=o,r.cacheCanvas.height=a,u=r.cacheCanvas.getContext("2d"),u.drawImage(c,n,i,o,a,0,0,o,a),n=0,i=0,c=r.cacheCanvas),l&&(u.putImageData(l,0,0),l=null),c;case"imageData":if(l)return l;var t=d("canvas");return l=t.getContext("2d").getImageData(0,0,c.width,c.height);default:o2.error("ソースタイプが間違ってます。")}},f=0;f<DrawableImage.effects.length;f++)DrawableImage.effects[f](h,this.options);l&&h("canvas")}e.save(),"opacity"in this.options&&(e.globalAlpha=this.options.opacity),e.drawImage(c,s.x-this.rect.x+n,s.y-this.rect.y+i,s.width,s.height,s.x,s.y,s.width,s.height),e.restore(),this.cacheEnabled&&this.reuseCanvas||(this.cacheCanvas=null)}},DrawableImage.effects=[function(e,t){if(t.flipLR){var r=e("canvas"),n=document.createElement("canvas");n.width=r.width,n.height=r.height;var i=n.getContext("2d");i.translate(r.width,0),i.scale(-1,1),i.drawImage(r,0,0);var o=r.getContext("2d");o.clearRect(0,0,r.width,r.height),o.drawImage(n,0,0)}},function(e,t){if(t.flipUD){var r=e("canvas"),n=document.createElement("canvas");n.width=r.width,n.height=r.height;var i=n.getContext("2d");i.translate(0,r.height),i.scale(1,-1),i.drawImage(r,0,0);var o=r.getContext("2d");o.clearRect(0,0,r.width,r.height),o.drawImage(n,0,0)}},function(e,t){if(t.grayscale)for(var r=e("imageData"),n=r.data,i=0,o=n.length;i<o;i+=4){var a=.34*n[i]+.5*n[i+1]+.16*n[i+2];n[i]=a,n[i+1]=a,n[i+2]=a}},function(e,t){var r=t.rGamma;if("rGamma"in t&&1!=r){var n=e("imageData"),i=n.data;
r=1/r;for(var o=0,a=i.length;o<a;o+=4)i[o]=255*Math.pow(i[o]/255,r)}},function(e,t){var r=t.gGamma;if("gGamma"in t&&1!=r){var n=e("imageData"),i=n.data;r=1/r;for(var o=0,a=i.length;o<a;o+=4)i[o+1]=255*Math.pow(i[o+1]/255,r)}},function(e,t){var r=t.bGamma;if("bGamma"in t&&1!=r){var n=e("imageData"),i=n.data;r=1/r;for(var o=0,a=i.length;o<a;o+=4)i[o+2]=255*Math.pow(i[o+2]/255,r)}},function(e,t){if("rFloor"in t||"rCeil"in t){var r="rFloor"in t?t.rFloor:0,n="rCeil"in t?t.rCeil:255,i=n-r;if(0!==r||255!==n)for(var o=e("imageData").data,a=0,s=o.length;a<s;a+=4)o[a]=o[a]/255*i+r}},function(e,t){if("gFloor"in t||"gCeil"in t){var r="gFloor"in t?t.gFloor:0,n="gCeil"in t?t.gCeil:255,i=n-r;if(0!==r||255!==n)for(var o=e("imageData").data,a=0,s=o.length;a<s;a+=4)o[a+1]=o[a+1]/255*i+r}},function(e,t){if("bFloor"in t||"bCeil"in t){var r="bFloor"in t?t.bFloor:0,n="gCeil"in t?t.bCeil:255,i=n-r;if(0!==r||255!==n)for(var o=e("imageData").data,a=0,s=o.length;a<s;a+=4)o[a+2]=o[a+2]/255*i+r}},function(e,t){if(t.tintColor&&t.tintOpacity){var r=e("canvas"),n=r.getContext("2d");n.save(),n.globalAlpha=t.tintOpacity,n.globalCompositeOperation="source-atop",n.fillStyle=t.tintColor,n.fillRect(0,0,r.width,r.height),n.restore()}},function(e,t){if(t.blurX||t.blurY){var r=e("canvas"),n=r.getContext("2d"),i=document.createElement("canvas"),o=i.getContext("2d");i.width=r.width,i.height=r.height;var a=(t.blurX||0)+1,s=(t.blurY||0)+1;if("linear"==t.blurMode){for(var c=0;c<a;c++){o.globalAlpha=1-c/a;var u=(a-c)/2*(c%2?-1:1);o.drawImage(r,u,0)}n.save(),n.clearRect(0,0,r.width,r.height);for(var l=0;l<s;l++){n.globalAlpha=1-l/s;var h=(s-l)/2*(l%2?-1:1);n.drawImage(i,0,h)}n.restore()}else{for(var f=n.getImageData(0,0,r.width,r.height),d=0,p=255,g=f.data,y=g.length-1;y>0;)d<g[y]&&(d=g[y]),p>g[y]&&(p=g[y]),y-=4;for(g=f=null,o.globalAlpha=1/a,y=0;y<a;y++)o.drawImage(r,y-a/2,0);for(n.save(),n.clearRect(0,0,r.width,r.height),n.globalAlpha=1/s,y=0;y<s;y++)n.drawImage(i,0,y-s/2);n.restore();var m=n.getImageData(0,0,r.width,r.height),v=m.data,w=0,T=255;for(y=v.length-1;y>0;)w<v[y]&&(w=v[y]),T>v[y]&&(T=v[y]),y-=4;var b=d-p,L=w-T;for(y=v.length-1;y>0;){var x=v[y],C=(x-T)/L,S=p+b*C;v[y]=S,y-=4}n.putImageData(m,0,0)}}}];var Renderer=function(){this.animator=new Animator(this),this.foreLayers=[],this.backLayers=[],this.foreCanvas=document.createElement("canvas"),this.foreCtx=this.foreCanvas.getContext("2d"),this.backCanvas=document.createElement("canvas"),this.backCtx=this.backCanvas.getContext("2d"),this.xShift=0,this.yShift=0,this.foreCanvas.width=this.backCanvas.width=config.scWidth,this.foreCanvas.height=this.backCanvas.height=config.scHeight,this.renderBackCanvas=!1,this.transForeCanvas,this.transBackCanvas,this.transCanvas};Renderer.prototype={render:function(){this.foreCtx.clearRect(0,0,this.foreCanvas.width,this.foreCanvas.height),this.renderBackCanvas&&this.backCtx.clearRect(0,0,this.backCanvas.width,this.backCanvas.height),this.foreCtx.save(),this.foreCtx.translate(this.xShift,this.yShift);for(var e=!1,t=0;t<this.foreLayers.length;t++){var r=this.foreLayers[t],n=r.getCorrespondingLayer();if(r.flush(),n.flush(),r.transTag){this.transForeCanvas||(this.transForeCanvas=document.createElement("canvas"),this.transBackCanvas=document.createElement("canvas"),this.transCanvas=document.createElement("canvas"),this.transForeCanvas.width=this.transBackCanvas.width=this.transCanvas.width=this.foreCanvas.width,this.transForeCanvas.height=this.transBackCanvas.height=this.transCanvas.height=this.foreCanvas.height);var i=this.transForeCanvas.getContext("2d"),o=this.transBackCanvas.getContext("2d");i.clearRect(0,0,this.transForeCanvas.width,this.transForeCanvas.height),o.clearRect(0,0,this.transBackCanvas.width,this.transBackCanvas.height),o.drawImage(this.foreCanvas,0,0),n.drawOnContext(o),i.drawImage(this.foreCanvas,0,0),r.drawOnContext(i),r.transTag.method.transit.call(r.transTag,r.transTag.transArgs,this.transForeCanvas,this.transBackCanvas,this.transCanvas),this.foreCtx.drawImage(this.transCanvas,0,0,this.transCanvas.width,this.transCanvas.height)}else r.drawOnContext(this.foreCtx),this.renderBackCanvas&&(e=!0,n.drawOnContext(this.backCtx))}o2.historyLayer.visible&&(o2.historyLayer.flush(),o2.historyLayer.drawOnContext(this.foreCtx)),this.foreCtx.restore(),$(this.foreCanvas).trigger("draw"),e&&$(this.backCanvas).trigger("draw")}},Renderer.showLoadingSign=function(){},Renderer.hideLoadingSign=function(){},Renderer.showServerError=function(e){},Renderer.hideServerError=function(){},Renderer.askForLogin=function(){var e=$.Deferred();return o2.serverStat.mode!=o2.SERVER_MODE_O2SERVER?e.resolve():o2.serverStat.uid!=-1?e.resolve():($("#login-box iframe").one("load",function(){$("#login-box").fadeIn()}).attr("src",o2.serverStat.userServer+"/auth/login_box"),$(window).one("message",function(t){var r=t.originalEvent;"login/cancel"==r.data?(Renderer.closeLoginBox(),e.reject()):"login/success"==r.data&&(Renderer.closeLoginBox(),$.getScript(o2.serverStat.userServer+"/js?id="+config.gameID).then(function(){return loadSystemStateFromServer()}).then(function(){saveCurrentSystemState(),$(o2).trigger("loginbox.loggedin")}).done(function(){e.resolve()}).fail(function(){e.reject()}))}),e.promise())},Renderer.closeLoginBox=function(){$("#login-box").fadeOut("fast",function(){$("#login-box iframe").attr("src","")}),scaleToFitPage()};var Animator=function(e){this.renderer=e,this.animationRequests=[],this.nextCallTimestamp=void 0,this.timeoutId=void 0,this.animationRequestId=void 0};Animator.prototype={requestFrame:function(e,t){void 0==t&&(t=0),e||(e=function(){});var r=Date.now(),n=r+t;!this.isPaused&&(n<this.nextCallTimestamp||void 0==this.nextCallTimestamp)&&(clearTimeout(this.timeoutId),cancelAnimationFrame(this.animationRequestId),t>0?this.timeoutId=setTimeout(this.animationLoopCalled.bind(this),t):this.animationRequestId=requestAnimationFrame(this.animationLoopCalled.bind(this)),this.nextCallTimestamp=n),this.animationRequests.push({callback:e,begin:n})},animationLoopCalled:function(){window.meter&&window.meter.tickStart(),this.nextCallTimestamp=void 0,this.timeoutId=void 0,this.animationRequestId=void 0;var e=this.animationRequests;this.animationRequests=[];for(var t=[],r=0;r<e.length;r++){var n=e[r],i=n.begin-Date.now();i>0?t.push(n):"function"==typeof n.callback&&n.callback()}for(var o=0;o<t.length;o++){var a=t[o],s=a.begin-Date.now();this.requestFrame(a.callback,s)}this.renderer.render(),window.meter&&window.meter.tick()},isPaused:!1,pause:function(){this.isPaused||(this.isPaused=!0,void 0!==this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=void 0),void 0!==this.animationRequestId&&(cancelAnimationFrame(this.animationRequestId),this.animationRequestId=void 0),this.nextCallTimestamp=void 0)},resume:function(){this.isPaused&&(this.isPaused=!1,this.animationRequests.length&&this.requestFrame())}};var Layer=function(e){Drawable.call(this,e),this.rect.width||(this.rect.width=config.scWidth),this.rect.height||(this.rect.height=config.scHeight),Object.defineProperty(this,"canvas",{get:function(){return this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.width=this.rect.width,this._canvas.height=this.rect.height),this._canvas},set:function(e){this._canvas=e}}),Object.defineProperty(this,"ctx",{get:function(){return this.canvas.getContext("2d")}}),this.stackedClearRect=new Rect,this.requestedFrame=!1,this.visible=!0,this.opacity=1,this.rotation=0,this.scaleX=1,this.scaleY=1,this.transformOrigin={x:0,y:0},this.cachedTransform={},this.index=0,this.userInteractionEnabled=!0,this.transTag=void 0,this.moveTag=void 0};Layer.prototype=new Drawable,Layer.prototype.initializer="Layer",Layer.prototype.objectToBeSerialized=function(e){switch(e){case"canvas":case"_canvas":case"ctx":case"cachedTransform":case"transTag":case"moveTag":case"stackedClearRect":case"requestedFrame":case"needRedraw":case"partialDraw":return}return this[e]},Layer.prototype.importFromSaveData=function(e){var t=this;return e.scale&&(this.scaleX=this.scaleY=e.scale,delete e.scale),this.stopTransition(),Drawable.prototype.importFromSaveData.call(this,e).done(function(){t.setRect()})},Layer.prototype.importFrom=function(e){this.rect=clone(e.rect),this.visible=e.visible,this.opacity=e.opacity,this.canvas.width=e.canvas.width,this.canvas.height=e.canvas.height,this.redrawRect(),this.transTag=void 0,this.rotation=e.rotation,this.scaleX=e.scaleX,this.scaleY=e.scaleY,this.transformOrigin=clone(e.transformOrigin),this.cachedTransform={},this.index=e.index},Layer.prototype.destroy=function(){this._canvas=null},Layer.prototype.getCorrespondingLayer=function(){var e=o2.allForeLayers().indexOf(this);return e!=-1?o2.allBackLayers()[e]:(e=o2.allBackLayers().indexOf(this),e!=-1?o2.allForeLayers()[e]:void 0)},Layer.prototype.setRect=function(e){e&&(e.width&&e.height||o2.error("width/heightは0です"),this.rect=e),this.canvas.width=this.rect.width,this.canvas.height=this.rect.height},Layer.prototype.transformMatrix=function(){if(this.cachedTransform.x==this.rect.x&&this.cachedTransform.y==this.rect.y&&this.cachedTransform.rotation==this.rotation&&this.cachedTransform.scaleX==this.scaleX&&this.cachedTransform.scaleY==this.scaleY&&this.cachedTransform.originX==this.transformOrigin.x&&this.cachedTransform.originY==this.transformOrigin.y&&void 0!=this.cachedTransform.matrix)return this.cachedTransform.matrix;var e=[[1,0,0],[0,1,0],[0,0,1]];return e=multiplyMatrix(e,[[1,0,this.rect.x+this.transformOrigin.x],[0,1,this.rect.y+this.transformOrigin.y],[0,0,1]]),0!=this.rotation&&(e=multiplyMatrix(e,[[Math.cos(this.rotation),Math.sin(this.rotation),0],[-Math.sin(this.rotation),Math.cos(this.rotation),0],[0,0,1]])),1==this.scaleX&&1==this.scaleY||(e=multiplyMatrix(e,[[this.scaleX,0,0],[0,this.scaleY,0],[0,0,1]])),this.cachedTransform.x=this.rect.x,this.cachedTransform.y=this.rect.y,this.cachedTransform.rotation=this.rotation,this.cachedTransform.scaleX=this.scaleX,this.cachedTransform.scaleY=this.scaleY,this.cachedTransform.originX=this.transformOrigin.x,this.cachedTransform.originY=this.transformOrigin.y,this.cachedTransform.matrix=e,this.cachedTransform.inverted=void 0,e},Layer.prototype.localLocation=function(e,t){var r=this.cachedTransform.inverted;if(!r){var n=this.transformMatrix(),i=[[n[0][0],n[0][1]],[n[1][0],n[1][1]]],o=i[0][0]*i[1][1]-i[0][1]*i[1][0],a=[[i[1][1]/o,i[0][1]/-o],[i[1][0]/-o,i[0][0]/o]],s=multiplyMatrix(a,[[n[0][2]],[n[1][2]]]);s=[[-s[0][0]],[-s[1][0]]],r=[[a[0][0],a[0][1],s[0][0]],[a[1][0],a[1][1],s[1][0]],[0,0,1]],this.cachedTransform.inverted=r}var c=multiplyMatrix(r,[[e],[t],[1]]);return{x:c[0][0]+this.transformOrigin.x,y:c[1][0]+this.transformOrigin.y}},Layer.prototype.transit=function(e){this.transTag=e,"function"==typeof e.method.prepare&&e.method.prepare.call(e,e.transArgs)},Layer.prototype.isTransiting=function(){return void 0!=this.transTag},Layer.prototype.stopTransition=function(){this.transTag&&(this.transTag.end=!0,"function"==typeof this.transTag.method.teardown&&this.transTag.method.teardown.call(this.transTag),this.importFrom(this.transTag.transArgs.layer.back),this.transTag=void 0)},Layer.prototype.drawOnContext=function(e){if(this.visible){e.save();var t=this.transformMatrix();e.transform(t[0][0],t[1][0],t[0][1],t[1][1],t[0][2],t[1][2]),e.globalAlpha=this.opacity,e.drawImage(this.canvas,-this.transformOrigin.x,-this.transformOrigin.y,this.rect.width,this.rect.height),e.restore()}},Layer.prototype.children=function(){return[]},Layer.prototype.mousedown=function(){return!!this.userInteractionEnabled},Layer.prototype.mousemove=function(){return!!this.userInteractionEnabled},Layer.prototype.mouseup=function(){return!!this.userInteractionEnabled},Layer.prototype.draw=function(e){e.needRedraw=!0,this.requestedFrame||(renderer.animator.requestFrame(),this.requestedFrame=!0)},Layer.prototype.redrawRect=function(e){e||(e=new Rect(0,0,this.rect.width,this.rect.height)),this.stackedClearRect.extend(e),this.requestedFrame||(renderer.animator.requestFrame(),this.requestedFrame=!0)},Layer.prototype.flush=function(){if(!this.requestedFrame)return!1;for(var e=this.children();;){for(var t=!1,r=e.length-1;r>=0;r--){var n=e[r];n.needRedraw||n.frame().intersect(this.stackedClearRect)&&(n.canDrawPartial()?n.partialDraw=!0:this.stackedClearRect.extend(n.frame()),n.needRedraw=!0,t=!0)}if(!t)break}this.stackedClearRect.round(),this.ctx.clearRect(this.stackedClearRect.x,this.stackedClearRect.y,this.stackedClearRect.width,this.stackedClearRect.height);for(var i=this.stackedClearRect.isZero(),o=0;o<e.length;o++){var a=e[o];a.needRedraw&&(!i&&a.partialDraw?a.drawOnContext(this.ctx,this.stackedClearRect):a.drawOnContext(this.ctx),a.needRedraw=!1,a.partialDraw=!1)}return this.stackedClearRect=new Rect,this.requestedFrame=!1,!0};var ImageLayer=function(){Layer.call(this),this.images=[],this.animationConductors=[],this.animationChildren=[]};window.ImageLayer=ImageLayer,ImageLayer.prototype=Object.create(Layer.prototype),ImageLayer.prototype.initializer="ImageLayer",ImageLayer.prototype.children=function(){return this.images.concat(this.animationChildren)},ImageLayer.prototype.importFrom=function(e){Layer.prototype.importFrom.apply(this,arguments),this.clearImage(),this.images=clone(e.images),this.clearAnimationConductors();for(var t in e.animationConductors){var r=clone(e.animationConductors[t]);this.addAnimationConductor(r,t)}},ImageLayer.prototype.objectToBeSerialized=function(e){if(("animationConductors"!=e||this.animationConductors.length)&&"animationChildren"!=e)return Layer.prototype.objectToBeSerialized.apply(this,arguments)},ImageLayer.prototype.importFromSaveData=function(e){this.images=[],this.animationConductors.forEach(function(e){e.stop()}),this.animationConductors=[];for(var t=this,r=[],n=0;n<e.images.length;n++){var i=e.images[n];!function(e){r.push($.when(i.restore()).done(function(r){t.images[e]=r}))}(n)}return delete e.images,$.when.apply($,r).then(function(){o2.log("イメージのロードを完了しました")}).then(function(){var r=[];if(t.clearAnimationConductors(),"animationConductors"in e)for(var n=0;n<e.animationConductors.length;n++){var i=e.animationConductors[n];null!==i&&!function(e,n){r.push($.when(n.restore()).done(function(r){t.addAnimationConductor(r,e),r.run()}))}(n,i)}return delete e.animationConductors,$.when.apply($,r)}).then(function(){return Layer.prototype.importFromSaveData.call(t,e)}).then(function(){return t.redrawRect(),t})},ImageLayer.prototype.loadImage=function(e,t,r){var n=this;return t=t||{},ResourceLoader.loadImage(e,!r).then(function(e){n.clearImage(),n.clearAnimationConductors();var r=new DrawableImage(e,0,0);return r.options=t,n.addImage(r),n.rect.width=r.rect.width,n.rect.height=r.rect.height,n.setRect(),r})},ImageLayer.prototype.addImage=function(e){this.images.push(e),this.draw(e)},ImageLayer.prototype.clearImage=function(){for(var e=0;e<this.images.length;e++)this.redrawRect(this.images[e].rect);this.images=[]},ImageLayer.prototype.getImageRect=function(e){var t=void 0;if("number"==typeof e?t=this.images[e]:"string"==typeof e?t=this.images.filter(function(t){return t.image.originalURL==e})[0]:"function"==typeof e&&(t=this.images.filter(e)[0]),t)return t.rect},ImageLayer.prototype.addAnimationConductor=function(e,t){t in this.animationConductors||(e.layer=this,this.animationConductors[t]=e)},ImageLayer.prototype.clearAnimationConductors=function(){this.animationConductors.forEach(function(e){e.stop()}),this.animationConductors=[]};var BaseLayer=function(){ImageLayer.call(this),this.backgroundSolid=new DrawableSolidColor,this.backgroundSolid.rect=new Rect(0,0,this.rect.width,this.rect.height),this.backgroundSolid.color=config.backgroundColor};BaseLayer.prototype=Object.create(ImageLayer.prototype),BaseLayer.prototype.initializer="BaseLayer",BaseLayer.prototype.children=function(){return[this.backgroundSolid].concat(this.images,this.animationChildren)};var GlyphLayer=function(){ImageLayer.call(this),this.triedLoadCurrentAnimationFile=!1,this.parentLayer=void 0};GlyphLayer.prototype=Object.create(ImageLayer.prototype),GlyphLayer.prototype.initializer="GlyphLayer",GlyphLayer.prototype.objectToBeSerialized=function(e){switch(e){case"parentLayer":case"triedLoadCurrentAnimationFile":return}return ImageLayer.prototype.objectToBeSerialized.apply(this,arguments)},GlyphLayer.prototype.importFromSaveData=function(){return ImageLayer.prototype.importFromSaveData.apply(this,arguments)},GlyphLayer.prototype.redrawRect=function(){this.requestedFrame=!0,this.parentLayer&&this.parentLayer.redrawRect(this.rect),ImageLayer.prototype.redrawRect.apply(this,arguments)},GlyphLayer.prototype.draw=function(){this.requestedFrame=!0,this.parentLayer&&this.parentLayer.redrawRect(this.rect),ImageLayer.prototype.draw.apply(this,arguments)},GlyphLayer.prototype.drawOnContext=function(){this.flush(),ImageLayer.prototype.drawOnContext.apply(this,arguments)},GlyphLayer.prototype.showOnLayer=function(e,t){var r=this,n=t+".asd";return this.parentLayer=e,$.when(function(){return r.images.length&&r.images[0].image.originalURL===t?void 0:(r.triedLoadCurrentAnimationFile=!1,r.loadImage(t))}()).then(function(){if(r.animationConductors.length&&r.animationConductors[0].file.filename==n)return r.visible=!0,r.animationConductors[0].status==Conductor.STATUS_STOP&&r.animationConductors[0].oneShot(),"loaded";if(!r.triedLoadCurrentAnimationFile){var e;try{e=_KAGFiles(n)}catch(t){}return e}}).then(function(e){if("loaded"!==e){if(r.triedLoadCurrentAnimationFile=!0,!e)return void o2.warn(n+"が見つからないです。");var t=new AnimationConductor({file:e});r.addAnimationConductor(t,0),t.run(),r.visible=!0}})},GlyphLayer.prototype.hide=function(){this.visible&&(this.visible=!1,this.redrawRect(),this.animationConductors.length&&this.animationConductors[0].status!==Conductor.STATUS_STOP&&(this.animationConductors[0].status=Conductor.STATUS_STOP,this.animationConductors[0].queue.push(new Tag("s"))))};var TextProperties=function(e){Drawable.call(this),this.text=e,this.rubyText,this.styles={opacity:1,size:20,face:"Arial",visible:!1,shadowBlur:5,vertical:void 0,shadowOffsetX:0,shadowOffsetY:0},this.useCanvasCache=!1,this.canvas};TextProperties.prototype=new Drawable,TextProperties.prototype.initializer="TextProperties",TextProperties.prototype.importFrom=function(e){Drawable.prototype.importFrom.call(this,e),this.text=e.text,this.rubyText=e.rubyText,this.styles=clone(e.styles),this.useCanvasCache=e.useCanvasCache},TextProperties.prototype.objectToBeSerialized=function(e){switch(e){case"canvas":return}return this[e]},TextProperties.prototype.drawOnContext=function(e){if(this.styles.visible&&0!=this.styles.opacity){if(this.useCanvasCache){var t=this.frame();if(!this.canvas){this.canvas=document.createElement("canvas"),this.canvas.width=t.width,this.canvas.height=t.height;var r=this.canvas.getContext("2d");r.textBaseline="top";var n=this.rect.x-t.x,i=this.rect.y-t.y;this.useCanvasCache=!1;var o=this.rect,a=this.styles.opacity;this.styles.opacity=1,this.rect=new Rect(n,i,this.rect.width,this.rect.height),this.drawOnContext(r),this.rect=o,this.styles.opacity=a,this.useCanvasCache=!0}return e.save(),e.globalAlpha=this.styles.opacity,e.drawImage(this.canvas,t.x,t.y,this.canvas.width,this.canvas.height),void e.restore()}e.save();var s=this.styles.color;if(e.fillStyle!=s&&(e.fillStyle=s),this.styles.shadow?(e.shadowColor=this.styles.shadowColor,e.shadowBlur=this.styles.shadowBlur,e.shadowOffsetX=this.styles.shadowOffsetX,e.shadowOffsetY=this.styles.shadowOffsetY):e.shadowBlur=0,e.globalAlpha!=this.styles.opacity&&(e.globalAlpha=this.styles.opacity),this.styles.vertical)this.fillTextVertical(e);else{var c;if(this.rubyText){c=this.rubyFont(),e.font!=c&&(e.font=c);var u=this.measureRuby(e),l=(this.rect.width-u.width)/2;this.styles.edge&&(e.lineJoin="round",e.lineWidth=this.styles.size/5,e.strokeStyle=this.styles.edgeColor,e.strokeText(this.rubyText,this.rect.x+l,this.rect.y-u.height-this.styles.rubyOffset)),e.fillText(this.rubyText,this.rect.x+l,this.rect.y-u.height-this.styles.rubyOffset)}c=this.font(),e.font!=c&&(e.font=c),this.styles.edge&&(e.lineJoin="round",e.lineWidth=this.styles.size/5,e.strokeStyle=this.styles.edgeColor,e.strokeText(this.text,this.rect.x,this.rect.y)),browser.isFirefox&&e.translate(0,.2*this.styles.size),e.fillText(this.text,this.rect.x,this.rect.y)}e.restore()}},TextProperties.prototype.clearCache=function(){this.canvas&&($(this.canvas).remove(),this.canvas=void 0)},TextProperties.prototype.frame=function(){var e=0;this.styles.edge&&(e+=.2*this.styles.size);var t=new Rect({x:this.rect.x-e,y:this.rect.y-e,width:this.rect.width+2*e,height:this.rect.height+2*e});if(t.y-=.1*this.styles.size,t.height+=.2*this.styles.size,this.styles.shadow){var r=new Rect({x:t.x-this.styles.shadowBlur,y:t.y-this.styles.shadowBlur,width:t.width+2*this.styles.shadowBlur,height:t.height+2*this.styles.shadowBlur});r.x+=this.styles.shadowOffsetX,r.y+=this.styles.shadowOffsetY,t.extend(r)}if((browser.isIOs||browser.isAndroid)&&(t.height+=5),this.rubyText){var n,i=this.measureRuby();if(this.styles.vertical){var o=(this.rect.height-i.height)/2;n=new Rect({x:this.rect.x+this.rect.width+this.styles.rubyOffset,y:this.rect.y+o-10,width:i.width,height:i.height+10})}else{var a=(this.rect.width-i.width)/2;n=new Rect({x:this.rect.x+a,y:this.rect.y-this.styles.rubySize+this.styles.rubyOffset-10,width:i.width,height:i.height+10})}this.styles.edge&&(n.x-=.1*i.width,n.y-=.1*i.height,n.width+=.2*i.width,n.height+=.2*i.height),t.extend(n)}return this.styles.italic&&(t.width+=10),t},TextProperties.prototype.font=function(){var e="";return this.styles.italic&&(e+="italic "),this.styles.bold&&(e+="bold "),e+=this.styles.size+"px ",e+=this.styles.face,e+=" , Arial"},TextProperties.prototype.rubyFont=function(){return this.styles.rubySize+"px "+this.styles.face},TextProperties.prototype.measure=function(e){e.save();var t=this.font();if(e.font!=t&&(e.font=t),this.styles.vertical)r=this.measureVertical(e,this.text);else{var r=e.measureText(this.text);r.height=this.styles.size}return e.restore(),r},TextProperties.prototype.measureRuby=function(e){e||(e=o2.currentMessageLayer.ctx),e.save();var t=this.rubyFont();if(this.font!=t&&(e.font=t),this.styles.vertical)r=this.measureVertical(e,this.rubyText,this.styles.rubySize);else{var r=e.measureText(this.rubyText);r.height=this.styles.rubySize}return e.restore(),r},function(){function e(e,t,r,n,i){var o=r*Math.PI/180,a=Math.cos(o),s=Math.sin(o);return[[e*a,t*s],[-e*s,t*a],[e*(a*n-s*i),t*(s*n+a*i)]]}function t(e,t){e.setTransform(t[0][0],t[0][1],t[1][0],t[1][1],t[2][0],t[2][1])}function r(t,r,n,i,o){switch(t){case"rotate90":return e(1,1,90,-r+n+o,-r-n);case"reflect45":return e(1,-1,270,-r+n+i,r-n-o);case"offsetTopRight":return e(1,1,0,.625*i,-.625*o);case"offsetRight":return e(1,1,0,.125*i,-.125*o);default:return[[1,0],[0,1],[0,0]]}}function n(e,n,u,l,h){var f=e.measureText(n),d=h||this.styles.size,p=this.styles.size;n in i&&(n=i[n]);var g="";return o.indexOf(n)!=-1?g="offsetTopRight":a.indexOf(n)!=-1?g="offsetRight":s.indexOf(n)!=-1?(u+=p,l-=d,g="rotate90"):c.indexOf(n)!=-1&&(u+=p,l-=d,g="reflect45"),e.save(),t(e,r(g,u,l,f.width,d)),this.styles.edge&&(e.lineJoin="round",e.lineWidth=f/5,e.strokeStyle=this.styles.edgeColor,e.strokeText(n,u,l)),e.fillText(n,u,l),e.restore(),"rotate90"==g?f.width:d}var i={"《":"︽","》":"︾","(":"︵","（":"︵",")":"︶","）":"︶","{":"︷","｛":"︷","}":"︸","｝":"︸","【":"︻","】":"︼","＜":"︿","<":"︿","＞":"﹀",">":"﹀","「":"﹁","」":"﹂","『":"﹃","』":"﹄","〔":"︹","〕":"︺"},o=["、","。","．"],a="ぁぃぅぇぉっゃゅょゎヵヶ",s="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ;:.s~〜…s＇─│┌┐┘└├┬┤┴┼━┃┏┓┛┗┣┳┫┻╋┠┯┨┷┿┝┰┥┸╂".split(""),c=["ー","―","～"];TextProperties.prototype.measureVertical=function(e,t,r){for(var n=t.split(""),i=0,o=0,a=0;a<n.length;a++){var c=n[a],u={width:e.measureText(c).width,height:r||this.styles.size};if(s.indexOf(c)!=-1){var l=u.height;u.height=u.width,u.width=l}o+=u.height,i<u.width&&(i=u.width)}return{width:i,height:o}},TextProperties.prototype.fillTextVertical=function(e){var t=this.text.split(""),r=this.rect.y,i=this.font();e.font!=i&&(e.font=i),e.save();for(var o=0;o<t.length;o++){var a=t[o];r+=n.call(this,e,a,this.rect.x,r)}if(e.restore(),this.rubyText){i=this.rubyFont(),e.font!=i&&(e.font=i);var s=this.measureRuby(e),c=(this.rect.height-s.height)/2,u=this.rubyText.split("");r=this.rect.y+c;for(var l=0;l<u.length;l++){var h=u[l];r+=n.call(this,e,h,this.rect.x+this.rect.width+this.styles.rubyOffset,r,this.styles.rubySize)}}}}(),TextProperties.prototype.calculateSize=function(e){var t=this.measure(e);return this.rect.width=t.width,this.rect.height=t.height,t},TextProperties.prototype.isEqual=function(e){if(!(e instanceof TextProperties))return!1;if(!this.frame().isEqual(e.frame()))return!1;for(var t in this.styles)if(this.styles[t]!=e.styles[t])return!1;return!0};var Button=function n(e,t,r){DrawableImage.call(this,e,t,r),this.cacheEnabled=!1,this.state=n.STATE_NORMAL};Button.prototype=Object.create(DrawableImage.prototype),Button.prototype.initializer="Button",Button.STATE_NORMAL=0,Button.STATE_HOVER=1,Button.STATE_DOWN=2,Button.STATE_DISABLE=3,Button.prototype.click=function(e,t,r){this.state=Button.STATE_HOVER},Button.prototype.enter=function(e,t,r){this.state=Button.STATE_HOVER},Button.prototype.leave=function(e,t,r){this.state=Button.STATE_NORMAL},Button.prototype.mousemove=function(e,t,r){},Button.prototype.mousedown=function(e,t,r){this.state=Button.STATE_DOWN},Button.prototype.cancel=function(){this.state=Button.STATE_NORMAL},Button.prototype.clone=function(){var e=new Button(this.image);return e.importFrom(this),e},Button.restore=function(e){return $.when(ResourceLoader.loadImage(e.image,!0)).then(function(t){var r=new Button(t);return r.importFromSaveData(e),r})};var Link=function(e){DrawableSolidColor.call(this),this.color=config.messageLayerDefaultLinkColor||"#0000ff",this.opacity=config.messageLayerDefaultLinkOpacity,this.hovering,this.textsProperties=[],this.rects=[],this.vertical=!1,this.messageLayer};Link.prototype=Object.create(DrawableSolidColor.prototype),Link.prototype.initializer="Link",Link.restore=function(e){var t=new Link;return t.importFromSaveData()},Link.prototype.objectToBeSerialized=function(e){switch(e){case"messageLayer":return}return this[e]},Link.prototype.importFrom=function(e){DrawableSolidColor.prototype.importFrom.call(this,e),this.vertical=e.vertical,e.messageLayer?(this.textsProperties=e.textsProperties.map(function(e){return e}),this.refreshRects()):(this.textsProperties=clone(e.textsProperties),this.refreshRects())},Link.prototype.isHovering=function(e,t){for(var r=0;r<this.rects.length;r++)if(this.rects[r].coverCoordinate(e,t))return!0;return!1},Link.prototype.drawOnContext=function(e,t){if(this.hovering){for(var r=this.rect,n=0;n<this.rects.length;n++)this.rect=this.rects[n],DrawableSolidColor.prototype.drawOnContext.call(this,e);this.rect=r}},Link.prototype.addTextProperties=function(e){e instanceof Array?this.textsProperties=this.textsProperties.concat(e):this.textsProperties.push(e),this.refreshRects()},Link.prototype.refreshRects=function(){this.rects=[],this.rect=new Rect;for(var e,t=0;t<this.textsProperties.length;t++){var r=this.textsProperties[t],n=r.frame();e||(e=new Rect),e.extend(n),(t==this.textsProperties.length-1||this.textsProperties[t+1].frame().y!=n.y&&!this.vertical||this.textsProperties[t+1].frame().x!=n.x&&this.vertical)&&(this.rects.push(e),this.rect.extend(e),e=void 0)}},Link.prototype.click=function(e,t,r){},Link.prototype.enter=function(e,t,r){},Link.prototype.leave=function(e,t,r){};var MessageLayer=function i(e){Layer.call(this,e||new Rect({x:config.messageLayerCurrentPositionX,y:config.messageLayerCurrentPositionY,width:config.messageLayerCurrentWidth,height:config.messageLayerCurrentHeight})),this.frameImage,this.frameSolid=new DrawableSolidColor(new Rect(0,0,this.rect.width,this.rect.height)),this.frameSolid.color=config.messageLayerColor||"#000",this.frameSolid.opacity=config.messageLayerOpacity,this.visible=!1,this.opacity=1,this.margin={top:config.messageLayerMarginT||20,right:config.messageLayerMarginR||20,bottom:config.messageLayerMarginB||20,left:config.messageLayerMarginL||20},this.textsProperties=[],this.vertical=config.messageLayerVertical,this.textCursor={x:0,y:0},this.align="left",this.delaySpeed=config.chSpeeds||20,this.ctx.textBaseline="top",this.defaultFont=i.defaults.defaultFont(),this.defaultStyle=i.defaults.defaultStyle(),this.font=clone(this.defaultFont),this.style=clone(this.defaultStyle),ResourceLoader.loadFont(this.defaultFont.face),ResourceLoader.loadFont(this.font.face),this.glyphOptions=i.defaults.glyphOptions(),this.textCustomizers=["baseTextCustomizer","alignTextCustomizer"],this.isDrawingText=!1,this.buttons=[],this.routineButtons=[],this.links=[],this.images=[],this.lastLineSize=0,this.resetCursor();var t=this;setTimeout(function(){$(conductor).on("ran",function(){t.refreshRoutineButtons(void 0,void 0,!0)})})};MessageLayer.prototype=Object.create(Layer.prototype),MessageLayer.prototype.initializer="MessageLayer",MessageLayer.defaults={defaultFont:function(){return{size:config.messageLayerDefaultFontSize||20,face:config.messageLayerDefaultFontFace||"Arial",color:config.messageLayerDefaultFontColor||"#000000",rubySize:config.messageLayerDefaultRubySize||10,rubyOffset:config.messageLayerDefaultRubyOffset||0,shadow:config.messageLayerDefaultShadow,shadowColor:config.messageLayerDefaultShadowColor||"#999999",shadowBlur:config.messageLayerDefaultShadowBlur,shadowOffsetX:config.messageLayerDefaultShadowOffsetX,shadowOffsetY:config.messageLayerDefaultShadowOffsetY,edge:config.messageLayerDefaultEdge,edgeColor:config.messageLayerDefaultEdgeColor||"#00ff00",bold:config.messageLayerDefaultFontBold,italic:config.messageLayerDefaultFontItalic}},font:function(){return this.defaultFont()},defaultStyle:function(){return{lineSpacing:Number(config.messageLayerDefaultStyleLineSpacing)||0,pitch:Number(config.messageLayerDefaultStylePitch)||0,lineSize:0,align:"left",autoReturn:config.messageLayerDefaultAutoReturn,kinsoku:MessageLayer.KINSOKU_BURASAGARI,kinsokuBolChar:" 。．、，」』）〉】》］〕”｝’〟？！⁇‼⁈⁉",kinsokuEolChar:"「『（〈【《［〔“｛‘〝",kinsokuBurasagariChar:"。．、，"}},style:function(){return this.defaultStyle()},glyphOptions:function(){return{line:config.messageLayerDefaultGlyphLine,page:config.messageLayerDefaultGlyphPage,fixed:config.messageLayerDefaultGlyphFixed,x:config.messageLayerDefaultGlyphX,y:config.messageLayerDefaultGlyphY}}},MessageLayer.prototype.objectToBeSerialized=function(e){switch(e){case"textsProperties":case"links":case"glyphLayer":case"isDrawingText":return}if(["buttons","routineButtons","images"].indexOf(e)==-1||this[e].length){if(MessageLayer.defaults.hasOwnProperty(e)){var t=MessageLayer.defaults[e]();if(!t)return;var r={};for(var n in this[e])this[e][n]!=t[n]&&(r[n]=this[e][n]);return r}return Layer.prototype.objectToBeSerialized.call(this,e)}},MessageLayer.prototype.importFromSaveData=function(e){var t=this;this.buttons=[];var r=[];if(e.buttons){for(var n=0;n<e.buttons.length;n++){var i=e.buttons[n];r.push($.when(i.restore()).done(function(e){t.addButton(e)}))}delete e.buttons}if(this.images=[],e.images)for(var o=0;o<e.images.length;o++){var a=e.images[o];r.push($.when(a.restore()).done(function(e){t.images.push(e)}))}if(delete e.images,this.links=[],e.links)for(var s=0;s<e.links.length;s++){var c=e.links[s];r.push($.when(c.restore()).done(function(e){t.addLink(e)}))}return delete e.links,this.textCustomizers=[],this.textsProperties=[],r.push(Layer.prototype.importFromSaveData.call(this,e)),e.font.face&&r.push(ResourceLoader.loadFont(e.font.face)),e.defaultFont.face&&r.push(ResourceLoader.loadFont(e.defaultFont.face)),$.when.apply($,r).then(function(){return t.setRect(t.rect),t.redrawRect(),t})},MessageLayer.KINSOKU_NONE=0,MessageLayer.KINSOKU_OIDASHI=1,MessageLayer.KINSOKU_BURASAGARI=2,MessageLayer.prototype.children=function(){var e=[];return this.frameImage?e.push(this.frameImage):e.push(this.frameSolid),e=e.concat(this.textsProperties,this.links,this.images,this.buttons,this.routineButtons),
this.glyphLayer&&e.push(this.glyphLayer),e},MessageLayer.prototype.importFrom=function(e){if(!(e instanceof MessageLayer))throw"[内部エラー] otherLayerはMessageLayerではありません";Layer.prototype.importFrom.call(this,e);var t=["frameImage","frameSolid","margin","textsProperties","vertical","lineWidth","textCursor","align","delaySpeed","defaultFont","defaultStyle","font","style","textCustomizers","buttons","images","routineButtons"];(function(){if(this.isDrawingText){var e=t.indexOf("textsProperties");e<0||t.splice(e,1)}}).call(this);for(var r=0;r<t.length;r++){var n=t[r];this[n]=clone(e[n])}this.links=[];for(var i=this,o=0;o<e.links.length;o++){var a=e.links[o],s=clone(a);s.textsProperties=a.textsProperties.map(function(e){var t=a.messageLayer.textsProperties.indexOf(e);if(t!=-1)return i.textsProperties[t]}),this.addLink(s)}this.setRect(clone(e.rect),!0)},MessageLayer.prototype.mousemove=function(e){if(!this.visible)return!1;if(!Layer.prototype.mousemove.apply(this,arguments))return!1;var t=!1,r=e.originalEvent.normalizedCoordinate(this);return this.refreshRoutineButtons(r.x,r.y)&&(t=!0),this.refreshButtons(r.x,r.y)&&(t=!0),this.refreshLinks(r.x,r.y)&&(t=!0),t},MessageLayer.prototype.mouseup=function(e){if(!this.visible)return!1;if(!Layer.prototype.mousedown.apply(this,arguments))return!1;for(var t=e.originalEvent.normalizedCoordinate(this),r=this.buttons.length-1;r>=0;r--){var n=this.buttons[r];if(!n.rect.coverCoordinate(t.x,t.y)&&n.state==Button.STATE_DOWN)return n.leave(t.x,t.y,this),this.redrawRect(n.rect),!0}for(var i=this.routineButtons.length-1;i>=0;i--){var o=this.routineButtons[i];if(o.rect.coverCoordinate(t.x,t.y)&&o.state!=Button.STATE_DISABLE)return o.click(t.x,t.y,this),o.state=Button.STATE_HOVER,this.redrawRect(o.rect),!0}for(var a=this.buttons.length-1;a>=0;a--){var s=this.buttons[a];if(s.rect.coverCoordinate(t.x,t.y))return s.click(t.x,t.y,this),s.state=Button.STATE_HOVER,this.redrawRect(s.rect),!0}for(var c=this.links.length-1;c>=0;c--){var u=this.links[c];if(u.isHovering(t.x,t.y))return u.click(t.x,t.y,this),!0}return!1},MessageLayer.prototype.mousedown=function(e){if(!this.visible)return!1;if(!Layer.prototype.mousedown.apply(this,arguments))return!1;for(var t=e.originalEvent.normalizedCoordinate(this),r=this.routineButtons.length-1;r>=0;r--){var n=this.routineButtons[r];if(n.rect.coverCoordinate(t.x,t.y)&&n.state!=Button.STATE_DISABLE)return n.mousedown(t.x,t.y,this),this.redrawRect(n.rect),!0}for(var i=this.buttons.length-1;i>=0;i--){var o=this.buttons[i];if(o.rect.coverCoordinate(t.x,t.y))return o.mousedown(t.x,t.y,this),this.redrawRect(o.rect),!0}return!1},MessageLayer.prototype.touchcancel=function(){for(var e=this.routineButtons.length-1;e>=0;e--){var t=this.routineButtons[e];t.cancel()}for(var r=this.buttons.length-1;r>=0;r--){var n=this.buttons[r];n.cancel()}},MessageLayer.prototype.setRect=function(e,t){e||(e=this.rect),e.width&&e.height||o2.error("width/heightは0です");var r=this.rect.width!=e.width||this.rect.height!=e.height||this.canvas.width!=e.width||this.canvas.height!=e.height;r&&(this.canvas.width=e.width,this.canvas.height=e.height),this.ctx.textBaseline="top",this.rect=e,this.frameSolid.rect.width=e.width,this.frameSolid.rect.height=e.height,(r||t)&&this.redrawRect()},MessageLayer.prototype.resetCursor=function(){this.vertical?this.textCursor={x:this.rect.width-this.margin.right-this.style.lineSpacing,y:this.margin.top}:this.textCursor={x:this.margin.left,y:this.margin.top+this.style.lineSpacing}},MessageLayer.prototype.linebreak=function(){var e=this.lastLineSize||Math.max(this.style.lineSize,this.font.size);this.vertical?(this.textCursor.y=this.margin.top,this.textCursor.x-=this.style.lineSpacing+e):(this.textCursor.x=this.margin.left,this.textCursor.y+=this.style.lineSpacing+e)},MessageLayer.textCustomizers={baseTextCustomizer:function(e,t,r){this.isAnimation=!1;var n=e.delaySpeed,i=void 0,o=function(t){return i?i:i=function(){var r,n=[],i=e.textCursor.x,o=e.textCursor.y,a=0,s=0,c=void 0;for(r=0;r<t.length;r++){var u=t[r];u.rect.isZero()&&void 0===u.styles.vertical&&(u.styles.vertical=e.vertical)}for(r=0;r<t.length;r++){var l=t[r];if(l.rect.isZero()){if(void 0==c){e.vertical?(a=Math.max(a,e.style.lineSize),e.lastLineSize=a):(s=Math.max(s,e.style.lineSize),e.lastLineSize=s),c=function(){for(var n=e.vertical?o:i,c=r;c<t.length;c++){var u=t[c].measure(e.ctx);if(e.vertical){if(n+=u.height+e.style.pitch,u.width>a&&(a=u.width,e.lastLineSize=a),n>e.rect.height-e.margin.bottom&&e.style.autoReturn)return c}else if(u.height>s&&(s=u.height,e.lastLineSize=s),n+=u.width+e.style.pitch,n>e.rect.width-e.margin.right&&e.style.autoReturn)return c}return-1}();var h=c;if(c!=-1){var f=t[c],d=t[c+1];if(e.style.kinsoku!=MessageLayer.KINSOKU_BURASAGARI||e.style.kinsokuBurasagariChar.indexOf(f.text)==-1||d&&e.style.kinsokuBolChar.indexOf(d.text)!=-1){if(e.style.kinsoku!=MessageLayer.KINSOKU_NONE)for(;e.style.kinsokuBolChar.indexOf(t[c].text)!=-1||t[c-1]&&e.style.kinsokuEolChar.indexOf(t[c-1].text)!=-1;)if(c--,c<=r){c=h;break}}else d?c++:c=-1}}var p=l.measure(e.ctx);if(c===r)if(e.vertical){if(!(o<=e.margin.top)){o=e.margin.top,i-=a+e.style.lineSpacing,a=0,c=void 0,r--;continue}c++}else{if(!(i<=e.margin.left)){i=e.margin.left,o+=s+e.style.lineSpacing,s=0,c=void 0,r--;continue}c++}e.vertical?n[r]={x:i-a+(a-p.width)/2,y:o,width:p.width,height:p.height}:n[r]={x:i,y:o+s-p.height,width:p.width,height:p.height},l.rect=new Rect(n[r]),e.vertical?o+=p.height+e.style.pitch:i+=p.width+e.style.pitch}}return n}()},a=t.concat(r),s=o(a),c=this;this.perform=function(){r.forEach(function(e,t){c.timePassed/n>=t&&(e.styles.visible||(e.styles.visible=!0,e.needRedraw=!0))}),s.forEach(function(e,t){a[t].rect=new Rect(e)})},this.isEnded=function(){return c.timePassed/n>=r.length}},alignTextCustomizer:function(e,t,r){if(e.vertical){if("center"!=e.style.align&&"bottom"!=e.style.align)return}else if("left"==e.style.align)return;var n=t.concat(r);this.perform=function(){var t=e.style.align;if(e.vertical)for(var r=0,i=0;i<n.length;i++){var o=n[i];if(i>=n.length-1||o.rect.y>n[i+1].rect.y){for(var a=0,s=r;s<=i;s++)n[s].styles.visible&&(a+=n[s].rect.height+e.style.pitch);a-=e.style.pitch;var c=0,u=e.rect.height-e.margin.top-e.margin.bottom;"center"==t?c=(u-a)/2:"bottom"==t&&(c=u-a);for(var l=r;l<=i;l++)n[l].styles.visible&&(n[l].rect.y=c,n[l].needRedraw=!0,c+=n[l].rect.height+e.style.pitch);r=i+1}}else for(var h=0,f=0;f<n.length;f++){var d=n[f];if(f>=n.length-1||d.rect.x>n[f+1].rect.x){for(var p=0,g=h;g<=f;g++)n[g].styles.visible&&(p+=n[g].rect.width+e.style.pitch);var y=0,m=e.rect.width-e.margin.left-e.margin.right;"center"==t?y=(m-p)/2+e.margin.left:"right"==t&&(y=m-p+e.margin.left);for(var v=h;v<=f;v++)n[v].styles.visible&&(n[v].rect.x=y,n[v].needRedraw=!0,y+=n[v].rect.width+e.style.pitch);h=f+1}}}}},MessageLayer.prototype.drawText=function(e,t){function r(){for(var e=!0,n=Date.now()-l,i=0;i<u.length;i++){var o=u[i];o.timePassed=n,(o2.skipMode||0==this.delaySpeed)&&(o.timePassed=1/0),"function"==typeof o.perform&&o.perform(),"function"==typeof o.isEnded&&0==o.isEnded()&&(e=!1)}this.redrawRect();for(var a=0;a<this.links.length;a++)this.links[a].refreshRects();if(e){var c=this.textsProperties[this.textsProperties.length-1];c&&(this.vertical?this.textCursor={x:c.rect.x+c.rect.width+(this.lastLineSize-c.rect.width)/2,y:c.rect.y+c.rect.height}:this.textCursor={x:c.rect.x+c.rect.width,y:c.rect.y+c.rect.height-this.lastLineSize}),this.isDrawingText=!1,"function"==typeof t&&setTimeout(t.bind(this),0),u.forEach(function(e){"function"==typeof e.destroy&&e.destroy()})}else renderer.animator.requestFrame(r.bind(this),s?0:this.delaySpeed)}this.isDrawingText=!0;var n=this;"string"==typeof e&&(e=e.split(""));for(var i=this.textsProperties.slice(),o=e.map(function(e){if(e instanceof TextProperties)return e;var t=new TextProperties(e);return $.extend(t.styles,clone(n.font)),t}),a=0;a<o.length;a++)this.textsProperties.push(o[a]);var s=!1,c=!1,u=this.textCustomizers.map(function(e){if(e=MessageLayer.textCustomizers[e],"function"!=typeof e)return void o2.error(e+"はtextCustomizerではないです。");var t=new e(this,i,o);return!s&&t.isAnimation&&(s=!0),t},this);!c&&(s||["center","right","bottom"].indexOf(this.style.align)>=0)&&this.textsProperties.forEach(function(e){e.useCanvasCache=!0});var l=Date.now();r.call(this)},MessageLayer.prototype.measureText=function(e){return"string"==typeof e&&(e=new TextProperties(e),$.extend(e.styles,clone(this.font))),e.measure(this.ctx)},MessageLayer.prototype.refreshButtons=function(e,t){for(var r=!1,n=this.buttons.length-1;n>=0;n--){var i=this.buttons[n],o=i.rect.coverCoordinate(e,t);this.drawButton(i,o,e,t),(o||i.state==Button.STATE_DOWN)&&(r=!0,i.mousemove(e,t,this))}return r},MessageLayer.prototype.drawButton=function(e,t,r,n){t&&e.state==Button.STATE_NORMAL?(e.enter(r,n,this),this.redrawRect(e.rect)):t||e.state!=Button.STATE_HOVER||(e.leave(r,n,this),this.redrawRect(e.rect))},MessageLayer.prototype.addButton=function(e){this.buttons.push(e),this.draw(e)},MessageLayer.prototype.refreshRoutineButtons=function(e,t,r){var n=!1,i=[],o=r?currentConductor.getNextTag():currentConductor.currentTag;if(o){for(var a=["p","l","s"].indexOf(o.tagName)!=-1,s=this.routineButtons.length-1;s>=0;s--){var c=this.routineButtons[s],u=!(!e||!t)&&c.rect.coverCoordinate(e,t);u?i.push(c):this.drawRoutineButton(c,u,a,e,t),u&&a&&c.enabled&&(n=!0)}for(var l=0;l<i.length;l++){var h=i[l];this.drawRoutineButton(h,!0,a,e,t)}return n}},MessageLayer.prototype.drawRoutineButton=function(e,t,r,n,i){var o=Button.STATE_NORMAL;r?t?(o=Button.STATE_HOVER,e.state!=Button.STATE_HOVER&&(e.enter(n,i,this),this.redrawRect(e.rect))):(o=Button.STATE_NORMAL,e.state==Button.STATE_HOVER&&(e.leave(n,i,this),this.redrawRect(e.rect))):o=Button.STATE_DISABLE,e.state!=o&&(e.state=o,this.redrawRect(e.rect))},MessageLayer.prototype.addRoutineButton=function(e){this.routineButtons.push(e),this.draw(e)},MessageLayer.prototype.refreshLinks=function(e,t){for(var r=!1,n=this.links.length-1;n>=0;n--){var i=this.links[n],o=i.isHovering(e,t);this.drawLink(i,o,e,t),o&&(r=!0)}return r},MessageLayer.prototype.drawLink=function(e,t,r,n){t&&!e.hovering?(e.enter(r,n,this),e.hovering=!0,e.visible=!0,this.draw(e)):!t&&e.hovering&&(e.leave(r,n,this),e.hovering=!1,e.visible=!1,this.redrawRect(e.rect))},MessageLayer.prototype.addLink=function(e){e.vertical=this.vertical,e.messageLayer=this,this.links.push(e)},MessageLayer.prototype.addButtonLinkImages=function(){for(var e=0;e<this.buttons.length;e++){var t=this.buttons[e],r=new DrawableCanvas(t.rect);t.rect.x=t.rect.y=0,t.drawOnContext(r.ctx),this.images.push(r),this.redrawRect(r.rect)}for(var n=0;n<this.links.length;n++){var i=this.links[n];if(i.visible&&i.hovering)for(var o=0;o<i.rects.length;o++){var a=i.rects[o],s=new DrawableSolidColor(a);s.importFrom(i),this.images.push(s),this.redrawRect(s.rect)}}},MessageLayer.prototype.showGlyphLayer=function(e,t){t=t||"line",this.glyphLayer=e;var r=this,n="line"===t?this.glyphOptions.line:this.glyphOptions.page;this.glyphLayer.showOnLayer(this,n).done(function(){r.glyphOptions.fixed?(e.rect.x=r.glyphOptions.x,e.rect.y=r.glyphOptions.y):r.vertical?(e.rect.x=r.textCursor.x-e.rect.width,e.rect.y=r.textCursor.y):(e.rect.x=r.textCursor.x,e.rect.y=r.textCursor.y+Math.max(r.style.lineSize,r.font.size)-e.rect.height),r.redrawRect(e.rect)})},MessageLayer.prototype.hideGlyphLayer=function(){this.glyphLayer&&this.glyphLayer.hide(),this.glyphLayer=void 0},MessageLayer.prototype.resetFrameSize=function(){this.frameSolid.rect.width=this.rect.width,this.frameSolid.rect.height=this.rect.height},MessageLayer.prototype.setFrameImage=function(e){if(void 0!=e&&!(e instanceof Drawable))throw"[内部エラー] imageはdrawableではありません";this.frameImage?this.redrawRect(this.frameImage.frame()):this.redrawRect(this.rect),this.frameImage=e,this.frameImage&&this.redrawRect(this.frameImage.rect)},MessageLayer.prototype.resetMessageLayer=function(){for(var e=this.buttons.length-1;e>=0;e--)this.redrawRect(this.buttons[e].frame());for(var t=this.textsProperties.length-1;t>=0;t--)this.redrawRect(this.textsProperties[t].frame());this.buttons=[],this.routineButtons=[],this.images=[],this.links=[],this.textsProperties=[],this.font=clone(this.defaultFont),this.style=clone(this.defaultStyle),this.resetCursor(),this.resetFrameSize(),this.redrawRect()};var Sound=function(e){this.filepath,this.isPlaying=!1,this.volume=1,this.volumePercentage=1,this.loop=!1,this.pan=0,this.loadDefer,this.audio=new Audio,this.fadeDefer,this.fadeStatus,"string"==typeof e&&this.setFile(e)};Sound.prototype.objectToBeSerialized=function(e){switch(e){case"audio":case"loadDefer":return}return this[e]},Sound.prototype.importFromSaveData=function(e){this.filepath=void 0;var t=this,r=e.fadeStatus;return delete e.fadeStatus,Object.prototype.importFromSaveData.call(this,e).then(function(){if(t.isPlaying||t.stop(),r||t.stopFade(),t.filepath){var e=t.setFile(t.filepath);return t.isPlaying&&t.loop&&t.play(),r&&t.fade(r),e}})},Sound.prototype.setFile=function(e){this.filepath=e;var t=this;return this.loadDefer=ResourceLoader.loadAudio(e,!0,this.audio),this.loadDefer.done(function(e){t.setVolume(t.volume),$(e).off(),$(e).on("ended",function(){t.loop?(e.currentTime=0,t.play()):(t.isPlaying=!1,$(t).trigger("ended"))})}),this.loadDefer},Sound.prototype.play=function(e){return browser.supportsMultipleAudio||this==o2.prioritySound?(this.stopFade(),e&&this.setFile(e),this.isPlaying=!0,this.loadDefer?this.loadDefer=this.loadDefer.then(function(e){return $.when(e.play()).then(function(t){return e})}):void o2.warn("サウンドファイルが指定されていない状態で再生を行おうとしました")):void o2.warn("再生しようとしていますが、config.AudioChannelとは違いますのでしなかった")},Sound.prototype.pause=function(){if(this.isPlaying=!1,this.loadDefer)return this.loadDefer=this.loadDefer.then(function(e){return $.when(e.pause()).then(function(t){return e})})},Sound.prototype.stop=function(){var e=this;if(this.isPlaying=!1,this.loadDefer)return this.pause().then(function(t){return $(e).trigger("ended"),e.setTime(0)})},Sound.prototype.setTime=function(e){return this.loadDefer.then(function(t){try{t.currentTime=e/1e3}catch(r){$(t).one("loadedmetadata",function(){t.currentTime=e/1e3})}return t})},Sound.prototype.setVolume=function(e){if(e<0||e>1)return void o2.error("ボリュームの指定が不正です");if(this.volume=e,this.loadDefer){var t=this;this.loadDefer.done(function(e){e.volume=t.volume*t.volumePercentage})}},Sound.prototype.setLoop=function(e){this.loop=e},Sound.prototype.setPan=function(e){this.pan=e},Sound.prototype.fade=function(e){var t=this;{if(e){if(this.fadeStatus){this.fadeStatus.stopAfterFade&&(this.fadeStatus.stopAfterFade=!1);var r=this.fadeStatus.defer.then(function(){return t.fade(e)});return this.stopFade(!1),r}if("fromVolume"in e||(e.fromVolume=this.volume),"toVolume"in e||(e.toVolume=this.volume),!this.loadDefer)return void o2.log("サウンドファイルを指定されていない状態でフェード処理を行おうとしました");var n=this.fadeStatus=new SoundFade(this,e),i=this;return this.fadeStatus.defer.done(function(){delete i.fadeStatus}),this.loadDefer.done(function(){i.fadeStatus===n&&i.fadeStatus.start()}),this.fadeStatus.defer}if(this.fadeStatus)return this.fadeStatus.defer}},Sound.prototype.stopFade=function(e){if(this.fadeStatus)return this.fadeStatus.stop(e)},Sound.prototype.dummyLoad=function(){this.audio.src="x",this.audio.load()};var SoundFade=function(e,t){this.sound=e,this.fromVolume=1,this.toVolume=0,this.duration=1e3,this.finalVolume=void 0,this.stopAfterFade=!1,t&&$.extend(this,t),this.intervalId,this.defer=$.Deferred()};SoundFade.prototype.initializer="SoundFade",SoundFade.prototype.start=function(){function e(){var e=(Date.now()-t)/this.duration;e>1&&(e=1);var r=this.fromVolume+(this.toVolume-this.fromVolume)*e;this.sound.setVolume(r),e>=1&&this.stop()}var t=Date.now();this.intervalId=setInterval(e.bind(this),1e3/60),e.call(this)},SoundFade.prototype.stop=function(e){var t=this;void 0===e&&(e=!0),clearInterval(this.intervalId),e&&(void 0!==this.finalVolume?this.sound.setVolume(this.finalVolume):this.sound.setVolume(this.toVolume)),this.stopAfterFade?this.sound.stop().then(function(){t.defer.resolve()}):this.defer.resolve()},SoundFade.prototype.toJSON=function(){return{fromVolume:this.fromVolume,toVolume:this.toVolume,duration:this.duration,finalVolume:this.finalVolume,stopAfterFade:this.stopAfterFade}};var WebAudioSound=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));e.audio=null,e.source,e.playStartTime=null,e.pausedAtTime=null;var r=t.getAudioContext();return e.gain=r.createGain(),e.gain.connect(r.destination),e}return _inherits(t,e),_createClass(t,null,[{key:"getAudioContext",value:function(){var e=window.AudioContext||window.webkitAudioContext;if(!e)return null;var r=new e;return t.getAudioContext=function(){return r},r}}]),_createClass(t,[{key:"objectToBeSerialized",value:function(e){switch(e){case"source":case"playStartTime":case"pausedAtTime":case"gain":return}return _get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"objectToBeSerialized",this).call(this,e)}},{key:"setFile",value:function(e){return this.filepath=e,this.source=null,this.loadDefer=ResourceLoader.loadAudioBuffer(e,t.getAudioContext(),!0),this.loadDefer}},{key:"play",value:function(e){var r=this;return this.stopFade(),e&&this.setFile(e),this.isPlaying=!0,this.loadDefer?(this.loadDefer.done(function(e){var n=t.getAudioContext();r.source=n.createBufferSource(),r.source.buffer=e,r.source.connect(r.gain),null!==r.pausedAtTime?(r.source.start(n.currentTime,r.pausedAtTime/1e3),r.playStartTime=Date.now()-r.pausedAtTime):(r.source.start(n.currentTime),r.playStartTime=Date.now()),r.pausedAtTime=null,$(r.source).on("ended",function(){r.isPlaying=!1,$(r).trigger("ended")})}),this.loadDefer):void o2.warn("サウンドファイルが指定されていない状態で再生を行おうとしました")}},{key:"pause",value:function(){var e=this.playStartTime;this.stop(),this.pausedAtTime=Date.now()-e}},{key:"stop",value:function(){var e=this;this.isPlaying=!1,this.pausedAtTime=null,this.playStartTime=null,this.loadDefer&&this.loadDefer.done(function(t){e.source&&(e.source.stop(),e.source.disconnect(),$(e.source).trigger("ended"),e.source=null)})}},{key:"setTime",value:function(e){this.stop(),this.pausedAtTime=e,this.play()}},{key:"setVolume",value:function(e){this.volume=e,this.gain.gain.value=this.volume*this.volumePercentage}},{key:"setLoop",value:function(e){var t=this;this.loop=e,this.loadDefer.then(function(r){t.source.loop=e})}},{key:"dummyLoad",value:function(){var e=t.getAudioContext(),r=e.createBuffer(1,1,22050),n=e.createBufferSource();n.buffer=r,n.connect(e.destination),n.start()}},{key:"initializer",get:function(){return"WebAudioSound"}}]),t}(Sound),Tag,TagAction;Tag=function(e,t,r){this.file,this.tagName=e,this.args=t||{},r&&(this.callbackArgs=r),this.scopeVars,this.lineNumber,this.originalLineNumber,this.originalCharNumber,this.conductor},Tag.prototype.getAction=function(e){return this.conductor&&"function"==typeof this.conductor.getTagAction?this.conductor.getTagAction(e):Tag.actions[e]},Tag.prototype.isOpen=function(){return void 0!=this.callbackArgs},Tag.prototype.isClose=function(){return"/"===this.tagName},Tag.prototype.getOpenTag=function(){if(this.isClose()&&this.file){if(this.openTag)return this.openTag;var e=function(){for(var e=1,t=this.lineNumber-1;t>0;t--){var r=this.file.lines[t];if(r.isClose()?e++:r.isOpen()&&e--,0==e)return r.closeTag=this,this.openTag=r,r}}.call(this),t=this.conductor.stack[this.conductor.stack.length-1];if(e&&t&&e.isPrototypeOf(t))return t;throw"something wrong in stack"}},Tag.prototype.getCloseTag=function(){if(this.isOpen()&&this.file)for(var e=1,t=this.lineNumber+1;t<this.file.lines.length;t++){var r=this.file.lines[t];if(r.isOpen()?e++:r.isClose()&&e--,0==e)return r.openTag=this,this.getCloseTag=function(){return r},r}},Tag.prototype.getCallbackFile=function(){var e=this.getCloseTag();if(e){var t=new PartialFile(this.file,this.lineNumber+1,e.lineNumber-1);return this.getCallbackFile=function(){return t},t}},Tag.prototype.makeScopeVars=function(e){if(e instanceof Array){for(var t={},r=0;r<this.callbackArgs.length;r++)t[this.callbackArgs[r]]=e[r];return t}},Tag.prototype.setScopeVars=function(e){if(this.isOpen()){var t=this.conductor.callbackVarsStack.indexOf(this.scopeVars);e instanceof Array?this.scopeVars=this.makeScopeVars(e):this.scopeVars=e,t==-1?this.conductor.callbackVarsStack.push(this.scopeVars):this.conductor.callbackVarsStack[t]=this.scopeVars}},Tag.prototype.keepStack=function(){throw"keepStackはclose tagのみ使える"},Tag.prototype.flattenCurrentScope=function(e){if(!this.conductor)return{};var t={};return this.conductor.callbackVarsStack.forEach(function(r){for(var n in r)e&&!e(n,r[n])||(t[n]=r[n])}),t},Tag.prototype.exitScope=function(){if(this.isOpen()){var e=this.getAction(this.tagName);if(e){var t=e.exitScope;"function"==typeof exitScope&&t.call(this)}}},Tag.prototype.jumpToTag=function(e,t){for(var r=this.conductor.stack.length-1;r>=0;r--){var n=this.conductor.stack[r];if(n===e||e.isPrototypeOf(n)||n.getCloseTag()===e&&!t)break;var i=n.getCallbackFile().lines.some(function(t){return t===e||e.isPrototypeOf(t)||t.isPrototypeOf(e)});if(i)break;n.exitScope(),this.conductor.stack.pop(),n.scopeVars&&this.conductor.callbackVarsStack.pop()}this.conductor.setTag(e,t)},Tag.prototype.run=function(){var e=this.tagName,t=this.getAction(e);if(this.isClose()){var r=this.conductor.stack[this.conductor.stack.length-1];if(!r)return void this.error("open tagが見つかりません");if(e=r.tagName,t=this.getAction(e),!t)return;var n=t.closeAction,i=0,o=!0;if("function"==typeof n){var a=Object.create(this);a.keepStack=function(){o=!1},i=n.call(a,r)}return o&&(this.exitScope(),this.conductor.stack.pop(),r.scopeVars&&this.conductor.callbackVarsStack.pop()),i}if(t){var s=this.argsForAction(),c=Object.create(this);if(c.conductor=this.conductor,this.isOpen()){c.conductor.stack.push(c);var u=this.getCloseTag();this.conductor.setTag(u)}var l=t.action.call(c,s);return l}this.warn("タグハンドラが見つかりません"),this.isOpen()&&this.conductor.setTag(this.getCloseTag(),!0)},Tag.prototype.preload=function(){var e=this.getAction(this.tagName);if(e&&"function"==typeof e.preload){var t=this.validate(this.args);return e.preload.call(this,t)}},Tag.prototype.normalizedArgs=function(e){e=clone(e?e:this.args);for(var t in e){var r=e[t],n=this.getAction(this.tagName);if(n){var i=n.rules;i&&(t in i||"o2_cond"==t||"*"==t||this.warn(t+"という未知の属性があります"))}if("*"!==t){if(e.hasOwnProperty(t)&&"string"==typeof r){switch(r.charAt(0)){case"&":r=r.substring(1),r=r.indexOf("$")!=-1?this.eval(r):(0,eval)(r);break;case"%":r=r.substring(1);var o=r.split("|"),a=this.conductor.macroStack[this.conductor.macroStack.length-1];r=void 0!==a.args[o[0]]?a.args[o[0]]:o[1];break;case"$":var s=/[\-\+\/\\\*()"'\s|&{:}!=><\[\]\;\?]/.test(r);if(s)r=this.eval(r);else{r=r.substring(1);for(var c=r.split("."),u=c[0],l=this.conductor.callbackVarsStack.length-1;l>=0;l--){var h=this.conductor.callbackVarsStack[l];if(u in h){r=h[u],c.shift();break}}l<0?r=void 0:c.forEach(function(e){e in r&&(r=r[e])})}}e[t]=r}}else for(var f in window.mp)window.mp.hasOwnProperty(f)&&(e[f]=window.mp[f])}return e},Tag.prototype.argsForAction=function(){return this.validate(this.normalizedArgs(this.args))},Tag.prototype.validate=function(e){e=e?clone(e):{};var t=this.getAction(this.tagName);if(!t)return e;var r=t.rules;if(!r)return e;if("function"==typeof r)return r(e);for(var n in r){var i=!!r[n].required,o=e[n],a=r[n];if(i&&void 0===o&&this.error("必須の属性 "+n+" が指定されていません"),void 0===o&&"defaultValue"in a&&(o="function"==typeof a.defaultValue?a.defaultValue():a.defaultValue),a.type&&void 0!==o){if("allowString"in a&&"string"==typeof o)for(var s=!1,c=a.allowString.length-1;c>=0;c--){var u=a.allowString[c];if(u===o){s=!0;break}}if(!s)if(a.type in Tag.validators)try{o=Tag.validators[a.type](o)}catch(l){console.trace&&console.trace(),this.error(n+"は"+l)}else a.type instanceof RegExp&&("string"!=typeof o&&(o=String(o)),a.type.test(o)||this.error("属性 "+n+" の値は "+a.type.toString()+" 型でなければなりません"))}void 0!==o&&(e[n]=o)}return e},Tag.validators={STRING:function(e){return String(e)},BOOLEAN:function(e){if("boolean"==typeof e)return e;if("string"==typeof e){if("true"===e||"1"===e)return!0;if("false"===e||"0"===e)return!1}else if("number"==typeof e){if(0===e)return!1;if(1===e)return!0}throw"boolean型ではありません"},INT:function(e){if(isNaN(parseFloat(e))||!isFinite(e))throw"int型ではありません";return parseInt(e)},FLOAT:function(e){if(isNaN(parseFloat(e))||!isFinite(e))throw"float型ではありません";return parseFloat(e)},LAYER:function(e){if("base"===e)return{fore:o2.foreLayers.baseLayer,back:o2.backLayers.baseLayer};if("object"===("undefined"==typeof e?"undefined":_typeof(e))&&e.fore instanceof Layer&&e.back instanceof Layer)return e;try{return this.MESSAGE_LAYER(e)}catch(t){}try{return this.IMAGE_LAYER(e)}catch(t){}throw"指定されたレイヤが見つかりません"},IMAGE_LAYER:function(e){if("base"===e)return{fore:o2.foreLayers.baseLayer,back:o2.backLayers.baseLayer};if("object"===("undefined"==typeof e?"undefined":_typeof(e))&&e.fore instanceof ImageLayer&&e.back instanceof ImageLayer)return e;var t=Number(e);if(isNaN(t))throw"number型ではありません";if(!(t in o2.foreLayers.imageLayers))throw"イメージレイヤ "+t+" は存在しません";return{fore:o2.foreLayers.imageLayers[t],back:o2.backLayers.imageLayers[t]}},MESSAGE_LAYER:function(e){var t;if(e.toString().match(/^message$/i))return o2.currentMessageLayer;if(t=e.toString().match(/^message(\d+)$/i)){var r=Number(t[1]);if(o2.foreLayers.messageLayers[r])return{fore:o2.foreLayers.messageLayers[r],back:o2.backLayers.messageLayers[r]}}else if("object"===("undefined"==typeof e?"undefined":_typeof(e))&&e.fore instanceof MessageLayer&&e.back instanceof MessageLayer)return e;throw"メッセージレイヤ "+e+" は存在しません"},COLOR:function(e){var t=/0x([0-9a-fA-F]{6})/.exec(e);if(null==t)throw"color型ではありません";return"#"+t[1]},TIME:function(e){if("number"==typeof e)return e;if("-1"==e.indexOf(":")){var t=parseFloat(e);if(isNaN(t))throw"time型ではありません";return t}var r=e.split(":"),n=0,i=0,o=0,a=0;if(4==r.length)n=parseFloat(r[0]),i=parseFloat(r[1]),o=parseFloat(r[2]),a=r[3];else if(3==r.length)i=parseFloat(r[0]),o=parseFloat(r[1]),a=parseFloat(r[2]);else if(2==r.length)i=parseFloat(r[0]),o=parseFloat(r[1]);else{if(1!=r.length)throw"time型ではありません";a=parseFloat(e)/10}if(isNaN(n)||isNaN(i)||isNaN(o)||isNaN(a))throw"time型ではありません";return 60*n*60*1e3+60*i*1e3+1e3*o+10*a},OBJECT:function(e){if(null==e||"object"!==("undefined"==typeof e?"undefined":_typeof(e)))throw"object型ではありません";return e},FUNCTION:function(e){if("function"!=typeof e)throw"functionではありません";return e}},Tag.prototype.eval=function(e){var t=this.flattenCurrentScope();for(var r in t)e=e.replace("$"+r,"Tag.tempScopeObj."+r);return Tag.tempScopeObj=t,e=(0,eval)(e),delete Tag.tempScopeObj,e},Tag.actions={},Tag.prototype.done=function(e){return e?void this.conductor.wait(this,e):void(this.conductor&&this.conductor.trigger(this))},Tag.prototype.error=function(e,t){var r="エラー: ";if(t&&(r="警告: "),this.file&&(r+="ファイル: "+this.file.filename+" / "),void 0!==this.originalLineNumber?r+="行: "+this.originalLineNumber+" / ":void 0!==this.lineNumber&&(r+="行: "+this.lineNumber+" / "),r+="タグ: "+this.tagName+" ",r+=e,!t)throw o2.error(r,this),"";o2.warn(r,this)},Tag.prototype.warn=function(e){this.error(e,!0)},Tag.prototype.clone=function(){return this},Tag.prototype.toJSON=function(){return config.saveMode==o2.SAVE_MODE_KAG3?{file:this.file.toRestorable(),label:this.args.name,initializer:"Tag"}:this.toRestorable()},Tag.prototype.toRestorable=function(){var e={initializer:"Tag"};return this.file&&(e.file=this.file.toRestorable()),void 0!==this.lineNumber&&(e.line=this.lineNumber),e.file||(e.tagName=this.tagName,e.args=this.args),void 0!==this.originalLineNumber&&(e.originalLineNumber=this.originalLineNumber),this.callbackArgs&&(e.callbackArgs=this.callbackArgs),e},Tag.restore=function(e){return"file"in e&&"line"in e?$.when(e.file.restore()).then(function(t){return t.lines[e.line]}):"file"in e&&"label"in e?$.when(e.file.restore()).then(function(t){return t.getLabelTag(e.label)}):"tagName"in e?new Tag(e.tagName,e.args,e.callbackArgs):(o2.error("タグを復元できない",e),{})},TagAction=function(e){this.action=function(){};for(var t in e)this[t]=e[t]};var DynamicMacroDefinition=function(e){function t(e,r){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,{name:e}));return n.makeTags=r,n.lastArgs={},n}return _inherits(t,e),_createClass(t,[{key:"macroCreated",value:function(e){this.lastArgs=e.args}},{key:"startTag",get:function(){var e=this.makeTags(this.lastArgs);this.lastArgs={};var r=new t.File(this.name,e);return r.lines[0].toRestorable()},set:function(e){}}]),t}(MacroDefinition);DynamicMacroDefinition.prototype.initializer="DynamicMacroDefinition",DynamicMacroDefinition.File=function(e){function t(e,r){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"Dynamic["+e+"]",!0));return n.macroName=e,r.forEach(function(e){return n.lines.push(e)}),n.lines.push(new Tag("endmacro")),n}return _inherits(t,e),_createClass(t,[{key:"toRestorable",value:function(){var e=this;return{tags:this.lines.map(function(t){t.file=void 0;var r=t.toRestorable();return t.file=e,r}),macroName:this.macroName,initializer:"DynamicMacroDefinition.File"}}}],[{key:"restore",value:function(e){return $.when(e.tags.map(function(e){return e.restore()})).then(function(t){return new DynamicMacroDefinition.File(e.macroName,t)})}}]),t}(KAGFile);var GestureRecognizer=function o(e){for(var t in e)this[t]=e[t];this.state=o.STATE.POSSIBLE,this.mutualExclusive=!0};GestureRecognizer.STATE={NONE:0,POSSIBLE:1,SATISIFIED:2,CANCELLED:3},GestureRecognizer.prototype.start=function(){},GestureRecognizer.prototype.move=function(){},GestureRecognizer.prototype.end=function(){},GestureRecognizer.prototype.cancel=function(){},GestureRecognizer.prototype.satisified=function(){this.manager&&this.manager.satisified(this)},GestureRecognizer.prototype.failed=function(){this.manager&&this.manager.failed(this)},GestureRecognizer.prototype.shouldCancelOtherRecognizer=function(e){return this.mutualExclusive},GestureRecognizer.prototype.shouldBeCancelled=function(e){return!0},GestureRecognizer.accumulateRecognizer=function(e,t,r,n,i){function o(i,o){var s=i.x-a.startLocation.x,c=i.y-a.startLocation.y;if(o){var u=function(e){return e>=0&&e<=1};if((u(s/e)||u(s/t))&&(u(c/r)||u(c/n)))return!0}return(void 0==r||c>r)&&(void 0==n||c<n)&&(void 0==e||s>e)&&(void 0==t||s<t)}var a=new GestureRecognizer({startLocation:void 0,start:function(e){var t=e.originalEvent.normalizedCoordinate();a.startLocation=t,a.state=GestureRecognizer.STATE.POSSIBLE},move:function(e){if(a.startLocation){var t=e.originalEvent.normalizedCoordinate();o(t,!0)?o(t)&&(a.satisified(),i(),a.startLocation=void 0):a.cancel()}},end:function(e){if(a.startLocation){var t=e.originalEvent.normalizedCoordinate();o(t)?(a.satisified(),i()):a.cancel()}},cancel:function(){a.startLocation=void 0,a.failed()}});return a},GestureRecognizer.basicRecognizer=function(e,t){var r=new GestureRecognizer({startLocation:void 0,start:function(n){r.startLocation=n.originalEvent.normalizedCoordinate(),"absolute"==e?t("start",r.startLocation.x,r.startLocation.y):"delta"==e&&t("start",0,0),r.state=GestureRecognizer.STATE.POSSIBLE},move:function(n){if(r.startLocation){var i=n.originalEvent.normalizedCoordinate(),o=i.x-r.startLocation.x,a=i.y-r.startLocation.y;"absolute"==e?t("move",i.x,i.y):"delta"==e&&t("move",o,a)}},end:function(n){if(r.startLocation){var i=n.originalEvent.normalizedCoordinate(),o=i.x-r.startLocation.x,a=i.y-r.startLocation.y;"absolute"==e?t("end",i.x,i.y):"delta"==e&&t("end",o,a),r.satisified(),r.startLocation=void 0}},cancel:function(){r.startLocation=void 0,r.failed()}});return r},GestureRecognizer.longTapRecognizer=function(e,t,r){var n=new GestureRecognizer({startDate:void 0,startLocation:void 0,timer:void 0,
start:function(t){n.startDate=Date.now(),n.startLocation=t.originalEvent.normalizedCoordinate(),n.state=GestureRecognizer.STATE.POSSIBLE,clearTimeout(n.timer),n.timer=setTimeout(function(){n.startDate=void 0,n.startLocation=void 0,n.timer=void 0,n.satisified(),r()},e)},move:function(e){if(n.startLocation){var r=e.originalEvent.normalizedCoordinate(),i=r.x-n.startLocation.x,o=r.y-n.startLocation.y;(i>t||o>t)&&n.cancel()}},end:function(e){n.cancel()},cancel:function(){n.startDate=void 0,n.startLocation=void 0,clearTimeout(n.timer),n.timer=void 0,n.failed()}});return n};var GestureManager={isProcessingEvent:!1,recognizers:[],addRecognizer:function(e){e.manager=this,this.recognizers.push(e)},removeRecognizer:function(e){var t=this.recognizers.indexOf(e);t!=-1&&this.recognizers.splice(t,1)},satisified:function(e){e.state=GestureRecognizer.STATE.SATISIFIED;for(var t=0;t<this.recognizers.length;t++){var r=this.recognizers[t];r!=e&&e.shouldCancelOtherRecognizer(r)&&r.shouldBeCancelled(e)&&r.cancel()}},failed:function(e){e.state=GestureRecognizer.STATE.CANCELLED},resetIfPossible:function(){var e=this.recognizers.filter(function(e){return e.state==GestureRecognizer.STATE.POSSIBLE});if(!e.length)for(var t=0;t<this.recognizers.length;t++){var r=this.recognizers[t];r.state=GestureRecognizer.STATE.NONE}},eventHandlers:{start:function(e){GestureManager.isProcessingEvent=!0;for(var t=GestureManager.recognizers.length-1;t>=0;t--){var r=GestureManager.recognizers[t];r.state!=GestureRecognizer.STATE.CANCELLED&&r.start(e)}GestureManager.isProcessingEvent=!1},move:function(e){GestureManager.isProcessingEvent=!0;for(var t=GestureManager.recognizers.length-1;t>=0;t--){var r=GestureManager.recognizers[t];r.state!=GestureRecognizer.STATE.CANCELLED&&r.move(e)}GestureManager.isProcessingEvent=!1},end:function(e){GestureManager.isProcessingEvent=!0;for(var t=GestureManager.recognizers.length-1;t>=0;t--){var r=GestureManager.recognizers[t];r.state!=GestureRecognizer.STATE.CANCELLED&&r.end(e)}GestureManager.isProcessingEvent=!1,GestureManager.resetIfPossible()},cancel:function(e){GestureManager.isProcessingEvent=!0;for(var t=GestureManager.recognizers.length-1;t>=0;t--){var r=GestureManager.recognizers[t];r.cancel(e)}GestureManager.isProcessingEvent=!1,GestureManager.resetIfPossible()}}},HistoryRecord=function(){};HistoryRecord.prototype.toDrawable=function(e,t){return null},HistoryRecord.String=function(e){HistoryRecord.call(this),this.text=e},HistoryRecord.String.prototype=Object.create(HistoryRecord.prototype),HistoryRecord.String.prototype.initializer="HistoryRecord.String",HistoryRecord.String.prototype.toDrawable=function(e){return this.text.split("").map(function(t){var r=new TextProperties(t);return $.extend(r.styles,e.layer.font),r})};var HistoryCell=function(){this.records=[],this.controller=void 0,this.sizeCache=void 0};HistoryCell.prototype={initializer:"HistoryCell",records:[],objectToBeSerialized:function(e){switch(e){case"initializer":case"records":return this[e]}}},HistoryCell.PageBreakPrototype=function(){},HistoryCell.PageBreakPrototype.prototype=Object.create(HistoryCell.prototype),HistoryCell.PageBreakPrototype.prototype.toJSON=function(){return{initializer:"HistoryCell.PageBreakPrototype"}},HistoryCell.PageBreakPrototype.restore=function(){return HistoryCell.PageBreak},HistoryCell.PageBreak=new HistoryCell.PageBreakPrototype;var HistoryCellController=function(e,t){DrawableCanvas.call(this),this.cell=e,this.layer=t,this.needPrepare=!0,this.drawables=[],this.needRedrawChildren=!1,this.prepareDrawables(),this.drawChildren()};HistoryCellController.prototype=Object.create(DrawableCanvas.prototype),HistoryCellController.prototype.prepareDrawables=function(){this.needPrepare=!1;for(var e=[],t=0,r=this.cell.records.length;t<r;t++){var n=this.cell.records[t].toDrawable(this,e);n instanceof Drawable?e.push(n):n instanceof Array&&e.push.apply(e,n)}this.drawables=e;var i=e.filter(function(e){return e instanceof TextProperties}),o=new MessageLayer.textCustomizers.baseTextCustomizer(this.layer,[],i);o.timePassed=1/0,o.perform();for(var a=i.length-1;a>=0;a--){var s=i[a];this.layer.vertical?(s.rect.x+=this.layer.margin.right,s.rect.y-=this.layer.margin.top):(s.rect.x-=this.layer.margin.left,s.rect.y-=this.layer.margin.top)}if(this.layer.vertical)for(var c=i.reduce(function(e,t){return Math.min(t.rect.x,e)},1/0),u=0;u<i.length;u++)i[u].rect.x-=c;for(var l=0;l<e.length;l++){var h=e[l];h instanceof Link&&h.refreshRects()}this.cell.sizeCache={width:e.reduce(function(e,t){var r=t.frame();return Math.max(r.x+r.width,e)},0),height:e.reduce(function(e,t){var r=t.frame();return Math.max(r.y+r.height,e)},0)}},HistoryCellController.prototype.mousemove=function(e){var t=!1;if(this.rect.coverCoordinate(e.x,e.y))for(var r=e.x-this.rect.x,n=e.y-this.rect.y,i=0;i<this.drawables.length;i++){var o=this.drawables[i];if(o instanceof Link)o.isHovering(r,n)?(t=!0,o.hovering||(o.hovering=!0,this.needRedrawChildren=!0,this.layer.redrawRect(this.rect))):o.hovering&&(o.hovering=!1,this.needRedrawChildren=!0,this.layer.redrawRect(this.rect));else if(o instanceof Button){var a=o.rect.coverCoordinate(r,n);a&&o.state==Button.STATE_NORMAL?(o.enter(r,n,this),this.needRedrawChildren=!0,this.layer.redrawRect(this.rect)):a||o.state!=Button.STATE_HOVER||(o.leave(r,n,this),this.needRedrawChildren=!0,this.layer.redrawRect(this.rect))}}else for(var s=0;s<this.drawables.length;s++){var c=this.drawables[s];c instanceof Link&&c.hovering?(c.hovering=!1,this.needRedrawChildren=!0,this.layer.redrawRect(this.rect)):c instanceof Button&&c.state==Button.STATE_HOVER&&(c.leave(r,n,this),this.needRedrawChildren=!0,this.layer.redrawRect(this.rect))}return t},HistoryCellController.prototype.mouseup=function(e){var t=!1;if(this.rect.coverCoordinate(e.x,e.y))for(var r=e.x-this.rect.x,n=e.y-this.rect.y,i=0;i<this.drawables.length;i++){var o=this.drawables[i];o instanceof Link?o.isHovering(r,n)&&(t=!0,o.click()):o instanceof Button&&o.rect.coverCoordinate(r,n)&&(t=!0,o.state=Button.STATE_HOVER,o.click())}return t},HistoryCellController.prototype.drawChildren=function(){this.rect.width=this.cell.sizeCache.width,this.rect.height=this.cell.sizeCache.height,this.setRect(),this.ctx.clearRect(0,0,this.rect.width,this.rect.height),this.ctx.textBaseline="top";for(var e=0;e<this.drawables.length;e++){var t=this.drawables[e];t.drawOnContext(this.ctx)}},HistoryCellController.prototype.drawOnContext=function(e){this.needRedrawChildren&&this.drawChildren(),e.save(),this.drawables.length&&DrawableCanvas.prototype.drawOnContext.apply(this,arguments),e.restore()};var HistoryRecorder=function(e){this.options={enabled:!0,output:!0,repage:config.historyLayerEverypage},this.layer,this.cells=[],this.currentPage=0,this.pageCount=0,this.lineCount=0};HistoryRecorder.prototype.objectToBeSerialized=function(e){switch(e){case"layer":return}if(config.historyLayerStoreState||"cells"!==e&&"pageCount"!==e&&"lineCount"!==e)return this[e]},HistoryRecorder.prototype.importFromSaveData=function(e){this.clearAllRecords(),Object.prototype.importFromSaveData.call(this,e)},HistoryRecorder.prototype.add=function(e){if(this.options.output){if(!(e instanceof HistoryRecord))throw"history recordじゃないです";this.cells.length&&this.cells[this.cells.length-1]!==HistoryCell.PageBreak||this.addCell();var t=this.cells.length-1;this.cells[t].records.push(e),this.lineCount++,this.ensureHistoryLimit()}},HistoryRecorder.prototype.addCell=function(e){if(this.options.output){var t=this.cells.length-1;if(this.cells.length&&!this.cells[t].records.length&&this.cells[t]!=HistoryCell.PageBreak){if(!e)return;this.cells[t].records.push(new HistoryRecord.String(" "))}this.cells.push(new HistoryCell)}},HistoryRecorder.prototype.addPage=function(){if(this.options.output){var e=this.cells.length-1;this.cells[e]&&this.cells[e]!==HistoryCell.PageBreak&&(this.cells[e].records.length?this.cells.push(HistoryCell.PageBreak):(this.cells[e]=HistoryCell.PageBreak,this.addCell()),this.pageCount++,this.ensureHistoryLimit())}},HistoryRecorder.prototype.ensureHistoryLimit=function(){var e=config.historyLayerMaxPages||100,t=config.historyLayerMaxLines||1e3;if(this.pageCount>e){var r=this.cells.indexOf(HistoryCell.PageBreak);this.cells.splice(0,r+1)}if(this.lineCount>t){var n=this.cells.shift();return this.lineCount-=n.records.length,this.cells[0]===HistoryCell.PageBreak&&this.cells.shift(),n}},HistoryRecorder.prototype.clearAllRecords=function(){this.cells=[],this.pageCount=0,this.lineCount=0,this.currentPage=0};var HistoryLayer=function(){var e=this;MessageLayer.call(this),this.frameSolid.opacity=.5,this.visible=!1,this.font.shadow=!1,this.font.edge=!1,this.font.size=36,this.recorder=new HistoryRecorder(this),this.contentOffset={x:0,y:0},this.visibleCellController=[],this.backgroundStay=config.historyLayerFrameFixed,this.animating=!1,this.animationOffset={x:0,y:0},this.animationContentOpacity=1,this.defaultFont.size=config.historyLayerFontHeight,this.defaultFont.face=config.historyLayerFontFace,this.defaultFont.color=config.historyLayerFontColor,this.defaultFont.shadow=config.historyLayerShadow,this.defaultFont.shadowColor=config.historyLayerShadowColor,this.defaultFont.shadowBlur=config.historyLayerShadowBlur,this.defaultFont.shadowOffsetX=config.historyLayerShadowOffsetX,this.defaultFont.shadowOffsetY=config.historyLayerShadowOffsetY,this.defaultFont.bold=config.historyLayerFontBold,this.defaultFont.edge=config.historyLayerEdge,this.defaultFont.edgeColor=config.historyLayerEdgeColor,this.font=clone(this.defaultFont),this.style.lineSize=config.historyLayerLineHeight,this.style.lineSpacing=0,this.frameSolid.color=config.historyLayerColor,this.frameSolid.opacity=config.historyLayerOpacity,config.historyLayerFrame&&ResourceLoader.loadImage(config.historyLayerFrame,!1).done(function(t){return e.frameImage=new DrawableImage(t,0,0)}),this.margin={top:config.historyLayerMarginT,right:config.historyLayerMarginR,bottom:config.historyLayerMarginB,left:config.historyLayerMarginL},setTimeout(function(){return e.setRect({x:config.historyLayerCurrentPositionX,y:config.historyLayerCurrentPositionY,width:config.historyLayerCurrentWidth,height:config.historyLayerCurrentHeight})}),this.resetCursor(),this.originalGlyphShown=!1};HistoryLayer.prototype=Object.create(MessageLayer.prototype),HistoryLayer.prototype.objectToBeSerialized=function(e){switch(e){case"animating":case"textsProperties":case"buttons":case"links":case"images":case"visibleCellController":return;case"recorder":case"contentOffset":return this[e];case"visible":return!1}return MessageLayer.prototype.objectToBeSerialized.call(this,e)},HistoryLayer.prototype.importFromSaveData=function(e){return Layer.prototype.importFromSaveData.call(this,e)},HistoryLayer.prototype.drawOnContext=function(){Layer.prototype.drawOnContext.apply(this,arguments)},HistoryLayer.prototype.reloadVertical=function(){"auto"==config.historyLayerVertical?this.vertical=o2.currentMessageLayer.vertical:"true"==config.historyLayerVertical||1==config.historyLayerVertical?this.vertical=!0:this.vertical=!1,this.resetCursor()},HistoryLayer.prototype.mousemove=function(e){if(!this.visible)return!1;for(var t=!1,r=e.originalEvent.normalizedCoordinate(this),n=0;n<this.visibleCellController.length;n++){var i=this.visibleCellController[n],o=i.mousemove(r);o&&(t=!0)}return t||(t=MessageLayer.prototype.mousemove.apply(this,arguments)),t},HistoryLayer.prototype.mouseup=function(e){if(!this.visible)return!1;for(var t=!1,r=e.originalEvent.normalizedCoordinate(this),n=0;n<this.visibleCellController.length;n++){var i=this.visibleCellController[n],o=i.mouseup(r);o&&(t=!0)}return t||(t=MessageLayer.prototype.mouseup.apply(this,arguments)),t},HistoryLayer.prototype.touchmoved=function(e){this.vertical?this.scrolled({x:e.x,y:0}):this.scrolled({x:0,y:e.y})},HistoryLayer.prototype.scrolled=function(e){if(!this.animating){if(this.reloadVertical(),this.vertical){if(!this.visible&&e.x<0){var t=["p","l","s"].indexOf(currentConductor.currentTag.tagName)!=-1;if(!t)return;return void this.resetAndShow()}var r=this.visibleCellController[0],n=this.visibleCellController[this.visibleCellController.length-1],i=!0;if(!this.visibleCellController.length||r.rect.x+e.x>this.margin.left||r.rect.x+r.rect.width+e.x<this.margin.left||n.rect.x+n.rect.width+e.x<this.rect.width-this.margin.right||n.rect.x+e.x>this.rect.width-this.margin.right){if(this.visibleCellController.length){if(r.rect.x+e.x>this.margin.left&&e.x>0){var o=this.recorder.cells.indexOf(r.cell),a=this.recorder.cells[o+1];a&&(a.records.length||a==HistoryCell.PageBreak)||(i=!1,this.contentOffset.x=0,this.hide("right",!1)),a&&a===HistoryCell.PageBreak&&(i=!1,this.newerPage("right"))}if(r.rect.x+r.rect.width+e.x<this.margin.left,n.rect.x+n.rect.width+e.x<this.rect.width-this.margin.right&&e.x<0){var s=this.recorder.cells.indexOf(n.cell),c=this.recorder.cells[s-1];if(!c)return i=!1,this.contentOffset.x-=this.rect.width-this.margin.right-(n.rect.x+n.rect.width),void(this.visibleCellController=this.childrenAtContentOffset(this.contentOffset));c&&c===HistoryCell.PageBreak&&(i=!1,this.olderPage("left"))}n.rect.x-e.x>this.rect.width-this.margin.right}i&&(this.contentOffset.x-=e.x,this.visibleCellController=this.childrenAtContentOffset(this.contentOffset))}else this.contentOffset.x-=e.x,this.visibleCellController.forEach(function(t){t.rect.x+=e.x}),renderer.animator.requestFrame()}else{if(!this.visible&&e.y>0){var u=["p","l","s"].indexOf(currentConductor.currentTag.tagName)!=-1;if(!u)return;return void this.resetAndShow()}var l=this.visibleCellController[0],h=this.visibleCellController[this.visibleCellController.length-1],f=!0;if(!this.visibleCellController.length||l.rect.y+l.rect.height+e.y<this.rect.height-this.margin.bottom||l.rect.y+e.y>this.rect.height-this.margin.bottom||h.rect.y+e.y>this.margin.top||h.rect.y+h.rect.height+e.y<this.margin.top){if(this.visibleCellController.length){if(l.rect.y+l.rect.height+e.y<this.rect.height-this.margin.bottom&&e.y<0){var d=this.recorder.cells.indexOf(l.cell),p=this.recorder.cells[d+1];p&&(p.records.length||p==HistoryCell.PageBreak)||(f=!1,this.contentOffset.y=0,this.hide("up",!1)),p&&p===HistoryCell.PageBreak&&(f=!1,this.newerPage())}if(l.rect.y+e.y>this.rect.height-this.margin.bottom,h.rect.y+e.y>this.margin.top&&e.y>0){var g=this.recorder.cells.indexOf(h.cell),y=this.recorder.cells[g-1];if(!y)return f=!1,this.contentOffset.y+=this.margin.top-h.rect.y,void(this.visibleCellController=this.childrenAtContentOffset(this.contentOffset));y&&y===HistoryCell.PageBreak&&(f=!1,this.olderPage())}h.rect.y+h.rect.height+e.y<this.margin.top}f&&(this.contentOffset.y+=e.y,this.visibleCellController=this.childrenAtContentOffset(this.contentOffset))}else this.contentOffset.y+=e.y,this.visibleCellController.forEach(function(t){t.rect.y+=e.y}),renderer.animator.requestFrame()}this.redrawRect()}},HistoryLayer.prototype.scrollToPageEnd=function(){this.vertical?this.contentOffset.x=0:this.contentOffset.y=0,this.redrawRect()},HistoryLayer.prototype.show=function(e,t){o2.skipMode=o2.SKIP_MODE_NONE,o2.cancelAutoMode(),void 0===t&&(t=this.backgroundStay),this.reloadVertical();var r=$.Deferred();if(this.animating||!this.recorder.options.enabled||!this.recorder.cells.length)return r.reject(),r.promise();this.animating=!0,this.visible=!0;var n=this,i=Date.now(),o=config.historyLayerCurrentPositionX,a=config.historyLayerCurrentPositionY,s=500,c=0,u=300;switch(e){case"left":c=300,u=0;break;case"right":c=-300,u=0;break;case"down":u=-300,c=0}t?this.animationContentOpacity=0:this.opacity=0;var l=new KeySpline(.08,.44,.42,.93);return renderer.animator.requestFrame(function h(){var e=(Date.now()-i)/s;e>=1?(e=1,n.animating=!1,r.resolve()):renderer.animator.requestFrame(h),e=l.get(e),t?(n.animationContentOpacity=e,n.animationOffset.x=c*(1-e),n.animationOffset.y=u*(1-e),n.redrawRect()):(n.opacity=e,n.rect.x=o+c*(1-e),n.rect.y=a+u*(1-e))}),this.redrawRect(),r.promise()},HistoryLayer.prototype.resetAndShow=function(){return this.scrollToPageEnd(),this.vertical?(this.contentOffset.x=0,this.visibleCellController=this.childrenAtContentOffset(this.contentOffset),this.show("left",!1)):(this.contentOffset.y=0,this.visibleCellController=this.childrenAtContentOffset(this.contentOffset),this.show("down",!1))},HistoryLayer.prototype.hide=function(e,t){void 0===t&&(t=this.backgroundStay),this.animating=!0;var r=this,n=Date.now(),i=this.rect.x,o=this.rect.y,a=500,s=this.vertical?300:0,c=this.vertical?0:-300;switch(e){case"left":s=-300,c=0;break;case"right":s=300,c=0;break;case"down":c=300,s=0}var u=$.Deferred(),l=new KeySpline(.45,0,.97,.65);return renderer.animator.requestFrame(function h(){var e=(Date.now()-n)/a;return e>=1?(e=1,r.animating=!1,r.visible=!1,r.textsProperties=[],t?(r.animationContentOpacity=1,r.animationOffset.x=0,r.animationOffset.y=0,r.redrawRect()):(r.rect.x=i,r.rect.y=o,r.opacity=0),void u.resolve()):(renderer.animator.requestFrame(h),e=l.get(e),void(t?(r.animationContentOpacity=1-e,r.animationOffset.x=s*e,r.animationOffset.y=c*e,r.redrawRect()):(r.opacity=1-e,r.rect.x=i+s*e,r.rect.y=o+c*e)))}),this.redrawRect(),u.promise()},function(){function e(e){return function(t,r,n){if(t instanceof HistoryCell&&(t=this.recorder.cells.indexOf(t)),void 0===r?r=this.recorder.cells.length-1:r instanceof HistoryCell&&(r=this.recorder.cells.indexOf(r)),t>r)throw"start cannot be larger than end";if(!this.recorder.cells[t]||!this.recorder.cells[r])throw"statr or end doesnt exist";for(var i=0,o=t;o<=r;o++)o==t&&n||o==r&&n||(i+=this.recorder.cells[o].sizeCache[e]);return i}}HistoryLayer.prototype.heightBetweenCells=e("height"),HistoryLayer.prototype.widthBetweenCells=e("width")}(),HistoryLayer.prototype.olderPage=function(e){e||(e="down");var t=this;if(this.vertical){var r=this.visibleCellController[this.visibleCellController.length-1],n=r.cell,i=this.widthBetweenCells(n);this.hide(e).done(function(){t.contentOffset.x=i,t.visibleCellController=t.childrenAtContentOffset(t.contentOffset),t.show(e)})}else{var o=this.visibleCellController[this.visibleCellController.length-1],a=o.cell,s=this.heightBetweenCells(a);this.hide(e).done(function(){t.contentOffset.y=s,t.visibleCellController=t.childrenAtContentOffset(t.contentOffset),t.show(e)})}},HistoryLayer.prototype.newerPage=function(e){e||(e="up");var t=this,r=t.visibleCellController[0],n=this.recorder.cells.indexOf(r.cell)+2;if(this.vertical){for(var i=this.widthBetweenCells(n),o=i-(this.rect.width-this.margin.left-this.margin.right),a=n;a<this.recorder.cells.length&&this.recorder.cells[a]!=HistoryCell.PageBreak;a++)n=a;var s=this.widthBetweenCells(n),c=Math.max(s,o);this.hide(e).done(function(){t.contentOffset.x=c,t.visibleCellController=t.childrenAtContentOffset(t.contentOffset),t.show(e)})}else{for(var u=this.heightBetweenCells(n),l=u-(this.rect.height-this.margin.top-this.margin.bottom),h=n;h<this.recorder.cells.length&&this.recorder.cells[h]!=HistoryCell.PageBreak;h++)n=h;var f=this.heightBetweenCells(n),d=Math.max(f,l);this.hide(e).done(function(){t.contentOffset.y=d,t.visibleCellController=t.childrenAtContentOffset(t.contentOffset),t.show(e)})}},HistoryLayer.prototype.children=function(){return MessageLayer.prototype.children.apply(this,arguments).concat(this.visibleCellController)},HistoryLayer.prototype.childrenAtContentOffset=function(e){if(e||(e=this.contentOffset),this.vertical){for(var t=0,r=[],n=!1,i=this.recorder.cells.length-1;i>=0;i--){var o=this.recorder.cells[i];if(o.sizeCache&&0!=o.sizeCache.width||(o.controller=new HistoryCellController(o,this)),t+=o.sizeCache.width,t>e.x&&t-o.sizeCache.width<this.rect.width-this.margin.right-this.margin.left+e.x){if(o.controller||(o.controller=new HistoryCellController(o,this)),o.controller.rect=new Rect({x:this.margin.left+(t-o.sizeCache.width)-e.x,y:this.margin.top,width:o.sizeCache.width,height:o.sizeCache.height}),o!=HistoryCell.PageBreak)r.push(o.controller);else if(r.length){o.controller=null,n=!0;break}}else o.controller&&(o.controller=null)}if(!n&&r.length&&r[r.length-1].rect.x+r[r.length-1].rect.width<this.rect.width-this.margin.right&&(n=!0),n){var a=r[r.length-1],s=this.rect.width-this.margin.right-(a.rect.x+a.rect.width);r.forEach(function(e){e.rect.x+=s})}return r}for(var c=0,u=[],l=!1,h=this.recorder.cells.length-1;h>=0;h--){var f=this.recorder.cells[h];if(f.sizeCache&&0!=f.sizeCache.height||(f.controller=new HistoryCellController(f,this)),c+=f.sizeCache.height,c>e.y&&c-f.sizeCache.height<this.rect.height-this.margin.top-this.margin.bottom+e.y){if(f.controller||(f.controller=new HistoryCellController(f,this)),f.controller.rect=new Rect({x:this.margin.left,y:this.rect.height-this.margin.bottom-c+e.y,width:f.sizeCache.width,height:f.sizeCache.height}),f==HistoryCell.PageBreak){f.controller=null,l=!0;break}u.push(f.controller)}else f.controller&&(f.controller=null)}if(!l&&u.length&&u[u.length-1].rect.y>this.margin.top&&(l=!0),l){var d=u[u.length-1],p=d.rect.y-this.margin.top;u.forEach(function(e){e.rect.y-=p})}return u},HistoryLayer.prototype.flush=function(){if(this.requestedFrame){this.requestedFrame=!1,this.stackedClearRect=new Rect,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.backgroundStay||this.ctx.translate(this.animationOffset.x,this.animationOffset.y);for(var e=this.children(),t=0;t<e.length;t++){var r=e[t];if(this.visibleCellController.indexOf(r)!=-1)break;r.drawOnContext(this.ctx)}for(this.backgroundStay&&(this.ctx.translate(this.animationOffset.x,this.animationOffset.y),this.ctx.globalAlpha=this.animationContentOpacity),this.ctx.beginPath(),this.ctx.rect(this.margin.left,this.margin.top,this.rect.width-this.margin.left-this.margin.right,this.rect.height-this.margin.top-this.margin.bottom),this.ctx.clip();t<e.length;){var n=e[t];n.drawOnContext(this.ctx),t++}this.ctx.restore(),this.resetCursor()}};var AnimationConductor=function(e){Conductor.call(this,e),this.layer,this.cellImage,this.canvas,this.isLooping=!1,e&&(this.startingLabelName=e.label),this.nextTagTime,this.shouldStop};AnimationConductor.prototype=Object.create(Conductor.prototype),AnimationConductor.prototype.initializer="AnimationConductor",AnimationConductor.prototype.importFrom=function(e){var t=this;if(this.waitTag=clone(e.waitTag),this.setTag(e.currentTag),this.queue=clone(e.queue),this.status=e.status,this.callStack=clone(e.callStack),this.macroStack=clone(e.macroStack),this.macros=clone(e.macros),this.ifStack=clone(e.ifStack),this.layer=e.layer,e.cellImage&&(this.cellImage=clone(e.cellImage)),e.canvas&&(this.canvas=clone(e.canvas)),this.shouldStop=e.shouldStop,e.status!=Conductor.STATUS_STOP)if("wait"==e.currentTag.tagName){this.currentTag=e.currentTag,this.setTag(e.currentTag,!0);var r=(e.nextTagTime||Date.now())-Date.now();setTimeout(function(){return t.run()},r)}else this.run()},AnimationConductor.prototype.toJSON=function(){var e=this.layer&&0==this.layer.animationConductors.indexOf(this)||!this.canvas||this.isLooping;if(e)return{initializer:"AnimationConductor",file:this.file.filename,lineNumber:0,startingLabelName:this.startingLabelName}},AnimationConductor.restore=function(e){return $.when(_KAGFiles(e.file)).then(function(t){var r=new AnimationConductor({file:t,label:e.startingLabelName});return r})},AnimationConductor.prototype.run=function(){var e=o2.debugLevel;o2.debugLevel=0,Conductor.prototype.run.apply(this,arguments),o2.debugLevel=e},AnimationConductor.prototype.addChildToLayer=function(){return!!this.canvas&&(this.layer.animationChildren.indexOf(this.canvas)==-1&&this.layer.animationChildren.push(this.canvas),!0)},AnimationConductor.prototype.removeChildFromLayer=function(){var e=this.layer.animationChildren.indexOf(this.canvas);e>=0&&this.layer.animationChildren.splice(e,1)},AnimationConductor.prototype.wait=function(e,t){Conductor.prototype.wait.call(this,e)},AnimationConductor.prototype.stop=function(){this.removeChildFromLayer(),this.status!==Conductor.STATUS_STOP&&this.queue.push(new Tag("s"))},AnimationConductor.prototype.stopUntilHome=function(){this.shouldStop=!0},AnimationConductor.prototype.getTagAction=function(e){return AnimationConductor.tagActions||(AnimationConductor.tagActions={loadcell:new TagAction({rules:{storage:{type:"STRING"}},action:function(e){var t,r,n=this;try{r=this.conductor.layer.images[0],t=e.storage||r.image.originalURL+"_a"}catch(i){this.error("レイヤは画像がないです。")}return ResourceLoader.loadImage(t,!1).done(function(e){setTimeout(function(){var t=new DrawableImage(e,0,0);t.cacheEnabled=!1,t.reuseCanvas=!0,n.conductor.cellImage=t,n.conductor.canvas=new DrawableCanvas(r.rect),n.done()})}),1}}),copy:new TagAction({rules:{dx:{type:"INT",required:!0},dy:{type:"INT",required:!0},sx:{type:"INT",required:!0},sy:{type:"INT",required:!0},sw:{type:"INT",required:!0},sh:{type:"INT",required:!0}},action:function(e){this.conductor.addChildToLayer()||this.error("loadcellしていない状態でcopyタグを使おうとしてます");var t=this.conductor.canvas,r=t.canvas.getContext("2d"),n=this.conductor.cellImage;return n.options.clipLeft=e.sx,n.options.clipTop=e.sy,n.options.clipWidth=e.sw,n.options.clipHeight=e.sh,n.rect=new Rect({x:e.dx,y:e.dy,width:e.sw,height:e.sh}),t.ctx.clearRect(n.rect.x,n.rect.y,n.rect.width,n.rect.height),n.drawOnContext(r),this.conductor.layer.redrawRect(this.conductor.canvas.rect),0}}),clip:new TagAction({rules:{left:{type:"INT",required:!0},top:{type:"INT",required:!0}},action:function(e){if(!this.conductor.layer.images[0])return 0;var t=this.conductor.layer.images[0];return t.options.clipLeft=e.left,t.options.clipTop=e.top,t.cacheEnabled=!1,t.cacheCanvas=void 0,this.conductor.layer.redrawRect(t.rect),0}}),wait:new TagAction({rules:{time:{type:"INT",required:!0}},action:function(e){var t=this;return this.conductor.nextTagTime=Date.now()+e.time,setTimeout(function(){delete t.conductor.nextTagTime,t.done()},e.time),1}}),label:new TagAction({rules:{name:{type:"STRING"}},action:function(e){return 0}}),loop:new TagAction({action:function(){return this.conductor.isLooping=!0,0}}),home:new TagAction({action:function(){return this.conductor.shouldStop?2:0}}),s:new TagAction({action:function(){return 2}})},["jump","macro","endmacro","erasemacro","if","else","elsif","endif","ignore","endignore","eval","o2_iscript"].forEach(function(e){AnimationConductor.tagActions[e]=Tag.actions[e]})),AnimationConductor.tagActions[e]||Conductor.prototype.getTagAction.apply(this,arguments)},Tag.actions.s=new TagAction({action:function(){return this.conductor!=conductor&&this.conductor!=extraConductor?2:(o2.skipMode=o2.SKIP_MODE_NONE,o2.reloadDelaySpeed(),2)}}),function(){var e=["text","ch","hch","emb","ruby"];Tag.actions.text=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(t){function r(){o2.skipMode=o2.SKIP_MODE_CLICK,$(o2).off("click",r)}var n=this,i=this.conductor.getNextTag();if(o2.currentMessageLayer.stackedTextsProperties||(o2.currentMessageLayer.stackedTextsProperties=[]),t.text.split("").forEach(function(e){var t=new TextProperties(e);$.extend(t.styles,clone(o2.currentMessageLayer.font)),o2.currentMessageLayer.currentRubyText&&(t.rubyText=o2.currentMessageLayer.currentRubyText,delete o2.currentMessageLayer.currentRubyText),o2.currentMessageLayer.stackedTextsProperties.push(t)}),i&&e.indexOf(i.tagName)!=-1)return 0;var o=new HistoryRecord.String(o2.currentMessageLayer.stackedTextsProperties.map(function(e){return e.text}).join(""));o2.historyLayer.recorder.add(o);var a=!1,s=!1,c=function(){a&&s&&($(o2).off("click",r),n.done())};if(o2.currentMessageLayerWithBack){var u=clone(o2.currentMessageLayer.stackedTextsProperties),l=o2.currentMessageLayer.getCorrespondingLayer();l.drawText(u,function(){s=!0,c()})}else s=!0;return o2.currentMessageLayer.drawText(o2.currentMessageLayer.stackedTextsProperties,function(){a=!0,c()}),delete o2.currentMessageLayer.stackedTextsProperties,o2.clickSkipEnabled&&$(o2).on("click",r),1}}),Tag.actions.ch=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(t){var r=this.conductor.getNextTag();o2.currentMessageLayer.stackedTextsProperties||(o2.currentMessageLayer.stackedTextsProperties=[]);var n=new TextProperties(t.text);if($.extend(n.styles,clone(o2.currentMessageLayer.font)),o2.currentMessageLayer.currentRubyText&&(n.rubyText=o2.currentMessageLayer.currentRubyText,delete o2.currentMessageLayer.currentRubyText),o2.currentMessageLayer.stackedTextsProperties.push(n),r&&e.indexOf(r.tagName)!=-1)return 0;var i=new HistoryRecord.String(o2.currentMessageLayer.stackedTextsProperties.map(function(e){return e.text}).join(""));o2.historyLayer.recorder.add(i);var o=this;if(o2.currentMessageLayer.drawText(o2.currentMessageLayer.stackedTextsProperties,function(){o.done()}),o2.currentMessageLayerWithBack){var a=o2.currentMessageLayer.getCorrespondingLayer();a.drawText(clone(o2.currentMessageLayer.stackedTextsProperties))}return delete o2.currentMessageLayer.stackedTextsProperties,1}}),Tag.actions.hch=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(t){o2.currentMessageLayer.vertical||this.warn("hchタグは縦書きの状態でしか実行できません");var r=this.conductor.getNextTag();o2.currentMessageLayer.stackedTextsProperties||(o2.currentMessageLayer.stackedTextsProperties=[]);var n=new TextProperties(t.text);if($.extend(n.styles,clone(o2.currentMessageLayer.font)),n.styles.vertical=!1,o2.currentMessageLayer.currentRubyText&&(n.rubyText=o2.currentMessageLayer.currentRubyText,delete o2.currentMessageLayer.currentRubyText),o2.currentMessageLayer.stackedTextsProperties.push(n),r&&e.indexOf(r.tagName)!=-1)return 0;var i=new HistoryRecord.String(o2.currentMessageLayer.stackedTextsProperties.map(function(e){return e.text}).join(""));o2.historyLayer.recorder.add(i);var o=this;if(o2.currentMessageLayer.drawText(o2.currentMessageLayer.stackedTextsProperties,function(){o.done()}),o2.currentMessageLayerWithBack){var a=o2.currentMessageLayer.getCorrespondingLayer();a.drawText(clone(o2.currentMessageLayer.stackedTextsProperties))}return delete o2.currentMessageLayer.stackedTextsProperties,1}}),Tag.actions.emb=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},action:function(e){var t=this.eval(e.o2_exp),r=new Tag("text",{text:t});return this.conductor.queue.push(r),0}})}(),Tag.actions.ruby=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(e){return o2.currentMessageLayer.currentRubyText=e.text,o2.currentMessageLayerWithBack&&(o2.currentMessageLayer.getCorrespondingLayer().currentRubyText=e.text),0}}),Tag.actions.cm=new TagAction({action:function(e){for(var t=o2.foreLayers.messageLayers.concat(o2.backLayers.messageLayers),r=t.length-1;r>=0;r--){var n=t[r];n.resetMessageLayer()}return o2.historyLayer.recorder.options.repage&&o2.historyLayer.recorder.addPage(),0}}),Tag.actions.ct=new TagAction({action:function(e){var t=new Tag("cm");return t.run(),o2.currentMessageLayer=o2.foreLayers.messageLayers[0],o2.currentMessageLayerWithBack=!1,o2.historyLayer.recorder.options.repage&&o2.historyLayer.recorder.addPage(),0}}),Tag.actions.er=new TagAction({action:function(e){return o2.currentMessageLayer.resetMessageLayer(),o2.currentMessageLayerWithBack&&o2.currentMessageLayer.getCorrespondingLayer().resetMessageLayer(),o2.historyLayer.recorder.options.repage&&o2.historyLayer.recorder.addPage(),0}}),Tag.actions.current=new TagAction({rules:{layer:{type:"MESSAGE_LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},withback:{type:"BOOLEAN"}},action:function(e){var t=e.layer[e.page];return o2.currentMessageLayer=t,"withback"in e&&(o2.currentMessageLayerWithBack=e.withback),0}}),Tag.actions.position=new TagAction({rules:{layer:{type:"MESSAGE_LAYER"},page:{type:/fore|back/},left:{type:"INT"},top:{type:"INT"},width:{type:"INT"},height:{type:"INT"},frame:{type:"STRING"},color:{type:"COLOR"},opacity:{type:"FLOAT"},marginl:{type:"INT"},margint:{type:"INT"},marginr:{type:"INT"},marginb:{type:"INT"},vertical:{type:"BOOLEAN"},visible:{type:"BOOLEAN"}},action:function(e){var t;t=e.layer&&e.page?e.layer[e.page]:o2.currentMessageLayer;var r=!1,n=clone(t.rect);if("left"in e&&(n.x=e.left),
"top"in e&&(n.y=e.top),"width"in e&&(n.width=e.width),"height"in e&&(n.height=e.height),t.setRect(n),"frame"in e)if(""===e.frame)t.setFrameImage();else{var i=this;ResourceLoader.loadImage(e.frame,!0).done(function(e){var r=new DrawableImage(e);t.setFrameImage(r)}).always(function(){setTimeout(function(){renderer.animator.requestFrame(),"visible"in e&&t.visible!=e.visible&&(t.visible=e.visible),i.done()})}),r=!0}return"color"in e&&(t.frameSolid.color=e.color),"opacity"in e&&(t.frameSolid.opacity=e.opacity/255),"marginl"in e&&(t.margin.left=e.marginl),"margint"in e&&(t.margin.top=e.margint),"marginr"in e&&(t.margin.right=e.marginr),"marginb"in e&&(t.margin.bottom=e.marginb),"vertical"in e&&(t.vertical=e.vertical),t.resetMessageLayer(),r?1:("visible"in e&&t.visible!=e.visible&&(t.visible=e.visible),renderer.animator.requestFrame(),0)}}),Tag.actions.delay=new TagAction({rules:{speed:{type:"INT",required:!0,allowString:["user","nowait"]}},action:function(e){"nowait"===e.speed?(sf.__system.chSpeed=0,sf.__system.useUserChSpeed=!1):"user"===e.speed?sf.__system.useUserChSpeed=!0:(sf.__system.chSpeed=parseFloat(e.speed),sf.__system.useUserChSpeed=!1),o2.reloadDelaySpeed()}}),Tag.actions.wc=new TagAction({rules:{time:{type:"INT",required:!0}},action:function(e){var t=e.time*o2.currentMessageLayer.delaySpeed,r=this;return setTimeout(function(){r.done()},t),1}}),function(){var e=void 0;Tag.actions.nowait=new TagAction({action:function(){return e=o2.currentMessageLayer.delaySpeed,o2.currentMessageLayer.delaySpeed=0,0}}),Tag.actions.endnowait=new TagAction({action:function(){return o2.currentMessageLayer.delaySpeed=e,0}})}(),Tag.actions.deffont=new TagAction({rules:{size:{type:"INT"},face:{type:"STRING"},color:{type:"COLOR"},rubysize:{type:"INT"},rubyoffset:{type:"INT"},edge:{type:"BOOLEAN"},edgecolor:{type:"COLOR"},bold:{type:"BOOLEAN"},o2_shadow:{type:"BOOLEAN"},o2_shadowcolor:{type:"COLOR"},o2_shadowblur:{type:"INT"},o2_shadowoffsetx:{type:"INT"},o2_shadowoffsety:{type:"INT"}},action:function(e){var t=o2.currentMessageLayer,r={rubysize:"rubySize",rubyoffset:"rubyOffset",edgecolor:"edgeColor",shadowcolor:"shadowColor",o2_shadow:"shadow",o2_shadowcolor:"shadowColor",o2_shadowblur:"shadowBlur",o2_shadowoffsetx:"shadowOffsetX",o2_shadowoffsety:"shadowOffsetY"};for(var n in e){var i=r[n]||n;t.defaultFont[i]=e[n],o2.currentMessageLayerWithBack&&(t.getCorrespondingLayer().defaultFont[i]=e[n])}if(e.face){var o=this;return ResourceLoader.loadFont(e.face,!0).always(function(){setTimeout(function(){o.done()})}),1}return 0}}),Tag.actions.font=new TagAction({rules:{size:{type:"INT",allowString:["default"]},face:{type:"STRING"},color:{type:"COLOR",allowString:["default"]},italic:{type:"BOOLEAN",allowString:["default"]},rubysize:{type:"INT",allowString:["default"]},rubyoffset:{type:"INT",allowString:["default"]},edge:{type:"BOOLEAN",allowString:["default"]},edgecolor:{type:"COLOR",allowString:["default"]},bold:{type:"BOOLEAN",allowString:["default"]},o2_shadow:{type:"BOOLEAN"},o2_shadowcolor:{type:"COLOR"},o2_shadowblur:{type:"INT"},o2_shadowoffsetx:{type:"INT"},o2_shadowoffsety:{type:"INT"}},action:function(e){var t={rubysize:"rubySize",rubyoffset:"rubyOffset",edgecolor:"edgeColor",shadowcolor:"shadowColor",o2_shadow:"shadow",o2_shadowcolor:"shadowColor",o2_shadowblur:"shadowBlur",o2_shadowoffsetx:"shadowOffsetX",o2_shadowoffsety:"shadowOffsetY"};for(var r in e){var n=t[r]||r;"default"===e[r]&&(e[r]=o2.currentMessageLayer.deffont[n]),o2.currentMessageLayer.font[n]=e[r],o2.currentMessageLayerWithBack&&(o2.currentMessageLayer.getCorrespondingLayer().font[n]=e[r])}if(e.face){var i=this;return ResourceLoader.loadFont(e.face,!0).always(function(){setTimeout(function(){i.done()})}),1}return 0}}),Tag.actions.resetfont=new TagAction({action:function(e){if(o2.currentMessageLayer.font=clone(o2.currentMessageLayer.defaultFont),o2.currentMessageLayerWithBack){var t=o2.currentMessageLayer.getCorrespondingLayer();t.font=clone(t.defaultFont)}}}),Tag.actions.defstyle=new TagAction({rules:{linespacing:{type:"INT"},pitch:{type:"INT"},linesize:{type:"INT"},o2_kinsoku:{type:/none|oidashi|burasagari-oidashi/},o2_kinsoku_bol_char:{type:"STRING"},o2_kinsoku_eol_char:{type:"STRING"},o2_kinsoku_burasagari_char:{type:"STRING"}},action:function(e){var t={linespacing:"lineSpacing",linesize:"lineSize",o2_kinsoku:"kinsoku",o2_kinsoku_bol_char:"kinsokuBolChar",o2_kinsoku_eol_char:"kinsokuEolChar",o2_kinsoku_burasagari_char:"kinsokuBurasagariChar",toback:{type:"BOOLEAN"}};if(o2.currentMessageLayerWithBack&&!e.toback){var r=clone(e);r.toback=!0;var n=new Tag("defstyle",r);this.conductor.queue.push(n)}var i=o2.currentMessageLayer;e.toback&&(i=i.getCorrespondingLayer());for(var o in e){var a=t[o]||o;i.defaultStyle[a]=e[o]}if("o2_kinsoku"in e)switch(e.o2_kinsoku){case"none":i.defaultStyle.kinsoku=MessageLayer.KINSOKU_NONE;break;case"oidashi":i.defaultStyle.kinsoku=MessageLayer.KINSOKU_OIDASHI;break;case"burasagari-oidashi":i.defaultStyle.kinsoku=MessageLayer.KINSOKU_BURASAGARI}return 0}}),Tag.actions.style=new TagAction({rules:{align:{type:/left|center|right|top|center|bottom|default/},linespacing:{type:"INT"},pitch:{type:"INT"},linesize:{type:"INT",allowString:["default"]},autoreturn:{type:"BOOLEAN",allowString:["default"]},o2_kinsoku:{type:/none|oidashi|burasagari-oidashi/},o2_kinsoku_bol_char:{type:"STRING"},o2_kinsoku_eol_char:{type:"STRING"},o2_kinsoku_burasagari_char:{type:"STRING"},toback:{type:"BOOLEAN"}},action:function(e){if(o2.currentMessageLayerWithBack&&!e.toback){var t=clone(e);t.toback=!0;var r=new Tag("style",t);this.conductor.queue.push(r)}var n=o2.currentMessageLayer;e.toback&&(n=n.getCorrespondingLayer()),"align"in e&&("default"==e.align?n.vertical?n.style.align="top":n.style.align="left":n.style.align=e.align),"linespacing"in e&&(n.vertical?n.textCursor.x-=e.linespacing-n.style.lineSpacing:n.textCursor.y+=e.linespacing-n.style.lineSpacing,n.style.lineSpacing=e.linespacing),"pitch"in e&&(n.style.pitch=e.pitch),"linesize"in e&&("default"==e.linesize?n.style.lineSize=-1:n.style.lineSize=e.linesize),"autoreturn"in e&&("default"==e.autoreturn&&(e.autoreturn=n.defaultStyle.autoReturn),n.style.autoReturn=e.autoreturn);var i={o2_kinsoku_bol_char:"kinsokuBolChar",o2_kinsoku_eol_char:"kinsokuEolChar",o2_kinsoku_burasagari_char:"kinsokuBurasagariChar"};for(var o in e)o in i&&(n.style[i[o]]=e[o]);if("o2_kinsoku"in e)switch(e.o2_kinsoku){case"none":n.style.kinsoku=MessageLayer.KINSOKU_NONE;break;case"oidashi":n.style.kinsoku=MessageLayer.KINSOKU_OIDASHI;break;case"burasagari-oidashi":n.style.kinsoku=MessageLayer.KINSOKU_BURASAGARI}}}),Tag.actions.resetstyle=new TagAction({rules:{toback:{type:"BOOLEAN"}},action:function(e){if(o2.currentMessageLayerWithBack&&!e.toback){var t=clone(e);t.toback=!0;var r=new Tag("resetstyle",t);this.conductor.queue.push(r)}var n=o2.currentMessageLayer;e.toback&&(n=n.getCorrespondingLayer()),n.vertical?n.textCursor.x-=o2.currentMessageLayer.defaultStyle.lineSpacing-o2.currentMessageLayer.style.lineSpacing:n.textCursor.y+=o2.currentMessageLayer.defaultStyle.lineSpacing-o2.currentMessageLayer.style.lineSpacing,n.style=clone(n.defaultStyle)}}),Tag.actions.locate=new TagAction({rules:{x:{type:"INT"},y:{type:"INT"},toback:{type:"BOOLEAN"}},action:function(e){if(o2.currentMessageLayerWithBack&&!e.toback){var t=clone(e);t.toback=!0;var r=new Tag("locate",t);this.conductor.queue.push(r)}var n=o2.currentMessageLayer;return e.toback&&(n=n.getCorrespondingLayer()),"x"in e&&(n.textCursor.x=e.x+n.margin.left,n.vertical&&(n.textCursor.x-=n.style.lineSpacing)),"y"in e&&(n.textCursor.y=e.y+n.margin.top,n.vertical||(n.textCursor.y+=n.style.lineSpacing)),0}}),Tag.actions.r=new TagAction({action:function(){return o2.currentMessageLayer.linebreak(),o2.currentMessageLayerWithBack&&o2.currentMessageLayer.getCorrespondingLayer().linebreak(),o2.historyLayer.recorder.addCell(!0),0}}),function(){var e=void 0;Tag.actions.indent=new TagAction({action:function(){var t=o2.currentMessageLayer,r=t.margin.vertical;return r?(e=t.margin.top,t.margin.top=t.textCursor.y):(e=t.margin.left,t.margin.left=t.textCursor.x),0}}),Tag.actions.endindent=new TagAction({action:function(){var t=o2.currentMessageLayer,r=t.margin.vertical;return void 0===e&&o2.error("indentタグを先に実行してください"),r?t.margin.top=e:t.margin.left=e,0}})}(),Tag.actions.p=new TagAction({action:function(e){if(o2.historyLayer.recorder.addCell(!0),o2.autoMode){var t=this,r=o2.cancelAutoMode,n=setTimeout(function(){t.conductor===currentConductor&&(o2.cancelAutoMode=r,t.done())},sf.__system.autoModePageWait);return o2.cancelAutoMode=function(){return clearTimeout(n),t.conductor.wait("click"),o2.cancelAutoMode=r,r.apply(this,arguments)},1}return o2.skipMode<=o2.SKIP_MODE_PAGE&&(o2.skipMode=o2.SKIP_MODE_NONE),o2.skipMode?0:(o2.showGlyph("page"),this.conductor.wait("click",function(){o2.hideGlyph()}),1)}}),Tag.actions.l=new TagAction({action:function(){var e=this.conductor.isCurrentRead(),t=config.chNonStopToPageBreak||config.ch2ndNonStopToPageBreak&&e;if(t)return 0;if(o2.autoMode){var r=this,n=o2.cancelAutoMode,i=setTimeout(function(){r.conductor===currentConductor&&(o2.cancelAutoMode=n,r.done())},sf.__system.autoModeLineWait);return o2.cancelAutoMode=function(){return clearTimeout(i),o2.showGlyph("line"),r.conductor.wait("click"),o2.cancelAutoMode=n,n.apply(this,arguments)},1}return o2.skipMode<=o2.SKIP_MODE_CLICK&&(o2.skipMode=o2.SKIP_MODE_NONE),o2.skipMode?0:(o2.showGlyph("line"),this.conductor.wait("click",function(){o2.hideGlyph()}),1)}}),Tag.actions.button=new TagAction({rules:{graphic:{type:"STRING",required:!0},graphickey:{type:"COLOR",allowString:["adapt"]},storage:{type:"STRING"},target:{type:"STRING"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},o2_exp:{type:"STRING"},o2_onenter:{type:"STRING"},o2_onleave:{type:"STRING"}},action:function(e){var t=this;return ResourceLoader.loadImage(e.graphic).done(function(r){setTimeout(function(){var n=o2.currentMessageLayer,i=n.textCursor,o=i.x,a=i.y;n.vertical?o-=n.style.lineSpacing:a-=n.style.lineSpacing;var s=new KAGButton(r,o,a);s.importFromKAGArgs(e),n.addButton(s),o2.currentMessageLayerWithBack&&n.getCorrespondingLayer().addButton(clone(s)),t.done()})}),1}});var KAGButton=function(e,t,r){Button.call(this,e,t,r),this.rect.width=Math.floor(this.rect.width/3),this.options.clipLeft=0,this.options.clipWidth=this.rect.width,this.tagArgs};KAGButton.prototype=Object.create(Button.prototype),KAGButton.prototype.initializer="KAGButton",KAGButton.prototype.clone=function(){var e=new KAGButton(this.image);return e.importFrom(this),e},KAGButton.prototype.drawOnContext=function(e,t){switch(this.state){case Button.STATE_HOVER:this.options.clipLeft=2*this.rect.width;break;case Button.STATE_DOWN:this.options.clipLeft=this.rect.width;break;case Button.STATE_NORMAL:default:this.options.clipLeft=0}Button.prototype.drawOnContext.apply(this,arguments)},KAGButton.prototype.importFromKAGArgs=function(e){e&&(this.tagArgs=clone(e),this.click=function(t,r,n){if(Button.prototype.click.apply(this,arguments),e.o2_exp&&(0,eval)(e.o2_exp),e.o2_url&&window.open(e.o2_url,e.o2_urltarget),e.storage||e.target){var i=new Tag("jump",{storage:e.storage,target:e.target});currentConductor.queue.push(i)}n.addButtonLinkImages(),n.buttons=[],n.links=[]},e.o2_onenter&&(this.enter=function(){Button.prototype.enter.apply(this,arguments),(0,eval)(e.o2_onenter)}),e.o2_onleave&&(this.leave=function(){Button.prototype.leave.apply(this,arguments),(0,eval)(e.o2_onleave)}))},KAGButton.prototype.importFrom=function(e){Button.prototype.importFrom.call(this,e),this.importFromKAGArgs(e.tagArgs)},KAGButton.prototype.importFromSaveData=function(e){Button.prototype.importFromSaveData.call(this,e),this.importFromKAGArgs(e.tagArgs)},KAGButton.prototype.toJSON=function(){var e=Button.prototype.toJSON.call(this);return e.tagArgs=this.tagArgs,e},KAGButton.restore=function(e){return $.when(ResourceLoader.loadImage(e.image,!0)).then(function(t){var r=new KAGButton(t);return r.importFromSaveData(e),r})};var KAGLink;!function(){KAGLink=function(){Link.call(this),this.tagArgs},KAGLink.prototype=Object.create(Link.prototype),KAGLink.prototype.initializer="KAGLink",KAGLink.restore=function(e){var t=new KAGLink;return t.importFromKAGArgs(e.tagArgs),delete e.tagArgs,Link.prototype.importFromSaveData(e),t},KAGLink.prototype.importFrom=function(e){Link.prototype.importFrom.call(this,e),this.importFromKAGArgs(e.tagArgs)},KAGLink.prototype.importFromKAGArgs=function(e){this.tagArgs=e,this.click=function(t,r,n){if(Link.prototype.click.apply(this,arguments),"o2_exp"in e&&(0,eval)(e.o2_exp),"o2_url"in e&&window.open(e.o2_url,e.o2_urltarget),e.target||e.storage){var i=new Tag("jump",{target:this.tagArgs.target,storage:this.tagArgs.storage});currentConductor.queue.push(i)}n.addButtonLinkImages(),n.buttons=[],n.links=[]},"o2_onenter"in e&&(this.enter=function(){Link.prototype.enter.apply(this,arguments),(0,eval)(e.o2_onenter)}),"o2_onleave"in e&&(this.leave=function(){Link.prototype.leave.apply(this,arguments),(0,eval)(e.o2_onleave)})};var e=0,t={};Tag.actions.link=new TagAction({rules:{storage:{type:"STRING"},target:{type:"STRING"},color:{type:"COLOR"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},o2_onenter:{type:"STRING"},o2_onleave:{type:"STRING"},o2_exp:{type:"STRING"}},action:function(r){return e=o2.currentMessageLayer.textsProperties.length,t=r,0}}),Tag.actions.endlink=new TagAction({action:function(r){var n=new KAGLink;n.importFromKAGArgs(t),n.vertical=o2.currentMessageLayer.vertical;for(var i=e;i<o2.currentMessageLayer.textsProperties.length;i++)n.addTextProperties(o2.currentMessageLayer.textsProperties[i]);if(o2.currentMessageLayer.addLink(n),o2.currentMessageLayerWithBack){var o=o2.currentMessageLayer.getCorrespondingLayer(),a=new KAGLink;a.importFromKAGArgs(t),a.vertical=o.vertical;for(var s=e;s<o.textsProperties.length;s++)a.addTextProperties(o.textsProperties[s]);o.addLink(a)}return 0}})}(),Tag.actions.image=new TagAction({rules:{storage:{type:"STRING",required:!0},layer:{type:"IMAGE_LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},grayscale:{type:"BOOLEAN"},rgamma:{type:"FLOAT"},ggamma:{type:"FLOAT"},bgamma:{type:"FLOAT"},rfloor:{type:"INT"},gfloor:{type:"INT"},bfloor:{type:"INT"},rceil:{type:"INT"},gceil:{type:"INT"},bceil:{type:"INT"},mcolor:{type:"COLOR"},mopacity:{type:"INT"},shadow:{type:"COLOR"},shadowopacity:{type:"INT",defaultValue:200},shadowx:{type:"INT",defaultValue:10},shadowy:{type:"INT",defaultValue:10},shadowblur:{type:"FLOAT",defaultValue:3},clipleft:{type:"INT"},cliptop:{type:"INT"},clipwidth:{type:"INT"},clipheight:{type:"INT"},flipud:{type:"BOOLEAN"},fliplr:{type:"BOOLEAN"},visible:{type:"BOOLEAN"},left:{type:"INT"},top:{type:"INT"},pos:{type:/left|left_center|center|right_center|right|l|lc|c|rc|r/},opacity:{type:"INT"},allowfail:{type:"BOOLEAN",defaultValue:!1},o2_zoom:{type:/[0-9]+(:[0-9]+)?/},o2_rotate:{type:"FLOAT"},o2_orx:{type:"FLOAT"},o2_ory:{type:"FLOAT"},o2_blur:{type:"INT"},o2_blurx:{type:"INT"},o2_blury:{type:"INT"},o2_blurmode:{type:/linear|constantalpha/}},preload:function(e){ResourceLoader.loadImage(e.storage,!1)},action:function(e){var t=this,r=e.layer[e.page],n={grayscale:!1,rGamma:1,gGamma:1,bGamma:1,rFloor:0,gFloor:0,bFloor:0,rCeil:255,gCeil:255,bCeil:255,tintColor:"#ff0000",tintOpacity:0,shadow:"#000000",shadowOpacity:200,shadowX:10,shadowY:10,shadowBlur:3,clipLeft:void 0,clipTop:void 0,clipWidth:void 0,clipHeight:void 0,flipUD:!1,flipLR:!1,visible:!0,opacity:255,blurX:0,blurY:0,blurMode:"linear"},i={rgamma:"rGamma",ggamma:"gGamma",bgamma:"bGamma",rfloor:"rFloor",gfloor:"gFloor",bfloor:"bFloor",rceil:"rCeil",gceil:"gCeil",bceil:"bCeil",mcolor:"tintColor",mopacity:"tintOpacity",shadowopacity:"shadowOpacity",shadowx:"shadowX",shadowy:"shadowY",shadowblur:"shadowBlur",clipleft:"clipLeft",cliptop:"clipTop",clipwidth:"clipWidth",clipheight:"clipHeight",flipud:"flipUD",fliplr:"flipLR",o2_blurx:"blurX",o2_blury:"blurY",o2_blurmode:"blurMode"};for(var o in e)if(["storage","layer","page","allowfail","left","top","pos","o2_zoom","o2_rotate","o2_orx","o2_ory"].indexOf(o)==-1){var a=i[o]||o;n[a]=e[o]}return"opacity"in n&&(r.opacity=n.opacity/255,n.opacity=1),"visible"in n&&(r.visible=n.visible,n.visible=!0),"shadowOpacity"in n&&(n.shadowOpacity/=255),"tintOpacity"in n&&(n.tintOpacity/=255),"o2_blur"in e&&("o2_blurx"in e||(n.blurX=e.o2_blur),"o2_blury"in e||(n.blurY=e.o2_blur)),r.loadImage(e.storage,n,e.allowfail).fail(function(){t.error("イメージファイル "+e.storage+" をロードできません")}).then(function(n){if("pos"in e){switch(e.pos){case"left":case"l":r.rect.x=config.scPositionX_left-n.rect.width/2;break;case"left_center":case"lc":r.rect.x=config.scPositionX_left_center-n.rect.width/2;break;case"center":case"c":r.rect.x=config.scPositionX_center-n.rect.width/2;break;case"right_center":case"rc":r.rect.x=config.scPositionX_right_center-n.rect.width/2;break;case"right":case"r":r.rect.x=config.scPositionX_right-n.rect.width/2}r.rect.y=config.scHeight-n.rect.height}else"left"in e&&(r.rect.x=e.left),"top"in e&&(r.rect.y=e.top);if(r.rect.width=Math.max(config.scWidth,n.rect.width),r.rect.height=Math.max(config.scHeight,n.rect.height),r.setRect(),"o2_zoom"in e){var i=1,o=1,a=e.o2_zoom.split(":");if(a.length>=2?(i=parseFloat(a[0]),o=parseFloat(a[1])):i=o=parseFloat(a[0]),isNaN(i)||isNaN(o))return t.error("o2_zoomが正しくありません。"),0;r.scaleX=i/100,r.scaleY=o/100}"o2_rotate"in e&&(r.rotation=e.o2_rotate/180*Math.PI),"o2_orx"in e?r.transformOrigin.x=e.o2_orx:r.transformOrigin.x=n.rect.width/2,"o2_ory"in e?r.transformOrigin.y=e.o2_ory:r.transformOrigin.y=n.rect.height/2}).then(function(){try{return _KAGFiles(e.storage+".asd")}catch(t){return $.Deferred().reject()}}).then(function(e){var t=new AnimationConductor({file:e});r.addAnimationConductor(t,0),t.run()}).always(function(){setTimeout(function(){t.done()})}),1}}),Tag.actions.pimage=new TagAction({rules:{storage:{type:"STRING",required:!0},layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},allowfail:{type:"BOOLEAN",defaultValue:!1},dx:{type:"INT",required:!0},dy:{type:"INT",required:!0},sx:{type:"INT",defaultValue:0},sy:{type:"INT",defaultValue:0},sw:{type:"INT"},sh:{type:"INT"},opacity:{type:"INT"},o2_grayscale:{type:"BOOLEAN",defaultValue:!1},o2_rgamma:{type:"FLOAT"},o2_ggamma:{type:"FLOAT"},o2_bgamma:{type:"FLOAT"},o2_rfloor:{type:"INT"},o2_gfloor:{type:"INT"},o2_bfloor:{type:"INT"},o2_rceil:{type:"INT"},o2_gceil:{type:"INT"},o2_bceil:{type:"INT"},o2_mcolor:{type:"COLOR"},o2_mopacity:{type:"INT"}},action:function(e){var t=this;return ResourceLoader.loadImage(e.storage,!e.allowfail).done(function(r){var n=e.layer[e.page],i=new DrawableImage(r,e.dx,e.dy),o={sx:"clipLeft",sy:"clipTop",sw:"clipWidth",sh:"clipHeight",opacity:"opacity",o2_grayscale:"grayscale",o2_rgamma:"rGamma",o2_ggamma:"gGamma",o2_bgamma:"bGamma",o2_rfloor:"rFloor",o2_gfloor:"gFloor",o2_bfloor:"bFloor",o2_rceil:"rCeil",o2_gceil:"gCeil",o2_bceil:"bCeil",o2_mcolor:"tintColor",o2_mopacity:"tintOpacity"};for(var a in o)a in e&&(i.options[o[a]]=e[a]);"opacity"in i.options&&(i.options.opacity/=255),"tintOpacity"in i.options&&(i.options.tintOpacity/=255),n.addImage(i),setTimeout(t.done.bind(t))}),1}}),Tag.actions.freeimage=new TagAction({rules:{layer:{type:"IMAGE_LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"}},action:function(e){return e.layer[e.page].clearImage(),e.layer[e.page].clearAnimationConductors(),0}}),Tag.actions.backlay=new TagAction({rules:{layer:{type:"LAYER"}},action:function(e){var t=this;return renderer.animator.requestFrame(function(){if(e.layer)e.layer.back.importFrom(e.layer.fore);else for(var r=o2.allForeLayers(),n=o2.allBackLayers(),i=0;i<r.length;i++)n[i].importFrom(r[i]);t.done()}),1}}),Tag.actions.copylay=new TagAction({rules:{srclayer:{type:"LAYER",required:!0},destlayer:{type:"LAYER",required:!0},srcpage:{type:/fore|back/,defaultValue:"fore"},destpage:{type:/fore|back/,defaultValue:"fore"}},action:function(e){var t=e.srclayer[e.srcpage],r=e.destlayer[e.destpage];if(t.initializer!=r.initializer)throw"srclayerとdestlayerに異なる種類のレイヤを指定することはできません";return r.importFrom(t),0}}),Tag.actions.o2_forelay=new TagAction({rules:{layer:{type:"LAYER"}},action:function(e){var t=this;return renderer.animator.requestFrame(function(){if(e.layer)e.layer.fore.importFrom(e.layer.back);else for(var r=o2.allForeLayers(),n=o2.allBackLayers(),i=0;i<r.length;i++)r[i].importFrom(n[i]);t.done()}),1}}),Tag.actions.layopt=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},visible:{type:"BOOLEAN"},left:{type:"INT"},top:{type:"INT"},opacity:{type:"INT"},autohide:{type:"BOOLEAN"},index:{type:"INT"},o2_zoom:{type:/[0-9]+(:[0-9]+)?/},o2_rotate:{type:"FLOAT"},o2_orx:{type:"FLOAT"},o2_ory:{type:"FLOAT"},o2_frameopacity:{type:"INT"},o2_userinteraction:{type:"BOOLEAN"}},action:function(e){var t=e.layer[e.page];if("visible"in e&&(t.visible=e.visible),"left"in e&&(t.rect.x=e.left),"top"in e&&(t.rect.y=e.top),"opacity"in e&&(t.opacity=e.opacity/255),"autohide"in e)if(e.autohide)o2.extraAutoHideLayers.indexOf(t)==-1&&o2.extraAutoHideLayers.push(t);else{var r=o2.extraAutoHideLayers.indexOf(t);r!=-1&&o2.extraAutoHideLayers.splice(r,1)}if("index"in e&&(t.index=e.index,o2.refreshRendererLayers()),"o2_zoom"in e){var n=1,i=1,o=e.o2_zoom.split(":");if(o.length>=2?(n=parseFloat(o[0]),i=parseFloat(o[1])):n=i=parseFloat(o[0]),isNaN(n)||isNaN(i))return this.error("o2_zoomが正しくありません。"),0;t.scaleX=n/100,t.scaleY=i/100}return"o2_rotate"in e&&(t.rotation=e.o2_rotate/180*Math.PI),"o2_orx"in e&&(t.transformOrigin.x=e.o2_orx),"o2_ory"in e&&(t.transformOrigin.y=e.o2_ory),"o2_frameopacity"in e&&(t instanceof MessageLayer?t.frameImage?(t.frameImage.options.opacity=e.o2_frameopacity/255,t.redrawRect(t.frameImage.rect)):(t.frameSolid.opacity=e.o2_frameopacity/255,t.redrawRect(t.frameSolid.rect)):this.error("メッセージレイヤー以外のレイヤーにo2_frameopacityを指定できないです")),"o2_userinteraction"in e&&(t.userInteractionEnabled=e.o2_userinteraction),renderer.animator.requestFrame(),0}}),Tag.actions.laycount=new TagAction({rules:{layers:{type:"INT"},messages:{type:"INT"}},action:function(e){if("layers"in e)if(e.layers>o2.foreLayers.imageLayers.length)for(var t=o2.foreLayers.imageLayers.length;t<e.layers;t++)o2.foreLayers.imageLayers.push(new ImageLayer),o2.backLayers.imageLayers.push(new ImageLayer);else if(e.layers<o2.foreLayers.imageLayers.length){var r=o2.foreLayers.imageLayers.length-e.layers;o2.foreLayers.imageLayers.splice(-r,r).concat(o2.backLayers.imageLayers.splice(-r,r)).forEach(function(e){e.destroy()})}if("messages"in e)if(e.messages>o2.foreLayers.messageLayers.length)for(var n=o2.foreLayers.messageLayers.length;n<e.messages;n++)o2.foreLayers.messageLayers.push(new MessageLayer),o2.backLayers.messageLayers.push(new MessageLayer);else if(e.messages<o2.foreLayers.messageLayers.length){var i=o2.foreLayers.messageLayers.length-e.messages;o2.foreLayers.messageLayers.splice(-i,i).concat(o2.backLayers.messageLayers.splice(-i,i)).forEach(function(e){e.destroy()})}return o2.resetLayersIndex(),o2.refreshRendererLayers(),renderer.animator.requestFrame(),0}}),Tag.actions.trans=new TagAction({rules:{time:{type:"INT",required:!0},layer:{type:"LAYER",defaultValue:"base"},children:{type:"BOOLEAN",defaultValue:!0},method:{type:"STRING",defaultValue:"crossfade"}},action:function(e){function t(){if(!this.end)if(i)$.when(Tag.actions.trans.stopAllTransitions()).done(function(){Tag.actions.trans.runningTag=n;var t=$("#main-wrapper");n.container=$("<div />"),n.container.css({position:"absolute",width:t.width()+"px",height:t.height()+"px"}),t.append(n.container),n.container.append([renderer.foreCanvas,renderer.backCanvas]),n.method.transitAllLayers.call(n,e,renderer.backCanvas,renderer.foreCanvas,n.container),renderer.animator.requestFrame(function(){n.end||r()},e.time)});else{var t=function a(){n.end||(Date.now()-o<e.time?renderer.animator.requestFrame(a):r())};e.layer.fore.transit(this);var o=Date.now();t()}}function r(){n.end||(n.end=!0,i?$.when(Tag.actions.trans.stopAllTransitions()).done(function(){n.done()}):(e.layer.fore.stopTransition(),n.done()))}this.end=!1,this.transArgs=e,this.method=Tag.actions.trans.methods[e.method],this.method||this.error(e.method+" というメソッドは存在しません"),"canRun"in this.method&&!this.method.canRun()&&(this.method=Tag.actions.trans.methods.crossfade);var n=this,i=!1;return e.layer.fore==o2.foreLayers.baseLayer&&e.children&&(i=!0),this.method.transit||i||this.error("メソッド "+e.method+" を実行するにはlayer属性にbase、children属性にtrueを指定する必要があります"),renderer.renderBackCanvas=!0,"function"==typeof this.method.preload?this.method.preload.call(this,e).done(function(){renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){t.call(n),n.done()})})}):renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){t.call(n),n.done()})}),1},stopAllTransitions:function(){for(var e=o2.allForeLayers(),t=o2.allBackLayers(),r=0;r<e.length;r++)e[r].stopTransition();if(Tag.actions.trans.runningTag){var n=$.Deferred();renderer.renderBackCanvas=!1;for(var i=0;i<e.length;i++)e[i].importFrom(t[i]);return o2.refreshRendererLayers(),function(){var e=Tag.actions.trans.runningTag;renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){"function"==typeof e.method.teardownAllLayers&&e.method.teardownAllLayers.call(e,e.transArgs,renderer.backCanvas,renderer.foreCanvas,e.container),$(renderer.backCanvas).detach(),e.container&&(e.container.remove(),delete e.container),$("#main-wrapper").append(renderer.foreCanvas),n.resolve()})}),e.end=!0}(),Tag.actions.trans.runningTag=void 0,$(o2).trigger("transEnd"),n.promise()}},methods:{}});var TransMethod=function(e){for(var t in e)this[t]=e[t];e.transitAllLayers||(this.transitAllLayers=function(t,r,n,i){function o(){s.end||(Date.now()-a<t.time&&renderer.animator.requestFrame(o),e.transit.call(s,t,n,r,s.transCanvas))}$(r).hide(),$(n).hide(),this.transCanvas=document.createElement("canvas"),this.transCanvas.width=n.width,this.transCanvas.height=r.height,$(this.transCanvas).css({position:"absolute",x:0,y:0}),$(i).append(this.transCanvas),e.prepare.call(this,t);var a=Date.now(),s=this;o()},this.teardownAllLayers=function(t,r,n,i){"function"==typeof e.teardown&&e.teardown.call(this),$(r).show(),$(n).show(),$(this.transCanvas).remove(),this.transCanvas=null})};Tag.actions.stoptrans=new TagAction({action:function(){var e=this;return $.when(Tag.actions.trans.stopAllTransitions()).done(function(){setTimeout(function(){e.done()})}),1}}),Tag.actions.wt=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!0}},action:function(e){var t=o2.allForeLayers(),r=!0;if(Tag.actions.trans.runningTag)r=!1;else for(var n=t.length-1;n>=0;n--)if(t[n].isTransiting()){r=!1;break}if(r)return 0;if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode){var i=this;return $.when(Tag.actions.trans.stopAllTransitions()).done(function(){setTimeout(function(){i.done()})}),1}this.conductor.wait("click",function(){Tag.actions.trans.stopAllTransitions()})}return this.conductor.wait("trans"),1}}),Tag.actions.trans.methods.crossfade=new TransMethod({prepare:function(e){this.beginning=Date.now()},transit:function(e,t,r,n){var i=n.getContext("2d"),o=Date.now(),a=(o-this.beginning)/e.time;(a>=1||this.end)&&(a=1),i.save(),i.clearRect(0,0,n.width,n.height),i.globalAlpha=1,i.drawImage(t,0,0),i.globalAlpha=a,i.drawImage(r,0,0),i.restore()},teardown:function(){delete this.beginning},transitAllLayers:function(e,t,r,n){var i=this,o=Date.now();if(r.style.zIndex=1,t.style.zIndex=2,supportCssProperty("animationName")){var a="@-webkit-keyframes fade { \n0% { \n opacity: 0; \n} 100% { \n opacity: 1; \n}} \n";a+=a.replace(/-webkit-/g,"-moz-")+a.replace(/-webkit-/g,"-o-")+a.replace(/-webkit-/g,"");var s=document.createTextNode(a);this.cssTag=document.createElement("style"),this.cssTag.type="text/css",this.cssTag.appendChild(s),document.getElementsByTagName("head")[0].appendChild(this.cssTag),$(t).css("opacity",0),renderer.animator.requestFrame(function(){$(t).css({"animation-duration":e.time+"ms","animation-timing-function":e.timing_function||"linear","animation-name":"fade"})})}else{var c=function u(){var r=(Date.now()-o)/e.time;i.end||renderer.animator.requestFrame(u),t.style.opacity=r};renderer.animator.requestFrame(c)}},teardownAllLayers:function(e,t,r,n){if(this.end=!0,this.cssTag)try{document.getElementsByTagName("head")[0].removeChild(this.cssTag)}catch(i){}$(t).css({opacity:1,"animation-duration":"","animation-timing-function":"","animation-name":""})}}),$.extend(Tag.actions.trans.rules,{from:{type:/left|top|right|bottom/,defaultValue:"left"},stay:{type:/stayfore|stayback|nostay/,defaultValue:"nostay"},o2_timing_function:{type:"STRING",defaultValue:"linear"}}),Tag.actions.trans.methods.scroll=new TransMethod({prepare:function(e){if(this.beginning=Date.now(),e.o2_timing_function.indexOf("cubic-bezier")!=-1){var t=e.o2_timing_function.replace("cubic-bezier","");if(t=t.replace("(",""),t=t.replace(")",""),t=t.split(",").map(function(e){return parseFloat(e)}),4!=t.length)throw"o2_timing_function属性のフォーマットが正しくありません";this.timingFunction=new KeySpline(t[0],t[1],t[2],t[3])}else switch(e.o2_timing_function){case"ease":this.timingFunction=new KeySpline(.25,.1,.25,1);break;case"ease-in":this.timingFunction=new KeySpline(.42,0,1,1);break;case"ease-out":this.timingFunction=new KeySpline(0,0,.58,1);break;case"ease-in-out":this.timingFunction=new KeySpline(.42,0,.58,1);break;default:this.timingFunction=new KeySpline(0,0,1,1)}},transit:function(e,t,r,n){var i=(Date.now()-this.beginning)/e.time,o=n.getContext("2d");i=this.timingFunction.get(i),o.clearRect(0,0,n.width,n.height);var a=0,s=0;if("stayback"!=e.stay)switch(e.from){case"top":s=n.height*i;break;case"right":a=-1*t.width*i;break;case"bottom":s=-1*t.height*i;break;default:a=n.width*i}o.drawImage(t,a,s,t.width,t.height);var c=r.height,u=r.width,l=0,h=0;if("stayfore"==e.stay)switch(a=s=0,e.from){case"top":c*=i;break;case"right":u*=i,l=(1-i)*r.width,a=l;break;case"bottom":c*=i,h=(1-i)*r.height,s=h;break;default:u*=i}else switch(e.from){case"top":s=r.height*(i-1);break;case"right":a=n.width*(1-i);break;case"bottom":s=(1-i)*n.height;break;default:a=r.width*(i-1)}u*c>0&&o.drawImage(r,l,h,u,c,a,s,u,c)},teardown:function(){delete this.beginning,delete this.timingFunction}}),$.extend(Tag.actions.trans.rules,{vague:{type:"INT",defaultValue:64},rule:{type:"STRING"},liveview:{type:"BOOLEAN",allowString:["auto"],defaultValue:"auto"},opaque:{type:"BOOLEAN",defaultValue:!0}}),Tag.actions.trans.methods.universal=new TransMethod({preload:function(e){var t=this;if(!("rule"in e))throw"rule属性は必須です";return this.liveview=function(){if(e.liveview===!0)return!0;if("auto"==e.liveview){var t;t=e.layer.fore==o2.foreLayers.baseLayer?o2.allLayers():e.layer;for(var r in t)if(t[r].moveTag)return!0}return!1}(),ResourceLoader.loadImage(e.rule).done(function(e){return t.maskImage=e})},supportsArrayBuffer:function(){return window.ArrayBuffer&&window.Uint8Array&&window.Uint32Array}(),isLittleEndian:function(){if(!window.ArrayBuffer||!window.Uint8Array||!window.Uint32Array)return!1;var e=new ArrayBuffer(4),t=new Uint32Array(e),r=new Uint8Array(e);if(t[0]=3735928559,239==r[0])return!0;if(222==r[0])return!1;throw new Error("unknown endianness")}(),prepare:function(e){this.beginning=Date.now(),this.maskCanvas=document.createElement("canvas"),this.maskCanvas.width=this.maskImage.width,this.maskCanvas.height=this.maskImage.height,this.maskContext=this.maskCanvas.getContext("2d"),this.maskContext.drawImage(this.maskImage,0,0),this.maskData=this.maskContext.getImageData(0,0,this.maskCanvas.width,this.maskCanvas.height)},transit:function(e,t,r,n){var i=(Date.now()-this.beginning)/e.time;i>1&&(i=1);var o,a;if(!this.liveview&&this.beforeBitmap&&this.afterBitmap)o=this.beforeBitmap,a=this.afterBitmap;else{var s=t.getContext("2d"),c=r.getContext("2d"),u=s.getImageData(0,0,t.width,t.height),l=c.getImageData(0,0,r.width,r.height);
a=l.data,o=u.data,this.liveview||(this.beforeBitmap=o,this.afterBitmap=a)}var h=e.vague,f=h+(h+255)*-i,d=this.maskData.data,p=n.getContext("2d"),g=p.createImageData(n.width,n.height),y=g.data;if(e.opaque&&Tag.actions.trans.methods.universal.supportsArrayBuffer&&a.buffer){this.maskCopyingCanvas?this.maskCopyingContext.clearRect(0,0,this.maskCopyingCanvas.width,this.maskCopyingCanvas.height):(this.maskCopyingCanvas=document.createElement("canvas"),this.maskCopyingCanvas.width=this.maskCanvas.width,this.maskCopyingCanvas.height=this.maskCanvas.height,this.maskCopyingContext=this.maskCopyingCanvas.getContext("2d"));var m=new Uint32Array(a.buffer),v=new Uint32Array(y.buffer);if(this.maskCanvas.width==n.width&&this.maskCanvas.height==n.height)if(Tag.actions.trans.methods.universal.isLittleEndian)for(var w=0,T=m.length;w<T;w++){var b=1-(d[w<<2]+f)/h;b=255*(b>1?1:b<0?0:b),v[w]=16777215&m[w]|(0|b)<<24}else for(var L=0,x=m.length;L<x;L++){var C=1-(d[L<<2]+f)/h;C=255*(C>1?1:C<0?0:C),v[L]=4294967040&m[L]|(0|C)}else{var S=n.width,k=this.maskCanvas.width,A=this.maskCanvas.height;if(Tag.actions.trans.methods.universal.isLittleEndian)for(var O=0,_=m.length;O<_;O++){var R=Math.floor(O/S),N=O%k,E=R%A,D=N+E*k,I=1-(d[D<<2]+f)/h;I=255*(I>1?1:I<0?0:I),v[O]=16777215&m[O]|(0|I)<<24}else for(var M=0,F=m.length;M<F;M++){var B=1-(d[M<<2]+f)/h;B=255*(B>1?1:B<0?0:B),v[M]=4294967040&m[M]|(0|B)}}this.maskCopyingContext.putImageData(g,0,0),p.drawImage(t,0,0),p.drawImage(this.maskCopyingCanvas,0,0)}else{if(this.maskCanvas.width==n.width&&this.maskCanvas.height==n.height)for(var P=0,G=y.length;P<G;P+=4){var z=1-(d[P]+f)/h;z=Math.max(0,Math.min(1,z)),y[P]=o[P]+(a[P]-o[P])*z,y[P+1]=o[P+1]+(a[P+1]-o[P+1])*z,y[P+2]=o[P+2]+(a[P+2]-o[P+2])*z,y[P+3]=255}else for(var j=n.width,V=this.maskCanvas.width,q=this.maskCanvas.height,$=0,H=y.length;$<H;$+=4){var K=$/4,W=Math.floor($/4/j),U=K%V,Y=W%q,X=4*(U+Y*V),J=1-(d[X]+f)/h;J=Math.max(0,Math.min(1,J)),y[$]=o[$]+(a[$]-o[$])*J,y[$+1]=o[$+1]+(a[$+1]-o[$+1])*J,y[$+2]=o[$+2]+(a[$+2]-o[$+2])*J,y[$+3]=255}p.putImageData(g,0,0)}},teardown:function(){delete this.beginning,delete this.maskCanvas,delete this.maskContext,delete this.maskData,delete this.maskImage,delete this.maskCopyingCanvas,delete this.maskCopyingContext}}),Tag.actions.move=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},spline:{type:"BOOLEAN"},time:{type:"INT",required:!0},delay:{type:"INT"},path:{type:"STRING"},accel:{type:"INT",defaultValue:0},o2_path:{type:"STRING"},o2_orx:{type:"FLOAT"},o2_ory:{type:"FLOAT"},o2_omit:{type:"STRING"},o2_override:{type:"BOOLEAN",defaultValue:!0}},action:function(e){var t=this,r=e.time,n=e.layer[e.page];if("o2_orx"in e&&(n.transformOrigin.x=e.o2_orx),"o2_ory"in e&&(n.transformOrigin.y=e.o2_ory),!("path"in e||"o2_path"in e))return this.error("path属性かo2_path属性のいずれかは必須です"),0;var i=function(e,t,r,n,i,o){this.x=e,this.y=t,this.opacity=r,this.zoomX=n,this.zoomY=i,this.rotation=o},o=/\((-?[0-9,\s:]+)*\)/g,a=[],s=e.path;"o2_path"in e&&(s=e.o2_path);var c=s.match(o);null==c&&this.error("path属性のフォーマットが正しくありません");var u={};"o2_omit"in e&&e.o2_omit.replace(/\s/g,"").split(",").forEach(function(e){u[e]=1}),a.push(new i(n.rect.x,n.rect.y,n.opacity,n.scaleX,n.scaleY,n.rotation));for(var l=0;l<c.length;l++){var h=c[l];h=h.replace("(","").replace(")",""),h=h.split(",");var f=new i,d=parseFloat(h[0]);isNaN(d)?f.x=a[a.length-1].x:f.x=d;var p=parseFloat(h[1]);isNaN(p)?f.y=a[a.length-1].y:f.y=p;var g=parseFloat(h[2]);isNaN(g)?f.opacity=a[a.length-1].opacity:f.opacity=g/255;var y=[];if(h.length>3){if(s==e.path)return this.error("path属性に4つ以上のパラメータを指定することはできません"),0;y=h[3].split(":")}2==y.length?(f.zoomX=parseFloat(y[0])/100||a[a.length-1].zoomX,f.zoomY=parseFloat(y[1])/100||a[a.length-1].zoomY):(f.zoomX=parseFloat(y[0])/100||a[a.length-1].zoomX,f.zoomY=parseFloat(y[0])/100||a[a.length-1].zoomY);var m=parseFloat(h[4]);isNaN(m)?f.rotation=a[a.length-1].rotation:f.rotation=m/180*Math.PI,a.push(f)}r=e.time*(a.length-1);var v;v=e.accel<-1?new KeySpline(.08,.44,.42,.93):e.accel>1?new KeySpline(.45,0,.97,.65):new KeySpline(0,0,1,1);var w=function(){n.moveTag&&e.o2_override&&(n.moveTag.end=!0),n.moveTag=this;var i=void 0;e.spline&&a.length>=2&&(i=B_Spline_Generator(a.map(function(e){return[e.x,e.y]})));var o=Date.now();renderer.animator.requestFrame(function s(){var e=Date.now(),c=e-o,l=c/r,h=1/(a.length-1);if(l>=1||t.end){l=1;var f=a[a.length-1];return u.x||(n.rect.x=f.x),u.y||(n.rect.y=f.y),u.opacity||(n.opacity=f.opacity),u.scaleX||(n.scaleX=f.zoomX),u.scaleY||(n.scaleY=f.zoomY),u.rotation||(n.rotation=f.rotation),$(o2).off("transEnd",T),T=null,t.end=!1,n.moveTag==t&&delete n.moveTag,void $(t).trigger("ended")}renderer.animator.requestFrame(s),l=v.get(l);var d=(a.length-1)*l,p=Math.floor(d),g=p+1,y=l/h-p;g>=a.length&&(g=a.length-1);var m,w=a[p],b=a[g];m=i?i(100*l):{x:w.x+(b.x-w.x)*y,y:w.y+(b.y-w.y)*y},u.x||(n.rect.x=m.x),u.y||(n.rect.y=m.y),u.opacity||(n.opacity=w.opacity+(b.opacity-w.opacity)*y),u.scaleX||(n.scaleX=w.zoomX+(b.zoomX-w.zoomX)*y),u.scaleY||(n.scaleY=w.zoomY+(b.zoomY-w.zoomY)*y),u.rotation||(n.rotation=w.rotation+(b.rotation-w.rotation)*y)})},T=function(){n.moveTag==t&&delete n.moveTag,n=n.getCorrespondingLayer(),n.moveTag=t};return $(o2).on("transEnd",T),e.delay?setTimeout(w.bind(this),e.delay):w.call(this),0}}),Tag.actions.stopmove=new TagAction({rules:{o2_layer:{type:"LAYER"},o2_page:{type:/fore|back/,defaultValue:"fore"}},action:function(e){var t;t=e.o2_layer?[e.o2_layer[e.o2_page]]:o2.allLayers();for(var r=t.length-1;r>=0;r--)t[r].moveTag&&(t[r].moveTag.end=!0);return 0}}),Tag.actions.wm=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!0},o2_layer:{type:"LAYER"},o2_page:{type:/fore|back/,defaultValue:"fore"}},action:function(e){function t(){o.forEach(function(e){e.moveTag.end=!0})}function r(){o.forEach(function(e){$(e.moveTag).off("ended",r),i.done()})}var n,i=this;n=e.o2_layer?[e.o2_layer[e.o2_page]]:o2.allLayers();var o=n.filter(function(e){return e.moveTag&&!e.moveTag.end}),a=o.length>0;if(!a)return 0;if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return t(),0;this.conductor.wait("click",t)}return o.forEach(function(e){$(e.moveTag).one("ended",r)}),1}}),function(){var e=!1,t=!1;Tag.actions.quake=new TagAction({rules:{time:{type:"INT",required:!0},hmax:{type:"INT",defaultValue:10},vmax:{type:"INT",defaultValue:10}},action:function(r){function n(){e=!0;for(var n=0;n<a;n++)s.push({x:Math.floor(Math.random()*r.hmax*2)-r.hmax,y:Math.floor(Math.random()*r.vmax*2)-r.vmax});s.push({x:0,y:0}),renderer.animator.requestFrame(function o(){var n=Date.now(),a=n-i,u=1/(s.length-1),l=a/r.time;l>1||t?(l=1,e=!1,t=!1,c.done()):renderer.animator.requestFrame(o);var h=(s.length-1)*l,f=Math.floor(h),d=f+1,p=l/u-f;d>=s.length&&(d=s.length-1);var g=s[f],y=s[d];renderer.xShift=g.x+(y.x-g.x)*p,renderer.yShift=g.y+(y.y-g.y)*p})}var i=Date.now(),o=50,a=Math.ceil(r.time/o),s=[],c=this;return e?(t=!0,renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){n(),c.done()})}),1):(n(),0)}}),Tag.actions.stopquake=new TagAction({rules:{},action:function(r){return e&&(t=!0),0}}),Tag.actions.wq=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(r){if(!e)return 0;if(r.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return t=!0,0;this.conductor.wait("click",function(){t=!0})}return this.conductor.wait("quake"),1}})}(),Tag.actions.label=new TagAction({rules:{name:{type:"STRING",required:!0},caption:{type:"STRING"}},action:function(e){if(this.conductor!=conductor)return 0;if(conductor.stack.length)return this.error("[->]のタグ内にラベルを置いてはいけないです。"),0;if(o2.reloadDelaySpeed(),o2.skipMode!=o2.SKIP_MODE_UNREAD||this.conductor.isCurrentRead()||(o2.skipMode=o2.SKIP_MODE_NONE),"caption"in e&&config.saveMode==o2.SAVE_MODE_KAG3){if(currentConductor.macroStack.length)return this.error("セーブモードがkag3モードの場合、ラベルをマクロの中に置いてはいけない。"),0;""!=e.caption?saveCurrentState(e.caption):saveCurrentState()}return 0}}),Tag.actions.jump=new TagAction({rules:{storage:{type:"STRING"},target:{type:"STRING"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},disable_clear_stack:{type:"BOOLEAN",defaultValue:!1}},action:function(e){function t(t){if(t||i.error("シナリオファイル "+e.storage+" が見つかりません"),e.target){var r=e.target;"*"==r.charAt(0)&&(r=r.substring(1)),n=t.getLabelTag(r),n||i.error("ラベル "+r+" が見つかりません")}else n=t.lines[0];i.jumpToTag(n),e.disable_clear_stack||(i.conductor.clearIfStack(),i.conductor.clearMacroStack(),i.conductor.clearStack())}"o2_url"in e&&window.open(e.o2_url,e.o2_urltarget);var r,n,i=this;if(e.storage)r=_KAGFiles(e.storage);else if(this.conductor.macroStack.length){var o=this.conductor.macroStack[this.conductor.macroStack.length-1];r=$.when(o.returnTag.restore()).then(function(e){return e.file})}else r=this.conductor.file;return r instanceof KAGFile?(t(r),0):($.when(r).then(function(e){t(e),i.done()}),1)}}),Tag.actions.call=new TagAction({rules:{storage:{type:"STRING"},target:{type:"STRING"}},action:function(e){var t=this.conductor.getNextTag();if(!t){var r=new Tag("jump",e);return this.conductor.queue.push(r),0}t=t.toRestorable(),this.conductor.callStack.push(t),e=this.normalizedArgs(),e.disable_clear_stack=!0;var n=new Tag("jump",e);return this.conductor.queue.push(n),0}}),Tag.actions["return"]=new TagAction({rules:{storage:{type:"STRING"},target:{type:"STRING"}},action:function(e){var t=this.conductor.callStack.pop();if(t||this.error("サブルーチン外でreturnタグを実行することはできません"),t=t.restore(),e=this.normalizedArgs(),e.disable_clear_stack=!0,e.storage||e.target){var r=new Tag("jump",e);return this.conductor.queue.push(r),0}if(t instanceof Tag)return this.jumpToTag(t),0;var n=this;return $.when(t).then(function(e){setTimeout(function(){n.jumpToTag(e),n.done()})}),1}}),Tag.actions.macro=new TagAction({rules:{name:{type:"STRING",required:!0}},action:function(e){var t=new MacroDefinition({name:e.name.toLowerCase(),startTag:this.conductor.getNextTag().toRestorable()});this.conductor.macros[e.name.toLowerCase()]=t;var r=this.conductor.getNextTag("endmacro");return r||this.error("endmacroタグが見つかりません"),this.conductor.setTag(r,!0),0}}),Tag.actions.endmacro=new TagAction({action:function(e){return 0}}),Tag.actions.erasemacro=new TagAction({rules:{name:{type:"STRING",required:!0}},action:function(e){return delete this.conductor.macros[e.name],0}}),Tag.actions.seopt=new TagAction({rules:{buf:{type:"INT",defaultValue:0},volume:{type:"INT"},gvolume:{type:"INT"},pan:{type:"INT",defaultValue:0}},action:function(e){var t=o2.se[e.buf],r=Math.max(-100,Math.min(100,e.pan/100));return t?("volume"in e&&t.setVolume(e.volume/100),"pan"in e&&t.setPan(r),"gvolume"in e&&o2.setSeGVolume(e.gvolume/100),0):(this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0)}}),Tag.actions.playse=new TagAction({rules:{buf:{type:"INT",defaultValue:0},storage:{type:"STRING",required:!0},loop:{type:"BOOLEAN",defaultValue:!1},o2_start:{type:"TIME"},o2_block:{type:"BOOLEAN"}},action:function(e){var t=o2.se[e.buf];if(!t)return this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0;t.play(e.storage),t.setLoop(e.loop),"o2_start"in e&&t.setTime(e.o2_start);var r=this;return e.o2_block?(t.loadDefer.done(function(){setTimeout(function(){r.done()})}),1):0}}),Tag.actions.stopse=new TagAction({rules:{buf:{type:"INT",defaultValue:0}},action:function(e){var t=o2.se[e.buf];return t?(t.stop(),0):(this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0)}}),Tag.actions.fadese=new TagAction({rules:{buf:{type:"INT",defaultValue:0},volume:{type:"INT",required:!0},time:{type:"INT",required:!0}},action:function(e){var t=o2.se[e.buf];return t?(t.fade({toVolume:e.volume/100,duration:e.time}),0):(this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0)}}),Tag.actions.fadeinse=new TagAction({rules:{buf:{type:"INT",defaultValue:0},storage:{type:"STRING",required:!0},time:{type:"INT",required:!0},loop:{type:"BOOLEAN",defaultValue:!1},o2_start:{type:"TIME"},o2_volume:{type:"INT"},o2_block:{type:"BOOLEAN",defaultValue:!1}},action:function(e){var t=o2.se[e.buf];if(!t)return this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0;t.play(e.storage),t.setLoop(e.loop),"o2_start"in e&&t.setTime(e.o2_start),"o2_volume"in e&&t.setVolume(e.o2_volume/100),t.fade({fromVolume:0,duration:e.time});var r=this;return e.o2_block?(t.loadDefer.done(function(){setTimeout(function(){r.done()})}),1):0}}),Tag.actions.fadeoutse=new TagAction({rules:{buf:{type:"INT",defaultValue:0},time:{type:"INT",required:!0}},action:function(e){var t=o2.se[e.buf];return t?(t.fade({toVolume:0,duration:e.time,stopAfterFade:!0,finalVolume:0}),0):(this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0)}}),Tag.actions.wf=new TagAction({rules:{buf:{type:"INT",defaultValue:0},canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(e){var t=this,r=o2.se[e.buf];if(!r)return this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0;var n=r.fade(),i=!1;if(!n)return 0;if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return r.stopFade(),0;this.conductor.wait("click",function(){i=!0,r.stopFade()})}return n.done(function(){i||setTimeout(function(){t.done()})}),1}}),Tag.actions.ws=new TagAction({rules:{buf:{type:"INT",defaultValue:0},canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(e){var t=o2.se[e.buf];if(!t)return this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0;if(!t.isPlaying)return o2.warn("効果音は再生されてないから、このタグは無視されました"),0;if(t.loop)return o2.warn("効果音のループ再生中に再生終了を待つことはできないため、このタグは無視されました"),0;var r=this,n=!1;if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return t.stop(),0;this.conductor.wait("click",function(){n=!0,t.stop()})}return $(t).one("ended",function(){n||setTimeout(function(){r.done()})}),1}}),Tag.actions.bgmopt=new TagAction({rules:{volume:{type:"INT"},gvolume:{type:"INT"}},action:function(e){var t=o2.bgm;return"volume"in e&&t.setVolume(e.volume/100),"gvolume"in e&&o2.setBgmGVolume(e.gvolume/100),0}}),Tag.actions.playbgm=new TagAction({rules:{storage:{type:"STRING",required:!0},loop:{type:"BOOLEAN",defaultValue:!0},o2_start:{type:"TIME"},o2_block:{type:"BOOLEAN"}},action:function(e){var t=o2.bgm;t.stopFade(),t.play(e.storage),t.setLoop(e.loop),"o2_start"in e&&t.setTime(e.o2_start);var r=this;return e.o2_block?(t.loadDefer.done(function(){setTimeout(function(){r.done()})}),1):0}}),Tag.actions.pausebgm=new TagAction({action:function(){return o2.bgm.pause(),0}}),Tag.actions.resumebgm=new TagAction({action:function(){return o2.bgm.play(),0}}),Tag.actions.stopbgm=new TagAction({action:function(e){var t=o2.bgm;return t.stop(),0}}),Tag.actions.fadebgm=new TagAction({rules:{volume:{type:"INT",required:!0},time:{type:"INT",required:!0}},action:function(e){var t=o2.bgm;return t.fade({toVolume:e.volume/100,duration:e.time}),0}}),Tag.actions.fadeinbgm=new TagAction({rules:{storage:{type:"STRING",required:!0},time:{type:"INT",required:!0},loop:{type:"BOOLEAN",defaultValue:!0},o2_start:{type:"TIME"},o2_volume:{type:"INT"},o2_block:{type:"BOOLEAN",defaultValue:!1}},action:function(e){var t=o2.bgm;t.play(e.storage),t.setLoop(e.loop),"o2_start"in e&&t.setTime(e.o2_start),"o2_volume"in e&&t.setVolume(e.o2_volume/100),t.fade({fromVolume:0,duration:e.time});var r=this;return e.o2_block?(t.loadDefer.done(function(){setTimeout(function(){r.done()})}),1):0}}),Tag.actions.fadeoutbgm=new TagAction({rules:{time:{type:"INT",required:!0}},action:function(e){var t=o2.bgm,r=t.volume;return t.fadeStatus&&void 0!==t.fadeStatus.finalVolume&&(r=t.fadeStatus.finalVolume),t.fade({toVolume:0,duration:e.time,stopAfterFade:!0,finalVolume:r}),0}}),Tag.actions.fadepausebgm=new TagAction({rules:{time:{type:"INT",required:!0}},action:function(e){var t=o2.bgm,r=t.fade({toVolume:0,duration:e.time});return r&&r.done(function(){t.pause()}),0}}),Tag.actions.xchgbgm=new TagAction({rules:{storage:{type:"STRING",required:!0},loop:{type:"BOOLEAN",defaultValue:!0},time:{type:"INT",required:!0},overlap:{type:"INT",defaultValue:0},volume:{type:"INT"},o2_start:{type:"TIME"}},action:function(e){var t,r=this;if(t="volume"in e?e.volume/100:o2.bgm.volume,!browser.supportsMultipleAudio&&o2.prioritySound==o2.bgm)return o2.bgm.stop(),o2.bgm.setFile(e.storage).done(function(){setTimeout(function(){o2.bgm.play(),o2.bgm.setVolume(t),o2.bgm.setLoop(e.loop),"o2_start"in e&&o2.bgm.setTime(e.o2_start),r.done()})}),1;var n=new Sound,i=o2.bgm;return n.setFile(e.storage).done(function(){o2.bgm=n,$.when(i.fade({toVolume:0,duration:e.time,id:"old"})).done(function(){i.stop()}),setTimeout(function(){n.play(),"o2_start"in e&&n.setTime(e.o2_start),n.fade({fromVolume:0,toVolume:t,duration:e.time})},e.time-e.overlap),setTimeout(function(){r.done()})}),n.setLoop(e.loop),1}}),Tag.actions.wb=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(e){var t=this,r=o2.bgm,n=r.fade();if(!n)return 0;if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return r.stopFade(),0;this.conductor.wait("click",function(){r.stopFade()})}return n.done(function(){setTimeout(function(){t.done()})}),1}}),Tag.actions.wl=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(e){var t=this,r=o2.bgm;if(!r.isPlaying||r.loop)return o2.warn("BGMのループ再生中に再生終了を待つことはできないため、このタグは無視されました"),0;if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return r.stop(),0;this.conductor.wait("click",function(){r.stop()})}return $(r).one("ended",function(){setTimeout(function(){t.done()})}),1}});var IfStatus;!function(){function e(e,t){t||(t=currentConductor);var r=t.upComingTags(),n=0;"string"==typeof e&&(e=[e]);for(var i=0;i<r.length;i++){var o=r[i];if(0===n&&e.indexOf(o.tagName)!==-1)return o;"if"===o.tagName&&n++,"endif"===o.tagName&&n--}}IfStatus=function(){this.conditionFulfilled=!1},Tag.actions["if"]=Tag.actions.ignore=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},action:function(t){var r=new IfStatus;this.conductor.ifStack.push(r);try{r.conditionFulfilled=this.eval(t.o2_exp)}catch(n){r.conditionFulfilled=!1}if("ignore"===this.tagName&&(r.conditionFulfilled=!r.conditionFulfilled),!r.conditionFulfilled){var i=e(["else","elsif","endif","endignore"],this.conductor);i&&this.conductor.setTag(i)}return 0}}),Tag.actions["else"]=new TagAction({action:function(t){var r=this.conductor.ifStack[this.conductor.ifStack.length-1];if(!r)return 0;if(r.conditionFulfilled){var n=e(["endif","endignore"],this.conductor);n&&this.conductor.setTag(n)}return 0}}),Tag.actions.elsif=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},action:function(t){var r=this.conductor.ifStack[this.conductor.ifStack.length-1],n=!1;if(!r)return 0;if(r.conditionFulfilled)n=!0;else{var i;try{i=this.eval(t.o2_exp)}catch(o){i=!1}i?r.conditionFulfilled=!0:n=!0}if(n){var a=e(["else","elsif","endif","endignore"],this.conductor);a&&this.conductor.setTag(a)}return 0}}),Tag.actions.endif=Tag.actions.endignore=new TagAction({action:function(e){return this.conductor.ifStack.pop(),0}}),Tag.actions["switch"]=new TagAction({rules:{val:{type:"STRING"}},action:function(e){this.value=e.val;var t=!1;return this.originalCase=this.conductor.tagActions["case"],this.conductor.tagActions["case"]=new TagAction({rules:{val:{type:"STRING"}},action:function(r){r.val==e.val&&(t=!0,this.conductor.setTag(this,!0))}}),this.originalDefault=this.conductor.tagActions["default"],this.conductor.tagActions["default"]=new TagAction({action:function(){t||this.conductor.setTag(this,!0)}}),this.conductor.setTag(this,!0),0},exitScope:function(){this.conductor.tagActions["case"]=this.originalCase,this.conductor.tagActions["default"]=this.originalDefault},closeAction:function(e){return 0}}),Tag.actions.foreach=new TagAction({rules:{val:{type:"OBJECT"},from:{type:"NUMBER",defaultValue:0},to:{type:"NUMBER"}},action:function(e){if(!("to"in e||"val"in e))return this.error("valかtoを指定してください。"),0;if(null!=e.val&&"object"===_typeof(e.val)&&("to"in e||0!=e.from))return this.error("valがobjectの時、to/fromを使えない"),0;var t;if("val"in e&&(e.val instanceof Array&&!("to"in e)||null!=e.val&&"object"===_typeof(e.val))&&(t=Object.keys(e.val),e.to=t.length-1),this.loopStatus={index:e.from,shouldLoop:function(){return this.index<=e.to},getValues:function(){if(e.val instanceof Array)return[e.val[this.index],this.index];if("object"===_typeof(e.val)){var r=t[this.index],n=e.val[r];return[r,n]}return[this.index]},next:function(){this.index++}},this.loopStatus.shouldLoop()){var r=this.loopStatus.getValues();this.setScopeVars(r),this.conductor.setTag(this,!0)}return 0},exitScope:function(){delete this.loopStatus},closeAction:function(e){var t=e.loopStatus;return t.next(),t.shouldLoop()&&(e.setScopeVars(t.getValues()),this.conductor.setTag(e,!0),this.keepStack()),0}})}(),function(){var e=void 0;Tag.actions.wait=new TagAction({rules:{time:{type:"INT",required:!0},mode:{type:/normal|until/,defaultValue:"normal"},canskip:{type:"BOOLEAN",defaultValue:!0}},action:function(t){var r=this;if("until"===t.mode&&(t.time=e+t.time-Date.now(),t.time<=0))return 0;var n=setTimeout(function(){return r.done()},t.time);if(t.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return clearTimeout(n),0;this.conductor.wait("click",function(){clearTimeout(n)})}return 1}}),Tag.actions.resetwait=new TagAction({action:function(t){return e=Date.now(),0}})}(),Tag.actions.waitclick=new TagAction({action:function(e){return this.conductor.wait("click",function(){o2.skipMode=o2.SKIP_MODE_NONE}),1}}),Tag.actions.cancelskip=new TagAction({action:function(e){return o2.skipMode=o2.SKIP_MODE_NONE,0}}),Tag.actions.clickskip=new TagAction({rules:{enabled:{type:"BOOLEAN",required:!0}},action:function(e){return o2.clickSkipEnabled=e.enabled,0}}),Tag.actions.cancelautomode=new TagAction({action:function(){return o2.cancelAutoMode(),0}}),Tag.actions.eval=new TagAction({rules:{o2_exp:{type:"STRING"},func:{type:"FUNCTION"}},action:function(e){e.o2_exp||e.func||this.error("o2_expがないです");try{e.o2_exp?this.eval(e.o2_exp):e.func(e)}catch(t){}return 0}}),Tag.actions.o2_iscript=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},action:function(e){try{this.eval(e.o2_exp)}catch(t){}return 0}}),$(function(){function e(){r=[];for(var e=o2.autoHideLayers(),t=0;t<e.length;t++){var n=e[t];r.push(n.visible),n.visible=!1}renderer.animator.requestFrame()}function t(){if(r){for(var e=o2.autoHideLayers(),t=0;t<e.length;t++){var n=e[t];n.visible=r[t]}renderer.animator.requestFrame(),r=void 0,"p"==conductor.currentTag.tagName?o2.showGlyph("page"):"l"==conductor.currentTag.tagName&&o2.showGlyph("line")}}var r=void 0;$(o2).on("rclick",function(){if(["p","l","s"].indexOf(currentConductor.currentTag.tagName)!=-1&&o2.rclickSettings.enabled&&!r)if(o2.rclickSettings.call){extraConductor.setFile(conductor.file),currentConductor=extraConductor;var e=new Tag("jump",{target:o2.rclickSettings.target,storage:o2.rclickSettings.storage});extraConductor.queue.push(e)}else if(o2.rclickSettings.jump){var t=new Tag("jump",{target:o2.rclickSettings.target,storage:o2.rclickSettings.storage});currentConductor.queue.push(t)}else Tag.actions.rclick.hideMessageLayer()});var n=function i(e){e.stopImmediatePropagation(),t(),$(o2).off("click",i),$(o2).off("rclick",i)};Tag.actions.rclick=new TagAction({rules:{call:{type:"BOOLEAN"},jump:{type:"BOOLEAN"},target:{type:"STRING"},storage:{type:"STRING"},enabled:{type:"BOOLEAN"}},action:function(e){if("call"in e&&e.call===!0&&"jump"in e&&e.jump===!0)return this.error("call属性とjump属性の両方にtrueを指定することはできません"),0;for(var t in e)e.hasOwnProperty(t)&&(o2.rclickSettings[t]=e[t]);return 0},hideMessageLayer:function(){e(),$(o2).bindFirst("click",n),$(o2).bindFirst("rclick",n)}}),Tag.actions.hidemessage=new TagAction({action:function(t){e();var r=this;return $(o2).bindFirst("click",n),$(o2).bindFirst("click",function i(){setTimeout(function(){r.done()}),$(o2).off("click",i)}),1}})}),function(){var e=void 0;Tag.actions.o2_request=new TagAction({rules:{method:{type:/get|post/i,required:!0},url:{type:"STRING",required:!0},req:{type:"STRING",required:!0},"return":{type:"STRING",defaultValue:"req"}},action:function(t){return e=$.ajax({url:t.url,type:t.method,data:t.req}).done(function(r,n,i){ev[t["return"]]={stat:i.status+" "+i.statusText,head:i.getAllResponseHeaders(),body:r},e=void 0}),0}}),Tag.actions.o2_wr=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!1},timeout:{type:"INT"}},action:function(t){function r(){i||(n.done(),i=!0)}if(!e)return 0;var n=this,i=!1;return e.done(function(){setTimeout(r)}),"timeout"in t&&setTimeout(r,t.timeout),t.canskip&&o2.clickSkipEnabled&&this.conductor.wait("click",function(){i=!0}),1}})}(),Tag.actions.title=new TagAction({rules:{name:{type:"STRING",required:!0}},action:function(e){return config.title=e.name,document.title=config.title,0}}),Tag.actions.history=new TagAction({rules:{output:{type:"BOOLEAN"},enabled:{type:"BOOLEAN"}},action:function(e){return"output"in e&&(o2.historyLayer.recorder.options.output=e.output),"enabled"in e&&(o2.historyLayer.recorder.options.enabled=e.enabled),0}}),Tag.actions.hr=new TagAction({rules:{repage:{type:"BOOLEAN",defaultValue:!1}},action:function(e){return o2.historyLayer.recorder.options.repage&&e.repage?o2.historyLayer.recorder.addPage():o2.historyLayer.recorder.addCell(!0),0}}),Tag.actions.showhistory=new TagAction({action:function(e){if(!o2.historyLayer.visible){var t=this;o2.historyLayer.resetAndShow().done(function(){t.done()}).fail(function(){t.warn("ヒストリーレイヤを開けなかった。"),t.done()})}return 1}}),Tag.actions.o2_historytext=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(e){var t=new HistoryRecord.String(e.text);return o2.historyLayer.recorder.add(t),0}}),function(){var e=-1,t={};HistoryRecord.LinkStart=function(e){this.args=e},HistoryRecord.LinkStart.prototype=Object.create(HistoryRecord.prototype),HistoryRecord.LinkStart.prototype.initializer="HistoryRecord.LinkStart",HistoryRecord.LinkStart.prototype.toDrawable=function(r,n){e=n.length,t=this.args},HistoryRecord.LinkEnd=function(){},HistoryRecord.LinkEnd.prototype=Object.create(HistoryRecord.prototype),HistoryRecord.LinkEnd.prototype.initializer="HistoryRecord.LinkEnd",HistoryRecord.LinkEnd.prototype.toDrawable=function(r,n){if(e>=0){var i=n.slice(e);e=-1;var o=new Link;return o.color="#ff0000",o.vertical=r.layer.vertical,o.addTextProperties(i),function(e){o.click=function(){(0,eval)(e.o2_exp)}}(t),o}},Tag.actions.hact=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},action:function(e){var t=new HistoryRecord.LinkStart(e);return o2.historyLayer.recorder.add(t),0}}),Tag.actions.endhact=new TagAction({action:function(){var e=new HistoryRecord.LinkEnd;return o2.historyLayer.recorder.add(e),0}})}();var Video=function a(){this.element=document.createElement("video"),this.element.setAttribute("webkit-playsinline",!0),this.filepath,this.rect=new Rect(0,0,320,240),this.loop=!1,this.outputs=[],this.volume=1,this.mode=a.MODE_OVERLAY,this.loadDefer};Video.prototype.toJSON=function(){return{rect:this.rect,loop:this.loop,outputs:this.outputs,volume:this.volume,mode:this.mode,currentTime:this.element.currentTime,paused:this.paused(),filepath:this.filepath}},Video.prototype.importFromSaveData=function(e){var t=$.Deferred();return e.filepath&&(this.setFile(e.filepath),delete e.filepath),"paused"in e&&(e.paused?this.pause():this.play()),"currentTime"in e&&this.setTime(1e3*e.currentTime),t.resolve(),this.mode=e.mode,this.setVolume(e.volume),this.setLoop(e.loop),this.setRect(e.rect),t.promise()},Video.MODE_OVERLAY=0,Video.MODE_LAYER=1,Video.canPlayInline=function(){var e=null!=navigator.userAgent.match(/iPad/i);return!(browser.isIOs&&!e)}(),Video.prototype.setFile=function(e){if(Video.canPlayInline){this.filepath=e;var t=this;return this.loadDefer=ResourceLoader.loadVideo(e,!0,this.element).done(function(e){t.setLoop(),t.setRect(),t.setVolume(),$(e).on("ended",function(){$(t).trigger("ended")})}),this.loadDefer}},Video.prototype.setVisible=function(e){if(Video.canPlayInline){var t=document.getElementsByClassName("video-wrapper")[0],r=!!this.element.parentNode;r&&!e?t.removeChild(this.element):!r&&e&&t.appendChild(this.element)}},Video.prototype.setRect=function(e){e&&(this.rect=e);var t=this;this.loadDefer&&this.loadDefer.done(function(e){e.style.marginLeft=t.rect.x+"px",e.style.marginTop=t.rect.y+"px",e.width=t.rect.width,e.height=t.rect.height})},Video.prototype.setLoop=function(e){if(void 0!==e&&(this.loop=e),this.loadDefer){var t=this;this.loadDefer.done(function(e){e.loop=t.loop})}},Video.prototype.setPlaybackRate=function(e){this.loadDefer&&this.loadDefer.done(function(t){t.playbackRate=e})},Video.prototype.setVolume=function(e){if(void 0!==e&&(this.volume=e),this.loadDefer){var t=this;this.loadDefer.done(function(e){e.volume=t.volume})}},Video.prototype.setMode=function(){},Video.prototype.play=function(e){e&&this.setFile(e),this.element.play()},Video.prototype.pause=function(){this.element.pause()},Video.prototype.paused=function(){return!this.element||(!this.loadDefer||this.element.paused)},Video.prototype.stop=function(){this.pause(),this.setTime(0)},Video.prototype.setTime=function(e){this.loadDefer&&this.loadDefer.done(function(t){try{t.currentTime=e/1e3}catch(r){$(t).one("loadedmetadata",function(){t.currentTime=e/1e3})}})},Video.prototype.dummyLoad=function(){this.element.src="x",this.element.load()},Tag.actions.video=new TagAction({rules:{slot:{type:"INT",defaultValue:0},visible:{type:"BOOLEAN"},left:{type:"INT"},top:{type:"INT"},width:{type:"INT"},height:{type:"INT"},loop:{type:"BOOLEAN"},position:{type:"INT"},frame:{type:"INT"},mode:{type:/overlay|layer/i},playrate:{type:"FLOAT"},volume:{type:"FLOAT"}},action:function(e){var t=o2.videos[e.slot];if(!t)return this.error("ビデオスロット "+e.slot+" が存在しません"),0;"visible"in e&&t.setVisible(e.visible);var r=!1;return"left"in e&&(t.rect.x=e.left,r=!0),"top"in e&&(t.rect.y=e.top,r=!0),"width"in e&&(t.rect.width=e.width,r=!0),"height"in e&&(t.rect.height=e.height,r=!0),r&&t.setRect(),"loop"in e&&t.setLoop(e.loop),"position"in e&&t.setTime(e.position),"mode"in e&&("layer"==e.mode?t.setMode(Video.MODE_LAYER):t.setMode(Video.MODE_OVERLAY)),"playrate"in e&&t.setPlaybackRate(e.playrate),"volume"in e&&t.setVolume(e.volume/100),0}}),Tag.actions.videolayer=new TagAction({rules:{slot:{type:"INT",defaultValue:0},channel:{type:/1|2/,required:!0},page:{type:/fore|back/,required:!0},layer:{type:"LAYER",required:!0}},action:function(e){var t=o2.videos[e.slot];return t?(t.outputs[e.channel]=e.layer[e.page],0):(this.error("ビデオスロット "+e.slot+" が存在しません"),0)}}),Tag.actions.openvideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0},storage:{type:"STRING",required:!0}},action:function(e){var t=o2.videos[e.slot];if(!t)return this.error("ビデオスロット "+e.slot+" が存在しません"),0;try{t.setFile(e.storage)}catch(r){this.error(r)}return 0}}),Tag.actions.preparevideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(e){var t=this;return renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){t.done()})}),1}}),Tag.actions.playvideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0},storage:{type:"STRING"}},action:function(e){var t=o2.videos[e.slot];if(!t)return this.error("ビデオスロット "+e.slot+" が存在しません"),0;try{t.play(e.storage)}catch(r){this.error(r)}return 0}}),Tag.actions.pausevideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(e){var t=o2.videos[e.slot];return t?(t.pause(),0):(this.error("ビデオスロット "+e.slot+" が存在しません"),0)}}),Tag.actions.resumevideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(e){var t=o2.videos[e.slot];return t?(t.play(),0):(this.error("ビデオスロット "+e.slot+" が存在しません"),0)}}),Tag.actions.stopvideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(e){var t=o2.videos[e.slot];return t?(t.stop(),0):(this.error("ビデオスロット "+e.slot+" が存在しません"),0)}}),Tag.actions.rewindvideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(e){var t=o2.videos[e.slot];return t?(t.setTime(0),0):(this.error("ビデオスロット "+e.slot+" が存在しません"),0)}}),Tag.actions.wv=new TagAction({
rules:{slot:{type:"INT",defaultValue:0},canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(e){var t=o2.videos[e.slot];if(!t)return this.error("ビデオスロット "+e.slot+" が存在しません"),0;if(t.paused())return 0;if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return t.stop(),0;this.conductor.wait("click",function(){t.stop()})}var r=this;return $(t).on("ended",function(){r.done()}),1}}),Object.defineProperty(Object.prototype,"objectToBeSerialized",{enumerable:!1,writable:!0,value:function(e){return this[e]}}),Object.defineProperty(Object.prototype,"toJSON",{enumerable:!1,writable:!0,value:function s(){var e=this instanceof Array?[]:{};for(var t in this){var s=this.objectToBeSerialized(t);void 0!==s&&"function"!=typeof s&&(e[t]=s)}return e}}),function(){var e=[],t=[];Object.defineProperty(Object.prototype,"importFromSaveData",{enumerable:!1,writable:!0,value:function(r){var n=[],i=this;for(var o in r)!function(o){var a=i[o],s=r[o];if(e.push(o),"object"==("undefined"==typeof a?"undefined":_typeof(a))&&null!==a){var c=a.importFromSaveData(s);c&&(c.stackName=e.join(">"),n.push(c),t.push(c),c.done(function(){t.splice(t.indexOf(c,1))}))}else void 0!=s&&n.push($.when(s.restore()).done(function(e){i[o]=e}));e.pop()}(o);return $.when.apply($,n).then(function(){return i})}})}(),Object.defineProperty(Object.prototype,"restore",{enumerable:!1,writable:!0,value:function(){var e=this.initializer;if(e||(Array.isArray(this)?e="Array":this instanceof Object&&(e="Object")),e){var t=e.split("."),r=window;if(t.forEach(function(e){r=r[e]}),"function"==typeof r){if(r.restore!==Object.prototype.restore)return r.restore(this);var n=new r;return n.importFromSaveData(this)}}return this}});var loadSystemStateFromServer,saveCurrentSystemState,saveCurrentState;!function(){function e(){var e=JSON.stringify({o2:o2,f:f,mp:mp,conductor:conductor},function(e,t){var r=Object.prototype.toString.apply(t);return/\[object HTML[A-Za-z]*Element\]/.test(r)?void 0:"function"==typeof t?void 0:t});return e}function t(e){var t=document.createElement("canvas"),r=Math.min(config.scWidth,e),n=r/config.scWidth*config.scHeight;return t.width=r,t.height=n,t.getContext("2d").drawImage(renderer.foreCanvas,0,0,config.scWidth,config.scHeight,0,0,r,n),t.toDataURL()}var r,n=0;$(function(){$(o2).on("init",function(){$([conductor,extraConductor]).on("ran",function(e,t){0!=t&&saveCurrentSystemState()}),o2.serverStat.mode==o2.SERVER_MODE_O2SERVER?$(o2).on("systeminit.loggedin",function(){loadSystemStateFromServer()}):o2.serverStat.mode==o2.SERVER_MODE_STANDALONE&&loadSystemStateFromServer()})});var i=function(){};i.prototype={setItem:function(e,t){try{return localStorage[e]=t,$.Deferred().resolve()}catch(r){return $.Deferred().reject("localStorageの容量を超えました。"+r)}},getItem:function(e){return $.Deferred().resolve(localStorage[e])},deleteItem:function(e){return $.Deferred().resolve(delete localStorage[e])},setGlobalSaveData:function(e){var t=config.gameID+"_sf";return this.setItem(t,e)},getGlobalSaveData:function(){var e=$.Deferred(),t=config.gameID+"_sf";return this.getItem(t).then(function(t){var r;try{r=JSON.parse(t)}catch(n){return $.Deferred().reject(n)}for(var i=Object.keys(localStorage),o=new RegExp(config.gameID+"_([0-9]+)"),a={},s=0;s<i.length;s++){var c=i[s].match(o);c&&i[s]+"_date"in localStorage&&i[s]+"_caption"in localStorage&&(a[c[1]]={date:new Date(1e3*localStorage.getItem(i[s]+"_date")),caption:localStorage.getItem(i[s]+"_caption"),snapshot:localStorage.getItem(i[s]+"_screen")})}return e.resolve(r,a)})},setSaveData:function(e,t){e=config.gameID+"_"+e;var r=e+"_caption",n=e+"_date",i=e+"_screen";return $.when(this.setItem(e,t.data),this.setItem(r,t.caption),this.setItem(n,t.date),t.snapshot?this.setItem(i,t.snapshot):null)},getSaveData:function(e){return e=config.gameID+"_"+e,this.getItem(e)},deleteSaveData:function(e){e=config.gameID+"_"+e;var t=e+"_caption",r=e+"_date",n=e+"_screen";return $.when(this.deleteItem(e),this.deleteItem(t),this.deleteItem(r),this.deleteItem(n))}};var o=function(){this.lastSentSystemStringTime=0,this.timerDefer,this.scheduledTimer,this.minimumRequestInterval=1e4};o.prototype=Object.create(i.prototype),$.extend(o.prototype,{setGlobalSaveData:function(e){function t(){return $.post(o2.serverStat.saveServer+"/api/1.2/globaldata/save.php",{sysvars:a,novel:config.gameID,key:o2.serverStat.skey,uid:o2.serverStat.uid})}if(o2.serverStat.uid==-1||this.waitingForSystemString)return $.Deferred().reject();if(Date.now()-this.lastSentSystemStringTime>this.minimumRequestInterval)return this.lastSentSystemStringTime=Date.now(),t();var r=function(e){var t=$.Deferred();return setTimeout(function(){t.resolve()},e),t.promise()},n=this;return this.scheduledTimer||(this.timerDefer=$.Deferred().resolve().then(function(){return r(n.lastSentSystemStringTime+n.minimumRequestInterval-Date.now())}).then(function(){return t()}).done(function(){n.timerDefer=null,n.scheduledTimer=null,n.lastSentSystemStringTime=Date.now()})),this.timerDefer.promise()},getGlobalSaveData:function(e){if(o2.serverStat.uid==-1)return $.Deferred().reject();this.waitingForSystemString=!0;var t=this;return $.post(o2.serverStat.saveServer+"/api/1.2/globaldata/load.php",{novel:config.gameID,key:o2.serverStat.skey,uid:o2.serverStat.uid}).then(function(e){if("string"==typeof e&&(e=JSON.parse(e)),"ok"!==e.result)return $.Deferred().reject(e.reason);if("string"==typeof e.sysvars)try{e.sysvars=JSON.parse(e.sysvars)}catch(t){return $.Deferred().reject(t)}var r={};if("sindex"in e)for(var n=0;n<e.sindex.length;n++){var i=e.sindex[n];r[i.save_id]={date:new Date(1e3*i.updated_at),caption:i.caption,snapshot:i.screen}}return $.Deferred().resolve(e.sysvars,r)}).always(function(){t.waitingForSystemString=!1})},setSaveData:function(e,t){return $.when(Renderer.askForLogin()).then(function(){return $.post(o2.serverStat.saveServer+"/api/1.2/savedata/save.php",{uid:o2.serverStat.uid,novel:config.gameID,sindex:e,data:t.data,key:o2.serverStat.skey,screen:t.snapshot||"1",caption:t.caption})})},getSaveData:function(e){return Renderer.askForLogin().then(function(){return $.post(o2.serverStat.saveServer+"/api/1.2/savedata/load.php",{uid:o2.serverStat.uid,novel:config.gameID,sindex:e,key:o2.serverStat.skey})}).then(function(e){return"ok"!==e.result?$.Deferred().reject(e.reason):("string"==typeof e&&(e=JSON.parse(e)),e.data)})},deleteSaveData:function(e){return $.when(Renderer.askForLogin()).then(function(){return $.post(o2.serverStat.saveServer+"/api/1.2/savedata/erase.php",{uid:o2.serverStat.uid,novel:config.gameID,sindex:e,key:o2.serverStat.skey})})}}),loadSystemStateFromServer=function(){return o2.currentSaveAdapter.getGlobalSaveData().done(function(e,t){if(e){window.sf=mergeObj(e,sf);for(var r in t){var n=t[r];ev.save.date[r]=n.date,ev.save.caption[r]=n.caption,ev.save.snapshot[r]=n.snapshot}o2.setSeGVolume(),o2.setBgmGVolume()}})};var a;saveCurrentSystemState=function(){var e=$.Deferred();try{a=JSON.stringify(window.sf)}catch(t){o2.error("システム変数を保存できない。")}return r==a?e.reject():o2.currentSaveAdapter.setGlobalSaveData(a).done(function(){r=a})},saveCurrentState=function(r){return Tag.actions.save.stateString=e(),!n&&config.saveThumbnail&&(Tag.actions.save.stateScreenShot=t(config.thumbnailWidth)),void 0!=r&&(Tag.actions.save.stateCaption=r),Tag.actions.save.stateString},Tag.actions.save=new TagAction({rules:{place:{type:"INT",defaultValue:0},ask:{type:"BOOLEAN",defaultValue:!1}},action:function(e){if(void 0==Tag.actions.save.stateString)return config.saveMode==o2.SAVE_MODE_KAG3?o2.warn("一度もセーブ可能なラベルを通過していない状態でセーブを行おうとしました"):config.saveMode==o2.SAVE_MODE_O2KAG&&o2.warn("一度も o2_savestat タグが実行されていない状態でセーブを行おうとしました"),0;if(e.ask&&!confirm("本当にセーブしますか？"))return 0;n||(Tag.actions.save.stateScreenShot=t(config.thumbnailWidth)),ev.save.date[e.place]=new Date,ev.save.caption[e.place]=Tag.actions.save.stateCaption,ev.save.snapshot[e.place]=Tag.actions.save.stateScreenShot;var r=this;return Tag.actions.save.processForSlot(e.place).always(function(){setTimeout(function(){r.done()})}).fail(function(e){o2.warn("書き込みに失敗しました: "+e)}),1},processForSlot:function(e){return o2.currentSaveAdapter.setSaveData(e,{data:Tag.actions.save.stateString,caption:Tag.actions.save.stateCaption,date:Date.now()/1e3,snapshot:Tag.actions.save.stateScreenShot})},adapters:{LocalAdapter:i,O2ServerAdapter:o}}),Tag.actions.save.stateString=void 0,Tag.actions.save.stateCaption="",Tag.actions.save.stateScreenShot=void 0,Tag.actions.o2_savestat=new TagAction({rules:{caption:{type:"STRING"}},action:function(e){if(config.saveMode==o2.SAVE_MODE_KAG3)return this.warn("セーブモードがKAG3モードの時にo2_savestatタグを実行することはできません"),0;if(conductor.stack.length)return this.error("[->]のタグ内はセーブできないです。"),0;var t=this;return renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){saveCurrentState(e.caption),t.done()})}),1}}),Tag.actions.load=new TagAction({rules:{place:{type:"INT",defaultValue:0},ask:{type:"BOOLEAN",defaultValue:!1}},action:function(e){if(e.ask&&!confirm("本当にロードしますか？"))return 0;var t=this;return o2.currentSaveAdapter.getSaveData(e.place).then(Tag.actions.load.processData).done(function(t){Tag.actions.load.applyDeserializedData(t).done(function(){setTimeout(function(){Tag.actions.save.stateString=t,Tag.actions.save.stateCaption=ev.save.caption[e.place],Tag.actions.save.stateScreenShot=ev.save.snapshot[e.place],currentConductor!=conductor&&currentConductor.reset(),currentConductor=conductor,o2.refreshRendererLayers(),conductor.oneShot()})})}).fail(function(){o2.warn("読み込みに失敗しました"),t.done()}),1},processData:function(e){return e},applyDeserializedData:function(e){$("body").css("pointer-events","none"),renderer.animator.pause(),conductor.pause();var t=JSON.parse(e),r=t.conductor;delete t.conductor,window.f={};var n=window.importFromSaveData(t).then(function(){return conductor.importFromSaveData(r)}).done(function(){o2.allLayers().forEach(function(e){e.redrawRect()}),o2.setSeGVolume(),o2.setBgmGVolume(),$("body").css("pointer-events","auto"),renderer.animator.resume(),conductor.resume()});return n}}),Tag.actions.locksnapshot=new TagAction({action:function(e){return 0==n&&(Tag.actions.save.stateScreenShot=t(config.thumbnailWidth)),n++,0}}),Tag.actions.unlocksnapshot=new TagAction({action:function(){return n--,n<0&&this.error("unlocksnapshotの回数はlocksnapshotより多いです。"),0}}),Tag.actions.erasebookmark=new TagAction({rules:{place:{type:"INT",defaultValue:0}},action:function(e){delete ev.save.date[e.place],delete ev.save.caption[e.place],delete ev.save.snapshot[e.place];var t=this;return o2.currentSaveAdapter.deleteSaveData(e.place).always(function(){setTimeout(function(){t.done()})}),1}})}(),Tag.actions.animstart=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},seg:{type:"INT",required:!0},target:{type:"STRING"}},action:function(e){var t=e.layer[e.page];if(!t.images[0]||!t.images[0].image)return this.warn("layerに画像がないです。"),0;var r=t.images[0].image.originalURL,n=_KAGFiles(r+".asd"),i=this;return $.when(n).then(function(n){setTimeout(function(){if(!n)return i.error(r+".asdが見つからないです。"),void i.done();var o=new AnimationConductor({file:n,label:e.target});t.addAnimationConductor(o,e.seg),o.run(),i.done()})}),1}}),Tag.actions.animstop=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},seg:{type:"INT"}},action:function(e){var t=e.layer[e.page],r=t.animationConductors[e.seg];return r?r.stopUntilHome():this.warn(e.seg+"というアニメーションセグメントが見つかりません。"),0}}),Tag.actions.wa=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},seg:{type:"INT"}},action:function(e){var t=this,r=e.layer[e.page],n=r.animationConductors[e.seg];return n?n.isLooping?0:($(n).on("ran",function(e,r){2==r&&t.done()}),1):(this.warn(e.seg+"というアニメーションセグメントが見つかりません。"),0)}}),function(){var e;Tag.actions.o2_geo_watch=new TagAction({action:function(t){return e?0:(e=navigator.geolocation.watchPosition(function(e){ev.geo=e}),0)}}),Tag.actions.o2_geo_endwatch=new TagAction({action:function(t){return navigator.geolocation.clearWatch(e),e=void 0,0}}),Tag.actions.o2_geo_get=new TagAction({action:function(e){function t(e){ev.geo=e,n.done()}function r(){n.done()}var n=this;return navigator.geolocation.getCurrentPosition(t,r),0}}),Tag.actions.o2_geo_wg=new TagAction({rules:{canskip:{type:"BOOLEAN"}},action:function(e){return e.canskip&&this.conductor.wait("click"),this.conductor.wait("o2_geo_get"),1}})}(),Tag.actions.clearsysvar=new TagAction({action:function(){return window.sf={},0}}),Tag.actions.clearvar=new TagAction({action:function(){window.f={}}}),Tag.actions.glyph=new TagAction({rules:{line:{type:"STRING"},page:{type:"STRING"},fix:{type:"BOOLEAN"},left:{type:"FLOAT"},top:{type:"FLOAT"}},action:function(e){var t={fix:"fixed",left:"x",top:"y"};for(var r in e){var n=t[r]||r;o2.currentMessageLayer.glyphOptions[n]=e[r]}return 0}}),Tag.actions.o2_loadplugin=new TagAction({rules:{module:{type:"STRING",required:!0}},action:function(e){var t=this,r=document.createElement("script");return r.onload=function(){t.done()},r.onerror=function(){t.error("プラグインファイル "+e.module+" をロードできません")},r.src="./plugin/"+e.module,document.getElementsByTagName("head")[0].appendChild(r),1}}),Tag.actions.o2_sysbutton=new TagAction({rules:{graphic:{type:"STRING",required:!0},graphickey:{type:"COLOR",allowString:["adapt"]},storage:{type:"STRING"},target:{type:"STRING"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},o2_exp:{type:"STRING"},o2_onenter:{type:"STRING"},o2_onleave:{type:"STRING"},id:{type:"STRING",required:!0}},action:function(e){var t=this;return ResourceLoader.loadImage(e.graphic).done(function(r){setTimeout(function(){var n=o2.currentMessageLayer.textCursor,i=new RoutineButton(r,n.x,n.y);i.importFromKAGArgs(e),o2.currentMessageLayer.addRoutineButton(i),t.done()})}),1}}),Tag.actions.o2_updatesysbutton=new TagAction({rules:{id:{type:"STRING",required:!0},enabled:{type:"BOOLEAN"}},action:function(e){for(var t=0;t<o2.currentMessageLayer.routineButtons.length;t++){var r=o2.currentMessageLayer.routineButtons[t];if(r.tagArgs.id==e.id){r.enabled=e.enabled;break}}return 0}}),Tag.actions.o2_deletesysbutton=new TagAction({rules:{id:{type:"STRING",required:!0}},action:function(e){for(var t=0;t<o2.currentMessageLayer.routineButtons.length;t++){var r=o2.currentMessageLayer.routineButtons[t];if(r.tagArgs.id==e.id){o2.currentMessageLayer.routineButtons.splice(t,1),o2.currentMessageLayer.redrawRect(r.rect);break}}return 0}});var RoutineButton=function(e,t,r){Button.call(this,e,t,r),this.rect.width=Math.floor(this.rect.width/4),this.options.clipLeft=0,this.options.clipWidth=this.rect.width,this.tagArgs,this.enabled=!0,this.activated=!0};RoutineButton.prototype=Object.create(Button.prototype),RoutineButton.prototype.initializer="RoutineButton",RoutineButton.prototype.clone=function(){var e=new RoutineButton(this.image);return e.importFrom(this),e},RoutineButton.prototype.drawOnContext=function(e,t){switch(this.state){case Button.STATE_DISABLE:this.options.clipLeft=3*this.rect.width;break;case Button.STATE_HOVER:this.options.clipLeft=2*this.rect.width;break;case Button.STATE_DOWN:this.options.clipLeft=this.rect.width;break;case Button.STATE_NORMAL:default:this.options.clipLeft=0}this.enabled||(this.options.clipLeft=3*this.rect.width),Button.prototype.drawOnContext.apply(this,arguments)},RoutineButton.prototype.importFromKAGArgs=function(e){this.tagArgs=clone(e),this.click=function(t,r,n){if(Button.prototype.click.apply(this,arguments),this.activated&&this.enabled&&(e.o2_exp&&(0,eval)(e.o2_exp),e.o2_url&&window.open(e.o2_url,e.o2_urltarget),e.storage||e.target)){extraConductor.setFile(conductor.file),currentConductor=extraConductor;var i=new Tag("jump",{storage:e.storage,target:e.target});extraConductor.queue.push(i)}},e.o2_onenter&&(this.enter=function(){Button.prototype.enter.apply(this,arguments),(0,eval)(e.o2_onenter)}),e.o2_onleave&&(this.leave=function(){Button.prototype.leave.apply(this,arguments),(0,eval)(e.o2_onleave)})},RoutineButton.prototype.importFrom=function(e){Button.prototype.importFrom.call(this,e),e.tagArgs&&this.importFromKAGArgs(e.tagArgs)},RoutineButton.prototype.importFromSaveData=function(e){Button.prototype.importFromSaveData.call(this,e),e.tagArgs&&this.importFromKAGArgs(e.tagArgs)},RoutineButton.prototype.toJSON=function(){var e=Button.prototype.toJSON.call(this);return e.tagArgs=this.tagArgs,e},RoutineButton.restore=function(e){return $.when(ResourceLoader.loadImage(e.image,!0)).then(function(t){var r=new RoutineButton(t);return r.importFromSaveData(e),r})};var RoutineLink;!function(){RoutineLink=function(){Link.call(this),this.tagArgs},RoutineLink.prototype=Object.create(Link.prototype),RoutineLink.prototype.initializer="RoutineLink",RoutineLink.restore=function(e){var t=new RoutineLink;return t.importFromKAGArgs(e.tagArgs),delete e.tagArgs,Link.prototype.importFromSaveData(e),t},RoutineLink.prototype.importFrom=function(e){Link.prototype.importFrom.call(this,e),this.importFromKAGArgs(e.tagArgs)},RoutineLink.prototype.importFromKAGArgs=function(e){this.tagArgs=e,this.click=function(t,r,n){if(Link.prototype.click.apply(this,arguments),"o2_exp"in e&&(0,eval)(e.o2_exp),"o2_url"in e&&window.open(e.o2_url,e.o2_urltarget),e.storage||e.target){extraConductor.setFile(conductor.file),currentConductor=extraConductor;var i=new Tag("jump",{storage:e.storage,target:e.target});extraConductor.queue.push(i)}},"o2_onenter"in e&&(this.enter=function(){Link.prototype.enter.apply(this,arguments),(0,eval)(e.o2_onenter)}),"o2_onleave"in e&&(this.leave=function(){Link.prototype.leave.apply(this,arguments),(0,eval)(e.o2_onleave)})};var e=0,t={};Tag.actions.o2_syslink=new TagAction({rules:{storage:{type:"STRING"},target:{type:"STRING"},color:{type:"COLOR"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},o2_onenter:{type:"STRING"},o2_onleave:{type:"STRING"},o2_exp:{type:"STRING"}},action:function(r){return e=o2.currentMessageLayer.textsProperties.length,t=r,0}}),Tag.actions.o2_endsyslink=new TagAction({action:function(r){var n=new RoutineLink;n.importFromKAGArgs(t),n.vertical=o2.currentMessageLayer.vertical;for(var i=e;i<o2.currentMessageLayer.textsProperties.length;i++)n.addTextProperties(o2.currentMessageLayer.textsProperties[i]);if(o2.currentMessageLayer.addLink(n),o2.currentMessageLayerWithBack){var o=o2.currentMessageLayer.getCorrespondingLayer();n=new RoutineLink,n.importFromKAGArgs(t),n.vertical=o.vertical;for(var a=e;a<o.textsProperties.length;a++)n.addTextProperties(o.textsProperties[a]);o.addLink(n)}return 0}})}(),Tag.actions.o2_enterskip=new TagAction({action:function(){return o2.skipToStop(),0}}),Tag.actions.o2_forcibleskip=new TagAction({action:function(){return o2.skipToStopForcibly(),0}}),Tag.actions.o2_enterautomode=new TagAction({action:function(){return o2.enterAutoMode(),0}}),Tag.actions.cancelskip=new TagAction({action:function(e){return o2.skipMode=o2.SKIP_MODE_NONE,0}}),Tag.actions.cancelautomode=new TagAction({action:function(e){return o2.cancelAutoMode(),0}}),function(){var e={};Tag.actions.listengesture=new TagAction({rules:{id:{type:"STRING",required:!0},mode:{type:/delta|accumulate|absolute|longtap/,defaultValue:"accumulate"},mutualexclusive:{type:"BOOLEAN",defaultValue:!0},minx:{type:"INT"},maxx:{type:"INT"},miny:{type:"INT"},maxy:{type:"INT"},duration:{type:"INT",defaultValue:1e3},maxmove:{type:"INT",defaultValue:10}},action:function(t){if(!this.isOpen())return void this.error("openタグじゃないとダメです");if(t.id in e)return void this.error(t.id+"はすでに定義されてる");var r=this,n=function(){for(var e=new Conductor({file:r.getCallbackFile()}),t=[],n=0;n<arguments.length;n++)t.push(arguments[n]);t=r.makeScopeVars(t),e.callbackVarsStack.push(t),e.run()},i=function(){switch(t.mode){case"accumulate":return GestureRecognizer.accumulateRecognizer(t.minx,t.maxx,t.miny,t.maxy,n);case"delta":return GestureRecognizer.basicRecognizer("delta",n);case"absolute":return GestureRecognizer.basicRecognizer("absolute",n);case"longtap":return GestureRecognizer.longTapRecognizer(t.duration,t.maxmove,n)}}();return i.mutualExclusive=t.mutualexclusive,GestureManager.addRecognizer(i),e[t.id]=i,0},closeAction:function(e){return 0}}),Tag.actions.unlistengesture=new TagAction({rules:{id:{type:"STRING",required:!0}},action:function(t){var r=e[t.id];return GestureManager.removeRecognizer(r),delete e[t.id],0}})}(),window.location.hostname&&!function(){var e=window.location.hostname.split(".");e.length>2&&(document.domain=e.splice(-(e.length-1)).join("."))}();var defaultConfig={title:["string","untitled"],gameID:["string","mygame"],scWidth:["number",800],scHeight:["number",600],numMessageLayers:["number",2],numImageLayers:["number",2],backgroundColor:["color","0xeeeeee"],chSpeeds:["number",40],userCh2ndSpeed:["number",-1],numSEBuffers:["number",2],numMovies:["number",1],scPositionX_left:["number",0],scPositionX_left_center:["number",0],scPositionX_center:["number",0],scPositionX_right_center:["number",0],scPositionX_right:["number",0],initialMessageLayerVisible:["boolean",!1],messageLayerColor:["color","0x000000"],messageLayerOpacity:["opacity",190],messageLayerMarginT:["number",6],messageLayerMarginL:["number",6],messageLayerMarginR:["number",6],messageLayerMarginB:["number",6],messageLayerCurrentPositionX:["number",10],messageLayerCurrentPositionY:["number",60],messageLayerCurrentWidth:["number",480],messageLayerCurrentHeight:["number",35],messageLayerDefaultAutoReturn:["boolean",!0],messageLayerDefaultFontSize:["number",12],messageLayerDefaultFontFace:["string","ＭＳ Ｐゴシック"],messageLayerDefaultFontColor:["color","0xFFFFFF"],messageLayerDefaultFontBold:["boolean",!1],messageLayerDefaultFontItalic:["boolean",!1],messageLayerDefaultStyleLineSpacing:["number",6],messageLayerDefaultStylePitch:["number",0],messageLayerDefaultGlyphLine:["string","linebreak"],messageLayerDefaultGlyphPage:["string","pagebreak"],messageLayerDefaultGlyphFixed:["boolean",!1],messageLayerDefaultGlyphX:["number",0],messageLayerDefaultGlyphY:["number",0],messageLayerDefaultLinkColor:["color","0x0000ff"],messageLayerDefaultLinkOpacity:["opacity",64],messageLayerVertical:["boolean",!1],messageLayerDefaultRubySize:["number",10],messageLayerDefaultRubyOffset:["number",-2],messageLayerDefaultShadow:["boolean",!0],messageLayerDefaultShadowBlur:["number",3],messageLayerDefaultShadowOffsetX:["number",0],messageLayerDefaultShadowOffsetY:["number",0],messageLayerDefaultShadowColor:["color","0x000000"],messageLayerDefaultEdge:["boolean",!1],messageLayerDefaultEdgeColor:["color","0x000000"],historyLayerFontFace:["string","ＭＳ Ｐゴシック"],historyLayerFontColor:["color","0xFFFFFF"],historyLayerFontBold:["boolean",!1],historyLayerFontHeight:["number",24],historyLayerLineHeight:["number",26],historyLayerEverypage:["boolean",!1],historyLayerMaxPages:["number",30],historyLayerMaxLines:["number",20],historyLayerStoreState:["boolean",!1],historyLayerColor:["color","0x000000"],historyLayerOpacity:["opacity",255],historyLayerFrame:["string",""],historyLayerMarginT:["number",30],historyLayerMarginL:["number",30],historyLayerMarginR:["number",30],historyLayerMarginB:["number",30],historyLayerCurrentPositionX:["number",10],historyLayerCurrentPositionY:["number",10],historyLayerCurrentWidth:["number",300],historyLayerCurrentHeight:["number",300],historyLayerVertical:["string","auto"],historyLayerShadow:["boolean",!0],historyLayerShadowColor:["color","0x000000"],historyLayerShadowBlur:["number",3],historyLayerShadowOffsetX:["number",0],historyLayerShadowOffsetY:["number",0],historyLayerEdge:["boolean",!1],historyLayerEdgeColor:["color","0x000000"],historyLayerFrameFixed:["boolean",!1],cursorDefault:["string","auto"],cursorPointed:["string","pointer"],cursorWaitingClick:["string","auto"],cursorDraggable:["string","auto"],saveMode:["string","o2kag"],priorityAudioChannel:["string","bgm"],saveThumbnail:["boolean",!1],thumbnailWidth:["number",128],autoModePageWait:["number",350],autoModeLineWait:["number",50],chNonStopToPageBreak:["boolean",!1],ch2ndNonStopToPageBreak:["boolean",!1],numImageCache:["number",-1],numScriptCache:["number",5],preload:["boolean",!0],forcePreloadSoundAndVideoInIOS:["boolean",!0]},config={},mp={},tf={},sf={__system:{seGVolume:1,bgmGVolume:1,chSpeed:40,useUserChSpeed:!0,userChSpeed:40,userCh2ndSpeed:-1,autoModeLineWait:50,autoModePageWait:350}},f={},ev={query:function(){function e(e){return decodeURIComponent((new RegExp("[?|&]"+e+"=([^&;]+?)(&|#|;|$)").exec(location.search)||["",""])[1].replace(/\+/g,"%20"))||null}for(var t={},r=window.location.search.substring(1),n=r.split("&"),i=0;i<n.length;i++){var o=n[i].split("=");!o.length||1==o.length&&""==o[0]||(2==o.length?t[o[0]]=e(o[0]):t[o[0]]=!0)}return t}(),save:{date:{},caption:{},snapshot:{}},cursorLocation:{x:0,y:0},ua:navigator.userAgent,lang:navigator.language?navigator.language:navigator.userLanguage,hostname:location.hostname,lastimage:{},enginever:"2.3.0",enginebuild:"71733ff"},o2={foreLayers:{baseLayer:void 0,imageLayers:[],messageLayers:[]},backLayers:{baseLayer:void 0,imageLayers:[],messageLayers:[]},currentMessageLayer:void 0,currentMessageLayerWithBack:!1,allForeLayers:function(){return[this.foreLayers.baseLayer].concat(this.foreLayers.imageLayers).concat(this.foreLayers.messageLayers)},allBackLayers:function(){return[this.backLayers.baseLayer].concat(this.backLayers.imageLayers).concat(this.backLayers.messageLayers)},allLayers:function(){return this.allBackLayers().concat(this.allForeLayers())},autoHideLayers:function(){return this.foreLayers.messageLayers.concat(this.backLayers.messageLayers).concat(this.extraAutoHideLayers)},refreshRendererLayers:function(){function e(e,t){return e.index-t.index}renderer.foreLayers=this.allForeLayers().sort(e),renderer.backLayers=this.allBackLayers().sort(e)},resetLayersIndex:function(){for(var e=0;e<o2.foreLayers.imageLayers.length;e++)o2.foreLayers.imageLayers[e].index=1e3*(e+1),o2.backLayers.imageLayers[e].index=1e3*(e+1);for(var t=0;t<o2.foreLayers.messageLayers.length;t++)o2.foreLayers.messageLayers[t].index=1e6+1e3*(t+1),o2.backLayers.messageLayers[t].index=1e6+1e3*(t+1)},extraAutoHideLayers:[],imageList:[],soundList:[],videoList:[],fontList:[],webFontList:[{name:"Noto Sans TC",weight:400,url:"https://fonts.gstatic.com/ea/notosanstc/v1/NotoSansTC-Regular"},{name:"Noto Sans TC",weight:700,url:"https://fonts.gstatic.com/ea/notosanstc/v1/NotoSansTC-Bold"}],config:{scriptTagNameKey:"name",scriptTagArgsKey:"args",scriptTagLineKey:"line",scriptTagCharKey:"char"},se:[],setSeGVolume:function(e){void 0!==e&&(sf.__system.seGVolume=e),this.se.forEach(function(e){e.volumePercentage=sf.__system.seGVolume,e.setVolume(e.volume)})},setBgmGVolume:function(e){void 0!==e&&(sf.__system.bgmGVolume=e),o2.bgm.volumePercentage=sf.__system.bgmGVolume,o2.bgm.setVolume(o2.bgm.volume)},bgm:browser.usesWebAudio?new WebAudioSound:new Sound,prioritySound:void 0,videos:[],currentSaveAdapter:new Tag.actions.save.adapters.LocalAdapter,skipMode:0,clickSkipEnabled:!0,skipWithMode:function(e){o2.skipMode=e,currentConductor.trigger("click")||currentConductor.status===Conductor.STATUS_WAIT&&0==Object.keys(currentConductor.waitTag).length&&currentConductor.oneShot()},skipToClick:function(){this.skipWithMode(o2.SKIP_MODE_CLICK)},skipToPage:function(){this.skipWithMode(o2.SKIP_MODE_PAGE)},skipToStop:function(){currentConductor.isCurrentRead()&&this.skipWithMode(o2.SKIP_MODE_UNREAD)},skipToStopForcibly:function(){this.skipWithMode(o2.SKIP_MODE_STOP)},autoMode:!1,enterAutoMode:function(){this.autoMode=!0,currentConductor.trigger("click")||currentConductor.status!=Conductor.STATUS_STOP&&0==Object.keys(currentConductor.waitTag).length&&currentConductor.oneShot()},cancelAutoMode:function(){this.autoMode=!1},reloadDelaySpeed:function(){var e=sf.__system.chSpeed;sf.__system.useUserChSpeed&&(currentConductor.isCurrentRead()&&"userCh2ndSpeed"in sf.__system&&sf.__system.userCh2ndSpeed!=-1?e=sf.__system.userCh2ndSpeed:"userChSpeed"in sf.__system&&(e=sf.__system.userChSpeed));for(var t=o2.foreLayers.messageLayers.concat(o2.backLayers.messageLayers),r=t.length-1;r>=0;r--)t[r].delaySpeed=e},historyLayer:void 0,glyphLayer:void 0,showGlyph:function(e){e=e||"line",this.currentMessageLayer.showGlyphLayer(this.glyphLayer,e)},hideGlyph:function(){this.currentMessageLayer.hideGlyphLayer()},debugLevel:1,serverStat:{mode:0,key:ev.query.key||null,uid:ev.query.uid||-1,userServer:"https://novelsphere.jp",saveServer:"/",skey:ev.query.skey||null},setServerStat:function(e){o2.serverStat.key=e.key,o2.serverStat.uid=e.uid,o2.serverStat.userServer=e.userServer,o2.serverStat.skey=e.skey,e.saveServer&&(o2.serverStat.saveServer=e.saveServer)},printLog:function(e){if(void 0==e&&(e=o2.DEBUG_LEVEL_LOG),e>o2.debugLevel)return function(){};switch(e){case o2.DEBUG_LEVEL_ERROR:return console.error;case o2.DEBUG_LEVEL_CAUTION:return console.warn;case o2.DEBUG_LEVEL_LOG:return console.log}return function(){}},log:function(){return o2.printLog(o2.DEBUG_LEVEL_LOG).apply(console,arguments)},warn:function(){return o2.printLog(o2.DEBUG_LEVEL_CAUTION).apply(console,arguments)},error:function(){return o2.printLog(o2.DEBUG_LEVEL_ERROR).apply(console,arguments)},setCursorStyle:function(e){var t;switch(e){case"pointer":t=config.cursorPointed;break;case"waitClick":t=config.cursorWaitingClick;break;case"draggable":t=config.cursorDraggable;break;case"default":default:t=config.cursorDefault}$("body").css("cursor",t)},rclickSettings:{call:!1,jump:!1,target:void 0,storage:void 0,enabled:!0}};o2.SKIP_MODE_NONE=0,o2.SKIP_MODE_CLICK=1,o2.SKIP_MODE_PAGE=2,o2.SKIP_MODE_UNREAD=3,o2.SKIP_MODE_STOP=4,o2.SKIP_MODE_FAST_FORWARD=5,o2.DEBUG_LEVEL_OFF=0,o2.DEBUG_LEVEL_ERROR=1,o2.DEBUG_LEVEL_CAUTION=2,o2.DEBUG_LEVEL_LOG=3,o2.SERVER_MODE_STANDALONE=0,o2.SERVER_MODE_O2SERVER=1,o2.SAVE_MODE_O2KAG="o2kag",o2.SAVE_MODE_KAG3="kag3",o2.objectToBeSerialized=function(e){function t(e){var t=void 0;for(t=0;t<o2.foreLayers.messageLayers.length;t++){var r=o2.foreLayers.messageLayers[t];if(e==r)return{page:"fore",layer:t}}for(t=0;t<o2.backLayers.messageLayers.length;t++){var n=o2.backLayers.messageLayers[t];if(e==n)return{page:"back",layer:t}}}if("function"!=typeof this[e]){switch(e){case"imageList":case"soundList":case"videoList":case"config":case"serverStat":case"prioritySound":case"debugLevel":case"skipMode":case"autoMode":case"SKIP_MODE_NONE":case"SKIP_MODE_CLICK":case"SKIP_MODE_PAGE":case"SKIP_MODE_STOP":case"SKIP_MODE_UNREAD":case"SKIP_MODE_FAST_FORWARD":case"DEBUG_LEVEL_OFF":case"DEBUG_LEVEL_ERROR":case"DEBUG_LEVEL_CAUTION":case"DEBUG_LEVEL_LOG":case"SERVER_MODE_STANDALONE":case"SERVER_MODE_O2SERVER":case"SAVE_MODE_O2KAG":case"SAVE_MODE_KAG3":return;case"currentMessageLayer":return t(this.currentMessageLayer);case"autoHideLayers":return this.autoHideLayers.map(function(e){return t(e)})}return this[e]}},o2.importFromSaveData=function(e){var t=this,r=[];["foreLayers","backLayers"].forEach(function(n){["imageLayers","messageLayers"].forEach(function(i){t[n][i]=[];var o=[];r.push(o.importFromSaveData(e[n][i]).done(function(){t[n][i]=o})),delete e[n][i]})});var n=e.currentMessageLayer;return delete e.currentMessageLayer,r=r.concat(Object.prototype.importFromSaveData.call(this,e)),$.when.apply($,r).done(function(){t.currentMessageLayer=t["back"==n.page?"backLayers":"foreLayers"].messageLayers[n.layer],delete e.currentMessageLayer,t.refreshRendererLayers()})};var renderer,conductor,currentConductor,extraConductor;!function(){var e={scriptTagNameKey:0,scriptTagArgsKey:1,scriptTagCallbackArgsKey:2,scriptTagLineKey:3,scriptTagCharKey:4};"undefined"!=typeof module&&module.exports?exports.config=e:window&&window.o2&&(window.o2.config=e)}();