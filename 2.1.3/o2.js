/*//////////////////////////////////////////////////////////////////////////////
O₂ Engine  -  version 2.1.3
Date : 2013-08-06
Copyright ©2012-2013 Gengosha Inc. All rights reserved.
To use or redistribute this software, please read 
http://developer.novelsphere.jp/

This software includes undermentioned libraries.
The following license descriptions are NOT about the license of O₂ Engine itself.

*** jQuery ***
Copyright 2013 jQuery Foundation and other contributors
http://jquery.com/

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
//////////////////////////////////////////////////////////////////////////////*/
(function(a,b){function c(a){var b=a.length,l=e.type(a);return e.isWindow(a)?!1:1===a.nodeType&&b?!0:"array"===l||"function"!==l&&(0===b||"number"==typeof b&&0<b&&b-1 in a)}function d(){Object.defineProperty(this.cache={},0,{get:function(){return{}}});this.expando=e.expando+Math.random()}function g(a,t,l){var c;if(l===b&&1===a.nodeType)if(c="data-"+t.replace(cc,"-$1").toLowerCase(),l=a.getAttribute(c),"string"==typeof l){try{l="true"===l?!0:"false"===l?!1:"null"===l?null:+l+""===l?+l:dc.test(l)?JSON.parse(l):
l}catch(e){}F.set(a,t,l)}else l=b;return l}function h(){return!0}function j(){return!1}function i(){try{return x.activeElement}catch(a){}}function n(a,b){for(;(a=a[b])&&1!==a.nodeType;);return a}function p(a,b,l){if(e.isFunction(b))return e.grep(a,function(a,s){return!!b.call(a,s,a)!==l});if(b.nodeType)return e.grep(a,function(a){return a===b!==l});if("string"==typeof b){if(ec.test(b))return e.filter(b,a,l);b=e.filter(b,a)}return e.grep(a,function(a){return 0<=za.call(b,a)!==l})}function k(a,b){return e.nodeName(a,
"table")&&e.nodeName(1===b.nodeType?b:b.firstChild,"tr")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function r(a){return a.type=(null!==a.getAttribute("type"))+"/"+a.type,a}function q(a){var b=fc.exec(a.type);return b?a.type=b[1]:a.removeAttribute("type"),a}function u(a,b){for(var l=a.length,c=0;l>c;c++)z.set(a[c],"globalEval",!b||z.get(b[c],"globalEval"))}function w(a,b){var l,c,v,d,m,g;if(1===b.nodeType){if(z.hasData(a)&&(l=z.access(a),c=e.extend({},
l),g=l.events,z.set(b,c),g))for(v in delete c.handle,c.events={},g){l=0;for(c=g[v].length;c>l;l++)e.event.add(b,v,g[v][l])}F.hasData(a)&&(d=F.access(a),m=e.extend({},d),F.set(b,m))}}function y(a,t){var l=a.getElementsByTagName?a.getElementsByTagName(t||"*"):a.querySelectorAll?a.querySelectorAll(t||"*"):[];return t===b||t&&e.nodeName(a,t)?e.merge([a],l):l}function G(a,b){if(b in a)return b;for(var l=b.charAt(0).toUpperCase()+b.slice(1),c=b,e=mb.length;e--;)if(b=mb[e]+l,b in a)return b;return c}function I(a,
b){return a=b||a,"none"===e.css(a,"display")||!e.contains(a.ownerDocument,a)}function N(a,b){for(var l,c,v,d=[],m=0,g=a.length;g>m;m++)c=a[m],c.style&&(d[m]=z.get(c,"olddisplay"),l=c.style.display,b?(d[m]||"none"!==l||(c.style.display=""),""===c.style.display&&I(c)&&(d[m]=z.access(c,"olddisplay",gc(c.nodeName)))):d[m]||(v=I(c),(l&&"none"!==l||!v)&&z.set(c,"olddisplay",v?l:e.css(c,"display"))));for(m=0;g>m;m++)c=a[m],c.style&&(b&&"none"!==c.style.display&&""!==c.style.display||(c.style.display=b?d[m]||
"":"none"));return a}function S(a,b,l){return(a=hc.exec(b))?Math.max(0,a[1]-(l||0))+(a[2]||"px"):b}function K(a,b,l,c,v){for(var b=l===(c?"border":"content")?4:"width"===b?1:0,d=0;4>b;b+=2)"margin"===l&&(d+=e.css(a,l+ia[b],!0,v)),c?("content"===l&&(d-=e.css(a,"padding"+ia[b],!0,v)),"margin"!==l&&(d-=e.css(a,"border"+ia[b]+"Width",!0,v))):(d+=e.css(a,"padding"+ia[b],!0,v),"padding"!==l&&(d+=e.css(a,"border"+ia[b]+"Width",!0,v)));return d}function ba(s,b,l){var c=!0,v="width"===b?s.offsetWidth:s.offsetHeight,
d=a.getComputedStyle(s,null),m=e.support.boxSizing&&"border-box"===e.css(s,"boxSizing",!1,d);if(0>=v||null==v){if(v=pa(s,b,d),(0>v||null==v)&&(v=s.style[b]),Ta.test(v))return v;c=m&&(e.support.boxSizingReliable||v===s.style[b]);v=parseFloat(v)||0}return v+K(s,b,l||(m?"border":"content"),c,d)+"px"}function gc(a){var b=x,l=nb[a];return l||(l=ob(a,b),"none"!==l&&l||(ta=(ta||e("<iframe frameborder='0' width='0' height='0'/>").css("cssText","display:block !important")).appendTo(b.documentElement),b=(ta[0].contentWindow||
ta[0].contentDocument).document,b.write("<!doctype html><html><body>"),b.close(),l=ob(a,b),ta.detach()),nb[a]=l),l}function ob(a,b){var l=e(b.createElement(a)).appendTo(b.body),c=e.css(l[0],"display");return l.remove(),c}function Ua(a,b,l,c){var v;if(e.isArray(b))e.each(b,function(b,t){l||ic.test(a)?c(a,t):Ua(a+"["+("object"==typeof t?b:"")+"]",t,l,c)});else if(l||"object"!==e.type(b))c(a,b);else for(v in b)Ua(a+"["+v+"]",b[v],l,c)}function pb(a){return function(b,l){"string"!=typeof b&&(l=b,b="*");
var c,v=0,d=b.toLowerCase().match(X)||[];if(e.isFunction(l))for(;c=d[v++];)"+"===c[0]?(c=c.slice(1)||"*",(a[c]=a[c]||[]).unshift(l)):(a[c]=a[c]||[]).push(l)}}function qb(a,t,l,c){function v(g){var h;return d[g]=!0,e.each(a[g]||[],function(a,s){var e=s(t,l,c);return"string"!=typeof e||m||d[e]?m?!(h=e):b:(t.dataTypes.unshift(e),v(e),!1)}),h}var d={},m=a===Va;return v(t.dataTypes[0])||!d["*"]&&v("*")}function Wa(a,t){var l,c,d=e.ajaxSettings.flatOptions||{};for(l in t)t[l]!==b&&((d[l]?a:c||(c={}))[l]=
t[l]);return c&&e.extend(!0,a,c),a}function rb(){return setTimeout(function(){qa=b}),qa=e.now()}function sb(a,b,l){var c,d,B=0,m=Aa.length,g=e.Deferred().always(function(){delete h.elem}),h=function(){if(d)return!1;for(var b=qa||rb(),b=Math.max(0,i.startTime+i.duration-b),t=1-(b/i.duration||0),l=0,c=i.tweens.length;c>l;l++)i.tweens[l].run(t);return g.notifyWith(a,[i,t,b]),1>t&&c?b:(g.resolveWith(a,[i]),!1)},i=g.promise({elem:a,props:e.extend({},b),opts:e.extend(!0,{specialEasing:{}},l),originalProperties:b,
originalOptions:l,startTime:qa||rb(),duration:l.duration,tweens:[],createTween:function(b,t){var l=e.Tween(a,i.opts,b,t,i.opts.specialEasing[b]||i.opts.easing);return i.tweens.push(l),l},stop:function(b){var t=0,l=b?i.tweens.length:0;if(d)return this;for(d=!0;l>t;t++)i.tweens[t].run(1);return b?g.resolveWith(a,[i,b]):g.rejectWith(a,[i,b]),this}}),b=i.props,l=i.opts.specialEasing,k,j,p,n;for(c in b)if(k=e.camelCase(c),j=l[k],p=b[c],e.isArray(p)&&(j=p[1],p=b[c]=p[0]),c!==k&&(b[k]=p,delete b[c]),n=e.cssHooks[k],
n&&"expand"in n)for(c in p=n.expand(p),delete b[k],p)c in b||(b[c]=p[c],l[c]=j);else l[k]=j;for(;m>B;B++)if(c=Aa[B].call(i,a,b,i.opts))return c;var r=i;e.each(b,function(a,s){for(var b=(ua[a]||[]).concat(ua["*"]),t=0,l=b.length;l>t&&!b[t].call(r,a,s);t++);});return e.isFunction(i.opts.start)&&i.opts.start.call(a,i),e.fx.timer(e.extend(h,{elem:a,anim:i,queue:i.opts.queue})),i.progress(i.opts.progress).done(i.opts.done,i.opts.complete).fail(i.opts.fail).always(i.opts.always)}function O(a,b,l,c,e){return new O.prototype.init(a,
b,l,c,e)}function Ba(a,b){for(var l,c={height:a},e=0,b=b?1:0;4>e;e+=2-b)l=ia[e],c["margin"+l]=c["padding"+l]=a;return b&&(c.opacity=c.width=a),c}var tb,Ca,Da=typeof b,kc=a.location,x=a.document,ub=x.documentElement,lc=a.jQuery,mc=a.$,Ea={},Fa=[],vb=Fa.concat,Xa=Fa.push,ja=Fa.slice,za=Fa.indexOf,nc=Ea.toString,Ya=Ea.hasOwnProperty,oc="2.0.0".trim,e=function(a,b){return new e.fn.init(a,b,tb)},Ga=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,X=/\S+/g,pc=/^(?:(<[\w\W]+>)[^>]*|#([\w-]*))$/,wb=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,
qc=/^-ms-/,rc=/-([\da-z])/gi,sc=function(a,b){return b.toUpperCase()},Ha=function(){x.removeEventListener("DOMContentLoaded",Ha,!1);a.removeEventListener("load",Ha,!1);e.ready()};e.fn=e.prototype={jquery:"2.0.0",constructor:e,init:function(a,t,l){var c,d;if(!a)return this;if("string"==typeof a){if(c="<"===a.charAt(0)&&">"===a.charAt(a.length-1)&&3<=a.length?[null,a,null]:pc.exec(a),!c||!c[1]&&t)return!t||t.jquery?(t||l).find(a):this.constructor(t).find(a);if(c[1]){if(t=t instanceof e?t[0]:t,e.merge(this,
e.parseHTML(c[1],t&&t.nodeType?t.ownerDocument||t:x,!0)),wb.test(c[1])&&e.isPlainObject(t))for(c in t)e.isFunction(this[c])?this[c](t[c]):this.attr(c,t[c]);return this}return d=x.getElementById(c[2]),d&&d.parentNode&&(this.length=1,this[0]=d),this.context=x,this.selector=a,this}return a.nodeType?(this.context=this[0]=a,this.length=1,this):e.isFunction(a)?l.ready(a):(a.selector!==b&&(this.selector=a.selector,this.context=a.context),e.makeArray(a,this))},selector:"",length:0,toArray:function(){return ja.call(this)},
get:function(a){return null==a?this.toArray():0>a?this[this.length+a]:this[a]},pushStack:function(a){a=e.merge(this.constructor(),a);return a.prevObject=this,a.context=this.context,a},each:function(a,b){return e.each(this,a,b)},ready:function(a){return e.ready.promise().done(a),this},slice:function(){return this.pushStack(ja.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(a){var b=this.length,a=+a+(0>a?b:0);return this.pushStack(0<=a&&b>
a?[this[a]]:[])},map:function(a){return this.pushStack(e.map(this,function(b,l){return a.call(b,l,b)}))},end:function(){return this.prevObject||this.constructor(null)},push:Xa,sort:[].sort,splice:[].splice};e.fn.init.prototype=e.fn;e.extend=e.fn.extend=function(){var a,t,l,c,d,B,m=arguments[0]||{},g=1,h=arguments.length,i=!1;"boolean"==typeof m&&(i=m,m=arguments[1]||{},g=2);"object"==typeof m||e.isFunction(m)||(m={});for(h===g&&(m=this,--g);h>g;g++)if(null!=(a=arguments[g]))for(t in a)l=m[t],c=a[t],
m!==c&&(i&&c&&(e.isPlainObject(c)||(d=e.isArray(c)))?(d?(d=!1,B=l&&e.isArray(l)?l:[]):B=l&&e.isPlainObject(l)?l:{},m[t]=e.extend(i,B,c)):c!==b&&(m[t]=c));return m};e.extend({expando:"jQuery"+("2.0.0"+Math.random()).replace(/\D/g,""),noConflict:function(s){return a.$===e&&(a.$=mc),s&&a.jQuery===e&&(a.jQuery=lc),e},isReady:!1,readyWait:1,holdReady:function(a){a?e.readyWait++:e.ready(!0)},ready:function(a){(!0===a?--e.readyWait:e.isReady)||(e.isReady=!0,!0!==a&&0<--e.readyWait||(Ca.resolveWith(x,[e]),
e.fn.trigger&&e(x).trigger("ready").off("ready")))},isFunction:function(a){return"function"===e.type(a)},isArray:Array.isArray,isWindow:function(a){return null!=a&&a===a.window},isNumeric:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},type:function(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?Ea[nc.call(a)]||"object":typeof a},isPlainObject:function(a){if("object"!==e.type(a)||a.nodeType||e.isWindow(a))return!1;try{if(a.constructor&&!Ya.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(b){return!1}return!0},
isEmptyObject:function(a){for(var b in a)return!1;return!0},error:function(a){throw Error(a);},parseHTML:function(a,b,c){if(!a||"string"!=typeof a)return null;"boolean"==typeof b&&(c=b,b=!1);var b=b||x,R=wb.exec(a),c=!c&&[];return R?[b.createElement(R[1])]:(R=e.buildFragment([a],b,c),c&&e(c).remove(),e.merge([],R.childNodes))},parseJSON:JSON.parse,parseXML:function(a){var t,c;if(!a||"string"!=typeof a)return null;try{c=new DOMParser,t=c.parseFromString(a,"text/xml")}catch(R){t=b}return(!t||t.getElementsByTagName("parsererror").length)&&
e.error("Invalid XML: "+a),t},noop:function(){},globalEval:function(a){var b,c=eval;(a=e.trim(a))&&(1===a.indexOf("use strict")?(b=x.createElement("script"),b.text=a,x.head.appendChild(b).parentNode.removeChild(b)):c(a))},camelCase:function(a){return a.replace(qc,"ms-").replace(rc,sc)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toLowerCase()===b.toLowerCase()},each:function(a,b,l){var e,d=0,B=a.length,m=c(a);if(l)if(m)for(;B>d&&!(e=b.apply(a[d],l),!1===e);d++);else for(d in a){if(e=b.apply(a[d],
l),!1===e)break}else if(m)for(;B>d&&!(e=b.call(a[d],d,a[d]),!1===e);d++);else for(d in a)if(e=b.call(a[d],d,a[d]),!1===e)break;return a},trim:function(a){return null==a?"":oc.call(a)},makeArray:function(a,b){var l=b||[];return null!=a&&(c(Object(a))?e.merge(l,"string"==typeof a?[a]:a):Xa.call(l,a)),l},inArray:function(a,b,c){return null==b?-1:za.call(b,a,c)},merge:function(a,t){var c=t.length,e=a.length,d=0;if("number"==typeof c)for(;c>d;d++)a[e++]=t[d];else for(;t[d]!==b;)a[e++]=t[d++];return a.length=
e,a},grep:function(a,b,c){for(var e,d=[],B=0,m=a.length,c=!!c;m>B;B++)e=!!b(a[B],B),c!==e&&d.push(a[B]);return d},map:function(a,b,l){var e,d=0,B=a.length,m=[];if(c(a))for(;B>d;d++)e=b(a[d],d,l),null!=e&&(m[m.length]=e);else for(d in a)e=b(a[d],d,l),null!=e&&(m[m.length]=e);return vb.apply([],m)},guid:1,proxy:function(a,c){var l,d,v;return"string"==typeof c&&(l=a[c],c=a,a=l),e.isFunction(a)?(d=ja.call(arguments,2),v=function(){return a.apply(c||this,d.concat(ja.call(arguments)))},v.guid=a.guid=a.guid||
e.guid++,v):b},access:function(a,c,l,d,v,B,m){var g=0,h=a.length,i=null==l;if("object"===e.type(l))for(g in v=!0,l)e.access(a,c,g,l[g],!0,B,m);else if(d!==b&&(v=!0,e.isFunction(d)||(m=!0),i&&(m?(c.call(a,d),c=null):(i=c,c=function(a,b,s){return i.call(e(a),s)})),c))for(;h>g;g++)c(a[g],l,m?d:d.call(a[g],g,c(a[g],l)));return v?a:i?c.call(a):h?c(a[0],l):B},now:Date.now,swap:function(a,b,c,e){var d,g={};for(d in b)g[d]=a.style[d],a.style[d]=b[d];c=c.apply(a,e||[]);for(d in b)a.style[d]=g[d];return c}});
e.ready.promise=function(b){return Ca||(Ca=e.Deferred(),"complete"===x.readyState?setTimeout(e.ready):(x.addEventListener("DOMContentLoaded",Ha,!1),a.addEventListener("load",Ha,!1))),Ca.promise(b)};e.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(a,b){Ea["[object "+b+"]"]=b.toLowerCase()});tb=e(x);var Za=a,$a=function(){var a,b=[];return a=function(c,d){return b.push(c+=" ")>A.cacheLength&&delete a[b.shift()],a[c]=d}},V=function(a){return a[E]=!0,a},Y=function(a){var b=
J.createElement("div");try{return!!a(b)}catch(c){return!1}finally{b.parentNode&&b.parentNode.removeChild(b)}},C=function(a,b,c,d){var e,g,m,h,i;if((b?b.ownerDocument||b:ca)!==J&&ra(b),b=b||J,c=c||[],!a||"string"!=typeof a)return c;if(1!==(h=b.nodeType)&&9!==h)return[];if(W&&!d){if(e=tc.exec(a))if(m=e[1])if(9===h){if(g=b.getElementById(m),!g||!g.parentNode)return c;if(g.id===m)return c.push(g),c}else{if(b.ownerDocument&&(g=b.ownerDocument.getElementById(m))&&va(b,g)&&g.id===m)return c.push(g),c}else{if(e[2])return da.apply(c,
b.getElementsByTagName(a)),c;if((m=e[3])&&H.getElementsByClassName&&b.getElementsByClassName)return da.apply(c,b.getElementsByClassName(m)),c}if(H.qsa&&(!P||!P.test(a))){if(g=e=E,m=b,i=9===h&&a,1===h&&"object"!==b.nodeName.toLowerCase()){h=Ia(a);(e=b.getAttribute("id"))?g=e.replace(uc,"\\$&"):b.setAttribute("id",g);g="[id='"+g+"'] ";for(m=h.length;m--;)h[m]=g+Ja(h[m]);m=ab.test(a)&&b.parentNode||b;i=h.join(",")}if(i)try{return da.apply(c,m.querySelectorAll(i)),c}catch(p){}finally{e||b.removeAttribute("id")}}}var k;
a:{var a=a.replace(Ka,"$1"),j,n;g=Ia(a);if(!d&&1===g.length){if(k=g[0]=g[0].slice(0),2<k.length&&"ID"===(j=k[0]).type&&9===b.nodeType&&W&&A.relative[k[1].type]){if(b=(A.find.ID(j.matches[0].replace(ea,fa),b)||[])[0],!b){k=c;break a}a=a.slice(k.shift().value.length)}for(h=La.needsContext.test(a)?0:k.length;h--&&!(j=k[h],A.relative[e=j.type]);)if((n=A.find[e])&&(d=n(j.matches[0].replace(ea,fa),ab.test(k[0].type)&&b.parentNode||b))){if(k.splice(h,1),a=d.length&&Ja(k),!a){k=(da.apply(c,d),c);break a}break}}k=
(bb(a,g)(d,b,!W,c,ab.test(a)),c)}return k},yb=function(a,b){var c=b&&a,e=c&&(~b.sourceIndex||xb)-(~a.sourceIndex||xb);if(e)return e;if(c)for(;c=c.nextSibling;)if(c===b)return-1;return a?1:-1},vc=function(a,b,c){var e;return c?void 0:(e=a.getAttributeNode(b))&&e.specified?e.value:!0===a[b]?b.toLowerCase():null},wc=function(a,b,c){return c?void 0:a.getAttribute(b,"type"===b.toLowerCase()?1:2)},xc=function(a){return function(b){return"input"===b.nodeName.toLowerCase()&&b.type===a}},yc=function(a){return function(b){var c=
b.nodeName.toLowerCase();return("input"===c||"button"===c)&&b.type===a}},ka=function(a){return V(function(b){return b=+b,V(function(c,e){for(var d,g=a([],c.length,b),m=g.length;m--;)c[d=g[m]]&&(c[d]=!(e[d]=c[d]))})})},Ia=function(a,b){var c,e,d,g,m,h,i;if(m=zb[a+" "])return b?0:m.slice(0);m=a;h=[];for(i=A.preFilter;m;){(!c||(e=zc.exec(m)))&&(e&&(m=m.slice(e[0].length)||m),h.push(d=[]));c=!1;(e=Ac.exec(m))&&(c=e.shift(),d.push({value:c,type:e[0].replace(Ka," ")}),m=m.slice(c.length));for(g in A.filter)!(e=
La[g].exec(m))||i[g]&&!(e=i[g](e))||(c=e.shift(),d.push({value:c,type:g,matches:e}),m=m.slice(c.length));if(!c)break}return b?m.length:m?C.error(a):zb(a,h).slice(0)},Ja=function(a){for(var b=0,c=a.length,e="";c>b;b++)e+=a[b].value;return e},cb=function(a,b,c){var e=b.dir,d=c&&"parentNode"===e,g=Bc++;return b.first?function(b,c,t){for(;b=b[e];)if(1===b.nodeType||d)return a(b,c,t)}:function(b,c,t){var l,h,i,k=Z+" "+g;if(t)for(;b=b[e];){if((1===b.nodeType||d)&&a(b,c,t))return!0}else for(;b=b[e];)if(1===
b.nodeType||d)if(i=b[E]||(b[E]={}),(h=i[e])&&h[0]===k){if(!0===(l=h[1])||l===Ma)return!0===l}else if(h=i[e]=[k],h[1]=a(b,c,t)||Ma,!0===h[1])return!0}},db=function(a){return 1<a.length?function(b,c,e){for(var d=a.length;d--;)if(!a[d](b,c,e))return!1;return!0}:a[0]},Na=function(a,b,c,e,d){for(var g,m=[],h=0,i=a.length,k=null!=b;i>h;h++)(g=a[h])&&(!c||c(g,e,d))&&(m.push(g),k&&b.push(h));return m},eb=function(a,b,c,e,d,g){return e&&!e[E]&&(e=eb(e)),d&&!d[E]&&(d=eb(d,g)),V(function(g,B,h,i){var k,j,p=
[],n=[],r=B.length,q;if(!(q=g)){q=b||"*";for(var u=h.nodeType?[h]:h,w=[],y=0,G=u.length;G>y;y++)C(q,u[y],w);q=w}q=!a||!g&&b?q:Na(q,p,a,h,i);u=c?d||(g?a:r||e)?[]:B:q;if(c&&c(q,u,h,i),e){k=Na(u,n);e(k,[],h,i);for(h=k.length;h--;)(j=k[h])&&(u[n[h]]=!(q[n[h]]=j))}if(g){if(d||a){if(d){k=[];for(h=u.length;h--;)(j=u[h])&&k.push(q[h]=j);d(null,u=[],k,i)}for(h=u.length;h--;)(j=u[h])&&-1<(k=d?la.call(g,j):p[h])&&(g[k]=!(B[k]=j))}}else u=Na(u===B?u.splice(r,u.length):u),d?d(null,B,u,i):da.apply(B,u)})},fb=function(a){var b,
c,e,d=a.length,g=A.relative[a[0].type];c=g||A.relative[" "];for(var m=g?1:0,h=cb(function(a){return a===b},c,!0),i=cb(function(a){return-1<la.call(b,a)},c,!0),k=[function(a,s,c){return!g&&(c||s!==Oa)||((b=s).nodeType?h(a,s,c):i(a,s,c))}];d>m;m++)if(c=A.relative[a[m].type])k=[cb(db(k),c)];else{if(c=A.filter[a[m].type].apply(null,a[m].matches),c[E]){for(e=++m;d>e&&!A.relative[a[e].type];e++);return eb(1<m&&db(k),1<m&&Ja(a.slice(0,m-1)).replace(Ka,"$1"),c,e>m&&fb(a.slice(m,e)),d>e&&fb(a=a.slice(e)),
d>e&&Ja(a))}k.push(c)}return db(k)},Ab=function(){},sa,Ma,A,Pa,Bb,bb,Oa,ma,ra,J,aa,W,P,na,Qa,va,E="sizzle"+-new Date,ca=Za.document,H={},Z=0,Bc=0,Cb=$a(),zb=$a(),Db=$a(),wa=!1,Ra=function(){return 0},xb=-2147483648,ga=[],Cc=ga.pop,Dc=ga.push,da=ga.push,Eb=ga.slice,la=ga.indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(this[b]===a)return b;return-1},Fb="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+".replace("w","w#"),Gb="\\[[\\x20\\t\\r\\n\\f]*((?:\\\\.|[\\w-]|[^\\x00-\\xa0])+)[\\x20\\t\\r\\n\\f]*(?:([*^$|!~]?=)[\\x20\\t\\r\\n\\f]*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+
Fb+")|)|)[\\x20\\t\\r\\n\\f]*\\]",gb=":((?:\\\\.|[\\w-]|[^\\x00-\\xa0])+)(?:\\(((['\"])((?:\\\\.|[^\\\\])*?)\\3|((?:\\\\.|[^\\\\()[\\]]|"+Gb.replace(3,8)+")*)|.*)\\)|)",Ka=/^[\x20\t\r\n\f]+|((?:^|[^\\])(?:\\.)*)[\x20\t\r\n\f]+$/g,zc=/^[\x20\t\r\n\f]*,[\x20\t\r\n\f]*/,Ac=/^[\x20\t\r\n\f]*([>+~]|[\x20\t\r\n\f])[\x20\t\r\n\f]*/,ab=/[\x20\t\r\n\f]*[+~]/,Ec=/=[\x20\t\r\n\f]*([^\]'"]*)[\x20\t\r\n\f]*\]/g,Fc=RegExp(gb),Gc=RegExp("^"+Fb+"$"),La={ID:/^#((?:\\.|[\w-]|[^\x00-\xa0])+)/,CLASS:/^\.((?:\\.|[\w-]|[^\x00-\xa0])+)/,
TAG:RegExp("^("+"(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+".replace("w","w*")+")"),ATTR:RegExp("^"+Gb),PSEUDO:RegExp("^"+gb),CHILD:RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\([\\x20\\t\\r\\n\\f]*(even|odd|(([+-]|)(\\d*)n|)[\\x20\\t\\r\\n\\f]*(?:([+-]|)[\\x20\\t\\r\\n\\f]*(\\d+)|))[\\x20\\t\\r\\n\\f]*\\)|)","i"),"boolean":RegExp("^(?:checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped)$","i"),needsContext:RegExp("^[\\x20\\t\\r\\n\\f]*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\([\\x20\\t\\r\\n\\f]*((?:-\\d)?\\d*)[\\x20\\t\\r\\n\\f]*\\)|)(?=[^-]|$)",
"i")},hb=/^[^{]+\{\s*\[native \w/,tc=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,Hc=/^(?:input|select|textarea|button)$/i,Ic=/^h\d$/i,uc=/'|\\/g,ea=/\\([\da-fA-F]{1,6}[\x20\t\r\n\f]?|.)/g,fa=function(a,b){var c="0x"+b-65536;return c!==c?b:0>c?String.fromCharCode(c+65536):String.fromCharCode(55296|c>>10,56320|1023&c)};try{da.apply(ga=Eb.call(ca.childNodes),ca.childNodes),ga[ca.childNodes.length].nodeType}catch(hd){da={apply:ga.length?function(a,b){Dc.apply(a,Eb.call(b))}:function(a,b){for(var c=a.length,e=
0;a[c++]=b[e++];);a.length=c-1}}}Bb=C.isXML=function(a){return(a=a&&(a.ownerDocument||a).documentElement)?"HTML"!==a.nodeName:!1};ra=C.setDocument=function(a){var b=a?a.ownerDocument||a:ca;if(b!==J&&9===b.nodeType&&b.documentElement){J=b;aa=b.documentElement;W=!Bb(b);H.getElementsByTagName=Y(function(a){return a.appendChild(b.createComment("")),!a.getElementsByTagName("*").length});H.attributes=Y(function(a){return a.className="i",!a.getAttribute("className")});H.getElementsByClassName=Y(function(a){return a.innerHTML=
"<div class='a'></div><div class='a i'></div>",a.firstChild.className="i",2===a.getElementsByClassName("i").length});H.sortDetached=Y(function(a){return 1&a.compareDocumentPosition(J.createElement("div"))});H.getById=Y(function(a){return aa.appendChild(a).id=E,!b.getElementsByName||!b.getElementsByName(E).length});H.getById?(A.find.ID=function(a,b){if("undefined"!==typeof b.getElementById&&W){var s=b.getElementById(a);return s&&s.parentNode?[s]:[]}},A.filter.ID=function(a){var b=a.replace(ea,fa);
return function(a){return a.getAttribute("id")===b}}):(A.find.ID=function(a,b){if("undefined"!==typeof b.getElementById&&W){var s=b.getElementById(a);return s?s.id===a||"undefined"!==typeof s.getAttributeNode&&s.getAttributeNode("id").value===a?[s]:void 0:[]}},A.filter.ID=function(a){var b=a.replace(ea,fa);return function(a){return(a="undefined"!==typeof a.getAttributeNode&&a.getAttributeNode("id"))&&a.value===b}});A.find.TAG=H.getElementsByTagName?function(a,b){return"undefined"!==typeof b.getElementsByTagName?
b.getElementsByTagName(a):void 0}:function(a,b){var s,c=[],t=0,l=b.getElementsByTagName(a);if("*"===a){for(;s=l[t++];)1===s.nodeType&&c.push(s);return c}return l};A.find.CLASS=H.getElementsByClassName&&function(a,b){return"undefined"!==typeof b.getElementsByClassName&&W?b.getElementsByClassName(a):void 0};na=[];P=[];(H.qsa=hb.test(b.querySelectorAll+""))&&(Y(function(a){a.innerHTML="<select><option selected=''></option></select>";a.querySelectorAll("[selected]").length||P.push("\\[[\\x20\\t\\r\\n\\f]*(?:value|checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped)");
a.querySelectorAll(":checked").length||P.push(":checked")}),Y(function(a){var b=J.createElement("input");b.setAttribute("type","hidden");a.appendChild(b).setAttribute("t","");a.querySelectorAll("[t^='']").length&&P.push("[*^$]=[\\x20\\t\\r\\n\\f]*(?:''|\"\")");a.querySelectorAll(":enabled").length||P.push(":enabled",":disabled");a.querySelectorAll("*,:x");P.push(",.*:")}));var a=H,c;c=Qa=aa.webkitMatchesSelector||aa.mozMatchesSelector||aa.oMatchesSelector||aa.msMatchesSelector;c=hb.test(c+"");a=((a.matchesSelector=
c)&&Y(function(a){H.disconnectedMatch=Qa.call(a,"div");Qa.call(a,"[s!='']:x");na.push("!=",gb)}),P=P.length&&RegExp(P.join("|")),na=na.length&&RegExp(na.join("|")),va=hb.test(aa.contains+"")||aa.compareDocumentPosition?function(a,b){var s=9===a.nodeType?a.documentElement:a,c=b&&b.parentNode;return a===c||!(!c||1!==c.nodeType||!(s.contains?s.contains(c):a.compareDocumentPosition&&16&a.compareDocumentPosition(c)))}:function(a,b){if(b)for(;b=b.parentNode;)if(b===a)return!0;return!1},Ra=aa.compareDocumentPosition?
function(a,s){if(a===s)return wa=!0,0;var c=s.compareDocumentPosition&&a.compareDocumentPosition&&a.compareDocumentPosition(s);return c?1&c||!H.sortDetached&&s.compareDocumentPosition(a)===c?a===b||va(ca,a)?-1:s===b||va(ca,s)?1:ma?la.call(ma,a)-la.call(ma,s):0:4&c?-1:1:a.compareDocumentPosition?-1:1}:function(a,s){var c,l=0;c=a.parentNode;var e=s.parentNode,d=[a],g=[s];if(a===s)return wa=!0,0;if(!c||!e)return a===b?-1:s===b?1:c?-1:e?1:ma?la.call(ma,a)-la.call(ma,s):0;if(c===e)return yb(a,s);for(c=
a;c=c.parentNode;)d.unshift(c);for(c=s;c=c.parentNode;)g.unshift(c);for(;d[l]===g[l];)l++;return l?yb(d[l],g[l]):d[l]===ca?-1:g[l]===ca?1:0},J)}else a=J;return a};C.matches=function(a,b){return C(a,null,null,b)};C.matchesSelector=function(a,b){if((a.ownerDocument||a)!==J&&ra(a),b=b.replace(Ec,"='$1']"),!(!H.matchesSelector||!W||na&&na.test(b)||P&&P.test(b)))try{var c=Qa.call(a,b);if(c||H.disconnectedMatch||a.document&&11!==a.document.nodeType)return c}catch(e){}return 0<C(b,J,null,[a]).length};C.contains=
function(a,b){return(a.ownerDocument||a)!==J&&ra(a),va(a,b)};C.attr=function(a,b){(a.ownerDocument||a)!==J&&ra(a);var c=A.attrHandle[b.toLowerCase()],c=c&&c(a,b,!W);return void 0===c?H.attributes||!W?a.getAttribute(b):(c=a.getAttributeNode(b))&&c.specified?c.value:null:c};C.error=function(a){throw Error("Syntax error, unrecognized expression: "+a);};C.uniqueSort=function(a){var b,c=[],e=0,d=0;if(wa=!H.detectDuplicates,ma=!H.sortStable&&a.slice(0),a.sort(Ra),wa){for(;b=a[d++];)b===a[d]&&(e=c.push(d));
for(;e--;)a.splice(c[e],1)}return a};Pa=C.getText=function(a){var b,c="",e=0;if(b=a.nodeType)if(1===b||9===b||11===b){if("string"==typeof a.textContent)return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=Pa(a)}else{if(3===b||4===b)return a.nodeValue}else for(;b=a[e];e++)c+=Pa(b);return c};A=C.selectors={cacheLength:50,createPseudo:V,match:La,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},
preFilter:{ATTR:function(a){return a[1]=a[1].replace(ea,fa),a[3]=(a[4]||a[5]||"").replace(ea,fa),"~="===a[2]&&(a[3]=" "+a[3]+" "),a.slice(0,4)},CHILD:function(a){return a[1]=a[1].toLowerCase(),"nth"===a[1].slice(0,3)?(a[3]||C.error(a[0]),a[4]=+(a[4]?a[5]+(a[6]||1):2*("even"===a[3]||"odd"===a[3])),a[5]=+(a[7]+a[8]||"odd"===a[3])):a[3]&&C.error(a[0]),a},PSEUDO:function(a){var b,c=!a[5]&&a[2];return La.CHILD.test(a[0])?null:(a[4]?a[2]=a[4]:c&&Fc.test(c)&&(b=Ia(c,!0))&&(b=c.indexOf(")",c.length-b)-c.length)&&
(a[0]=a[0].slice(0,b),a[2]=c.slice(0,b)),a.slice(0,3))}},filter:{TAG:function(a){var b=a.replace(ea,fa).toLowerCase();return"*"===a?function(){return!0}:function(a){return a.nodeName&&a.nodeName.toLowerCase()===b}},CLASS:function(a){var b=Cb[a+" "];return b||(b=RegExp("(^|[\\x20\\t\\r\\n\\f])"+a+"([\\x20\\t\\r\\n\\f]|$)"))&&Cb(a,function(a){return b.test("string"==typeof a.className&&a.className||"undefined"!==typeof a.getAttribute&&a.getAttribute("class")||"")})},ATTR:function(a,b,c){return function(e){e=
C.attr(e,a);return null==e?"!="===b:b?(e+="","="===b?e===c:"!="===b?e!==c:"^="===b?c&&0===e.indexOf(c):"*="===b?c&&-1<e.indexOf(c):"$="===b?c&&e.slice(-c.length)===c:"~="===b?-1<(" "+e+" ").indexOf(c):"|="===b?e===c||e.slice(0,c.length+1)===c+"-":!1):!0}},CHILD:function(a,b,c,e,d){var g="nth"!==a.slice(0,3),m="last"!==a.slice(-4),h="of-type"===b;return 1===e&&0===d?function(a){return!!a.parentNode}:function(b,c,l){var t,i,k,j,p,c=g!==m?"nextSibling":"previousSibling",n=b.parentNode,r=h&&b.nodeName.toLowerCase(),
l=!l&&!h;if(n){if(g){for(;c;){for(i=b;i=i[c];)if(h?i.nodeName.toLowerCase()===r:1===i.nodeType)return!1;p=c="only"===a&&!p&&"nextSibling"}return!0}if(p=[m?n.firstChild:n.lastChild],m&&l){l=n[E]||(n[E]={});t=l[a]||[];j=t[0]===Z&&t[1];k=t[0]===Z&&t[2];for(i=j&&n.childNodes[j];i=++j&&i&&i[c]||(k=j=0)||p.pop();)if(1===i.nodeType&&++k&&i===b){l[a]=[Z,j,k];break}}else if(l&&(t=(b[E]||(b[E]={}))[a])&&t[0]===Z)k=t[1];else for(;(i=++j&&i&&i[c]||(k=j=0)||p.pop())&&(!(h?i.nodeName.toLowerCase()===r:1===i.nodeType)||
!++k||!(l&&((i[E]||(i[E]={}))[a]=[Z,k]),i===b)););return k-=d,k===e||0===k%e&&0<=k/e}}},PSEUDO:function(a,b){var c,e=A.pseudos[a]||A.setFilters[a.toLowerCase()]||C.error("unsupported pseudo: "+a);return e[E]?e(b):1<e.length?(c=[a,a,"",b],A.setFilters.hasOwnProperty(a.toLowerCase())?V(function(a,c){for(var s,d=e(a,b),l=d.length;l--;)s=la.call(a,d[l]),a[s]=!(c[s]=d[l])}):function(a){return e(a,0,c)}):e}},pseudos:{not:V(function(a){var b=[],c=[],e=bb(a.replace(Ka,"$1"));return e[E]?V(function(a,b,c,
s){for(var d,c=e(a,null,s,[]),s=a.length;s--;)(d=c[s])&&(a[s]=!(b[s]=d))}):function(a,s,d){return b[0]=a,e(b,null,d,c),!c.pop()}}),has:V(function(a){return function(b){return 0<C(a,b).length}}),contains:V(function(a){return function(b){return-1<(b.textContent||b.innerText||Pa(b)).indexOf(a)}}),lang:V(function(a){return Gc.test(a||"")||C.error("unsupported lang: "+a),a=a.replace(ea,fa).toLowerCase(),function(b){var c;do if(c=W?b.lang:b.getAttribute("xml:lang")||b.getAttribute("lang"))return c=c.toLowerCase(),
c===a||0===c.indexOf(a+"-");while((b=b.parentNode)&&1===b.nodeType);return!1}}),target:function(a){var b=Za.location&&Za.location.hash;return b&&b.slice(1)===a.id},root:function(a){return a===aa},focus:function(a){return a===J.activeElement&&(!J.hasFocus||J.hasFocus())&&!(!a.type&&!a.href&&!~a.tabIndex)},enabled:function(a){return!1===a.disabled},disabled:function(a){return!0===a.disabled},checked:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&!!a.checked||"option"===b&&!!a.selected},
selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,!0===a.selected},empty:function(a){for(a=a.firstChild;a;a=a.nextSibling)if("@"<a.nodeName||3===a.nodeType||4===a.nodeType)return!1;return!0},parent:function(a){return!A.pseudos.empty(a)},header:function(a){return Ic.test(a.nodeName)},input:function(a){return Hc.test(a.nodeName)},button:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&"button"===a.type||"button"===b},text:function(a){var b;return"input"===a.nodeName.toLowerCase()&&
"text"===a.type&&(null==(b=a.getAttribute("type"))||b.toLowerCase()===a.type)},first:ka(function(){return[0]}),last:ka(function(a,b){return[b-1]}),eq:ka(function(a,b,c){return[0>c?c+b:c]}),even:ka(function(a,b){for(var c=0;b>c;c+=2)a.push(c);return a}),odd:ka(function(a,b){for(var c=1;b>c;c+=2)a.push(c);return a}),lt:ka(function(a,b,c){for(b=0>c?c+b:c;0<=--b;)a.push(b);return a}),gt:ka(function(a,b,c){for(c=0>c?c+b:c;b>++c;)a.push(c);return a})}};for(sa in{radio:!0,checkbox:!0,file:!0,password:!0,
image:!0})A.pseudos[sa]=xc(sa);for(sa in{submit:!0,reset:!0})A.pseudos[sa]=yc(sa);bb=C.compile=function(a,b){var c,e=[],d=[],g=Db[a+" "];if(!g){b||(b=Ia(a));for(c=b.length;c--;)g=fb(b[c]),g[E]?e.push(g):d.push(g);var m=0,h=0<e.length,i=0<d.length;c=function(a,b,c,s,l){var t,g,B=[],k=0,j="0",p=a&&[],n=null!=l,r=Oa,q=a||i&&A.find.TAG("*",l&&b.parentNode||b),u=Z+=null==r?1:Math.random()||0.1;for(n&&(Oa=b!==J&&b,Ma=m);null!=(l=q[j]);j++){if(i&&l){for(t=0;g=d[t++];)if(g(l,b,c)){s.push(l);break}n&&(Z=u,
Ma=++m)}h&&((l=!g&&l)&&k--,a&&p.push(l))}if(k+=j,h&&j!==k){for(t=0;g=e[t++];)g(p,B,b,c);if(a){if(0<k)for(;j--;)p[j]||B[j]||(B[j]=Cc.call(s));B=Na(B)}da.apply(s,B);n&&!a&&0<B.length&&1<k+e.length&&C.uniqueSort(s)}return n&&(Z=u,Oa=r),p};c=h?V(c):c;g=Db(a,c)}return g};A.pseudos.nth=A.pseudos.eq;Ab.prototype=A.filters=A.pseudos;A.setFilters=new Ab;H.sortStable=E.split("").sort(Ra).join("")===E;ra();[0,0].sort(Ra);H.detectDuplicates=wa;Y(function(a){if(a.innerHTML="<a href='#'></a>","#"!==a.firstChild.getAttribute("href"))for(var a=
["type","href","height","width"],b=a.length;b--;)A.attrHandle[a[b]]=wc});Y(function(a){if(null!=a.getAttribute("disabled"))for(var a="checked selected async autofocus autoplay controls defer disabled hidden ismap loop multiple open readonly required scoped".split(" "),b=a.length;b--;)A.attrHandle[a[b]]=vc});e.find=C;e.expr=C.selectors;e.expr[":"]=e.expr.pseudos;e.unique=C.uniqueSort;e.text=C.getText;e.isXMLDoc=C.isXML;e.contains=C.contains;var Hb={};e.Callbacks=function(a){var c;if("string"==typeof a){if(!(c=
Hb[a])){c=a;var d=Hb[c]={};c=(e.each(c.match(X)||[],function(a,b){d[b]=!0}),d)}}else c=e.extend({},a);var a=c,g,v,B,m,h,i,k=[],j=!a.once&&[],p=function(b){g=a.memory&&b;v=!0;i=m||0;m=0;h=k.length;for(B=!0;k&&h>i;i++)if(!1===k[i].apply(b[0],b[1])&&a.stopOnFalse){g=!1;break}B=!1;k&&(j?j.length&&p(j.shift()):g?k=[]:n.disable())},n={add:function(){if(k){var b=k.length;(function jc(b){e.each(b,function(b,c){var d=e.type(c);"function"===d?a.unique&&n.has(c)||k.push(c):c&&c.length&&"string"!==d&&jc(c)})})(arguments);
B?h=k.length:g&&(m=b,p(g))}return this},remove:function(){return k&&e.each(arguments,function(a,b){for(var c;-1<(c=e.inArray(b,k,c));)k.splice(c,1),B&&(h>=c&&h--,i>=c&&i--)}),this},has:function(a){return a?-1<e.inArray(a,k):!(!k||!k.length)},empty:function(){return k=[],h=0,this},disable:function(){return k=j=g=b,this},disabled:function(){return!k},lock:function(){return j=b,g||n.disable(),this},locked:function(){return!j},fireWith:function(a,b){return b=b||[],b=[a,b.slice?b.slice():b],!k||v&&!j||
(B?j.push(b):p(b)),this},fire:function(){return n.fireWith(this,arguments),this},fired:function(){return!!v}};return n};e.extend({Deferred:function(a){var b=[["resolve","done",e.Callbacks("once memory"),"resolved"],["reject","fail",e.Callbacks("once memory"),"rejected"],["notify","progress",e.Callbacks("memory")]],c="pending",d={state:function(){return c},always:function(){return g.done(arguments).fail(arguments),this},then:function(){var a=arguments;return e.Deferred(function(c){e.each(b,function(b,
s){var l=s[0],t=e.isFunction(a[b])&&a[b];g[s[1]](function(){var a=t&&t.apply(this,arguments);a&&e.isFunction(a.promise)?a.promise().done(c.resolve).fail(c.reject).progress(c.notify):c[l+"With"](this===d?c.promise():this,t?[a]:arguments)})});a=null}).promise()},promise:function(a){return null!=a?e.extend(a,d):d}},g={};return d.pipe=d.then,e.each(b,function(a,s){var e=s[2],h=s[3];d[s[1]]=e.add;h&&e.add(function(){c=h},b[1^a][2].disable,b[2][2].lock);g[s[0]]=function(){return g[s[0]+"With"](this===g?
d:this,arguments),this};g[s[0]+"With"]=e.fireWith}),d.promise(g),a&&a.call(g,g),g},when:function(a){var b=0,c=ja.call(arguments),d=c.length,g=1!==d||a&&e.isFunction(a.promise)?d:0,h=1===g?a:e.Deferred(),m=function(a,b,c){return function(s){b[a]=this;c[a]=1<arguments.length?ja.call(arguments):s;c===i?h.notifyWith(b,c):--g||h.resolveWith(b,c)}},i,k,j;if(1<d){i=Array(d);k=Array(d);for(j=Array(d);d>b;b++)c[b]&&e.isFunction(c[b].promise)?c[b].promise().done(m(b,j,c)).fail(h.reject).progress(m(b,k,i)):
--g}return g||h.resolveWith(j,c),h.promise()}});var Jc=e,Ib,M={},T=x.createElement("input"),Jb=x.createDocumentFragment(),U=x.createElement("div"),Kb=x.createElement("select"),Lb=Kb.appendChild(x.createElement("option"));Ib=T.type?(T.type="checkbox",M.checkOn=""!==T.value,M.optSelected=Lb.selected,M.reliableMarginRight=!0,M.boxSizingReliable=!0,M.pixelPosition=!1,T.checked=!0,M.noCloneChecked=T.cloneNode(!0).checked,Kb.disabled=!0,M.optDisabled=!Lb.disabled,T=x.createElement("input"),T.value="t",
T.type="radio",M.radioValue="t"===T.value,T.setAttribute("checked","t"),T.setAttribute("name","t"),Jb.appendChild(T),M.checkClone=Jb.cloneNode(!0).cloneNode(!0).lastChild.checked,M.focusinBubbles="onfocusin"in a,U.style.backgroundClip="content-box",U.cloneNode(!0).style.backgroundClip="",M.clearCloneStyle="content-box"===U.style.backgroundClip,e(function(){var b,c,d=x.getElementsByTagName("body")[0];d&&(b=x.createElement("div"),b.style.cssText="border:0;width:0;height:0;position:absolute;top:0;left:-9999px;margin-top:1px",
d.appendChild(b).appendChild(U),U.innerHTML="",U.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;padding:1px;border:1px;display:block;width:4px;margin-top:1%;position:absolute;top:1%",e.swap(d,null!=d.style.zoom?{zoom:1}:{},function(){M.boxSizing=4===U.offsetWidth}),a.getComputedStyle&&(M.pixelPosition="1%"!==(a.getComputedStyle(U,null)||{}).top,M.boxSizingReliable="4px"===(a.getComputedStyle(U,null)||{width:"4px"}).width,c=U.appendChild(x.createElement("div")),
c.style.cssText=U.style.cssText="padding:0;margin:0;border:0;display:block;-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box",c.style.marginRight=c.style.width="0",U.style.width="1px",M.reliableMarginRight=!parseFloat((a.getComputedStyle(c,null)||{}).marginRight)),d.removeChild(b))}),M):M;Jc.support=Ib;var F,z,dc=/(?:\{[\s\S]*\}|\[[\s\S]*\])$/,cc=/([A-Z])/g;d.uid=1;d.accepts=function(a){return a.nodeType?1===a.nodeType||9===a.nodeType:!0};d.prototype={key:function(a){if(!d.accepts(a))return 0;
var b={},c=a[this.expando];if(!c){c=d.uid++;try{b[this.expando]={value:c},Object.defineProperties(a,b)}catch(g){b[this.expando]=c,e.extend(a,b)}}return this.cache[c]||(this.cache[c]={}),c},set:function(a,b,c){var d,a=this.key(a),g=this.cache[a];if("string"==typeof b)g[b]=c;else if(e.isEmptyObject(g))this.cache[a]=b;else for(d in b)g[d]=b[d]},get:function(a,c){var e=this.cache[this.key(a)];return c===b?e:e[c]},access:function(a,c,e){return c===b||c&&"string"==typeof c&&e===b?this.get(a,c):(this.set(a,
c,e),e!==b?e:c)},remove:function(a,c){var d,g;d=this.key(a);var v=this.cache[d];if(c===b)this.cache[d]={};else{e.isArray(c)?g=c.concat(c.map(e.camelCase)):c in v?g=[c]:(g=e.camelCase(c),g=g in v?[g]:g.match(X)||[]);for(d=g.length;d--;)delete v[g[d]]}},hasData:function(a){return!e.isEmptyObject(this.cache[a[this.expando]]||{})},discard:function(a){delete this.cache[this.key(a)]}};F=new d;z=new d;e.extend({acceptData:d.accepts,hasData:function(a){return F.hasData(a)||z.hasData(a)},data:function(a,b,
c){return F.access(a,b,c)},removeData:function(a,b){F.remove(a,b)},_data:function(a,b,c){return z.access(a,b,c)},_removeData:function(a,b){z.remove(a,b)}});e.fn.extend({data:function(a,c){var d,R,v=this[0],h=0,m=null;if(a===b){if(this.length&&(m=F.get(v),1===v.nodeType&&!z.get(v,"hasDataAttrs"))){for(d=v.attributes;d.length>h;h++)R=d[h].name,0===R.indexOf("data-")&&(R=e.camelCase(R.substring(5)),g(v,R,m[R]));z.set(v,"hasDataAttrs",!0)}return m}return"object"==typeof a?this.each(function(){F.set(this,
a)}):e.access(this,function(c){var d,l=e.camelCase(a);if(v&&c===b){if((d=F.get(v,a),d!==b)||(d=F.get(v,l),d!==b)||(d=g(v,l,b),d!==b))return d}else this.each(function(){var e=F.get(this,l);F.set(this,l,c);-1!==a.indexOf("-")&&e!==b&&F.set(this,a,c)})},null,c,1<arguments.length,null,!0)},removeData:function(a){return this.each(function(){F.remove(this,a)})}});e.extend({queue:function(a,c,d){var g;return a?(c=(c||"fx")+"queue",g=z.get(a,c),d&&(!g||e.isArray(d)?g=z.access(a,c,e.makeArray(d)):g.push(d)),
g||[]):b},dequeue:function(a,b){var b=b||"fx",c=e.queue(a,b),d=c.length,g=c.shift(),h=e._queueHooks(a,b),m=function(){e.dequeue(a,b)};"inprogress"===g&&(g=c.shift(),d--);(h.cur=g)&&("fx"===b&&c.unshift("inprogress"),delete h.stop,g.call(a,m,h));!d&&h&&h.empty.fire()},_queueHooks:function(a,b){var c=b+"queueHooks";return z.get(a,c)||z.access(a,c,{empty:e.Callbacks("once memory").add(function(){z.remove(a,[b+"queue",c])})})}});e.fn.extend({queue:function(a,c){var d=2;return"string"!=typeof a&&(c=a,
a="fx",d--),d>arguments.length?e.queue(this[0],a):c===b?this:this.each(function(){var b=e.queue(this,a,c);e._queueHooks(this,a);"fx"===a&&"inprogress"!==b[0]&&e.dequeue(this,a)})},dequeue:function(a){return this.each(function(){e.dequeue(this,a)})},delay:function(a,b){return a=e.fx?e.fx.speeds[a]||a:a,b=b||"fx",this.queue(b,function(b,c){var d=setTimeout(b,a);c.stop=function(){clearTimeout(d)}})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,c){var d,g=1,v=e.Deferred(),
h=this,m=this.length,i=function(){--g||v.resolveWith(h,[h])};"string"!=typeof a&&(c=a,a=b);for(a=a||"fx";m--;)(d=z.get(h[m],a+"queueHooks"))&&d.empty&&(g++,d.empty.add(i));return i(),v.promise(c)}});var Mb,ib=/[\t\r\n]/g,Kc=/\r/g,Lc=/^(?:input|select|textarea|button)$/i;e.fn.extend({attr:function(a,b){return e.access(this,e.attr,a,b,1<arguments.length)},removeAttr:function(a){return this.each(function(){e.removeAttr(this,a)})},prop:function(a,b){return e.access(this,e.prop,a,b,1<arguments.length)},
removeProp:function(a){return this.each(function(){delete this[e.propFix[a]||a]})},addClass:function(a){var b,c,d,g,h,m=0,i=this.length;b="string"==typeof a&&a;if(e.isFunction(a))return this.each(function(b){e(this).addClass(a.call(this,b,this.className))});if(b)for(b=(a||"").match(X)||[];i>m;m++)if(c=this[m],d=1===c.nodeType&&(c.className?(" "+c.className+" ").replace(ib," "):" ")){for(h=0;g=b[h++];)0>d.indexOf(" "+g+" ")&&(d+=g+" ");c.className=e.trim(d)}return this},removeClass:function(a){var b,
c,d,g,h,m=0,i=this.length;b=0===arguments.length||"string"==typeof a&&a;if(e.isFunction(a))return this.each(function(b){e(this).removeClass(a.call(this,b,this.className))});if(b)for(b=(a||"").match(X)||[];i>m;m++)if(c=this[m],d=1===c.nodeType&&(c.className?(" "+c.className+" ").replace(ib," "):"")){for(h=0;g=b[h++];)for(;0<=d.indexOf(" "+g+" ");)d=d.replace(" "+g+" "," ");c.className=a?e.trim(d):""}return this},toggleClass:function(a,b){var c=typeof a,d="boolean"==typeof b;return e.isFunction(a)?
this.each(function(c){e(this).toggleClass(a.call(this,c,this.className,b),b)}):this.each(function(){if("string"===c)for(var g,h=0,m=e(this),i=b,k=a.match(X)||[];g=k[h++];)i=d?i:!m.hasClass(g),m[i?"addClass":"removeClass"](g);else(c===Da||"boolean"===c)&&(this.className&&z.set(this,"__className__",this.className),this.className=this.className||!1===a?"":z.get(this,"__className__")||"")})},hasClass:function(a){for(var a=" "+a+" ",b=0,c=this.length;c>b;b++)if(1===this[b].nodeType&&0<=(" "+this[b].className+
" ").replace(ib," ").indexOf(a))return!0;return!1},val:function(a){var c,d,g,v=this[0];if(arguments.length)return g=e.isFunction(a),this.each(function(d){var l,v=e(this);1===this.nodeType&&(l=g?a.call(this,d,v.val()):a,null==l?l="":"number"==typeof l?l+="":e.isArray(l)&&(l=e.map(l,function(a){return null==a?"":a+""})),c=e.valHooks[this.type]||e.valHooks[this.nodeName.toLowerCase()],c&&"set"in c&&c.set(this,l,"value")!==b||(this.value=l))});if(v)return c=e.valHooks[v.type]||e.valHooks[v.nodeName.toLowerCase()],
c&&"get"in c&&(d=c.get(v,"value"))!==b?d:(d=v.value,"string"==typeof d?d.replace(Kc,""):null==d?"":d)}});e.extend({valHooks:{option:{get:function(a){var b=a.attributes.value;return!b||b.specified?a.value:a.text}},select:{get:function(a){for(var b,c=a.options,d=a.selectedIndex,g="select-one"===a.type||0>d,h=g?null:[],m=g?d+1:c.length,i=0>d?m:g?d:0;m>i;i++)if(b=c[i],!(!b.selected&&i!==d||(e.support.optDisabled?b.disabled:null!==b.getAttribute("disabled"))||b.parentNode.disabled&&e.nodeName(b.parentNode,
"optgroup"))){if(a=e(b).val(),g)return a;h.push(a)}return h},set:function(a,b){for(var c,d,g=a.options,h=e.makeArray(b),m=g.length;m--;)d=g[m],(d.selected=0<=e.inArray(e(d).val(),h))&&(c=!0);return c||(a.selectedIndex=-1),h}}},attr:function(a,c,d){var g,v,h=a.nodeType;if(a&&3!==h&&8!==h&&2!==h)return typeof a.getAttribute===Da?e.prop(a,c,d):(1===h&&e.isXMLDoc(a)||(c=c.toLowerCase(),g=e.attrHooks[c]||(e.expr.match.boolean.test(c)?Mb:void 0)),d===b?g&&"get"in g&&null!==(v=g.get(a,c))?v:(v=e.find.attr(a,
c),null==v?b:v):null!==d?g&&"set"in g&&(v=g.set(a,d,c))!==b?v:(a.setAttribute(c,d+""),d):(e.removeAttr(a,c),b))},removeAttr:function(a,b){var c,d,g=0,h=b&&b.match(X);if(h&&1===a.nodeType)for(;c=h[g++];)d=e.propFix[c]||c,e.expr.match.boolean.test(c)&&(a[d]=!1),a.removeAttribute(c)},attrHooks:{type:{set:function(a,b){if(!e.support.radioValue&&"radio"===b&&e.nodeName(a,"input")){var c=a.value;return a.setAttribute("type",b),c&&(a.value=c),b}}}},propFix:{"for":"htmlFor","class":"className"},prop:function(a,
c,d){var g,v,h,m=a.nodeType;if(a&&3!==m&&8!==m&&2!==m)return h=1!==m||!e.isXMLDoc(a),h&&(c=e.propFix[c]||c,v=e.propHooks[c]),d!==b?v&&"set"in v&&(g=v.set(a,d,c))!==b?g:a[c]=d:v&&"get"in v&&null!==(g=v.get(a,c))?g:a[c]},propHooks:{tabIndex:{get:function(a){return a.hasAttribute("tabindex")||Lc.test(a.nodeName)||a.href?a.tabIndex:-1}}}});Mb={set:function(a,b,c){return!1===b?e.removeAttr(a,c):a.setAttribute(c,c),c}};e.each(e.expr.match.boolean.source.match(/\w+/g),function(a,c){var d=e.expr.attrHandle[c]||
e.find.attr;e.expr.attrHandle[c]=function(a,c,s){var g=e.expr.attrHandle[c],a=s?b:(e.expr.attrHandle[c]=b)!=d(a,c,s)?c.toLowerCase():null;return e.expr.attrHandle[c]=g,a}});e.support.optSelected||(e.propHooks.selected={get:function(a){a=a.parentNode;return a&&a.parentNode&&a.parentNode.selectedIndex,null}});e.each("tabIndex readOnly maxLength cellSpacing cellPadding rowSpan colSpan useMap frameBorder contentEditable".split(" "),function(){e.propFix[this.toLowerCase()]=this});e.each(["radio","checkbox"],
function(){e.valHooks[this]={set:function(a,c){return e.isArray(c)?a.checked=0<=e.inArray(e(a).val(),c):b}};e.support.checkOn||(e.valHooks[this].get=function(a){return null===a.getAttribute("value")?"on":a.value})});var Mc=/^key/,Nc=/^(?:mouse|contextmenu)|click/,Nb=/^(?:focusinfocus|focusoutblur)$/,Ob=/^([^.]*)(?:\.(.+)|)$/;e.event={global:{},add:function(a,c,d,g,h){var i,m,k,j,p,n,r,q,u,w;if(p=z.get(a)){d.handler&&(i=d,d=i.handler,h=i.selector);d.guid||(d.guid=e.guid++);(j=p.events)||(j=p.events=
{});(m=p.handle)||(m=p.handle=function(a){return typeof e===Da||a&&e.event.triggered===a.type?b:e.event.dispatch.apply(m.elem,arguments)},m.elem=a);c=(c||"").match(X)||[""];for(p=c.length;p--;)k=Ob.exec(c[p])||[],u=w=k[1],k=(k[2]||"").split(".").sort(),u&&(r=e.event.special[u]||{},u=(h?r.delegateType:r.bindType)||u,r=e.event.special[u]||{},n=e.extend({type:u,origType:w,data:g,handler:d,guid:d.guid,selector:h,needsContext:h&&e.expr.match.needsContext.test(h),namespace:k.join(".")},i),(q=j[u])||(q=
j[u]=[],q.delegateCount=0,r.setup&&!1!==r.setup.call(a,g,k,m)||a.addEventListener&&a.addEventListener(u,m,!1)),r.add&&(r.add.call(a,n),n.handler.guid||(n.handler.guid=d.guid)),h?q.splice(q.delegateCount++,0,n):q.push(n),e.event.global[u]=!0);a=null}},remove:function(a,b,c,d,g){var h,m,i,k,j,p,n,r,q,u,w,y=z.hasData(a)&&z.get(a);if(y&&(k=y.events)){b=(b||"").match(X)||[""];for(j=b.length;j--;)if(i=Ob.exec(b[j])||[],q=w=i[1],u=(i[2]||"").split(".").sort(),q){n=e.event.special[q]||{};q=(d?n.delegateType:
n.bindType)||q;r=k[q]||[];i=i[2]&&RegExp("(^|\\.)"+u.join("\\.(?:.*\\.|)")+"(\\.|$)");for(m=h=r.length;h--;)p=r[h],!g&&w!==p.origType||c&&c.guid!==p.guid||i&&!i.test(p.namespace)||d&&d!==p.selector&&("**"!==d||!p.selector)||(r.splice(h,1),p.selector&&r.delegateCount--,n.remove&&n.remove.call(a,p));m&&!r.length&&(n.teardown&&!1!==n.teardown.call(a,u,y.handle)||e.removeEvent(a,q,y.handle),delete k[q])}else for(q in k)e.event.remove(a,q+b[j],c,d,!0);e.isEmptyObject(k)&&(delete y.handle,z.remove(a,"events"))}},
trigger:function(c,d,g,h){var v,i,m,k,j,p,n,r=[g||x],q=Ya.call(c,"type")?c.type:c;v=Ya.call(c,"namespace")?c.namespace.split("."):[];if(i=m=g=g||x,3!==g.nodeType&&8!==g.nodeType&&!Nb.test(q+e.event.triggered)&&(0<=q.indexOf(".")&&(v=q.split("."),q=v.shift(),v.sort()),j=0>q.indexOf(":")&&"on"+q,c=c[e.expando]?c:new e.Event(q,"object"==typeof c&&c),c.isTrigger=h?2:3,c.namespace=v.join("."),c.namespace_re=c.namespace?RegExp("(^|\\.)"+v.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,c.result=b,c.target||(c.target=
g),d=null==d?[c]:e.makeArray(d,[c]),n=e.event.special[q]||{},h||!n.trigger||!1!==n.trigger.apply(g,d))){if(!h&&!n.noBubble&&!e.isWindow(g)){k=n.delegateType||q;for(Nb.test(k+q)||(i=i.parentNode);i;i=i.parentNode)r.push(i),m=i;m===(g.ownerDocument||x)&&r.push(m.defaultView||m.parentWindow||a)}for(v=0;(i=r[v++])&&!c.isPropagationStopped();)c.type=1<v?k:n.bindType||q,(p=(z.get(i,"events")||{})[c.type]&&z.get(i,"handle"))&&p.apply(i,d),(p=j&&i[j])&&e.acceptData(i)&&p.apply&&!1===p.apply(i,d)&&c.preventDefault();
return c.type=q,h||c.isDefaultPrevented()||n._default&&!1!==n._default.apply(r.pop(),d)||!e.acceptData(g)||j&&e.isFunction(g[q])&&!e.isWindow(g)&&(m=g[j],m&&(g[j]=null),e.event.triggered=q,g[q](),e.event.triggered=b,m&&(g[j]=m)),c.result}},dispatch:function(a){var a=e.event.fix(a),c,d,g,h,i,m=[],k=ja.call(arguments);c=(z.get(this,"events")||{})[a.type]||[];var j=e.event.special[a.type]||{};if(k[0]=a,a.delegateTarget=this,!j.preDispatch||!1!==j.preDispatch.call(this,a)){m=e.event.handlers.call(this,
a,c);for(c=0;(h=m[c++])&&!a.isPropagationStopped();){a.currentTarget=h.elem;for(d=0;(i=h.handlers[d++])&&!a.isImmediatePropagationStopped();)(!a.namespace_re||a.namespace_re.test(i.namespace))&&(a.handleObj=i,a.data=i.data,g=((e.event.special[i.origType]||{}).handle||i.handler).apply(h.elem,k),g!==b&&!1===(a.result=g)&&(a.preventDefault(),a.stopPropagation()))}return j.postDispatch&&j.postDispatch.call(this,a),a.result}},handlers:function(a,c){var d,g,h,i,m=[],k=c.delegateCount,j=a.target;if(k&&j.nodeType&&
(!a.button||"click"!==a.type))for(;j!==this;j=j.parentNode||this)if(!0!==j.disabled||"click"!==a.type){g=[];for(d=0;k>d;d++)i=c[d],h=i.selector+" ",g[h]===b&&(g[h]=i.needsContext?0<=e(h,this).index(j):e.find(h,this,null,[j]).length),g[h]&&g.push(i);g.length&&m.push({elem:j,handlers:g})}return c.length>k&&m.push({elem:this,handlers:c.slice(k)}),m},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:["char",
"charCode","key","keyCode"],filter:function(a,b){return null==a.which&&(a.which=null!=b.charCode?b.charCode:b.keyCode),a}},mouseHooks:{props:"button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,c){var d,e,g,h=c.button;return null==a.pageX&&null!=c.clientX&&(d=a.target.ownerDocument||x,e=d.documentElement,g=d.body,a.pageX=c.clientX+(e&&e.scrollLeft||g&&g.scrollLeft||0)-(e&&e.clientLeft||g&&g.clientLeft||0),a.pageY=c.clientY+(e&&e.scrollTop||
g&&g.scrollTop||0)-(e&&e.clientTop||g&&g.clientTop||0)),a.which||h===b||(a.which=1&h?1:2&h?3:4&h?2:0),a}},fix:function(a){if(a[e.expando])return a;var b,c,d;b=a.type;var g=a,h=this.fixHooks[b];h||(this.fixHooks[b]=h=Nc.test(b)?this.mouseHooks:Mc.test(b)?this.keyHooks:{});d=h.props?this.props.concat(h.props):this.props;a=new e.Event(g);for(b=d.length;b--;)c=d[b],a[c]=g[c];return 3===a.target.nodeType&&(a.target=a.target.parentNode),h.filter?h.filter(a,g):a},special:{load:{noBubble:!0},focus:{trigger:function(){return this!==
i()&&this.focus?(this.focus(),!1):b},delegateType:"focusin"},blur:{trigger:function(){return this===i()&&this.blur?(this.blur(),!1):b},delegateType:"focusout"},click:{trigger:function(){return"checkbox"===this.type&&this.click&&e.nodeName(this,"input")?(this.click(),!1):b},_default:function(a){return e.nodeName(a.target,"a")}},beforeunload:{postDispatch:function(a){a.result!==b&&(a.originalEvent.returnValue=a.result)}}},simulate:function(a,b,c,d){a=e.extend(new e.Event,c,{type:a,isSimulated:!0,originalEvent:{}});
d?e.event.trigger(a,null,b):e.event.dispatch.call(b,a);a.isDefaultPrevented()&&c.preventDefault()}};e.removeEvent=function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c,!1)};e.Event=function(a,c){return this instanceof e.Event?(a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||a.getPreventDefault&&a.getPreventDefault()?h:j):this.type=a,c&&e.extend(this,c),this.timeStamp=a&&a.timeStamp||e.now(),this[e.expando]=!0,b):new e.Event(a,c)};e.Event.prototype=
{isDefaultPrevented:j,isPropagationStopped:j,isImmediatePropagationStopped:j,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=h;a&&a.preventDefault&&a.preventDefault()},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=h;a&&a.stopPropagation&&a.stopPropagation()},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=h;this.stopPropagation()}};e.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(a,b){e.event.special[a]=
{delegateType:b,bindType:b,handle:function(a){var c,d=a.relatedTarget,g=a.handleObj;return(!d||d!==this&&!e.contains(this,d))&&(a.type=g.origType,c=g.handler.apply(this,arguments),a.type=b),c}}});e.support.focusinBubbles||e.each({focus:"focusin",blur:"focusout"},function(a,b){var c=0,d=function(a){e.event.simulate(b,a.target,e.event.fix(a),!0)};e.event.special[b]={setup:function(){0===c++&&x.addEventListener(a,d,!0)},teardown:function(){0===--c&&x.removeEventListener(a,d,!0)}}});e.fn.extend({on:function(a,
c,d,g,h){var i,m;if("object"==typeof a){"string"!=typeof c&&(d=d||c,c=b);for(m in a)this.on(m,c,d,a[m],h);return this}if(null==d&&null==g?(g=c,d=c=b):null==g&&("string"==typeof c?(g=d,d=b):(g=d,d=c,c=b)),!1===g)g=j;else if(!g)return this;return 1===h&&(i=g,g=function(a){return e().off(a),i.apply(this,arguments)},g.guid=i.guid||(i.guid=e.guid++)),this.each(function(){e.event.add(this,a,g,d,c)})},one:function(a,b,c,d){return this.on(a,b,c,d,1)},off:function(a,c,d){var g,h;if(a&&a.preventDefault&&a.handleObj)return g=
a.handleObj,e(a.delegateTarget).off(g.namespace?g.origType+"."+g.namespace:g.origType,g.selector,g.handler),this;if("object"==typeof a){for(h in a)this.off(h,c,a[h]);return this}return(!1===c||"function"==typeof c)&&(d=c,c=b),!1===d&&(d=j),this.each(function(){e.event.remove(this,a,d,c)})},trigger:function(a,b){return this.each(function(){e.event.trigger(a,b,this)})},triggerHandler:function(a,c){var d=this[0];return d?e.event.trigger(a,c,d,!0):b}});var ec=/^.[^:#\[\.,]*$/,Pb=e.expr.match.needsContext,
Oc={children:!0,contents:!0,next:!0,prev:!0};e.fn.extend({find:function(a){var b,c,d,g=this.length;if("string"!=typeof a)return b=this,this.pushStack(e(a).filter(function(){for(d=0;g>d;d++)if(e.contains(b[d],this))return!0}));c=[];for(d=0;g>d;d++)e.find(a,this[d],c);return c=this.pushStack(1<g?e.unique(c):c),c.selector=(this.selector?this.selector+" ":"")+a,c},has:function(a){var b=e(a,this),c=b.length;return this.filter(function(){for(var a=0;c>a;a++)if(e.contains(this,b[a]))return!0})},not:function(a){return this.pushStack(p(this,
a||[],!0))},filter:function(a){return this.pushStack(p(this,a||[],!1))},is:function(a){return!!a&&("string"==typeof a?Pb.test(a)?0<=e(a,this.context).index(this[0]):0<e.filter(a,this).length:0<this.filter(a).length)},closest:function(a,b){for(var c,d=0,g=this.length,h=[],i=Pb.test(a)||"string"!=typeof a?e(a,b||this.context):0;g>d;d++)for(c=this[d];c&&c!==b;c=c.parentNode)if(11>c.nodeType&&(i?-1<i.index(c):1===c.nodeType&&e.find.matchesSelector(c,a))){h.push(c);break}return this.pushStack(1<h.length?
e.unique(h):h)},index:function(a){return a?"string"==typeof a?za.call(e(a),this[0]):za.call(this,a.jquery?a[0]:a):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(a,b){var c="string"==typeof a?e(a,b):e.makeArray(a&&a.nodeType?[a]:a),c=e.merge(this.get(),c);return this.pushStack(e.unique(c))},addBack:function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}});e.each({parent:function(a){return(a=a.parentNode)&&11!==a.nodeType?a:null},parents:function(a){return e.dir(a,
"parentNode")},parentsUntil:function(a,b,c){return e.dir(a,"parentNode",c)},next:function(a){return n(a,"nextSibling")},prev:function(a){return n(a,"previousSibling")},nextAll:function(a){return e.dir(a,"nextSibling")},prevAll:function(a){return e.dir(a,"previousSibling")},nextUntil:function(a,b,c){return e.dir(a,"nextSibling",c)},prevUntil:function(a,b,c){return e.dir(a,"previousSibling",c)},siblings:function(a){return e.sibling((a.parentNode||{}).firstChild,a)},children:function(a){return e.sibling(a.firstChild)},
contents:function(a){return e.nodeName(a,"iframe")?a.contentDocument||a.contentWindow.document:e.merge([],a.childNodes)}},function(a,b){e.fn[a]=function(c,d){var g=e.map(this,b,c);return"Until"!==a.slice(-5)&&(d=c),d&&"string"==typeof d&&(g=e.filter(d,g)),1<this.length&&(Oc[a]||e.unique(g),"p"===a[0]&&g.reverse()),this.pushStack(g)}});e.extend({filter:function(a,b,c){var d=b[0];return c&&(a=":not("+a+")"),1===b.length&&1===d.nodeType?e.find.matchesSelector(d,a)?[d]:[]:e.find.matches(a,e.grep(b,function(a){return 1===
a.nodeType}))},dir:function(a,c,d){for(var g=[],h=d!==b;(a=a[c])&&9!==a.nodeType;)if(1===a.nodeType){if(h&&e(a).is(d))break;g.push(a)}return g},sibling:function(a,b){for(var c=[];a;a=a.nextSibling)1===a.nodeType&&a!==b&&c.push(a);return c}});var Qb=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,Rb=/<([\w:]+)/,Pc=/<|&#?\w+;/,Qc=/<(?:script|style|link)/i,Sb=/^(?:checkbox|radio)$/i,Rc=/checked\s*(?:[^=]|=\s*.checked.)/i,Tb=/^$|\/(?:java|ecma)script/i,fc=/^true\/(.*)/,Sc=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,
Q={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};Q.optgroup=Q.option;Q.tbody=Q.tfoot=Q.colgroup=Q.caption=Q.col=Q.thead;Q.th=Q.td;e.fn.extend({text:function(a){return e.access(this,function(a){return a===b?e.text(this):this.empty().append((this[0]&&this[0].ownerDocument||x).createTextNode(a))},null,a,arguments.length)},append:function(){return this.domManip(arguments,
function(a){(1===this.nodeType||11===this.nodeType||9===this.nodeType)&&k(this,a).appendChild(a)})},prepend:function(){return this.domManip(arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=k(this,a);b.insertBefore(a,b.firstChild)}})},before:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this)})},after:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this.nextSibling)})},
remove:function(a,b){for(var c,d=a?e.filter(a,this):this,g=0;null!=(c=d[g]);g++)b||1!==c.nodeType||e.cleanData(y(c)),c.parentNode&&(b&&e.contains(c.ownerDocument,c)&&u(y(c,"script")),c.parentNode.removeChild(c));return this},empty:function(){for(var a,b=0;null!=(a=this[b]);b++)1===a.nodeType&&(e.cleanData(y(a,!1)),a.textContent="");return this},clone:function(a,b){return a=null==a?!1:a,b=null==b?a:b,this.map(function(){return e.clone(this,a,b)})},html:function(a){return e.access(this,function(a){var c=
this[0]||{},d=0,g=this.length;if(a===b&&1===c.nodeType)return c.innerHTML;if("string"==typeof a&&!Qc.test(a)&&!Q[(Rb.exec(a)||["",""])[1].toLowerCase()]){a=a.replace(Qb,"<$1></$2>");try{for(;g>d;d++)c=this[d]||{},1===c.nodeType&&(e.cleanData(y(c,!1)),c.innerHTML=a);c=0}catch(s){}}c&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(){var a=e.map(this,function(a){return[a.nextSibling,a.parentNode]}),b=0;return this.domManip(arguments,function(c){var d=a[b++],g=a[b++];g&&(e(this).remove(),
g.insertBefore(c,d))},!0),b?this:this.remove()},detach:function(a){return this.remove(a,!0)},domManip:function(a,b,c){var a=vb.apply([],a),d,g,h,i,k=0,j=this.length,p=this,n=j-1,u=a[0],w=e.isFunction(u);if(w||!(1>=j||"string"!=typeof u||e.support.checkClone)&&Rc.test(u))return this.each(function(d){var e=p.eq(d);w&&(a[0]=u.call(this,d,e.html()));e.domManip(a,b,c)});if(j&&(d=e.buildFragment(a,this[0].ownerDocument,!1,!c&&this),g=d.firstChild,1===d.childNodes.length&&(d=g),g)){g=e.map(y(d,"script"),
r);for(h=g.length;j>k;k++)i=d,k!==n&&(i=e.clone(i,!0,!0),h&&e.merge(g,y(i,"script"))),b.call(this[k],i,k);if(h){d=g[g.length-1].ownerDocument;e.map(g,q);for(k=0;h>k;k++)i=g[k],Tb.test(i.type||"")&&!z.access(i,"globalEval")&&e.contains(d,i)&&(i.src?e._evalUrl(i.src):e.globalEval(i.textContent.replace(Sc,"")))}}return this}});e.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){e.fn[a]=function(a){for(var c=[],d=e(a),g=d.length-
1,s=0;g>=s;s++)a=s===g?this:this.clone(!0),e(d[s])[b](a),Xa.apply(c,a.get());return this.pushStack(c)}});e.extend({clone:function(a,b,c){var d,g,h,i,k=a.cloneNode(!0),j=e.contains(a.ownerDocument,a);if(!e.support.noCloneChecked&&!(1!==a.nodeType&&11!==a.nodeType||e.isXMLDoc(a))){i=y(k);h=y(a);d=0;for(g=h.length;g>d;d++){var p=h[d],n=i[d],r=n.nodeName.toLowerCase();"input"===r&&Sb.test(p.type)?n.checked=p.checked:("input"===r||"textarea"===r)&&(n.defaultValue=p.defaultValue)}}if(b)if(c){h=h||y(a);
i=i||y(k);d=0;for(g=h.length;g>d;d++)w(h[d],i[d])}else w(a,k);return i=y(k,"script"),0<i.length&&u(i,!j&&y(a,"script")),k},buildFragment:function(a,b,c,d){for(var g,h,i,k,j=0,p=a.length,n=b.createDocumentFragment(),r=[];p>j;j++)if(g=a[j],g||0===g)if("object"===e.type(g))e.merge(r,g.nodeType?[g]:g);else if(Pc.test(g)){h=h||n.appendChild(b.createElement("div"));i=(Rb.exec(g)||["",""])[1].toLowerCase();i=Q[i]||Q._default;h.innerHTML=i[1]+g.replace(Qb,"<$1></$2>")+i[2];for(i=i[0];i--;)h=h.firstChild;
e.merge(r,h.childNodes);h=n.firstChild;h.textContent=""}else r.push(b.createTextNode(g));n.textContent="";for(j=0;g=r[j++];)if((!d||-1===e.inArray(g,d))&&(k=e.contains(g.ownerDocument,g),h=y(n.appendChild(g),"script"),k&&u(h),c))for(i=0;g=h[i++];)Tb.test(g.type||"")&&c.push(g);return n},cleanData:function(a){for(var b,c,d,g=a.length,h=0,i=e.event.special;g>h;h++){if(c=a[h],e.acceptData(c)&&(b=z.access(c)))for(d in b.events)i[d]?e.event.remove(c,d):e.removeEvent(c,d,b.handle);F.discard(c);z.discard(c)}},
_evalUrl:function(a){return e.ajax({url:a,type:"GET",dataType:"text",async:!1,global:!1,success:e.globalEval})}});e.fn.extend({wrapAll:function(a){var b;return e.isFunction(a)?this.each(function(b){e(this).wrapAll(a.call(this,b))}):(this[0]&&(b=e(a,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){for(var a=this;a.firstElementChild;)a=a.firstElementChild;return a}).append(this)),this)},wrapInner:function(a){return e.isFunction(a)?this.each(function(b){e(this).wrapInner(a.call(this,
b))}):this.each(function(){var b=e(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=e.isFunction(a);return this.each(function(c){e(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){e.nodeName(this,"body")||e(this).replaceWith(this.childNodes)}).end()}});var pa,ta,Tc=/^(none|table(?!-c[ea]).+)/,Ub=/^margin/,hc=RegExp("^("+Ga+")(.*)$","i"),Ta=RegExp("^("+Ga+")(?!px)[a-z%]+$","i"),Uc=RegExp("^([+-])=("+Ga+")","i"),nb={BODY:"block"},
Vc={position:"absolute",visibility:"hidden",display:"block"},Vb={letterSpacing:0,fontWeight:400},ia=["Top","Right","Bottom","Left"],mb=["Webkit","O","Moz","ms"];e.fn.extend({css:function(c,d){return e.access(this,function(c,d,g){var h,s={},i=0;if(e.isArray(d)){g=a.getComputedStyle(c,null);for(h=d.length;h>i;i++)s[d[i]]=e.css(c,d[i],!1,g);return s}return g!==b?e.style(c,d,g):e.css(c,d)},c,d,1<arguments.length)},show:function(){return N(this,!0)},hide:function(){return N(this)},toggle:function(a){var b=
"boolean"==typeof a;return this.each(function(){(b?a:I(this))?e(this).show():e(this).hide()})}});e.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=pa(a,"opacity");return""===c?"1":c}}}},cssNumber:{columnCount:!0,fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":"cssFloat"},style:function(a,c,d,g){if(a&&3!==a.nodeType&&8!==a.nodeType&&a.style){var h,i,k,j=e.camelCase(c),p=a.style;return c=e.cssProps[j]||(e.cssProps[j]=G(p,j)),k=
e.cssHooks[c]||e.cssHooks[j],d===b?k&&"get"in k&&(h=k.get(a,!1,g))!==b?h:p[c]:(i=typeof d,"string"===i&&(h=Uc.exec(d))&&(d=(h[1]+1)*h[2]+parseFloat(e.css(a,c)),i="number"),null==d||"number"===i&&isNaN(d)||("number"!==i||e.cssNumber[j]||(d+="px"),e.support.clearCloneStyle||""!==d||0!==c.indexOf("background")||(p[c]="inherit"),k&&"set"in k&&(d=k.set(a,d,g))===b||(p[c]=d)),b)}},css:function(a,c,d,g){var h,i,k,j=e.camelCase(c);return c=e.cssProps[j]||(e.cssProps[j]=G(a.style,j)),k=e.cssHooks[c]||e.cssHooks[j],
k&&"get"in k&&(h=k.get(a,!0,d)),h===b&&(h=pa(a,c,g)),"normal"===h&&c in Vb&&(h=Vb[c]),""===d||d?(i=parseFloat(h),!0===d||e.isNumeric(i)?i||0:h):h}});pa=function(c,d,g){var h,i,k,j=(g=g||a.getComputedStyle(c,null))?g.getPropertyValue(d)||g[d]:b,p=c.style;return g&&(""!==j||e.contains(c.ownerDocument,c)||(j=e.style(c,d)),Ta.test(j)&&Ub.test(d)&&(h=p.width,i=p.minWidth,k=p.maxWidth,p.minWidth=p.maxWidth=p.width=j,j=g.width,p.width=h,p.minWidth=i,p.maxWidth=k)),j};e.each(["height","width"],function(c,
d){e.cssHooks[d]={get:function(a,c,g){return c?0===a.offsetWidth&&Tc.test(e.css(a,"display"))?e.swap(a,Vc,function(){return ba(a,d,g)}):ba(a,d,g):b},set:function(b,c,g){var h=g&&a.getComputedStyle(b,null);return S(b,c,g?K(b,d,g,e.support.boxSizing&&"border-box"===e.css(b,"boxSizing",!1,h),h):0)}}});e(function(){e.support.reliableMarginRight||(e.cssHooks.marginRight={get:function(a,c){return c?e.swap(a,{display:"inline-block"},pa,[a,"marginRight"]):b}});!e.support.pixelPosition&&e.fn.position&&e.each(["top",
"left"],function(a,c){e.cssHooks[c]={get:function(a,d){return d?(d=pa(a,c),Ta.test(d)?e(a).position()[c]+"px":d):b}}})});e.expr&&e.expr.filters&&(e.expr.filters.hidden=function(a){return 0>=a.offsetWidth&&0>=a.offsetHeight},e.expr.filters.visible=function(a){return!e.expr.filters.hidden(a)});e.each({margin:"",padding:"",border:"Width"},function(a,b){e.cssHooks[a+b]={expand:function(c){for(var d=0,e={},c="string"==typeof c?c.split(" "):[c];4>d;d++)e[a+ia[d]+b]=c[d]||c[d-2]||c[0];return e}};Ub.test(a)||
(e.cssHooks[a+b].set=S)});var Wc=/%20/g,ic=/\[\]$/,Wb=/\r?\n/g,Xc=/^(?:submit|button|image|reset|file)$/i,Yc=/^(?:input|select|textarea|keygen)/i;e.fn.extend({serialize:function(){return e.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var a=e.prop(this,"elements");return a?e.makeArray(a):this}).filter(function(){var a=this.type;return this.name&&!e(this).is(":disabled")&&Yc.test(this.nodeName)&&!Xc.test(a)&&(this.checked||!Sb.test(a))}).map(function(a,b){var c=
e(this).val();return null==c?null:e.isArray(c)?e.map(c,function(a){return{name:b.name,value:a.replace(Wb,"\r\n")}}):{name:b.name,value:c.replace(Wb,"\r\n")}}).get()}});e.param=function(a,c){var d,g=[],h=function(a,b){b=e.isFunction(b)?b():null==b?"":b;g[g.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};if(c===b&&(c=e.ajaxSettings&&e.ajaxSettings.traditional),e.isArray(a)||a.jquery&&!e.isPlainObject(a))e.each(a,function(){h(this.name,this.value)});else for(d in a)Ua(d,a[d],c,h);return g.join("&").replace(Wc,
"+")};e.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){e.fn[b]=function(a,c){return 0<arguments.length?this.on(b,null,a,c):this.trigger(b)}});e.fn.extend({hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)},bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},
delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return 1===arguments.length?this.off(a,"**"):this.off(b,a||"**",c)}});var oa,ha,jb=e.now(),kb=/\?/,Zc=/#.*$/,Xb=/([?&])_=[^&]*/,$c=/^(.*?):[ \t]*([^\r\n]*)$/gm,ad=/^(?:GET|HEAD)$/,bd=/^\/\//,Yb=/^([\w.+-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,Zb=e.fn.load,$b={},Va={},ac="*/".concat("*");try{ha=kc.href}catch(id){ha=x.createElement("a"),ha.href="",ha=ha.href}oa=Yb.exec(ha.toLowerCase())||[];e.fn.load=function(a,c,d){if("string"!=
typeof a&&Zb)return Zb.apply(this,arguments);var g,h,i,k=this,j=a.indexOf(" ");return 0<=j&&(g=a.slice(j),a=a.slice(0,j)),e.isFunction(c)?(d=c,c=b):c&&"object"==typeof c&&(h="POST"),0<k.length&&e.ajax({url:a,type:h,dataType:"html",data:c}).done(function(a){i=arguments;k.html(g?e("<div>").append(e.parseHTML(a)).find(g):a)}).complete(d&&function(a,b){k.each(d,i||[a.responseText,b,a])}),this};e.each("ajaxStart ajaxStop ajaxComplete ajaxError ajaxSuccess ajaxSend".split(" "),function(a,b){e.fn[b]=function(a){return this.on(b,
a)}});e.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:ha,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(oa[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":ac,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},
converters:{"* text":String,"text html":!0,"text json":e.parseJSON,"text xml":e.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(a,b){return b?Wa(Wa(a,e.ajaxSettings),b):Wa(e.ajaxSettings,a)},ajaxPrefilter:pb($b),ajaxTransport:pb(Va),ajax:function(a,c){function d(a,c,k,s){var l,p,m,t,r=c;if(2!==I){I=2;j&&clearTimeout(j);g=b;i=s||"";D.readyState=0<a?4:0;s=200<=a&&300>a||304===a;if(k){m=q;for(var A=D,x,N,C,L,H=m.contents,S=m.dataTypes;"*"===S[0];)S.shift(),x===b&&(x=m.mimeType||A.getResponseHeader("Content-Type"));
if(x)for(N in H)if(H[N]&&H[N].test(x)){S.unshift(N);break}if(S[0]in k)C=S[0];else{for(N in k){if(!S[0]||m.converters[N+" "+S[0]]){C=N;break}L||(L=N)}C=C||L}m=C?(C!==S[0]&&S.unshift(C),k[C]):b}var E;a:{k=q;x=m;N=D;C=s;var K,ba,F;m={};A=k.dataTypes.slice();if(A[1])for(K in k.converters)m[K.toLowerCase()]=k.converters[K];for(L=A.shift();L;)if(k.responseFields[L]&&(N[k.responseFields[L]]=x),!F&&C&&k.dataFilter&&(x=k.dataFilter(x,k.dataType)),F=L,L=A.shift())if("*"===L)L=F;else if("*"!==F&&F!==L){if(K=
m[F+" "+L]||m["* "+L],!K)for(E in m)if(ba=E.split(" "),ba[1]===L&&(K=m[F+" "+ba[0]]||m["* "+ba[0]])){!0===K?K=m[E]:!0!==m[E]&&(L=ba[0],A.unshift(ba[1]));break}if(!0!==K)if(K&&k["throws"])x=K(x);else try{x=K(x)}catch(J){E={state:"parsererror",error:K?J:"No conversion from "+F+" to "+L};break a}}E={state:"success",data:x}}m=E;s?(q.ifModified&&(t=D.getResponseHeader("Last-Modified"),t&&(e.lastModified[h]=t),t=D.getResponseHeader("etag"),t&&(e.etag[h]=t)),204===a?r="nocontent":304===a?r="notmodified":
(r=m.state,l=m.data,p=m.error,s=!p)):(p=r,(a||!r)&&(r="error",0>a&&(a=0)));D.status=a;D.statusText=(c||r)+"";s?y.resolveWith(u,[l,r,D]):y.rejectWith(u,[D,r,p]);D.statusCode(z);z=b;n&&w.trigger(s?"ajaxSuccess":"ajaxError",[D,q,s?l:p]);G.fireWith(u,[D,r]);n&&(w.trigger("ajaxComplete",[D,q]),--e.active||e.event.trigger("ajaxStop"))}}"object"==typeof a&&(c=a,a=b);var c=c||{},g,h,i,k,j,p,n,r,q=e.ajaxSetup({},c),u=q.context||q,w=q.context&&(u.nodeType||u.jquery)?e(u):e.event,y=e.Deferred(),G=e.Callbacks("once memory"),
z=q.statusCode||{},A={},x={},I=0,N="canceled",D={readyState:0,getResponseHeader:function(a){var b;if(2===I){if(!k)for(k={};b=$c.exec(i);)k[b[1].toLowerCase()]=b[2];b=k[a.toLowerCase()]}return null==b?null:b},getAllResponseHeaders:function(){return 2===I?i:null},setRequestHeader:function(a,b){var c=a.toLowerCase();return I||(a=x[c]=x[c]||a,A[a]=b),this},overrideMimeType:function(a){return I||(q.mimeType=a),this},statusCode:function(a){var b;if(a)if(2>I)for(b in a)z[b]=[z[b],a[b]];else D.always(a[D.status]);
return this},abort:function(a){a=a||N;return g&&g.abort(a),d(0,a),this}};if(y.promise(D).complete=G.add,D.success=D.done,D.error=D.fail,q.url=((a||q.url||ha)+"").replace(Zc,"").replace(bd,oa[1]+"//"),q.type=c.method||c.type||q.method||q.type,q.dataTypes=e.trim(q.dataType||"*").toLowerCase().match(X)||[""],null==q.crossDomain&&(p=Yb.exec(q.url.toLowerCase()),q.crossDomain=!(!p||p[1]===oa[1]&&p[2]===oa[2]&&(p[3]||("http:"===p[1]?"80":"443"))===(oa[3]||("http:"===oa[1]?"80":"443")))),q.data&&q.processData&&
"string"!=typeof q.data&&(q.data=e.param(q.data,q.traditional)),qb($b,q,c,D),2===I)return D;(n=q.global)&&0===e.active++&&e.event.trigger("ajaxStart");q.type=q.type.toUpperCase();q.hasContent=!ad.test(q.type);h=q.url;q.hasContent||(q.data&&(h=q.url+=(kb.test(h)?"&":"?")+q.data,delete q.data),!1===q.cache&&(q.url=Xb.test(h)?h.replace(Xb,"$1_="+jb++):h+(kb.test(h)?"&":"?")+"_="+jb++));q.ifModified&&(e.lastModified[h]&&D.setRequestHeader("If-Modified-Since",e.lastModified[h]),e.etag[h]&&D.setRequestHeader("If-None-Match",
e.etag[h]));(q.data&&q.hasContent&&!1!==q.contentType||c.contentType)&&D.setRequestHeader("Content-Type",q.contentType);D.setRequestHeader("Accept",q.dataTypes[0]&&q.accepts[q.dataTypes[0]]?q.accepts[q.dataTypes[0]]+("*"!==q.dataTypes[0]?", "+ac+"; q=0.01":""):q.accepts["*"]);for(r in q.headers)D.setRequestHeader(r,q.headers[r]);if(q.beforeSend&&(!1===q.beforeSend.call(u,D,q)||2===I))return D.abort();N="abort";for(r in{success:1,error:1,complete:1})D[r](q[r]);if(g=qb(Va,q,c,D)){D.readyState=1;n&&
w.trigger("ajaxSend",[D,q]);q.async&&0<q.timeout&&(j=setTimeout(function(){D.abort("timeout")},q.timeout));try{I=1,g.send(A,d)}catch(C){if(!(2>I))throw C;d(-1,C)}}else d(-1,"No Transport");return D},getJSON:function(a,b,c){return e.get(a,b,c,"json")},getScript:function(a,c){return e.get(a,b,c,"script")}});e.each(["get","post"],function(a,c){e[c]=function(a,d,g,h){return e.isFunction(d)&&(h=h||g,g=d,d=b),e.ajax({url:a,type:c,dataType:h,data:d,success:g})}});e.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},
contents:{script:/(?:java|ecma)script/},converters:{"text script":function(a){return e.globalEval(a),a}}});e.ajaxPrefilter("script",function(a){a.cache===b&&(a.cache=!1);a.crossDomain&&(a.type="GET")});e.ajaxTransport("script",function(a){if(a.crossDomain){var b,c;return{send:function(d,g){b=e("<script>").prop({async:!0,charset:a.scriptCharset,src:a.url}).on("load error",c=function(a){b.remove();c=null;a&&g("error"===a.type?404:200,a.type)});x.head.appendChild(b[0])},abort:function(){c&&c()}}}});
var bc=[],lb=/(=)\?(?=&|$)|\?\?/;e.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var a=bc.pop()||e.expando+"_"+jb++;return this[a]=!0,a}});e.ajaxPrefilter("json jsonp",function(c,d,g){var h,i,k,j=!1!==c.jsonp&&(lb.test(c.url)?"url":"string"==typeof c.data&&!(c.contentType||"").indexOf("application/x-www-form-urlencoded")&&lb.test(c.data)&&"data");return j||"jsonp"===c.dataTypes[0]?(h=c.jsonpCallback=e.isFunction(c.jsonpCallback)?c.jsonpCallback():c.jsonpCallback,j?c[j]=c[j].replace(lb,"$1"+
h):!1!==c.jsonp&&(c.url+=(kb.test(c.url)?"&":"?")+c.jsonp+"="+h),c.converters["script json"]=function(){return k||e.error(h+" was not called"),k[0]},c.dataTypes[0]="json",i=a[h],a[h]=function(){k=arguments},g.always(function(){a[h]=i;c[h]&&(c.jsonpCallback=d.jsonpCallback,bc.push(h));k&&e.isFunction(i)&&i(k[0]);k=i=b}),"script"):b});e.ajaxSettings.xhr=function(){try{return new XMLHttpRequest}catch(a){}};var xa=e.ajaxSettings.xhr(),cd={"0":200,1223:204},dd=0,ya={};a.ActiveXObject&&e(a).on("unload",
function(){for(var a in ya)ya[a]();ya=b});e.support.cors=!!xa&&"withCredentials"in xa;e.support.ajax=xa=!!xa;e.ajaxTransport(function(a){var c;return e.support.cors||xa&&!a.crossDomain?{send:function(d,e){var g,h,i=a.xhr();if(i.open(a.type,a.url,a.async,a.username,a.password),a.xhrFields)for(g in a.xhrFields)i[g]=a.xhrFields[g];a.mimeType&&i.overrideMimeType&&i.overrideMimeType(a.mimeType);a.crossDomain||d["X-Requested-With"]||(d["X-Requested-With"]="XMLHttpRequest");for(g in d)i.setRequestHeader(g,
d[g]);c=function(a){return function(){c&&(delete ya[h],c=i.onload=i.onerror=null,"abort"===a?i.abort():"error"===a?e(i.status||404,i.statusText):e(cd[i.status]||i.status,i.statusText,"string"==typeof i.responseText?{text:i.responseText}:b,i.getAllResponseHeaders()))}};i.onload=c();i.onerror=c("error");c=ya[h=dd++]=c("abort");i.send(a.hasContent&&a.data||null)},abort:function(){c&&c()}}:b});var qa,Sa,ed=/^(?:toggle|show|hide)$/,fd=RegExp("^(?:([+-])=|)("+Ga+")([a-z%]*)$","i"),gd=/queueHooks$/,Aa=[function(a,
c,d){var g,h,i,k,j,p,n=this,q=a.style,r={},u=[],w=a.nodeType&&I(a);d.queue||(j=e._queueHooks(a,"fx"),null==j.unqueued&&(j.unqueued=0,p=j.empty.fire,j.empty.fire=function(){j.unqueued||p()}),j.unqueued++,n.always(function(){n.always(function(){j.unqueued--;e.queue(a,"fx").length||j.empty.fire()})}));1===a.nodeType&&("height"in c||"width"in c)&&(d.overflow=[q.overflow,q.overflowX,q.overflowY],"inline"===e.css(a,"display")&&"none"===e.css(a,"float")&&(q.display="inline-block"));d.overflow&&(q.overflow=
"hidden",n.always(function(){q.overflow=d.overflow[0];q.overflowX=d.overflow[1];q.overflowY=d.overflow[2]}));k=z.get(a,"fxshow");for(g in c)if(i=c[g],ed.exec(i)){if(delete c[g],h=h||"toggle"===i,i===(w?"hide":"show")){if("show"!==i||k===b||k[g]===b)continue;w=!0}u.push(g)}if(c=u.length){k=z.get(a,"fxshow")||z.access(a,"fxshow",{});"hidden"in k&&(w=k.hidden);h&&(k.hidden=!w);w?e(a).show():n.done(function(){e(a).hide()});n.done(function(){var b;z.remove(a,"fxshow");for(b in r)e.style(a,b,r[b])});for(g=
0;c>g;g++)h=u[g],i=n.createTween(h,w?k[h]:0),r[h]=k[h]||e.style(a,h),h in k||(k[h]=i.start,w&&(i.end=i.start,i.start="width"===h||"height"===h?1:0))}}],ua={"*":[function(a,b){var c,d,g=this.createTween(a,b),h=fd.exec(b),i=g.cur(),k=+i||0,j=1,p=20;if(h){if(c=+h[2],d=h[3]||(e.cssNumber[a]?"":"px"),"px"!==d&&k){k=e.css(g.elem,a,!0)||c||1;do j=j||".5",k/=j,e.style(g.elem,a,k+d);while(j!==(j=g.cur()/i)&&1!==j&&--p)}g.unit=d;g.start=k;g.end=h[1]?k+(h[1]+1)*c:c}return g}]};e.Animation=e.extend(sb,{tweener:function(a,
b){e.isFunction(a)?(b=a,a=["*"]):a=a.split(" ");for(var c,d=0,g=a.length;g>d;d++)c=a[d],ua[c]=ua[c]||[],ua[c].unshift(b)},prefilter:function(a,b){b?Aa.unshift(a):Aa.push(a)}});e.Tween=O;O.prototype={constructor:O,init:function(a,b,c,d,g,h){this.elem=a;this.prop=c;this.easing=g||"swing";this.options=b;this.start=this.now=this.cur();this.end=d;this.unit=h||(e.cssNumber[c]?"":"px")},cur:function(){var a=O.propHooks[this.prop];return a&&a.get?a.get(this):O.propHooks._default.get(this)},run:function(a){var b,
c=O.propHooks[this.prop];return this.pos=b=this.options.duration?e.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration):a,this.now=(this.end-this.start)*b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):O.propHooks._default.set(this),this}};O.prototype.init.prototype=O.prototype;O.propHooks={_default:{get:function(a){var b;return null==a.elem[a.prop]||a.elem.style&&null!=a.elem.style[a.prop]?(b=e.css(a.elem,a.prop,""),b&&"auto"!==
b?b:0):a.elem[a.prop]},set:function(a){e.fx.step[a.prop]?e.fx.step[a.prop](a):a.elem.style&&(null!=a.elem.style[e.cssProps[a.prop]]||e.cssHooks[a.prop])?e.style(a.elem,a.prop,a.now+a.unit):a.elem[a.prop]=a.now}}};O.propHooks.scrollTop=O.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}};e.each(["toggle","show","hide"],function(a,b){var c=e.fn[b];e.fn[b]=function(a,d,e){return null==a||"boolean"==typeof a?c.apply(this,arguments):this.animate(Ba(b,!0),
a,d,e)}});e.fn.extend({fadeTo:function(a,b,c,d){return this.filter(I).css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var g=e.isEmptyObject(a),h=e.speed(b,c,d),i=function(){var b=sb(this,e.extend({},a),h);i.finish=function(){b.stop(!0)};(g||z.get(this,"finish"))&&b.stop(!0)};return i.finish=i,g||!1===h.queue?this.each(i):this.queue(h.queue,i)},stop:function(a,c,d){var g=function(a){var b=a.stop;delete a.stop;b(d)};return"string"!=typeof a&&(d=c,c=a,a=b),c&&!1!==
a&&this.queue(a||"fx",[]),this.each(function(){var b=!0,c=null!=a&&a+"queueHooks",h=e.timers,i=z.get(this);if(c)i[c]&&i[c].stop&&g(i[c]);else for(c in i)i[c]&&i[c].stop&&gd.test(c)&&g(i[c]);for(c=h.length;c--;)h[c].elem!==this||null!=a&&h[c].queue!==a||(h[c].anim.stop(d),b=!1,h.splice(c,1));(b||!d)&&e.dequeue(this,a)})},finish:function(a){return!1!==a&&(a=a||"fx"),this.each(function(){var b,c=z.get(this),d=c[a+"queue"];b=c[a+"queueHooks"];var g=e.timers,h=d?d.length:0;c.finish=!0;e.queue(this,a,[]);
b&&b.cur&&b.cur.finish&&b.cur.finish.call(this);for(b=g.length;b--;)g[b].elem===this&&g[b].queue===a&&(g[b].anim.stop(!0),g.splice(b,1));for(b=0;h>b;b++)d[b]&&d[b].finish&&d[b].finish.call(this);delete c.finish})}});e.each({slideDown:Ba("show"),slideUp:Ba("hide"),slideToggle:Ba("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){e.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}});e.speed=function(a,b,c){var d=a&&"object"==typeof a?e.extend({},
a):{complete:c||!c&&b||e.isFunction(a)&&a,duration:a,easing:c&&b||b&&!e.isFunction(b)&&b};return d.duration=e.fx.off?0:"number"==typeof d.duration?d.duration:d.duration in e.fx.speeds?e.fx.speeds[d.duration]:e.fx.speeds._default,(null==d.queue||!0===d.queue)&&(d.queue="fx"),d.old=d.complete,d.complete=function(){e.isFunction(d.old)&&d.old.call(this);d.queue&&e.dequeue(this,d.queue)},d};e.easing={linear:function(a){return a},swing:function(a){return 0.5-Math.cos(a*Math.PI)/2}};e.timers=[];e.fx=O.prototype.init;
e.fx.tick=function(){var a,c=e.timers,d=0;for(qa=e.now();c.length>d;d++)a=c[d],a()||c[d]!==a||c.splice(d--,1);c.length||e.fx.stop();qa=b};e.fx.timer=function(a){a()&&e.timers.push(a)&&e.fx.start()};e.fx.interval=13;e.fx.start=function(){Sa||(Sa=setInterval(e.fx.tick,e.fx.interval))};e.fx.stop=function(){clearInterval(Sa);Sa=null};e.fx.speeds={slow:600,fast:200,_default:400};e.fx.step={};e.expr&&e.expr.filters&&(e.expr.filters.animated=function(a){return e.grep(e.timers,function(b){return a===b.elem}).length});
e.fn.offset=function(a){if(arguments.length)return a===b?this:this.each(function(b){e.offset.setOffset(this,a,b)});var c,d,g=this[0],h={top:0,left:0},i=g&&g.ownerDocument;if(i)return c=i.documentElement,e.contains(c,g)?(typeof g.getBoundingClientRect!==Da&&(h=g.getBoundingClientRect()),d=e.isWindow(i)?i:9===i.nodeType&&i.defaultView,{top:h.top+d.pageYOffset-c.clientTop,left:h.left+d.pageXOffset-c.clientLeft}):h};e.offset={setOffset:function(a,b,c){var d,g,h,i,k,j,p=e.css(a,"position"),n=e(a),q={};
"static"===p&&(a.style.position="relative");k=n.offset();h=e.css(a,"top");j=e.css(a,"left");("absolute"===p||"fixed"===p)&&-1<(h+j).indexOf("auto")?(d=n.position(),i=d.top,g=d.left):(i=parseFloat(h)||0,g=parseFloat(j)||0);e.isFunction(b)&&(b=b.call(a,c,k));null!=b.top&&(q.top=b.top-k.top+i);null!=b.left&&(q.left=b.left-k.left+g);"using"in b?b.using.call(a,q):n.css(q)}};e.fn.extend({position:function(){if(this[0]){var a,b,c=this[0],d={top:0,left:0};return"fixed"===e.css(c,"position")?b=c.getBoundingClientRect():
(a=this.offsetParent(),b=this.offset(),e.nodeName(a[0],"html")||(d=a.offset()),d.top+=e.css(a[0],"borderTopWidth",!0),d.left+=e.css(a[0],"borderLeftWidth",!0)),{top:b.top-d.top-e.css(c,"marginTop",!0),left:b.left-d.left-e.css(c,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var a=this.offsetParent||ub;a&&!e.nodeName(a,"html")&&"static"===e.css(a,"position");)a=a.offsetParent;return a||ub})}});e.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(c,d){var g=
"pageYOffset"===d;e.fn[c]=function(h){return e.access(this,function(c,h,i){var k=e.isWindow(c)?c:9===c.nodeType&&c.defaultView;return i===b?k?k[d]:c[h]:(k?k.scrollTo(g?a.pageXOffset:i,g?i:a.pageYOffset):c[h]=i,b)},c,h,arguments.length,null)}});e.each({Height:"height",Width:"width"},function(a,c){e.each({padding:"inner"+a,content:c,"":"outer"+a},function(d,g){e.fn[g]=function(g,h){var i=arguments.length&&(d||"boolean"!=typeof g),k=d||(!0===g||!0===h?"margin":"border");return e.access(this,function(c,
d,g){var h;return e.isWindow(c)?c.document.documentElement["client"+a]:9===c.nodeType?(h=c.documentElement,Math.max(c.body["scroll"+a],h["scroll"+a],c.body["offset"+a],h["offset"+a],h["client"+a])):g===b?e.css(c,d,k):e.style(c,d,g,k)},c,i?g:b,i,null)}})});e.fn.size=function(){return this.length};e.fn.andSelf=e.fn.addBack;"object"==typeof module&&"object"==typeof module.exports?module.exports=e:"function"==typeof define&&define.amd&&define("jquery",[],function(){return e});"object"==typeof a&&"object"==
typeof a.document&&(a.jQuery=a.$=e)})(window);var ResourceLoader;
(function(){var a,b=new Audio,c="ogg";"maybe"==b.canPlayType("audio/mp4")?c="mp4":"maybe"==b.canPlayType("audio/ogg")?c="ogg":"maybe"==b.canPlayType("audio/mp3")?c="mp3":"maybe"==b.canPlayType("audio/wav")&&(c="wav");a=c;var d=function(){var a=document.createElement("video");if("maybe"==a.canPlayType("video/webm"))return"webm";if("maybe"==a.canPlayType("video/mp4"))return"mp4";if("maybe"==a.canPlayType("video/ogg"))return"ogv"}(),g=3,h=3,j={},i={},n=function(a,b,c){var d=$.Deferred();c||(c="video"==
b?document.createElement("video"):new Audio);$(c).one("canplaythrough stalled suspend",function(){d.resolve(c)});$(c).one("error",function(){d.reject()});c.autoplay=!1;c.src="";c.src=a;c.load();setTimeout(function(){d.reject()},1E4);return d.promise()};ResourceLoader={loadImage:function(a,b){"undefined"===typeof b&&(b=!0);var c=a=a.toLowerCase();a in o2.imageList&&(a=o2.imageList[a]);if(a in i)return i[a].promise();var d=$.Deferred();if(a in j)d.resolve(j[a]);else{i[a]=d;var g=0,h,n=function(){var i=
a,j=$.Deferred(),G=new Image;$(G).one("readystatechange load",function(){G.complete||4==G.readyState||"complete"==G.readyState?j.resolve(G):$(G).trigger("error")});$(G).one("error",function(a){j.reject(a)});var K=setTimeout(function(){$(G).trigger("error")},1E4);j.always(function(){clearTimeout(K)});$(G).attr("src",i);h=j.promise();h.done(function(a){a.originalURL=c;d.resolve(a)}).fail(function(a){(browser.isIOs||browser.isAndroid)&&!navigator.onLine||10>g?(setTimeout(n,100),g++,b&&Renderer.showLoadingSign()):
b?(Renderer.hideLoadingSign(),Renderer.showServerError(function(){g=0;b&&Renderer.showLoadingSign();n()})):d.reject(a)})};n();var G;b&&(G=setTimeout(function(){Renderer.showLoadingSign()},3E3));d.done(function(b){j[a]=b});d.always(function(){b&&(clearTimeout(G),Renderer.hideLoadingSign());delete d[a]})}return d.promise()},loadAudio:function(b,c,d){function h(){n(b+"."+a,"audio",d).done(function(a){i.resolve(a)}).fail(function(a){(browser.isIOs||browser.isAndroid)&&!navigator.onLine||j<g?(setTimeout(h,
100),j++,c&&Renderer.showLoadingSign()):c?(Renderer.hideLoadingSign(),Renderer.showServerError(function(){j=0;c&&Renderer.showLoadingSign();h()})):i.reject(a)})}"undefined"===typeof c&&(c=!0);b=b.toLowerCase();b in o2.soundList&&(b=o2.soundList[b]);var i=$.Deferred(),j=0;h();var y;c&&(y=setTimeout(function(){Renderer.showLoadingSign()},3E3));i.always(function(){c&&(clearTimeout(y),Renderer.hideLoadingSign())});return i.promise()},loadVideo:function(a,b,c){function g(){n(a+"."+d,"video",c).done(function(a){i.resolve(a)}).fail(function(a){(browser.isIOs||
browser.isAndroid)&&!navigator.onLine||j<h?(setTimeout(g,100),j++,b&&Renderer.showLoadingSign()):b?(Renderer.hideLoadingSign(),Renderer.showServerError(function(){j=0;b&&Renderer.showLoadingSign();g()})):i.reject(a)})}"undefined"===typeof b&&(b=!0);a=a.toLowerCase();if(a in o2.videoList)a=o2.videoList[a];else throw"\u30e0\u30fc\u30d3\u30fc\u30b9\u30c8\u30ec\u30fc\u30b8 "+a+" \u304c\u5b58\u5728\u3057\u307e\u305b\u3093";var i=$.Deferred(),j=0;g();var y;b&&(y=setTimeout(function(){Renderer.showLoadingSign()},
3E3));i.always(function(){b&&(clearTimeout(y),Renderer.hideLoadingSign())});return i.promise()},loadFont:function(a,b){var c=a,d=$.Deferred();if(a in o2.fontList)a=o2.fontList[a];else return d.resolve();$("head").prepend('<style type="text/css">@font-face {font-family: "'+c+'";src: url("'+a+'.ttf"),     url("'+a+'.woff");}</style>');$("body").append($("<div />").css({"font-family":c,height:0,width:0,opacity:0,margin:0}).html("."));var g,h;setTimeout(function G(){isFontLoaded(c)?d.resolve():setTimeout(G,
100)},100);_loadFont=function(){b&&(g=setTimeout(function(){Renderer.showLoadingSign()},3E3),h=setTimeout(function(){d.reject()},1E4))};_loadFont();d.always(function(){clearTimeout(g);clearTimeout(h);Renderer.hideLoadingSign()});return d.promise()}}})();
var Conductor=function(a){this.waitTag={};this.file;this.lineNumber=-1;this.currentTag;this.oneShotStackDepth=0;this.tagActions;this.stack=[];this.status=Conductor.STATUS_STOP;this.callStack=[];this.macroStack=[];this.macros={};this.ifStack=[];a&&a.file&&this.setFile(a.file);var b=this;this.stack.push=function(a){if(a instanceof Tag){var d=Array.prototype.push.apply(this,arguments);if("click"in b.waitTag)trigger("click");else if(b.status==Conductor.STATUS_STOP)b.oneShot();return d}}};
Conductor.STATUS_STOP=0;Conductor.STATUS_RUN=1;Conductor.STATUS_WAIT=2;Conductor.prototype.toJSON=function(){result={currentTag:this.currentTag,ifStack:this.ifStack};config.saveMode==o2.SAVE_MODE_O2KAG&&(result.macroStack=this.macroStack,result.callStack=this.callStack);return result};
Conductor.prototype.importFromSaveData=function(a){this.macroStack=[];this.ifStack=[];this.callStack=[];this.setTag(a.currentTag.restore(),!0);this.status!=Conductor.STATUS_RUN&&setTimeout(function(){});delete a.currentTag;return Object.prototype.importFromSaveData.call(this,a)};
Conductor.prototype.run=function(){this.waitTag={};this.status=Conductor.STATUS_RUN;if(this.stack.length)this.currentTag=this.stack.shift();else{this.currentTag=this.file.lines[this.lineNumber];if(!this.currentTag){var a=new Tag("s");this.stack.push(a);this.oneShot();return}a="\u30d5\u30a1\u30a4\u30eb: "+this.file.filename+" / ";a+="\u884c:"+(this.currentTag.originalLineNumber||this.currentTag.lineNumber)+" / ";"undefined"!=typeof this.currentTag.originalCharNumber&&(a+="\u6587\u5b57:"+this.currentTag.originalCharNumber+
" / ");a=a+"\u30bf\u30b0: "+this.macroStack.map(function(a){return a.definition.name}).concat([this.currentTag.tagName]).join(" > ");this.callStack.length&&(a+="\ncall stack: ",a+=this.callStack.map(function(a){a=a.file.lines[a.lineNumber-1];a.normalizedArgs(a.args);return a.file.filename+":"+a.originalLineNumber+" : "+a.tagName}).join(" > "));o2.log(a);this.lineNumber++}this.currentTag.conductor=this;a=!0;if("o2_cond"in this.currentTag.args)try{eval(this.currentTag.args.o2_cond)||(a=!1)}catch(b){a=
!1}if(a){if(this.isMacro(this.currentTag)){this.jumpIntoMacro(this.currentTag);return}if(this.shouldMacroEnd()){this.jumpOutOfMacro();return}a=this.currentTag.run();void 0==a&&(a=0)}else o2.log("o2_cond\u306e\u8a55\u4fa1\u7d50\u679c\u304cfalse\u3060\u3063\u305f\u305f\u3081\u5b9f\u884c\u3055\u308c\u307e\u305b\u3093\u3067\u3057\u305f"),a=0;delete this.currentTag.conductor;$(this).trigger("ran",[a]);0==a?(this.oneShotStackDepth++,this.oneShot()):1==a?(this.oneShotStackDepth=0,wait(this.currentTag.tagName)):
2==a&&(this.oneShotStackDepth=0,this.status=Conductor.STATUS_STOP)};Conductor.prototype.setFile=function(a){this.setTag(a.line(0))};Conductor.prototype.setTag=function(a,b){this.file=a.file;this.lineNumber=a.lineNumber;b&&this.lineNumber++};Conductor.prototype.getNextTag=function(a){if(!a)return this.stack.length?this.stack[0]:this.file.lines[this.lineNumber];for(var b=this.upCommingTags(),c=0;c<b.length;c++)if(b[c].tagName==a)return b[c]};Conductor.prototype.upCommingTags=function(){return this.stack.concat(this.file.lines.slice(this.lineNumber))};
Conductor.prototype.oneShot=function(){if(5E3>this.oneShotStackDepth)this.run();else{var a=this;setTimeout(function(){a.oneShotStackDepth=0;a.run()})}};
(function(){function a(){window.mp=currentConductor.macroStack.length?currentConductor.macroStack[currentConductor.macroStack.length-1].args:{}}Conductor.prototype.isMacro=function(a){a instanceof Tag&&(a=a.tagName);return a in this.macros};Conductor.prototype.jumpIntoMacro=function(b){var c=new Macro,d;if(b instanceof Tag){d=this.macros[b.tagName];if(!d)throw"\u767b\u9332\u3055\u308c\u3066\u3044\u306a\u3044\u30de\u30af\u30ed "+b.tagName+" \u304c\u547c\u3073\u51fa\u3055\u308c\u307e\u3057\u305f";c.args=
b.argsForAction()}else d=this.macros[b];c.definition=d;c.returnTag=this.getNextTag();this.macroStack.push(c);a();this.setTag(d.startTag);this.oneShot()};Conductor.prototype.shouldMacroEnd=function(){return!this.macroStack.length?!1:"endmacro"==this.currentTag.tagName?!0:!1};Conductor.prototype.jumpOutOfMacro=function(){var b=this.macroStack.pop();a();b&&this.setTag(b.returnTag);this.oneShot()};Conductor.prototype.clearMacroStack=function(){this.macroStack=[];a()}})();
Conductor.prototype.clearIfStack=function(){this.ifStack=[]};Conductor.prototype.reset=function(){this.stack.splice(0,this.stack.length);this.status=Conductor.STATUS_STOP;this.callStack=[];this.macroStack=[];this.macros={};this.ifStack=[]};Conductor.prototype.wait=function(a,b){this.status=Conductor.STATUS_WAIT;a instanceof Tag&&(a=a.tagName);a in this.waitTag||(this.waitTag[a]=[]);b&&this.waitTag[a].push(b)};
Conductor.prototype.trigger=function(a){var b=[],c=!1;a instanceof Tag&&(a=a.tagName);a in this.waitTag?a in this.waitTag&&(c=!0,b=b.concat(this.waitTag[a])):"click"==a&&(0==Object.keys(this.waitTag).length&&this.status!=Conductor.STATUS_STOP)&&(c=!0);for(a=0;a<b.length;a++)b[a]();return c?(this.oneShot(),!0):!1};var trigger=function(){return currentConductor.trigger.apply(currentConductor,arguments)},wait=function(){return currentConductor.wait.apply(currentConductor,arguments)};
MacroDefinition=function(a){this.name=a.name;this.startTag=a.startTag;this.endTag=a.endTag};Macro=function(a){a&&(this.definition=a.definition,this.returnTag=a.returnTag,this.args=a.args)};Macro.prototype.initializer="Macro";
var SubRoutineConductor=function(){Conductor.call(this);var a,b=this;Object.defineProperty(this,"tagActions",{get:function(){if(!a||Object.keys(Tag.actions).length!=Object.keys(a).length){var c={},d;for(d in Tag.actions)c[d]=Tag.actions[d];c["return"]=new TagAction({rules:Tag.actions["return"].rules,action:function(a){if(0==b.callStack.length){currentConductor=conductor;o2.skipMode=o2.SKIP_MODE_NONE;if(a.storage||a.target)a=new Tag("jump",a),currentConductor.stack.push(a);return 2}return Tag.actions["return"].action.call(this,
a)}});config.saveMode==o2.SAVE_MODE_KAG3?c.label=new TagAction({action:function(a){return a.caption?(this.error("\u30b5\u30d6\u30eb\u30fc\u30c1\u30f3\u5185\u306b\u30bb\u30fc\u30d6\u53ef\u80fd\u306a\u30e9\u30d9\u30eb\u3092\u7f6e\u304f\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093"),0):Tag.actions.label.action.call(this,a)}}):c.o2_savestat=new TagAction({action:function(){this.error("\u30b5\u30d6\u30eb\u30fc\u30c1\u30f3\u5185\u306bo2_savestat\u30bf\u30b0\u3092\u7f6e\u304f\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093");
return 0}});a=c}return a}});Object.defineProperty(this,"macros",{get:function(){return conductor.macros}})};SubRoutineConductor.prototype=Object.create(Conductor.prototype);
function clone(a,b){if(a&&a.clone&&"function"===typeof a.clone)return a.clone(a);if(null==a||"object"!=typeof a||/\[object HTML[A-Za-z]*Element\]/.test(Object.prototype.toString.apply(a))||/\[object Window\]/.test(Object.prototype.toString.apply(a)))return a;if(a instanceof Date){var c=new Date;c.setTime(a.getTime());return c}if(a instanceof Array){for(var c=[],d=0,g=a.length;d<g;d++)c[d]=clone(a[d]);return c}if(a instanceof Object){c=window[a.initializer]?new window[a.initializer]:new a.constructor;
b&&(c.originalReference=a);if("function"===typeof c.importFrom)c.importFrom(a);else for(d in a)a.hasOwnProperty(d)&&(c[d]=clone(a[d]));return c}throw Error("[\u5185\u90e8\u30a8\u30e9\u30fc] \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u30b3\u30d4\u30fc\u3067\u304d\u307e\u305b\u3093\u3002\u3053\u306e\u578b\u306f\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u307e\u305b\u3093");}
browser={isIE:-1!=navigator.userAgent.indexOf("MSIE"),isFirefox:-1!=navigator.userAgent.toLowerCase().indexOf("firefox"),isNativeApp:-1!=navigator.userAgent.toLowerCase().indexOf("adsphere"),isIOs:navigator.userAgent.match(/(iPad|iPhone|iPod)/i)?!0:!1,isAndroid:navigator.userAgent.match(/(android)/i)?!0:!1};
Event.prototype.normalizedCoordinate=function(a){var b=document.getElementById("main-wrapper");returnCoordinate=this.changedTouches?{x:(this.changedTouches[0].pageX-b.getBoundingClientRect().left)/scale+0,y:(this.changedTouches[0].pageY-b.getBoundingClientRect().top)/scale+0}:{x:(this.clientX-b.getBoundingClientRect().left)/scale+0,y:(this.clientY-b.getBoundingClientRect().top)/scale+0};a instanceof Layer&&(returnCoordinate=a.localLocation(returnCoordinate.x,returnCoordinate.y));return returnCoordinate};
var scaleToFitPage,scale=1,setPageScale;
(function(){function a(){var a=window,b=document,g=b.documentElement,b=b.getElementsByTagName("body")[0];return{width:a.innerWidth||g.clientWidth||b.clientWidth,height:a.innerHeight||g.clientHeight||b.clientHeight}}setPageScale=function(a){scale!=a&&(scale=a,$("#main-wrapper").css("transformOrigin","0% 0%").css("transform","scale("+scale+")"))};var b;scaleToFitPage=function(){var c=a();if(!b||!(b.width==c.width&&b.height==c.height)){var d=document.body;d.style.overflow="hidden";d.style.height=browser.isIOs&&
window==window.top?2*c.height+"px":c.height+"px";window.scrollTo(0,0);b=c=a();d=Math.min(c.width/config.scWidth,c.height/config.scHeight);setPageScale(d);$("#main-wrapper").css("top",(c.height-config.scHeight*d)/2+"px").css("left",(c.width-config.scWidth*d)/2+"px");return this}}})();
function KeySpline(a,b,c,d){this.get=function(g){if(a==b&&c==d)return g;a:{for(var h=g,j=0;4>j;++j){var i=3*(1-3*c+3*a)*h*h+2*(3*c-6*a)*h+3*a;if(0==i){g=h;break a}h-=((((1-3*c+3*a)*h+(3*c-6*a))*h+3*a)*h-g)/i}g=h}return(((1-3*d+3*b)*g+(3*d-6*b))*g+3*b)*g}}
function B_Spline_Generator(a){var b=a.length,c=b-1,d=b+2,g=(b+1)/100;return function(b){var b=g*(0>b?0:100<b?100:b)-1,j={x:0,y:0},i,n,p,k;for(i=-2;i<d;i++)n=b-i,p=1>(n=Math.abs(n))?(k=3*n*n,(n*k-2*k+4)/6):2>n?(k=n-2,k*k*k/-6):0,n=0>i?0:c<i?c:i,j.x+=a[n][0]*p,j.y+=a[n][1]*p;return j}}
function supportCssProperty(a){"string"==typeof a&&(a=[a]);for(var b=0;b<a.length;b++){var c=a[b],d=document.body;if("string"!=typeof d.style[c]&&"string"!=typeof d.style["Webkit"+c.substring(0,1).toUpperCase()+c.substring(1)]&&"string"!=typeof d.style["Moz"+c.substring(0,1).toUpperCase()+c.substring(1)]&&"string"!=typeof d.style["O"+c.substring(0,1).toUpperCase()+c.substring(1)])return!1}return!0}
(function(){browser.isAndroid&&(window.requestAnimationFrame=function(a){window.setTimeout(a,1E3/60)});for(var a=0,b=Date.now(),c=["ms","moz","webkit","o"],d=0;d<c.length&&!window.requestAnimationFrame;++d)window.requestAnimationFrame=window[c[d]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[c[d]+"CancelAnimationFrame"]||window[c[d]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(c){var d=(new Date).getTime(),j=Math.max(0,16-(d-a)),
i=window.setTimeout(function(){c(d-b)},j);a=d+j;return i});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})})();(function(){if(window.chrome){var a=CanvasRenderingContext2D.prototype.fillText;CanvasRenderingContext2D.prototype.fillText=function(b,c,d,g){if(-1==b.indexOf("\u3000"))return a.apply(this,arguments);for(var h=b.split(""),j=c,i=0;i<h.length;i++){var n=h[i],p=this.measureText(n).width;if(c+p-j>g)break;a.call(this,n,c,d);c+=p}}}})();
Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!==typeof this)throw new TypeError("[\u5185\u90e8\u30a8\u30e9\u30fc] Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},g=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};d.prototype=this.prototype;g.prototype=new d;return g});
function hexToRgb(a){return(a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a))?{r:parseInt(a[1],16),g:parseInt(a[2],16),b:parseInt(a[3],16)}:null}$(function(){$.fn.bindFirst=function(a,b){this.on(a,b);this.each(function(){var b=$._data(this,"events")[a.split(".")[0]],d=b.pop();b.splice(0,0,d)})}});
function wheelDistance(a){a||(a=event);var b=0,c=0,c=a.wheelDelta,d=a.detail;d?c?c=0<c/d/40*d?1:-1:a.deltaX||a.deltaY?(b=a.deltaX,c=a.deltaY):c=-d/3:a.wheelDeltaX||a.wheelDeltaY?(c=a.wheelDeltaY/120,b=a.wheelDeltaX/120):a.deltaX||a.deltaY?(b=-a.deltaX/3,c=-a.deltaY/3):c/=120;"DOMMouseScroll"==a.type?(c*=40,b*=40):browser.isIE||(c*=10,b*=10);return{x:b,y:c}}
function multiplyMatrix(a,b){for(var c=a.length,d=a[0].length,g=b[0].length,h=[],j=0;j<c;j++){h[j]=[];for(var i=0;i<g;i++){for(var n=0,p=0;p<d;p++)n+=a[j][p]*b[p][i];h[j][i]=n}}return h}var isFontLoaded;
(function(){var a=null,b=null,c={};isFontLoaded=function(d){a||(a=document.createElement("canvas"),b=a.getContext("2d"));for(var g=["monospace","sans-serif","serif"],h=0,j=g.length;h<j;h++){var i=g[h],n=c[i];n||(b.font="72px "+i,n=c[i]=b.measureText("0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz").width);var p=c[d];p||(b.font="72px "+d+","+i,p=b.measureText("0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz").width);if(n!=p)return c[d]=p,!0}return!1}})(this);
var KAGFiles,KAGFile;
(function(){var a={};KAGFiles=function(b,c){return void 0==c?a[b]:a[b]=c};KAGFile=function(a){this.filename=a;this.lines=[];this.labels=[];KAGFiles(a,this);var c=this;this.lines.push=function(a){a.file=c;a.lineNumber=this.length;"label"==a.tagName&&c.labels.push(a);return Array.prototype.push.apply(this,arguments)}};KAGFile.prototype.line=function(a){return this.lines[a]};KAGFile.prototype.getLabelTag=function(a){for(var c=0;c<this.labels.length;c++)if(this.labels[c].args.name==a)return this.labels[c];
return null}})();Rect=function(){if(4==arguments.length)return new Rect({x:arguments[0],y:arguments[1],width:arguments[2],height:arguments[3]});if(1==arguments.length&&"object"===typeof arguments[0])for(var a in arguments[0])this[a]=arguments[0][a];else this.x=this.y=this.width=this.height=0};Rect.prototype.initializer="Rect";Rect.prototype.isEqual=function(a){return a.x==this.x&&a.y==this.y&&a.width==this.width&&a.height==this.height};
Rect.prototype.isZero=function(){return this.isEqual(new Rect(0,0,0,0))};Rect.prototype.coverCoordinate=function(a,b){return a>=this.x&&a<this.x+this.width&&b>this.y&&b<this.y+this.height?!0:!1};Rect.prototype.extend=function(a){(0==this.width||0==this.height)&&$.extend(this,a);var b=Math.min(a.x,this.x),c=Math.min(a.y,this.y),d=Math.max(a.x+a.width,this.x+this.width);maxY=Math.max(a.y+a.height,this.y+this.height);this.x=b;this.y=c;this.width=d-b;this.height=maxY-c};
Rect.prototype.intersect=function(a){if(a.x+a.width>this.x&&a.x<this.x+this.width&&a.y+a.height>this.y&&a.y<this.y+this.height){var b=Math.max(this.x,a.x),c=Math.max(this.y,a.y),d=Math.min(this.x+this.width,a.x+a.width),a=Math.min(this.y+this.height,a.y+a.height);return new Rect({x:b,y:c,width:d-b,height:a-c})}return!1};Rect.prototype.round=function(){this.x=~~(0.5+this.x);this.y=~~(0.5+this.y);this.width=~~(0.5+this.width);this.height=~~(0.5+this.height)};
Drawable=function(a){this.rect=clone(a)||new Rect;this.needRedraw=!0;this.partialDraw=!1};Drawable.prototype.initializer="Drawable";Drawable.prototype.objectToBeSerialized=function(a){switch(a){case "needRedraw":case "partialDraw":return}return this[a]};Drawable.prototype.importFrom=function(a){this.rect=clone(a.rect);this.transform=clone(a.transform)};Drawable.prototype.drawOnContext=function(){};Drawable.prototype.frame=function(){return this.rect};Drawable.prototype.canDrawPartial=function(){return!1};
DrawableCanvas=function(a){Drawable.call(this,a);this.canvas=document.createElement("canvas");this.canvas.width=this.rect.width;this.canvas.height=this.rect.height;this.ctx=this.canvas.getContext("2d")};DrawableCanvas.prototype=new Drawable;DrawableCanvas.prototype.initializer="DrawableCanvas";DrawableCanvas.prototype.objectToBeSerialized=function(a){switch(a){case canvas:case ctx:return}return this[a]};DrawableCanvas.prototype.canDrawPartial=function(){return!0};
DrawableCanvas.prototype.clone=function(a){var b=new DrawableCanvas;b.importFrom(a);b.canvas.width=this.rect.width;b.canvas.height=this.rect.height;b.ctx.drawImage(a.canvas,0,0);return b};DrawableCanvas.prototype.drawOnContext=function(a,b){if(b){var c=b.intersect(this.rect);a.drawImage(this.canvas,c.x-this.rect.x,c.y-this.rect.y,c.width,c.height,c.x,c.y,c.width,c.height)}else a.drawImage(this.canvas,this.rect.x,this.rect.y,this.rect.width,this.rect.height)};
DrawableSolidColor=function(a){Drawable.call(this,a);this.color="#000000";this.opacity=1};DrawableSolidColor.prototype=new Drawable;DrawableSolidColor.prototype.initializer="DrawableSolidColor";DrawableSolidColor.prototype.canDrawPartial=function(){return!0};DrawableSolidColor.prototype.drawOnContext=function(a,b){b=b?b.intersect(this.rect):this.rect;a.save();a.globalAlpha=this.opacity;a.fillStyle=this.color;a.fillRect(b.x,b.y,b.width,b.height);a.restore()};
DrawableSolidColor.prototype.importFrom=function(a){a instanceof DrawableSolidColor&&(this.color=a.color,this.opacity=a.opacity)};DrawableImage=function(a,b,c){Drawable.call(this);if(null==a)throw"image needed";null==b&&(b=0);null==c&&(c=0);Drawable.call(this,new Rect(b,c,a.width,a.height));this.image=a;this.cacheEnabled=!0;this.cacheCanvas;this.options={}};DrawableImage.prototype=new Drawable;DrawableImage.prototype.initializer="DrawableImage";
DrawableImage.prototype.objectToBeSerialized=function(a){switch(a){case "image":if(this.image.originalURL)return this.image.originalURL;case "cacheCanvas":return}return this[a]};DrawableImage.restore=function(a){return $.when(ResourceLoader.loadImage(a.image,!0)).then(function(b){b=new DrawableImage(b);b.importFrom(a);return b})};DrawableImage.prototype.canDrawPartial=function(){return!0};
DrawableImage.prototype.clone=function(a){if(!(a instanceof DrawableImage))throw"[\u5185\u90e8\u30a8\u30e9\u30fc] DrawableImage\u3067\u306f\u3042\u308a\u307e\u305b\u3093";var b=new DrawableImage(a.image);b.importFrom(a);this.cacheCanvas&&(b.cacheCanvas=document.createElement("canvas"),b.cacheCanvas.width=this.cacheCanvas.width,b.cacheCanvas.height=this.cacheCanvas.height,b.cacheCanvas.getContext("2d").drawImage(this.cacheCanvas,0,0));return b};
DrawableImage.prototype.importFrom=function(a){this.options=clone(a.options);this.rect=clone(a.rect)};
DrawableImage.prototype.drawOnContext=function(a,b){b||(b=this.rect);var c=0,d=0,g=this.rect.width,h=this.rect.height;this.options.clipLeft&&(c+=this.options.clipLeft,g-=this.options.clipLeft);this.options.clipTop&&(d+=this.options.clipTop,h-=this.options.clipTop);this.options.clipWidth&&(g=this.options.clipWidth);this.options.clipHeight&&(h=this.options.clipHeight);var j=b.intersect(new Rect({x:this.rect.x,y:this.rect.y,width:g,height:h}));if(j){var i=this.image;if(this.cacheCanvas)i=this.cacheCanvas;
else{var n=this,p,k=function(){$(i).is("canvas")||(n.cacheCanvas=document.createElement("canvas"),n.cacheCanvas.width=i.width,n.cacheCanvas.height=i.height,p=n.cacheCanvas.getContext("2d"),p.drawImage(i,0,0),i=n.cacheCanvas)};if(0!=c||0!=d||g!=this.rect.width||h!=this.rect.height){k();var r=document.createElement("canvas");r.width=g;r.height=h;tempContext=r.getContext("2d");tempContext.drawImage(this.cacheCanvas,c,d,g,h,0,0,g,h);this.cacheCanvas.width=g;this.cacheCanvas.height=h;p.drawImage(r,0,0)}this.options.flipLR&&
(k(),r=document.createElement("canvas"),r.width=this.cacheCanvas.width,r.height=this.cacheCanvas.height,tempContext=r.getContext("2d"),tempContext.translate(this.cacheCanvas.width,0),tempContext.scale(-1,1),tempContext.drawImage(this.cacheCanvas,0,0),p.drawImage(r,0,0));this.options.flipUD&&(k(),r=document.createElement("canvas"),r.width=this.cacheCanvas.width,r.height=this.cacheCanvas.height,tempContext=r.getContext("2d"),tempContext.translate(0,this.cacheCanvas.height),tempContext.scale(1,-1),tempContext.drawImage(this.cacheCanvas,
0,0),p.drawImage(r,0,0));if(this.options.grayscale){k();c=p.getImageData(0,0,i.width,i.height);d=c.data;for(g=0;g<d.length;g+=4)h=0.34*d[g]+0.5*d[g+1]+0.16*d[g+2],d[g]=h,d[g+1]=h,d[g+2]=h;p.putImageData(c,0,0)}}a.save();"opacity"in this.options&&(a.globalAlpha=this.options.opacity);a.drawImage(i,j.x-this.rect.x,j.y-this.rect.y,j.width,j.height,j.x,j.y,j.width,j.height);a.restore();this.cacheEnabled||(this.cacheCanvas=null)}};
var Renderer=function(){this.animator=new Animator(this);this.foreLayers=[];this.backLayers=[];this.foreCanvas=document.createElement("canvas");this.foreCtx=this.foreCanvas.getContext("2d");this.backCanvas=document.createElement("canvas");this.backCtx=this.backCanvas.getContext("2d");this.yShift=this.xShift=0;this.foreCanvas.width=this.backCanvas.width=config.scWidth;this.foreCanvas.height=this.backCanvas.height=config.scHeight;this.renderBackCanvas=!1;this.transForeCanvas;this.transBackCanvas;this.transCanvas};
Renderer.prototype={render:function(){for(var a=-1,b=this.foreLayers.length-1;0<=b;b--)if(this.foreLayers[b].transTag){a=b;break}this.foreCtx.clearRect(0,0,this.foreCanvas.width,this.foreCanvas.height);(this.renderBackCanvas||0<=a)&&this.backCtx.clearRect(0,0,this.backCanvas.width,this.backCanvas.height);this.foreCtx.save();this.foreCtx.translate(this.xShift,this.yShift);for(var c=!1,b=0;b<this.foreLayers.length;b++){var d=this.foreLayers[b],g=this.backLayers[b];d.flush();g.flush();if(d.transTag){this.transForeCanvas||
(this.transForeCanvas=document.createElement("canvas"),this.transBackCanvas=document.createElement("canvas"),this.transCanvas=document.createElement("canvas"),this.transForeCanvas.width=this.transBackCanvas.width=this.transCanvas.width=this.backCanvas.width,this.transForeCanvas.height=this.transBackCanvas.height=this.transCanvas.height=this.foreCanvas.height);var h=this.transForeCanvas.getContext("2d"),j=this.transBackCanvas.getContext("2d");h.clearRect(0,0,this.transForeCanvas.width,this.transForeCanvas.height);
j.clearRect(0,0,this.transBackCanvas.width,this.transBackCanvas.height);j.drawImage(this.backCanvas,0,0);g.drawOnContext(j);h.drawImage(this.foreCanvas,0,0);d.drawOnContext(h);d.transTag.method.transit.call(d.transTag,d.transTag.transArgs,this.transForeCanvas,this.transBackCanvas,this.transCanvas);this.foreCtx.drawImage(this.transCanvas,0,0,this.transCanvas.width,this.transCanvas.height)}else if(d.drawOnContext(this.foreCtx),this.renderBackCanvas||b<=a)c=!0,g.drawOnContext(this.backCtx)}o2.historyLayer.flush();
o2.historyLayer.drawOnContext(this.foreCtx);this.foreCtx.restore();$(this.foreCanvas).trigger("draw");c&&$(this.backCanvas).trigger("draw")}};Renderer.showLoadingSign=function(){$("#loading").show()};Renderer.hideLoadingSign=function(){$("#loading").hide()};Renderer.showServerError=function(a){$("#error").show();$("#retryButton").one("click",function(){Renderer.hideServerError();a()})};Renderer.hideServerError=function(){$("#error").hide()};
Renderer.askForLogin=function(){var a=$.Deferred();if(o2.serverStat.mode!=o2.SERVER_MODE_O2SERVER||-1!=o2.serverStat.uid)return a.resolve();$("#login-box iframe").one("load",function(){$("#login-box").fadeIn()}).attr("src",o2.serverStat.userServer+"/auth/login_box");$(window).one("message",function(b){b=b.originalEvent;"login/cancel"==b.data?(Renderer.closeLoginBox(),a.reject()):"login/success"==b.data&&(Renderer.closeLoginBox(),$.getScript(o2.serverStat.userServer+"/js?id="+config.gameID).then(function(){return loadSystemStateFromServer()}).then(function(){saveCurrentSystemState();
$(o2).trigger("loginbox.loggedin");a.resolve()}))});return a.promise()};Renderer.closeLoginBox=function(){$("#login-box").fadeOut("fast",function(){$("#login-box iframe").attr("src","")});scaleToFitPage()};var Animator=function(a){this.renderer=a;this.animationRequests=[];this.timeoutId=this.nextCallTimestamp=void 0};
Animator.prototype={requestFrame:function(a,b){void 0==b&&(b=0);a||(a=function(){});var c=Date.now()+b;if(c<this.nextCallTimestamp||void 0==this.nextCallTimestamp)clearTimeout(this.timeoutId),0<b?this.timeoutId=setTimeout(this.animationLoopCalled.bind(this),b):requestAnimationFrame(this.animationLoopCalled.bind(this)),this.nextCallTimestamp=c;this.animationRequests.push({callback:a,begin:c})},animationLoopCalled:function(){window.meter&&window.meter.tickStart();this.nextCallTimestamp=void 0;var a=
this.animationRequests;this.animationRequests=[];for(var b=[],c=0;c<a.length;c++){var d=a[c],g=d.begin-Date.now();0<g?b.push(d):"function"===typeof d.callback&&d.callback()}for(c=0;c<b.length;c++)d=b[c],g=d.begin-Date.now(),this.requestFrame(d.callback,g);this.renderer.render();window.meter&&window.meter.tick()}};
Layer=function(a){Drawable.call(this,a);this.rect.width||(this.rect.width=config.scWidth);this.rect.height||(this.rect.height=config.scHeight);this.canvas=document.createElement("canvas");this.canvas.width=this.rect.width;this.canvas.height=this.rect.height;this.ctx=this.canvas.getContext("2d");this.stackedClearRect=new Rect;this.requestedFrame=!1;this.visible=!0;this.opacity=1;this.rotation=0;this.scale=1;this.transformOrigin={x:0,y:0};this.cachedTransform={};this.moveTag=this.transTag=void 0};
Layer.prototype=new Drawable;Layer.prototype.initializer="Layer";Layer.prototype.objectToBeSerialized=function(a){switch(a){case "canvas":case "ctx":case "cachedTransform":case "transTag":case "moveTag":return}return this[a]};Layer.prototype.importFromSaveData=function(a){var b=this;return Drawable.prototype.importFromSaveData.call(this,a).done(function(){b.setRect()})};
Layer.prototype.importFrom=function(a){this.rect=clone(a.rect);this.visible=a.visible;this.opacity=a.opacity;this.canvas.width=a.canvas.width;this.canvas.height=a.canvas.height;this.redrawRect();this.transTag=void 0;this.rotation=a.rotation;this.scale=a.scale;this.transformOrigin=clone(a.transformOrigin);this.cachedTransform={}};Layer.prototype.setRect=function(a){a&&(this.rect=a);this.canvas.width=this.rect.width;this.canvas.height=this.rect.height};
Layer.prototype.transformMatrix=function(){if(this.cachedTransform.x==this.rect.x&&this.cachedTransform.y==this.rect.y&&this.cachedTransform.rotation==this.rotation&&this.cachedTransform.scale==this.scale&&this.cachedTransform.originX==this.transformOrigin.x&&this.cachedTransform.originY==this.transformOrigin.y&&void 0!=this.cachedTransform.matrix)return this.cachedTransform.matrix;var a=[[1,0,0],[0,1,0],[0,0,1]],a=multiplyMatrix(a,[[1,0,this.rect.x+this.transformOrigin.x],[0,1,this.rect.y+this.transformOrigin.y],
[0,0,1]]);0!=this.rotation&&(a=multiplyMatrix(a,[[Math.cos(this.rotation),Math.sin(this.rotation),0],[-Math.sin(this.rotation),Math.cos(this.rotation),0],[0,0,1]]));1!=this.scale&&(a=multiplyMatrix(a,[[this.scale,0,0],[0,this.scale,0],[0,0,1]]));this.cachedTransform.x=this.rect.x;this.cachedTransform.y=this.rect.y;this.cachedTransform.rotation=this.rotation;this.cachedTransform.scale=this.scale;this.cachedTransform.originX=this.transformOrigin.x;this.cachedTransform.originY=this.transformOrigin.y;
this.cachedTransform.matrix=a;this.cachedTransform.inverted=void 0;return a};
Layer.prototype.localLocation=function(a,b){var c=this.cachedTransform.inverted;if(!c){var c=this.transformMatrix(),d=[[c[0][0],c[0][1]],[c[1][0],c[1][1]]],g=d[0][0]*d[1][1]-d[0][1]*d[1][0],d=[[d[1][1]/g,d[0][1]/-g],[d[1][0]/-g,d[0][0]/g]],c=multiplyMatrix(d,[[c[0][2]],[c[1][2]]]),c=[[-c[0][0]],[-c[1][0]]],c=[[d[0][0],d[0][1],c[0][0]],[d[1][0],d[1][1],c[1][0]],[0,0,1]];this.cachedTransform.inverted=c}c=multiplyMatrix(c,[[a],[b],[1]]);return{x:c[0][0]+this.transformOrigin.x,y:c[1][0]+this.transformOrigin.y}};
Layer.prototype.transit=function(a){this.transTag=a;"function"==typeof a.method.prepare&&a.method.prepare.call(a,a.transArgs)};Layer.prototype.isTransiting=function(){return void 0!=this.transTag};Layer.prototype.stopTransition=function(){this.transTag&&(typeof this.transTag.method.teardown&&this.transTag.method.teardown(),this.importFrom(this.transTag.transArgs.layer.back),this.transTag=void 0)};
Layer.prototype.drawOnContext=function(a){if(this.visible){a.save();var b=this.transformMatrix();a.transform(b[0][0],b[1][0],b[0][1],b[1][1],b[0][2],b[1][2]);a.globalAlpha=this.opacity;a.drawImage(this.canvas,-this.transformOrigin.x,-this.transformOrigin.y,this.rect.width,this.rect.height);a.restore()}};Layer.prototype.children=function(){return[]};Layer.prototype.mousemove=function(){};Layer.prototype.mouseup=function(){};
Layer.prototype.draw=function(a){a.needRedraw=!0;this.requestedFrame||(renderer.animator.requestFrame(),this.requestedFrame=!0)};Layer.prototype.redrawRect=function(a){a||(a=new Rect(0,0,this.rect.width,this.rect.height));this.stackedClearRect.extend(a);this.requestedFrame||(renderer.animator.requestFrame(),this.requestedFrame=!0)};
Layer.prototype.flush=function(){if(this.requestedFrame){for(var a=!0,b=this.children();a;)for(var a=!1,c=b.length-1;0<=c;c--){var d=b[c];!d.needRedraw&&d.frame().intersect(this.stackedClearRect)&&(d.canDrawPartial()?d.partialDraw=!0:this.stackedClearRect.extend(d.frame()),a=d.needRedraw=!0)}this.stackedClearRect.round();this.ctx.clearRect(this.stackedClearRect.x,this.stackedClearRect.y,this.stackedClearRect.width,this.stackedClearRect.height);a=this.stackedClearRect.isZero();for(c=0;c<b.length;c++)d=
b[c],d.needRedraw&&(!a&&d.partialDraw?d.drawOnContext(this.ctx,this.stackedClearRect):d.drawOnContext(this.ctx),d.needRedraw=!1,d.partialDraw=!1);this.stackedClearRect=new Rect;this.requestedFrame=!1}};AnimationLayer=function(){Layer.call(this);this.animationSeg=[]};AnimationLayer.prototype=Object.create(Layer.prototype);AnimationLayer.prototype.initializer="AnimationLayer";
AnimationLayer.prototype.importFrom=function(a){this.animationSeg=clone(a.animationSeg);Layer.prototype.importFrom.apply(this,arguments)};AnimationLayer.prototype.drawImage=function(){};var ImageLayer=function(){AnimationLayer.call(this);this.images=[]};ImageLayer.prototype=Object.create(AnimationLayer.prototype);ImageLayer.prototype.initializer="ImageLayer";ImageLayer.prototype.children=function(){return this.images};
ImageLayer.prototype.importFrom=function(a){this.images=clone(a.images);AnimationLayer.prototype.importFrom.apply(this,arguments)};
ImageLayer.prototype.importFromSaveData=function(a){this.images=[];for(var b=this,c=[],d=0;d<a.images.length;d++)c.push($.when(a.images[d].restore()).done(function(a){b.images.push(a)}));delete a.images;c.push(AnimationLayer.prototype.importFromSaveData.call(this,a));return $.when.apply($,c).done(function(){o2.log("\u30a4\u30e1\u30fc\u30b8\u306e\u30ed\u30fc\u30c9\u3092\u5b8c\u4e86\u3057\u307e\u3057\u305f");b.redrawRect()})};
ImageLayer.prototype.loadImage=function(a,b,c){var d=this;return ResourceLoader.loadImage(a,!c).done(function(c){d.images.length?d.redrawRect(d.images[0].rect):d.redrawRect();c=new DrawableImage(c,0,0);c.originalURL=a;d.images=[c];c.options=b;d.draw(c)})};ImageLayer.prototype.clearImage=function(){for(var a=0;a<this.images.length;a++)this.redrawRect(this.images[a].rect);this.images=[]};
BaseLayer=function(){ImageLayer.call(this);this.backgroundSolid=new DrawableSolidColor;this.backgroundSolid.rect=new Rect(0,0,this.rect.width,this.rect.height);this.backgroundSolid.color=config.backgroundColor};BaseLayer.prototype=Object.create(ImageLayer.prototype);BaseLayer.prototype.initializer="BaseLayer";BaseLayer.prototype.children=function(){return[this.backgroundSolid].concat(this.images)};
TextProperties=function(a){Drawable.call(this);this.text=a;this.rubyText;this.styles={opacity:1,size:20,face:"Arial",visible:!1,shadowBlur:5,vertical:void 0,shadowOffsetX:0,shadowOffsetY:0};this.useCanvasCache=!1;this.canvas};TextProperties.prototype=new Drawable;TextProperties.prototype.initializer="TextProperties";TextProperties.prototype.importFrom=function(a){Drawable.prototype.importFrom.call(this,a);this.text=a.text;this.rubyText=a.rubyText;this.styles=clone(a.styles);this.useCanvasCache=a.useCanvasCache};
TextProperties.prototype.objectToBeSerialized=function(a){switch(a){case "canvas":return}return this[a]};
TextProperties.prototype.drawOnContext=function(a){if(this.styles.visible&&0!=this.styles.opacity){if(this.useCanvasCache){var b=this.frame();if(!this.canvas){this.canvas=document.createElement("canvas");this.canvas.width=b.width;this.canvas.height=b.height;var c=this.canvas.getContext("2d");c.textBaseline="top";var d=this.rect.x-b.x,g=this.rect.y-b.y;this.useCanvasCache=!1;var h=this.rect,j=this.styles.opacity;this.styles.opacity=1;this.rect=new Rect(d,g,this.rect.width,this.rect.height);this.drawOnContext(c);
this.rect=h;this.styles.opacity=j;this.useCanvasCache=!0}a.save();a.globalAlpha=this.styles.opacity;a.drawImage(this.canvas,b.x,b.y,this.canvas.width,this.canvas.height)}else a.save(),b=this.styles.color,a.fillStyle!=b&&(a.fillStyle=b),this.styles.shadow?(a.shadowColor=this.styles.shadowColor,a.shadowBlur=this.styles.shadowBlur,a.shadowOffsetX=this.styles.shadowOffsetX,a.shadowOffsetY=this.styles.shadowOffsetY):a.shadowBlur=0,a.globalAlpha!=this.styles.opacity&&(a.globalAlpha=this.styles.opacity),
this.styles.vertical?this.fillTextVertical(a):(this.rubyText&&(b=this.rubyFont(),a.font!=b&&(a.font=b),b=this.measureRuby(a),a.fillText(this.rubyText,this.rect.x+(this.rect.width-b.width)/2,this.rect.y-b.height-this.styles.rubyOffset)),b=this.font(),a.font!=b&&(a.font=b),a.fillText(this.text,this.rect.x,this.rect.y),this.styles.edge&&(a.lineWidth=2,a.strokeStyle=this.styles.edgeColor,a.strokeText(this.text,this.rect.x,this.rect.y)));a.restore()}};
TextProperties.prototype.clearCache=function(){this.canvas&&($(this.canvas).remove(),this.canvas=void 0)};
TextProperties.prototype.frame=function(){var a=0;this.styles.edge&&(a+=10);a=new Rect({x:this.rect.x-a,y:this.rect.y-a,width:this.rect.width+2*a,height:this.rect.height+2*a});if(this.styles.shadow){var b=new Rect({x:a.x-this.styles.shadowBlur,y:a.y-this.styles.shadowBlur,width:a.width+2*this.styles.shadowBlur,height:a.height+2*this.styles.shadowBlur});b.x+=this.styles.shadowOffsetX;b.y+=this.styles.shadowOffsetY;a.extend(b)}if(browser.isIOs||browser.isAndroid)a.height+=5;this.rubyText&&(b=this.measureRuby(),
b=this.styles.vertical?new Rect({x:this.rect.x+this.rect.width+this.styles.rubyOffset,y:this.rect.y+(this.rect.height-b.height)/2-10,width:b.width,height:b.height+10}):new Rect({x:this.rect.x+(this.rect.width-b.width)/2,y:this.rect.y-this.styles.rubySize+this.styles.rubyOffset-10,width:b.width,height:b.height+10}),a.extend(b));this.styles.italic&&(a.width+=10);return a};
TextProperties.prototype.font=function(){var a="";this.styles.italic&&(a+="italic ");this.styles.bold&&(a+="bold ");a+=this.styles.size+"px ";a+=this.styles.face;return a+" , Arial"};TextProperties.prototype.rubyFont=function(){return this.styles.rubySize+"px "+this.styles.face};
TextProperties.prototype.measure=function(a){a.save();var b=this.font();this.font!=b&&(a.font=b);this.styles.vertical?b=this.measureVertical(a,this.text):(b=a.measureText(this.text),b.height=this.styles.size);a.restore();return b};
TextProperties.prototype.measureRuby=function(a){a||(a=o2.currentMessageLayer.ctx);a.save();var b=this.rubyFont();this.font!=b&&(a.font=b);this.styles.vertical?b=this.measureVertical(a,this.rubyText,this.styles.rubySize):(b=a.measureText(this.rubyText),b.height=this.styles.rubySize);a.restore();return b};
(function(){function a(a,b,c,d,g){var h=c*Math.PI/180,c=Math.cos(h),h=Math.sin(h);return[[a*c,b*h],[-a*h,b*c],[a*(c*d-h*g),b*(h*d+c*g)]]}function b(b,n,p,k,r){var q=b.measureText(n),r=r||this.styles.size,u=this.styles.size;n in c&&(n=c[n]);var w="";-1!=d.indexOf(n)?w="offsetTopRight":-1!=g.indexOf(n)?w="offsetRight":-1!=h.indexOf(n)?(p+=u,k-=r,w="rotate90"):-1!=j.indexOf(n)&&(p+=u,k-=r,w="reflect45");b.save();a:{var u=p,y=k,G=q.width,I=r;switch(w){case "rotate90":u=a(1,1,90,-u+y+I,-u-y);break a;case "reflect45":u=
a(1,-1,270,-u+y+G,u-y-I);break a;case "offsetTopRight":u=a(1,1,0,0.625*G,-0.625*I);break a;case "offsetRight":u=a(1,1,0,0.125*G,-0.125*I);break a;default:u=[[1,0],[0,1],[0,0]]}}b.setTransform(u[0][0],u[0][1],u[1][0],u[1][1],u[2][0],u[2][1]);b.fillText(n,p,k);this.styles.edge&&(b.lineWidth=2,b.strokeStyle=this.styles.edgeColor,b.strokeText(this.text,p,k));b.restore();return"rotate90"==w?q.width:r}var c={"\u300a":"\ufe3d","\u300b":"\ufe3e","(":"\ufe35","\uff08":"\ufe35",")":"\ufe36","\uff09":"\ufe36",
"{":"\ufe37","\uff5b":"\ufe37","}":"\ufe38","\uff5d":"\ufe38","\u3010":"\ufe3b","\u3011":"\ufe3c","\uff1c":"\ufe3f","<":"\ufe3f","\uff1e":"\ufe40",">":"\ufe40","\u300c":"\ufe41","\u300d":"\ufe42","\u300e":"\ufe43","\u300f":"\ufe44"},d=["\u3001","\u3002"],g="\u3041\u3043\u3045\u3047\u3049\u3063\u3083\u3085\u3087\u308e\u30f5\u30f6",h="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ~\u301c\u2026s\uff07\u2500\u2502\u250c\u2510\u2518\u2514\u251c\u252c\u2524\u2534\u253c\u2501\u2503\u250f\u2513\u251b\u2517\u2523\u2533\u252b\u253b\u254b\u2520\u252f\u2528\u2537\u253f\u251d\u2530\u2525\u2538\u2542".split(""),
j=["\u30fc","\u2015","\uff5e"];TextProperties.prototype.measureVertical=function(a,b,c){for(var b=b.split(""),d=0,g=0,j=0;j<b.length;j++){var u=b[j],w=a.measureText(u).width,y=c||this.styles.size;-1!=h.indexOf(u)&&(u=y,y=w,w=u);g+=y;d<w&&(d=w)}return{width:d,height:g}};TextProperties.prototype.fillTextVertical=function(a){var c=this.text.split(""),d=this.rect.y,g=this.font();a.font!=g&&(a.font=g);a.save();for(g=0;g<c.length;g++)var h=c[g],d=d+b.call(this,a,h,this.rect.x,d);a.restore();if(this.rubyText){g=
this.rubyFont();a.font!=g&&(a.font=g);d=this.measureRuby(a);d=(this.rect.height-d.height)/2;c=this.rubyText.split("");d=this.rect.y+d;for(g=0;g<c.length;g++)h=c[g],d+=b.call(this,a,h,this.rect.x+this.rect.width+this.styles.rubyOffset,d,this.styles.rubySize)}}})();TextProperties.prototype.calculateSize=function(){var a=this.measure();this.rect.width=a.width;this.rect.height=a.height;return a};
TextProperties.prototype.isEqual=function(a){if(!(a instanceof TextProperties)||!this.frame().isEqual(a.frame()))return!1;for(var b in this.styles)if(this.styles[b]!=a.styles[b])return!1;return!0};Button=function(a,b,c){DrawableImage.call(this,a,b,c);this.cacheEnabled=!1;this.state=Button.STATE_NORMAL};Button.prototype=Object.create(DrawableImage.prototype);Button.prototype.initializer="Button";Button.STATE_NORMAL=0;Button.STATE_HOVER=1;Button.STATE_DOWN=2;Button.STATE_DISABLE=3;
Button.prototype.click=Button.prototype.enter=Button.prototype.leave=function(){};Button.prototype.clone=function(a){var b=new Button(this.image);b.importFrom(a);return b};Button.restore=function(a){return $.when(ResourceLoader.loadImage(a.image,!0)).then(function(){var b=new Button(image);b.importFrom(a);return b})};
Link=function(){DrawableSolidColor.call(this);this.color=config.messageLayerDefaultLinkColor||"#0000ff";this.opacity=config.messageLayerDefaultLinkOpacity;this.hovering;this.textsProperties=[];this.rects=[];this.vertical=!1;this.messageLayer};Link.prototype=Object.create(DrawableSolidColor.prototype);Link.prototype.initializer="Link";Link.restore=function(){return(new Link).importFromSaveData()};Link.prototype.objectToBeSerialized=function(a){switch(a){case "messageLayer":return}return this[a]};
Link.prototype.importFrom=function(a){DrawableSolidColor.prototype.importFrom.call(this,a);this.vertical=a.vertical;this.textsProperties=a.messageLayer?a.textsProperties.map(function(b){return a.messageLayer.textsProperties.indexOf(b)}).map(function(a){return this.messageLayer.textsProperties[a]}):clone(a.textsProperties);this.refreshRects()};Link.prototype.isHovering=function(a,b){for(var c=0;c<this.rects.length;c++)if(this.rects[c].coverCoordinate(a,b))return!0;return!1};
Link.prototype.drawOnContext=function(a){if(this.hovering){for(var b=this.rect,c=0;c<this.rects.length;c++)this.rect=this.rects[c],DrawableSolidColor.prototype.drawOnContext.call(this,a);this.rect=b}};Link.prototype.addTextProperties=function(a){this.textsProperties.push(a);this.refreshRects()};
Link.prototype.refreshRects=function(){this.rects=[];this.rect=new Rect;for(var a,b=0;b<this.textsProperties.length;b++){var c=this.textsProperties[b].frame();a||(a=new Rect);a.extend(c);if(b==this.textsProperties.length-1||this.textsProperties[b+1].frame().y!=c.y&&!this.vertical||this.textsProperties[b+1].frame().x!=c.x&&this.vertical)this.rects.push(a),this.rect.extend(a),a=void 0}};Link.prototype.click=Link.prototype.enter=Link.prototype.leave=function(){};
MessageLayer=function(){Layer.call(this,new Rect({x:config.messageLayerCurrentPositionX,y:config.messageLayerCurrentPositionY,width:config.messageLayerCurrentWidth,height:config.messageLayerCurrentHeight}));this.frameImage;this.frameSolid=new DrawableSolidColor(new Rect(0,0,this.rect.width,this.rect.height));this.frameSolid.color=config.messageLayerColor||"#000";this.frameSolid.opacity=config.messageLayerOpacity;this.visible=!1;this.opacity=1;this.margin={top:config.messageLayerMarginT||20,right:config.messageLayerMarginR||
20,bottom:config.messageLayerMarginB||20,left:config.messageLayerMarginL||20};this.textsProperties=[];this.vertical=config.messageLayerVertical;this.textCursor={x:0,y:0};this.align="left";this.delaySpeed=config.chSpeeds||20;this.ctx.textBaseline="top";this.defaultFont={size:config.messageLayerDefaultFontSize||20,face:config.messageLayerDefaultFontFace||"Arial",color:config.messageLayerDefaultFontColor||"#000000",rubySize:config.messageLayerDefaultRubySize||10,rubyOffset:config.messageLayerDefaultRubyOffset||
0,shadow:config.messageLayerDefaultShadow,shadowColor:config.messageLayerDefaultShadowColor||"#999999",shadowBlur:config.messageLayerDefaultShadowBlur,shadowOffsetX:config.messageLayerDefaultShadowOffsetX,shadowOffsetY:config.messageLayerDefaultShadowOffsetY,edge:config.messageLayerDefaultEdge,edgeColor:config.messageLayerDefaultEdgeColor||"#00ff00",bold:config.messageLayerDefaultFontBold,italic:config.messageLayerDefaultFontItalic};this.defaultStyle={lineSpacing:Number(config.messageLayerDefaultStyleLineSpacing)||
0,pitch:Number(config.messageLayerDefaultStylePitch)||0,lineSize:0,align:"left",autoReturn:config.messageLayerDefaultAutoReturn,kinsoku:MessageLayer.KINSOKU_BURASAGARI,kinsokuBolChar:" \u3002\uff0e\u3001\uff0c\u300d\u300f\uff09\u3009\u3011\u300b\uff3d\u3015\u201d\uff5d\u2019\u301f\uff1f\uff01\u2047\u203c\u2048\u2049",kinsokuEolChar:"\u300c\u300e\uff08\u3008\u3010\u300a\uff3b\u3014\u201c\uff5b\u2018\u301d",kinsokuBurasagariChar:"\u3002\uff0e\u3001\uff0c"};this.font=clone(this.defaultFont);this.style=
clone(this.defaultStyle);this.textCustomizers=["baseTextCustomizer","alignTextCustomizer"];this.buttons=[];this.routineButtons=[];this.links=[];this.images=[];this.lastLineSize=0;this.resetCursor();var a=this;setTimeout(function(){$(conductor).on("ran",function(){a.refreshRoutineButtons()})})};MessageLayer.prototype=Object.create(Layer.prototype);MessageLayer.prototype.initializer="MessageLayer";
MessageLayer.prototype.objectToBeSerialized=function(a){switch(a){case "textsProperties":return}return Layer.prototype.objectToBeSerialized.call(this,a)};
MessageLayer.prototype.importFromSaveData=function(a){var b=this;this.buttons=[];var c=[];if(a.buttons){for(var d=0;d<a.buttons.length;d++)c.push($.when(a.buttons[d].restore()).done(function(a){b.addButton(a)}));delete a.buttons}this.images=[];if(a.images)for(d=0;d<a.images.length;d++)c.push($.when(a.images[d].restore()).done(function(a){b.images.push(a)}));delete a.images;this.links=[];if(a.links)for(d=0;d<a.links.length;d++)c.push($.when(a.links[d].restore()).done(function(a){b.addLink(a)}));delete a.links;
this.textCustomizers=[];this.textsProperties=[];c.push(Layer.prototype.importFromSaveData.call(this,a));return $.when.apply($,c).done(function(){b.setRect(b.rect);b.redrawRect()})};MessageLayer.KINSOKU_NONE=0;MessageLayer.KINSOKU_OIDASHI=1;MessageLayer.KINSOKU_BURASAGARI=2;MessageLayer.prototype.drawOnContext=function(){this.opacity=1;Layer.prototype.drawOnContext.apply(this,arguments)};
MessageLayer.prototype.children=function(){var a=[];this.frameImage?a.push(this.frameImage):a.push(this.frameSolid);return a=a.concat(this.textsProperties,this.links,this.images,this.buttons,this.routineButtons)};
MessageLayer.prototype.importFrom=function(a){if(!(a instanceof MessageLayer))throw"[\u5185\u90e8\u30a8\u30e9\u30fc] otherLayer\u306fMessageLayer\u3067\u306f\u3042\u308a\u307e\u305b\u3093";Layer.prototype.importFrom.call(this,a);a.frameImage&&(this.frameImage=clone(a.frameImage));for(var b="frameSolid margin textsProperties vertical lineWidth textCursor align delaySpeed defaultFont defaultStyle font style textCustomizers buttons links images routineButtons".split(" "),c=0;c<b.length;c++){var d=b[c];
this[d]=clone(a[d])}this.setRect(clone(a.rect),!0)};MessageLayer.prototype.mousemove=function(a){if(!this.visible)return!1;var b=!1,a=a.originalEvent.normalizedCoordinate(this);this.refreshRoutineButtons(a.x,a.y)&&(b=!0);this.refreshButtons(a.x,a.y)&&(b=!0);this.refreshLinks(a.x,a.y)&&(b=!0);return b};
MessageLayer.prototype.mouseup=function(a){if(!this.visible)return!1;for(var a=a.originalEvent.normalizedCoordinate(this),b=this.routineButtons.length-1;0<=b;b--){var c=this.routineButtons[b];if(c.rect.coverCoordinate(a.x,a.y)&&c.state!=Button.STATE_DISABLE)return c.click(),c.state=Button.STATE_DISABLE,this.redrawRect(c.rect),!0}for(b=this.buttons.length-1;0<=b;b--)if(c=this.buttons[b],c.rect.coverCoordinate(a.x,a.y))return c.click(),c.state=Button.STATE_DOWN,this.redrawRect(c.rect),this.addButtonLinkImages(),
this.buttons=[],this.links=[],!0;for(b=this.links.length-1;0<=b;b--)if(c=this.links[b],c.isHovering(a.x,a.y))return c.click(),this.addButtonLinkImages(),this.buttons=[],this.links=[],!0};
MessageLayer.prototype.mousedown=function(a){if(!this.visible)return!1;for(var a=a.originalEvent.normalizedCoordinate(this),b=this.routineButtons.length-1;0<=b;b--){var c=this.routineButtons[b];if(c.rect.coverCoordinate(a.x,a.y)&&c.state!=Button.STATE_DISABLE)return c.state=Button.STATE_DOWN,this.redrawRect(c.rect),!0}for(b=this.buttons.length-1;0<=b;b--)c=this.buttons[b],c.rect.coverCoordinate(a.x,a.y)&&(c.state=Button.STATE_DOWN,this.redrawRect(c.rect))};
MessageLayer.prototype.setRect=function(a,b){a||(a=this.rect);var c=this.rect.width!=a.width||this.rect.height!=a.height||this.canvas.width!=a.width||this.canvas.height!=a.height;c&&(this.canvas.width=a.width,this.canvas.height=a.height);this.ctx.textBaseline="top";this.rect=a;this.frameSolid.rect.width=a.width;this.frameSolid.rect.height=a.height;(c||b)&&this.redrawRect()};
MessageLayer.prototype.resetCursor=function(){this.textCursor=this.vertical?{x:this.rect.width-this.margin.right-this.style.lineSpacing,y:this.margin.top}:{x:this.margin.left,y:this.margin.top+this.style.lineSpacing}};MessageLayer.prototype.linebreak=function(){this.vertical?(this.textCursor.y=this.margin.top,this.textCursor.x-=this.style.lineSpacing+this.lastLineSize):(this.textCursor.x=this.margin.left,this.textCursor.y+=this.style.lineSpacing+this.lastLineSize)};
MessageLayer.textCustomizers={baseTextCustomizer:function(a,b,c){for(var d=b.delaySpeed,g=[],h=b.textCursor.x,j=b.textCursor.y,i=0,n=0,p=void 0,k=0;k<a.length;k++){var r=a[k];r.rect.isZero()&&void 0===r.styles.vertical&&(r.styles.vertical=b.vertical)}for(k=0;k<a.length;k++)if(r=a[k],r.rect.isZero()){if(void 0==p){b.vertical?(i=Math.max(i,b.style.lineSize),b.lastLineSize=i):(n=Math.max(n,b.style.lineSize),b.lastLineSize=n);var q=p=function(){for(var c=b.vertical?j:h,d=k;d<a.length;d++){var g=a[d].measure(b.ctx);
if(b.vertical){if(c+=g.height+b.style.pitch,g.width>i&&(i=g.width,b.lastLineSize=i),c>b.rect.height-b.margin.bottom&&b.style.autoReturn)return d}else if(g.height>n&&(n=g.height,b.lastLineSize=n),c+=g.width+b.style.pitch,c>b.rect.width-b.margin.right&&b.style.autoReturn)return d}return-1}();if(-1!=p){var u=a[p],w=a[p+1];if(b.style.kinsoku==MessageLayer.KINSOKU_BURASAGARI&&-1!=b.style.kinsokuBurasagariChar.indexOf(u.text)&&(!w||-1==b.style.kinsokuBolChar.indexOf(w.text)))w?p++:p=-1;else if(b.style.kinsoku!=
MessageLayer.KINSOKU_NONE)for(;-1!=b.style.kinsokuBolChar.indexOf(a[p].text)||a[p-1]&&-1!=b.style.kinsokuEolChar.indexOf(a[p-1].text);)if(p--,p<=k){p=q;break}}}q=r.measure(b.ctx);p===k?(p=void 0,b.vertical?(j=b.margin.top,h-=i+b.style.lineSpacing,i=0):(h=b.margin.left,j+=n+b.style.lineSpacing,n=0),k--):(g[k]=b.vertical?{x:h-i+(i-q.width)/2,y:j,width:q.width,height:q.height}:{x:h,y:j+n-q.height,width:q.width,height:q.height},r.rect=new Rect(g[k]),b.vertical?j+=q.height+b.style.pitch:h+=q.width+b.style.pitch)}this.isAnimation=
!1;var y=this;this.textProperties=function(b){var h=a[b];if(!h)debugger;$.extend(h.rect,new Rect(g[b]));h.styles.visible=y.timePassed/d+(a.length-c)>=b?!0:!1;return h};this.isEnded=function(){return y.timePassed/d>=c?!0:!1}},alignTextCustomizer:function(a,b){if(b.vertical){if("center"!=b.style.align&&"bottom"!=b.style.align)return}else if("left"==b.style.align)return;var c=b.style.align;this.allTextsProperties=function(){if(b.vertical)for(i=j=0;i<a.length;i++){if(g=a[i],i>=a.length-1||g.rect.y>a[i+
1].rect.y){for(var d=0,g=j;g<=i;g++)a[g].styles.visible&&(d+=a[g].rect.height+b.style.pitch);var d=d-b.style.pitch,h=0,g=b.rect.height-b.margin.top-b.margin.bottom;"center"==c?h=(g-d)/2:"bottom"==c&&(h=g-d);for(g=j;g<=i;g++)a[g].styles.visible&&(a[g].rect.y=h,h+=a[g].rect.height+b.style.pitch);j=i+1}}else for(var j=0,i=0;i<a.length;i++){var g=a[i];if(i>=a.length-1||g.rect.x>a[i+1].rect.x){d=0;for(g=j;g<=i;g++)a[g].styles.visible&&(d+=a[g].rect.width+b.style.pitch);h=0;g=b.rect.width-b.margin.left-
b.margin.right;"center"==c?h=(g-d)/2+b.margin.left:"right"==c&&(h=g-d+b.margin.left);for(g=j;g<=i;g++)a[g].styles.visible&&(a[g].rect.x=h,h+=a[g].rect.width+b.style.pitch);j=i+1}}return a}}};
MessageLayer.prototype.drawText=function(a,b){function c(){for(var a=!0,g=Date.now()-p,h=0;h<i.length;h++){var u=i[h];u.timePassed=g;if(o2.skipMode||0==this.delaySpeed)u.timePassed=Infinity;if("function"===typeof u.allTextsProperties)this.textsProperties=u.allTextsProperties(this.textsProperties);else if("function"===typeof u.textProperties)for(var w=d;w<this.textsProperties.length;w++)this.textsProperties[w]=u.textProperties(w);"function"===typeof u.isEnded&&!1==u.isEnded()&&(a=!1)}g=!1;for(h=0;h<
this.textsProperties.length;h++)u=this.textsProperties[h],w=n[h],u.isEqual(w)||(w&&w.styles.visible&&(this.redrawRect(w.frame()),g=!0),this.draw(u));if(g)for(h=0;h<this.links.length;h++)this.links[h].refreshRects();n=clone(this.textsProperties);if(a){if(a=this.textsProperties[this.textsProperties.length-1])this.textCursor=this.vertical?{x:a.rect.x+a.rect.width+(this.lastLineSize-a.rect.width)/2,y:a.rect.y+a.rect.height}:{x:a.rect.x+a.rect.width,y:a.rect.y+a.rect.height-this.lastLineSize};"function"==
typeof b&&setTimeout(b.bind(this),0)}else renderer.animator.requestFrame(c.bind(this),j?0:this.delaySpeed)}var d=this.textsProperties.length;"string"===typeof a&&(a=a.split(""));for(var g=a.map(function(a){if(a instanceof TextProperties)return a;a=new TextProperties(a);$.extend(a.styles,clone(o2.currentMessageLayer.font));return a}),h=0;h<g.length;h++)this.textsProperties.push(g[h]);var j=!1,i=this.textCustomizers.map(function(a){a=MessageLayer.textCustomizers[a];if("function"!=typeof a)o2.error(a+
"\u306ftextCustomizer\u3067\u306f\u306a\u3044\u3067\u3059\u3002");else return a=new a(this.textsProperties,this,g.length),!j&&a.isAnimation&&(j=!0),a},this);(j||0<=["center","right","bottom"].indexOf(this.style.align))&&this.textsProperties.forEach(function(a){a.useCanvasCache=!0});var n=clone(this.textsProperties),p=Date.now();c.call(this)};
MessageLayer.prototype.refreshButtons=function(a,b){for(var c=!1,d=this.buttons.length-1;0<=d;d--){var g=this.buttons[d],h=g.rect.coverCoordinate(a,b);this.drawButton(g,h);h&&(c=!0)}return c};MessageLayer.prototype.drawButton=function(a,b){b&&a.state!=Button.STATE_HOVER?(a.state=Button.STATE_HOVER,a.enter(),this.redrawRect(a.rect)):!b&&a.state!=Button.STATE_NORMAL&&(a.state=Button.STATE_NORMAL,a.leave(),this.redrawRect(a.rect))};MessageLayer.prototype.addButton=function(a){this.buttons.push(a);this.draw(a)};
MessageLayer.prototype.refreshRoutineButtons=function(a,b){for(var c=!1,d=-1!=["p","l","s"].indexOf(currentConductor.currentTag.tagName),g=this.routineButtons.length-1;0<=g;g--){var h=this.routineButtons[g],j=a&&b?h.rect.coverCoordinate(a,b):!1;this.drawRoutineButton(h,j,d);j&&(d&&h.enabled)&&(c=!0)}return c};
MessageLayer.prototype.drawRoutineButton=function(a,b,c){var d=Button.STATE_NORMAL;c?b?(d=Button.STATE_HOVER,a.state!=Button.STATE_HOVER&&a.enter()):(d=Button.STATE_NORMAL,a.state==Button.STATE_HOVER&&a.leave()):d=Button.STATE_DISABLE;a.state!=d&&(a.state=d,this.redrawRect(a.rect))};MessageLayer.prototype.addRoutineButton=function(a){this.routineButtons.push(a);this.draw(a)};
MessageLayer.prototype.refreshLinks=function(a,b){for(var c=!1,d=this.links.length-1;0<=d;d--){var g=this.links[d],h=g.isHovering(a,b);this.drawLink(g,h);h&&(c=!0)}return c};MessageLayer.prototype.drawLink=function(a,b){b&&!a.hovering?(a.enter(),a.hovering=!0,a.visible=!0,this.draw(a)):!b&&a.hovering&&(a.leave(),a.hovering=!1,a.visible=!1,this.redrawRect(a.rect))};MessageLayer.prototype.addLink=function(a){a.vertical=this.vertical;a.messageLaye=this;this.links.push(a)};
MessageLayer.prototype.addButtonLinkImages=function(){for(var a=0;a<this.buttons.length;a++){var b=this.buttons[a],c=new DrawableCanvas(b.rect);b.rect.x=b.rect.y=0;b.drawOnContext(c.ctx);this.images.push(c);this.redrawRect(c.rect)}for(a=0;a<this.links.length;a++)if(b=this.links[a],b.visible&&b.hovering)for(var d=0;d<b.rects.length;d++)c=new DrawableSolidColor(b.rects[d]),c.importFrom(b),this.images.push(c),this.redrawRect(c.rect)};
MessageLayer.prototype.resetFrameSize=function(){this.frameSolid.rect.width=this.rect.width;this.frameSolid.rect.height=this.rect.height};
MessageLayer.prototype.setFrameImage=function(a){if(null==a)this.frameImage?(this.redrawRect(this.frameImage.rect),this.frameImage=void 0):this.redrawRect();else{if(!(a instanceof Drawable))throw"[\u5185\u90e8\u30a8\u30e9\u30fc] image\u306fdrawable\u3067\u306f\u3042\u308a\u307e\u305b\u3093";this.frameImage?this.redrawRect(this.frameImage.frame()):this.redrawRect(this.rect);this.frameImage=a;this.redrawRect(this.frameImage.rect)}};
MessageLayer.prototype.resetMessageLayer=function(){for(var a=this.buttons.length-1;0<=a;a--)this.redrawRect(this.buttons[a].frame());for(a=this.textsProperties.length-1;0<=a;a--)this.redrawRect(this.textsProperties[a].frame());this.buttons=[];this.routineButtons=[];this.images=[];this.links=[];this.textsProperties=[];this.font=clone(this.defaultFont);this.style=clone(this.defaultStyle);this.resetCursor();this.resetFrameSize();this.redrawRect()};
var Sound=function(a){this.filepath;this.isPlaying=!1;this.volume=1;this.loop=!1;this.loadDefer;this.audio=new Audio;this.fadeDefer;this.fadeStatus;"string"==typeof a&&this.setFile(a)};Sound.prototype.objectToBeSerialized=function(a){switch(a){case "audio":case "loadDefer":return}return this[a]};Sound.prototype.importFromSaveData=function(a){this.filepath=void 0;Object.prototype.importFromSaveData.call(this,a);if(this.filepath)return a=this.setFile(this.filepath),this.isPlaying&&this.play(),a};
Sound.prototype.setFile=function(a){this.filepath=a;var b=this;this.loadDefer=ResourceLoader.loadAudio(a,!0,this.audio);this.loadDefer.done(function(a){a.volume=b.volume;$(a).on("ended",function(){$(b).trigger("ended");b.isPlaying=!1;if(b.loop&&(browser.isFirefox||browser.isAndroid))a.currentTime=0,a.play()})});return this.loadDefer};Sound.prototype.play=function(a){a&&this.setFile(a);this.isPlaying=!0;if(this.loadDefer)return this.loadDefer.done(function(a){a.play()}),this.loadDefer;o2.warn("\u30b5\u30a6\u30f3\u30c9\u30d5\u30a1\u30a4\u30eb\u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u306a\u3044\u72b6\u614b\u3067\u518d\u751f\u3092\u884c\u304a\u3046\u3068\u3057\u307e\u3057\u305f")};
Sound.prototype.pause=function(){this.isPlaying=!1;this.loadDefer&&this.loadDefer.done(function(a){a.pause()})};Sound.prototype.stop=function(){this.isPlaying=!1;this.loadDefer&&this.loadDefer.done(function(a){a.pause();try{a.currentTime=0}catch(b){}})};Sound.prototype.setTime=function(a){this.loadDefer.done(function(b){try{b.currentTime=a/1E3}catch(c){$(b).one("loadedmetadata",function(){b.currentTime=a/1E3})}})};
Sound.prototype.setVolume=function(a){this.volume=a;this.loadDefer&&this.loadDefer.done(function(b){b.volume=a})};Sound.prototype.setLoop=function(a){this.loop=a;!browser.isFirefox&&!browser.isAndroid&&this.loadDefer.done(function(b){b.loop=a})};
Sound.prototype.fade=function(a){if(a){this.fadeStatus&&this.stopFade();"fromVolume"in a||(a.fromVolume=this.volume);"toVolume"in a||(a.toVolume=this.volume);if(this.loadDefer){this.fadeStatus=new SoundFade(this,a);var b=this;this.fadeStatus.defer.done(function(){setTimeout(function(){delete b.fadeStatus})});this.loadDefer.done(function(){b.fadeStatus&&b.fadeStatus.start()});return this.fadeStatus.defer}o2.log("\u30b5\u30a6\u30f3\u30c9\u30d5\u30a1\u30a4\u30eb\u3092\u6307\u5b9a\u3055\u308c\u3066\u3044\u306a\u3044\u72b6\u614b\u3067\u30d5\u30a7\u30fc\u30c9\u51e6\u7406\u3092\u884c\u304a\u3046\u3068\u3057\u307e\u3057\u305f")}else if(this.fadeStatus)return this.fadeStatus.defer};
Sound.prototype.stopFade=function(){this.fadeStatus&&this.fadeStatus.stop()};Sound.prototype.dummyLoad=function(){this.audio.src="x";this.audio.load()};SoundFade=function(a,b){this.sound=a;this.fromVolume=1;this.toVolume=0;this.duration=1E3;b&&$.extend(this,b);this.intervalId;this.defer=$.Deferred()};
SoundFade.prototype.start=function(){function a(){var a=(Date.now()-b)/this.duration;1<a&&(a=1);this.sound.setVolume(this.fromVolume+(this.toVolume-this.fromVolume)*a);1<=a&&this.stop()}var b=Date.now();this.intervalId=setInterval(a.bind(this),1E3/60);a.call(this)};SoundFade.prototype.stop=function(){clearInterval(this.intervalId);this.sound.setVolume(this.toVolume);this.defer.resolve()};SoundFade.prototype.objectToBeSerialized=function(a){switch(a){case "defer":case "sound":return}return this[a]};
var Tag,TagAction;
(function(){Tag=function(a,b){this.file;this.tagName=a;this.args=b||{};this.lineNumber;this.originalLineNumber;this.originalCharNumber;this.conductor};Tag.prototype.actions=function(){return this.conductor&&this.conductor.tagActions?this.conductor.tagActions:Tag.actions};Tag.prototype.run=function(){var a=this.actions();if(this.tagName in a){var b=this.argsForAction();return a[this.tagName].action.call(this,b)}this.warn("\u30bf\u30b0\u30cf\u30f3\u30c9\u30e9\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093")};Tag.prototype.preload=
function(){var a=this.actions();if(this.tagName in a&&"function"===typeof a[this.tagName].preload){var b=this.validate(this.args);return a[this.tagName].preload.call(this,b)}};Tag.prototype.normalizedArgs=function(a){var a=a?clone(a):clone(this.args),b;for(b in a){var c=a[b],d=this.actions()[this.tagName];d&&(d=d.rules)&&!(b in d)&&("o2_cond"!=b&&"*"!=b)&&this.warn(b+"\u3068\u3044\u3046\u672a\u77e5\u306e\u5c5e\u6027\u304c\u3042\u308a\u307e\u3059");if("*"===b)for(var g in window.mp)window.mp.hasOwnProperty(g)&&
(a[g]=window.mp[g]);else if(a.hasOwnProperty(b)&&"string"===typeof c){switch(c.charAt(0)){case "&":c=c.substring(1);c=eval(c);break;case "%":c=c.substring(1),values=c.split("|"),c=void 0!==window.mp[values[0]]?window.mp[values[0]]:values[1]}a[b]=c}}return a};Tag.prototype.argsForAction=function(){return this.validate(this.normalizedArgs(this.args))};Tag.prototype.validate=function(a){var a=a?clone(a):{},b=this.actions();if(!b[this.tagName])return a;b=b[this.tagName].rules;if(!b)return a;if("function"==
typeof b)return b(a);for(var c in b){var d=a[c],g=b[c];b[c].required&&void 0===d&&this.error("\u5fc5\u9808\u306e\u5c5e\u6027 "+c+" \u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u307e\u305b\u3093");void 0===d&&"defaultValue"in g&&(d="function"===typeof g.defaultValue?g.defaultValue():g.defaultValue);if(g.type&&void 0!==d){if("allowString"in g&&"string"===typeof d)for(var h=!1,j=g.allowString.length-1;0<=j;j--)if(g.allowString[j]===d){h=!0;break}if(!h)if(g.type in Tag.validators)try{d=Tag.validators[g.type](d)}catch(i){console.trace&&
console.trace(),this.error(c+"\u306f"+i)}else g.type instanceof RegExp&&(g.type.test(d)||this.error("\u5c5e\u6027 "+c+" \u306e\u5024\u306f "+g.type.toString()+" \u578b\u3067\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093"))}void 0!==d&&(a[c]=d)}return a};Tag.validators={STRING:function(a){if("string"!=typeof a)throw"string\u578b\u3067\u306f\u3042\u308a\u307e\u305b\u3093";return a},BOOLEAN:function(a){if("boolean"===typeof a)return a;if("string"===typeof a){if("true"===a||"1"===a)return!0;if("false"===
a||"0"===a)return!1}else if("number"===typeof a){if(0===a)return!1;if(1===a)return!0}throw"boolean\u578b\u3067\u306f\u3042\u308a\u307e\u305b\u3093";},INT:function(a){if(isNaN(parseFloat(a))||!(isFinite(a)&&0===a%1))throw"int\u578b\u3067\u306f\u3042\u308a\u307e\u305b\u3093";return parseInt(a)},FLOAT:function(a){if(isNaN(parseFloat(a))||!isFinite(a))throw"float\u578b\u3067\u306f\u3042\u308a\u307e\u305b\u3093";return parseFloat(a)},LAYER:function(a){if("base"==a)return{fore:o2.foreLayers.baseLayer,back:o2.backLayers.baseLayer};
try{return this.MESSAGE_LAYER(a)}catch(b){}try{return this.IMAGE_LAYER(a)}catch(c){}throw"\u6307\u5b9a\u3055\u308c\u305f\u30ec\u30a4\u30e4\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093";},IMAGE_LAYER:function(a){if("base"==a)return{fore:o2.foreLayers.baseLayer,back:o2.backLayers.baseLayer};a=Number(a);if(isNaN(a))throw"number\u578b\u3067\u306f\u3042\u308a\u307e\u305b\u3093";if(!(a in o2.foreLayers.imageLayers))throw"\u30a4\u30e1\u30fc\u30b8\u30ec\u30a4\u30e4 "+a+" \u306f\u5b58\u5728\u3057\u307e\u305b\u3093";
return{fore:o2.foreLayers.imageLayers[a],back:o2.backLayers.imageLayers[a]}},MESSAGE_LAYER:function(a){if(a.toString().match(/^message$/i))return o2.currentMessageLayer;if(a.toString().match(/^message(\d+)$/i)){var b=Number(a.toString().match(/^message(\d+)$/i)[1]);if(o2.foreLayers.messageLayers[b])return{fore:o2.foreLayers.messageLayers[b],back:o2.backLayers.messageLayers[b]}}throw"\u30e1\u30c3\u30bb\u30fc\u30b8\u30ec\u30a4\u30e4 "+a+" \u306f\u5b58\u5728\u3057\u307e\u305b\u3093";},COLOR:function(a){a=
/0x([0-9a-fA-F]{6})/.exec(a);if(null==a)throw"color\u578b\u3067\u306f\u3042\u308a\u307e\u305b\u3093";return"#"+a[1]},TIME:function(a){if("-1"==a.indexOf(":")){a=parseFloat(a);if(isNaN(a))throw"time\u578b\u3067\u306f\u3042\u308a\u307e\u305b\u3093";return a}var b=a.split(":"),c=0,d=0,g=0,h=0;if(4==b.length)c=parseFloat(b[0]),d=parseFloat(b[1]),g=parseFloat(b[2]),h=b[3];else if(3==b.length)d=parseFloat(b[0]),g=parseFloat(b[1]),h=parseFloat(b[2]);else if(2==b.length)d=parseFloat(b[0]),g=parseFloat(b[1]);
else if(1==b.length)h=parseFloat(a)/10;else throw"time\u578b\u3067\u306f\u3042\u308a\u307e\u305b\u3093";if(isNaN(c)||isNaN(d)||isNaN(g)||isNaN(h))throw"time\u578b\u3067\u306f\u3042\u308a\u307e\u305b\u3093";return 36E5*c+6E4*d+1E3*g+10*h}};Tag.actions={};Tag.prototype.done=function(a){a?wait(this,a):trigger(this)};Tag.prototype.error=function(a,b){var c="\u30a8\u30e9\u30fc: ";b&&(c="\u8b66\u544a: ");this.file&&(c+="\u30d5\u30a1\u30a4\u30eb: "+this.file.filename+" / ");void 0!==this.originalLineNumber?
c+="\u884c: "+this.originalLineNumber+" / ":void 0!==this.lineNumber&&(c+="\u884c: "+this.lineNumber+" / ");c+="\u30bf\u30b0: "+this.tagName;c+=a;if(b)o2.warn(c,this);else throw o2.error(c,this),"";};Tag.prototype.warn=function(a){this.error(a,!0)};Tag.prototype.toJSON=function(){return config.saveMode==o2.SAVE_MODE_KAG3?{file:this.file.filename,label:this.args.name,initializer:"Tag"}:{file:this.file.filename,line:this.lineNumber,initializer:"Tag"}};Tag.restore=function(a){if("file"in a&&"line"in
a)return KAGFiles(a.file).lines[a.line];if("file"in a&&"label"in a)return KAGFiles(a.file).getLabelTag(a.label);o2.error("\u30bf\u30b0\u3092\u5fa9\u5143\u3067\u304d\u306a\u3044",a);return{}};TagAction=function(a){this.action=function(){};for(var b in a)this[b]=a[b]}})();Tag.actions.s=new TagAction({action:function(){o2.skipMode=o2.SKIP_MODE_NONE;return 2}});
(function(){var a=["text","ch","hch","emb","ruby"];a.concat(["style","resetstyle"]);Tag.actions.text=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(b){function c(){o2.skipMode=o2.SKIP_MODE_CLICK;$(o2).off("click",c)}var d=currentConductor.getNextTag();o2.currentMessageLayer.stackedTextsProperties||(o2.currentMessageLayer.stackedTextsProperties=[]);b.text.split("").forEach(function(a){a=new TextProperties(a);$.extend(a.styles,clone(o2.currentMessageLayer.font));o2.currentMessageLayer.currentRubyText&&
(a.rubyText=o2.currentMessageLayer.currentRubyText,delete o2.currentMessageLayer.currentRubyText);o2.currentMessageLayer.stackedTextsProperties.push(a)});if(d&&-1!=a.indexOf(d.tagName))return 0;o2.historyLayer.recorder.add("text",o2.currentMessageLayer.stackedTextsProperties.map(function(a){return a.text}).join(""));o2.currentMessageLayer.drawText(o2.currentMessageLayer.stackedTextsProperties,function(){$(o2).off("click",c);trigger("text")});delete o2.currentMessageLayer.stackedTextsProperties;if(o2.clickSkipEnabled)$(o2).on("click",
c);return 1}});Tag.actions.ch=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(b){var c=currentConductor.getNextTag();o2.currentMessageLayer.stackedTextsProperties||(o2.currentMessageLayer.stackedTextsProperties=[]);b=new TextProperties(b.text);$.extend(b.styles,clone(o2.currentMessageLayer.font));o2.currentMessageLayer.currentRubyText&&(b.rubyText=o2.currentMessageLayer.currentRubyText,delete o2.currentMessageLayer.currentRubyText);o2.currentMessageLayer.stackedTextsProperties.push(b);
if(c&&-1!=a.indexOf(c.tagName))return 0;o2.historyLayer.recorder.add("text",o2.currentMessageLayer.stackedTextsProperties.map(function(a){return a.text}).join(""));var d=this;o2.currentMessageLayer.drawText(o2.currentMessageLayer.stackedTextsProperties,function(){d.done()});delete o2.currentMessageLayer.stackedTextsProperties;return 1}});Tag.actions.hch=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(b){o2.currentMessageLayer.vertical||this.warn("hch\u30bf\u30b0\u306f\u7e26\u66f8\u304d\u306e\u72b6\u614b\u3067\u3057\u304b\u5b9f\u884c\u3067\u304d\u307e\u305b\u3093");
var c=currentConductor.getNextTag();o2.currentMessageLayer.stackedTextsProperties||(o2.currentMessageLayer.stackedTextsProperties=[]);b=new TextProperties(b.text);$.extend(b.styles,clone(o2.currentMessageLayer.font));b.styles.vertical=!1;o2.currentMessageLayer.currentRubyText&&(b.rubyText=o2.currentMessageLayer.currentRubyText,delete o2.currentMessageLayer.currentRubyText);o2.currentMessageLayer.stackedTextsProperties.push(b);if(c&&-1!=a.indexOf(c.tagName))return 0;o2.historyLayer.recorder.add("text",
o2.currentMessageLayer.stackedTextsProperties.map(function(a){return a.text}).join(""));var d=this;o2.currentMessageLayer.drawText(o2.currentMessageLayer.stackedTextsProperties,function(){d.done()});delete o2.currentMessageLayer.stackedTextsProperties;return 1}});Tag.actions.emb=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},action:function(a){a=eval(a.o2_exp);a=new Tag("ch",{text:a});currentConductor.stack.push(a);return 0}})})();
Tag.actions.ruby=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(a){o2.currentMessageLayer.currentRubyText=a.text;return 0}});Tag.actions.cm=new TagAction({action:function(){for(var a=o2.foreLayers.messageLayers.concat(o2.backLayers.messageLayers),b=a.length-1;0<=b;b--)a[b].resetMessageLayer();o2.historyLayer.recorder.add("pagebreak");return 0}});Tag.actions.ct=new TagAction({action:function(){(new Tag("cm")).run();o2.currentMessageLayer=o2.foreLayers.messageLayers[0];return 0}});
Tag.actions.er=new TagAction({action:function(){o2.currentMessageLayer.resetMessageLayer();o2.historyLayer.recorder.add("pagebreak");return 0}});Tag.actions.current=new TagAction({rules:{layer:{type:"MESSAGE_LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"}},action:function(a){o2.currentMessageLayer=a.layer[a.page];return 0}});
Tag.actions.position=new TagAction({rules:{layer:{type:"MESSAGE_LAYER"},page:{type:/fore|back/},left:{type:"INT"},top:{type:"INT"},width:{type:"INT"},height:{type:"INT"},frame:{type:"STRING"},color:{type:"COLOR"},opacity:{type:"FLOAT"},marginl:{type:"INT"},margint:{type:"INT"},marginr:{type:"INT"},marginb:{type:"INT"},vertical:{type:"BOOLEAN"},visible:{type:"BOOLEAN"}},action:function(a){var b;b=a.layer&&a.page?a.layer[a.page]:o2.currentMessageLayer;var c=!1,d=clone(b.rect);"left"in a&&(d.x=a.left);
"top"in a&&(d.y=a.top);"width"in a&&(d.width=a.width);"height"in a&&(d.height=a.height);b.setRect(d);"frame"in a&&(""===a.frame?b.setFrameImage():(ResourceLoader.loadImage(a.frame,!1).done(function(c){c=new DrawableImage(c);c.originalURL=a.frame;b.setFrameImage(c)}).always(function(){setTimeout(function(){renderer.animator.requestFrame();trigger("position")})}),c=!0));"color"in a&&(b.frameSolid.color=a.color);"opacity"in a&&(b.frameSolid.opacity=a.opacity/255);"marginl"in a&&(b.margin.left=a.marginl);
"margint"in a&&(b.margin.top=a.margint);"marginr"in a&&(b.margin.right=a.marginr);"marginb"in a&&(b.margin.bottom=a.marginb);"vertical"in a&&(b.vertical=a.vertical);"visible"in a&&b.visible!=a.visible&&(b.visible=a.visible);b.resetMessageLayer();if(c)return 1;renderer.animator.requestFrame();return 0}});
Tag.actions.delay=new TagAction({rules:{speed:{type:"INT",required:!0,allowString:["user","nowait"]}},action:function(a){a.speed="nowait"===a.speed?0:"user"===a.speed?config.delaySpeed||40:parseFloat(a.speed);for(var b=o2.foreLayers.messageLayers.concat(o2.backLayers.messageLayers),c=b.length-1;0<=c;c--)b[c].delaySpeed=a.speed}});
Tag.actions.wc=new TagAction({rules:{time:{type:"INT",required:!0}},action:function(a){var b=this;setTimeout(function(){b.done()},a.time*o2.currentMessageLayer.delaySpeed);return 1}});(function(){var a=void 0;Tag.actions.nowait=new TagAction({action:function(){a=o2.currentMessageLayer.delaySpeed;return o2.currentMessageLayer.delaySpeed=0}});Tag.actions.endnowait=new TagAction({action:function(){o2.currentMessageLayer.delaySpeed=a;return 0}})})();
Tag.actions.deffont=new TagAction({rules:{size:{type:"INT"},face:{type:"STRING"},color:{type:"COLOR"},rubysize:{type:"INT"},rubyoffset:{type:"INT"},edge:{type:"BOOLEAN"},edgecolor:{type:"COLOR"},bold:{type:"BOOLEAN"},o2_shadow:{type:"BOOLEAN"},o2_shadowcolor:{type:"COLOR"},o2_shadowblur:{type:"INT"},o2_shadowoffsetx:{type:"INT"},o2_shadowoffsety:{type:"INT"}},action:function(a){var b=o2.currentMessageLayer,c={rubysize:"rubySize",rubyoffset:"rubyOffset",edgecolor:"edgeColor",shadowcolor:"shadowColor",
o2_shadow:"shadow",o2_shadowcolor:"shadowColor",o2_shadowblur:"shadowBlur",o2_shadowoffsetx:"shadowOffsetX",o2_shadowoffsety:"shadowOffsetY"},d;for(d in a)b.defaultFont[c[d]||d]=a[d];if(a.face){var g=this;ResourceLoader.loadFont(a.face,!0).always(function(){setTimeout(function(){g.done()})});return 1}return 0}});
Tag.actions.font=new TagAction({rules:{size:{type:"INT",allowString:["default"]},face:{type:"STRING"},color:{type:"COLOR",allowString:["default"]},italic:{type:"BOOLEAN",allowString:["default"]},rubysize:{type:"INT",allowString:["default"]},rubyoffset:{type:"INT",allowString:["default"]},edge:{type:"BOOLEAN",allowString:["default"]},edgecolor:{type:"COLOR",allowString:["default"]},bold:{type:"BOOLEAN",allowString:["default"]},o2_shadow:{type:"BOOLEAN"},o2_shadowcolor:{type:"COLOR"},o2_shadowblur:{type:"INT"},
o2_shadowoffsetx:{type:"INT"},o2_shadowoffsety:{type:"INT"}},action:function(a){var b={rubysize:"rubySize",rubyoffset:"rubyOffset",edgecolor:"edgeColor",shadowcolor:"shadowColor",o2_shadow:"shadow",o2_shadowcolor:"shadowColor",o2_shadowblur:"shadowBlur",o2_shadowoffsetx:"shadowOffsetX",o2_shadowoffsety:"shadowOffsetY"},c;for(c in a){var d=b[c]||c;"default"===a[c]?a[c]=o2.currentMessageLayer.deffont[d]:o2.currentMessageLayer.font[d]=a[c]}if(a.face){var g=this;ResourceLoader.loadFont(a.face,!0).always(function(){setTimeout(function(){g.done()})});
return 1}return 0}});Tag.actions.resetfont=new TagAction({action:function(){o2.currentMessageLayer.font=clone(o2.currentMessageLayer.defaultFont)}});
Tag.actions.defstyle=new TagAction({rules:{linespacing:{type:"INT"},pitch:{type:"INT"},linesize:{type:"INT"},o2_kinsoku:{type:/none|oidashi|burasagari-oidashi/},o2_kinsoku_bol_char:{type:"STRING"},o2_kinsoku_eol_char:{type:"STRING"},o2_kinsoku_burasagari_char:{type:"STRING"}},action:function(a){var b={linespacing:"lineSpacing",linesize:"lineSize",o2_kinsoku:"kinsoku",o2_kinsoku_bol_char:"kinsokuBolChar",o2_kinsoku_eol_char:"kinsokuEolChar",o2_kinsoku_burasagari_char:"kinsokuBurasagariChar"},c=o2.currentMessageLayer,
d;for(d in a)c.defaultStyle[b[d]||d]=a[d];if("o2_kinsoku"in a)switch(a.o2_kinsoku){case "none":c.defaultStyle.kinsoku=MessageLayer.KINSOKU_NONE;break;case "oidashi":c.defaultStyle.kinsoku=MessageLayer.KINSOKU_OIDASHI;break;case "burasagari-oidashi":c.defaultStyle.kinsoku=MessageLayer.KINSOKU_BURASAGARI}return 0}});
Tag.actions.style=new TagAction({rules:{align:{type:/left|center|right|top|center|bottom|default/},linespacing:{type:"INT"},pitch:{type:"INT"},linesize:{type:"INT",allowString:["default"]},autoreturn:{type:"BOOLEAN",allowString:["default"]},o2_kinsoku:{type:/none|oidashi|burasagari-oidashi/},o2_kinsoku_bol_char:{type:"STRING"},o2_kinsoku_eol_char:{type:"STRING"},o2_kinsoku_burasagari_char:{type:"STRING"}},action:function(a){var b=o2.currentMessageLayer;"align"in a&&(b.style.align="default"==a.align?
b.vertical?"top":"left":a.align);"linespacing"in a&&(b.vertical?b.textCursor.x-=a.linespacing-b.style.lineSpacing:b.textCursor.y+=a.linespacing-b.style.lineSpacing,b.style.lineSpacing=a.linespacing);"pitch"in a&&(b.style.pitch=a.pitch);"linesize"in a&&(b.style.lineSize="default"==a.linesize?-1:a.linesize);"autoreturn"in a&&("default"==a.autoreturn&&(a.autoreturn=b.defaultStyle.autoReturn),b.style.autoReturn=a.autoreturn);var c={o2_kinsoku_bol_char:"kinsokuBolChar",o2_kinsoku_eol_char:"kinsokuEolChar",
o2_kinsoku_burasagari_char:"kinsokuBurasagariChar"},d;for(d in a)d in c&&(b.style[c[d]]=a[d]);if("o2_kinsoku"in a)switch(a.o2_kinsoku){case "none":b.style.kinsoku=MessageLayer.KINSOKU_NONE;break;case "oidashi":b.style.kinsoku=MessageLayer.KINSOKU_OIDASHI;break;case "burasagari-oidashi":b.style.kinsoku=MessageLayer.KINSOKU_BURASAGARI}}});
Tag.actions.resetstyle=new TagAction({action:function(){var a=o2.currentMessageLayer;a.vertical?a.textCursor.x-=o2.currentMessageLayer.defaultStyle.linespacing-o2.currentMessageLayer.style.lineSpacing:a.textCursor.y+=o2.currentMessageLayer.defaultStyle.linespacing-o2.currentMessageLayer.style.lineSpacing;a.style=clone(a.defaultStyle)}});
Tag.actions.locate=new TagAction({rules:{x:{type:"INT"},y:{type:"INT"}},action:function(a){var b=o2.currentMessageLayer;"x"in a&&(b.textCursor.x=a.x+b.margin.left,b.vertical&&(b.textCursor.x-=b.style.lineSpacing));"y"in a&&(b.textCursor.y=a.y+b.margin.top,b.vertical||(b.textCursor.y+=b.style.lineSpacing));return 0}});Tag.actions.r=new TagAction({action:function(){o2.currentMessageLayer.linebreak();o2.historyLayer.recorder.add("linebreak");return 0}});
Tag.actions.p=new TagAction({action:function(){o2.historyLayer.recorder.add("linebreak");if(o2.skipMode<=o2.SKIP_MODE_PAGE)o2.skipMode=o2.SKIP_MODE_NONE;else if(o2.skipMode==o2.SKIP_MODE_FAST_FORWARD&&!o2.skipKeyPressing())o2.skipMode=o2.SKIP_MODE_NONE;else return 0;glyph.showPageGlyph();wait("click",function(){glyph.hide()});return 1}});
Tag.actions.l=new TagAction({action:function(){if(o2.skipMode<=o2.SKIP_MODE_CLICK)o2.skipMode=o2.SKIP_MODE_NONE;else if(o2.skipMode==o2.SKIP_MODE_FAST_FORWARD&&!o2.skipKeyPressing())o2.skipMode=o2.SKIP_MODE_NONE;else return 0;glyph.showLineGlyph();wait("click",function(){glyph.hide()});return 1}});
Tag.actions.button=new TagAction({rules:{graphic:{type:"STRING",required:!0},graphickey:{type:"COLOR",allowString:["adapt"]},storage:{type:"STRING"},target:{type:"STRING"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},o2_exp:{type:"STRING"},o2_onenter:{type:"STRING"},o2_onleave:{type:"STRING"}},action:function(a){var b=this;ResourceLoader.loadImage(a.graphic).done(function(c){setTimeout(function(){var d=o2.currentMessageLayer.textCursor,d=new KAGButton(c,d.x,d.y);d.importFromKAGArgs(a);
o2.currentMessageLayer.addButton(d);b.done()})});return 1}});var KAGButton=function(a,b,c){Button.call(this,a,b,c);this.rect.width=Math.floor(this.rect.width/3);this.options.clipLeft=0;this.options.clipWidth=this.rect.width;this.tagArgs};KAGButton.prototype=Object.create(Button.prototype);KAGButton.prototype.initializer="KAGButton";KAGButton.prototype.clone=function(a){var b=new KAGButton(this.image);b.importFrom(a);return b};
KAGButton.prototype.drawOnContext=function(a,b){switch(this.state){case Button.STATE_HOVER:this.options.clipLeft=2*this.rect.width;break;case Button.STATE_DOWN:this.options.clipLeft=this.rect.width;break;default:this.options.clipLeft=0}Button.prototype.drawOnContext.apply(this,arguments)};
KAGButton.prototype.importFromKAGArgs=function(a){this.tagArgs=clone(a);this.click=function(){a.o2_exp&&eval(a.o2_exp);a.o2_url&&window.open(a.o2_url,a.o2_urltarget);if(a.storage||a.target){var b=new Tag("jump",{storage:a.storage,target:a.target});currentConductor.stack.push(b)}};a.o2_onenter&&(this.enter=function(){eval(a.o2_onenter)});a.o2_onleave&&(this.leave=function(){eval(a.o2_onleave)})};KAGButton.prototype.importFrom=function(a){Button.prototype.importFrom.call(this,a);this.importFromKAGArgs(a.tagArgs)};
KAGButton.prototype.toJSON=function(){var a=Button.prototype.toJSON.call(this);a.tagArgs=this.tagArgs;return a};KAGButton.restore=function(a){return $.when(ResourceLoader.loadImage(a.image,!0)).then(function(b){b=new KAGButton(b);b.importFrom(a);return b})};
(function(){KAGLink=function(){Link.call(this);this.tagArgs};KAGLink.prototype=Object.create(Link.prototype);KAGLink.prototype.initializer="KAGLink";KAGLink.restore=function(a){var b=new KAGLink;b.importFromKAGArgs(a.tagArgs);delete a.tagArgs;Link.prototype.importFromSaveData(a);return b};KAGLink.prototype.importFrom=function(a){Link.prototype.importFrom.call(this,a);this.importFromKAGArgs(a.tagArgs)};KAGLink.prototype.importFromKAGArgs=function(a){this.tagArgs=a;this.click=function(){"o2_exp"in a&&
eval(a.o2_exp);"o2_url"in a&&window.open(a.o2_url,a.o2_urltarget);if(a.target||a.storage){var b=new Tag("jump",{target:this.tagArgs.target,storage:this.tagArgs.storage});currentConductor.stack.push(b)}};"o2_onenter"in a&&(this.enter=function(){eval(a.o2_onenter)});"o2_onleave"in a&&(this.leave=function(){eval(a.o2_onleave)})};var a=0,b={};Tag.actions.link=new TagAction({rules:{storage:{type:"STRING"},target:{type:"STRING"},color:{type:"COLOR"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},
o2_onenter:{type:"STRING"},o2_onleave:{type:"STRING"},o2_exp:{type:"STRING"}},action:function(c){a=o2.currentMessageLayer.textsProperties.length;b=c;return 0}});Tag.actions.endlink=new TagAction({action:function(){var c=new KAGLink;c.importFromKAGArgs(b);c.vertical=o2.currentMessageLayer.vertical;for(var d=a;d<o2.currentMessageLayer.textsProperties.length;d++)c.addTextProperties(o2.currentMessageLayer.textsProperties[d]);o2.currentMessageLayer.addLink(c);return 0}})})();
Tag.actions.image=new TagAction({rules:{storage:{type:"STRING",required:!0},layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},grayscale:{type:"BOOLEAN"},clipleft:{type:"INT"},cliptop:{type:"INT"},clipwidth:{type:"INT"},clipheight:{type:"INT"},flipud:{type:"BOOLEAN"},fliplr:{type:"BOOLEAN"},visible:{type:"BOOLEAN"},left:{type:"INT"},top:{type:"INT"},pos:{type:/left|left_center|center|right_center|right|l|lc|c|rc|r/},opacity:{type:"INT"},allowfail:{type:"BOOLEAN",defaultValue:!1},
o2_zoom:{type:"FLOAT"},o2_rotate:{type:"FLOAT"},o2_orx:{type:"FLOAT"},o2_ory:{type:"FLOAT"}},preload:function(a){ResourceLoader.loadImage(a.storage,!1)},action:function(a){var b=this,c=a.layer[a.page],d={grayscale:!1,rgamma:1,ggamma:1,bgamma:1,shadow:"#000000",shadowOpacity:200,shadowX:10,shadowY:10,shadowBlur:3,clipLeft:void 0,clipTop:void 0,clipWidth:void 0,clipHeight:void 0,flipUD:!1,flipLR:!1,visible:!0,opacity:255},g={shadowopacity:"shadowOpacity",shadowx:"shadowX",shadowy:"shadowY",shadowblur:"shadowBlur",
clipleft:"clipLeft",cliptop:"clipTop",clipwidth:"clipWidth",clipheight:"clipHeight",flipud:"flipUD",fliplr:"flipLR"},h;for(h in a)-1=="storage layer page allowfail left top pos o2_zoom o2_rotate o2_orx o2_ory".split(" ").indexOf(h)&&(d[g[h]||h]=a[h]);"opacity"in d&&(c.opacity=d.opacity/255,d.opacity=1);"visible"in d&&(c.visible=d.visible,d.visible=!0);"shadowOpacity"in d&&(d.shadowOpacity/=255);c.loadImage(a.storage,d,a.allowfail).fail(function(){this.error("\u30a4\u30e1\u30fc\u30b8\u30d5\u30a1\u30a4\u30eb "+
a.storage+" \u3092\u30ed\u30fc\u30c9\u3067\u304d\u307e\u305b\u3093")}).always(function(d){if("pos"in a){switch(a.pos){case "left":case "l":c.rect.x=config.scPositionX_left-d.width/2;break;case "left_center":case "lc":c.rect.x=config.scPositionX_left_center-d.width/2;break;case "center":case "c":c.rect.x=config.scPositionX_center-d.width/2;break;case "right_center":case "rc":c.rect.x=config.scPositionX_right_center-d.width/2;break;case "right":case "r":c.rect.x=config.scPositionX_right-d.width/2}c.rect.y=
config.scHeight-d.height}else"left"in a&&(c.rect.x=a.left),"top"in a&&(c.rect.y=a.top);c.rect.width=Math.max(config.scWidth,d.width);c.rect.height=Math.max(config.scHeight,d.height);c.setRect();"o2_zoom"in a&&(c.scale=a.o2_zoom/100);"o2_rotate"in a&&(c.rotation=a.o2_rotate/180*Math.PI);c.transformOrigin.x="o2_orx"in a?a.o2_orx:d.width/2;c.transformOrigin.y="o2_ory"in a?a.o2_ory:d.height/2;setTimeout(b.done.bind(b))});return 1}});
Tag.actions.freeimage=new TagAction({rules:{layer:{type:"IMAGE_LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"}},action:function(a){a.layer[a.page].clearImage();return 0}});Tag.actions.backlay=new TagAction({rules:{layer:{type:"LAYER"}},action:function(a){var b=this;renderer.animator.requestFrame(function(){if(a.layer)a.layer.back.importFrom(a.layer.fore);else for(var c=o2.allForeLayers(),d=o2.allBackLayers(),g=0;g<c.length;g++)d[g].importFrom(c[g]);b.done()});return 1}});
Tag.actions.copylay=new TagAction({rules:{srclayer:{type:"LAYER",required:!0},destlayer:{type:"LAYER",required:!0},srcpage:{type:/fore|back/,defaultValue:"fore"},destpage:{type:/fore|back/,defaultValue:"fore"}},action:function(a){var b=a.srclayer[a.srcpage],a=a.destlayer[a.destpage];if(b.initializer!=a.initializer)throw"srclayer\u3068destlayer\u306b\u7570\u306a\u308b\u7a2e\u985e\u306e\u30ec\u30a4\u30e4\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093";a.importFrom(b);
return 0}});
Tag.actions.layopt=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},visible:{type:"BOOLEAN"},left:{type:"INT"},top:{type:"INT"},opacity:{type:"INT"},autohide:{type:"BOOLEAN"},o2_zoom:{type:"FLOAT"},o2_rotate:{type:"FLOAT"},o2_orx:{type:"FLOAT"},o2_ory:{type:"FLOAT"}},action:function(a){var b=a.layer[a.page];"visible"in a&&(b.visible=a.visible);"left"in a&&(b.rect.x=a.left);"top"in a&&(b.rect.y=a.top);"opacity"in a&&(b.opacity=a.opacity/255);if("autohide"in
a)if(a.autohide)-1==o2.extraAutoHideLayers.indexOf(b)&&o2.extraAutoHideLayers.push(b);else{var c=o2.extraAutoHideLayers.indexOf(b);-1!=c&&o2.extraAutoHideLayers.splice(c,1)}"o2_zoom"in a&&(b.scale=a.o2_zoom/100);"o2_rotate"in a&&(b.rotation=a.o2_rotate/180*Math.PI);"o2_orx"in a&&(b.transformOrigin.x=a.o2_orx);"o2_ory"in a&&(b.transformOrigin.y=a.o2_ory);renderer.animator.requestFrame();return 0}});
Tag.actions.trans=new TagAction({rules:{time:{type:"INT",required:!0},layer:{type:"LAYER",defaultValue:"base"},children:{type:"BOOLEAN",defaultValue:!0},method:{type:"STRING",defaultValue:"crossfade"}},action:function(a){function b(){if(!this.end)if(g)$.when(Tag.actions.trans.stopAllTransitions()).done(function(){Tag.actions.trans.runningTag=d;var b=$("#main-wrapper");d.container=$("<div />");d.container.css({position:"absolute",width:b.width()+"px",height:b.height()+"px"});b.append(d.container);
d.container.append([renderer.foreCanvas,renderer.backCanvas]);d.method.transitAllLayers.call(d,a,renderer.backCanvas,renderer.foreCanvas,d.container);renderer.animator.requestFrame(function(){d.end||c()},a.time)});else{a.layer.fore.transit(this);var b=Date.now(),j=function(){d.end||(Date.now()-b<a.time?renderer.animator.requestFrame(j):c())};j()}}function c(){d.end||(d.end=!0,g?Tag.actions.trans.stopAllTransitions():a.layer.fore.stopTransition(),d.done())}this.end=!1;this.transArgs=a;(this.method=
Tag.actions.trans.methods[a.method])||this.error(a.method+" \u3068\u3044\u3046\u30e1\u30bd\u30c3\u30c9\u306f\u5b58\u5728\u3057\u307e\u305b\u3093");"canRun"in this.method&&!this.method.canRun()&&(this.method=Tag.actions.trans.methods.crossfade);var d=this,g=!1;a.layer.fore==o2.foreLayers.baseLayer&&a.children&&(g=!0);!this.method.transit&&!g&&this.error("\u30e1\u30bd\u30c3\u30c9 "+a.method+" \u3092\u5b9f\u884c\u3059\u308b\u306b\u306flayer\u5c5e\u6027\u306bbase\u3001children\u5c5e\u6027\u306btrue\u3092\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059");
renderer.renderBackCanvas=!0;"function"===typeof this.method.preload?this.method.preload.call(this,a).done(function(){renderer.animator.requestFrame(function(){b.call(d);d.done()})}):renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){b.call(d);d.done()})});return 1},stopAllTransitions:function(){for(var a=o2.allForeLayers(),b=0;b<a.length;b++)a[b].stopTransition();if(Tag.actions.trans.runningTag){var c=$.Deferred();renderer.renderBackCanvas=!1;for(b=0;b<renderer.foreLayers.length;b++)renderer.foreLayers[b].importFrom(renderer.backLayers[b]);
var d=Tag.actions.trans.runningTag;renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){"function"==typeof d.method.teardownAllLayers&&d.method.teardownAllLayers.call(d,d.transArgs,renderer.backCanvas,renderer.foreCanvas,d.container);$(renderer.backCanvas).detach();d.container&&(d.container.remove(),delete d.container);$("#main-wrapper").append(renderer.foreCanvas);c.resolve()})});d.end=!0;Tag.actions.trans.runningTag=void 0;$(o2).trigger("transEnd");return c.promise()}},
methods:{}});
TransMethod=function(a){for(var b in a)this[b]=a[b];a.transitAllLayers||(this.transitAllLayers=function(b,d,g,h){function j(){n.end||(Date.now()-i<b.time&&renderer.animator.requestFrame(j),a.transit.call(n,b,g,d,n.transCanvas))}$(d).hide();$(g).hide();this.transCanvas=document.createElement("canvas");this.transCanvas.width=g.width;this.transCanvas.height=d.height;$(this.transCanvas).css({position:"absolute",x:0,y:0});$(h).append(this.transCanvas);a.prepare.call(this,b);var i=Date.now(),n=this;j()},
this.teardownAllLayers=function(b,d,g){"function"==typeof a.teardown&&a.teardown.call(this);$(d).show();$(g).show();$(this.transCanvas).remove();this.transCanvas=null})};Tag.actions.stoptrans=new TagAction({action:function(){var a=this;$.when(Tag.actions.trans.stopAllTransitions()).done(function(){setTimeout(function(){a.done()})});return 1}});
Tag.actions.wt=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!0}},action:function(a){var b=o2.allForeLayers(),c=!0;if(Tag.actions.trans.runningTag)c=!1;else for(var d=b.length-1;0<=d;d--)if(b[d].isTransiting()){c=!1;break}if(c)return 0;if(a.canskip&&o2.clickSkipEnabled){if(o2.skipMode){var g=this;$.when(Tag.actions.trans.stopAllTransitions()).done(function(){setTimeout(function(){g.done()})});return 1}wait("click",function(){Tag.actions.trans.stopAllTransitions()})}wait("trans");return 1}});
Tag.actions.trans.methods.crossfade=new TransMethod({prepare:function(){this.beginning=Date.now()},transit:function(a,b,c,d){var g=d.getContext("2d"),a=(Date.now()-this.beginning)/a.time;if(1<=a||this.end)a=1;g.save();g.clearRect(0,0,d.width,d.height);g.globalAlpha=1;g.drawImage(b,0,0);g.globalAlpha=a;g.drawImage(c,0,0);g.restore()},teardown:function(){delete this.beginning},transitAllLayers:function(a,b,c){var d=this,g=Date.now();c.style.zIndex=1;b.style.zIndex=2;if(supportCssProperty("animationName"))c=
"@-webkit-keyframes fade { \n0% { \n opacity: 0; \n} 100% { \n opacity: 1; \n}} \n",c+=c.replace(/-webkit-/g,"-moz-")+c.replace(/-webkit-/g,"-o-")+c.replace(/-webkit-/g,""),c=document.createTextNode(c),this.cssTag=document.createElement("style"),this.cssTag.type="text/css",this.cssTag.appendChild(c),document.getElementsByTagName("head")[0].appendChild(this.cssTag),$(b).css("opacity",0),renderer.animator.requestFrame(function(){$(b).css({"animation-duration":a.time+"ms","animation-timing-function":a.timing_function||
"linear","animation-name":"fade"})});else{var h=function(){var c=(Date.now()-g)/a.time;d.end||renderer.animator.requestFrame(h);b.style.opacity=c};renderer.animator.requestFrame(h)}},teardownAllLayers:function(a,b){this.end=!0;if(this.cssTag)try{document.getElementsByTagName("head")[0].removeChild(this.cssTag)}catch(c){}$(b).css({opacity:1,"animation-duration":"","animation-timing-function":"","animation-name":""})}});
$.extend(Tag.actions.trans.rules,{from:{type:/left|top|right|bottom/,defaultValue:"left"},stay:{type:/stayfore|stayback|nostay/,defaultValue:"nostay"},o2_timing_function:{type:"STRING",defaultValue:"linear"}});
Tag.actions.trans.methods.scroll=new TransMethod({prepare:function(a){this.beginning=Date.now();if(-1!=a.o2_timing_function.indexOf("cubic-bezier")){a=a.o2_timing_function.replace("cubic-bezier","");a=a.replace("(","");a=a.replace(")","");a=a.split(",").map(function(a){return parseFloat(a)});if(4!=a.length)throw"o2_timing_function\u5c5e\u6027\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u6b63\u3057\u304f\u3042\u308a\u307e\u305b\u3093";this.timingFunction=new KeySpline(a[0],a[1],a[2],a[3])}else switch(a.o2_timing_function){case "ease":this.timingFunction=
new KeySpline(0.25,0.1,0.25,1);break;case "ease-in":this.timingFunction=new KeySpline(0.42,0,1,1);break;case "ease-out":this.timingFunction=new KeySpline(0,0,0.58,1);break;case "ease-in-out":this.timingFunction=new KeySpline(0.42,0,0.58,1);break;default:this.timingFunction=new KeySpline(0,0,1,1)}},transit:function(a,b,c,d){var g=(Date.now()-this.beginning)/a.time,h=d.getContext("2d"),g=this.timingFunction.get(g);h.clearRect(0,0,d.width,d.height);var j=drawY=0;if("stayback"!=a.stay)switch(a.from){case "top":drawY=
d.height*g;break;case "right":j=-1*b.width*g;break;case "bottom":drawY=-1*b.height*g;break;default:j=d.width*g}h.drawImage(b,j,drawY,b.width,b.height);var b=c.height,i=c.width,n=0,p=0;if("stayfore"==a.stay)switch(j=drawY=0,a.from){case "top":b*=g;break;case "right":i*=g;j=n=(1-g)*c.width;break;case "bottom":b*=g;drawY=p=(1-g)*c.height;break;default:i*=g}else switch(a.from){case "top":drawY=c.height*(g-1);break;case "right":j=d.width*(1-g);break;case "bottom":drawY=(1-g)*d.height;break;default:j=c.width*
(g-1)}h.drawImage(c,n,p,i,b,j,drawY,i,b)},teardown:function(){delete this.beginning;delete this.timingFunction}});$.extend(Tag.actions.trans.rules,{vague:{type:"INT",defaultValue:64},rule:{type:"STRING"},liveview:{type:"BOOLEAN",allowString:["auto"],defaultValue:"auto"}});
Tag.actions.trans.methods.universal=new TransMethod({preload:function(a){if(!("rule"in a))throw"rule\u5c5e\u6027\u306f\u5fc5\u9808\u3067\u3059";var b=this;this.liveview=function(){if(!0===a.liveview)return!0;if("auto"==a.liveview){var b;b=a.layer.fore==o2.foreLayers.baseLayer?o2.allLayers():a.layer;for(var d in b)if(b[d].moveTag)return!0}return!1}();return ResourceLoader.loadImage(a.rule).done(function(a){b.maskImage=a})},prepare:function(){this.beginning=Date.now();this.maskCanvas=document.createElement("canvas");
this.maskCanvas.width=this.maskImage.width;this.maskCanvas.height=this.maskImage.height;this.maskContext=this.maskCanvas.getContext("2d");this.maskContext.drawImage(this.maskImage,0,0);this.maskData=this.maskContext.getImageData(0,0,this.maskCanvas.width,this.maskCanvas.height)},transit:function(a,b,c,d){var g=(Date.now()-this.beginning)/a.time;1<g&&(g=1);var h,j=b.getContext("2d");h=c.getContext("2d");b=j.getImageData(0,0,b.width,b.height);c=h.getImageData(0,0,c.width,c.height).data;h=b.data;this.liveview||
(this.beforeBitmap=h,this.afterBitmap=c);var a=a.vague,g=a+(a+255)*-g,b=this.maskData.data,j=d.getContext("2d"),i=j.createImageData(d.width,d.height),n=i.data;if(this.maskCanvas.width==d.width&&this.maskCanvas.height==d.height)for(var d=0,p=n.length;d<p;d+=4){var k=1-(b[d]+g)/a,k=Math.max(0,Math.min(1,k));n[d]=h[d]+(c[d]-h[d])*k;n[d+1]=h[d+1]+(c[d+1]-h[d+1])*k;n[d+2]=h[d+2]+(c[d+2]-h[d+2])*k;n[d+3]=255}else for(var r=d.width,q=this.maskCanvas.width,u=this.maskCanvas.height,d=0,p=n.length;d<p;d+=4)k=
Math.floor(d/4/r),maskX=d/4%q,maskY=k%u,maskIndex=4*(maskX+maskY*q),k=1-(b[maskIndex]+g)/a,k=Math.max(0,Math.min(1,k)),n[d]=h[d]+(c[d]-h[d])*k,n[d+1]=h[d+1]+(c[d+1]-h[d+1])*k,n[d+2]=h[d+2]+(c[d+2]-h[d+2])*k,n[d+3]=255;j.putImageData(i,0,0)},teardown:function(){delete this.beginning;delete this.maskCanvas;delete this.maskContext;delete this.maskData;delete this.maskImage}});
Tag.actions.move=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},spline:{type:"BOOLEAN"},time:{type:"INT",required:!0},delay:{type:"INT"},path:{type:"STRING"},accel:{type:"INT",defaultValue:0},o2_path:{type:"STRING"},o2_orx:{type:"FLOAT"},o2_ory:{type:"FLOAT"}},action:function(a){var b=this,c=a.time,d=a.layer[a.page];"o2_orx"in a&&(d.transformOrigin.x=a.o2_orx);"o2_ory"in a&&(d.transformOrigin.y=a.o2_ory);if(!("path"in a)&&!("o2_path"in a))return this.error("path\u5c5e\u6027\u304bo2_path\u5c5e\u6027\u306e\u3044\u305a\u308c\u304b\u306f\u5fc5\u9808\u3067\u3059"),
0;var g=function(a,b,c,d,g){this.x=parseFloat(a);this.y=parseFloat(b);this.opacity=parseFloat(c);this.zoom=parseFloat(d);this.rotation=parseFloat(g)},h=[],j=a.path;"o2_path"in a&&(j=a.o2_path);var i=j.match(/\((-?[0-9,\s]+)*\)/g);null==i&&this.error("path\u5c5e\u6027\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u6b63\u3057\u304f\u3042\u308a\u307e\u305b\u3093");h.push(new g(d.rect.x,d.rect.y,d.opacity,d.scale,d.rotation));for(var n=0;n<i.length;n++){var p=i[n],p=p.replace("(","").replace(")",""),
p=p.split(","),k=new g,r=parseFloat(p[0]);k.x=isNaN(r)?h[h.length-1].x:r;r=parseFloat(p[1]);k.y=isNaN(r)?h[h.length-1].y:r;r=parseFloat(p[2]);k.opacity=isNaN(r)?h[h.length-1].opacity:r/255;r=parseFloat(p[3]);if(isNaN(r))k.zoom=h[h.length-1].zoom;else{if(j==a.path)return this.error("path\u5c5e\u6027\u306b4\u3064\u4ee5\u4e0a\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093"),0;k.zoom=r/100}p=parseFloat(p[4]);k.rotation=isNaN(p)?h[h.length-
1].rotation:p/180*Math.PI;h.push(k)}var c=a.time*(h.length-1),q;q=-1>a.accel?new KeySpline(0.08,0.44,0.42,0.93):1<a.accel?new KeySpline(0.45,0,0.97,0.65):new KeySpline(0,0,1,1);var g=function(){d.moveTag&&(d.moveTag.end=!0);d.moveTag=this;var g=void 0;a.spline&&2<=h.length&&(g=B_Spline_Generator(h.map(function(a){return[a.x,a.y]})));var i=Date.now();renderer.animator.requestFrame(function I(){var a=(Date.now()-i)/c,j=1/(h.length-1);if(1<=a||b.end)a=h[h.length-1],d.rect.x=a.x,d.rect.y=a.y,d.opacity=
a.opacity,d.scale=a.zoom,d.rotation=a.rotation,b.done(),$(o2).off("transEnd",u),u=null,b.end=!1,d.moveTag==b&&delete d.moveTag;else{renderer.animator.requestFrame(I);var a=q.get(a),k=Math.floor((h.length-1)*a),n=k+1,j=a/j-k;n>=h.length&&(n=h.length-1);k=h[k];n=h[n];a=g?g(100*a):{x:k.x+(n.x-k.x)*j,y:k.y+(n.y-k.y)*j};d.rect.x=a.x;d.rect.y=a.y;d.opacity=k.opacity+(n.opacity-k.opacity)*j;d.scale=k.zoom+(n.zoom-k.zoom)*j;d.rotation=k.rotation+(n.rotation-k.rotation)*j}})},u=function(){var a=o2.allForeLayers(),
b=o2.allBackLayers(),c=a.indexOf(d),g=!0;-1==c&&(c=b.indexOf(d),g=!1);d=g?b[c]:a[c]};$(o2).on("transEnd",u);a.delay?setTimeout(g.bind(this),a.delay):g.call(this);return 0}});Tag.actions.stopmove=new TagAction({action:function(){for(var a=o2.allLayers(),b=a.length-1;0<=b;b--)a[b].moveTag&&(a[b].moveTag.end=!0);return 0}});
Tag.actions.wm=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!0}},action:function(a){function b(){for(var a=o2.allLayers(),b=a.length-1;0<=b;b--)a[b].moveTag&&(a[b].moveTag.end=!0)}if(a.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return b(),0;wait("click",b)}wait("move");return 1}});
(function(){var a=!1,b=!1;Tag.actions.quake=new TagAction({rules:{time:{type:"INT",required:!0},hmax:{type:"INT",defaultValue:10},vmax:{type:"INT",defaultValue:10}},action:function(c){function d(){a=!0;for(var d=0;d<h;d++)j.push({x:Math.floor(2*Math.random()*c.hmax)-c.hmax,y:Math.floor(2*Math.random()*c.vmax)-c.vmax});j.push({x:0,y:0});renderer.animator.requestFrame(function k(){var d=Date.now()-g,h=1/(j.length-1),n=d/c.time;1<n||b?(n=1,b=a=!1,i.done()):renderer.animator.requestFrame(k);var w=Math.floor((j.length-
1)*n),d=w+1,h=n/h-w;d>=j.length&&(d=j.length-1);w=j[w];d=j[d];renderer.xShift=w.x+(d.x-w.x)*h;renderer.yShift=w.y+(d.y-w.y)*h})}var g=Date.now(),h=Math.ceil(c.time/50),j=[],i=this;if(a)return b=!0,renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){d();i.done()})}),1;d();return 0}});Tag.actions.stopquake=new TagAction({rules:{},action:function(){a&&(b=!0);return 0}});Tag.actions.wq=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(c){if(!a)return 0;
if(c.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return b=!0,0;wait("click",function(){b=!0})}wait("quake");return 1}})})();
Tag.actions.label=new TagAction({rules:{name:{type:"STRING",required:!0},caption:{type:"STRING"}},action:function(a){if("caption"in a&&config.saveMode==o2.SAVE_MODE_KAG3){if(currentConductor.macroStack.length)return o2.error("\u30bb\u30fc\u30d6\u30e2\u30fc\u30c9\u304ckag3\u30e2\u30fc\u30c9\u306e\u5834\u5408\u3001\u30e9\u30d9\u30eb\u3092\u30de\u30af\u30ed\u306e\u4e2d\u306b\u7f6e\u3044\u3066\u306f\u3044\u3051\u306a\u3044\u3002"),0;""!=a.caption?saveCurrentState(a.caption):saveCurrentState()}return 0}});
Tag.actions.jump=new TagAction({rules:{storage:{type:"STRING"},target:{type:"STRING"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},disable_clear_stack:{type:"BOOLEAN",defaultValue:!1}},action:function(a){"o2_url"in a&&window.open(a.o2_url,a.o2_urltarget);var b;(b=a.storage?KAGFiles(a.storage):currentConductor.file)||this.error("\u30b7\u30ca\u30ea\u30aa\u30d5\u30a1\u30a4\u30eb "+a.storage+" \u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093");if(a.target){var c=a.target;
"*"==c.charAt(0)&&(c=c.substring(1));(b=b.getLabelTag(c))||this.error("\u30e9\u30d9\u30eb "+c+" \u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093")}else b=b.lines[0];currentConductor.setTag(b);a.disable_clear_stack||(currentConductor.clearIfStack(),currentConductor.clearMacroStack());return 0}});
Tag.actions.call=new TagAction({rules:{storage:{type:"STRING"},target:{type:"STRING"}},action:function(a){a=currentConductor.getNextTag();currentConductor.callStack.push(a);a=this.normalizedArgs();a.disable_clear_stack=!0;a=new Tag("jump",a);currentConductor.stack.push(a);return 0}});
Tag.actions["return"]=new TagAction({rules:{storage:{type:"STRING"},target:{type:"STRING"}},action:function(a){var b=currentConductor.callStack.pop();b||this.error("\u30b5\u30d6\u30eb\u30fc\u30c1\u30f3\u5916\u3067return\u30bf\u30b0\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093");a=this.normalizedArgs();a.disable_clear_stack=!0;a.storage||a.target?(a=new Tag("jump",a),currentConductor.stack.push(a)):currentConductor.setTag(b);return 0}});
Tag.actions.macro=new TagAction({rules:{name:{type:"STRING",required:!0}},action:function(a){var b=new MacroDefinition({name:a.name.toLowerCase(),startTag:currentConductor.getNextTag()});currentConductor.macros[a.name.toLowerCase()]=b;(a=currentConductor.getNextTag("endmacro"))||this.error("endmacro\u30bf\u30b0\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093");currentConductor.setTag(a,!0);return 0}});Tag.actions.endmacro=new TagAction({action:function(){return 0}});
Tag.actions.erasemacro=new TagAction({rules:{name:{type:"STRING",required:!0}},action:function(a){delete currentConductor.macros[a.name];return 0}});Tag.actions.seopt=new TagAction({rules:{buf:{type:"INT",defaultValue:0},volume:{type:"INT"}},action:function(a){o2.se[a.buf].setVolume(a.volume/100);return 0}});
Tag.actions.playse=new TagAction({rules:{buf:{type:"INT",defaultValue:0},storage:{type:"STRING",required:!0},loop:{type:"BOOLEAN",defaultValue:!1},o2_start:{type:"TIME"},o2_block:{type:"BOOLEAN"}},action:function(a){var b=o2.se[a.buf];b.play(a.storage);b.setLoop(a.loop);"o2_start"in a&&b.setTime(a.o2_start);var c=this;return a.o2_block?(b.loadDefer.done(function(){setTimeout(function(){c.done()})}),1):0}});
Tag.actions.stopse=new TagAction({rules:{buf:{type:"INT",defaultValue:0}},action:function(a){o2.se[a.buf].stop();return 0}});Tag.actions.fadese=new TagAction({rules:{buf:{type:"INT",defaultValue:0},volume:{type:"INT",required:!0},time:{type:"INT",required:!0}},action:function(a){o2.se[a.buf].fade({toVolume:a.volume/100,duration:a.time});return 0}});
Tag.actions.fadeinse=new TagAction({rules:{buf:{type:"INT",defaultValue:0},storage:{type:"STRING",required:!0},time:{type:"INT",required:!0},loop:{type:"BOOLEAN",defaultValue:!1},o2_start:{type:"TIME"},o2_volume:{type:"INT"},o2_block:{type:"BOOLEAN",defaultValue:!1}},action:function(a){var b=o2.se[a.buf];b.play(a.storage);b.setLoop(a.loop);"o2_start"in a&&b.setTime(a.o2_start);"o2_volume"in a&&b.setVolume(a.o2_volume/100);b.fade({fromVolume:0,duration:a.time});var c=this;return a.o2_block?(b.loadDefer.done(function(){setTimeout(function(){c.done()})}),
1):0}});Tag.actions.fadeoutse=new TagAction({rules:{buf:{type:"INT",defaultValue:0},time:{type:"INT",required:!0}},action:function(a){var b=o2.se[a.buf];b.fade({toVolume:0,duration:a.time}).done(function(){b.pause()});return 0}});
Tag.actions.wf=new TagAction({rules:{buf:{type:"INT",defaultValue:0},canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(a){var b=this,c=o2.se[a.buf],d=c.fade(),g=!1;if(!d)return 0;if(a.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return c.stopFade(),0;wait("click",function(){g=!0;c.stopFade()})}d.done(function(){g||b.done()});return 1}});
Tag.actions.ws=new TagAction({rules:{buf:{type:"INT",defaultValue:0},canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(a){var b=o2.se[a.buf],c=this,d=!1;if(!b.isPlaying||b.loop)return o2.warn("\u52b9\u679c\u97f3\u306e\u30eb\u30fc\u30d7\u518d\u751f\u4e2d\u306b\u518d\u751f\u7d42\u4e86\u3092\u5f85\u3064\u3053\u3068\u306f\u3067\u304d\u306a\u3044\u305f\u3081\u3001\u3053\u306e\u30bf\u30b0\u306f\u7121\u8996\u3055\u308c\u307e\u3057\u305f"),0;if(a.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return b.stop(),
0;wait("click",function(){d=!0;b.stop()})}$(b).one("ended",function(){d||c.done()});return 1}});Tag.actions.bgmopt=new TagAction({rules:{volume:{type:"INT"}},action:function(a){o2.bgm.setVolume(a.volume/100);return 0}});
Tag.actions.playbgm=new TagAction({rules:{storage:{type:"STRING",required:!0},loop:{type:"BOOLEAN",defaultValue:!0},o2_start:{type:"TIME"},o2_block:{type:"BOOLEAN"}},action:function(a){var b=o2.bgm;b.play(a.storage);b.setLoop(a.loop);"o2_start"in a&&b.setTime(a.o2_start);var c=this;return a.o2_block?(b.loadDefer.done(function(){setTimeout(function(){c.done()})}),1):0}});Tag.actions.pausebgm=new TagAction({action:function(){o2.bgm.pause();return 0}});
Tag.actions.resumebgm=new TagAction({action:function(){o2.bgm.play();return 0}});Tag.actions.stopbgm=new TagAction({action:function(){o2.bgm.stop();return 0}});Tag.actions.fadebgm=new TagAction({rules:{volume:{type:"INT",required:!0},time:{type:"INT",required:!0}},action:function(a){o2.bgm.fade({toVolume:a.volume/100,duration:a.time});return 0}});
Tag.actions.fadeinbgm=new TagAction({rules:{storage:{type:"STRING",required:!0},time:{type:"INT",required:!0},loop:{type:"BOOLEAN",defaultValue:!0},o2_start:{type:"TIME"},o2_volume:{type:"INT"},o2_block:{type:"BOOLEAN",defaultValue:!1}},action:function(a){var b=o2.bgm;b.play(a.storage);b.setLoop(a.loop);"o2_start"in a&&b.setTime(a.o2_start);"o2_volume"in a&&b.setVolume(a.o2_volume/100);b.fade({fromVolume:0,duration:a.time});var c=this;return a.o2_block?(b.loadDefer.done(function(){setTimeout(function(){c.done()})}),
1):0}});Tag.actions.fadeoutbgm=new TagAction({rules:{time:{type:"INT",required:!0}},action:function(a){var b=o2.bgm,c=b.volume;(a=b.fade({toVolume:0,duration:a.time}))&&a.done(function(){b.stop();b.setVolume(c)});return 0}});Tag.actions.fadepausebgm=new TagAction({rules:{time:{type:"INT",required:!0}},action:function(a){var b=o2.bgm;(a=b.fade({toVolume:0,duration:a.time}))&&a.done(function(){b.pause()});return 0}});
Tag.actions.xchgbgm=new TagAction({rules:{storage:{type:"STRING",required:!0},loop:{type:"BOOLEAN",defaultValue:!0},time:{type:"INT",required:!0},overlap:{type:"INT",defaultValue:0},volume:{type:"INT"},o2_start:{type:"TIME"}},action:function(a){var b;b="volume"in a?a.volume/100:o2.bgm.volume;var c=new Sound,d=o2.bgm,g=this;c.setFile(a.storage).done(function(){o2.bgm=c;d.fade({toVolume:0,duration:a.time,id:"old"}).done(function(){d.stop()});setTimeout(function(){c.play();"o2_start"in a&&c.setTime(a.o2_start);
c.fade({fromVolume:0,toVolume:b,duration:a.time})},a.time-a.overlap);g.done()});c.setLoop(a.loop);return 1}});Tag.actions.wb=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(a){var b=this,c=o2.bgm,d=c.fade();if(!d)return 0;if(a.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return c.stopFade(),0;wait("click",function(){c.stopFade()})}d.done(function(){b.done()});return 1}});
Tag.actions.wl=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(a){var b=this,c=o2.bgm;if(!c.isPlaying||c.loop)return o2.warn("\u52b9\u679c\u97f3\u306e\u30eb\u30fc\u30d7\u518d\u751f\u4e2d\u306b\u518d\u751f\u7d42\u4e86\u3092\u5f85\u3064\u3053\u3068\u306f\u3067\u304d\u306a\u3044\u305f\u3081\u3001\u3053\u306e\u30bf\u30b0\u306f\u7121\u8996\u3055\u308c\u307e\u3057\u305f"),0;if(a.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return c.stop(),0;wait("click",function(){c.stop()})}$(c).one("ended",
function(){b.done()});return 1}});
(function(){function a(a){var c=currentConductor.upCommingTags(),d=0;"string"===typeof a&&(a=[a]);for(var g=0;g<c.length;g++){var h=c[g];if(0===d&&-1!==a.indexOf(h.tagName))return h;"if"===h.tagName&&d++;"endif"===h.tagName&&d--}}IfStatus=function(){this.conditionFulfilled=!1};Tag.actions["if"]=Tag.actions.ignore=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},action:function(b){var c=new IfStatus;currentConductor.ifStack.push(c);try{c.conditionFulfilled=eval(b.o2_exp)}catch(d){c.conditionFulfilled=
!1}"ignore"===this.tagName&&(c.conditionFulfilled=!c.conditionFulfilled);c.conditionFulfilled||(b=a(["else","elsif","endif","endignore"]))&&currentConductor.setTag(b);return 0}});Tag.actions["else"]=new TagAction({action:function(){var b=currentConductor.ifStack[currentConductor.ifStack.length-1];if(!b)return 0;b.conditionFulfilled&&(b=a(["endif","endignore"]))&&currentConductor.setTag(b);return 0}});Tag.actions.elsif=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},action:function(b){var c=
currentConductor.ifStack[currentConductor.ifStack.length-1],d=!1;if(!c)return 0;if(c.conditionFulfilled)d=!0;else{var g;try{g=eval(b.o2_exp)}catch(h){g=!1}g?c.conditionFulfilled=!0:d=!0}d&&(b=a(["else","elsif","endif","endignore"]))&&currentConductor.setTag(b);return 0}});Tag.actions.endif=Tag.actions.endignore=new TagAction({action:function(){currentConductor.ifStack.pop();return 0}})})();
Tag.actions.wait=new TagAction({rules:{time:{type:"INT",required:!0},mode:{type:/normal|until/,defaultValue:"normal"},canskip:{type:"BOOLEAN",defaultValue:!0}},action:function(a){var b=this,c=setTimeout(function(){b.done()},a.time);if(a.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return clearTimeout(c),0;wait("click",function(){clearTimeout(c)})}return 1}});Tag.actions.waitclick=new TagAction({action:function(){wait("click",function(){o2.skipMode=o2.SKIP_MODE_NONE});return 1}});
Tag.actions.cancelskip=new TagAction({action:function(){o2.skipMode=o2.SKIP_MODE_NONE;return 0}});Tag.actions.clickskip=new TagAction({rules:{enabled:{type:"BOOLEAN",required:!0}},action:function(a){o2.clickSkipEnabled=a.enabled;return 0}});Tag.actions.eval=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},action:function(a){eval(a.o2_exp);return 0}});Tag.actions.o2_iscript=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},action:function(a){eval(a.o2_exp);return 0}});
$(function(){function a(){c=[];for(var a=o2.autoHideLayers(),b=0;b<a.length;b++){var d=a[b];c.push(d.visible);d.visible=!1}renderer.animator.requestFrame();glyph.hide()}var b={call:!1,jump:!1,target:void 0,storage:void 0,enabled:!0},c=void 0;$(o2).on("rclick",function(){if(-1!=["p","l","s"].indexOf(currentConductor.currentTag.tagName)&&b.enabled&&!c)if(b.call){extraConductor.setFile(conductor.file);currentConductor=extraConductor;var g=new Tag("jump",b);extraConductor.stack.push(g)}else b.jump?(g=
new Tag("jump",b),currentConductor.stack.push(g)):(a(),$(o2).bindFirst("click",d),$(o2).bindFirst("rclick",d))});var d=function(a){a.stopImmediatePropagation();if(c){for(var a=o2.autoHideLayers(),b=0;b<a.length;b++)a[b].visible=c[b];renderer.animator.requestFrame();c=void 0;glyph.show()}$(o2).off("click",d);$(o2).off("rclick",d)};Tag.actions.rclick=new TagAction({rules:{call:{type:"BOOLEAN"},jump:{type:"BOOLEAN"},target:{type:"STRING"},storage:{type:"STRING"},enabled:{type:"BOOLEAN"}},action:function(a){if("call"in
a&&!0===a.call&&"jump"in a&&!0===a.jump)return this.error("call\u5c5e\u6027\u3068jump\u5c5e\u6027\u306e\u4e21\u65b9\u306btrue\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093"),0;for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return 0}});Tag.actions.hidemessage=new TagAction({action:function(){a();var b=this;$(o2).bindFirst("click",d);$(o2).bindFirst("click",function j(){setTimeout(function(){b.done()});$(o2).off("click",j)});return 1}})});
(function(){var a=void 0;Tag.actions.o2_request=new TagAction({rules:{method:{type:/get|post/i,required:!0},url:{type:"STRING",required:!0},req:{type:"STRING",required:!0},"return":{type:"STRING",defaultValue:"req"}},action:function(b){a=$.ajax({url:b.url,type:b.method,data:b.req}).done(function(c,d,g){ev[b["return"]]={stat:g.status+" "+g.statusText,head:g.getAllResponseHeaders(),body:c};a=void 0});return 0}});Tag.actions.o2_wr=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!1},timeout:{type:"INT"}},
action:function(b){function c(){g||(d.done(),g=!0)}if(!a)return 0;var d=this,g=!1;a.done(function(){setTimeout(c)});"timeout"in b&&setTimeout(c,b.timeout);b.canskip&&o2.clickSkipEnabled&&wait("click",function(){g=!0});return 1}})})();
function setupEventHandlers(){var a=!1;o2.skipKeyPressing=function(){return a};$("body").on("touchend",function(){window.scrollTo(0,0);scaleToFitPage()});$(o2).on("click",function(){glyph.hide();currentConductor.trigger("click")});$("body").on("touchstart touchmove touchcancel touchend mousemove mouseup mousedown",function(a){var b=a.type;if("touchmove"==b||"touchstart"==b)b="mousemove";else if("touchend"==b||"touchcancel"==b)b="mouseup";if(!o2.historyLayer.visible||!o2.historyLayer[b]||!o2.historyLayer[b](a)){for(var c=
o2.foreLayers.messageLayers.length-1;0<=c;c--){var d=o2.foreLayers.messageLayers[c];if(d[b]&&d[b](a)){a.stopImmediatePropagation();o2.setCursorStyle("pointer");return}}o2.setCursorStyle("default")}});$("body").on("mouseup",function(a){3==a.which?o2.historyLayer.visible?o2.historyLayer.hide():$(o2).trigger("rclick"):o2.historyLayer.visible||$(o2).trigger("click")});$("body").on("keydown",function(b){if("keyCode"in b)switch(b.keyCode){case 37:o2.historyLayer.scrolled({x:-30,y:0});break;case 38:o2.historyLayer.scrolled({x:0,
y:30});break;case 39:o2.historyLayer.scrolled({x:30,y:0});break;case 40:o2.historyLayer.visible&&o2.historyLayer.scrolled({x:0,y:-30});break;case 13:o2.historyLayer.visible||$(o2).trigger("click");break;case 17:if(a=!0,o2.skipMode!=o2.SKIP_MODE_FAST_FORWARD&&(o2.skipMode=o2.SKIP_MODE_FAST_FORWARD,!trigger("click")&&currentConductor.status!=Conductor.STATUS_STOP&&0==Object.keys(currentConductor.waitTag).length))currentConductor.oneShot()}});$("body").on("keyup",function(b){if("keyCode"in b)switch(b.keyCode){case 17:a=
!1}});$("body").on("mousewheel DOMMouseScroll wheel",function(a){a.preventDefault();a=wheelDistance(a.originalEvent);o2.historyLayer.scrolled(a)});var b=!1,c,d;$("body").on("touchstart touchmove touchend touchcancel",function(a){var h=a.originalEvent,j=h.normalizedCoordinate();a.preventDefault();if(b){if(d=c=void 0,("touchend"==a.type||"touchcancel"==a.type)&&0==h.touches.length)b=!1}else{"touchstart"==a.type&&(c||(c=j),d=j);if("touchmove"==a.type){var i=j.x-c.x,n=j.y-c.y,p;p=d?{x:j.x-d.x,y:j.y-d.y}:
{x:0,y:0};var k=!1;20>Math.abs(i)&&100<Math.abs(n)?0<n&&!o2.historyLayer.visible&&(o2.historyLayer.touchmoved({x:0,y:30}),b=k=!0):100<Math.abs(i)&&20>Math.abs(n)&&(0>i&&!o2.historyLayer.visible)&&(o2.historyLayer.touchmoved({x:-30,y:0}),b=k=!0);o2.historyLayer.visible&&!k&&(o2.historyLayer.touchmoved(p),o2.historyLayer.animating&&(b=!0));d=j}if("touchend"==a.type||"touchcancel"==a.type)1==h.changedTouches.length&&0==h.touches.length?(d=c=void 0,1==h.changedTouches.length&&(o2.historyLayer.visible||
$(o2).trigger("click"))):2==h.changedTouches.length+h.touches.length&&(o2.historyLayer.visible?o2.historyLayer.hide():($(o2).trigger("rclick"),h.touches.length&&(b=!0)))}});$("body").on("contextmenu",function(a){a.preventDefault()})}HistoryRecorder=function(){this.options={enabled:!0,output:!0};this.layer;this.historyPages=[];this.lineCount=this.pageCount=this.currentPage=0};HistoryRecorder.prototype.init=function(){};
HistoryRecorder.prototype.objectToBeSerialized=function(a){switch(a){case "layer":return}return!config.historyLayerStoreState&&"historyPages"==a?void 0:this[a]};HistoryRecorder.prototype.importFromSaveData=function(a){this.historyPages=[];Object.prototype.importFromSaveData.call(this,a)};
HistoryRecorder.prototype.add=function(a,b){this.options.output&&("pagebreak"==a?this.addPage():(this.historyPages.length||this.addPage(),this.historyPages[this.historyPages.length-1].push({type:a,data:b}),this.lineCount++,this.ensureHistoryLimit()))};HistoryRecorder.prototype.addPage=function(){if(this.options.output){var a=this.historyPages.length-1;this.historyPages[a]&&0==this.historyPages[a].length||(this.pageCount++,this.historyPages.push([]),this.ensureHistoryLimit())}};
HistoryRecorder.prototype.ensureHistoryLimit=function(){var a=config.historyLayerMaxLines||1E3;this.historyPages.length>(config.historyLayerMaxPages||100)&&this.historyPages.shift();this.lineCount>a&&this.historyPages[0].shift()};
HistoryRecorder.prototype.childrenForPage=function(a){var a=this.historyPages[a],b=[];if(!a)return[];for(var c=0;c<a.length;c++){var d=a[c],g=HistoryLayer.historyDataRenderer[d.type];"function"==typeof g&&(d=g.call(this.layer,d.data,b),d instanceof Array?b=b.concat(d):void 0!==d&&b.push(d))}return b};HistoryRecorder.prototype.childrenForCurrentPage=function(){return this.childrenForPage(this.currentPage)};
HistoryRecorder.prototype.childrenForAllPages=function(){for(var a=[],b=0;b<this.historyPages.length;b++)a=a.concat(this.childrenForPage(b));return a};HistoryRecorder.prototype.prevPage=function(){if(!config.historyLayerEverypage)return!1;if(0>=this.currentPage)return this.currentPage=0,!1;this.currentPage--;return!0};HistoryRecorder.prototype.nextPage=function(){if(this.currentPage>=this.historyPages.length-1)return!1;this.currentPage++;return!0};
HistoryRecorder.prototype.resetCurrentPage=function(){this.currentPage=this.historyPages.length-1};HistoryLayer=function(){MessageLayer.call(this);this.frameSolid.opacity=0.5;this.visible=!1;this.font.shadow=!1;this.font.edge=!1;this.font.size=36;this.recorder=new HistoryRecorder;this.recorder.layer=this;this.contentOffset={x:0,y:0};this.animating=!1;this.contentHeight=this.contentWidth=0};HistoryLayer.prototype=Object.create(MessageLayer.prototype);
HistoryLayer.prototype.init=function(){var a=this;this.defaultFont.size=config.historyLayerFontHeight;this.defaultFont.face=config.historyLayerFontFace;this.defaultFont.color=config.historyLayerFontColor;this.defaultFont.shadow=config.historyLayerShadow;this.defaultFont.shadowColor=config.historyLayerShadowColor;this.defaultFont.shadowBlur=config.historyLayerShadowBlur;this.defaultFont.shadowOffsetX=config.historyLayerShadowOffsetX;this.defaultFont.shadowOffsetY=config.historyLayerShadowOffsetY;this.defaultFont.bold=
config.historyLayerFontBold;this.font=clone(this.defaultFont);this.style.lineSize=config.historyLayerLineHeight;this.style.lineSpacing=0;this.frameSolid.color=config.historyLayerColor;this.frameSolid.opacity=config.historyLayerOpacity;config.historyLayerFrame&&ResourceLoader.loadImage(config.historyLayerFrame,!1).done(function(b){a.frameImage=new DrawableImage(b,0,0)});this.margin={top:config.historyLayerMarginT,right:config.historyLayerMarginR,bottom:config.historyLayerMarginB,left:config.historyLayerMarginL};
setTimeout(function(){a.setRect({x:config.historyLayerCurrentPositionX,y:config.historyLayerCurrentPositionY,width:config.historyLayerCurrentWidth,height:config.historyLayerCurrentHeight})});this.recorder.init();this.resetCursor();this.originalGlyphShown=!1};
HistoryLayer.prototype.objectToBeSerialized=function(a){switch(a){case "animating":case "textsProperties":case "buttons":case "links":case "images":case "contentWidth":case "contentHeight":return;case "recorder":case "contentOffset":return this[a]}return MessageLayer.prototype.objectToBeSerialized.call(this,a)};HistoryLayer.prototype.drawOnContext=function(){Layer.prototype.drawOnContext.apply(this,arguments)};
HistoryLayer.prototype.reloadVertical=function(){this.vertical="auto"==config.historyLayerVertical?o2.currentMessageLayer.vertical:"true"==config.historyLayerVertical||!0==config.historyLayerVertical?!0:!1};
HistoryLayer.historyDataRenderer={text:function(a){for(var b=[],c=0;c<a.length;c++){var d=new TextProperties(a[c]);$.extend(d.styles,clone(o2.currentMessageLayer.font));b.push(d)}d=new MessageLayer.textCustomizers.baseTextCustomizer(b,this,b.length);d.timePassed=Infinity;a=[];for(c=b.length-1;0<=c;c--)b=d.textProperties(c),a.unshift(b);c=a[a.length-1];this.textCursor=this.vertical?{x:c.rect.x+c.rect.width+(this.lastLineSize-c.rect.width)/2,y:c.rect.y+c.rect.height}:{x:c.rect.x+c.rect.width,y:c.rect.y+
c.rect.height-this.lastLineSize};return a},linebreak:function(){this.linebreak()}};HistoryLayer.prototype.refreshButtons=function(a,b){a-=this.contentOffset.x;b+=this.contentOffset.y;MessageLayer.prototype.refreshButtons.call(this,a,b)};HistoryLayer.prototype.refreshLinks=function(a,b){a-=this.contentOffset.x;b+=this.contentOffset.y;MessageLayer.prototype.refreshLinks.call(this,a,b)};
HistoryLayer.prototype.mouseup=function(a){if(!this.visible)return!1;a=a.originalEvent.normalizedCoordinate(this);a.x-=this.contentOffset.x;a.y+=this.contentOffset.y;for(var b=this.buttons.length-1;0<=b;b--){var c=this.buttons[b];if(c.rect.coverCoordinate(a.x,a.y))return c.click(),!0}for(b=this.links.length-1;0<=b;b--)if(c=this.links[b],c.isHovering(a.x,a.y))return c.click(),!0};HistoryLayer.prototype.touchmoved=function(a){this.vertical?this.scrolled({x:a.x,y:0}):this.scrolled({x:0,y:a.y})};
HistoryLayer.prototype.scrolled=function(a){if(!this.animating){this.reloadVertical();if(this.vertical){this.contentOffset.x+=a.x;this.contentOffset.x-=a.y;if(!this.visible&&0>a.x-a.y){this.recorder.resetCurrentPage();this.render();this.scrollToPageEnd();this.show("left");this.originalGlyphShown=glyph.isShown();glyph.hide();return}if(this.visible){if(-20>=this.contentOffset.x&&(this.contentOffset.x=-20,this.prevPage("left")))return;this.contentOffset.x>this.margin.left+this.margin.right+this.contentWidth-
this.rect.width+20&&this.nextPage("right")}}else{this.contentOffset.y-=a.y;if(!this.visible&&0<a.y){this.recorder.resetCurrentPage();this.render();this.scrollToPageEnd();this.show("down");return}if(this.visible){if(0>this.contentOffset.y){this.contentOffset.y=0;this.prevPage();return}this.contentHeight-this.contentOffset.y<this.rect.height-this.margin.top-this.margin.bottom&&this.nextPage()}}this.redrawRect()}};
HistoryLayer.prototype.scrollToPageEnd=function(){this.vertical?this.contentOffset.x=this.margin.left+this.margin.right+this.contentWidth-this.rect.width:this.contentOffset.y=this.contentHeight-this.rect.height+this.margin.top+this.margin.bottom;this.redrawRect()};
HistoryLayer.prototype.show=function(a){this.reloadVertical();var b=$.Deferred();if(this.animating||!this.recorder.options.enabled||!this.recorder.historyPages.length)return b.fail(),b.promise();this.visible=this.animating=!0;this.opacity=0;var c=this,d=Date.now(),g=config.historyLayerCurrentPositionX,h=config.historyLayerCurrentPositionY,j=0,i=300;switch(a){case "left":j=300;i=0;break;case "right":j=-300;i=0;break;case "down":i=-300}var n=new KeySpline(0.08,0.44,0.42,0.93);renderer.animator.requestFrame(function k(){var a=
(Date.now()-d)/500;1<=a?(a=1,c.animating=!1,b.resolve()):renderer.animator.requestFrame(k);a=n.get(a);c.opacity=a;c.rect.x=g+j*(1-a);c.rect.y=h+i*(1-a)});this.redrawRect();return b.promise()};
HistoryLayer.prototype.hide=function(a){this.animating=!0;var b=this,c=Date.now(),d=this.rect.x,g=this.rect.y,h=this.vertical?300:0,j=this.vertical?0:-300;switch(a){case "left":h=-300;j=0;break;case "right":h=300;j=0;break;case "down":j=300}var i=$.Deferred(),n=new KeySpline(0.45,0,0.97,0.65);renderer.animator.requestFrame(function k(){var a=(Date.now()-c)/500;1<=a?(b.animating=!1,b.visible=!1,b.textsProperties=[],b.links=[],b.buttons=[],i.resolve(),b.rect.x=d,b.rect.y=g,b.opacity=0):(renderer.animator.requestFrame(k),
a=n.get(a),b.opacity=1-a,b.rect.x=d+h*a,b.rect.y=g+j*a)});this.redrawRect();return i.promise()};HistoryLayer.prototype.prevPage=function(a){var b=this;a||(a="down");return this.recorder.prevPage()?(this.hide(a).done(function(){b.render();b.scrollToPageEnd();b.show(a)}),!0):!1};
HistoryLayer.prototype.nextPage=function(a){a||(a="up");if(this.recorder.nextPage()){var b=this;this.hide(a).done(function(){b.render();b.contentOffset.x=0;b.contentOffset.y=0;b.show(a)});return!0}this.hide(a);this.originalGlyphShown&&glyph.show();return!1};
HistoryLayer.prototype.render=function(){this.textsProperties=[];this.links=[];this.buttons=[];var a;a=config.historyLayerEverypage?this.recorder.childrenForCurrentPage():this.recorder.childrenForAllPages();for(var b=0;b<a.length;b++){var c=a[b];c instanceof Drawable&&(c instanceof TextProperties?this.textsProperties.push(c):c instanceof Link?this.links.push(c):c instanceof Button&&this.buttons.push(c))}this.vertical?(this.contentWidth=this.rect.width-this.margin.right-this.textCursor.x,this.contentHeight=
this.rect.height-this.margin.top-this.margin.bottom):(this.contentWidth=this.rect.width-this.margin.left-this.margin.right,this.contentHeight=this.textCursor.y+this.font.size-this.margin.top);this.contentWidth=Math.max(this.contentWidth,this.rect.width-this.margin.left-this.margin.right);this.contentHeight=Math.max(this.contentHeight,this.rect.height-this.margin.top-this.margin.bottom)};
HistoryLayer.prototype.flush=function(){if(this.requestedFrame){this.requestedFrame=!1;this.stackedClearRect=new Rect;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.frameImage?this.frameImage.drawOnContext(this.ctx):this.frameSolid.drawOnContext(this.ctx);var a=new Rect({x:this.margin.left-this.contentOffset.x,y:this.margin.top+this.contentOffset.y,width:this.rect.width-this.margin.left-this.margin.right,height:this.rect.height-this.margin.top-this.margin.bottom}),b=this.children(),
c=b.indexOf(this.frameImage);-1!=c&&b.splice(c,1);c=b.indexOf(this.frameSolid);-1!=c&&b.splice(c,1);this.ctx.save();this.ctx.beginPath();this.ctx.rect(this.margin.left,this.margin.top,this.rect.width-this.margin.left-this.margin.right,this.rect.height-this.margin.top-this.margin.bottom);this.ctx.clip();for(c=b.length-1;0<=c;c--){var d=b[c];d.rect.intersect(a)&&(d.rect.x+=this.contentOffset.x,d.rect.y-=this.contentOffset.y,d instanceof Link&&(this.ctx.save(),this.ctx.translate(this.contentOffset.x,
-this.contentOffset.y)),d.drawOnContext(this.ctx),d instanceof Link&&this.ctx.restore(),d.rect.x-=this.contentOffset.x,d.rect.y+=this.contentOffset.y)}this.ctx.restore();this.resetCursor()}};Tag.actions.history=new TagAction({rules:{output:{type:"BOOLEAN"},enabled:{type:"BOOLEAN"}},action:function(a){"output"in a&&(o2.historyLayer.recorder.options.output=a.output);"enabled"in a&&(o2.historyLayer.recorder.options.enabled=a.enabled);return 0}});
Tag.actions.hr=new TagAction({rules:{repage:{type:"BOOLEAN",defaultValue:!1}},action:function(a){o2.historyLayer.recorder.options.repage?a.repage?o2.historyLayer.recorder.addPage():o2.historyLayer.recorder.add("linebreak"):o2.historyLayer.recorder.add("linebreak");return 0}});Tag.actions.showhistory=new TagAction({action:function(){o2.historyLayer.show();return 1}});
(function(){var a=0,b={};Tag.actions.hact=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},action:function(a){o2.historyLayer.recorder.add("hact",a);return 0}});Tag.actions.endhact=new TagAction({action:function(){o2.historyLayer.recorder.add("endhact");return 0}});HistoryLayer.historyDataRenderer.hact=function(c,d){a=d.length;b=c};HistoryLayer.historyDataRenderer.endhact=function(c,d){var g=new KAGLink;g.color="#aaaaaa";g.vertical=o2.historyLayer.vertical;(function(a){g.click=function(){"o2_exp"in
a&&eval(a.o2_exp)}})(b);for(var h=a;h<d.length;h++)g.addTextProperties(d[h]);return g}})();var Video=function(){this.element=document.createElement("video");this.element.setAttribute("webkit-playsinline",!0);this.filepath;this.rect=new Rect(0,0,320,240);this.loop=!1;this.outputs=[];this.volume=1;this.mode=Video.MODE_OVERLAY;this.loadDefer};
Video.prototype.toJSON=function(){return{rect:this.rect,loop:this.loop,outputs:this.outputs,volume:this.volume,mode:this.mode,currentTime:this.element.currentTime,paused:this.paused(),filepath:this.filepath}};
Video.prototype.importFromSaveData=function(a){var b=$.Deferred();a.filepath&&(this.setFile(a.filepath),delete a.filepath);"paused"in a&&(a.paused?this.pause():this.play());"currentTime"in a&&this.setTime(1E3*a.currentTime);b.resolve();this.mode=a.mode;this.setVolume(a.volume);this.setLoop(a.loop);this.setRect(a.rect);return b.promise()};Video.MODE_OVERLAY=0;Video.MODE_LAYER=1;Video.canPlayInline=function(){var a=null!=navigator.userAgent.match(/iPad/i);return browser.isIOs&&!a?!1:!0}();
Video.prototype.setFile=function(a){if(Video.canPlayInline){this.filepath=a;var b=this;return this.loadDefer=ResourceLoader.loadVideo(a,!0,this.element).done(function(a){b.setLoop();b.setRect();$(a).on("ended",function(){$(b).trigger("ended")})})}};Video.prototype.setVisible=function(a){if(Video.canPlayInline){var b=document.getElementsByClassName("video-wrapper")[0],c=!!this.element.parentNode;c&&!a?b.removeChild(this.element):!c&&a&&b.appendChild(this.element)}};
Video.prototype.setRect=function(a){a&&(this.rect=a);var b=this;this.loadDefer&&this.loadDefer.done(function(a){a.style.marginLeft=b.rect.x+"px";a.style.marginTop=b.rect.y+"px";a.width=b.rect.width;a.height=b.rect.height})};Video.prototype.setLoop=function(a){void 0!==a&&(this.loop=a);if(this.loadDefer){var b=this;this.loadDefer.done(function(a){a.loop=b.loop})}};Video.prototype.setPlaybackRate=function(a){this.loadDefer&&this.loadDefer.done(function(b){b.playbackRate=a})};
Video.prototype.setVolume=function(a){void 0!==a&&(this.volume=a);if(this.loadDefer){var b=this;this.loadDefer.done(function(a){a.volume=b.volume})}};Video.prototype.play=function(a){a&&this.setFile(a);this.element.play()};Video.prototype.pause=function(){this.element.pause()};Video.prototype.paused=function(){return!this.element||!this.loadDefer?!0:this.element.paused};Video.prototype.stop=function(){this.pause();this.setTime(0)};
Video.prototype.setTime=function(a){this.loadDefer&&this.loadDefer.done(function(b){try{b.currentTime=a/1E3}catch(c){$(b).one("loadedmetadata",function(){b.currentTime=a/1E3})}})};Video.prototype.dummyLoad=function(){this.element.src="x";this.element.load()};
Tag.actions.video=new TagAction({rules:{slot:{type:"INT",defaultValue:0},visible:{type:"BOOLEAN"},left:{type:"INT"},top:{type:"INT"},width:{type:"INT"},height:{type:"INT"},loop:{type:"BOOLEAN"},position:{type:"INT"},frame:{type:"INT"},mode:{type:/overlay|layer/i},playrate:{type:"FLOAT"},volume:{type:"FLOAT"}},action:function(a){var b=o2.videos[a.slot];if(!b)return this.error("\u30d3\u30c7\u30aa\u30b9\u30ed\u30c3\u30c8 "+a.slot+" \u304c\u5b58\u5728\u3057\u307e\u305b\u3093"),0;"visible"in a&&b.setVisible(a.visible);
var c=!1;"left"in a&&(b.rect.x=a.left,c=!0);"top"in a&&(b.rect.y=a.top,c=!0);"width"in a&&(b.rect.width=a.width,c=!0);"height"in a&&(b.rect.height=a.height,c=!0);c&&b.setRect();"loop"in a&&b.setLoop(a.loop);"position"in a&&b.setTime(a.position);"mode"in a&&("layer"==a.mode?b.setMode(Video.MODE_LAYER):b.setMode(Video.MODE_OVERLAY));"playrate"in a&&b.setPlaybackRate(a.playrate);"volume"in a&&b.setVolume(a.volume/100);return 0}});
Tag.actions.videolayer=new TagAction({rules:{slot:{type:"INT",defaultValue:0},channel:{type:/1|2/,required:!0},page:{type:/fore|back/,required:!0},layer:{type:"LAYER",required:!0}},action:function(a){var b=o2.videos[a.slot];if(!b)return this.error("\u30d3\u30c7\u30aa\u30b9\u30ed\u30c3\u30c8 "+a.slot+" \u304c\u5b58\u5728\u3057\u307e\u305b\u3093"),0;b.outputs[a.channel]=a.layer[a.page];return 0}});
Tag.actions.openvideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0},storage:{type:"STRING",required:!0}},action:function(a){var b=o2.videos[a.slot];if(!b)return this.error("\u30d3\u30c7\u30aa\u30b9\u30ed\u30c3\u30c8 "+a.slot+" \u304c\u5b58\u5728\u3057\u307e\u305b\u3093"),0;try{b.setFile(a.storage)}catch(c){this.error(c)}return 0}});
Tag.actions.preparevideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(){var a=this;renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){a.done()})});return 1}});Tag.actions.playvideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0},storage:{type:"STRING"}},action:function(a){var b=o2.videos[a.slot];if(!b)return this.error("\u30d3\u30c7\u30aa\u30b9\u30ed\u30c3\u30c8 "+a.slot+" \u304c\u5b58\u5728\u3057\u307e\u305b\u3093"),0;try{b.play(a.storage)}catch(c){this.error(c)}return 0}});
Tag.actions.pausevideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(a){var b=o2.videos[a.slot];if(!b)return this.error("\u30d3\u30c7\u30aa\u30b9\u30ed\u30c3\u30c8 "+a.slot+" \u304c\u5b58\u5728\u3057\u307e\u305b\u3093"),0;b.pause();return 0}});
Tag.actions.resumevideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(a){var b=o2.videos[a.slot];if(!b)return this.error("\u30d3\u30c7\u30aa\u30b9\u30ed\u30c3\u30c8 "+a.slot+" \u304c\u5b58\u5728\u3057\u307e\u305b\u3093"),0;b.play();return 0}});
Tag.actions.stopvideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(a){var b=o2.videos[a.slot];if(!b)return this.error("\u30d3\u30c7\u30aa\u30b9\u30ed\u30c3\u30c8 "+a.slot+" \u304c\u5b58\u5728\u3057\u307e\u305b\u3093"),0;b.stop();return 0}});
Tag.actions.rewindvideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(a){var b=o2.videos[a.slot];if(!b)return this.error("\u30d3\u30c7\u30aa\u30b9\u30ed\u30c3\u30c8 "+a.slot+" \u304c\u5b58\u5728\u3057\u307e\u305b\u3093"),0;b.setTime(0);return 0}});
Tag.actions.wv=new TagAction({rules:{slot:{type:"INT",defaultValue:0},canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(a){var b=o2.videos[a.slot];if(!b)return this.error("\u30d3\u30c7\u30aa\u30b9\u30ed\u30c3\u30c8 "+a.slot+" \u304c\u5b58\u5728\u3057\u307e\u305b\u3093"),0;if(b.paused())return 0;if(a.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return b.stop(),0;wait("click",function(){b.stop()})}var c=this;$(b).on("ended",function(){c.done()});return 1}});
Object.defineProperty(Object.prototype,"objectToBeSerialized",{enumerable:!1,writable:!0,value:function(a){return this[a]}});Object.defineProperty(Object.prototype,"toJSON",{enumerable:!1,writable:!0,value:function(){var a=this instanceof Array?[]:{},b;for(b in this){var c=this.objectToBeSerialized(b);void 0!==c&&"function"!=typeof c&&(a[b]=c)}return a}});var saveStack=[],holdingDefers=[];
Object.defineProperty(Object.prototype,"importFromSaveData",{enumerable:!1,writable:!0,value:function(a){var b=[],c=this,d;for(d in a)(function(d){var h=c[d],j=a[d];saveStack.push(d);o2.log(saveStack.join(">"));if("object"==typeof h){var i=h.importFromSaveData(j);i&&(i.stackName=saveStack.join(">"),b.push(i),holdingDefers.push(i),i.done(function(){holdingDefers.splice(holdingDefers.indexOf(i,1))}))}else h=!1,j.initializer&&(h=!0,b.push($.when(j.restore()).done(function(a){c[d]=a}))),h||(c[d]=j);saveStack.pop()})(d);
return $.when.apply($,b).then(function(){return c})}});Object.defineProperty(Object.prototype,"restore",{enumerable:!1,writable:!0,value:function(){return"function"===typeof window[this.initializer]?window[this.initializer].restore!=Object.prototype.restore?window[this.initializer].restore(this):(new window[this.initializer]).importFromSaveData(this):this}});
(function(){function a(b,c){for(var d in b)"object"!=typeof b[d]||void 0==c[d]?c[d]=b[d]:a(b[d],c[d]);return c}var b,c,d=0,g=null;$(function(){$(o2).on("init",function(){$([conductor,extraConductor]).on("ran",function(a,b){0!=b&&saveCurrentSystemState()});if(o2.serverStat.mode==o2.SERVER_MODE_O2SERVER)$(o2).on("systeminit.loggedin",loadSystemStateFromServer);else o2.serverStat.mode==o2.SERVER_MODE_STANDALONE&&loadSystemStateFromServer()})});window.loadSystemStateFromServer=function(){var b=$.Deferred();
if(o2.serverStat.mode==o2.SERVER_MODE_STANDALONE){var d=localStorage.getItem(config.gameID+"_sf");d&&(d=JSON.parse(d),window.sf=a(d,sf));for(var d=Object.keys(localStorage),g=RegExp(config.gameID+"_([0-9]+)"),h=null,j=0;j<d.length;j++)if((h=d[j].match(g))&&d[j]+"_date"in localStorage&&d[j]+"_caption"in localStorage)ev.save.date[h[1]]=new Date(1E3*localStorage.getItem(d[j]+"_date")),ev.save.caption[h[1]]=localStorage.getItem(d[j]+"_caption");b.resolve()}else{if(-1==o2.serverStat.uid)return b.reject();
c=!0;$.post("/api/1.1/globaldata/load.php",{novel:config.gameID,key:o2.serverStat.skey,uid:o2.serverStat.uid}).done(function(d){"string"==typeof d&&(d=JSON.parse(d));if("sysvars"in d)if("object"==typeof d.sysvars&&!(d.sysvars instanceof Array))window.sf=a(d.sysvars,sf);else if("string"==typeof d.sysvars)try{window.sf=a(JSON.parse(d.sysvars),sf)}catch(g){}if("sindex"in d)for(var h=0;h<d.sindex.length;h++){var j=d.sindex[h];ev.save.date[j.save_id]=new Date(1E3*j.updated_at);ev.save.caption[j.save_id]=
j.caption}c=!1;b.resolve()}).fail(function(){b.reject()})}return b.promise()};window.saveCurrentSystemState=function(){var a=$.Deferred(),h;try{h=JSON.stringify(window.sf)}catch(j){o2.error("\u30b7\u30b9\u30c6\u30e0\u5909\u6570\u3092\u4fdd\u5b58\u3067\u304d\u306a\u3044\u3002")}if(b==h)return a.reject();if(o2.serverStat.mode==o2.SERVER_MODE_STANDALONE||o2.serverStat.mode==o2.SERVER_MODE_O2SERVER&&-1!=o2.serverStat.uid&&!c){b=h;if(o2.serverStat.mode==o2.SERVER_MODE_STANDALONE)return localStorage.setItem(config.gameID+
"_sf",h),a.resolve();var k=function(){$.post("/api/1.1/globaldata/save.php",{sysvars:h,novel:config.gameID,key:o2.serverStat.skey,uid:o2.serverStat.uid}).done(function(){a.resolve()}).fail(function(){a.reject()})};1E4<Date.now()-d?(k(),d=Date.now()):g||(g=setTimeout(function(){k();g=null;d=Date.now()},d+1E4-Date.now()))}else a.reject();return a.promise()};var h=void 0,j="";window.saveCurrentState=function(a){window.serializeLog="";h=JSON.stringify({o2:o2,f:f,mp:mp,conductor:conductor},function(a,
b){if("nodeName"==a)debugger;serializeLog+=a+":"+b+",";var c=Object.prototype.toString.apply(b);if(/\[object HTML[A-Za-z]*Element\]/.test(c))debugger;else if("function"==typeof b)debugger;else return b});void 0!=a&&(j=a)};Tag.actions.save=new TagAction({rules:{place:{type:"INT",defaultValue:0},ask:{type:"BOOLEAN",defaultValue:!1}},action:function(a){if(void 0==h)return config.saveMode==o2.SAVE_MODE_KAG3?o2.warn("\u4e00\u5ea6\u3082\u30bb\u30fc\u30d6\u53ef\u80fd\u306a\u30e9\u30d9\u30eb\u3092\u901a\u904e\u3057\u3066\u3044\u306a\u3044\u72b6\u614b\u3067\u30bb\u30fc\u30d6\u3092\u884c\u304a\u3046\u3068\u3057\u307e\u3057\u305f"):
config.saveMode==o2.SAVE_MODE_O2KAG&&o2.warn("\u4e00\u5ea6\u3082 o2_savestat \u30bf\u30b0\u304c\u5b9f\u884c\u3055\u308c\u3066\u3044\u306a\u3044\u72b6\u614b\u3067\u30bb\u30fc\u30d6\u3092\u884c\u304a\u3046\u3068\u3057\u307e\u3057\u305f"),0;if(a.ask&&!confirm("\u672c\u5f53\u306b\u30bb\u30fc\u30d6\u3057\u307e\u3059\u304b\uff1f"))return 0;ev.save.date[a.place]=new Date;ev.save.caption[a.place]=j;if(o2.serverStat.mode==o2.SERVER_MODE_STANDALONE){var b=config.gameID+"_"+a.place,c=b+"_caption",d=b+"_date";
localStorage.setItem(b,h);localStorage.setItem(c,j);localStorage.setItem(d,Date.now()/1E3);return 0}var g=this;$.when(Renderer.askForLogin()).done(function(){$.post("/api/1.1/savedata/save.php",{uid:o2.serverStat.uid,novel:config.gameID,sindex:a.place,data:h,key:o2.serverStat.skey,screen:"1",caption:j}).done(function(){g.done()})}).fail(function(){g.done()});return 1}});Tag.actions.o2_savestat=new TagAction({rules:{caption:{type:"STRING"}},action:function(a){if(config.saveMode==o2.SAVE_MODE_KAG3)return this.warn("\u30bb\u30fc\u30d6\u30e2\u30fc\u30c9\u304cKAG3\u30e2\u30fc\u30c9\u306e\u6642\u306bo2_savestat\u30bf\u30b0\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093"),
0;saveCurrentState(a.caption);return 0}});Tag.actions.load=new TagAction({rules:{place:{type:"INT",defaultValue:0},ask:{type:"BOOLEAN",defaultValue:!1}},action:function(a){if(a.ask&&!confirm("\u672c\u5f53\u306b\u30ed\u30fc\u30c9\u3057\u307e\u3059\u304b\uff1f"))return 0;var b=this,c;c=o2.serverStat.mode==o2.SERVER_MODE_STANDALONE?localStorage.getItem(config.gameID+"_"+a.place):Renderer.askForLogin().then(function(){return $.post("/api/1.1/savedata/load.php",{uid:o2.serverStat.uid,novel:config.gameID,
sindex:a.place,key:o2.serverStat.skey})}).then(function(a){"string"==typeof a&&(a=JSON.parse(a));return a.data}).fail(function(){b.done()});$.when(c).done(function(a){a=JSON.parse(a);window.importFromSaveData(a).done(function(){o2.allLayers().forEach(function(a){a.redrawRect()})}).done(function(){setTimeout(function(){currentConductor!=conductor&&currentConductor.reset();currentConductor=conductor;conductor.oneShot()})})});return 1}})})();
(function(){var a;Tag.actions.o2_geo_watch=new TagAction({action:function(){if(a)return 0;a=navigator.geolocation.watchPosition(function(a){ev.geo=a});return 0}});Tag.actions.o2_geo_endwatch=new TagAction({action:function(){navigator.geolocation.clearWatch(a);a=void 0;return 0}});Tag.actions.o2_geo_get=new TagAction({action:function(){var a=this;navigator.geolocation.getCurrentPosition(function(c){ev.geo=c;a.done()},function(){a.done()});return 0}});Tag.actions.o2_geo_wg=new TagAction({rules:{canskip:{type:"BOOLEAN"}},
action:function(a){a.canskip&&wait("click");wait("o2_geo_get");return 1}})})();Tag.actions.clearsysvar=new TagAction({action:function(){window.sf={};return 0}});Tag.actions.clearvar=new TagAction({action:function(){window.f={}}});
Tag.actions.o2_prov_glyph=new TagAction({rules:{line:{type:"STRING"},page:{type:"STRING"},fix:{type:"BOOLEAN"},left:{type:"INT"},top:{type:"INT"}},action:function(a){a.line&&(config.messageLayerDefaultGlyphLine=a.line);a.page&&(config.messageLayerDefaultGlyphPage=a.page);a.fix&&(config.messageLayerDefaultGlyphFixed=a.fix);a.left&&(config.messageLayerDefaultGlyphX=a.left);a.top&&(config.messageLayerDefaultGlyphY=a.top);return 0}});
$(function(){window.glyph={show:function(){config.messageLayerDefaultGlyphFixed?$(this.image).css({left:config.messageLayerDefaultGlyphX+"px",top:config.messageLayerDefaultGlyphY+"px"}):o2.currentMessageLayer.vertical?$(this.image).css({left:o2.currentMessageLayer.textCursor.x+o2.currentMessageLayer.rect.x+o2.currentMessageLayer.font.size-$(this.image).width()+"px",top:o2.currentMessageLayer.textCursor.y+o2.currentMessageLayer.rect.y-$(this.image).height()+o2.currentMessageLayer.style.lineSpacing+
"px"}):$(this.image).css({left:o2.currentMessageLayer.textCursor.x+o2.currentMessageLayer.rect.x+"px",top:o2.currentMessageLayer.textCursor.y+o2.currentMessageLayer.rect.y+Math.max(o2.currentMessageLayer.style.lineSize,o2.currentMessageLayer.font.size)-$(this.image).height()+o2.currentMessageLayer.style.lineSpacing+"px"});$(this.image).show();var a=this;$(this.image).one("load",function(){a.show()})},hide:function(){$(this.image).hide()},isShown:function(){return $(this.image).is(":visible")},showLineGlyph:function(){this.image.src=
o2.imageList[config.messageLayerDefaultGlyphLine];this.show()},showPageGlyph:function(){this.image.src=o2.imageList[config.messageLayerDefaultGlyphPage];this.show()},image:$("#glyph")[0]}});
Tag.actions.o2_loadplugin=new TagAction({rules:{module:{type:"STRING",required:!0}},action:function(a){var b=this;$.getScript("./plugin/"+a.module).done(function(){b.done()}).fail(function(){b.error("\u30d7\u30e9\u30b0\u30a4\u30f3\u30d5\u30a1\u30a4\u30eb "+a.module+" \u3092\u30ed\u30fc\u30c9\u3067\u304d\u307e\u305b\u3093")});return 1}});
Tag.actions.o2_sysbutton=new TagAction({rules:{graphic:{type:"STRING",required:!0},graphickey:{type:"COLOR",allowString:["adapt"]},storage:{type:"STRING"},target:{type:"STRING"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},o2_exp:{type:"STRING"},o2_onenter:{type:"STRING"},o2_onleave:{type:"STRING"},id:{type:"STRING",required:!0}},action:function(a){var b=this;ResourceLoader.loadImage(a.graphic).done(function(c){setTimeout(function(){var d=o2.currentMessageLayer.textCursor,
d=new RoutineButton(c,d.x,d.y);d.importFromKAGArgs(a);o2.currentMessageLayer.addRoutineButton(d);b.done()})});return 1}});Tag.actions.o2_updatesysbutton=new TagAction({rules:{id:{type:"STRING",required:!0},enabled:{type:"BOOLEAN"}},action:function(a){for(var b=0;b<o2.currentMessageLayer.routineButtons.length;b++){var c=o2.currentMessageLayer.routineButtons[b];if(c.tagArgs.id==a.id){c.enabled=a.enabled;break}}return 0}});
Tag.actions.o2_deletesysbutton=new TagAction({rules:{id:{type:"STRING",required:!0}},action:function(a){for(var b=0;b<o2.currentMessageLayer.routineButtons.length;b++){var c=o2.currentMessageLayer.routineButtons[b];if(c.tagArgs.id==a.id){o2.currentMessageLayer.routineButtons.splice(b,1);o2.currentMessageLayer.redrawRect(c.rect);break}}return 0}});
var RoutineButton=function(a,b,c){Button.call(this,a,b,c);this.rect.width=Math.floor(this.rect.width/4);this.options.clipLeft=0;this.options.clipWidth=this.rect.width;this.tagArgs;this.activated=this.enabled=!0};RoutineButton.prototype=Object.create(Button.prototype);RoutineButton.prototype.initializer="RoutineButton";RoutineButton.prototype.clone=function(a){var b=new RoutineButton(this.image);b.importFrom(a);return b};
RoutineButton.prototype.drawOnContext=function(a,b){switch(this.state){case Button.STATE_DISABLE:this.options.clipLeft=3*this.rect.width;break;case Button.STATE_HOVER:this.options.clipLeft=2*this.rect.width;break;case Button.STATE_DOWN:this.options.clipLeft=this.rect.width;break;default:this.options.clipLeft=0}this.enabled||(this.options.clipLeft=3*this.rect.width);Button.prototype.drawOnContext.apply(this,arguments)};
RoutineButton.prototype.importFromKAGArgs=function(a){this.tagArgs=clone(a);this.click=function(){if(this.activated&&this.enabled&&(a.o2_exp&&eval(a.o2_exp),a.o2_url&&window.open(a.o2_url,a.o2_urltarget),a.storage||a.target)){extraConductor.setFile(conductor.file);currentConductor=extraConductor;var b=new Tag("jump",{storage:a.storage,target:a.target});extraConductor.stack.push(b)}};a.o2_onenter&&(this.enter=function(){eval(a.o2_onenter)});a.o2_onleave&&(this.leave=function(){eval(a.o2_onleave)})};
RoutineButton.prototype.importFrom=function(a){Button.prototype.importFrom.call(this,a);this.importFromKAGArgs(a.tagArgs)};RoutineButton.prototype.toJSON=function(){var a=Button.prototype.toJSON.call(this);a.tagArgs=this.tagArgs;return a};RoutineButton.restore=function(a){return $.when(ResourceLoader.loadImage(a.image,!0)).then(function(b){b=new RoutineButton(b);b.importFrom(a);return b})};
var defaultConfig={title:["string","untitled"],gameID:["string","mygame"],scWidth:["number",800],scHeight:["number",600],numMessageLayers:["number",2],numImageLayers:["number",2],backgroundColor:["color","0xeeeeee"],chSpeeds:["number",40],numSEBuffers:["number",2],numMovies:["number",1],scPositionX_left:["number",0],scPositionX_left_center:["number",0],scPositionX_center:["number",0],scPositionX_right_center:["number",0],scPositionX_right:["number",0],initialMessageLayerVisible:["boolean",!1],messageLayerColor:["color",
"0x000000"],messageLayerOpacity:["opacity",190],messageLayerMarginT:["number",6],messageLayerMarginL:["number",6],messageLayerMarginR:["number",6],messageLayerMarginB:["number",6],messageLayerCurrentPositionX:["number",10],messageLayerCurrentPositionY:["number",60],messageLayerCurrentWidth:["number",480],messageLayerCurrentHeight:["number",35],messageLayerDefaultAutoReturn:["boolean",!0],messageLayerDefaultFontSize:["number",12],messageLayerDefaultFontFace:["string","\uff2d\uff33 \uff30\u30b4\u30b7\u30c3\u30af"],
messageLayerDefaultFontColor:["color","0xFFFFFF"],messageLayerDefaultFontBold:["boolean",!1],messageLayerDefaultFontItalic:["boolean",!1],messageLayerDefaultStyleLineSpacing:["number",6],messageLayerDefaultStylePitch:["number",0],messageLayerDefaultGlyphLine:["string","linebreak"],messageLayerDefaultGlyphPage:["string","pagebreak"],messageLayerDefaultGlyphFixed:["boolean",!1],messageLayerDefaultGlyphX:["number",0],messageLayerDefaultGlyphY:["number",0],messageLayerDefaultLinkColor:["color","0x0000ff"],
messageLayerDefaultLinkOpacity:["opacity",64],messageLayerVertical:["boolean",!1],messageLayerDefaultRubySize:["number",10],messageLayerDefaultRubyOffset:["number",-2],messageLayerDefaultShadow:["boolean",!0],messageLayerDefaultShadowBlur:["number",3],messageLayerDefaultShadowOffsetX:["number",0],messageLayerDefaultShadowOffsetY:["number",0],messageLayerDefaultShadowColor:["color","0x000000"],messageLayerDefaultEdge:["boolean",!1],messageLayerDefaultEdgeColor:["color","0x000000"],historyLayerFontFace:["string",
"\uff2d\uff33 \uff30\u30b4\u30b7\u30c3\u30af"],historyLayerFontColor:["color","0xFFFFFF"],historyLayerFontBold:["boolean",!1],historyLayerFontHeight:["number",24],historyLayerLineHeight:["number",26],historyLayerEverypage:["boolean",!1],historyLayerMaxPages:["number",30],historyLayerMaxLines:["number",20],historyLayerStoreState:["boolean",!1],historyLayerColor:["color","0x000000"],historyLayerOpacity:["opacity",255],historyLayerFrame:["string",""],historyLayerMarginT:["number",30],historyLayerMarginL:["number",
30],historyLayerMarginR:["number",30],historyLayerMarginB:["number",30],historyLayerCurrentPositionX:["number",10],historyLayerCurrentPositionY:["number",10],historyLayerCurrentWidth:["number",300],historyLayerCurrentHeight:["number",300],historyLayerVertical:["string","auto"],historyLayerShadow:["boolean",!0],historyLayerShadowColor:["color","0x000000"],historyLayerShadowBlur:["number",3],historyLayerShadowOffsetX:["number",0],historyLayerShadowOffsetY:["number",0],cursorDefault:["string","auto"],
cursorPointed:["string","pointer"],cursorWaitingClick:["string","auto"],cursorDraggable:["string","auto"],saveMode:["string","o2kag"]},config={},mp={},tf={},sf={},f={},ev={query:function(){for(var a={},b=window.location.search.substring(1).split("&"),c=0;c<b.length;c++){var d=b[c].split("=");d.length&&!(1==d.length&&""==d[0])&&(a[d[0]]=2==d.length?decodeURIComponent((RegExp("[?|&]"+d[0]+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null:!0)}return a}(),save:{date:{},
caption:{}},ua:navigator.userAgent,lang:navigator.language?navigator.language:navigator.userLanguage,hostname:location.hostname,enginever:"2.1.3"},o2={foreLayers:{baseLayer:void 0,imageLayers:[],messageLayers:[]},backLayers:{baseLayer:void 0,imageLayers:[],messageLayers:[]},currentMessageLayer:void 0,allForeLayers:function(){return[this.foreLayers.baseLayer].concat(this.foreLayers.imageLayers).concat(this.foreLayers.messageLayers)},allBackLayers:function(){return[this.backLayers.baseLayer].concat(this.backLayers.imageLayers).concat(this.backLayers.messageLayers)},
allLayers:function(){return this.allBackLayers().concat(this.allForeLayers())},autoHideLayers:function(){return this.foreLayers.messageLayers.concat(this.backLayers.messageLayers).concat(this.extraAutoHideLayers)},extraAutoHideLayers:[],imageList:[],soundList:[],videoList:[],fontList:[],config:{scriptTagNameKey:"name",scriptTagArgsKey:"args",scriptTagLineKey:"line",scriptTagCharKey:"char"},se:[],seVolume:1,bgm:new Sound,bgmVolume:1,videos:[],skipMode:0,clickSkipEnabled:!0,skipKeyPressing:function(){return!1},
historyLayer:void 0,debugLevel:1,serverStat:{mode:0,key:ev.query.key||null,uid:ev.query.uid||-1,userServer:"https://novelsphere.jp",skey:ev.query.skey||null},setServerStat:function(a){o2.serverStat.key=a.key;o2.serverStat.uid=a.uid;o2.serverStat.userServer=a.userServer;o2.serverStat.skey=a.skey},printLog:function(a){void 0==a&&(a=o2.DEBUG_LEVEL_LOG);if(a>o2.debugLevel)return function(){};switch(a){case o2.DEBUG_LEVEL_ERROR:return console.error;case o2.DEBUG_LEVEL_CAUTION:return console.warn;case o2.DEBUG_LEVEL_LOG:return console.log}return function(){}},
log:function(){return o2.printLog(o2.DEBUG_LEVEL_LOG).apply(console,arguments)},warn:function(){return o2.printLog(o2.DEBUG_LEVEL_CAUTION).apply(console,arguments)},error:function(){return o2.printLog(o2.DEBUG_LEVEL_ERROR).apply(console,arguments)},setCursorStyle:function(a){switch(a){case "pointer":a=config.cursorPointed;break;case "waitClick":a=config.cursorWaitingClick;break;case "draggable":a=config.cursorDraggable;break;default:a=config.cursorDefault}$("body").css("cursor",a)},SKIP_MODE_NONE:0,
SKIP_MODE_CLICK:1,SKIP_MODE_PAGE:2,SKIP_MODE_STOP:3,SKIP_MODE_FAST_FORWARD:4,DEBUG_LEVEL_OFF:0,DEBUG_LEVEL_ERROR:1,DEBUG_LEVEL_CAUTION:2,DEBUG_LEVEL_LOG:3,SERVER_MODE_STANDALONE:0,SERVER_MODE_O2SERVER:1,SAVE_MODE_O2KAG:"o2kag",SAVE_MODE_KAG3:"kag3",objectToBeSerialized:function(a){function b(a){for(var b=0;b<o2.foreLayers.messageLayers.length;b++){var g=o2.foreLayers.messageLayers[b];if(a==g)return{page:"fore",layer:b}}for(b=0;b<o2.backLayers.messageLayers.length;b++)if(g=o2.backLayers.messageLayers[b],
a==g)return{page:"back",layer:b}}if("function"!=typeof this[a]){switch(a){case "imageList":case "soundList":case "videoList":case "config":case "imageList":case "soundList":case "videoList":case "serverStat":case "SKIP_MODE_NONE":case "SKIP_MODE_CLICK":case "SKIP_MODE_PAGE":case "SKIP_MODE_STOP":case "SKIP_MODE_FAST_FORWARD":case "DEBUG_LEVEL_OFF":case "DEBUG_LEVEL_ERROR":case "DEBUG_LEVEL_CAUTION":case "DEBUG_LEVEL_LOG":case "SERVER_MODE_STANDALONE":case "SERVER_MODE_O2SERVER":case "SAVE_MODE_O2KAG":case "SAVE_MODE_KAG3":return;
case "currentMessageLayer":return b(this.currentMessageLayer);case "autoHideLayers":return this.autoHideLayers.map(function(a){return b(a)})}return this[a]}},importFromSaveData:function(a){this.currentMessageLayer=this["back"==a.currentMessageLayer.page?"backLayers":"foreLayers"].messageLayers[a.currentMessageLayer.layer];delete a.currentMessageLayer;return Object.prototype.importFromSaveData.call(this,a)}};
function initialize(a){function b(a,b){var c=defaultConfig[a],d;c&&(d=c[0]);switch(d){case "number":config[a]=Number(b);break;case "opacity":config[a]=Number(b)/255;break;case "boolean":config[a]="boolean"==typeof b?b:"true"==b.toLowerCase()?!0:"false"==b.toLowerCase()?!1:Boolean(b);break;case "color":config[a]=b.replace("0x","#");break;default:config[a]=b}}for(var c in defaultConfig)b(c,defaultConfig[c][1]);for(c in a.config)b(c,a.config[c]);document.title=config.title;c={videolist:"videoList",imagelist:"imageList",
soundlist:"soundList",fontlist:"fontList"};for(var d in c)c.hasOwnProperty(d)&&"object"===typeof a[d]&&(o2[c[d]]=a[d]);for(d=0;d<config.numSEBuffers;d++)o2.se.push(new Sound);for(d=0;d<config.numMovies;d++)o2.videos.push(new Video);o2.foreLayers.baseLayer=new BaseLayer;o2.backLayers.baseLayer=new BaseLayer;for(d=0;d<config.numImageLayers;d++)c=new ImageLayer,o2.foreLayers.imageLayers.push(c),c=new ImageLayer,o2.backLayers.imageLayers.push(c);for(d=0;d<config.numMessageLayers;d++)c=new MessageLayer,
o2.foreLayers.messageLayers.push(c),c=new MessageLayer,o2.backLayers.messageLayers.push(c);o2.currentMessageLayer=o2.foreLayers.messageLayers[0];o2.foreLayers.messageLayers[0].visible=o2.backLayers.messageLayers[0].visible=config.initialMessageLayerVisible;o2.historyLayer=new HistoryLayer;o2.historyLayer.init();setupRenderer();for(var g in a.scripts){c=a.scripts[g];var h=new KAGFile(g);for(d=0;d<c.length;d++){var j=c[d],i=new Tag(j[o2.config.scriptTagNameKey],j[o2.config.scriptTagArgsKey]);h.lines.push(i);
"undefined"!=typeof j[o2.config.scriptTagLineKey]&&(i.originalLineNumber=j[o2.config.scriptTagLineKey]);"undefined"!=typeof j[o2.config.scriptTagCharKey]&&(i.originalCharNumber=j[o2.config.scriptTagCharKey])}}glyph.hide();$("body").css("background-color",config.backgroundColor);scaleToFitPage();window.addEventListener("resize",scaleToFitPage)}var renderer;
function setupRenderer(){renderer=new Renderer;renderer.foreLayers=[o2.foreLayers.baseLayer].concat(o2.foreLayers.imageLayers,o2.foreLayers.messageLayers);renderer.backLayers=[o2.backLayers.baseLayer].concat(o2.backLayers.imageLayers,o2.backLayers.messageLayers);$("#main-wrapper").append(renderer.foreCanvas);$("#main-wrapper").css({width:config.scWidth+"px",height:config.scHeight+"px"})}var conductor,currentConductor,extraConductor;
function getScripts(a,b){o2.serverStat.mode=o2.SERVER_MODE_O2SERVER;$.ajax({url:a,data:b,type:b?"POST":"GET",success:function(a){"string"==typeof a&&(a=JSON.parse(a));initScripts(a)}})}
function initScripts(a){initialize(a);a=null;extraConductor=new SubRoutineConductor;currentConductor=conductor=new Conductor({file:KAGFiles("first.ks")});conductor.run();setupEventHandlers();$(o2).trigger("init");if(browser.isIOs||browser.isAndroid)$("body").one("touchstart",function(){o2.bgm.dummyLoad();for(var a=o2.se.length-1;0<=a;a--)o2.se[a].dummyLoad();for(a=o2.videos.length-1;0<=a;a--)o2.videos[a].dummyLoad()});window.FPSMeter&&(window.meter=new FPSMeter({smoothing:2,position:"fixed",top:"auto",
left:"auto",bottom:"0px",right:"0px",graph:1,heat:1}))}(function(){var a={scriptTagNameKey:0,scriptTagArgsKey:1,scriptTagLineKey:2,scriptTagCharKey:3};"undefined"!==typeof module&&module.exports?exports.config=a:window&&window.o2&&(window.o2.config=a)})();
